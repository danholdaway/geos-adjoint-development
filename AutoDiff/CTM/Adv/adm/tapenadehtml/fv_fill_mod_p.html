<title>Generated by TAPENADE</title>
<link type="text/CSS" rel="stylesheet" href="tapenade.css">
<link type="text/CSS" rel="stylesheet" href="fortranStyle.css">
<body>
<pre><code class="comment">!        Generated by TAPENADE     (INRIA, Ecuador team)</code>
<code class="comment">!  Tapenade 3.12 (r6213) - 13 Oct 2016 10:30</code>
<code class="comment">!</code>
<code class="keyword">MODULE </code><code class="funcname">FV_FILL_MOD</code>
  <code class="keyword">USE </code><code class="funcname">FV_ARRAYS_MOD</code>, <code class="keyword">ONLY </code>: real8
  <code class="keyword">IMPLICIT NONE</code>
  PUBLIC fillz
<a name="fillz"></a>
<code class="keyword">CONTAINS</code>
<a name="fillzi545"></a>  <a href="null.html#fv_fill_mod_b" target="diffFile"><code class="keyword">SUBROUTINE </code><code class="funcname">FILLZ</code>(<code class="vardecl">im</code>, <code class="vardecl">km</code>, <code class="vardecl">nq</code>, <code class="vardecl">q</code>, <code class="vardecl">dp</code>)</a>
    <a href="null.html#fv_fill_mod_b" target="diffFile"><code class="keyword">IMPLICIT NONE</code></a>
<a name="fillzi546"></a><a href="null.html#fv_fill_mod_b" target="diffFile"><code class="comment">! No. of longitudes</code></a>
    <a href="null.html#fv_fill_mod_b" target="diffFile"><code class="typename">INTEGER</code>, <code class="typename">INTENT(IN) </code>:: <code class="vardecl">im</code></a>
<a name="fillzi547"></a><a href="null.html#fv_fill_mod_b" target="diffFile"><code class="comment">! No. of levels</code></a>
    <a href="null.html#fv_fill_mod_b" target="diffFile"><code class="typename">INTEGER</code>, <code class="typename">INTENT(IN) </code>:: <code class="vardecl">km</code></a>
<a name="fillzi548"></a><a href="null.html#fv_fill_mod_b" target="diffFile"><code class="comment">! Total number of tracers</code></a>
    <a href="null.html#fv_fill_mod_b" target="diffFile"><code class="typename">INTEGER</code>, <code class="typename">INTENT(IN) </code>:: <code class="vardecl">nq</code></a>
<a name="fillzi549"></a><a href="null.html#fv_fill_mod_b" target="diffFile"><code class="comment">! pressure thickness</code></a>
    <a href="null.html#fv_fill_mod_b" target="diffFile"><code class="typename">REAL(</code><code class="modifier">real8</code><code class="typename">)</code>, <code class="typename">INTENT(IN) </code>:: <code class="vardecl">dp</code>(<code class="vardecl">im</code>, <code class="vardecl">km</code>)</a>
<a name="fillzi550"></a><a href="null.html#fv_fill_mod_b" target="diffFile"><code class="comment">! tracer mixing ratio</code></a>
    <a href="null.html#fv_fill_mod_b" target="diffFile"><code class="typename">REAL(</code><code class="modifier">real8</code><code class="typename">)</code>, <code class="typename">INTENT(INOUT) </code>:: <code class="vardecl">q</code>(<code class="vardecl">im</code>, <code class="vardecl">km</code>, <code class="vardecl">nq</code>)</a>
<a name="fillzi551"></a><a href="null.html#fv_fill_mod_b" target="diffFile"><code class="comment">! !LOCAL VARIABLES:</code></a>
<a name="fillzi552"></a>    <a href="null.html#fv_fill_mod_b" target="diffFile"><code class="typename">LOGICAL </code>:: <code class="vardecl">zfix</code>(<code class="vardecl">im</code>)</a>
<a name="fillzi553"></a>    <a href="null.html#fv_fill_mod_b" target="diffFile"><code class="typename">REAL(</code><code class="modifier">real8</code><code class="typename">) </code>:: <code class="vardecl">dm</code>(<code class="vardecl">km</code>)</a>
<a name="fillzi554"></a>    <a href="null.html#fv_fill_mod_b" target="diffFile"><code class="typename">INTEGER </code>:: <code class="vardecl">i</code>, <code class="vardecl">k</code>, <code class="vardecl">ic</code></a>
<a name="fillzi555"></a>    <a href="null.html#fv_fill_mod_b" target="diffFile"><code class="typename">REAL(</code><code class="modifier">real8</code><code class="typename">) </code>:: <code class="vardecl">qup</code>, <code class="vardecl">qly</code>, <code class="vardecl">dup</code>, <code class="vardecl">dq</code>, <code class="vardecl">sum0</code>, <code class="vardecl">sum1</code>, <code class="vardecl">fac</code></a>
<a name="fillzi556"></a>    <a href="null.html#fv_fill_mod_b" target="diffFile"><code class="keyword">INTRINSIC </code><code class="funcname">MIN</code></a>
<a name="fillzi607"></a>    <a href="null.html#fv_fill_mod_b" target="diffFile"><code class="keyword">INTRINSIC </code><code class="funcname">MAX</code></a>
<a name="fillzi560"></a>    <a href="null.html#fv_fill_mod_b" target="diffFile"><code class="typename">REAL*8 </code>:: <code class="vardecl">max1</code></a>
    <a href="null.html#fv_fill_mod_b" target="diffFile"><code class="keyword">DO </code>ic=<code class="constant">1</code>,nq</a>
<a name="fillzi557"></a><a href="null.html#fv_fill_mod_b" target="diffFile"><code class="comment">! Top layer</code></a>
<a name="fillzi558"></a>      <a href="null.html#fv_fill_mod_b" target="diffFile"><code class="keyword">DO </code>i=<code class="constant">1</code>,im</a>
<a name="fillzi559"></a>        <a href="null.html#fv_fill_mod_b" target="diffFile"><code class="keyword">IF</code> (q(i, <code class="constant">1</code>, ic) .LT. <code class="constant">0.</code>) <code class="keyword">THEN</code></a>
          <a href="null.html#fv_fill_mod_bi153" target="diffFile">q(i, <code class="constant">2</code>, ic) = q(i, <code class="constant">2</code>, ic) + q(i, <code class="constant">1</code>, ic)*dp(i, <code class="constant">1</code>)/dp(i, <code class="constant">2</code>)</a>
          <a href="null.html#fv_fill_mod_bi152" target="diffFile">q(i, <code class="constant">1</code>, ic) = <code class="constant">0.</code></a>
<a name="fillzi561"></a>        <a href="null.html#fv_fill_mod_b" target="diffFile"><code class="keyword">END IF</code></a>
      <a href="null.html#fv_fill_mod_b" target="diffFile"><code class="keyword">END DO</code></a>
<a name="fillzi577"></a><a href="null.html#fv_fill_mod_b" target="diffFile"><code class="comment">! Interior</code></a>
<a name="fillzi576"></a>      <a href="null.html#fv_fill_mod_b" target="diffFile">zfix(:) = <code class="constant">.false.</code></a>
<a name="fillzi562"></a>      <a href="null.html#fv_fill_mod_b" target="diffFile"><code class="keyword">DO </code>k=<code class="constant">2</code>,km-<code class="constant">1</code></a>
<a name="fillzi563"></a>        <a href="null.html#fv_fill_mod_b" target="diffFile"><code class="keyword">DO </code>i=<code class="constant">1</code>,im</a>
<a name="fillzi564"></a>          <a href="null.html#fv_fill_mod_b" target="diffFile"><code class="keyword">IF</code> (q(i, k, ic) .LT. <code class="constant">0.</code>) <code class="keyword">THEN</code></a>
<a name="fillzi565"></a>            <a href="null.html#fv_fill_mod_b" target="diffFile">zfix(i) = <code class="constant">.true.</code></a>
            <a href="null.html#fv_fill_mod_b" target="diffFile"><code class="keyword">IF</code> (q(i, k-<code class="constant">1</code>, ic) .GT. <code class="constant">0.</code>) <code class="keyword">THEN</code></a>
<a name="fillzi566"></a>              <a href="null.html#fv_fill_mod_b" target="diffFile"><code class="keyword">IF</code> (q(i, k-<code class="constant">1</code>, ic)*dp(i, k-<code class="constant">1</code>) .GT. -(q(i, k, ic)*dp(i, k))<code class="label">&</code></a>
<a href="null.html#fv_fill_mod_b" target="diffFile"><code class="label">&             </code>) <code class="keyword">THEN</code></a>
<a name="fillzi567"></a>                <a href="null.html#fv_fill_mod_bi154" target="diffFile">dq = -(q(i, k, ic)*dp(i, k))</a>
              <a href="null.html#fv_fill_mod_b" target="diffFile"><code class="keyword">ELSE</code></a>
<a name="fillzi568"></a>                <a href="null.html#fv_fill_mod_bi155" target="diffFile">dq = q(i, k-<code class="constant">1</code>, ic)*dp(i, k-<code class="constant">1</code>)</a>
<a name="fillzi569"></a>              <a href="null.html#fv_fill_mod_b" target="diffFile"><code class="keyword">END IF</code></a>
              <a href="null.html#fv_fill_mod_bi157" target="diffFile">q(i, k-<code class="constant">1</code>, ic) = q(i, k-<code class="constant">1</code>, ic) - dq/dp(i, k-<code class="constant">1</code>)</a>
<a name="fillzi570"></a>              <a href="null.html#fv_fill_mod_bi156" target="diffFile">q(i, k, ic) = q(i, k, ic) + dq/dp(i, k)</a>
<a name="fillzi571"></a>            <a href="null.html#fv_fill_mod_b" target="diffFile"><code class="keyword">END IF</code></a>
            <a href="null.html#fv_fill_mod_b" target="diffFile"><code class="keyword">IF</code> (q(i, k, ic) .LT. <code class="constant">0.0 </code>.AND. q(i, k+<code class="constant">1</code>, ic) .GT. <code class="constant">0.</code>) <code class="keyword">THEN</code></a>
<a name="fillzi572"></a>              <a href="null.html#fv_fill_mod_b" target="diffFile"><code class="keyword">IF</code> (q(i, k+<code class="constant">1</code>, ic)*dp(i, k+<code class="constant">1</code>) .GT. -(q(i, k, ic)*dp(i, k))<code class="label">&</code></a>
<a href="null.html#fv_fill_mod_b" target="diffFile"><code class="label">&             </code>) <code class="keyword">THEN</code></a>
<a name="fillzi573"></a>                <a href="null.html#fv_fill_mod_bi158" target="diffFile">dq = -(q(i, k, ic)*dp(i, k))</a>
              <a href="null.html#fv_fill_mod_b" target="diffFile"><code class="keyword">ELSE</code></a>
<a name="fillzi574"></a>                <a href="null.html#fv_fill_mod_bi159" target="diffFile">dq = q(i, k+<code class="constant">1</code>, ic)*dp(i, k+<code class="constant">1</code>)</a>
<a name="fillzi575"></a>              <a href="null.html#fv_fill_mod_b" target="diffFile"><code class="keyword">END IF</code></a>
              <a href="null.html#fv_fill_mod_bi161" target="diffFile">q(i, k+<code class="constant">1</code>, ic) = q(i, k+<code class="constant">1</code>, ic) - dq/dp(i, k+<code class="constant">1</code>)</a>
              <a href="null.html#fv_fill_mod_bi160" target="diffFile">q(i, k, ic) = q(i, k, ic) + dq/dp(i, k)</a>
            <a href="null.html#fv_fill_mod_b" target="diffFile"><code class="keyword">END IF</code></a>
          <a href="null.html#fv_fill_mod_b" target="diffFile"><code class="keyword">END IF</code></a>
<a name="fillzi578"></a>        <a href="null.html#fv_fill_mod_b" target="diffFile"><code class="keyword">END DO</code></a>
      <a href="null.html#fv_fill_mod_b" target="diffFile"><code class="keyword">END DO</code></a>
<a name="fillzi588"></a><a href="null.html#fv_fill_mod_b" target="diffFile"><code class="comment">! Bottom layer</code></a>
<a name="fillzi579"></a>      <a href="null.html#fv_fill_mod_b" target="diffFile">k = km</a>
<a name="fillzi580"></a>      <a href="null.html#fv_fill_mod_b" target="diffFile"><code class="keyword">DO </code>i=<code class="constant">1</code>,im</a>
<a name="fillzi581"></a>        <a href="null.html#fv_fill_mod_b" target="diffFile"><code class="keyword">IF</code> (q(i, k, ic) .LT. <code class="constant">0. </code>.AND. q(i, k-<code class="constant">1</code>, ic) .GT. <code class="constant">0.</code>) <code class="keyword">THEN</code></a>
          <a href="null.html#fv_fill_mod_b" target="diffFile">zfix(i) = <code class="constant">.true.</code></a>
<a name="fillzi582"></a><a href="null.html#fv_fill_mod_bi163" target="diffFile"><code class="comment">! Borrow from above</code></a>
<a name="fillzi583"></a>          <a href="null.html#fv_fill_mod_bi163" target="diffFile">qup = q(i, k-<code class="constant">1</code>, ic)*dp(i, k-<code class="constant">1</code>)</a>
<a name="fillzi584"></a>          <a href="null.html#fv_fill_mod_bi162" target="diffFile">qly = -(q(i, k, ic)*dp(i, k))</a>
          <a href="null.html#fv_fill_mod_b" target="diffFile"><code class="keyword">IF</code> (qly .GT. qup) <code class="keyword">THEN</code></a>
<a name="fillzi585"></a>            <a href="null.html#fv_fill_mod_bi164" target="diffFile">dup = qup</a>
          <a href="null.html#fv_fill_mod_b" target="diffFile"><code class="keyword">ELSE</code></a>
<a name="fillzi586"></a>            <a href="null.html#fv_fill_mod_bi165" target="diffFile">dup = qly</a>
<a name="fillzi587"></a>          <a href="null.html#fv_fill_mod_b" target="diffFile"><code class="keyword">END IF</code></a>
          <a href="null.html#fv_fill_mod_bi167" target="diffFile">q(i, k-<code class="constant">1</code>, ic) = q(i, k-<code class="constant">1</code>, ic) - dup/dp(i, k-<code class="constant">1</code>)</a>
          <a href="null.html#fv_fill_mod_bi166" target="diffFile">q(i, k, ic) = q(i, k, ic) + dup/dp(i, k)</a>
<a name="fillzi606"></a>        <a href="null.html#fv_fill_mod_b" target="diffFile"><code class="keyword">END IF</code></a>
      <a href="null.html#fv_fill_mod_b" target="diffFile"><code class="keyword">END DO</code></a>
<a name="fillzi589"></a><a href="null.html#fv_fill_mod_b" target="diffFile"><code class="comment">! Perform final check and non-local fix if needed</code></a>
<a name="fillzi590"></a>      <a href="null.html#fv_fill_mod_b" target="diffFile"><code class="keyword">DO </code>i=<code class="constant">1</code>,im</a>
<a name="fillzi593"></a>        <a href="null.html#fv_fill_mod_b" target="diffFile"><code class="keyword">IF</code> (zfix(i)) <code class="keyword">THEN</code></a>
<a name="fillzi591"></a>          <a href="null.html#fv_fill_mod_bi168" target="diffFile">sum0 = <code class="constant">0.</code></a>
<a name="fillzi592"></a>          <a href="null.html#fv_fill_mod_b" target="diffFile"><code class="keyword">DO </code>k=<code class="constant">2</code>,km</a>
            <a href="null.html#fv_fill_mod_bi170" target="diffFile">dm(k) = q(i, k, ic)*dp(i, k)</a>
<a name="fillzi594"></a>            <a href="null.html#fv_fill_mod_bi169" target="diffFile">sum0 = sum0 + dm(k)</a>
<a name="fillzi595"></a>          <a href="null.html#fv_fill_mod_b" target="diffFile"><code class="keyword">END DO</code></a>
<a name="fillzi600"></a>          <a href="null.html#fv_fill_mod_b" target="diffFile"><code class="keyword">IF</code> (sum0 .GT. <code class="constant">0.</code>) <code class="keyword">THEN</code></a>
<a name="fillzi596"></a>            <a href="null.html#fv_fill_mod_bi171" target="diffFile">sum1 = <code class="constant">0.</code></a>
<a name="fillzi597"></a>            <a href="null.html#fv_fill_mod_b" target="diffFile"><code class="keyword">DO </code>k=<code class="constant">2</code>,km</a>
              <a href="null.html#fv_fill_mod_b" target="diffFile"><code class="keyword">IF</code> (<code class="constant">0. </code>.LT. dm(k)) <code class="keyword">THEN</code></a>
<a name="fillzi598"></a>                <a href="null.html#fv_fill_mod_bi172" target="diffFile">max1 = dm(k)</a>
              <a href="null.html#fv_fill_mod_b" target="diffFile"><code class="keyword">ELSE</code></a>
<a name="fillzi599"></a>                <a href="null.html#fv_fill_mod_b" target="diffFile">max1 = <code class="constant">0.</code></a>
              <a href="null.html#fv_fill_mod_b" target="diffFile"><code class="keyword">END IF</code></a>
<a name="fillzi601"></a>              <a href="null.html#fv_fill_mod_bi173" target="diffFile">sum1 = sum1 + max1</a>
<a name="fillzi605"></a>            <a href="null.html#fv_fill_mod_b" target="diffFile"><code class="keyword">END DO</code></a>
<a name="fillzi602"></a>            <a href="null.html#fv_fill_mod_bi174" target="diffFile">fac = sum0/sum1</a>
<a name="fillzi603"></a>            <a href="null.html#fv_fill_mod_b" target="diffFile"><code class="keyword">DO </code>k=<code class="constant">2</code>,km</a>
              <a href="null.html#fv_fill_mod_b" target="diffFile"><code class="keyword">IF</code> (<code class="constant">0. </code>.LT. fac*dm(k)/dp(i, k)) <code class="keyword">THEN</code></a>
<a name="fillzi604"></a>                <a href="null.html#fv_fill_mod_bi175" target="diffFile">q(i, k, ic) = fac*dm(k)/dp(i, k)</a>
              <a href="null.html#fv_fill_mod_b" target="diffFile"><code class="keyword">ELSE</code></a>
                <a href="null.html#fv_fill_mod_bi176" target="diffFile">q(i, k, ic) = <code class="constant">0.</code></a>
              <a href="null.html#fv_fill_mod_b" target="diffFile"><code class="keyword">END IF</code></a>
            <a href="null.html#fv_fill_mod_b" target="diffFile"><code class="keyword">END DO</code></a>
          <a href="null.html#fv_fill_mod_b" target="diffFile"><code class="keyword">END IF</code></a>
        <a href="null.html#fv_fill_mod_b" target="diffFile"><code class="keyword">END IF</code></a>
      <a href="null.html#fv_fill_mod_b" target="diffFile"><code class="keyword">END DO</code></a>
    <a href="null.html#fv_fill_mod_b" target="diffFile"><code class="keyword">END DO</code></a>
  <a href="null.html#fv_fill_mod_b" target="diffFile"><code class="keyword">END SUBROUTINE </code><code class="funcname">FILLZ</code></a>
<code class="keyword">END MODULE </code><code class="funcname">FV_FILL_MOD</code>
</pre>
</body>
