<title>Generated by TAPENADE</title>
<link type="text/CSS" rel="stylesheet" href="tapenade.css">
<link type="text/CSS" rel="stylesheet" href="fortranStyle.css">
<body>
<pre><code class="comment">!        Generated by TAPENADE     (INRIA, Ecuador team)</code>
<code class="comment">!  Tapenade 3.12 (r6213) - 13 Oct 2016 10:30</code>
<code class="comment">!</code>
<code class="keyword">MODULE </code><code class="funcname">FV_FILL_MOD_B</code>
  <code class="keyword">USE </code><code class="funcname">FV_ARRAYS_MOD</code>, <code class="keyword">ONLY </code>: real8
  <code class="keyword">IMPLICIT NONE</code>
  PUBLIC fillz
  PUBLIC fillz_adm
<a name="fillz_adm"></a>
<code class="keyword">CONTAINS</code>
<a href="null_p.html#fv_fill_mod" target="origFile"><code class="comment">!  Differentiation of fillz in reverse (adjoint) mode:</code></a>
<a href="null_p.html#fv_fill_mod" target="origFile"><code class="comment">!   gradient     of useful results: q</code></a>
<a href="null_p.html#fv_fill_mod" target="origFile"><code class="comment">!   with respect to varying inputs: q</code></a>
  <a href="null_p.html#fv_fill_mod" target="origFile"><code class="keyword">SUBROUTINE </code><code class="funcname">FILLZ_ADM</code>(<code class="vardecl">im</code>, <code class="vardecl">km</code>, <code class="vardecl">nq</code>, <code class="vardecl">q</code>, <code class="vardecl">q_ad</code>, <code class="vardecl">dp</code>)</a>
    <a href="null_p.html#fv_fill_mod" target="origFile"><code class="keyword">IMPLICIT NONE</code></a>
<a href="null_p.html#fv_fill_modi545" target="origFile"><code class="comment">! No. of longitudes</code></a>
    <a href="null_p.html#fv_fill_modi545" target="origFile"><code class="typename">INTEGER</code>, <code class="typename">INTENT(IN) </code>:: <code class="vardecl">im</code></a>
<a href="null_p.html#fv_fill_modi546" target="origFile"><code class="comment">! No. of levels</code></a>
    <a href="null_p.html#fv_fill_modi546" target="origFile"><code class="typename">INTEGER</code>, <code class="typename">INTENT(IN) </code>:: <code class="vardecl">km</code></a>
<a href="null_p.html#fv_fill_modi547" target="origFile"><code class="comment">! Total number of tracers</code></a>
    <a href="null_p.html#fv_fill_modi547" target="origFile"><code class="typename">INTEGER</code>, <code class="typename">INTENT(IN) </code>:: <code class="vardecl">nq</code></a>
<a href="null_p.html#fv_fill_modi548" target="origFile"><code class="comment">! pressure thickness</code></a>
    <a href="null_p.html#fv_fill_modi548" target="origFile"><code class="typename">REAL(</code><code class="modifier">real8</code><code class="typename">)</code>, <code class="typename">INTENT(IN) </code>:: <code class="vardecl">dp</code>(<code class="vardecl">im</code>, <code class="vardecl">km</code>)</a>
<a href="null_p.html#fv_fill_modi549" target="origFile"><code class="comment">! tracer mixing ratio</code></a>
    <a href="null_p.html#fv_fill_modi549" target="origFile"><code class="typename">REAL(</code><code class="modifier">real8</code><code class="typename">)</code>, <code class="typename">INTENT(INOUT) </code>:: <code class="vardecl">q</code>(<code class="vardecl">im</code>, <code class="vardecl">km</code>, <code class="vardecl">nq</code>)</a>
    <a href="null_p.html#fv_fill_mod" target="origFile"><code class="typename">REAL(</code><code class="modifier">real8</code><code class="typename">)</code>, <code class="typename">INTENT(INOUT) </code>:: <code class="vardecl">q_ad</code>(<code class="vardecl">im</code>, <code class="vardecl">km</code>, <code class="vardecl">nq</code>)</a>
<a href="null_p.html#fv_fill_modi550" target="origFile"><code class="comment">! !LOCAL VARIABLES:</code></a>
    <a href="null_p.html#fv_fill_modi550" target="origFile"><code class="typename">LOGICAL </code>:: <code class="vardecl">zfix</code>(<code class="vardecl">im</code>)</a>
    <a href="null_p.html#fv_fill_modi551" target="origFile"><code class="typename">REAL(</code><code class="modifier">real8</code><code class="typename">) </code>:: <code class="vardecl">dm</code>(<code class="vardecl">km</code>)</a>
    <a href="null_p.html#fv_fill_mod" target="origFile"><code class="typename">REAL(</code><code class="modifier">real8</code><code class="typename">) </code>:: <code class="vardecl">dm_ad</code>(<code class="vardecl">km</code>)</a>
    <a href="null_p.html#fv_fill_modi552" target="origFile"><code class="typename">INTEGER </code>:: <code class="vardecl">i</code>, <code class="vardecl">k</code>, <code class="vardecl">ic</code></a>
    <a href="null_p.html#fv_fill_modi553" target="origFile"><code class="typename">REAL(</code><code class="modifier">real8</code><code class="typename">) </code>:: <code class="vardecl">qup</code>, <code class="vardecl">qly</code>, <code class="vardecl">dup</code>, <code class="vardecl">dq</code>, <code class="vardecl">sum0</code>, <code class="vardecl">sum1</code>, <code class="vardecl">fac</code></a>
    <a href="null_p.html#fv_fill_mod" target="origFile"><code class="typename">REAL(</code><code class="modifier">real8</code><code class="typename">) </code>:: <code class="vardecl">qup_ad</code>, <code class="vardecl">qly_ad</code>, <code class="vardecl">dup_ad</code>, <code class="vardecl">dq_ad</code>, <code class="vardecl">sum0_ad</code>, <code class="vardecl">sum1_ad</code>, <code class="label">&</code></a>
<a href="null_p.html#fv_fill_mod" target="origFile"><code class="label">&   </code><code class="vardecl">fac_ad</code></a>
    <a href="null_p.html#fv_fill_modi554" target="origFile"><code class="keyword">INTRINSIC </code><code class="funcname">MIN</code></a>
    <a href="null_p.html#fv_fill_modi555" target="origFile"><code class="keyword">INTRINSIC </code><code class="funcname">MAX</code></a>
    <a href="null_p.html#fv_fill_modi556" target="origFile"><code class="typename">REAL*8 </code>:: <code class="vardecl">max1</code></a>
    <a href="null_p.html#fv_fill_mod" target="origFile"><code class="typename">REAL*8 </code>:: <code class="vardecl">max1_ad</code></a>
    <a href="null_p.html#fv_fill_mod" target="origFile"><code class="typename">REAL(</code><code class="modifier">real8</code><code class="typename">) </code>:: <code class="vardecl">temp_ad</code></a>
    <a href="null_p.html#fv_fill_mod" target="origFile"><code class="typename">INTEGER </code>:: <code class="vardecl">branch</code></a>
    <a href="null_p.html#fv_fill_modi607" target="origFile"><code class="keyword">DO </code>ic=<code class="constant">1</code>,nq</a>
<a href="null_p.html#fv_fill_modi560" target="origFile"><code class="comment">! Top layer</code></a>
      <a href="null_p.html#fv_fill_modi560" target="origFile"><code class="keyword">DO </code>i=<code class="constant">1</code>,im</a>
        <a href="null_p.html#fv_fill_modi557" target="origFile"><code class="keyword">IF</code> (q(i, <code class="constant">1</code>, ic) .LT. <code class="constant">0.</code>) <code class="keyword">THEN</code></a>
          <a href="null_p.html#fv_fill_modi558" target="origFile"><code class="keyword">CALL </code><code class="funcname">PUSHREAL8</code>(q(i, <code class="constant">2</code>, ic))</a>
          <a href="null_p.html#fv_fill_modi558" target="origFile">q(i, <code class="constant">2</code>, ic) = q(i, <code class="constant">2</code>, ic) + q(i, <code class="constant">1</code>, ic)*dp(i, <code class="constant">1</code>)/dp(i, <code class="constant">2</code>)</a>
          <a href="null_p.html#fv_fill_modi559" target="origFile"><code class="keyword">CALL </code><code class="funcname">PUSHREAL8</code>(q(i, <code class="constant">1</code>, ic))</a>
          <a href="null_p.html#fv_fill_modi559" target="origFile">q(i, <code class="constant">1</code>, ic) = <code class="constant">0.</code></a>
          <a href="null_p.html#fv_fill_modi557" target="origFile"><code class="keyword">CALL </code><code class="funcname">PUSHCONTROL1B</code>(<code class="constant">1</code>)</a>
        <a href="null_p.html#fv_fill_modi557" target="origFile"><code class="keyword">ELSE</code></a>
          <a href="null_p.html#fv_fill_modi557" target="origFile"><code class="keyword">CALL </code><code class="funcname">PUSHCONTROL1B</code>(<code class="constant">0</code>)</a>
        <a href="null_p.html#fv_fill_modi557" target="origFile"><code class="keyword">END IF</code></a>
      <a href="null_p.html#fv_fill_modi560" target="origFile"><code class="keyword">END DO</code></a>
<a href="null_p.html#fv_fill_modi561" target="origFile"><code class="comment">! Interior</code></a>
      <a href="null_p.html#fv_fill_modi561" target="origFile">zfix(:) = <code class="constant">.false.</code></a>
      <a href="null_p.html#fv_fill_modi607" target="origFile"><code class="keyword">CALL </code><code class="funcname">PUSHINTEGER4</code>(k)</a>
      <a href="null_p.html#fv_fill_modi577" target="origFile"><code class="keyword">DO </code>k=<code class="constant">2</code>,km-<code class="constant">1</code></a>
        <a href="null_p.html#fv_fill_modi576" target="origFile"><code class="keyword">DO </code>i=<code class="constant">1</code>,im</a>
          <a href="null_p.html#fv_fill_modi562" target="origFile"><code class="keyword">IF</code> (q(i, k, ic) .LT. <code class="constant">0.</code>) <code class="keyword">THEN</code></a>
            <a href="null_p.html#fv_fill_modi563" target="origFile">zfix(i) = <code class="constant">.true.</code></a>
            <a href="null_p.html#fv_fill_modi564" target="origFile"><code class="keyword">IF</code> (q(i, k-<code class="constant">1</code>, ic) .GT. <code class="constant">0.</code>) <code class="keyword">THEN</code></a>
              <a href="null_p.html#fv_fill_modi565" target="origFile"><code class="keyword">IF</code> (q(i, k-<code class="constant">1</code>, ic)*dp(i, k-<code class="constant">1</code>) .GT. -(q(i, k, ic)*dp(i, k))<code class="label">&</code></a>
<a href="null_p.html#fv_fill_modi565" target="origFile"><code class="label">&             </code>) <code class="keyword">THEN</code></a>
                <a href="null_p.html#fv_fill_modi566" target="origFile">dq = -(q(i, k, ic)*dp(i, k))</a>
                <a href="null_p.html#fv_fill_modi565" target="origFile"><code class="keyword">CALL </code><code class="funcname">PUSHCONTROL1B</code>(<code class="constant">0</code>)</a>
              <a href="null_p.html#fv_fill_modi565" target="origFile"><code class="keyword">ELSE</code></a>
                <a href="null_p.html#fv_fill_modi567" target="origFile">dq = q(i, k-<code class="constant">1</code>, ic)*dp(i, k-<code class="constant">1</code>)</a>
                <a href="null_p.html#fv_fill_modi565" target="origFile"><code class="keyword">CALL </code><code class="funcname">PUSHCONTROL1B</code>(<code class="constant">1</code>)</a>
              <a href="null_p.html#fv_fill_modi565" target="origFile"><code class="keyword">END IF</code></a>
              <a href="null_p.html#fv_fill_modi568" target="origFile"><code class="keyword">CALL </code><code class="funcname">PUSHREAL8</code>(q(i, k-<code class="constant">1</code>, ic))</a>
              <a href="null_p.html#fv_fill_modi568" target="origFile">q(i, k-<code class="constant">1</code>, ic) = q(i, k-<code class="constant">1</code>, ic) - dq/dp(i, k-<code class="constant">1</code>)</a>
              <a href="null_p.html#fv_fill_modi569" target="origFile"><code class="keyword">CALL </code><code class="funcname">PUSHREAL8</code>(q(i, k, ic))</a>
              <a href="null_p.html#fv_fill_modi569" target="origFile">q(i, k, ic) = q(i, k, ic) + dq/dp(i, k)</a>
              <a href="null_p.html#fv_fill_modi564" target="origFile"><code class="keyword">CALL </code><code class="funcname">PUSHCONTROL1B</code>(<code class="constant">0</code>)</a>
            <a href="null_p.html#fv_fill_modi564" target="origFile"><code class="keyword">ELSE</code></a>
              <a href="null_p.html#fv_fill_modi564" target="origFile"><code class="keyword">CALL </code><code class="funcname">PUSHCONTROL1B</code>(<code class="constant">1</code>)</a>
            <a href="null_p.html#fv_fill_modi564" target="origFile"><code class="keyword">END IF</code></a>
            <a href="null_p.html#fv_fill_modi570" target="origFile"><code class="keyword">IF</code> (q(i, k, ic) .LT. <code class="constant">0.0 </code>.AND. q(i, k+<code class="constant">1</code>, ic) .GT. <code class="constant">0.</code>) <code class="keyword">THEN</code></a>
              <a href="null_p.html#fv_fill_modi571" target="origFile"><code class="keyword">IF</code> (q(i, k+<code class="constant">1</code>, ic)*dp(i, k+<code class="constant">1</code>) .GT. -(q(i, k, ic)*dp(i, k))<code class="label">&</code></a>
<a href="null_p.html#fv_fill_modi571" target="origFile"><code class="label">&             </code>) <code class="keyword">THEN</code></a>
                <a href="null_p.html#fv_fill_modi572" target="origFile">dq = -(q(i, k, ic)*dp(i, k))</a>
                <a href="null_p.html#fv_fill_modi571" target="origFile"><code class="keyword">CALL </code><code class="funcname">PUSHCONTROL1B</code>(<code class="constant">0</code>)</a>
              <a href="null_p.html#fv_fill_modi571" target="origFile"><code class="keyword">ELSE</code></a>
                <a href="null_p.html#fv_fill_modi573" target="origFile">dq = q(i, k+<code class="constant">1</code>, ic)*dp(i, k+<code class="constant">1</code>)</a>
                <a href="null_p.html#fv_fill_modi571" target="origFile"><code class="keyword">CALL </code><code class="funcname">PUSHCONTROL1B</code>(<code class="constant">1</code>)</a>
              <a href="null_p.html#fv_fill_modi571" target="origFile"><code class="keyword">END IF</code></a>
              <a href="null_p.html#fv_fill_modi574" target="origFile"><code class="keyword">CALL </code><code class="funcname">PUSHREAL8</code>(q(i, k+<code class="constant">1</code>, ic))</a>
              <a href="null_p.html#fv_fill_modi574" target="origFile">q(i, k+<code class="constant">1</code>, ic) = q(i, k+<code class="constant">1</code>, ic) - dq/dp(i, k+<code class="constant">1</code>)</a>
              <a href="null_p.html#fv_fill_modi575" target="origFile"><code class="keyword">CALL </code><code class="funcname">PUSHREAL8</code>(q(i, k, ic))</a>
              <a href="null_p.html#fv_fill_modi575" target="origFile">q(i, k, ic) = q(i, k, ic) + dq/dp(i, k)</a>
              <a href="null_p.html#fv_fill_modi570" target="origFile"><code class="keyword">CALL </code><code class="funcname">PUSHCONTROL2B</code>(<code class="constant">2</code>)</a>
            <a href="null_p.html#fv_fill_modi570" target="origFile"><code class="keyword">ELSE</code></a>
              <a href="null_p.html#fv_fill_modi570" target="origFile"><code class="keyword">CALL </code><code class="funcname">PUSHCONTROL2B</code>(<code class="constant">1</code>)</a>
            <a href="null_p.html#fv_fill_modi570" target="origFile"><code class="keyword">END IF</code></a>
          <a href="null_p.html#fv_fill_modi562" target="origFile"><code class="keyword">ELSE</code></a>
            <a href="null_p.html#fv_fill_modi562" target="origFile"><code class="keyword">CALL </code><code class="funcname">PUSHCONTROL2B</code>(<code class="constant">0</code>)</a>
          <a href="null_p.html#fv_fill_modi562" target="origFile"><code class="keyword">END IF</code></a>
        <a href="null_p.html#fv_fill_modi576" target="origFile"><code class="keyword">END DO</code></a>
      <a href="null_p.html#fv_fill_modi577" target="origFile"><code class="keyword">END DO</code></a>
<a href="null_p.html#fv_fill_modi578" target="origFile"><code class="comment">! Bottom layer</code></a>
      <a href="null_p.html#fv_fill_modi578" target="origFile">k = km</a>
      <a href="null_p.html#fv_fill_modi588" target="origFile"><code class="keyword">DO </code>i=<code class="constant">1</code>,im</a>
        <a href="null_p.html#fv_fill_modi579" target="origFile"><code class="keyword">IF</code> (q(i, k, ic) .LT. <code class="constant">0. </code>.AND. q(i, k-<code class="constant">1</code>, ic) .GT. <code class="constant">0.</code>) <code class="keyword">THEN</code></a>
          <a href="null_p.html#fv_fill_modi580" target="origFile">zfix(i) = <code class="constant">.true.</code></a>
<a href="null_p.html#fv_fill_modi581" target="origFile"><code class="comment">! Borrow from above</code></a>
          <a href="null_p.html#fv_fill_modi581" target="origFile">qup = q(i, k-<code class="constant">1</code>, ic)*dp(i, k-<code class="constant">1</code>)</a>
          <a href="null_p.html#fv_fill_modi582" target="origFile">qly = -(q(i, k, ic)*dp(i, k))</a>
          <a href="null_p.html#fv_fill_modi583" target="origFile"><code class="keyword">IF</code> (qly .GT. qup) <code class="keyword">THEN</code></a>
            <a href="null_p.html#fv_fill_modi584" target="origFile">dup = qup</a>
            <a href="null_p.html#fv_fill_modi583" target="origFile"><code class="keyword">CALL </code><code class="funcname">PUSHCONTROL1B</code>(<code class="constant">0</code>)</a>
          <a href="null_p.html#fv_fill_modi583" target="origFile"><code class="keyword">ELSE</code></a>
            <a href="null_p.html#fv_fill_modi585" target="origFile">dup = qly</a>
            <a href="null_p.html#fv_fill_modi583" target="origFile"><code class="keyword">CALL </code><code class="funcname">PUSHCONTROL1B</code>(<code class="constant">1</code>)</a>
          <a href="null_p.html#fv_fill_modi583" target="origFile"><code class="keyword">END IF</code></a>
          <a href="null_p.html#fv_fill_modi586" target="origFile"><code class="keyword">CALL </code><code class="funcname">PUSHREAL8</code>(q(i, k-<code class="constant">1</code>, ic))</a>
          <a href="null_p.html#fv_fill_modi586" target="origFile">q(i, k-<code class="constant">1</code>, ic) = q(i, k-<code class="constant">1</code>, ic) - dup/dp(i, k-<code class="constant">1</code>)</a>
          <a href="null_p.html#fv_fill_modi587" target="origFile"><code class="keyword">CALL </code><code class="funcname">PUSHREAL8</code>(q(i, k, ic))</a>
          <a href="null_p.html#fv_fill_modi587" target="origFile">q(i, k, ic) = q(i, k, ic) + dup/dp(i, k)</a>
          <a href="null_p.html#fv_fill_modi579" target="origFile"><code class="keyword">CALL </code><code class="funcname">PUSHCONTROL1B</code>(<code class="constant">1</code>)</a>
        <a href="null_p.html#fv_fill_modi579" target="origFile"><code class="keyword">ELSE</code></a>
          <a href="null_p.html#fv_fill_modi579" target="origFile"><code class="keyword">CALL </code><code class="funcname">PUSHCONTROL1B</code>(<code class="constant">0</code>)</a>
        <a href="null_p.html#fv_fill_modi579" target="origFile"><code class="keyword">END IF</code></a>
      <a href="null_p.html#fv_fill_modi588" target="origFile"><code class="keyword">END DO</code></a>
<a href="null_p.html#fv_fill_modi606" target="origFile"><code class="comment">! Perform final check and non-local fix if needed</code></a>
      <a href="null_p.html#fv_fill_modi606" target="origFile"><code class="keyword">DO </code>i=<code class="constant">1</code>,im</a>
        <a href="null_p.html#fv_fill_modi589" target="origFile"><code class="keyword">IF</code> (zfix(i)) <code class="keyword">THEN</code></a>
          <a href="null_p.html#fv_fill_modi590" target="origFile"><code class="keyword">CALL </code><code class="funcname">PUSHREAL8</code>(sum0)</a>
          <a href="null_p.html#fv_fill_modi590" target="origFile">sum0 = <code class="constant">0.</code></a>
          <a href="null_p.html#fv_fill_modi589" target="origFile"><code class="keyword">CALL </code><code class="funcname">PUSHINTEGER4</code>(k)</a>
          <a href="null_p.html#fv_fill_modi593" target="origFile"><code class="keyword">DO </code>k=<code class="constant">2</code>,km</a>
            <a href="null_p.html#fv_fill_modi591" target="origFile"><code class="keyword">CALL </code><code class="funcname">PUSHREAL8</code>(dm(k))</a>
            <a href="null_p.html#fv_fill_modi591" target="origFile">dm(k) = q(i, k, ic)*dp(i, k)</a>
            <a href="null_p.html#fv_fill_modi592" target="origFile">sum0 = sum0 + dm(k)</a>
          <a href="null_p.html#fv_fill_modi593" target="origFile"><code class="keyword">END DO</code></a>
          <a href="null_p.html#fv_fill_modi594" target="origFile"><code class="keyword">IF</code> (sum0 .GT. <code class="constant">0.</code>) <code class="keyword">THEN</code></a>
            <a href="null_p.html#fv_fill_modi595" target="origFile"><code class="keyword">CALL </code><code class="funcname">PUSHREAL8</code>(sum1)</a>
            <a href="null_p.html#fv_fill_modi595" target="origFile">sum1 = <code class="constant">0.</code></a>
            <a href="null_p.html#fv_fill_modi600" target="origFile"><code class="keyword">DO </code>k=<code class="constant">2</code>,km</a>
              <a href="null_p.html#fv_fill_modi596" target="origFile"><code class="keyword">IF</code> (<code class="constant">0. </code>.LT. dm(k)) <code class="keyword">THEN</code></a>
                <a href="null_p.html#fv_fill_modi597" target="origFile">max1 = dm(k)</a>
                <a href="null_p.html#fv_fill_modi596" target="origFile"><code class="keyword">CALL </code><code class="funcname">PUSHCONTROL1B</code>(<code class="constant">0</code>)</a>
              <a href="null_p.html#fv_fill_modi596" target="origFile"><code class="keyword">ELSE</code></a>
                <a href="null_p.html#fv_fill_modi596" target="origFile"><code class="keyword">CALL </code><code class="funcname">PUSHCONTROL1B</code>(<code class="constant">1</code>)</a>
                <a href="null_p.html#fv_fill_modi598" target="origFile">max1 = <code class="constant">0.</code></a>
              <a href="null_p.html#fv_fill_modi596" target="origFile"><code class="keyword">END IF</code></a>
              <a href="null_p.html#fv_fill_modi599" target="origFile">sum1 = sum1 + max1</a>
            <a href="null_p.html#fv_fill_modi600" target="origFile"><code class="keyword">END DO</code></a>
            <a href="null_p.html#fv_fill_modi601" target="origFile"><code class="keyword">CALL </code><code class="funcname">PUSHREAL8</code>(fac)</a>
            <a href="null_p.html#fv_fill_modi601" target="origFile">fac = sum0/sum1</a>
            <a href="null_p.html#fv_fill_modi605" target="origFile"><code class="keyword">DO </code>k=<code class="constant">2</code>,km</a>
              <a href="null_p.html#fv_fill_modi602" target="origFile"><code class="keyword">IF</code> (<code class="constant">0. </code>.LT. fac*dm(k)/dp(i, k)) <code class="keyword">THEN</code></a>
                <a href="null_p.html#fv_fill_modi602" target="origFile"><code class="keyword">CALL </code><code class="funcname">PUSHCONTROL1B</code>(<code class="constant">0</code>)</a>
              <a href="null_p.html#fv_fill_modi602" target="origFile"><code class="keyword">ELSE</code></a>
                <a href="null_p.html#fv_fill_modi602" target="origFile"><code class="keyword">CALL </code><code class="funcname">PUSHCONTROL1B</code>(<code class="constant">1</code>)</a>
              <a href="null_p.html#fv_fill_modi602" target="origFile"><code class="keyword">END IF</code></a>
            <a href="null_p.html#fv_fill_modi605" target="origFile"><code class="keyword">END DO</code></a>
            <a href="null_p.html#fv_fill_modi594" target="origFile"><code class="keyword">CALL </code><code class="funcname">PUSHCONTROL2B</code>(<code class="constant">2</code>)</a>
          <a href="null_p.html#fv_fill_modi594" target="origFile"><code class="keyword">ELSE</code></a>
            <a href="null_p.html#fv_fill_modi594" target="origFile"><code class="keyword">CALL </code><code class="funcname">PUSHCONTROL2B</code>(<code class="constant">1</code>)</a>
          <a href="null_p.html#fv_fill_modi594" target="origFile"><code class="keyword">END IF</code></a>
        <a href="null_p.html#fv_fill_modi589" target="origFile"><code class="keyword">ELSE</code></a>
          <a href="null_p.html#fv_fill_modi589" target="origFile"><code class="keyword">CALL </code><code class="funcname">PUSHCONTROL2B</code>(<code class="constant">0</code>)</a>
        <a href="null_p.html#fv_fill_modi589" target="origFile"><code class="keyword">END IF</code></a>
      <a href="null_p.html#fv_fill_modi606" target="origFile"><code class="keyword">END DO</code></a>
    <a href="null_p.html#fv_fill_modi607" target="origFile"><code class="keyword">END DO</code></a>
    <a href="null_p.html#fv_fill_mod" target="origFile">dm_ad = <code class="constant">0.0_8</code></a>
    <a href="null_p.html#fv_fill_mod" target="origFile"><code class="keyword">DO </code>ic=nq,<code class="constant">1</code>,<code class="constant">-1</code></a>
      <a href="null_p.html#fv_fill_mod" target="origFile"><code class="keyword">DO </code>i=im,<code class="constant">1</code>,<code class="constant">-1</code></a>
        <a href="null_p.html#fv_fill_mod" target="origFile"><code class="keyword">CALL </code><code class="funcname">POPCONTROL2B</code>(branch)</a>
        <a href="null_p.html#fv_fill_mod" target="origFile"><code class="keyword">IF</code> (branch .NE. <code class="constant">0</code>) <code class="keyword">THEN</code></a>
          <a href="null_p.html#fv_fill_mod" target="origFile"><code class="keyword">IF</code> (branch .EQ. <code class="constant">1</code>) <code class="keyword">THEN</code></a>
            <a href="null_p.html#fv_fill_mod" target="origFile">sum0_ad = <code class="constant">0.0_8</code></a>
          <a href="null_p.html#fv_fill_mod" target="origFile"><code class="keyword">ELSE</code></a>
            <a href="null_p.html#fv_fill_mod" target="origFile">fac_ad = <code class="constant">0.0_8</code></a>
            <a href="null_p.html#fv_fill_mod" target="origFile"><code class="keyword">DO </code>k=km,<code class="constant">2</code>,<code class="constant">-1</code></a>
<a name="fillz_admi175"></a>              <a href="null_p.html#fv_fill_mod" target="origFile"><code class="keyword">CALL </code><code class="funcname">POPCONTROL1B</code>(branch)</a>
              <a href="null_p.html#fv_fill_mod" target="origFile"><code class="keyword">IF</code> (branch .EQ. <code class="constant">0</code>) <code class="keyword">THEN</code></a>
                <a href="null_p.html#fv_fill_modi603" target="origFile">temp_ad = q_ad(i, k, ic)/dp(i, k)</a>
                <a href="null_p.html#fv_fill_modi603" target="origFile">fac_ad = fac_ad + dm(k)*temp_ad</a>
                <a href="null_p.html#fv_fill_modi603" target="origFile">dm_ad(k) = dm_ad(k) + fac*temp_ad</a>
<a name="fillz_admi176"></a>                <a href="null_p.html#fv_fill_modi603" target="origFile">q_ad(i, k, ic) = <code class="constant">0.0_8</code></a>
              <a href="null_p.html#fv_fill_mod" target="origFile"><code class="keyword">ELSE</code></a>
                <a href="null_p.html#fv_fill_modi604" target="origFile">q_ad(i, k, ic) = <code class="constant">0.0_8</code></a>
<a name="fillz_admi174"></a>              <a href="null_p.html#fv_fill_mod" target="origFile"><code class="keyword">END IF</code></a>
            <a href="null_p.html#fv_fill_mod" target="origFile"><code class="keyword">END DO</code></a>
            <a href="null_p.html#fv_fill_modi601" target="origFile"><code class="keyword">CALL </code><code class="funcname">POPREAL8</code>(fac)</a>
            <a href="null_p.html#fv_fill_modi601" target="origFile">sum0_ad = fac_ad/sum1</a>
<a name="fillz_admi173"></a>            <a href="null_p.html#fv_fill_modi601" target="origFile">sum1_ad = -(sum0*fac_ad/sum1**<code class="constant">2</code>)</a>
            <a href="null_p.html#fv_fill_mod" target="origFile"><code class="keyword">DO </code>k=km,<code class="constant">2</code>,<code class="constant">-1</code></a>
<a name="fillz_admi172"></a>              <a href="null_p.html#fv_fill_modi599" target="origFile">max1_ad = sum1_ad</a>
              <a href="null_p.html#fv_fill_mod" target="origFile"><code class="keyword">CALL </code><code class="funcname">POPCONTROL1B</code>(branch)</a>
<a name="fillz_admi171"></a>              <a href="null_p.html#fv_fill_mod" target="origFile"><code class="keyword">IF</code> (branch .EQ. <code class="constant">0</code>) </a><a href="null_p.html#fv_fill_modi597" target="origFile">dm_ad(k) = dm_ad(k) + max1_ad</a>
            <a href="null_p.html#fv_fill_mod" target="origFile"><code class="keyword">END DO</code></a>
            <a href="null_p.html#fv_fill_modi595" target="origFile"><code class="keyword">CALL </code><code class="funcname">POPREAL8</code>(sum1)</a>
<a name="fillz_admi169"></a>          <a href="null_p.html#fv_fill_mod" target="origFile"><code class="keyword">END IF</code></a>
<a name="fillz_admi170"></a>          <a href="null_p.html#fv_fill_mod" target="origFile"><code class="keyword">DO </code>k=km,<code class="constant">2</code>,<code class="constant">-1</code></a>
            <a href="null_p.html#fv_fill_modi592" target="origFile">dm_ad(k) = dm_ad(k) + sum0_ad</a>
            <a href="null_p.html#fv_fill_modi591" target="origFile"><code class="keyword">CALL </code><code class="funcname">POPREAL8</code>(dm(k))</a>
            <a href="null_p.html#fv_fill_modi591" target="origFile">q_ad(i, k, ic) = q_ad(i, k, ic) + dp(i, k)*dm_ad(k)</a>
            <a href="null_p.html#fv_fill_modi591" target="origFile">dm_ad(k) = <code class="constant">0.0_8</code></a>
<a name="fillz_admi168"></a>          <a href="null_p.html#fv_fill_mod" target="origFile"><code class="keyword">END DO</code></a>
          <a href="null_p.html#fv_fill_mod" target="origFile"><code class="keyword">CALL </code><code class="funcname">POPINTEGER4</code>(k)</a>
          <a href="null_p.html#fv_fill_modi590" target="origFile"><code class="keyword">CALL </code><code class="funcname">POPREAL8</code>(sum0)</a>
        <a href="null_p.html#fv_fill_mod" target="origFile"><code class="keyword">END IF</code></a>
      <a href="null_p.html#fv_fill_mod" target="origFile"><code class="keyword">END DO</code></a>
      <a href="null_p.html#fv_fill_mod" target="origFile"><code class="keyword">DO </code>i=im,<code class="constant">1</code>,<code class="constant">-1</code></a>
<a name="fillz_admi166"></a>        <a href="null_p.html#fv_fill_mod" target="origFile"><code class="keyword">CALL </code><code class="funcname">POPCONTROL1B</code>(branch)</a>
        <a href="null_p.html#fv_fill_mod" target="origFile"><code class="keyword">IF</code> (branch .NE. <code class="constant">0</code>) <code class="keyword">THEN</code></a>
<a name="fillz_admi167"></a>          <a href="null_p.html#fv_fill_modi587" target="origFile"><code class="keyword">CALL </code><code class="funcname">POPREAL8</code>(q(i, k, ic))</a>
          <a href="null_p.html#fv_fill_modi587" target="origFile">dup_ad = q_ad(i, k, ic)/dp(i, k) - q_ad(i, k-<code class="constant">1</code>, ic)/dp(i, k-<code class="constant">1</code>)</a>
          <a href="null_p.html#fv_fill_modi586" target="origFile"><code class="keyword">CALL </code><code class="funcname">POPREAL8</code>(q(i, k-<code class="constant">1</code>, ic))</a>
<a name="fillz_admi164"></a>          <a href="null_p.html#fv_fill_mod" target="origFile"><code class="keyword">CALL </code><code class="funcname">POPCONTROL1B</code>(branch)</a>
          <a href="null_p.html#fv_fill_mod" target="origFile"><code class="keyword">IF</code> (branch .EQ. <code class="constant">0</code>) <code class="keyword">THEN</code></a>
            <a href="null_p.html#fv_fill_modi584" target="origFile">qup_ad = dup_ad</a>
<a name="fillz_admi165"></a>            <a href="null_p.html#fv_fill_mod" target="origFile">qly_ad = <code class="constant">0.0_8</code></a>
          <a href="null_p.html#fv_fill_mod" target="origFile"><code class="keyword">ELSE</code></a>
            <a href="null_p.html#fv_fill_modi585" target="origFile">qly_ad = dup_ad</a>
<a name="fillz_admi162"></a>            <a href="null_p.html#fv_fill_mod" target="origFile">qup_ad = <code class="constant">0.0_8</code></a>
<a name="fillz_admi163"></a>          <a href="null_p.html#fv_fill_mod" target="origFile"><code class="keyword">END IF</code></a>
          <a href="null_p.html#fv_fill_modi582" target="origFile">q_ad(i, k, ic) = q_ad(i, k, ic) - dp(i, k)*qly_ad</a>
          <a href="null_p.html#fv_fill_modi581" target="origFile">q_ad(i, k-<code class="constant">1</code>, ic) = q_ad(i, k-<code class="constant">1</code>, ic) + dp(i, k-<code class="constant">1</code>)*qup_ad</a>
        <a href="null_p.html#fv_fill_mod" target="origFile"><code class="keyword">END IF</code></a>
      <a href="null_p.html#fv_fill_mod" target="origFile"><code class="keyword">END DO</code></a>
      <a href="null_p.html#fv_fill_mod" target="origFile"><code class="keyword">DO </code>k=km-<code class="constant">1</code>,<code class="constant">2</code>,<code class="constant">-1</code></a>
        <a href="null_p.html#fv_fill_mod" target="origFile"><code class="keyword">DO </code>i=im,<code class="constant">1</code>,<code class="constant">-1</code></a>
          <a href="null_p.html#fv_fill_mod" target="origFile"><code class="keyword">CALL </code><code class="funcname">POPCONTROL2B</code>(branch)</a>
<a name="fillz_admi160"></a>          <a href="null_p.html#fv_fill_mod" target="origFile"><code class="keyword">IF</code> (branch .NE. <code class="constant">0</code>) <code class="keyword">THEN</code></a>
            <a href="null_p.html#fv_fill_mod" target="origFile"><code class="keyword">IF</code> (branch .NE. <code class="constant">1</code>) <code class="keyword">THEN</code></a>
              <a href="null_p.html#fv_fill_modi575" target="origFile"><code class="keyword">CALL </code><code class="funcname">POPREAL8</code>(q(i, k, ic))</a>
<a name="fillz_admi161"></a>              <a href="null_p.html#fv_fill_modi575" target="origFile">dq_ad = q_ad(i, k, ic)/dp(i, k) - q_ad(i, k+<code class="constant">1</code>, ic)/dp(i, k<code class="label">&</code></a>
<a href="null_p.html#fv_fill_modi575" target="origFile"><code class="label">&               </code>+<code class="constant">1</code>)</a>
              <a href="null_p.html#fv_fill_modi574" target="origFile"><code class="keyword">CALL </code><code class="funcname">POPREAL8</code>(q(i, k+<code class="constant">1</code>, ic))</a>
<a name="fillz_admi158"></a>              <a href="null_p.html#fv_fill_mod" target="origFile"><code class="keyword">CALL </code><code class="funcname">POPCONTROL1B</code>(branch)</a>
              <a href="null_p.html#fv_fill_mod" target="origFile"><code class="keyword">IF</code> (branch .EQ. <code class="constant">0</code>) <code class="keyword">THEN</code></a>
<a name="fillz_admi159"></a>                <a href="null_p.html#fv_fill_modi572" target="origFile">q_ad(i, k, ic) = q_ad(i, k, ic) - dp(i, k)*dq_ad</a>
              <a href="null_p.html#fv_fill_mod" target="origFile"><code class="keyword">ELSE</code></a>
                <a href="null_p.html#fv_fill_modi573" target="origFile">q_ad(i, k+<code class="constant">1</code>, ic) = q_ad(i, k+<code class="constant">1</code>, ic) + dp(i, k+<code class="constant">1</code>)*dq_ad</a>
              <a href="null_p.html#fv_fill_mod" target="origFile"><code class="keyword">END IF</code></a>
            <a href="null_p.html#fv_fill_mod" target="origFile"><code class="keyword">END IF</code></a>
<a name="fillz_admi156"></a>            <a href="null_p.html#fv_fill_mod" target="origFile"><code class="keyword">CALL </code><code class="funcname">POPCONTROL1B</code>(branch)</a>
            <a href="null_p.html#fv_fill_mod" target="origFile"><code class="keyword">IF</code> (branch .EQ. <code class="constant">0</code>) <code class="keyword">THEN</code></a>
              <a href="null_p.html#fv_fill_modi569" target="origFile"><code class="keyword">CALL </code><code class="funcname">POPREAL8</code>(q(i, k, ic))</a>
<a name="fillz_admi157"></a>              <a href="null_p.html#fv_fill_modi569" target="origFile">dq_ad = q_ad(i, k, ic)/dp(i, k) - q_ad(i, k-<code class="constant">1</code>, ic)/dp(i, k<code class="label">&</code></a>
<a href="null_p.html#fv_fill_modi569" target="origFile"><code class="label">&               </code>-<code class="constant">1</code>)</a>
              <a href="null_p.html#fv_fill_modi568" target="origFile"><code class="keyword">CALL </code><code class="funcname">POPREAL8</code>(q(i, k-<code class="constant">1</code>, ic))</a>
<a name="fillz_admi154"></a>              <a href="null_p.html#fv_fill_mod" target="origFile"><code class="keyword">CALL </code><code class="funcname">POPCONTROL1B</code>(branch)</a>
              <a href="null_p.html#fv_fill_mod" target="origFile"><code class="keyword">IF</code> (branch .EQ. <code class="constant">0</code>) <code class="keyword">THEN</code></a>
<a name="fillz_admi155"></a>                <a href="null_p.html#fv_fill_modi566" target="origFile">q_ad(i, k, ic) = q_ad(i, k, ic) - dp(i, k)*dq_ad</a>
              <a href="null_p.html#fv_fill_mod" target="origFile"><code class="keyword">ELSE</code></a>
                <a href="null_p.html#fv_fill_modi567" target="origFile">q_ad(i, k-<code class="constant">1</code>, ic) = q_ad(i, k-<code class="constant">1</code>, ic) + dp(i, k-<code class="constant">1</code>)*dq_ad</a>
              <a href="null_p.html#fv_fill_mod" target="origFile"><code class="keyword">END IF</code></a>
            <a href="null_p.html#fv_fill_mod" target="origFile"><code class="keyword">END IF</code></a>
          <a href="null_p.html#fv_fill_mod" target="origFile"><code class="keyword">END IF</code></a>
        <a href="null_p.html#fv_fill_mod" target="origFile"><code class="keyword">END DO</code></a>
      <a href="null_p.html#fv_fill_mod" target="origFile"><code class="keyword">END DO</code></a>
      <a href="null_p.html#fv_fill_mod" target="origFile"><code class="keyword">CALL </code><code class="funcname">POPINTEGER4</code>(k)</a>
      <a href="null_p.html#fv_fill_mod" target="origFile"><code class="keyword">DO </code>i=im,<code class="constant">1</code>,<code class="constant">-1</code></a>
<a name="fillz_admi152"></a>        <a href="null_p.html#fv_fill_mod" target="origFile"><code class="keyword">CALL </code><code class="funcname">POPCONTROL1B</code>(branch)</a>
        <a href="null_p.html#fv_fill_mod" target="origFile"><code class="keyword">IF</code> (branch .NE. <code class="constant">0</code>) <code class="keyword">THEN</code></a>
<a name="fillz_admi153"></a>          <a href="null_p.html#fv_fill_modi559" target="origFile"><code class="keyword">CALL </code><code class="funcname">POPREAL8</code>(q(i, <code class="constant">1</code>, ic))</a>
          <a href="null_p.html#fv_fill_modi559" target="origFile">q_ad(i, <code class="constant">1</code>, ic) = dp(i, <code class="constant">1</code>)*q_ad(i, <code class="constant">2</code>, ic)/dp(i, <code class="constant">2</code>)</a>
          <a href="null_p.html#fv_fill_modi558" target="origFile"><code class="keyword">CALL </code><code class="funcname">POPREAL8</code>(q(i, <code class="constant">2</code>, ic))</a>
        <a href="null_p.html#fv_fill_mod" target="origFile"><code class="keyword">END IF</code></a>
      <a href="null_p.html#fv_fill_mod" target="origFile"><code class="keyword">END DO</code></a>
<a name="fillz"></a>    <a href="null_p.html#fv_fill_mod" target="origFile"><code class="keyword">END DO</code></a>
  <a href="null_p.html#fv_fill_mod" target="origFile"><code class="keyword">END SUBROUTINE </code><code class="funcname">FILLZ_ADM</code></a>
  <a href="null_p.html#fv_fill_mod" target="origFile"><code class="keyword">SUBROUTINE </code><code class="funcname">FILLZ</code>(<code class="vardecl">im</code>, <code class="vardecl">km</code>, <code class="vardecl">nq</code>, <code class="vardecl">q</code>, <code class="vardecl">dp</code>)</a>
    <a href="null_p.html#fv_fill_mod" target="origFile"><code class="keyword">IMPLICIT NONE</code></a>
<a href="null_p.html#fv_fill_mod" target="origFile"><code class="comment">! No. of longitudes</code></a>
    <a href="null_p.html#fv_fill_mod" target="origFile"><code class="typename">INTEGER</code>, <code class="typename">INTENT(IN) </code>:: <code class="vardecl">im</code></a>
<a href="null_p.html#fv_fill_mod" target="origFile"><code class="comment">! No. of levels</code></a>
    <a href="null_p.html#fv_fill_mod" target="origFile"><code class="typename">INTEGER</code>, <code class="typename">INTENT(IN) </code>:: <code class="vardecl">km</code></a>
<a href="null_p.html#fv_fill_mod" target="origFile"><code class="comment">! Total number of tracers</code></a>
    <a href="null_p.html#fv_fill_mod" target="origFile"><code class="typename">INTEGER</code>, <code class="typename">INTENT(IN) </code>:: <code class="vardecl">nq</code></a>
<a href="null_p.html#fv_fill_mod" target="origFile"><code class="comment">! pressure thickness</code></a>
    <a href="null_p.html#fv_fill_mod" target="origFile"><code class="typename">REAL(</code><code class="modifier">real8</code><code class="typename">)</code>, <code class="typename">INTENT(IN) </code>:: <code class="vardecl">dp</code>(<code class="vardecl">im</code>, <code class="vardecl">km</code>)</a>
<a href="null_p.html#fv_fill_mod" target="origFile"><code class="comment">! tracer mixing ratio</code></a>
    <a href="null_p.html#fv_fill_mod" target="origFile"><code class="typename">REAL(</code><code class="modifier">real8</code><code class="typename">)</code>, <code class="typename">INTENT(INOUT) </code>:: <code class="vardecl">q</code>(<code class="vardecl">im</code>, <code class="vardecl">km</code>, <code class="vardecl">nq</code>)</a>
<a href="null_p.html#fv_fill_mod" target="origFile"><code class="comment">! !LOCAL VARIABLES:</code></a>
    <a href="null_p.html#fv_fill_mod" target="origFile"><code class="typename">LOGICAL </code>:: <code class="vardecl">zfix</code>(<code class="vardecl">im</code>)</a>
    <a href="null_p.html#fv_fill_mod" target="origFile"><code class="typename">REAL(</code><code class="modifier">real8</code><code class="typename">) </code>:: <code class="vardecl">dm</code>(<code class="vardecl">km</code>)</a>
    <a href="null_p.html#fv_fill_mod" target="origFile"><code class="typename">INTEGER </code>:: <code class="vardecl">i</code>, <code class="vardecl">k</code>, <code class="vardecl">ic</code></a>
    <a href="null_p.html#fv_fill_mod" target="origFile"><code class="typename">REAL(</code><code class="modifier">real8</code><code class="typename">) </code>:: <code class="vardecl">qup</code>, <code class="vardecl">qly</code>, <code class="vardecl">dup</code>, <code class="vardecl">dq</code>, <code class="vardecl">sum0</code>, <code class="vardecl">sum1</code>, <code class="vardecl">fac</code></a>
    <a href="null_p.html#fv_fill_mod" target="origFile"><code class="keyword">INTRINSIC </code><code class="funcname">MIN</code></a>
    <a href="null_p.html#fv_fill_mod" target="origFile"><code class="keyword">INTRINSIC </code><code class="funcname">MAX</code></a>
    <a href="null_p.html#fv_fill_mod" target="origFile"><code class="typename">REAL*8 </code>:: <code class="vardecl">max1</code></a>
    <a href="null_p.html#fv_fill_mod" target="origFile"><code class="keyword">DO </code>ic=<code class="constant">1</code>,nq</a>
<a href="null_p.html#fv_fill_mod" target="origFile"><code class="comment">! Top layer</code></a>
      <a href="null_p.html#fv_fill_mod" target="origFile"><code class="keyword">DO </code>i=<code class="constant">1</code>,im</a>
        <a href="null_p.html#fv_fill_mod" target="origFile"><code class="keyword">IF</code> (q(i, <code class="constant">1</code>, ic) .LT. <code class="constant">0.</code>) <code class="keyword">THEN</code></a>
          <a href="null_p.html#fv_fill_mod" target="origFile">q(i, <code class="constant">2</code>, ic) = q(i, <code class="constant">2</code>, ic) + q(i, <code class="constant">1</code>, ic)*dp(i, <code class="constant">1</code>)/dp(i, <code class="constant">2</code>)</a>
          <a href="null_p.html#fv_fill_mod" target="origFile">q(i, <code class="constant">1</code>, ic) = <code class="constant">0.</code></a>
        <a href="null_p.html#fv_fill_mod" target="origFile"><code class="keyword">END IF</code></a>
      <a href="null_p.html#fv_fill_mod" target="origFile"><code class="keyword">END DO</code></a>
<a href="null_p.html#fv_fill_mod" target="origFile"><code class="comment">! Interior</code></a>
      <a href="null_p.html#fv_fill_mod" target="origFile">zfix(:) = <code class="constant">.false.</code></a>
      <a href="null_p.html#fv_fill_mod" target="origFile"><code class="keyword">DO </code>k=<code class="constant">2</code>,km-<code class="constant">1</code></a>
        <a href="null_p.html#fv_fill_mod" target="origFile"><code class="keyword">DO </code>i=<code class="constant">1</code>,im</a>
          <a href="null_p.html#fv_fill_mod" target="origFile"><code class="keyword">IF</code> (q(i, k, ic) .LT. <code class="constant">0.</code>) <code class="keyword">THEN</code></a>
            <a href="null_p.html#fv_fill_mod" target="origFile">zfix(i) = <code class="constant">.true.</code></a>
            <a href="null_p.html#fv_fill_mod" target="origFile"><code class="keyword">IF</code> (q(i, k-<code class="constant">1</code>, ic) .GT. <code class="constant">0.</code>) <code class="keyword">THEN</code></a>
              <a href="null_p.html#fv_fill_mod" target="origFile"><code class="keyword">IF</code> (q(i, k-<code class="constant">1</code>, ic)*dp(i, k-<code class="constant">1</code>) .GT. -(q(i, k, ic)*dp(i, k))<code class="label">&</code></a>
<a href="null_p.html#fv_fill_mod" target="origFile"><code class="label">&             </code>) <code class="keyword">THEN</code></a>
                <a href="null_p.html#fv_fill_mod" target="origFile">dq = -(q(i, k, ic)*dp(i, k))</a>
              <a href="null_p.html#fv_fill_mod" target="origFile"><code class="keyword">ELSE</code></a>
                <a href="null_p.html#fv_fill_mod" target="origFile">dq = q(i, k-<code class="constant">1</code>, ic)*dp(i, k-<code class="constant">1</code>)</a>
              <a href="null_p.html#fv_fill_mod" target="origFile"><code class="keyword">END IF</code></a>
              <a href="null_p.html#fv_fill_mod" target="origFile">q(i, k-<code class="constant">1</code>, ic) = q(i, k-<code class="constant">1</code>, ic) - dq/dp(i, k-<code class="constant">1</code>)</a>
              <a href="null_p.html#fv_fill_mod" target="origFile">q(i, k, ic) = q(i, k, ic) + dq/dp(i, k)</a>
            <a href="null_p.html#fv_fill_mod" target="origFile"><code class="keyword">END IF</code></a>
            <a href="null_p.html#fv_fill_mod" target="origFile"><code class="keyword">IF</code> (q(i, k, ic) .LT. <code class="constant">0.0 </code>.AND. q(i, k+<code class="constant">1</code>, ic) .GT. <code class="constant">0.</code>) <code class="keyword">THEN</code></a>
              <a href="null_p.html#fv_fill_mod" target="origFile"><code class="keyword">IF</code> (q(i, k+<code class="constant">1</code>, ic)*dp(i, k+<code class="constant">1</code>) .GT. -(q(i, k, ic)*dp(i, k))<code class="label">&</code></a>
<a href="null_p.html#fv_fill_mod" target="origFile"><code class="label">&             </code>) <code class="keyword">THEN</code></a>
                <a href="null_p.html#fv_fill_mod" target="origFile">dq = -(q(i, k, ic)*dp(i, k))</a>
              <a href="null_p.html#fv_fill_mod" target="origFile"><code class="keyword">ELSE</code></a>
                <a href="null_p.html#fv_fill_mod" target="origFile">dq = q(i, k+<code class="constant">1</code>, ic)*dp(i, k+<code class="constant">1</code>)</a>
              <a href="null_p.html#fv_fill_mod" target="origFile"><code class="keyword">END IF</code></a>
              <a href="null_p.html#fv_fill_mod" target="origFile">q(i, k+<code class="constant">1</code>, ic) = q(i, k+<code class="constant">1</code>, ic) - dq/dp(i, k+<code class="constant">1</code>)</a>
              <a href="null_p.html#fv_fill_mod" target="origFile">q(i, k, ic) = q(i, k, ic) + dq/dp(i, k)</a>
            <a href="null_p.html#fv_fill_mod" target="origFile"><code class="keyword">END IF</code></a>
          <a href="null_p.html#fv_fill_mod" target="origFile"><code class="keyword">END IF</code></a>
        <a href="null_p.html#fv_fill_mod" target="origFile"><code class="keyword">END DO</code></a>
      <a href="null_p.html#fv_fill_mod" target="origFile"><code class="keyword">END DO</code></a>
<a href="null_p.html#fv_fill_mod" target="origFile"><code class="comment">! Bottom layer</code></a>
      <a href="null_p.html#fv_fill_mod" target="origFile">k = km</a>
      <a href="null_p.html#fv_fill_mod" target="origFile"><code class="keyword">DO </code>i=<code class="constant">1</code>,im</a>
        <a href="null_p.html#fv_fill_mod" target="origFile"><code class="keyword">IF</code> (q(i, k, ic) .LT. <code class="constant">0. </code>.AND. q(i, k-<code class="constant">1</code>, ic) .GT. <code class="constant">0.</code>) <code class="keyword">THEN</code></a>
          <a href="null_p.html#fv_fill_mod" target="origFile">zfix(i) = <code class="constant">.true.</code></a>
<a href="null_p.html#fv_fill_mod" target="origFile"><code class="comment">! Borrow from above</code></a>
          <a href="null_p.html#fv_fill_mod" target="origFile">qup = q(i, k-<code class="constant">1</code>, ic)*dp(i, k-<code class="constant">1</code>)</a>
          <a href="null_p.html#fv_fill_mod" target="origFile">qly = -(q(i, k, ic)*dp(i, k))</a>
          <a href="null_p.html#fv_fill_mod" target="origFile"><code class="keyword">IF</code> (qly .GT. qup) <code class="keyword">THEN</code></a>
            <a href="null_p.html#fv_fill_mod" target="origFile">dup = qup</a>
          <a href="null_p.html#fv_fill_mod" target="origFile"><code class="keyword">ELSE</code></a>
            <a href="null_p.html#fv_fill_mod" target="origFile">dup = qly</a>
          <a href="null_p.html#fv_fill_mod" target="origFile"><code class="keyword">END IF</code></a>
          <a href="null_p.html#fv_fill_mod" target="origFile">q(i, k-<code class="constant">1</code>, ic) = q(i, k-<code class="constant">1</code>, ic) - dup/dp(i, k-<code class="constant">1</code>)</a>
          <a href="null_p.html#fv_fill_mod" target="origFile">q(i, k, ic) = q(i, k, ic) + dup/dp(i, k)</a>
        <a href="null_p.html#fv_fill_mod" target="origFile"><code class="keyword">END IF</code></a>
      <a href="null_p.html#fv_fill_mod" target="origFile"><code class="keyword">END DO</code></a>
<a href="null_p.html#fv_fill_mod" target="origFile"><code class="comment">! Perform final check and non-local fix if needed</code></a>
      <a href="null_p.html#fv_fill_mod" target="origFile"><code class="keyword">DO </code>i=<code class="constant">1</code>,im</a>
        <a href="null_p.html#fv_fill_mod" target="origFile"><code class="keyword">IF</code> (zfix(i)) <code class="keyword">THEN</code></a>
          <a href="null_p.html#fv_fill_mod" target="origFile">sum0 = <code class="constant">0.</code></a>
          <a href="null_p.html#fv_fill_mod" target="origFile"><code class="keyword">DO </code>k=<code class="constant">2</code>,km</a>
            <a href="null_p.html#fv_fill_mod" target="origFile">dm(k) = q(i, k, ic)*dp(i, k)</a>
            <a href="null_p.html#fv_fill_mod" target="origFile">sum0 = sum0 + dm(k)</a>
          <a href="null_p.html#fv_fill_mod" target="origFile"><code class="keyword">END DO</code></a>
          <a href="null_p.html#fv_fill_mod" target="origFile"><code class="keyword">IF</code> (sum0 .GT. <code class="constant">0.</code>) <code class="keyword">THEN</code></a>
            <a href="null_p.html#fv_fill_mod" target="origFile">sum1 = <code class="constant">0.</code></a>
            <a href="null_p.html#fv_fill_mod" target="origFile"><code class="keyword">DO </code>k=<code class="constant">2</code>,km</a>
              <a href="null_p.html#fv_fill_mod" target="origFile"><code class="keyword">IF</code> (<code class="constant">0. </code>.LT. dm(k)) <code class="keyword">THEN</code></a>
                <a href="null_p.html#fv_fill_mod" target="origFile">max1 = dm(k)</a>
              <a href="null_p.html#fv_fill_mod" target="origFile"><code class="keyword">ELSE</code></a>
                <a href="null_p.html#fv_fill_mod" target="origFile">max1 = <code class="constant">0.</code></a>
              <a href="null_p.html#fv_fill_mod" target="origFile"><code class="keyword">END IF</code></a>
              <a href="null_p.html#fv_fill_mod" target="origFile">sum1 = sum1 + max1</a>
            <a href="null_p.html#fv_fill_mod" target="origFile"><code class="keyword">END DO</code></a>
            <a href="null_p.html#fv_fill_mod" target="origFile">fac = sum0/sum1</a>
            <a href="null_p.html#fv_fill_mod" target="origFile"><code class="keyword">DO </code>k=<code class="constant">2</code>,km</a>
              <a href="null_p.html#fv_fill_mod" target="origFile"><code class="keyword">IF</code> (<code class="constant">0. </code>.LT. fac*dm(k)/dp(i, k)) <code class="keyword">THEN</code></a>
                <a href="null_p.html#fv_fill_mod" target="origFile">q(i, k, ic) = fac*dm(k)/dp(i, k)</a>
              <a href="null_p.html#fv_fill_mod" target="origFile"><code class="keyword">ELSE</code></a>
                <a href="null_p.html#fv_fill_mod" target="origFile">q(i, k, ic) = <code class="constant">0.</code></a>
              <a href="null_p.html#fv_fill_mod" target="origFile"><code class="keyword">END IF</code></a>
            <a href="null_p.html#fv_fill_mod" target="origFile"><code class="keyword">END DO</code></a>
          <a href="null_p.html#fv_fill_mod" target="origFile"><code class="keyword">END IF</code></a>
        <a href="null_p.html#fv_fill_mod" target="origFile"><code class="keyword">END IF</code></a>
      <a href="null_p.html#fv_fill_mod" target="origFile"><code class="keyword">END DO</code></a>
    <a href="null_p.html#fv_fill_mod" target="origFile"><code class="keyword">END DO</code></a>
  <a href="null_p.html#fv_fill_mod" target="origFile"><code class="keyword">END SUBROUTINE </code><code class="funcname">FILLZ</code></a>
<code class="keyword">END MODULE </code><code class="funcname">FV_FILL_MOD_B</code>
</pre>
</body>
