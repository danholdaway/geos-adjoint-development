!        Generated by TAPENADE     (INRIA, Ecuador team)
!  Tapenade 3.12 (r6213) - 13 Oct 2016 10:30
!
MODULE FV_FILL_MOD_B
  USE FV_ARRAYS_MOD, ONLY : real8
  IMPLICIT NONE
  PUBLIC fillz
  PUBLIC fillz_adm

CONTAINS
!  Differentiation of fillz in reverse (adjoint) mode:
!   gradient     of useful results: q
!   with respect to varying inputs: q
  SUBROUTINE FILLZ_ADM(im, km, nq, q, q_ad, dp)
    IMPLICIT NONE
! No. of longitudes
    INTEGER, INTENT(IN) :: im
! No. of levels
    INTEGER, INTENT(IN) :: km
! Total number of tracers
    INTEGER, INTENT(IN) :: nq
! pressure thickness
    REAL(real8), INTENT(IN) :: dp(im, km)
! tracer mixing ratio
    REAL(real8), INTENT(INOUT) :: q(im, km, nq)
    REAL(real8), INTENT(INOUT) :: q_ad(im, km, nq)
! !LOCAL VARIABLES:
    LOGICAL :: zfix(im)
    REAL(real8) :: dm(km)
    REAL(real8) :: dm_ad(km)
    INTEGER :: i, k, ic
    REAL(real8) :: qup, qly, dup, dq, sum0, sum1, fac
    REAL(real8) :: qup_ad, qly_ad, dup_ad, dq_ad, sum0_ad, sum1_ad, &
&   fac_ad
    INTRINSIC MIN
    INTRINSIC MAX
    REAL*8 :: max1
    REAL*8 :: max1_ad
    REAL(real8) :: temp_ad
    INTEGER :: branch
    DO ic=1,nq
! Top layer
      DO i=1,im
        IF (q(i, 1, ic) .LT. 0.) THEN
          CALL PUSHREAL8(q(i, 2, ic))
          q(i, 2, ic) = q(i, 2, ic) + q(i, 1, ic)*dp(i, 1)/dp(i, 2)
          CALL PUSHREAL8(q(i, 1, ic))
          q(i, 1, ic) = 0.
          CALL PUSHCONTROL1B(1)
        ELSE
          CALL PUSHCONTROL1B(0)
        END IF
      END DO
! Interior
      zfix(:) = .false.
      CALL PUSHINTEGER4(k)
      DO k=2,km-1
        DO i=1,im
          IF (q(i, k, ic) .LT. 0.) THEN
            zfix(i) = .true.
            IF (q(i, k-1, ic) .GT. 0.) THEN
              IF (q(i, k-1, ic)*dp(i, k-1) .GT. -(q(i, k, ic)*dp(i, k))&
&             ) THEN
                dq = -(q(i, k, ic)*dp(i, k))
                CALL PUSHCONTROL1B(0)
              ELSE
                dq = q(i, k-1, ic)*dp(i, k-1)
                CALL PUSHCONTROL1B(1)
              END IF
              CALL PUSHREAL8(q(i, k-1, ic))
              q(i, k-1, ic) = q(i, k-1, ic) - dq/dp(i, k-1)
              CALL PUSHREAL8(q(i, k, ic))
              q(i, k, ic) = q(i, k, ic) + dq/dp(i, k)
              CALL PUSHCONTROL1B(0)
            ELSE
              CALL PUSHCONTROL1B(1)
            END IF
            IF (q(i, k, ic) .LT. 0.0 .AND. q(i, k+1, ic) .GT. 0.) THEN
              IF (q(i, k+1, ic)*dp(i, k+1) .GT. -(q(i, k, ic)*dp(i, k))&
&             ) THEN
                dq = -(q(i, k, ic)*dp(i, k))
                CALL PUSHCONTROL1B(0)
              ELSE
                dq = q(i, k+1, ic)*dp(i, k+1)
                CALL PUSHCONTROL1B(1)
              END IF
              CALL PUSHREAL8(q(i, k+1, ic))
              q(i, k+1, ic) = q(i, k+1, ic) - dq/dp(i, k+1)
              CALL PUSHREAL8(q(i, k, ic))
              q(i, k, ic) = q(i, k, ic) + dq/dp(i, k)
              CALL PUSHCONTROL2B(2)
            ELSE
              CALL PUSHCONTROL2B(1)
            END IF
          ELSE
            CALL PUSHCONTROL2B(0)
          END IF
        END DO
      END DO
! Bottom layer
      k = km
      DO i=1,im
        IF (q(i, k, ic) .LT. 0. .AND. q(i, k-1, ic) .GT. 0.) THEN
          zfix(i) = .true.
! Borrow from above
          qup = q(i, k-1, ic)*dp(i, k-1)
          qly = -(q(i, k, ic)*dp(i, k))
          IF (qly .GT. qup) THEN
            dup = qup
            CALL PUSHCONTROL1B(0)
          ELSE
            dup = qly
            CALL PUSHCONTROL1B(1)
          END IF
          CALL PUSHREAL8(q(i, k-1, ic))
          q(i, k-1, ic) = q(i, k-1, ic) - dup/dp(i, k-1)
          CALL PUSHREAL8(q(i, k, ic))
          q(i, k, ic) = q(i, k, ic) + dup/dp(i, k)
          CALL PUSHCONTROL1B(1)
        ELSE
          CALL PUSHCONTROL1B(0)
        END IF
      END DO
! Perform final check and non-local fix if needed
      DO i=1,im
        IF (zfix(i)) THEN
          CALL PUSHREAL8(sum0)
          sum0 = 0.
          CALL PUSHINTEGER4(k)
          DO k=2,km
            CALL PUSHREAL8(dm(k))
            dm(k) = q(i, k, ic)*dp(i, k)
            sum0 = sum0 + dm(k)
          END DO
          IF (sum0 .GT. 0.) THEN
            CALL PUSHREAL8(sum1)
            sum1 = 0.
            DO k=2,km
              IF (0. .LT. dm(k)) THEN
                max1 = dm(k)
                CALL PUSHCONTROL1B(0)
              ELSE
                CALL PUSHCONTROL1B(1)
                max1 = 0.
              END IF
              sum1 = sum1 + max1
            END DO
            CALL PUSHREAL8(fac)
            fac = sum0/sum1
            DO k=2,km
              IF (0. .LT. fac*dm(k)/dp(i, k)) THEN
                CALL PUSHCONTROL1B(0)
              ELSE
                CALL PUSHCONTROL1B(1)
              END IF
            END DO
            CALL PUSHCONTROL2B(2)
          ELSE
            CALL PUSHCONTROL2B(1)
          END IF
        ELSE
          CALL PUSHCONTROL2B(0)
        END IF
      END DO
    END DO
    dm_ad = 0.0_8
    DO ic=nq,1,-1
      DO i=im,1,-1
        CALL POPCONTROL2B(branch)
        IF (branch .NE. 0) THEN
          IF (branch .EQ. 1) THEN
            sum0_ad = 0.0_8
          ELSE
            fac_ad = 0.0_8
            DO k=km,2,-1
              CALL POPCONTROL1B(branch)
              IF (branch .EQ. 0) THEN
                temp_ad = q_ad(i, k, ic)/dp(i, k)
                fac_ad = fac_ad + dm(k)*temp_ad
                dm_ad(k) = dm_ad(k) + fac*temp_ad
                q_ad(i, k, ic) = 0.0_8
              ELSE
                q_ad(i, k, ic) = 0.0_8
              END IF
            END DO
            CALL POPREAL8(fac)
            sum0_ad = fac_ad/sum1
            sum1_ad = -(sum0*fac_ad/sum1**2)
            DO k=km,2,-1
              max1_ad = sum1_ad
              CALL POPCONTROL1B(branch)
              IF (branch .EQ. 0) dm_ad(k) = dm_ad(k) + max1_ad
            END DO
            CALL POPREAL8(sum1)
          END IF
          DO k=km,2,-1
            dm_ad(k) = dm_ad(k) + sum0_ad
            CALL POPREAL8(dm(k))
            q_ad(i, k, ic) = q_ad(i, k, ic) + dp(i, k)*dm_ad(k)
            dm_ad(k) = 0.0_8
          END DO
          CALL POPINTEGER4(k)
          CALL POPREAL8(sum0)
        END IF
      END DO
      DO i=im,1,-1
        CALL POPCONTROL1B(branch)
        IF (branch .NE. 0) THEN
          CALL POPREAL8(q(i, k, ic))
          dup_ad = q_ad(i, k, ic)/dp(i, k) - q_ad(i, k-1, ic)/dp(i, k-1)
          CALL POPREAL8(q(i, k-1, ic))
          CALL POPCONTROL1B(branch)
          IF (branch .EQ. 0) THEN
            qup_ad = dup_ad
            qly_ad = 0.0_8
          ELSE
            qly_ad = dup_ad
            qup_ad = 0.0_8
          END IF
          q_ad(i, k, ic) = q_ad(i, k, ic) - dp(i, k)*qly_ad
          q_ad(i, k-1, ic) = q_ad(i, k-1, ic) + dp(i, k-1)*qup_ad
        END IF
      END DO
      DO k=km-1,2,-1
        DO i=im,1,-1
          CALL POPCONTROL2B(branch)
          IF (branch .NE. 0) THEN
            IF (branch .NE. 1) THEN
              CALL POPREAL8(q(i, k, ic))
              dq_ad = q_ad(i, k, ic)/dp(i, k) - q_ad(i, k+1, ic)/dp(i, k&
&               +1)
              CALL POPREAL8(q(i, k+1, ic))
              CALL POPCONTROL1B(branch)
              IF (branch .EQ. 0) THEN
                q_ad(i, k, ic) = q_ad(i, k, ic) - dp(i, k)*dq_ad
              ELSE
                q_ad(i, k+1, ic) = q_ad(i, k+1, ic) + dp(i, k+1)*dq_ad
              END IF
            END IF
            CALL POPCONTROL1B(branch)
            IF (branch .EQ. 0) THEN
              CALL POPREAL8(q(i, k, ic))
              dq_ad = q_ad(i, k, ic)/dp(i, k) - q_ad(i, k-1, ic)/dp(i, k&
&               -1)
              CALL POPREAL8(q(i, k-1, ic))
              CALL POPCONTROL1B(branch)
              IF (branch .EQ. 0) THEN
                q_ad(i, k, ic) = q_ad(i, k, ic) - dp(i, k)*dq_ad
              ELSE
                q_ad(i, k-1, ic) = q_ad(i, k-1, ic) + dp(i, k-1)*dq_ad
              END IF
            END IF
          END IF
        END DO
      END DO
      CALL POPINTEGER4(k)
      DO i=im,1,-1
        CALL POPCONTROL1B(branch)
        IF (branch .NE. 0) THEN
          CALL POPREAL8(q(i, 1, ic))
          q_ad(i, 1, ic) = dp(i, 1)*q_ad(i, 2, ic)/dp(i, 2)
          CALL POPREAL8(q(i, 2, ic))
        END IF
      END DO
    END DO
  END SUBROUTINE FILLZ_ADM
  SUBROUTINE FILLZ(im, km, nq, q, dp)
    IMPLICIT NONE
! No. of longitudes
    INTEGER, INTENT(IN) :: im
! No. of levels
    INTEGER, INTENT(IN) :: km
! Total number of tracers
    INTEGER, INTENT(IN) :: nq
! pressure thickness
    REAL(real8), INTENT(IN) :: dp(im, km)
! tracer mixing ratio
    REAL(real8), INTENT(INOUT) :: q(im, km, nq)
! !LOCAL VARIABLES:
    LOGICAL :: zfix(im)
    REAL(real8) :: dm(km)
    INTEGER :: i, k, ic
    REAL(real8) :: qup, qly, dup, dq, sum0, sum1, fac
    INTRINSIC MIN
    INTRINSIC MAX
    REAL*8 :: max1
    DO ic=1,nq
! Top layer
      DO i=1,im
        IF (q(i, 1, ic) .LT. 0.) THEN
          q(i, 2, ic) = q(i, 2, ic) + q(i, 1, ic)*dp(i, 1)/dp(i, 2)
          q(i, 1, ic) = 0.
        END IF
      END DO
! Interior
      zfix(:) = .false.
      DO k=2,km-1
        DO i=1,im
          IF (q(i, k, ic) .LT. 0.) THEN
            zfix(i) = .true.
            IF (q(i, k-1, ic) .GT. 0.) THEN
              IF (q(i, k-1, ic)*dp(i, k-1) .GT. -(q(i, k, ic)*dp(i, k))&
&             ) THEN
                dq = -(q(i, k, ic)*dp(i, k))
              ELSE
                dq = q(i, k-1, ic)*dp(i, k-1)
              END IF
              q(i, k-1, ic) = q(i, k-1, ic) - dq/dp(i, k-1)
              q(i, k, ic) = q(i, k, ic) + dq/dp(i, k)
            END IF
            IF (q(i, k, ic) .LT. 0.0 .AND. q(i, k+1, ic) .GT. 0.) THEN
              IF (q(i, k+1, ic)*dp(i, k+1) .GT. -(q(i, k, ic)*dp(i, k))&
&             ) THEN
                dq = -(q(i, k, ic)*dp(i, k))
              ELSE
                dq = q(i, k+1, ic)*dp(i, k+1)
              END IF
              q(i, k+1, ic) = q(i, k+1, ic) - dq/dp(i, k+1)
              q(i, k, ic) = q(i, k, ic) + dq/dp(i, k)
            END IF
          END IF
        END DO
      END DO
! Bottom layer
      k = km
      DO i=1,im
        IF (q(i, k, ic) .LT. 0. .AND. q(i, k-1, ic) .GT. 0.) THEN
          zfix(i) = .true.
! Borrow from above
          qup = q(i, k-1, ic)*dp(i, k-1)
          qly = -(q(i, k, ic)*dp(i, k))
          IF (qly .GT. qup) THEN
            dup = qup
          ELSE
            dup = qly
          END IF
          q(i, k-1, ic) = q(i, k-1, ic) - dup/dp(i, k-1)
          q(i, k, ic) = q(i, k, ic) + dup/dp(i, k)
        END IF
      END DO
! Perform final check and non-local fix if needed
      DO i=1,im
        IF (zfix(i)) THEN
          sum0 = 0.
          DO k=2,km
            dm(k) = q(i, k, ic)*dp(i, k)
            sum0 = sum0 + dm(k)
          END DO
          IF (sum0 .GT. 0.) THEN
            sum1 = 0.
            DO k=2,km
              IF (0. .LT. dm(k)) THEN
                max1 = dm(k)
              ELSE
                max1 = 0.
              END IF
              sum1 = sum1 + max1
            END DO
            fac = sum0/sum1
            DO k=2,km
              IF (0. .LT. fac*dm(k)/dp(i, k)) THEN
                q(i, k, ic) = fac*dm(k)/dp(i, k)
              ELSE
                q(i, k, ic) = 0.
              END IF
            END DO
          END IF
        END IF
      END DO
    END DO
  END SUBROUTINE FILLZ
END MODULE FV_FILL_MOD_B
