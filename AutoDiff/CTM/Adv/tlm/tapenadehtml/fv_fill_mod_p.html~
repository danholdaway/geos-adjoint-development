<title>Generated by TAPENADE</title>
<link type="text/CSS" rel="stylesheet" href="tapenade.css">
<link type="text/CSS" rel="stylesheet" href="fortranStyle.css">
<body>
<pre><code class="comment">!        Generated by TAPENADE     (INRIA, Ecuador team)</code>
<code class="comment">!  Tapenade 3.12 (r6213) - 13 Oct 2016 10:30</code>
<code class="comment">!</code>
<code class="keyword">MODULE </code><code class="funcname">FV_FILL_MOD</code>
  <code class="keyword">USE </code><code class="funcname">FV_ARRAYS_MOD</code>, <code class="keyword">ONLY </code>: real8
  <code class="keyword">IMPLICIT NONE</code>
  PUBLIC fillz
<a name="fillz"></a>
<code class="keyword">CONTAINS</code>
  <a href="null.html#fv_fill_mod_d" target="diffFile"><code class="keyword">SUBROUTINE </code><code class="funcname">FILLZ</code>(<code class="vardecl">im</code>, <code class="vardecl">km</code>, <code class="vardecl">nq</code>, <code class="vardecl">q</code>, <code class="vardecl">dp</code>)</a>
    <a href="null.html#fv_fill_mod_d" target="diffFile"><code class="keyword">IMPLICIT NONE</code></a>
<a href="null.html#fv_fill_mod_d" target="diffFile"><code class="comment">! No. of longitudes</code></a>
    <a href="null.html#fv_fill_mod_d" target="diffFile"><code class="typename">INTEGER</code>, <code class="typename">INTENT(IN) </code>:: <code class="vardecl">im</code></a>
<a href="null.html#fv_fill_mod_d" target="diffFile"><code class="comment">! No. of levels</code></a>
    <a href="null.html#fv_fill_mod_d" target="diffFile"><code class="typename">INTEGER</code>, <code class="typename">INTENT(IN) </code>:: <code class="vardecl">km</code></a>
<a href="null.html#fv_fill_mod_d" target="diffFile"><code class="comment">! Total number of tracers</code></a>
    <a href="null.html#fv_fill_mod_d" target="diffFile"><code class="typename">INTEGER</code>, <code class="typename">INTENT(IN) </code>:: <code class="vardecl">nq</code></a>
<a href="null.html#fv_fill_mod_d" target="diffFile"><code class="comment">! pressure thickness</code></a>
    <a href="null.html#fv_fill_mod_d" target="diffFile"><code class="typename">REAL(</code><code class="modifier">real8</code><code class="typename">)</code>, <code class="typename">INTENT(IN) </code>:: <code class="vardecl">dp</code>(<code class="vardecl">im</code>, <code class="vardecl">km</code>)</a>
<a href="null.html#fv_fill_mod_d" target="diffFile"><code class="comment">! tracer mixing ratio</code></a>
    <a href="null.html#fv_fill_mod_d" target="diffFile"><code class="typename">REAL(</code><code class="modifier">real8</code><code class="typename">)</code>, <code class="typename">INTENT(INOUT) </code>:: <code class="vardecl">q</code>(<code class="vardecl">im</code>, <code class="vardecl">km</code>, <code class="vardecl">nq</code>)</a>
<a href="null.html#fv_fill_mod_d" target="diffFile"><code class="comment">! !LOCAL VARIABLES:</code></a>
    <a href="null.html#fv_fill_mod_d" target="diffFile"><code class="typename">LOGICAL </code>:: <code class="vardecl">zfix</code>(<code class="vardecl">im</code>)</a>
    <a href="null.html#fv_fill_mod_d" target="diffFile"><code class="typename">REAL(</code><code class="modifier">real8</code><code class="typename">) </code>:: <code class="vardecl">dm</code>(<code class="vardecl">km</code>)</a>
    <a href="null.html#fv_fill_mod_d" target="diffFile"><code class="typename">INTEGER </code>:: <code class="vardecl">i</code>, <code class="vardecl">k</code>, <code class="vardecl">ic</code></a>
    <a href="null.html#fv_fill_mod_d" target="diffFile"><code class="typename">REAL(</code><code class="modifier">real8</code><code class="typename">) </code>:: <code class="vardecl">qup</code>, <code class="vardecl">qly</code>, <code class="vardecl">dup</code>, <code class="vardecl">dq</code>, <code class="vardecl">sum0</code>, <code class="vardecl">sum1</code>, <code class="vardecl">fac</code></a>
    <a href="null.html#fv_fill_mod_d" target="diffFile"><code class="keyword">INTRINSIC </code><code class="funcname">MIN</code></a>
    <a href="null.html#fv_fill_mod_d" target="diffFile"><code class="keyword">INTRINSIC </code><code class="funcname">MAX</code></a>
    <a href="null.html#fv_fill_mod_d" target="diffFile"><code class="typename">REAL*8 </code>:: <code class="vardecl">max1</code></a>
    <a href="null.html#fv_fill_mod_d" target="diffFile"><code class="keyword">DO </code>ic=<code class="constant">1</code>,nq</a>
<a href="null.html#fv_fill_mod_d" target="diffFile"><code class="comment">! Top layer</code></a>
      <a href="null.html#fv_fill_mod_d" target="diffFile"><code class="keyword">DO </code>i=<code class="constant">1</code>,im</a>
        <a href="null.html#fv_fill_mod_d" target="diffFile"><code class="keyword">IF</code> (q(i, <code class="constant">1</code>, ic) .LT. <code class="constant">0.</code>) <code class="keyword">THEN</code></a>
          <a href="null.html#fv_fill_mod_d" target="diffFile">q(i, <code class="constant">2</code>, ic) = q(i, <code class="constant">2</code>, ic) + q(i, <code class="constant">1</code>, ic)*dp(i, <code class="constant">1</code>)/dp(i, <code class="constant">2</code>)</a>
          <a href="null.html#fv_fill_mod_d" target="diffFile">q(i, <code class="constant">1</code>, ic) = <code class="constant">0.</code></a>
        <a href="null.html#fv_fill_mod_d" target="diffFile"><code class="keyword">END IF</code></a>
      <a href="null.html#fv_fill_mod_d" target="diffFile"><code class="keyword">END DO</code></a>
<a href="null.html#fv_fill_mod_d" target="diffFile"><code class="comment">! Interior</code></a>
      <a href="null.html#fv_fill_mod_d" target="diffFile">zfix(:) = <code class="constant">.false.</code></a>
      <a href="null.html#fv_fill_mod_d" target="diffFile"><code class="keyword">DO </code>k=<code class="constant">2</code>,km-<code class="constant">1</code></a>
        <a href="null.html#fv_fill_mod_d" target="diffFile"><code class="keyword">DO </code>i=<code class="constant">1</code>,im</a>
          <a href="null.html#fv_fill_mod_d" target="diffFile"><code class="keyword">IF</code> (q(i, k, ic) .LT. <code class="constant">0.</code>) <code class="keyword">THEN</code></a>
            <a href="null.html#fv_fill_mod_d" target="diffFile">zfix(i) = <code class="constant">.true.</code></a>
            <a href="null.html#fv_fill_mod_d" target="diffFile"><code class="keyword">IF</code> (q(i, k-<code class="constant">1</code>, ic) .GT. <code class="constant">0.</code>) <code class="keyword">THEN</code></a>
              <a href="null.html#fv_fill_mod_d" target="diffFile"><code class="keyword">IF</code> (q(i, k-<code class="constant">1</code>, ic)*dp(i, k-<code class="constant">1</code>) .GT. -(q(i, k, ic)*dp(i, k))<code class="label">&</code></a>
<a href="null.html#fv_fill_mod_d" target="diffFile"><code class="label">&             </code>) <code class="keyword">THEN</code></a>
                <a href="null.html#fv_fill_mod_d" target="diffFile">dq = -(q(i, k, ic)*dp(i, k))</a>
              <a href="null.html#fv_fill_mod_d" target="diffFile"><code class="keyword">ELSE</code></a>
                <a href="null.html#fv_fill_mod_d" target="diffFile">dq = q(i, k-<code class="constant">1</code>, ic)*dp(i, k-<code class="constant">1</code>)</a>
              <a href="null.html#fv_fill_mod_d" target="diffFile"><code class="keyword">END IF</code></a>
              <a href="null.html#fv_fill_mod_d" target="diffFile">q(i, k-<code class="constant">1</code>, ic) = q(i, k-<code class="constant">1</code>, ic) - dq/dp(i, k-<code class="constant">1</code>)</a>
              <a href="null.html#fv_fill_mod_d" target="diffFile">q(i, k, ic) = q(i, k, ic) + dq/dp(i, k)</a>
            <a href="null.html#fv_fill_mod_d" target="diffFile"><code class="keyword">END IF</code></a>
            <a href="null.html#fv_fill_mod_d" target="diffFile"><code class="keyword">IF</code> (q(i, k, ic) .LT. <code class="constant">0.0 </code>.AND. q(i, k+<code class="constant">1</code>, ic) .GT. <code class="constant">0.</code>) <code class="keyword">THEN</code></a>
              <a href="null.html#fv_fill_mod_d" target="diffFile"><code class="keyword">IF</code> (q(i, k+<code class="constant">1</code>, ic)*dp(i, k+<code class="constant">1</code>) .GT. -(q(i, k, ic)*dp(i, k))<code class="label">&</code></a>
<a href="null.html#fv_fill_mod_d" target="diffFile"><code class="label">&             </code>) <code class="keyword">THEN</code></a>
                <a href="null.html#fv_fill_mod_d" target="diffFile">dq = -(q(i, k, ic)*dp(i, k))</a>
              <a href="null.html#fv_fill_mod_d" target="diffFile"><code class="keyword">ELSE</code></a>
                <a href="null.html#fv_fill_mod_d" target="diffFile">dq = q(i, k+<code class="constant">1</code>, ic)*dp(i, k+<code class="constant">1</code>)</a>
              <a href="null.html#fv_fill_mod_d" target="diffFile"><code class="keyword">END IF</code></a>
              <a href="null.html#fv_fill_mod_d" target="diffFile">q(i, k+<code class="constant">1</code>, ic) = q(i, k+<code class="constant">1</code>, ic) - dq/dp(i, k+<code class="constant">1</code>)</a>
              <a href="null.html#fv_fill_mod_d" target="diffFile">q(i, k, ic) = q(i, k, ic) + dq/dp(i, k)</a>
            <a href="null.html#fv_fill_mod_d" target="diffFile"><code class="keyword">END IF</code></a>
          <a href="null.html#fv_fill_mod_d" target="diffFile"><code class="keyword">END IF</code></a>
        <a href="null.html#fv_fill_mod_d" target="diffFile"><code class="keyword">END DO</code></a>
      <a href="null.html#fv_fill_mod_d" target="diffFile"><code class="keyword">END DO</code></a>
<a href="null.html#fv_fill_mod_d" target="diffFile"><code class="comment">! Bottom layer</code></a>
      <a href="null.html#fv_fill_mod_d" target="diffFile">k = km</a>
      <a href="null.html#fv_fill_mod_d" target="diffFile"><code class="keyword">DO </code>i=<code class="constant">1</code>,im</a>
        <a href="null.html#fv_fill_mod_d" target="diffFile"><code class="keyword">IF</code> (q(i, k, ic) .LT. <code class="constant">0. </code>.AND. q(i, k-<code class="constant">1</code>, ic) .GT. <code class="constant">0.</code>) <code class="keyword">THEN</code></a>
          <a href="null.html#fv_fill_mod_d" target="diffFile">zfix(i) = <code class="constant">.true.</code></a>
<a href="null.html#fv_fill_mod_d" target="diffFile"><code class="comment">! Borrow from above</code></a>
          <a href="null.html#fv_fill_mod_d" target="diffFile">qup = q(i, k-<code class="constant">1</code>, ic)*dp(i, k-<code class="constant">1</code>)</a>
          <a href="null.html#fv_fill_mod_d" target="diffFile">qly = -(q(i, k, ic)*dp(i, k))</a>
          <a href="null.html#fv_fill_mod_d" target="diffFile"><code class="keyword">IF</code> (qly .GT. qup) <code class="keyword">THEN</code></a>
            <a href="null.html#fv_fill_mod_d" target="diffFile">dup = qup</a>
          <a href="null.html#fv_fill_mod_d" target="diffFile"><code class="keyword">ELSE</code></a>
            <a href="null.html#fv_fill_mod_d" target="diffFile">dup = qly</a>
          <a href="null.html#fv_fill_mod_d" target="diffFile"><code class="keyword">END IF</code></a>
          <a href="null.html#fv_fill_mod_d" target="diffFile">q(i, k-<code class="constant">1</code>, ic) = q(i, k-<code class="constant">1</code>, ic) - dup/dp(i, k-<code class="constant">1</code>)</a>
          <a href="null.html#fv_fill_mod_d" target="diffFile">q(i, k, ic) = q(i, k, ic) + dup/dp(i, k)</a>
        <a href="null.html#fv_fill_mod_d" target="diffFile"><code class="keyword">END IF</code></a>
      <a href="null.html#fv_fill_mod_d" target="diffFile"><code class="keyword">END DO</code></a>
<a href="null.html#fv_fill_mod_d" target="diffFile"><code class="comment">! Perform final check and non-local fix if needed</code></a>
      <a href="null.html#fv_fill_mod_d" target="diffFile"><code class="keyword">DO </code>i=<code class="constant">1</code>,im</a>
        <a href="null.html#fv_fill_mod_d" target="diffFile"><code class="keyword">IF</code> (zfix(i)) <code class="keyword">THEN</code></a>
          <a href="null.html#fv_fill_mod_d" target="diffFile">sum0 = <code class="constant">0.</code></a>
          <a href="null.html#fv_fill_mod_d" target="diffFile"><code class="keyword">DO </code>k=<code class="constant">2</code>,km</a>
            <a href="null.html#fv_fill_mod_d" target="diffFile">dm(k) = q(i, k, ic)*dp(i, k)</a>
            <a href="null.html#fv_fill_mod_d" target="diffFile">sum0 = sum0 + dm(k)</a>
          <a href="null.html#fv_fill_mod_d" target="diffFile"><code class="keyword">END DO</code></a>
          <a href="null.html#fv_fill_mod_d" target="diffFile"><code class="keyword">IF</code> (sum0 .GT. <code class="constant">0.</code>) <code class="keyword">THEN</code></a>
            <a href="null.html#fv_fill_mod_d" target="diffFile">sum1 = <code class="constant">0.</code></a>
            <a href="null.html#fv_fill_mod_d" target="diffFile"><code class="keyword">DO </code>k=<code class="constant">2</code>,km</a>
              <a href="null.html#fv_fill_mod_d" target="diffFile"><code class="keyword">IF</code> (<code class="constant">0. </code>.LT. dm(k)) <code class="keyword">THEN</code></a>
                <a href="null.html#fv_fill_mod_d" target="diffFile">max1 = dm(k)</a>
              <a href="null.html#fv_fill_mod_d" target="diffFile"><code class="keyword">ELSE</code></a>
                <a href="null.html#fv_fill_mod_d" target="diffFile">max1 = <code class="constant">0.</code></a>
              <a href="null.html#fv_fill_mod_d" target="diffFile"><code class="keyword">END IF</code></a>
              <a href="null.html#fv_fill_mod_d" target="diffFile">sum1 = sum1 + max1</a>
            <a href="null.html#fv_fill_mod_d" target="diffFile"><code class="keyword">END DO</code></a>
            <a href="null.html#fv_fill_mod_d" target="diffFile">fac = sum0/sum1</a>
            <a href="null.html#fv_fill_mod_d" target="diffFile"><code class="keyword">DO </code>k=<code class="constant">2</code>,km</a>
              <a href="null.html#fv_fill_mod_d" target="diffFile"><code class="keyword">IF</code> (<code class="constant">0. </code>.LT. fac*dm(k)/dp(i, k)) <code class="keyword">THEN</code></a>
                <a href="null.html#fv_fill_mod_d" target="diffFile">q(i, k, ic) = fac*dm(k)/dp(i, k)</a>
              <a href="null.html#fv_fill_mod_d" target="diffFile"><code class="keyword">ELSE</code></a>
                <a href="null.html#fv_fill_mod_d" target="diffFile">q(i, k, ic) = <code class="constant">0.</code></a>
              <a href="null.html#fv_fill_mod_d" target="diffFile"><code class="keyword">END IF</code></a>
            <a href="null.html#fv_fill_mod_d" target="diffFile"><code class="keyword">END DO</code></a>
          <a href="null.html#fv_fill_mod_d" target="diffFile"><code class="keyword">END IF</code></a>
        <a href="null.html#fv_fill_mod_d" target="diffFile"><code class="keyword">END IF</code></a>
      <a href="null.html#fv_fill_mod_d" target="diffFile"><code class="keyword">END DO</code></a>
    <a href="null.html#fv_fill_mod_d" target="diffFile"><code class="keyword">END DO</code></a>
  <a href="null.html#fv_fill_mod_d" target="diffFile"><code class="keyword">END SUBROUTINE </code><code class="funcname">FILLZ</code></a>
<code class="keyword">END MODULE </code><code class="funcname">FV_FILL_MOD</code>
</pre>
</body>
