<title>Generated by TAPENADE</title>
<link type="text/CSS" rel="stylesheet" href="tapenade.css">
<link type="text/CSS" rel="stylesheet" href="fortranStyle.css">
<body>
<pre><code class="comment">!        Generated by TAPENADE     (INRIA, Ecuador team)</code>
<code class="comment">!  Tapenade 3.12 (r6213) - 13 Oct 2016 10:30</code>
<code class="comment">!</code>
<code class="comment">!-------------------------------------------------------------------------</code>
<code class="comment">!         NASA/GSFC, Software Systems Support Office, Code 610.3         !</code>
<code class="comment">!-------------------------------------------------------------------------</code>
<code class="comment">!BOP</code>
<code class="comment">!</code>
<code class="comment">! !MODULE: updateDiffusion_mod</code>
<code class="comment">!</code>
<code class="comment">! !INTERFACE:</code>
<code class="comment">!</code>
<code class="comment">!#include "MAPL_Generic.h"</code>
<code class="comment">!</code>
<code class="keyword">MODULE </code><code class="funcname">UPDATEDIFFUSION_MOD_D</code>
<code class="comment">!</code>
<code class="comment">! !USES:</code>
  <code class="keyword">USE </code><code class="funcname">ESMF</code>
<code class="comment">!      use MAPL_Mod</code>
  <code class="keyword">USE </code><code class="funcname">GMIARRAYBUNDLEPOINTER_MOD_D</code>, <code class="keyword">ONLY </code>: t_gmiarraybundle, <code class="label">&</code>
<code class="label">& </code>t_gmiarraybundle_d
  <code class="keyword">IMPLICIT NONE</code>
<code class="comment">!EOC</code>
<code class="comment">!------------------------------------------------------------------------------</code>
<code class="comment">!</code>
<code class="comment">! !PUBLIC MEMBER FUNCTIONS:</code>
  PRIVATE 
  PUBLIC updatediffusion
  PUBLIC updatediffusion_tlm
  PUBLIC update_pbl_mixing
<a name="updatediffusion_tlm"></a>
<code class="keyword">CONTAINS</code>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">!  Differentiation of updatediffusion in forward (tangent) mode:</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">!   variations   of useful results: *(concentration.parray3d)</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">!   with respect to varying inputs: *(concentration.parray3d)</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">!   RW status of diff variables: *(concentration.parray3d):in-out</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">!   Plus diff mem management of: concentration.parray3d:in</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">!</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">! !DESCRIPTION:</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">!</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">! !AUTHOR:</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">!</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">! !REVISION HISTORY:</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">!</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">!EOP</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">!-------------------------------------------------------------------------</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">!-------------------------------------------------------------------------</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">!BOP</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">!</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">! !IROUTINE: updateDiffusion</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">!</code></a>
  <a href="null_p.html#updatediffusion_mod" target="origFile"><code class="keyword">SUBROUTINE </code><code class="funcname">UPDATEDIFFUSION_TLM</code>(<code class="vardecl">tdt</code>, <code class="vardecl">vert_diffu_coef</code>, <code class="vardecl">pbl</code>, <code class="vardecl">tropp</code>, <code class="vardecl">kzz</code>, <code class="label">&</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="label">&   </code><code class="vardecl">press3c</code>, <code class="vardecl">press3e</code>, <code class="vardecl">pctm1</code>, <code class="vardecl">concentration</code>, <code class="vardecl">concentration_tl</code>, <code class="label">&</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="label">&   </code><code class="vardecl">isfixedconcentration</code>, <code class="vardecl">mettype</code>, <code class="vardecl">i1</code>, <code class="vardecl">i2</code>, <code class="vardecl">ju1</code>, <code class="vardecl">j2</code>, <code class="vardecl">k1</code>, <code class="vardecl">k2</code>, <code class="vardecl">ilo</code>, <code class="vardecl">ihi</code>, <code class="label">&</code></a>
<a name="updatediffusion_tlmi80"></a><a href="null_p.html#updatediffusion_mod" target="origFile"><code class="label">&   </code><code class="vardecl">julo</code>, <code class="vardecl">jhi</code>, <code class="vardecl">numspecies</code>)</a>
    <a href="null_p.html#updatediffusion_mod" target="origFile"><code class="keyword">IMPLICIT NONE</code></a>
<a href="null_p.html#updatediffusion_modi80" target="origFile"><code class="comment">!</code></a>
<a name="updatediffusion_tlmi81"></a><a href="null_p.html#updatediffusion_modi80" target="origFile"><code class="comment">! !INPUT PARAMETERS:</code></a>
<a name="updatediffusion_tlmi82"></a>    <a href="null_p.html#updatediffusion_modi80" target="origFile"><code class="typename">INTEGER</code>, <code class="typename">INTENT(IN) </code>:: <code class="vardecl">i1</code>, <code class="vardecl">i2</code>, <code class="vardecl">ju1</code>, <code class="vardecl">j2</code>, <code class="vardecl">k1</code>, <code class="vardecl">k2</code>, <code class="vardecl">ilo</code>, <code class="vardecl">ihi</code>, <code class="vardecl">julo</code>, <code class="vardecl">jhi</code></a>
    <a href="null_p.html#updatediffusion_modi81" target="origFile"><code class="typename">INTEGER</code>, <code class="typename">INTENT(IN) </code>:: <code class="vardecl">numspecies</code></a>
<a name="updatediffusion_tlmi83"></a><a href="null_p.html#updatediffusion_modi82" target="origFile"><code class="comment">! model time step (s)</code></a>
    <a href="null_p.html#updatediffusion_modi82" target="origFile"><code class="typename">REAL*8</code>, <code class="typename">INTENT(IN) </code>:: <code class="vardecl">tdt</code></a>
<a name="updatediffusion_tlmi84"></a><a href="null_p.html#updatediffusion_modi83" target="origFile"><code class="comment">! scalar vertical diffusion coefficient (m^2/s)</code></a>
    <a href="null_p.html#updatediffusion_modi83" target="origFile"><code class="typename">REAL*8</code>, <code class="typename">INTENT(IN) </code>:: <code class="vardecl">vert_diffu_coef</code></a>
<a name="updatediffusion_tlmi85"></a><a href="null_p.html#updatediffusion_modi84" target="origFile"><code class="comment">! planetary boundary layer depth (m</code></a>
    <a href="null_p.html#updatediffusion_modi84" target="origFile"><code class="typename">REAL*8</code>, <code class="typename">INTENT(IN) </code>:: <code class="vardecl">pbl</code>(<code class="vardecl">i1</code>:<code class="vardecl">i2</code>, <code class="vardecl">ju1</code>:<code class="vardecl">j2</code>)</a>
<a name="updatediffusion_tlmi86"></a><a href="null_p.html#updatediffusion_modi85" target="origFile"><code class="comment">! tropopause pressure (mb)</code></a>
    <a href="null_p.html#updatediffusion_modi85" target="origFile"><code class="typename">REAL*8</code>, <code class="typename">INTENT(IN) </code>:: <code class="vardecl">tropp</code>(<code class="vardecl">i1</code>:<code class="vardecl">i2</code>, <code class="vardecl">ju1</code>:<code class="vardecl">j2</code>)</a>
<a name="updatediffusion_tlmi87"></a><a href="null_p.html#updatediffusion_modi86" target="origFile"><code class="comment">! atmospheric pressure at the center </code></a>
    <a href="null_p.html#updatediffusion_modi86" target="origFile"><code class="typename">REAL*8</code>, <code class="typename">INTENT(IN) </code>:: <code class="vardecl">press3c</code>(<code class="vardecl">ilo</code>:<code class="vardecl">ihi</code>, <code class="vardecl">julo</code>:<code class="vardecl">jhi</code>, <code class="vardecl">k1</code>:<code class="vardecl">k2</code>)</a>
<a href="null_p.html#updatediffusion_modi87" target="origFile"><code class="comment">! of each grid box (mb)</code></a>
<a name="updatediffusion_tlmi88"></a><a href="null_p.html#updatediffusion_modi87" target="origFile"><code class="comment">! atmospheric pressure at the edge</code></a>
    <a href="null_p.html#updatediffusion_modi87" target="origFile"><code class="typename">REAL*8</code>, <code class="typename">INTENT(IN) </code>:: <code class="vardecl">press3e</code>(<code class="vardecl">ilo</code>:<code class="vardecl">ihi</code>, <code class="vardecl">julo</code>:<code class="vardecl">jhi</code>, <code class="vardecl">k1</code>-<code class="constant">1</code>:<code class="vardecl">k2</code>)</a>
<a href="null_p.html#updatediffusion_modi88" target="origFile"><code class="comment">! of each grid box (mb)</code></a>
<a name="updatediffusion_tlmi89"></a><a href="null_p.html#updatediffusion_modi88" target="origFile"><code class="comment">! surface pressure field at t1, </code></a>
    <a href="null_p.html#updatediffusion_modi88" target="origFile"><code class="typename">REAL*8</code>, <code class="typename">INTENT(IN) </code>:: <code class="vardecl">pctm1</code>(<code class="vardecl">ilo</code>:<code class="vardecl">ihi</code>, <code class="vardecl">julo</code>:<code class="vardecl">jhi</code>)</a>
<a name="updatediffusion_tlmi90"></a><a href="null_p.html#updatediffusion_modi89" target="origFile"><code class="comment">! known at zone centers (mb)</code></a>
<a name="updatediffusion_tlmi91"></a>    <a href="null_p.html#updatediffusion_modi89" target="origFile"><code class="typename">LOGICAL</code>, <code class="typename">INTENT(IN) </code>:: <code class="vardecl">isfixedconcentration</code>(<code class="vardecl">numspecies</code>)</a>
    <a href="null_p.html#updatediffusion_modi90" target="origFile"><code class="typename">CHARACTER</code>(<code class="keyword">len</code>=esmf_maxstr), <code class="typename">INTENT(IN) </code>:: <code class="vardecl">mettype</code></a>
<a href="null_p.html#updatediffusion_modi91" target="origFile"><code class="comment">!</code></a>
<a href="null_p.html#updatediffusion_modi91" target="origFile"><code class="comment">! !INPUT/OUTPUT PARAMETERS:</code></a>
<a name="updatediffusion_tlmi92"></a><a href="null_p.html#updatediffusion_modi91" target="origFile"><code class="comment">! array of vertical diffusion coefficients (m^2/s)</code></a>
    <a href="null_p.html#updatediffusion_modi91" target="origFile"><code class="typename">REAL*8</code>, <code class="typename">INTENT(INOUT) </code>:: <code class="vardecl">kzz</code>(<code class="vardecl">i1</code>:<code class="vardecl">i2</code>, <code class="vardecl">ju1</code>:<code class="vardecl">j2</code>, <code class="vardecl">k1</code>:<code class="vardecl">k2</code>)</a>
<a href="null_p.html#updatediffusion_modi92" target="origFile"><code class="comment">! species concentration (mixing ratio)</code></a>
    <a href="null_p.html#updatediffusion_modi92" target="origFile"><code class="typename">TYPE(T_GMIARRAYBUNDLE)</code>, <code class="typename">INTENT(INOUT) </code>:: <code class="vardecl">concentration</code>(<code class="vardecl">numspecies</code>)</a>
<a name="updatediffusion_tlmi93"></a>    <a href="null_p.html#updatediffusion_mod" target="origFile"><code class="typename">TYPE(T_GMIARRAYBUNDLE)</code>, <code class="typename">INTENT(INOUT) </code>:: <code class="vardecl">concentration_tl</code>(<code class="vardecl">numspecies</code><code class="label">&</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="label">&   </code>)</a>
<a href="null_p.html#updatediffusion_modi93" target="origFile"><code class="comment">!</code></a>
<a href="null_p.html#updatediffusion_modi93" target="origFile"><code class="comment">! !DESCRIPTION:</code></a>
<a href="null_p.html#updatediffusion_modi93" target="origFile"><code class="comment">! Updates diffusion.</code></a>
<a href="null_p.html#updatediffusion_modi93" target="origFile"><code class="comment">!</code></a>
<a href="null_p.html#updatediffusion_modi93" target="origFile"><code class="comment">!EOP</code></a>
<a href="null_p.html#updatediffusion_modi93" target="origFile"><code class="comment">!------------------------------------------------------------------------------</code></a>
<a href="null_p.html#updatediffusion_modi93" target="origFile"><code class="comment">!BOC</code></a>
<a name="updatediffusion_tlmi94"></a>    <a href="null_p.html#updatediffusion_modi93" target="origFile"><code class="keyword">CALL </code><code class="funcname">ADJUST_KZZ</code>(press3c, tropp, kzz, i1, i2, ju1, j2, k1, k2, ilo, <code class="label">&</code></a>
<a href="null_p.html#updatediffusion_modi93" target="origFile"><code class="label">&             </code>ihi, julo, jhi)</a>
    <a href="null_p.html#updatediffusion_modi94" target="origFile"><code class="keyword">CALL </code><code class="funcname">DO_VERT_DIFFU_TLM</code>(tdt, vert_diffu_coef, pbl, kzz, press3c, <code class="label">&</code></a>
<a href="null_p.html#updatediffusion_modi94" target="origFile"><code class="label">&                    </code>press3e, pctm1, concentration, concentration_tl, <code class="label">&</code></a>
<a name="updatediffusion_tlmi95"></a><a href="null_p.html#updatediffusion_modi94" target="origFile"><code class="label">&                    </code>isfixedconcentration, mettype, i1, i2, ju1, j2, k1<code class="label">&</code></a>
<a href="null_p.html#updatediffusion_modi94" target="origFile"><code class="label">&                    </code>, k2, ilo, ihi, julo, jhi, numspecies)</a>
<a name="updatediffusion"></a>    <a href="null_p.html#updatediffusion_modi95" target="origFile"><code class="keyword">RETURN</code></a>
  <a href="null_p.html#updatediffusion_mod" target="origFile"><code class="keyword">END SUBROUTINE </code><code class="funcname">UPDATEDIFFUSION_TLM</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">!</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">! !DESCRIPTION:</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">!</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">! !AUTHOR:</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">!</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">! !REVISION HISTORY:</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">!</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">!EOP</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">!-------------------------------------------------------------------------</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">!-------------------------------------------------------------------------</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">!BOP</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">!</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">! !IROUTINE: updateDiffusion</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">!</code></a>
  <a href="null_p.html#updatediffusion_mod" target="origFile"><code class="keyword">SUBROUTINE </code><code class="funcname">UPDATEDIFFUSION</code>(<code class="vardecl">tdt</code>, <code class="vardecl">vert_diffu_coef</code>, <code class="vardecl">pbl</code>, <code class="vardecl">tropp</code>, <code class="vardecl">kzz</code>, <code class="label">&</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="label">&   </code><code class="vardecl">press3c</code>, <code class="vardecl">press3e</code>, <code class="vardecl">pctm1</code>, <code class="vardecl">concentration</code>, <code class="vardecl">isfixedconcentration</code>, <code class="label">&</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="label">&   </code><code class="vardecl">mettype</code>, <code class="vardecl">i1</code>, <code class="vardecl">i2</code>, <code class="vardecl">ju1</code>, <code class="vardecl">j2</code>, <code class="vardecl">k1</code>, <code class="vardecl">k2</code>, <code class="vardecl">ilo</code>, <code class="vardecl">ihi</code>, <code class="vardecl">julo</code>, <code class="vardecl">jhi</code>, <code class="vardecl">numspecies</code>)</a>
    <a href="null_p.html#updatediffusion_mod" target="origFile"><code class="keyword">IMPLICIT NONE</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">!</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">! !INPUT PARAMETERS:</code></a>
    <a href="null_p.html#updatediffusion_mod" target="origFile"><code class="typename">INTEGER</code>, <code class="typename">INTENT(IN) </code>:: <code class="vardecl">i1</code>, <code class="vardecl">i2</code>, <code class="vardecl">ju1</code>, <code class="vardecl">j2</code>, <code class="vardecl">k1</code>, <code class="vardecl">k2</code>, <code class="vardecl">ilo</code>, <code class="vardecl">ihi</code>, <code class="vardecl">julo</code>, <code class="vardecl">jhi</code></a>
    <a href="null_p.html#updatediffusion_mod" target="origFile"><code class="typename">INTEGER</code>, <code class="typename">INTENT(IN) </code>:: <code class="vardecl">numspecies</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">! model time step (s)</code></a>
    <a href="null_p.html#updatediffusion_mod" target="origFile"><code class="typename">REAL*8</code>, <code class="typename">INTENT(IN) </code>:: <code class="vardecl">tdt</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">! scalar vertical diffusion coefficient (m^2/s)</code></a>
    <a href="null_p.html#updatediffusion_mod" target="origFile"><code class="typename">REAL*8</code>, <code class="typename">INTENT(IN) </code>:: <code class="vardecl">vert_diffu_coef</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">! planetary boundary layer depth (m</code></a>
    <a href="null_p.html#updatediffusion_mod" target="origFile"><code class="typename">REAL*8</code>, <code class="typename">INTENT(IN) </code>:: <code class="vardecl">pbl</code>(<code class="vardecl">i1</code>:<code class="vardecl">i2</code>, <code class="vardecl">ju1</code>:<code class="vardecl">j2</code>)</a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">! tropopause pressure (mb)</code></a>
    <a href="null_p.html#updatediffusion_mod" target="origFile"><code class="typename">REAL*8</code>, <code class="typename">INTENT(IN) </code>:: <code class="vardecl">tropp</code>(<code class="vardecl">i1</code>:<code class="vardecl">i2</code>, <code class="vardecl">ju1</code>:<code class="vardecl">j2</code>)</a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">! atmospheric pressure at the center </code></a>
    <a href="null_p.html#updatediffusion_mod" target="origFile"><code class="typename">REAL*8</code>, <code class="typename">INTENT(IN) </code>:: <code class="vardecl">press3c</code>(<code class="vardecl">ilo</code>:<code class="vardecl">ihi</code>, <code class="vardecl">julo</code>:<code class="vardecl">jhi</code>, <code class="vardecl">k1</code>:<code class="vardecl">k2</code>)</a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">! of each grid box (mb)</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">! atmospheric pressure at the edge</code></a>
    <a href="null_p.html#updatediffusion_mod" target="origFile"><code class="typename">REAL*8</code>, <code class="typename">INTENT(IN) </code>:: <code class="vardecl">press3e</code>(<code class="vardecl">ilo</code>:<code class="vardecl">ihi</code>, <code class="vardecl">julo</code>:<code class="vardecl">jhi</code>, <code class="vardecl">k1</code>-<code class="constant">1</code>:<code class="vardecl">k2</code>)</a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">! of each grid box (mb)</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">! surface pressure field at t1, </code></a>
    <a href="null_p.html#updatediffusion_mod" target="origFile"><code class="typename">REAL*8</code>, <code class="typename">INTENT(IN) </code>:: <code class="vardecl">pctm1</code>(<code class="vardecl">ilo</code>:<code class="vardecl">ihi</code>, <code class="vardecl">julo</code>:<code class="vardecl">jhi</code>)</a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">! known at zone centers (mb)</code></a>
    <a href="null_p.html#updatediffusion_mod" target="origFile"><code class="typename">LOGICAL</code>, <code class="typename">INTENT(IN) </code>:: <code class="vardecl">isfixedconcentration</code>(<code class="vardecl">numspecies</code>)</a>
    <a href="null_p.html#updatediffusion_mod" target="origFile"><code class="typename">CHARACTER</code>(<code class="keyword">len</code>=esmf_maxstr), <code class="typename">INTENT(IN) </code>:: <code class="vardecl">mettype</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">!</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">! !INPUT/OUTPUT PARAMETERS:</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">! array of vertical diffusion coefficients (m^2/s)</code></a>
    <a href="null_p.html#updatediffusion_mod" target="origFile"><code class="typename">REAL*8</code>, <code class="typename">INTENT(INOUT) </code>:: <code class="vardecl">kzz</code>(<code class="vardecl">i1</code>:<code class="vardecl">i2</code>, <code class="vardecl">ju1</code>:<code class="vardecl">j2</code>, <code class="vardecl">k1</code>:<code class="vardecl">k2</code>)</a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">! species concentration (mixing ratio)</code></a>
    <a href="null_p.html#updatediffusion_mod" target="origFile"><code class="typename">TYPE(T_GMIARRAYBUNDLE)</code>, <code class="typename">INTENT(INOUT) </code>:: <code class="vardecl">concentration</code>(<code class="vardecl">numspecies</code>)</a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">!</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">! !DESCRIPTION:</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">! Updates diffusion.</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">!</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">!EOP</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">!------------------------------------------------------------------------------</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">!BOC</code></a>
    <a href="null_p.html#updatediffusion_mod" target="origFile"><code class="keyword">CALL </code><code class="funcname">ADJUST_KZZ</code>(press3c, tropp, kzz, i1, i2, ju1, j2, k1, k2, ilo, <code class="label">&</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="label">&             </code>ihi, julo, jhi)</a>
    <a href="null_p.html#updatediffusion_mod" target="origFile"><code class="keyword">CALL </code><code class="funcname">DO_VERT_DIFFU</code>(tdt, vert_diffu_coef, pbl, kzz, press3c, press3e<code class="label">&</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="label">&                </code>, pctm1, concentration, isfixedconcentration, mettype, <code class="label">&</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="label">&                </code>i1, i2, ju1, j2, k1, k2, ilo, ihi, julo, jhi, <code class="label">&</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="label">&                </code>numspecies)</a>
<a name="update_pbl_mixing"></a>    <a href="null_p.html#updatediffusion_mod" target="origFile"><code class="keyword">RETURN</code></a>
  <a href="null_p.html#updatediffusion_mod" target="origFile"><code class="keyword">END SUBROUTINE </code><code class="funcname">UPDATEDIFFUSION</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">!</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">!EOC</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">!------------------------------------------------------------------------------</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">!BOP</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">!</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">! !IROUTINE: Update_PBL_Mixing</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">!</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">! !INTERFACE: </code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">!</code></a>
  <a href="null_p.html#updatediffusion_mod" target="origFile"><code class="keyword">SUBROUTINE </code><code class="funcname">UPDATE_PBL_MIXING</code>(<code class="vardecl">tdt</code>, <code class="vardecl">pbl_mixing_tau</code>, <code class="vardecl">pbl</code>, <code class="vardecl">grid_height</code>, <code class="label">&</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="label">&   </code><code class="vardecl">mass</code>, <code class="vardecl">concentration</code>, <code class="vardecl">i1</code>, <code class="vardecl">i2</code>, <code class="vardecl">ju1</code>, <code class="vardecl">j2</code>, <code class="vardecl">k1</code>, <code class="vardecl">k2</code>, <code class="vardecl">numspecies</code>)</a>
    <a href="null_p.html#updatediffusion_mod" target="origFile"><code class="keyword">IMPLICIT NONE</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">!</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">! !INPUT PARAMETERS:</code></a>
    <a href="null_p.html#updatediffusion_mod" target="origFile"><code class="typename">INTEGER</code>, <code class="typename">INTENT(IN) </code>:: <code class="vardecl">i1</code>, <code class="vardecl">i2</code>, <code class="vardecl">ju1</code>, <code class="vardecl">j2</code>, <code class="vardecl">k1</code>, <code class="vardecl">k2</code></a>
    <a href="null_p.html#updatediffusion_mod" target="origFile"><code class="typename">INTEGER</code>, <code class="typename">INTENT(IN) </code>:: <code class="vardecl">numspecies</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">! model time step (s)</code></a>
    <a href="null_p.html#updatediffusion_mod" target="origFile"><code class="typename">REAL*8</code>, <code class="typename">INTENT(IN) </code>:: <code class="vardecl">tdt</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">! time scale for pbl mixing (s)</code></a>
    <a href="null_p.html#updatediffusion_mod" target="origFile"><code class="typename">REAL*8</code>, <code class="typename">INTENT(IN) </code>:: <code class="vardecl">pbl_mixing_tau</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">! planetary boundary layer depth (m)</code></a>
    <a href="null_p.html#updatediffusion_mod" target="origFile"><code class="typename">REAL*8</code>, <code class="typename">INTENT(IN) </code>:: <code class="vardecl">pbl</code>(<code class="vardecl">i1</code>:<code class="vardecl">i2</code>, <code class="vardecl">ju1</code>:<code class="vardecl">j2</code>)</a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">! height of each grid box (m)</code></a>
    <a href="null_p.html#updatediffusion_mod" target="origFile"><code class="typename">REAL*8</code>, <code class="typename">INTENT(IN) </code>:: <code class="vardecl">grid_height</code>(<code class="vardecl">i1</code>:<code class="vardecl">i2</code>, <code class="vardecl">ju1</code>:<code class="vardecl">j2</code>, <code class="vardecl">k1</code>:<code class="vardecl">k2</code>)</a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">! air mass in each grid box (kg)</code></a>
    <a href="null_p.html#updatediffusion_mod" target="origFile"><code class="typename">REAL*8</code>, <code class="typename">INTENT(IN) </code>:: <code class="vardecl">mass</code>(<code class="vardecl">i1</code>:<code class="vardecl">i2</code>, <code class="vardecl">ju1</code>:<code class="vardecl">j2</code>, <code class="vardecl">k1</code>:<code class="vardecl">k2</code>)</a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">!</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">! !INPUT/OUTPUT PARAMETERS:</code></a>
    <a href="null_p.html#updatediffusion_mod" target="origFile"><code class="typename">TYPE(T_GMIARRAYBUNDLE)</code>, <code class="typename">INTENT(INOUT) </code>:: <code class="vardecl">concentration</code>(<code class="vardecl">numspecies</code>)</a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">!</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">! !DESCRIPTION:</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">!   Updates diffusion through a boundary layer mixing model.</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">!</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">! !LOCAL VARIABLES:</code></a>
    <a href="null_p.html#updatediffusion_mod" target="origFile"><code class="typename">INTEGER </code>:: <code class="vardecl">ic</code>, <code class="vardecl">il</code>, <code class="vardecl">ij</code>, <code class="vardecl">ik</code>, <code class="vardecl">kpbl</code></a>
    <a href="null_p.html#updatediffusion_mod" target="origFile"><code class="typename">REAL*8 </code>:: <code class="vardecl">frac_pbl</code>, <code class="vardecl">height</code>, <code class="vardecl">mass_pbl</code>, <code class="vardecl">mixing_factor</code>, <code class="vardecl">well_mixed</code></a>
    <a href="null_p.html#updatediffusion_mod" target="origFile"><code class="keyword">INTRINSIC </code><code class="funcname">EXP</code></a>
    <a href="null_p.html#updatediffusion_mod" target="origFile"><code class="keyword">INTRINSIC </code><code class="funcname">SUM</code></a>
    <a href="null_p.html#updatediffusion_mod" target="origFile"><code class="typename">REAL*8</code>, DIMENSION(kpbl-k1) :: <code class="vardecl">arg1</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">!EOP</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">!------------------------------------------------------------------------------</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">!BOC</code></a>
    <a href="null_p.html#updatediffusion_mod" target="origFile">mixing_factor = <code class="funcname">EXP</code>(-(tdt/pbl_mixing_tau))</a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">!---------------------------------------</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">! Loop over all longitudes and latitudes.</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">!---------------------------------------</code></a>
    <a href="null_p.html#updatediffusion_mod" target="origFile"><code class="keyword">DO </code>il=i1,i2</a>
      <a href="null_p.html#updatediffusion_mod" target="origFile"><code class="keyword">DO </code>ij=ju1,j2</a>
        <a href="null_p.html#updatediffusion_mod" target="origFile">mass_pbl = <code class="constant">0.0d0</code></a>
        <a href="null_p.html#updatediffusion_mod" target="origFile">height = <code class="constant">0.0d0</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">!-----------------------------------</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">! Find the total mass within the pbl.</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">!-----------------------------------</code></a>
  <a href="null_p.html#updatediffusion_mod" target="origFile"><code class="label">kloop:</code><code class="keyword">DO </code>ik=k1,k2</a>
          <a href="null_p.html#updatediffusion_mod" target="origFile">height = height + grid_height(il, ij, ik)</a>
          <a href="null_p.html#updatediffusion_mod" target="origFile"><code class="keyword">IF</code> (pbl(il, ij) .GE. height) <code class="keyword">THEN</code></a>
            <a href="null_p.html#updatediffusion_mod" target="origFile">mass_pbl = mass_pbl + mass(il, ij, ik)</a>
          <a href="null_p.html#updatediffusion_mod" target="origFile"><code class="keyword">ELSE</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">!-------------------------------------------------------</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">! This grid box is fractionally in the PBL. Save part of</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">! its mass also, save the k index, and exit the loop.</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">!-------------------------------------------------------</code></a>
            <a href="null_p.html#updatediffusion_mod" target="origFile">frac_pbl = (pbl(il, ij)-(height-grid_height(il, ij, ik)))/<code class="label">&</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="label">&             </code>grid_height(il, ij, ik)</a>
            <a href="null_p.html#updatediffusion_mod" target="origFile">mass_pbl = mass_pbl + mass(il, ij, ik)*frac_pbl</a>
            <a href="null_p.html#updatediffusion_mod" target="origFile">kpbl = ik</a>
            <a href="null_p.html#updatediffusion_mod" target="origFile"><code class="keyword">GOTO </code><code class="label">100</code></a>
          <a href="null_p.html#updatediffusion_mod" target="origFile"><code class="keyword">END IF</code></a>
        <a href="null_p.html#updatediffusion_mod" target="origFile"><code class="keyword">END DO </code><code class="label">kloop</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">!--------------------------------------------------------</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">! Now if a real PBL was found (kpbl &gt; k1) loop over the</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">! species, calculate a well mixed</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">! mixing ratio, and apply it to the grids within the pbl</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">! and then to the grid box</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">! which is fractionally within the pbl.</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">!---------------------------------------------------------</code></a>
 <a href="null_p.html#updatediffusion_mod" target="origFile"><code class="label">100    </code><code class="keyword">IF</code> (kpbl .GT. k1) <code class="keyword">THEN</code></a>
          <a href="null_p.html#updatediffusion_mod" target="origFile"><code class="keyword">DO </code>ic=<code class="constant">1</code>,numspecies</a>
            <a href="null_p.html#updatediffusion_mod" target="origFile">arg1(:) = concentration(ic)%parray3d(il, ij, k1:kpbl-<code class="constant">1</code>)*mass<code class="label">&</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="label">&             </code>(il, ij, k1:kpbl-<code class="constant">1</code>)</a>
            <a href="null_p.html#updatediffusion_mod" target="origFile">well_mixed = (<code class="funcname">SUM</code>(arg1(:))+frac_pbl*concentration(ic)%<code class="label">&</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="label">&             </code>parray3d(il, ij, kpbl)*mass(il, ij, kpbl))/mass_pbl</a>
            <a href="null_p.html#updatediffusion_mod" target="origFile">concentration(ic)%parray3d(il, ij, <code class="constant">1</code>:kpbl-<code class="constant">1</code>) = concentration<code class="label">&</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="label">&             </code>(ic)%parray3d(il, ij, k1:kpbl-<code class="constant">1</code>)*mixing_factor + <code class="label">&</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="label">&             </code>well_mixed*(<code class="constant">1.0d0</code>-mixing_factor)</a>
            <a href="null_p.html#updatediffusion_mod" target="origFile">concentration(ic)%parray3d(il, ij, kpbl) = concentration(ic)<code class="label">&</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="label">&             </code>%parray3d(il, ij, kpbl) + frac_pbl*(concentration(ic)%<code class="label">&</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="label">&             </code>parray3d(il, ij, kpbl)*(mixing_factor-<code class="constant">1.0d0</code>)+well_mixed*(<code class="label">&</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="label">&             </code><code class="constant">1.0d0</code>-mixing_factor))</a>
          <a href="null_p.html#updatediffusion_mod" target="origFile"><code class="keyword">END DO</code></a>
        <a href="null_p.html#updatediffusion_mod" target="origFile"><code class="keyword">END IF</code></a>
      <a href="null_p.html#updatediffusion_mod" target="origFile"><code class="keyword">END DO</code></a>
    <a href="null_p.html#updatediffusion_mod" target="origFile"><code class="keyword">END DO</code></a>
<a name="adjust_kzz"></a>    <a href="null_p.html#updatediffusion_mod" target="origFile"><code class="keyword">RETURN</code></a>
  <a href="null_p.html#updatediffusion_mod" target="origFile"><code class="keyword">END SUBROUTINE </code><code class="funcname">UPDATE_PBL_MIXING</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">!EOC</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">!------------------------------------------------------------------------------</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">!BOP</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">!</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">! !IROUTINE: Adjust_Kzz</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">!</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">! !INTERFACE:</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">!</code></a>
  <a href="null_p.html#updatediffusion_mod" target="origFile"><code class="keyword">SUBROUTINE </code><code class="funcname">ADJUST_KZZ</code>(<code class="vardecl">press3c</code>, <code class="vardecl">tropp</code>, <code class="vardecl">kzz</code>, <code class="vardecl">i1</code>, <code class="vardecl">i2</code>, <code class="vardecl">ju1</code>, <code class="vardecl">j2</code>, <code class="vardecl">k1</code>, <code class="vardecl">k2</code>, <code class="label">&</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="label">&   </code><code class="vardecl">ilo</code>, <code class="vardecl">ihi</code>, <code class="vardecl">julo</code>, <code class="vardecl">jhi</code>)</a>
    <a href="null_p.html#updatediffusion_mod" target="origFile"><code class="keyword">IMPLICIT NONE</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">!</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">! !INPUT PARAMETERS</code></a>
    <a href="null_p.html#updatediffusion_mod" target="origFile"><code class="typename">INTEGER</code>, <code class="typename">INTENT(IN) </code>:: <code class="vardecl">i1</code>, <code class="vardecl">i2</code>, <code class="vardecl">ju1</code>, <code class="vardecl">j2</code>, <code class="vardecl">k1</code>, <code class="vardecl">k2</code>, <code class="vardecl">ilo</code>, <code class="vardecl">ihi</code>, <code class="vardecl">julo</code>, <code class="vardecl">jhi</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">! atmospheric pressure at the center </code></a>
    <a href="null_p.html#updatediffusion_mod" target="origFile"><code class="typename">REAL*8</code>, <code class="typename">INTENT(IN) </code>:: <code class="vardecl">press3c</code>(<code class="vardecl">ilo</code>:<code class="vardecl">ihi</code>, <code class="vardecl">julo</code>:<code class="vardecl">jhi</code>, <code class="vardecl">k1</code>:<code class="vardecl">k2</code>)</a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">! of each grid box (mb)</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">! tropopause pressure (mb)</code></a>
    <a href="null_p.html#updatediffusion_mod" target="origFile"><code class="typename">REAL*8</code>, <code class="typename">INTENT(IN) </code>:: <code class="vardecl">tropp</code>(<code class="vardecl">i1</code>:<code class="vardecl">i2</code>, <code class="vardecl">ju1</code>:<code class="vardecl">j2</code>)</a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">!</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">! !INPUT/OUTPUT PARAMETERS:</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">! vertical diffusion coefficients (m^2/s)</code></a>
    <a href="null_p.html#updatediffusion_mod" target="origFile"><code class="typename">REAL*8</code>, <code class="typename">INTENT(INOUT) </code>:: <code class="vardecl">kzz</code>(<code class="vardecl">i1</code>:<code class="vardecl">i2</code>, <code class="vardecl">ju1</code>:<code class="vardecl">j2</code>, <code class="vardecl">k1</code>:<code class="vardecl">k2</code>)</a>
    <a href="null_p.html#updatediffusion_mod" target="origFile"><code class="keyword">INTRINSIC </code><code class="funcname">MAXVAL</code></a>
    <a href="null_p.html#updatediffusion_mod" target="origFile"><code class="typename">REAL*8 </code>:: <code class="vardecl">result1</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">!</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">! !DESCRIPTION:</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">!   Makes the kzz (vertical diffusion) zero above the tropopause.</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">!</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">!EOP</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">!------------------------------------------------------------------------------</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">!BOC</code></a>
    <a href="null_p.html#updatediffusion_mod" target="origFile">result1 = <code class="funcname">MAXVAL</code>(kzz)</a>
    <a href="null_p.html#updatediffusion_mod" target="origFile"><code class="keyword">IF</code> (result1 .GT. <code class="constant">0.0d0</code>) <code class="keyword">THEN</code></a>
      <a href="null_p.html#updatediffusion_mod" target="origFile"><code class="keyword">WHERE </code>(press3c(i1:i2, ju1:j2, :) .LT. result1 + <code class="constant">100.0d0</code>) </a>
        <a href="null_p.html#updatediffusion_mod" target="origFile">result1 = <code class="funcname">SPREAD</code>(tropp(:, :), <code class="constant">3</code>, k2)</a>
        <a href="null_p.html#updatediffusion_mod" target="origFile">kzz(i1:i2, ju1:j2, :) = <code class="constant">0.0d0</code></a>
      <a href="null_p.html#updatediffusion_mod" target="origFile"><code class="keyword">END WHERE</code></a>
    <a href="null_p.html#updatediffusion_mod" target="origFile"><code class="keyword">END IF</code></a>
<a name="do_vert_diffu_tlm"></a>    <a href="null_p.html#updatediffusion_mod" target="origFile"><code class="keyword">RETURN</code></a>
  <a href="null_p.html#updatediffusion_mod" target="origFile"><code class="keyword">END SUBROUTINE </code><code class="funcname">ADJUST_KZZ</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">!  Differentiation of do_vert_diffu in forward (tangent) mode:</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">!   variations   of useful results: *(concentration.parray3d)</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">!   with respect to varying inputs: *(concentration.parray3d)</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">!   Plus diff mem management of: concentration.parray3d:in</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">!EOP</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">!------------------------------------------------------------------------------</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">!BOC</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">!</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">! !IROUTINE: Do_Vert_Diffu</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">!</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">! !INTERFACE:</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">!</code></a>
  <a href="null_p.html#updatediffusion_mod" target="origFile"><code class="keyword">SUBROUTINE </code><code class="funcname">DO_VERT_DIFFU_TLM</code>(<code class="vardecl">tdt</code>, <code class="vardecl">vert_diffu_coef</code>, <code class="vardecl">pbl</code>, <code class="vardecl">kzz</code>, <code class="vardecl">press3c</code>, <code class="label">&</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="label">&   </code><code class="vardecl">press3e</code>, <code class="vardecl">psf</code>, <code class="vardecl">concentration</code>, <code class="vardecl">concentration_tl</code>, <code class="vardecl">isfixedconcentration</code><code class="label">&</code></a>
<a name="do_vert_diffu_tlmi0"></a><a href="null_p.html#updatediffusion_mod" target="origFile"><code class="label">&   </code>, <code class="vardecl">mettype</code>, <code class="vardecl">i1</code>, <code class="vardecl">i2</code>, <code class="vardecl">ju1</code>, <code class="vardecl">j2</code>, <code class="vardecl">k1</code>, <code class="vardecl">k2</code>, <code class="vardecl">ilo</code>, <code class="vardecl">ihi</code>, <code class="vardecl">julo</code>, <code class="vardecl">jhi</code>, <code class="vardecl">numspecies</code>)</a>
    <a href="null_p.html#updatediffusion_mod" target="origFile"><code class="keyword">IMPLICIT NONE</code></a>
<a href="null_p.html#updatediffusion_modi0" target="origFile"><code class="comment">!</code></a>
<a name="do_vert_diffu_tlmi1"></a><a href="null_p.html#updatediffusion_modi0" target="origFile"><code class="comment">! !INPUT PARAMETERS:</code></a>
<a name="do_vert_diffu_tlmi2"></a>    <a href="null_p.html#updatediffusion_modi0" target="origFile"><code class="typename">INTEGER</code>, <code class="typename">INTENT(IN) </code>:: <code class="vardecl">i1</code>, <code class="vardecl">i2</code>, <code class="vardecl">ju1</code>, <code class="vardecl">j2</code>, <code class="vardecl">k1</code>, <code class="vardecl">k2</code>, <code class="vardecl">ilo</code>, <code class="vardecl">ihi</code>, <code class="vardecl">julo</code>, <code class="vardecl">jhi</code></a>
    <a href="null_p.html#updatediffusion_modi1" target="origFile"><code class="typename">INTEGER</code>, <code class="typename">INTENT(IN) </code>:: <code class="vardecl">numspecies</code></a>
<a name="do_vert_diffu_tlmi3"></a><a href="null_p.html#updatediffusion_modi2" target="origFile"><code class="comment">! model time step (s)</code></a>
    <a href="null_p.html#updatediffusion_modi2" target="origFile"><code class="typename">REAL*8</code>, <code class="typename">INTENT(IN) </code>:: <code class="vardecl">tdt</code></a>
<a name="do_vert_diffu_tlmi4"></a><a href="null_p.html#updatediffusion_modi3" target="origFile"><code class="comment">! scalar vertical diffusion coefficient (m^2/s)</code></a>
    <a href="null_p.html#updatediffusion_modi3" target="origFile"><code class="typename">REAL*8</code>, <code class="typename">INTENT(IN) </code>:: <code class="vardecl">vert_diffu_coef</code></a>
<a name="do_vert_diffu_tlmi5"></a><a href="null_p.html#updatediffusion_modi4" target="origFile"><code class="comment">! planetary boundary layer depth (m)</code></a>
    <a href="null_p.html#updatediffusion_modi4" target="origFile"><code class="typename">REAL*8</code>, <code class="typename">INTENT(IN) </code>:: <code class="vardecl">pbl</code>(<code class="vardecl">i1</code>:<code class="vardecl">i2</code>, <code class="vardecl">ju1</code>:<code class="vardecl">j2</code>)</a>
<a name="do_vert_diffu_tlmi6"></a><a href="null_p.html#updatediffusion_modi5" target="origFile"><code class="comment">! vertical diffusion coefficients (m^2/s)</code></a>
    <a href="null_p.html#updatediffusion_modi5" target="origFile"><code class="typename">REAL*8</code>, <code class="typename">INTENT(IN) </code>:: <code class="vardecl">kzz</code>(<code class="vardecl">i1</code>:<code class="vardecl">i2</code>, <code class="vardecl">ju1</code>:<code class="vardecl">j2</code>, <code class="vardecl">k1</code>:<code class="vardecl">k2</code>)</a>
<a name="do_vert_diffu_tlmi7"></a><a href="null_p.html#updatediffusion_modi6" target="origFile"><code class="comment">! atmospheric pressure at the center of each grid box (mb)</code></a>
    <a href="null_p.html#updatediffusion_modi6" target="origFile"><code class="typename">REAL*8</code>, <code class="typename">INTENT(IN) </code>:: <code class="vardecl">press3c</code>(<code class="vardecl">ilo</code>:<code class="vardecl">ihi</code>, <code class="vardecl">julo</code>:<code class="vardecl">jhi</code>, <code class="vardecl">k1</code>:<code class="vardecl">k2</code>)</a>
<a name="do_vert_diffu_tlmi8"></a><a href="null_p.html#updatediffusion_modi7" target="origFile"><code class="comment">! atmospheric pressure at the edge   of each grid box (mb)</code></a>
    <a href="null_p.html#updatediffusion_modi7" target="origFile"><code class="typename">REAL*8</code>, <code class="typename">INTENT(IN) </code>:: <code class="vardecl">press3e</code>(<code class="vardecl">ilo</code>:<code class="vardecl">ihi</code>, <code class="vardecl">julo</code>:<code class="vardecl">jhi</code>, <code class="vardecl">k1</code>-<code class="constant">1</code>:<code class="vardecl">k2</code>)</a>
<a name="do_vert_diffu_tlmi9"></a><a href="null_p.html#updatediffusion_modi8" target="origFile"><code class="comment">! surface pressure field known at zone centers (mb)</code></a>
<a name="do_vert_diffu_tlmi10"></a>    <a href="null_p.html#updatediffusion_modi8" target="origFile"><code class="typename">REAL*8</code>, <code class="typename">INTENT(IN) </code>:: <code class="vardecl">psf</code>(<code class="vardecl">ilo</code>:<code class="vardecl">ihi</code>, <code class="vardecl">julo</code>:<code class="vardecl">jhi</code>)</a>
<a name="do_vert_diffu_tlmi11"></a>    <a href="null_p.html#updatediffusion_modi9" target="origFile"><code class="typename">LOGICAL</code>, <code class="typename">INTENT(IN) </code>:: <code class="vardecl">isfixedconcentration</code>(<code class="vardecl">numspecies</code>)</a>
    <a href="null_p.html#updatediffusion_modi10" target="origFile"><code class="typename">CHARACTER</code>(<code class="keyword">len</code>=esmf_maxstr), <code class="typename">INTENT(IN) </code>:: <code class="vardecl">mettype</code></a>
<a href="null_p.html#updatediffusion_modi11" target="origFile"><code class="comment">!</code></a>
<a href="null_p.html#updatediffusion_modi11" target="origFile"><code class="comment">! !INPUT/OUTPUT PARAMETERS:</code></a>
    <a href="null_p.html#updatediffusion_modi11" target="origFile"><code class="typename">TYPE(T_GMIARRAYBUNDLE)</code>, <code class="typename">INTENT(INOUT) </code>:: <code class="vardecl">concentration</code>(<code class="vardecl">numspecies</code>)</a>
<a name="do_vert_diffu_tlmi12"></a>    <a href="null_p.html#updatediffusion_mod" target="origFile"><code class="typename">TYPE(T_GMIARRAYBUNDLE)</code>, <code class="typename">INTENT(INOUT) </code>:: <code class="vardecl">concentration_tl</code>(<code class="vardecl">numspecies</code><code class="label">&</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="label">&   </code>)</a>
<a href="null_p.html#updatediffusion_modi12" target="origFile"><code class="comment">!</code></a>
<a href="null_p.html#updatediffusion_modi12" target="origFile"><code class="comment">! !DECLARED VARIABLES:</code></a>
<a name="do_vert_diffu_tlmi13"></a><a href="null_p.html#updatediffusion_modi12" target="origFile"><code class="comment">! atmospheric scale height (m)</code></a>
    <a href="null_p.html#updatediffusion_modi12" target="origFile"><code class="typename">REAL*8</code>, <code class="typename">PARAMETER </code>:: <code class="vardecl">hzero</code>=<code class="constant">8000.0d0</code></a>
<a name="do_vert_diffu_tlmi14"></a><a href="null_p.html#updatediffusion_modi13" target="origFile"><code class="comment">! (m^2)</code></a>
    <a href="null_p.html#updatediffusion_modi13" target="origFile"><code class="typename">REAL*8</code>, <code class="typename">PARAMETER </code>:: <code class="vardecl">hzero2</code>=<code class="vardecl">hzero</code>*<code class="vardecl">hzero</code></a>
<a href="null_p.html#updatediffusion_modi14" target="origFile"><code class="comment">!</code></a>
<a href="null_p.html#updatediffusion_modi14" target="origFile"><code class="comment">! !DESCRIPTION:</code></a>
<a href="null_p.html#updatediffusion_modi14" target="origFile"><code class="comment">!   Calculates vertical diffusion using an implicit technique.</code></a>
<a href="null_p.html#updatediffusion_modi14" target="origFile"><code class="comment">!   Note: Constituent mass is conserved during mixing.</code></a>
<a href="null_p.html#updatediffusion_modi14" target="origFile"><code class="comment">!          Constant field should remain constant.</code></a>
<a href="null_p.html#updatediffusion_modi14" target="origFile"><code class="comment">!</code></a>
<a name="do_vert_diffu_tlmi15"></a><a href="null_p.html#updatediffusion_modi14" target="origFile"><code class="comment">! !LOCAL VARIABLES:</code></a>
<a name="do_vert_diffu_tlmi16"></a>    <a href="null_p.html#updatediffusion_modi14" target="origFile"><code class="typename">INTEGER </code>:: <code class="vardecl">ik</code>, <code class="vardecl">ic</code></a>
<a name="do_vert_diffu_tlmi17"></a>    <a href="null_p.html#updatediffusion_modi15" target="origFile"><code class="typename">REAL*8 </code>:: <code class="vardecl">avdiff</code>(<code class="vardecl">i1</code>:<code class="vardecl">i2</code>, <code class="vardecl">ju1</code>:<code class="vardecl">j2</code>, <code class="vardecl">k1</code>:<code class="vardecl">k2</code>-<code class="constant">1</code>)</a>
<a name="do_vert_diffu_tlmi18"></a>    <a href="null_p.html#updatediffusion_modi16" target="origFile"><code class="typename">REAL*8 </code>:: <code class="vardecl">bvdiff</code>(<code class="vardecl">i1</code>:<code class="vardecl">i2</code>, <code class="vardecl">ju1</code>:<code class="vardecl">j2</code>, <code class="vardecl">k1</code>:<code class="vardecl">k2</code>-<code class="constant">1</code>)</a>
<a name="do_vert_diffu_tlmi19"></a>    <a href="null_p.html#updatediffusion_modi17" target="origFile"><code class="typename">REAL*8 </code>:: <code class="vardecl">cvdiff</code>(<code class="vardecl">i1</code>:<code class="vardecl">i2</code>, <code class="vardecl">ju1</code>:<code class="vardecl">j2</code>, <code class="vardecl">k1</code>:<code class="vardecl">k2</code>-<code class="constant">1</code>)</a>
<a name="do_vert_diffu_tlmi20"></a>    <a href="null_p.html#updatediffusion_modi18" target="origFile"><code class="typename">REAL*8 </code>:: <code class="vardecl">vdiff</code>(<code class="vardecl">i1</code>:<code class="vardecl">i2</code>, <code class="vardecl">ju1</code>:<code class="vardecl">j2</code>, <code class="vardecl">k1</code>:<code class="vardecl">k2</code>-<code class="constant">1</code>)</a>
<a name="do_vert_diffu_tlmi21"></a>    <a href="null_p.html#updatediffusion_modi19" target="origFile"><code class="typename">REAL*8 </code>:: <code class="vardecl">bb</code>(<code class="vardecl">i1</code>:<code class="vardecl">i2</code>, <code class="vardecl">ju1</code>:<code class="vardecl">j2</code>, <code class="vardecl">k1</code>:<code class="vardecl">k2</code>-<code class="constant">1</code>)</a>
    <a href="null_p.html#updatediffusion_modi20" target="origFile"><code class="typename">REAL*8 </code>:: <code class="vardecl">cc</code>(<code class="vardecl">i1</code>:<code class="vardecl">i2</code>, <code class="vardecl">ju1</code>:<code class="vardecl">j2</code>, <code class="vardecl">k1</code>:<code class="vardecl">k2</code>-<code class="constant">1</code>)</a>
<a name="do_vert_diffu_tlmi22"></a>    <a href="null_p.html#updatediffusion_modi21" target="origFile"><code class="typename">REAL*8 </code>:: <code class="vardecl">rr</code>(<code class="vardecl">i1</code>:<code class="vardecl">i2</code>, <code class="vardecl">ju1</code>:<code class="vardecl">j2</code>, <code class="vardecl">k1</code>:<code class="vardecl">k2</code>-<code class="constant">1</code>)</a>
<a name="do_vert_diffu_tlmi23"></a>    <a href="null_p.html#updatediffusion_mod" target="origFile"><code class="typename">REAL*8 </code>:: <code class="vardecl">rr_tl</code>(<code class="vardecl">i1</code>:<code class="vardecl">i2</code>, <code class="vardecl">ju1</code>:<code class="vardecl">j2</code>, <code class="vardecl">k1</code>:<code class="vardecl">k2</code>-<code class="constant">1</code>)</a>
<a name="do_vert_diffu_tlmi24"></a>    <a href="null_p.html#updatediffusion_modi22" target="origFile"><code class="keyword">INTRINSIC </code><code class="funcname">MAXVAL</code></a>
<a name="do_vert_diffu_tlmi25"></a>    <a href="null_p.html#updatediffusion_modi23" target="origFile"><code class="keyword">INTRINSIC </code><code class="funcname">LOG</code></a>
<a name="do_vert_diffu_tlmi26"></a>    <a href="null_p.html#updatediffusion_modi24" target="origFile"><code class="keyword">INTRINSIC </code><code class="funcname">ABS</code></a>
<a name="do_vert_diffu_tlmi27"></a>    <a href="null_p.html#updatediffusion_modi25" target="origFile"><code class="keyword">INTRINSIC </code><code class="funcname">TRIM</code></a>
<a name="do_vert_diffu_tlmi28"></a>    <a href="null_p.html#updatediffusion_modi26" target="origFile"><code class="typename">REAL*8</code>, DIMENSION(i1:i2, ju1:j2) :: <code class="vardecl">abs0</code></a>
<a name="do_vert_diffu_tlmi29"></a>    <a href="null_p.html#updatediffusion_modi27" target="origFile"><code class="typename">REAL*8 </code>:: <code class="vardecl">result1</code></a>
    <a href="null_p.html#updatediffusion_modi28" target="origFile"><code class="typename">REAL*8</code>, DIMENSION(i2-i1+<code class="constant">1</code>, j2-ju1+<code class="constant">1</code>) :: <code class="vardecl">arg1</code></a>
<a href="null_p.html#updatediffusion_modi29" target="origFile"><code class="comment">!</code></a>
<a href="null_p.html#updatediffusion_modi29" target="origFile"><code class="comment">!EOP</code></a>
<a href="null_p.html#updatediffusion_modi29" target="origFile"><code class="comment">!------------------------------------------------------------------------------</code></a>
<a name="do_vert_diffu_tlmi30"></a><a href="null_p.html#updatediffusion_modi29" target="origFile"><code class="comment">!BOC</code></a>
<a name="do_vert_diffu_tlmi31"></a>    <a href="null_p.html#updatediffusion_modi29" target="origFile">avdiff(:, :, :) = <code class="constant">0.0d0</code></a>
<a name="do_vert_diffu_tlmi32"></a>    <a href="null_p.html#updatediffusion_modi30" target="origFile">bvdiff(:, :, :) = <code class="constant">0.0d0</code></a>
<a name="do_vert_diffu_tlmi33"></a>    <a href="null_p.html#updatediffusion_modi31" target="origFile">cvdiff(:, :, :) = <code class="constant">0.0d0</code></a>
<a name="do_vert_diffu_tlmi34"></a>    <a href="null_p.html#updatediffusion_modi32" target="origFile">vdiff(:, :, :) = <code class="constant">0.0d0</code></a>
<a name="do_vert_diffu_tlmi35"></a>    <a href="null_p.html#updatediffusion_modi33" target="origFile">bb(:, :, :) = <code class="constant">0.0d0</code></a>
<a name="do_vert_diffu_tlmi36"></a>    <a href="null_p.html#updatediffusion_modi34" target="origFile">cc(:, :, :) = <code class="constant">0.0d0</code></a>
    <a href="null_p.html#updatediffusion_modi35" target="origFile">rr(:, :, :) = <code class="constant">0.0d0</code></a>
<a href="null_p.html#updatediffusion_modi36" target="origFile"><code class="comment">! --------------------------------------------------------</code></a>
<a href="null_p.html#updatediffusion_modi36" target="origFile"><code class="comment">! If there was no kzz in the met file, it was set to &lt; 0.</code></a>
<a href="null_p.html#updatediffusion_modi36" target="origFile"><code class="comment">! In this case calculate a vertical diffusion coefficient,</code></a>
<a href="null_p.html#updatediffusion_modi36" target="origFile"><code class="comment">! otherwise use kzz.</code></a>
<a name="do_vert_diffu_tlmi37"></a><a href="null_p.html#updatediffusion_modi36" target="origFile"><code class="comment">! --------------------------------------------------------</code></a>
<a name="do_vert_diffu_tlmi38"></a>    <a href="null_p.html#updatediffusion_modi36" target="origFile">result1 = <code class="funcname">MAXVAL</code>(kzz)</a>
    <a href="null_p.html#updatediffusion_modi37" target="origFile"><code class="keyword">IF</code> (result1 .LT. <code class="constant">0.0d0</code>) <code class="keyword">THEN</code></a>
<a href="null_p.html#updatediffusion_modi38" target="origFile"><code class="comment">! ------------------------------------------------------</code></a>
<a href="null_p.html#updatediffusion_modi38" target="origFile"><code class="comment">! Set up the vertical diffusion coefficients.</code></a>
<a href="null_p.html#updatediffusion_modi38" target="origFile"><code class="comment">! First put height (m) into vdiff, then put simple</code></a>
<a href="null_p.html#updatediffusion_modi38" target="origFile"><code class="comment">! parameterization for diffusion coefficient into vdiff,</code></a>
<a href="null_p.html#updatediffusion_modi38" target="origFile"><code class="comment">! then put it into units of per mb</code></a>
<a name="do_vert_diffu_tlmi48"></a><a href="null_p.html#updatediffusion_modi38" target="origFile"><code class="comment">! ------------------------------------------------------</code></a>
<a name="do_vert_diffu_tlmi39"></a>      <a href="null_p.html#updatediffusion_modi38" target="origFile">vdiff = <code class="constant">0.0d0</code></a>
<a name="do_vert_diffu_tlmi40"></a>      <a href="null_p.html#updatediffusion_modi48" target="origFile"><code class="keyword">DO </code>ik=<code class="constant">1</code>,<code class="constant">10</code></a>
        <a href="null_p.html#updatediffusion_modi39" target="origFile">arg1(:, :) = press3e(i1:i2, ju1:j2, ik)/psf(i1:i2, ju1:j2)</a>
<a name="do_vert_diffu_tlmi43"></a>        <a href="null_p.html#updatediffusion_modi40" target="origFile">vdiff(:, :, ik) = -(hzero*<code class="funcname">LOG</code>(arg1(:, :)))</a>
        <a href="null_p.html#updatediffusion_modi48" target="origFile"><code class="keyword">WHERE </code>(vdiff(:, :, ik) - pbl(:, :)*<code class="constant">0.5d0 </code>.GE. <code class="constant">0.0</code>) </a>
<a name="do_vert_diffu_tlmi44"></a>          <a href="null_p.html#updatediffusion_modi43" target="origFile">abs0 = vdiff(:, :, ik) - pbl(:, :)*<code class="constant">0.5d0</code></a>
        <a href="null_p.html#updatediffusion_modi48" target="origFile"><code class="keyword">ELSEWHERE</code></a>
          <a href="null_p.html#updatediffusion_modi44" target="origFile">abs0 = -(vdiff(:, :, ik)-pbl(:, :)*<code class="constant">0.5d0</code>)</a>
<a name="do_vert_diffu_tlmi45"></a>        <a href="null_p.html#updatediffusion_modi48" target="origFile"><code class="keyword">END WHERE</code></a>
        <a href="null_p.html#updatediffusion_modi48" target="origFile"><code class="keyword">WHERE </code>(vdiff(:, :, ik) .LT. pbl(:, :)) </a>
          <a href="null_p.html#updatediffusion_modi45" target="origFile">vdiff(:, :, ik) = vert_diffu_coef*(<code class="constant">1.0d0</code>-<code class="constant">2.0d0</code>*(abs0/pbl(:, :)<code class="label">&</code></a>
<a name="do_vert_diffu_tlmi46"></a><a href="null_p.html#updatediffusion_modi45" target="origFile"><code class="label">&           </code>))</a>
        <a href="null_p.html#updatediffusion_modi48" target="origFile"><code class="keyword">ELSEWHERE</code></a>
<a name="do_vert_diffu_tlmi47"></a>          <a href="null_p.html#updatediffusion_modi46" target="origFile">vdiff(:, :, ik) = <code class="constant">0.0d0</code></a>
        <a href="null_p.html#updatediffusion_modi48" target="origFile"><code class="keyword">END WHERE</code></a>
        <a href="null_p.html#updatediffusion_modi47" target="origFile">vdiff(:, :, ik) = vdiff(:, :, ik)/hzero2*(press3e(i1:i2, ju1:j2<code class="label">&</code></a>
<a href="null_p.html#updatediffusion_modi47" target="origFile"><code class="label">&         </code>, ik)*press3e(i1:i2, ju1:j2, ik))/(press3c(i1:i2, ju1:j2, ik)-<code class="label">&</code></a>
<a href="null_p.html#updatediffusion_modi47" target="origFile"><code class="label">&         </code>press3c(i1:i2, ju1:j2, ik+<code class="constant">1</code>))</a>
<a name="do_vert_diffu_tlmi49"></a>      <a href="null_p.html#updatediffusion_modi48" target="origFile"><code class="keyword">END DO</code></a>
    <a href="null_p.html#updatediffusion_modi37" target="origFile"><code class="keyword">ELSE</code></a>
      <a href="null_p.html#updatediffusion_modi49" target="origFile">vdiff(:, :, k1:k2-<code class="constant">1</code>) = kzz(:, :, k1:k2-<code class="constant">1</code>)/hzero2*(press3e(i1:i2, <code class="label">&</code></a>
<a href="null_p.html#updatediffusion_modi49" target="origFile"><code class="label">&       </code>ju1:j2, k1:k2-<code class="constant">1</code>)*press3e(i1:i2, ju1:j2, k1:k2-<code class="constant">1</code>))/(press3c(i1:i2<code class="label">&</code></a>
<a name="do_vert_diffu_tlmi50"></a><a href="null_p.html#updatediffusion_modi49" target="origFile"><code class="label">&       </code>, ju1:j2, k1:k2-<code class="constant">1</code>)-press3c(i1:i2, ju1:j2, k1+<code class="constant">1</code>:k2))</a>
    <a href="null_p.html#updatediffusion_modi37" target="origFile"><code class="keyword">END IF</code></a>
<a href="null_p.html#updatediffusion_modi50" target="origFile"><code class="comment">! -----------------------------------------------------------</code></a>
<a href="null_p.html#updatediffusion_modi50" target="origFile"><code class="comment">! Construct the tri-diagonal matrix which will be used in the</code></a>
<a href="null_p.html#updatediffusion_modi50" target="origFile"><code class="comment">! implicit vertical diffusion solution.</code></a>
<a href="null_p.html#updatediffusion_modi50" target="origFile"><code class="comment">!   avdiff is the lower band</code></a>
<a href="null_p.html#updatediffusion_modi50" target="origFile"><code class="comment">!   bvdiff is the main diagonal</code></a>
<a href="null_p.html#updatediffusion_modi50" target="origFile"><code class="comment">!   cvdiff is the upper band</code></a>
<a href="null_p.html#updatediffusion_modi50" target="origFile"><code class="comment">! -----------------------------------------------------------</code></a>
<a href="null_p.html#updatediffusion_modi50" target="origFile"><code class="comment">! -----------------------</code></a>
<a href="null_p.html#updatediffusion_modi50" target="origFile"><code class="comment">! First do the top layer.</code></a>
<a name="do_vert_diffu_tlmi51"></a><a href="null_p.html#updatediffusion_modi50" target="origFile"><code class="comment">! -----------------------</code></a>
<a name="do_vert_diffu_tlmi52"></a>    <a href="null_p.html#updatediffusion_modi50" target="origFile">avdiff(:, :, k2-<code class="constant">1</code>) = <code class="constant">0.0d0</code></a>
<a name="do_vert_diffu_tlmi53"></a>    <a href="null_p.html#updatediffusion_modi51" target="origFile">bvdiff(:, :, k2-<code class="constant">1</code>) = vdiff(:, :, k2-<code class="constant">2</code>)</a>
    <a href="null_p.html#updatediffusion_modi52" target="origFile">cvdiff(:, :, k2-<code class="constant">1</code>) = -vdiff(:, :, k2-<code class="constant">2</code>)</a>
<a href="null_p.html#updatediffusion_modi53" target="origFile"><code class="comment">! ----------------------</code></a>
<a href="null_p.html#updatediffusion_modi53" target="origFile"><code class="comment">! Now do all the layers.</code></a>
<a name="do_vert_diffu_tlmi54"></a><a href="null_p.html#updatediffusion_modi53" target="origFile"><code class="comment">! ----------------------</code></a>
    <a href="null_p.html#updatediffusion_modi53" target="origFile">avdiff(:, :, k1+<code class="constant">1</code>:k2-<code class="constant">2</code>) = -vdiff(:, :, k1+<code class="constant">1</code>:k2-<code class="constant">2</code>)</a>
<a name="do_vert_diffu_tlmi55"></a>    <a href="null_p.html#updatediffusion_modi54" target="origFile">bvdiff(:, :, k1+<code class="constant">1</code>:k2-<code class="constant">2</code>) = vdiff(:, :, k1+<code class="constant">1</code>:k2-<code class="constant">2</code>) + vdiff(:, :, k1:k2<code class="label">&</code></a>
<a name="do_vert_diffu_tlmi56"></a><a href="null_p.html#updatediffusion_modi54" target="origFile"><code class="label">&     </code>-<code class="constant">3</code>)</a>
    <a href="null_p.html#updatediffusion_modi55" target="origFile">cvdiff(:, :, k1+<code class="constant">1</code>:k2-<code class="constant">2</code>) = -vdiff(:, :, k1:k2-<code class="constant">3</code>)</a>
<a href="null_p.html#updatediffusion_modi56" target="origFile"><code class="comment">! ------------------------------------</code></a>
<a href="null_p.html#updatediffusion_modi56" target="origFile"><code class="comment">! Now do the layer next to the ground.</code></a>
<a name="do_vert_diffu_tlmi57"></a><a href="null_p.html#updatediffusion_modi56" target="origFile"><code class="comment">! ------------------------------------</code></a>
<a name="do_vert_diffu_tlmi58"></a>    <a href="null_p.html#updatediffusion_modi56" target="origFile">avdiff(:, :, k1) = -vdiff(:, :, k1)</a>
<a name="do_vert_diffu_tlmi59"></a>    <a href="null_p.html#updatediffusion_modi57" target="origFile">bvdiff(:, :, k1) = vdiff(:, :, k1)</a>
    <a href="null_p.html#updatediffusion_modi58" target="origFile">cvdiff(:, :, k1) = <code class="constant">0.0d0</code></a>
<a href="null_p.html#updatediffusion_modi59" target="origFile"><code class="comment">! ---------------------------------------------------</code></a>
<a href="null_p.html#updatediffusion_modi59" target="origFile"><code class="comment">! Now convert them to the proper dimensionless units.</code></a>
<a name="do_vert_diffu_tlmi60"></a><a href="null_p.html#updatediffusion_modi59" target="origFile"><code class="comment">! ---------------------------------------------------</code></a>
    <a href="null_p.html#updatediffusion_modi59" target="origFile"><code class="keyword">IF</code> (<code class="funcname">TRIM</code>(mettype) .EQ. <code class="string">'MERRA2' </code>.OR. <code class="funcname">TRIM</code>(mettype) .EQ. <code class="string">'FPIT'</code>) <code class="keyword">THEN</code></a>
      <a href="null_p.html#updatediffusion_modi60" target="origFile">avdiff(i1:i2, ju1:j2, k1:k2-<code class="constant">1</code>) = avdiff(i1:i2, ju1:j2, k1:k2-<code class="constant">1</code>)*<code class="label">&</code></a>
<a name="do_vert_diffu_tlmi61"></a><a href="null_p.html#updatediffusion_modi60" target="origFile"><code class="label">&       </code>tdt/(press3e(i1:i2, ju1:j2, k1:k2-<code class="constant">1</code>)-press3e(i1:i2, ju1:j2, k1+<code class="constant">1</code><code class="label">&</code></a>
<a href="null_p.html#updatediffusion_modi60" target="origFile"><code class="label">&       </code>:k2))</a>
      <a href="null_p.html#updatediffusion_modi61" target="origFile">bvdiff(i1:i2, ju1:j2, k1:k2-<code class="constant">1</code>) = bvdiff(i1:i2, ju1:j2, k1:k2-<code class="constant">1</code>)*<code class="label">&</code></a>
<a name="do_vert_diffu_tlmi62"></a><a href="null_p.html#updatediffusion_modi61" target="origFile"><code class="label">&       </code>tdt/(press3e(i1:i2, ju1:j2, k1:k2-<code class="constant">1</code>)-press3e(i1:i2, ju1:j2, k1+<code class="constant">1</code><code class="label">&</code></a>
<a href="null_p.html#updatediffusion_modi61" target="origFile"><code class="label">&       </code>:k2)) + <code class="constant">1.0d0</code></a>
      <a href="null_p.html#updatediffusion_modi62" target="origFile">cvdiff(i1:i2, ju1:j2, k1:k2-<code class="constant">1</code>) = cvdiff(i1:i2, ju1:j2, k1:k2-<code class="constant">1</code>)*<code class="label">&</code></a>
<a href="null_p.html#updatediffusion_modi62" target="origFile"><code class="label">&       </code>tdt/(press3e(i1:i2, ju1:j2, k1:k2-<code class="constant">1</code>)-press3e(i1:i2, ju1:j2, k1+<code class="constant">1</code><code class="label">&</code></a>
<a name="do_vert_diffu_tlmi63"></a><a href="null_p.html#updatediffusion_modi62" target="origFile"><code class="label">&       </code>:k2))</a>
<a name="do_vert_diffu_tlmi64"></a>      <a href="null_p.html#updatediffusion_modi59" target="origFile">rr_tl = <code class="constant">0.0_8</code></a>
    <a href="null_p.html#updatediffusion_modi59" target="origFile"><code class="keyword">ELSE </code></a><a href="null_p.html#updatediffusion_modi63" target="origFile"><code class="keyword">IF</code> (<code class="funcname">TRIM</code>(mettype) .EQ. <code class="string">'MERRA1'</code>) <code class="keyword">THEN</code></a>
      <a href="null_p.html#updatediffusion_modi64" target="origFile">avdiff(i1:i2, ju1:j2, k1:k2-<code class="constant">1</code>) = avdiff(i1:i2, ju1:j2, k1:k2-<code class="constant">1</code>)*<code class="label">&</code></a>
<a name="do_vert_diffu_tlmi65"></a><a href="null_p.html#updatediffusion_modi64" target="origFile"><code class="label">&       </code>tdt/(press3e(i1:i2, ju1:j2, k1-<code class="constant">1</code>:k2-<code class="constant">2</code>)-press3e(i1:i2, ju1:j2, k1<code class="label">&</code></a>
<a href="null_p.html#updatediffusion_modi64" target="origFile"><code class="label">&       </code>:k2-<code class="constant">1</code>))</a>
      <a href="null_p.html#updatediffusion_modi65" target="origFile">bvdiff(i1:i2, ju1:j2, k1:k2-<code class="constant">1</code>) = bvdiff(i1:i2, ju1:j2, k1:k2-<code class="constant">1</code>)*<code class="label">&</code></a>
<a name="do_vert_diffu_tlmi66"></a><a href="null_p.html#updatediffusion_modi65" target="origFile"><code class="label">&       </code>tdt/(press3e(i1:i2, ju1:j2, k1-<code class="constant">1</code>:k2-<code class="constant">2</code>)-press3e(i1:i2, ju1:j2, k1<code class="label">&</code></a>
<a href="null_p.html#updatediffusion_modi65" target="origFile"><code class="label">&       </code>:k2-<code class="constant">1</code>)) + <code class="constant">1.0d0</code></a>
      <a href="null_p.html#updatediffusion_modi66" target="origFile">cvdiff(i1:i2, ju1:j2, k1:k2-<code class="constant">1</code>) = cvdiff(i1:i2, ju1:j2, k1:k2-<code class="constant">1</code>)*<code class="label">&</code></a>
<a href="null_p.html#updatediffusion_modi66" target="origFile"><code class="label">&       </code>tdt/(press3e(i1:i2, ju1:j2, k1-<code class="constant">1</code>:k2-<code class="constant">2</code>)-press3e(i1:i2, ju1:j2, k1<code class="label">&</code></a>
<a href="null_p.html#updatediffusion_modi66" target="origFile"><code class="label">&       </code>:k2-<code class="constant">1</code>))</a>
      <a href="null_p.html#updatediffusion_modi63" target="origFile">rr_tl = <code class="constant">0.0_8</code></a>
    <a href="null_p.html#updatediffusion_modi63" target="origFile"><code class="keyword">ELSE</code></a>
<a name="do_vert_diffu_tlmi78"></a>      <a href="null_p.html#updatediffusion_modi63" target="origFile">rr_tl = <code class="constant">0.0_8</code></a>
    <a href="null_p.html#updatediffusion_modi59" target="origFile"><code class="keyword">END IF</code></a>
<a href="null_p.html#updatediffusion_modi78" target="origFile"><code class="comment">! ---------------------</code></a>
<a href="null_p.html#updatediffusion_modi78" target="origFile"><code class="comment">! Now solve the system.</code></a>
<a name="do_vert_diffu_tlmi67"></a><a href="null_p.html#updatediffusion_modi78" target="origFile"><code class="comment">! ---------------------</code></a>
<a href="null_p.html#updatediffusion_modi78" target="origFile"><code class="label">icloop:</code><code class="keyword">DO </code>ic=<code class="constant">1</code>,numspecies</a>
<a name="do_vert_diffu_tlmi68"></a><a href="null_p.html#updatediffusion_modi67" target="origFile"><code class="comment">!   ======================================</code></a>
      <a href="null_p.html#updatediffusion_modi67" target="origFile"><code class="keyword">IF</code> (.NOT.isfixedconcentration(ic)) <code class="keyword">THEN</code></a>
<a href="null_p.html#updatediffusion_modi68" target="origFile"><code class="comment">!   ======================================</code></a>
<a href="null_p.html#updatediffusion_modi68" target="origFile"><code class="comment">! -----------------------------------------</code></a>
<a href="null_p.html#updatediffusion_modi68" target="origFile"><code class="comment">! Set up the right hand side of the system.</code></a>
<a name="do_vert_diffu_tlmi69"></a><a href="null_p.html#updatediffusion_modi68" target="origFile"><code class="comment">! -----------------------------------------</code></a>
<a name="do_vert_diffu_tlmi69"></a>        <a href="null_p.html#updatediffusion_modi68" target="origFile">bb(:, :, k2-<code class="constant">1</code>) = bvdiff(:, :, k2-<code class="constant">1</code>)</a>
<a name="do_vert_diffu_tlmi74"></a>        <a href="null_p.html#updatediffusion_modi69" target="origFile">rr_tl(:, :, k2-<code class="constant">1</code>) = concentration_tl(ic)%parray3d(:, :, k2-<code class="constant">1</code>)</a>
        <a href="null_p.html#updatediffusion_modi69" target="origFile">rr(:, :, k2-<code class="constant">1</code>) = concentration(ic)%parray3d(:, :, k2-<code class="constant">1</code>)</a>
<a href="null_p.html#updatediffusion_modi74" target="origFile"><code class="comment">! ---------------------------------</code></a>
<a href="null_p.html#updatediffusion_modi74" target="origFile"><code class="comment">! Eliminate the lower diagonal (a).</code></a>
<a name="do_vert_diffu_tlmi70"></a><a href="null_p.html#updatediffusion_modi74" target="origFile"><code class="comment">! ---------------------------------</code></a>
<a name="do_vert_diffu_tlmi71"></a>        <a href="null_p.html#updatediffusion_modi74" target="origFile"><code class="keyword">DO </code>ik=k2-<code class="constant">1</code>,k1+<code class="constant">1</code>,-<code class="constant">1</code></a>
<a name="do_vert_diffu_tlmi71"></a>          <a href="null_p.html#updatediffusion_modi70" target="origFile">cc(:, :, ik) = cvdiff(:, :, ik)/bb(:, :, ik)</a>
<a name="do_vert_diffu_tlmi72"></a>          <a href="null_p.html#updatediffusion_modi71" target="origFile">rr_tl(:, :, ik) = rr_tl(:, :, ik)/bb(:, :, ik)</a>
          <a href="null_p.html#updatediffusion_modi71" target="origFile">rr(:, :, ik) = rr(:, :, ik)/bb(:, :, ik)</a>
<a name="do_vert_diffu_tlmi73"></a>          <a href="null_p.html#updatediffusion_modi72" target="origFile">bb(:, :, ik-<code class="constant">1</code>) = bvdiff(:, :, ik-<code class="constant">1</code>) - avdiff(:, :, ik-<code class="constant">1</code>)*cc(:<code class="label">&</code></a>
<a href="null_p.html#updatediffusion_modi72" target="origFile"><code class="label">&           </code>, :, ik)</a>
<a name="do_vert_diffu_tlmi73"></a>          <a href="null_p.html#updatediffusion_modi73" target="origFile">rr_tl(:, :, ik-<code class="constant">1</code>) = concentration_tl(ic)%parray3d(:, :, ik-<code class="constant">1</code>) <code class="label">&</code></a>
<a href="null_p.html#updatediffusion_modi73" target="origFile"><code class="label">&           </code>- avdiff(:, :, ik-<code class="constant">1</code>)*rr_tl(:, :, ik)</a>
          <a href="null_p.html#updatediffusion_modi73" target="origFile">rr(:, :, ik-<code class="constant">1</code>) = concentration(ic)%parray3d(:, :, ik-<code class="constant">1</code>) - <code class="label">&</code></a>
<a name="do_vert_diffu_tlmi75"></a><a href="null_p.html#updatediffusion_modi73" target="origFile"><code class="label">&           </code>avdiff(:, :, ik-<code class="constant">1</code>)*rr(:, :, ik)</a>
        <a href="null_p.html#updatediffusion_modi74" target="origFile"><code class="keyword">END DO</code></a>
<a href="null_p.html#updatediffusion_modi75" target="origFile"><code class="comment">! -------------------------------</code></a>
<a href="null_p.html#updatediffusion_modi75" target="origFile"><code class="comment">! Solve for the new mixing ratio.</code></a>
<a href="null_p.html#updatediffusion_modi75" target="origFile"><code class="comment">! -------------------------------</code></a>
<a name="do_vert_diffu_tlmi75"></a>        <a href="null_p.html#updatediffusion_modi75" target="origFile">concentration_tl(ic)%parray3d(:, :, k1) = rr_tl(:, :, k1)/bb(:, <code class="label">&</code></a>
<a name="do_vert_diffu_tlmi77"></a><a href="null_p.html#updatediffusion_modi75" target="origFile"><code class="label">&         </code>:, k1)</a>
<a name="do_vert_diffu_tlmi76"></a>        <a href="null_p.html#updatediffusion_modi75" target="origFile">concentration(ic)%parray3d(:, :, k1) = rr(:, :, k1)/bb(:, :, k1)</a>
        <a href="null_p.html#updatediffusion_modi77" target="origFile"><code class="keyword">DO </code>ik=k1+<code class="constant">1</code>,k2-<code class="constant">1</code></a>
<a name="do_vert_diffu_tlmi76"></a>          <a href="null_p.html#updatediffusion_modi76" target="origFile">concentration_tl(ic)%parray3d(:, :, ik) = rr_tl(:, :, ik) - cc<code class="label">&</code></a>
<a href="null_p.html#updatediffusion_modi76" target="origFile"><code class="label">&           </code>(:, :, ik)*concentration_tl(ic)%parray3d(:, :, ik-<code class="constant">1</code>)</a>
          <a href="null_p.html#updatediffusion_modi76" target="origFile">concentration(ic)%parray3d(:, :, ik) = rr(:, :, ik) - <code class="label">&</code></a>
<a href="null_p.html#updatediffusion_modi76" target="origFile"><code class="label">&           </code>concentration(ic)%parray3d(:, :, ik-<code class="constant">1</code>)*cc(:, :, ik)</a>
        <a href="null_p.html#updatediffusion_modi77" target="origFile"><code class="keyword">END DO</code></a>
<a name="do_vert_diffu_tlmi79"></a>      <a href="null_p.html#updatediffusion_modi67" target="origFile"><code class="keyword">END IF</code></a>
    <a href="null_p.html#updatediffusion_modi78" target="origFile"><code class="keyword">END DO </code><code class="label">icloop</code></a>
<a name="do_vert_diffu"></a>    <a href="null_p.html#updatediffusion_modi79" target="origFile"><code class="keyword">RETURN</code></a>
  <a href="null_p.html#updatediffusion_mod" target="origFile"><code class="keyword">END SUBROUTINE </code><code class="funcname">DO_VERT_DIFFU_TLM</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">!EOP</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">!------------------------------------------------------------------------------</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">!BOC</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">!</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">! !IROUTINE: Do_Vert_Diffu</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">!</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">! !INTERFACE:</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">!</code></a>
  <a href="null_p.html#updatediffusion_mod" target="origFile"><code class="keyword">SUBROUTINE </code><code class="funcname">DO_VERT_DIFFU</code>(<code class="vardecl">tdt</code>, <code class="vardecl">vert_diffu_coef</code>, <code class="vardecl">pbl</code>, <code class="vardecl">kzz</code>, <code class="vardecl">press3c</code>, <code class="label">&</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="label">&   </code><code class="vardecl">press3e</code>, <code class="vardecl">psf</code>, <code class="vardecl">concentration</code>, <code class="vardecl">isfixedconcentration</code>, <code class="vardecl">mettype</code>, <code class="vardecl">i1</code>, <code class="vardecl">i2</code>, <code class="label">&</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="label">&   </code><code class="vardecl">ju1</code>, <code class="vardecl">j2</code>, <code class="vardecl">k1</code>, <code class="vardecl">k2</code>, <code class="vardecl">ilo</code>, <code class="vardecl">ihi</code>, <code class="vardecl">julo</code>, <code class="vardecl">jhi</code>, <code class="vardecl">numspecies</code>)</a>
    <a href="null_p.html#updatediffusion_mod" target="origFile"><code class="keyword">IMPLICIT NONE</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">!</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">! !INPUT PARAMETERS:</code></a>
    <a href="null_p.html#updatediffusion_mod" target="origFile"><code class="typename">INTEGER</code>, <code class="typename">INTENT(IN) </code>:: <code class="vardecl">i1</code>, <code class="vardecl">i2</code>, <code class="vardecl">ju1</code>, <code class="vardecl">j2</code>, <code class="vardecl">k1</code>, <code class="vardecl">k2</code>, <code class="vardecl">ilo</code>, <code class="vardecl">ihi</code>, <code class="vardecl">julo</code>, <code class="vardecl">jhi</code></a>
    <a href="null_p.html#updatediffusion_mod" target="origFile"><code class="typename">INTEGER</code>, <code class="typename">INTENT(IN) </code>:: <code class="vardecl">numspecies</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">! model time step (s)</code></a>
    <a href="null_p.html#updatediffusion_mod" target="origFile"><code class="typename">REAL*8</code>, <code class="typename">INTENT(IN) </code>:: <code class="vardecl">tdt</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">! scalar vertical diffusion coefficient (m^2/s)</code></a>
    <a href="null_p.html#updatediffusion_mod" target="origFile"><code class="typename">REAL*8</code>, <code class="typename">INTENT(IN) </code>:: <code class="vardecl">vert_diffu_coef</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">! planetary boundary layer depth (m)</code></a>
    <a href="null_p.html#updatediffusion_mod" target="origFile"><code class="typename">REAL*8</code>, <code class="typename">INTENT(IN) </code>:: <code class="vardecl">pbl</code>(<code class="vardecl">i1</code>:<code class="vardecl">i2</code>, <code class="vardecl">ju1</code>:<code class="vardecl">j2</code>)</a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">! vertical diffusion coefficients (m^2/s)</code></a>
    <a href="null_p.html#updatediffusion_mod" target="origFile"><code class="typename">REAL*8</code>, <code class="typename">INTENT(IN) </code>:: <code class="vardecl">kzz</code>(<code class="vardecl">i1</code>:<code class="vardecl">i2</code>, <code class="vardecl">ju1</code>:<code class="vardecl">j2</code>, <code class="vardecl">k1</code>:<code class="vardecl">k2</code>)</a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">! atmospheric pressure at the center of each grid box (mb)</code></a>
    <a href="null_p.html#updatediffusion_mod" target="origFile"><code class="typename">REAL*8</code>, <code class="typename">INTENT(IN) </code>:: <code class="vardecl">press3c</code>(<code class="vardecl">ilo</code>:<code class="vardecl">ihi</code>, <code class="vardecl">julo</code>:<code class="vardecl">jhi</code>, <code class="vardecl">k1</code>:<code class="vardecl">k2</code>)</a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">! atmospheric pressure at the edge   of each grid box (mb)</code></a>
    <a href="null_p.html#updatediffusion_mod" target="origFile"><code class="typename">REAL*8</code>, <code class="typename">INTENT(IN) </code>:: <code class="vardecl">press3e</code>(<code class="vardecl">ilo</code>:<code class="vardecl">ihi</code>, <code class="vardecl">julo</code>:<code class="vardecl">jhi</code>, <code class="vardecl">k1</code>-<code class="constant">1</code>:<code class="vardecl">k2</code>)</a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">! surface pressure field known at zone centers (mb)</code></a>
    <a href="null_p.html#updatediffusion_mod" target="origFile"><code class="typename">REAL*8</code>, <code class="typename">INTENT(IN) </code>:: <code class="vardecl">psf</code>(<code class="vardecl">ilo</code>:<code class="vardecl">ihi</code>, <code class="vardecl">julo</code>:<code class="vardecl">jhi</code>)</a>
    <a href="null_p.html#updatediffusion_mod" target="origFile"><code class="typename">LOGICAL</code>, <code class="typename">INTENT(IN) </code>:: <code class="vardecl">isfixedconcentration</code>(<code class="vardecl">numspecies</code>)</a>
    <a href="null_p.html#updatediffusion_mod" target="origFile"><code class="typename">CHARACTER</code>(<code class="keyword">len</code>=esmf_maxstr), <code class="typename">INTENT(IN) </code>:: <code class="vardecl">mettype</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">!</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">! !INPUT/OUTPUT PARAMETERS:</code></a>
    <a href="null_p.html#updatediffusion_mod" target="origFile"><code class="typename">TYPE(T_GMIARRAYBUNDLE)</code>, <code class="typename">INTENT(INOUT) </code>:: <code class="vardecl">concentration</code>(<code class="vardecl">numspecies</code>)</a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">!</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">! !DECLARED VARIABLES:</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">! atmospheric scale height (m)</code></a>
    <a href="null_p.html#updatediffusion_mod" target="origFile"><code class="typename">REAL*8</code>, <code class="typename">PARAMETER </code>:: <code class="vardecl">hzero</code>=<code class="constant">8000.0d0</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">! (m^2)</code></a>
    <a href="null_p.html#updatediffusion_mod" target="origFile"><code class="typename">REAL*8</code>, <code class="typename">PARAMETER </code>:: <code class="vardecl">hzero2</code>=<code class="vardecl">hzero</code>*<code class="vardecl">hzero</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">!</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">! !DESCRIPTION:</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">!   Calculates vertical diffusion using an implicit technique.</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">!   Note: Constituent mass is conserved during mixing.</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">!          Constant field should remain constant.</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">!</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">! !LOCAL VARIABLES:</code></a>
    <a href="null_p.html#updatediffusion_mod" target="origFile"><code class="typename">INTEGER </code>:: <code class="vardecl">ik</code>, <code class="vardecl">ic</code></a>
    <a href="null_p.html#updatediffusion_mod" target="origFile"><code class="typename">REAL*8 </code>:: <code class="vardecl">avdiff</code>(<code class="vardecl">i1</code>:<code class="vardecl">i2</code>, <code class="vardecl">ju1</code>:<code class="vardecl">j2</code>, <code class="vardecl">k1</code>:<code class="vardecl">k2</code>-<code class="constant">1</code>)</a>
    <a href="null_p.html#updatediffusion_mod" target="origFile"><code class="typename">REAL*8 </code>:: <code class="vardecl">bvdiff</code>(<code class="vardecl">i1</code>:<code class="vardecl">i2</code>, <code class="vardecl">ju1</code>:<code class="vardecl">j2</code>, <code class="vardecl">k1</code>:<code class="vardecl">k2</code>-<code class="constant">1</code>)</a>
    <a href="null_p.html#updatediffusion_mod" target="origFile"><code class="typename">REAL*8 </code>:: <code class="vardecl">cvdiff</code>(<code class="vardecl">i1</code>:<code class="vardecl">i2</code>, <code class="vardecl">ju1</code>:<code class="vardecl">j2</code>, <code class="vardecl">k1</code>:<code class="vardecl">k2</code>-<code class="constant">1</code>)</a>
    <a href="null_p.html#updatediffusion_mod" target="origFile"><code class="typename">REAL*8 </code>:: <code class="vardecl">vdiff</code>(<code class="vardecl">i1</code>:<code class="vardecl">i2</code>, <code class="vardecl">ju1</code>:<code class="vardecl">j2</code>, <code class="vardecl">k1</code>:<code class="vardecl">k2</code>-<code class="constant">1</code>)</a>
    <a href="null_p.html#updatediffusion_mod" target="origFile"><code class="typename">REAL*8 </code>:: <code class="vardecl">bb</code>(<code class="vardecl">i1</code>:<code class="vardecl">i2</code>, <code class="vardecl">ju1</code>:<code class="vardecl">j2</code>, <code class="vardecl">k1</code>:<code class="vardecl">k2</code>-<code class="constant">1</code>)</a>
    <a href="null_p.html#updatediffusion_mod" target="origFile"><code class="typename">REAL*8 </code>:: <code class="vardecl">cc</code>(<code class="vardecl">i1</code>:<code class="vardecl">i2</code>, <code class="vardecl">ju1</code>:<code class="vardecl">j2</code>, <code class="vardecl">k1</code>:<code class="vardecl">k2</code>-<code class="constant">1</code>)</a>
    <a href="null_p.html#updatediffusion_mod" target="origFile"><code class="typename">REAL*8 </code>:: <code class="vardecl">rr</code>(<code class="vardecl">i1</code>:<code class="vardecl">i2</code>, <code class="vardecl">ju1</code>:<code class="vardecl">j2</code>, <code class="vardecl">k1</code>:<code class="vardecl">k2</code>-<code class="constant">1</code>)</a>
    <a href="null_p.html#updatediffusion_mod" target="origFile"><code class="keyword">INTRINSIC </code><code class="funcname">MAXVAL</code></a>
    <a href="null_p.html#updatediffusion_mod" target="origFile"><code class="keyword">INTRINSIC </code><code class="funcname">LOG</code></a>
    <a href="null_p.html#updatediffusion_mod" target="origFile"><code class="keyword">INTRINSIC </code><code class="funcname">ABS</code></a>
    <a href="null_p.html#updatediffusion_mod" target="origFile"><code class="keyword">INTRINSIC </code><code class="funcname">TRIM</code></a>
    <a href="null_p.html#updatediffusion_mod" target="origFile"><code class="typename">REAL*8</code>, DIMENSION(i1:i2, ju1:j2) :: <code class="vardecl">abs0</code></a>
    <a href="null_p.html#updatediffusion_mod" target="origFile"><code class="typename">REAL*8 </code>:: <code class="vardecl">result1</code></a>
    <a href="null_p.html#updatediffusion_mod" target="origFile"><code class="typename">REAL*8</code>, DIMENSION(i2-i1+<code class="constant">1</code>, j2-ju1+<code class="constant">1</code>) :: <code class="vardecl">arg1</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">!</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">!EOP</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">!------------------------------------------------------------------------------</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">!BOC</code></a>
    <a href="null_p.html#updatediffusion_mod" target="origFile">avdiff(:, :, :) = <code class="constant">0.0d0</code></a>
    <a href="null_p.html#updatediffusion_mod" target="origFile">bvdiff(:, :, :) = <code class="constant">0.0d0</code></a>
    <a href="null_p.html#updatediffusion_mod" target="origFile">cvdiff(:, :, :) = <code class="constant">0.0d0</code></a>
    <a href="null_p.html#updatediffusion_mod" target="origFile">vdiff(:, :, :) = <code class="constant">0.0d0</code></a>
    <a href="null_p.html#updatediffusion_mod" target="origFile">bb(:, :, :) = <code class="constant">0.0d0</code></a>
    <a href="null_p.html#updatediffusion_mod" target="origFile">cc(:, :, :) = <code class="constant">0.0d0</code></a>
    <a href="null_p.html#updatediffusion_mod" target="origFile">rr(:, :, :) = <code class="constant">0.0d0</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">! --------------------------------------------------------</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">! If there was no kzz in the met file, it was set to &lt; 0.</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">! In this case calculate a vertical diffusion coefficient,</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">! otherwise use kzz.</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">! --------------------------------------------------------</code></a>
    <a href="null_p.html#updatediffusion_mod" target="origFile">result1 = <code class="funcname">MAXVAL</code>(kzz)</a>
    <a href="null_p.html#updatediffusion_mod" target="origFile"><code class="keyword">IF</code> (result1 .LT. <code class="constant">0.0d0</code>) <code class="keyword">THEN</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">! ------------------------------------------------------</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">! Set up the vertical diffusion coefficients.</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">! First put height (m) into vdiff, then put simple</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">! parameterization for diffusion coefficient into vdiff,</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">! then put it into units of per mb</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">! ------------------------------------------------------</code></a>
      <a href="null_p.html#updatediffusion_mod" target="origFile">vdiff = <code class="constant">0.0d0</code></a>
      <a href="null_p.html#updatediffusion_mod" target="origFile"><code class="keyword">DO </code>ik=<code class="constant">1</code>,<code class="constant">10</code></a>
        <a href="null_p.html#updatediffusion_mod" target="origFile">arg1(:, :) = press3e(i1:i2, ju1:j2, ik)/psf(i1:i2, ju1:j2)</a>
        <a href="null_p.html#updatediffusion_mod" target="origFile">vdiff(:, :, ik) = -(hzero*<code class="funcname">LOG</code>(arg1(:, :)))</a>
        <a href="null_p.html#updatediffusion_mod" target="origFile"><code class="keyword">WHERE </code>(vdiff(:, :, ik) - pbl(:, :)*<code class="constant">0.5d0 </code>.GE. <code class="constant">0.0</code>) </a>
          <a href="null_p.html#updatediffusion_mod" target="origFile">abs0 = vdiff(:, :, ik) - pbl(:, :)*<code class="constant">0.5d0</code></a>
        <a href="null_p.html#updatediffusion_mod" target="origFile"><code class="keyword">ELSEWHERE</code></a>
          <a href="null_p.html#updatediffusion_mod" target="origFile">abs0 = -(vdiff(:, :, ik)-pbl(:, :)*<code class="constant">0.5d0</code>)</a>
        <a href="null_p.html#updatediffusion_mod" target="origFile"><code class="keyword">END WHERE</code></a>
        <a href="null_p.html#updatediffusion_mod" target="origFile"><code class="keyword">WHERE </code>(vdiff(:, :, ik) .LT. pbl(:, :)) </a>
          <a href="null_p.html#updatediffusion_mod" target="origFile">vdiff(:, :, ik) = vert_diffu_coef*(<code class="constant">1.0d0</code>-<code class="constant">2.0d0</code>*(abs0/pbl(:, :)<code class="label">&</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="label">&           </code>))</a>
        <a href="null_p.html#updatediffusion_mod" target="origFile"><code class="keyword">ELSEWHERE</code></a>
          <a href="null_p.html#updatediffusion_mod" target="origFile">vdiff(:, :, ik) = <code class="constant">0.0d0</code></a>
        <a href="null_p.html#updatediffusion_mod" target="origFile"><code class="keyword">END WHERE</code></a>
        <a href="null_p.html#updatediffusion_mod" target="origFile">vdiff(:, :, ik) = vdiff(:, :, ik)/hzero2*(press3e(i1:i2, ju1:j2<code class="label">&</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="label">&         </code>, ik)*press3e(i1:i2, ju1:j2, ik))/(press3c(i1:i2, ju1:j2, ik)-<code class="label">&</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="label">&         </code>press3c(i1:i2, ju1:j2, ik+<code class="constant">1</code>))</a>
      <a href="null_p.html#updatediffusion_mod" target="origFile"><code class="keyword">END DO</code></a>
    <a href="null_p.html#updatediffusion_mod" target="origFile"><code class="keyword">ELSE</code></a>
      <a href="null_p.html#updatediffusion_mod" target="origFile">vdiff(:, :, k1:k2-<code class="constant">1</code>) = kzz(:, :, k1:k2-<code class="constant">1</code>)/hzero2*(press3e(i1:i2, <code class="label">&</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="label">&       </code>ju1:j2, k1:k2-<code class="constant">1</code>)*press3e(i1:i2, ju1:j2, k1:k2-<code class="constant">1</code>))/(press3c(i1:i2<code class="label">&</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="label">&       </code>, ju1:j2, k1:k2-<code class="constant">1</code>)-press3c(i1:i2, ju1:j2, k1+<code class="constant">1</code>:k2))</a>
    <a href="null_p.html#updatediffusion_mod" target="origFile"><code class="keyword">END IF</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">! -----------------------------------------------------------</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">! Construct the tri-diagonal matrix which will be used in the</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">! implicit vertical diffusion solution.</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">!   avdiff is the lower band</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">!   bvdiff is the main diagonal</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">!   cvdiff is the upper band</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">! -----------------------------------------------------------</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">! -----------------------</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">! First do the top layer.</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">! -----------------------</code></a>
    <a href="null_p.html#updatediffusion_mod" target="origFile">avdiff(:, :, k2-<code class="constant">1</code>) = <code class="constant">0.0d0</code></a>
    <a href="null_p.html#updatediffusion_mod" target="origFile">bvdiff(:, :, k2-<code class="constant">1</code>) = vdiff(:, :, k2-<code class="constant">2</code>)</a>
    <a href="null_p.html#updatediffusion_mod" target="origFile">cvdiff(:, :, k2-<code class="constant">1</code>) = -vdiff(:, :, k2-<code class="constant">2</code>)</a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">! ----------------------</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">! Now do all the layers.</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">! ----------------------</code></a>
    <a href="null_p.html#updatediffusion_mod" target="origFile">avdiff(:, :, k1+<code class="constant">1</code>:k2-<code class="constant">2</code>) = -vdiff(:, :, k1+<code class="constant">1</code>:k2-<code class="constant">2</code>)</a>
    <a href="null_p.html#updatediffusion_mod" target="origFile">bvdiff(:, :, k1+<code class="constant">1</code>:k2-<code class="constant">2</code>) = vdiff(:, :, k1+<code class="constant">1</code>:k2-<code class="constant">2</code>) + vdiff(:, :, k1:k2<code class="label">&</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="label">&     </code>-<code class="constant">3</code>)</a>
    <a href="null_p.html#updatediffusion_mod" target="origFile">cvdiff(:, :, k1+<code class="constant">1</code>:k2-<code class="constant">2</code>) = -vdiff(:, :, k1:k2-<code class="constant">3</code>)</a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">! ------------------------------------</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">! Now do the layer next to the ground.</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">! ------------------------------------</code></a>
    <a href="null_p.html#updatediffusion_mod" target="origFile">avdiff(:, :, k1) = -vdiff(:, :, k1)</a>
    <a href="null_p.html#updatediffusion_mod" target="origFile">bvdiff(:, :, k1) = vdiff(:, :, k1)</a>
    <a href="null_p.html#updatediffusion_mod" target="origFile">cvdiff(:, :, k1) = <code class="constant">0.0d0</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">! ---------------------------------------------------</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">! Now convert them to the proper dimensionless units.</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">! ---------------------------------------------------</code></a>
    <a href="null_p.html#updatediffusion_mod" target="origFile"><code class="keyword">IF</code> (<code class="funcname">TRIM</code>(mettype) .EQ. <code class="string">'MERRA2' </code>.OR. <code class="funcname">TRIM</code>(mettype) .EQ. <code class="string">'FPIT'</code>) <code class="keyword">THEN</code></a>
      <a href="null_p.html#updatediffusion_mod" target="origFile">avdiff(i1:i2, ju1:j2, k1:k2-<code class="constant">1</code>) = avdiff(i1:i2, ju1:j2, k1:k2-<code class="constant">1</code>)*<code class="label">&</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="label">&       </code>tdt/(press3e(i1:i2, ju1:j2, k1:k2-<code class="constant">1</code>)-press3e(i1:i2, ju1:j2, k1+<code class="constant">1</code><code class="label">&</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="label">&       </code>:k2))</a>
      <a href="null_p.html#updatediffusion_mod" target="origFile">bvdiff(i1:i2, ju1:j2, k1:k2-<code class="constant">1</code>) = bvdiff(i1:i2, ju1:j2, k1:k2-<code class="constant">1</code>)*<code class="label">&</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="label">&       </code>tdt/(press3e(i1:i2, ju1:j2, k1:k2-<code class="constant">1</code>)-press3e(i1:i2, ju1:j2, k1+<code class="constant">1</code><code class="label">&</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="label">&       </code>:k2)) + <code class="constant">1.0d0</code></a>
      <a href="null_p.html#updatediffusion_mod" target="origFile">cvdiff(i1:i2, ju1:j2, k1:k2-<code class="constant">1</code>) = cvdiff(i1:i2, ju1:j2, k1:k2-<code class="constant">1</code>)*<code class="label">&</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="label">&       </code>tdt/(press3e(i1:i2, ju1:j2, k1:k2-<code class="constant">1</code>)-press3e(i1:i2, ju1:j2, k1+<code class="constant">1</code><code class="label">&</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="label">&       </code>:k2))</a>
    <a href="null_p.html#updatediffusion_mod" target="origFile"><code class="keyword">ELSE IF</code> (<code class="funcname">TRIM</code>(mettype) .EQ. <code class="string">'MERRA1'</code>) <code class="keyword">THEN</code></a>
      <a href="null_p.html#updatediffusion_mod" target="origFile">avdiff(i1:i2, ju1:j2, k1:k2-<code class="constant">1</code>) = avdiff(i1:i2, ju1:j2, k1:k2-<code class="constant">1</code>)*<code class="label">&</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="label">&       </code>tdt/(press3e(i1:i2, ju1:j2, k1-<code class="constant">1</code>:k2-<code class="constant">2</code>)-press3e(i1:i2, ju1:j2, k1<code class="label">&</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="label">&       </code>:k2-<code class="constant">1</code>))</a>
      <a href="null_p.html#updatediffusion_mod" target="origFile">bvdiff(i1:i2, ju1:j2, k1:k2-<code class="constant">1</code>) = bvdiff(i1:i2, ju1:j2, k1:k2-<code class="constant">1</code>)*<code class="label">&</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="label">&       </code>tdt/(press3e(i1:i2, ju1:j2, k1-<code class="constant">1</code>:k2-<code class="constant">2</code>)-press3e(i1:i2, ju1:j2, k1<code class="label">&</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="label">&       </code>:k2-<code class="constant">1</code>)) + <code class="constant">1.0d0</code></a>
      <a href="null_p.html#updatediffusion_mod" target="origFile">cvdiff(i1:i2, ju1:j2, k1:k2-<code class="constant">1</code>) = cvdiff(i1:i2, ju1:j2, k1:k2-<code class="constant">1</code>)*<code class="label">&</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="label">&       </code>tdt/(press3e(i1:i2, ju1:j2, k1-<code class="constant">1</code>:k2-<code class="constant">2</code>)-press3e(i1:i2, ju1:j2, k1<code class="label">&</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="label">&       </code>:k2-<code class="constant">1</code>))</a>
    <a href="null_p.html#updatediffusion_mod" target="origFile"><code class="keyword">END IF</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">! ---------------------</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">! Now solve the system.</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">! ---------------------</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="label">icloop:</code><code class="keyword">DO </code>ic=<code class="constant">1</code>,numspecies</a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">!   ======================================</code></a>
      <a href="null_p.html#updatediffusion_mod" target="origFile"><code class="keyword">IF</code> (.NOT.isfixedconcentration(ic)) <code class="keyword">THEN</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">!   ======================================</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">! -----------------------------------------</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">! Set up the right hand side of the system.</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">! -----------------------------------------</code></a>
        <a href="null_p.html#updatediffusion_mod" target="origFile">bb(:, :, k2-<code class="constant">1</code>) = bvdiff(:, :, k2-<code class="constant">1</code>)</a>
        <a href="null_p.html#updatediffusion_mod" target="origFile">rr(:, :, k2-<code class="constant">1</code>) = concentration(ic)%parray3d(:, :, k2-<code class="constant">1</code>)</a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">! ---------------------------------</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">! Eliminate the lower diagonal (a).</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">! ---------------------------------</code></a>
        <a href="null_p.html#updatediffusion_mod" target="origFile"><code class="keyword">DO </code>ik=k2-<code class="constant">1</code>,k1+<code class="constant">1</code>,-<code class="constant">1</code></a>
          <a href="null_p.html#updatediffusion_mod" target="origFile">cc(:, :, ik) = cvdiff(:, :, ik)/bb(:, :, ik)</a>
          <a href="null_p.html#updatediffusion_mod" target="origFile">rr(:, :, ik) = rr(:, :, ik)/bb(:, :, ik)</a>
          <a href="null_p.html#updatediffusion_mod" target="origFile">bb(:, :, ik-<code class="constant">1</code>) = bvdiff(:, :, ik-<code class="constant">1</code>) - avdiff(:, :, ik-<code class="constant">1</code>)*cc(:<code class="label">&</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="label">&           </code>, :, ik)</a>
          <a href="null_p.html#updatediffusion_mod" target="origFile">rr(:, :, ik-<code class="constant">1</code>) = concentration(ic)%parray3d(:, :, ik-<code class="constant">1</code>) - <code class="label">&</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="label">&           </code>avdiff(:, :, ik-<code class="constant">1</code>)*rr(:, :, ik)</a>
        <a href="null_p.html#updatediffusion_mod" target="origFile"><code class="keyword">END DO</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">! -------------------------------</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">! Solve for the new mixing ratio.</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="comment">! -------------------------------</code></a>
        <a href="null_p.html#updatediffusion_mod" target="origFile">concentration(ic)%parray3d(:, :, k1) = rr(:, :, k1)/bb(:, :, k1)</a>
        <a href="null_p.html#updatediffusion_mod" target="origFile"><code class="keyword">DO </code>ik=k1+<code class="constant">1</code>,k2-<code class="constant">1</code></a>
          <a href="null_p.html#updatediffusion_mod" target="origFile">concentration(ic)%parray3d(:, :, ik) = rr(:, :, ik) - <code class="label">&</code></a>
<a href="null_p.html#updatediffusion_mod" target="origFile"><code class="label">&           </code>concentration(ic)%parray3d(:, :, ik-<code class="constant">1</code>)*cc(:, :, ik)</a>
        <a href="null_p.html#updatediffusion_mod" target="origFile"><code class="keyword">END DO</code></a>
      <a href="null_p.html#updatediffusion_mod" target="origFile"><code class="keyword">END IF</code></a>
    <a href="null_p.html#updatediffusion_mod" target="origFile"><code class="keyword">END DO </code><code class="label">icloop</code></a>
    <a href="null_p.html#updatediffusion_mod" target="origFile"><code class="keyword">RETURN</code></a>
  <a href="null_p.html#updatediffusion_mod" target="origFile"><code class="keyword">END SUBROUTINE </code><code class="funcname">DO_VERT_DIFFU</code></a>
<code class="keyword">END MODULE </code><code class="funcname">UPDATEDIFFUSION_MOD_D</code>
</pre>
</body>
