<title>Generated by TAPENADE</title>
<link type="text/CSS" rel="stylesheet" href="tapenade.css">
<link type="text/CSS" rel="stylesheet" href="fortranStyle.css">
<body>
<pre><code class="comment">!        Generated by TAPENADE     (INRIA, Ecuador team)</code>
<code class="comment">!  Tapenade 3.12 (r6213) - 13 Oct 2016 10:30</code>
<code class="comment">!</code>
<code class="comment">!-------------------------------------------------------------------------</code>
<code class="comment">!         NASA/GSFC, Software Systems Support Office, Code 610.3         !</code>
<code class="comment">!-------------------------------------------------------------------------</code>
<code class="comment">!BOP</code>
<code class="comment">!</code>
<code class="comment">! !MODULE: updateDiffusion_mod</code>
<code class="comment">!</code>
<code class="comment">! !INTERFACE:</code>
<code class="comment">!</code>
<code class="comment">!#include "MAPL_Generic.h"</code>
<code class="comment">!</code>
<code class="keyword">MODULE </code><code class="funcname">UPDATEDIFFUSION_MOD</code>
<code class="comment">!</code>
<code class="comment">! !USES:</code>
  <code class="keyword">USE </code><code class="funcname">ESMF</code>
<code class="comment">!      use MAPL_Mod</code>
  <code class="keyword">USE </code><code class="funcname">GMIARRAYBUNDLEPOINTER_MOD</code>, <code class="keyword">ONLY </code>: t_gmiarraybundle
  <code class="keyword">IMPLICIT NONE</code>
<code class="comment">!EOC</code>
<code class="comment">!------------------------------------------------------------------------------</code>
<code class="comment">!</code>
<code class="comment">! !PUBLIC MEMBER FUNCTIONS:</code>
  PRIVATE 
  PUBLIC updatediffusion
  PUBLIC update_pbl_mixing
<a name="updatediffusion"></a>
<code class="keyword">CONTAINS</code>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">!</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">! !DESCRIPTION:</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">!</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">! !AUTHOR:</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">!</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">! !REVISION HISTORY:</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">!</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">!EOP</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">!-------------------------------------------------------------------------</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">!-------------------------------------------------------------------------</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">!BOP</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">!</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">! !IROUTINE: updateDiffusion</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">!</code></a>
  <a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="keyword">SUBROUTINE </code><code class="funcname">UPDATEDIFFUSION</code>(<code class="vardecl">tdt</code>, <code class="vardecl">vert_diffu_coef</code>, <code class="vardecl">pbl</code>, <code class="vardecl">tropp</code>, <code class="vardecl">kzz</code>, <code class="label">&</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="label">&   </code><code class="vardecl">press3c</code>, <code class="vardecl">press3e</code>, <code class="vardecl">pctm1</code>, <code class="vardecl">concentration</code>, <code class="vardecl">isfixedconcentration</code>, <code class="label">&</code></a>
<a name="updatediffusioni77"></a><a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="label">&   </code><code class="vardecl">mettype</code>, <code class="vardecl">i1</code>, <code class="vardecl">i2</code>, <code class="vardecl">ju1</code>, <code class="vardecl">j2</code>, <code class="vardecl">k1</code>, <code class="vardecl">k2</code>, <code class="vardecl">ilo</code>, <code class="vardecl">ihi</code>, <code class="vardecl">julo</code>, <code class="vardecl">jhi</code>, <code class="vardecl">numspecies</code>)</a>
    <a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="keyword">IMPLICIT NONE</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">!</code></a>
<a name="updatediffusioni78"></a><a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">! !INPUT PARAMETERS:</code></a>
<a name="updatediffusioni79"></a>    <a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="typename">INTEGER</code>, <code class="typename">INTENT(IN) </code>:: <code class="vardecl">i1</code>, <code class="vardecl">i2</code>, <code class="vardecl">ju1</code>, <code class="vardecl">j2</code>, <code class="vardecl">k1</code>, <code class="vardecl">k2</code>, <code class="vardecl">ilo</code>, <code class="vardecl">ihi</code>, <code class="vardecl">julo</code>, <code class="vardecl">jhi</code></a>
    <a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="typename">INTEGER</code>, <code class="typename">INTENT(IN) </code>:: <code class="vardecl">numspecies</code></a>
<a name="updatediffusioni80"></a><a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">! model time step (s)</code></a>
    <a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="typename">REAL*8</code>, <code class="typename">INTENT(IN) </code>:: <code class="vardecl">tdt</code></a>
<a name="updatediffusioni81"></a><a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">! scalar vertical diffusion coefficient (m^2/s)</code></a>
    <a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="typename">REAL*8</code>, <code class="typename">INTENT(IN) </code>:: <code class="vardecl">vert_diffu_coef</code></a>
<a name="updatediffusioni82"></a><a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">! planetary boundary layer depth (m</code></a>
    <a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="typename">REAL*8</code>, <code class="typename">INTENT(IN) </code>:: <code class="vardecl">pbl</code>(<code class="vardecl">i1</code>:<code class="vardecl">i2</code>, <code class="vardecl">ju1</code>:<code class="vardecl">j2</code>)</a>
<a name="updatediffusioni83"></a><a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">! tropopause pressure (mb)</code></a>
    <a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="typename">REAL*8</code>, <code class="typename">INTENT(IN) </code>:: <code class="vardecl">tropp</code>(<code class="vardecl">i1</code>:<code class="vardecl">i2</code>, <code class="vardecl">ju1</code>:<code class="vardecl">j2</code>)</a>
<a name="updatediffusioni84"></a><a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">! atmospheric pressure at the center </code></a>
    <a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="typename">REAL*8</code>, <code class="typename">INTENT(IN) </code>:: <code class="vardecl">press3c</code>(<code class="vardecl">ilo</code>:<code class="vardecl">ihi</code>, <code class="vardecl">julo</code>:<code class="vardecl">jhi</code>, <code class="vardecl">k1</code>:<code class="vardecl">k2</code>)</a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">! of each grid box (mb)</code></a>
<a name="updatediffusioni85"></a><a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">! atmospheric pressure at the edge</code></a>
    <a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="typename">REAL*8</code>, <code class="typename">INTENT(IN) </code>:: <code class="vardecl">press3e</code>(<code class="vardecl">ilo</code>:<code class="vardecl">ihi</code>, <code class="vardecl">julo</code>:<code class="vardecl">jhi</code>, <code class="vardecl">k1</code>-<code class="constant">1</code>:<code class="vardecl">k2</code>)</a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">! of each grid box (mb)</code></a>
<a name="updatediffusioni86"></a><a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">! surface pressure field at t1, </code></a>
    <a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="typename">REAL*8</code>, <code class="typename">INTENT(IN) </code>:: <code class="vardecl">pctm1</code>(<code class="vardecl">ilo</code>:<code class="vardecl">ihi</code>, <code class="vardecl">julo</code>:<code class="vardecl">jhi</code>)</a>
<a name="updatediffusioni87"></a><a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">! known at zone centers (mb)</code></a>
<a name="updatediffusioni88"></a>    <a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="typename">LOGICAL</code>, <code class="typename">INTENT(IN) </code>:: <code class="vardecl">isfixedconcentration</code>(<code class="vardecl">numspecies</code>)</a>
    <a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="typename">CHARACTER</code>(<code class="keyword">len</code>=esmf_maxstr), <code class="typename">INTENT(IN) </code>:: <code class="vardecl">mettype</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">!</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">! !INPUT/OUTPUT PARAMETERS:</code></a>
<a name="updatediffusioni89"></a><a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">! array of vertical diffusion coefficients (m^2/s)</code></a>
    <a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="typename">REAL*8</code>, <code class="typename">INTENT(INOUT) </code>:: <code class="vardecl">kzz</code>(<code class="vardecl">i1</code>:<code class="vardecl">i2</code>, <code class="vardecl">ju1</code>:<code class="vardecl">j2</code>, <code class="vardecl">k1</code>:<code class="vardecl">k2</code>)</a>
<a name="updatediffusioni90"></a><a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">! species concentration (mixing ratio)</code></a>
    <a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="typename">TYPE(T_GMIARRAYBUNDLE)</code>, <code class="typename">INTENT(INOUT) </code>:: <code class="vardecl">concentration</code>(<code class="vardecl">numspecies</code>)</a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">!</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">! !DESCRIPTION:</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">! Updates diffusion.</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">!</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">!EOP</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">!------------------------------------------------------------------------------</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">!BOC</code></a>
<a name="updatediffusioni91"></a>    <a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="keyword">CALL </code><code class="funcname">ADJUST_KZZ</code>(press3c, tropp, kzz, i1, i2, ju1, j2, k1, k2, ilo, <code class="label">&</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="label">&             </code>ihi, julo, jhi)</a>
    <a href="null.html#updatediffusion_mod_bi10" target="diffFile"><code class="keyword">CALL </code><code class="funcname">DO_VERT_DIFFU</code>(tdt, vert_diffu_coef, pbl, kzz, press3c, press3e<code class="label">&</code></a>
<a href="null.html#updatediffusion_mod_bi10" target="diffFile"><code class="label">&                </code>, pctm1, concentration, isfixedconcentration, mettype, <code class="label">&</code></a>
<a href="null.html#updatediffusion_mod_bi10" target="diffFile"><code class="label">&                </code>i1, i2, ju1, j2, k1, k2, ilo, ihi, julo, jhi, <code class="label">&</code></a>
<a href="null.html#updatediffusion_mod_bi10" target="diffFile"><code class="label">&                </code>numspecies)</a>
<a name="update_pbl_mixing"></a>    <a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="keyword">RETURN</code></a>
  <a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="keyword">END SUBROUTINE </code><code class="funcname">UPDATEDIFFUSION</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">!</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">!EOC</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">!------------------------------------------------------------------------------</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">!BOP</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">!</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">! !IROUTINE: Update_PBL_Mixing</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">!</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">! !INTERFACE: </code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">!</code></a>
  <a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="keyword">SUBROUTINE </code><code class="funcname">UPDATE_PBL_MIXING</code>(<code class="vardecl">tdt</code>, <code class="vardecl">pbl_mixing_tau</code>, <code class="vardecl">pbl</code>, <code class="vardecl">grid_height</code>, <code class="label">&</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="label">&   </code><code class="vardecl">mass</code>, <code class="vardecl">concentration</code>, <code class="vardecl">i1</code>, <code class="vardecl">i2</code>, <code class="vardecl">ju1</code>, <code class="vardecl">j2</code>, <code class="vardecl">k1</code>, <code class="vardecl">k2</code>, <code class="vardecl">numspecies</code>)</a>
    <a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="keyword">IMPLICIT NONE</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">!</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">! !INPUT PARAMETERS:</code></a>
    <a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="typename">INTEGER</code>, <code class="typename">INTENT(IN) </code>:: <code class="vardecl">i1</code>, <code class="vardecl">i2</code>, <code class="vardecl">ju1</code>, <code class="vardecl">j2</code>, <code class="vardecl">k1</code>, <code class="vardecl">k2</code></a>
    <a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="typename">INTEGER</code>, <code class="typename">INTENT(IN) </code>:: <code class="vardecl">numspecies</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">! model time step (s)</code></a>
    <a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="typename">REAL*8</code>, <code class="typename">INTENT(IN) </code>:: <code class="vardecl">tdt</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">! time scale for pbl mixing (s)</code></a>
    <a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="typename">REAL*8</code>, <code class="typename">INTENT(IN) </code>:: <code class="vardecl">pbl_mixing_tau</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">! planetary boundary layer depth (m)</code></a>
    <a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="typename">REAL*8</code>, <code class="typename">INTENT(IN) </code>:: <code class="vardecl">pbl</code>(<code class="vardecl">i1</code>:<code class="vardecl">i2</code>, <code class="vardecl">ju1</code>:<code class="vardecl">j2</code>)</a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">! height of each grid box (m)</code></a>
    <a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="typename">REAL*8</code>, <code class="typename">INTENT(IN) </code>:: <code class="vardecl">grid_height</code>(<code class="vardecl">i1</code>:<code class="vardecl">i2</code>, <code class="vardecl">ju1</code>:<code class="vardecl">j2</code>, <code class="vardecl">k1</code>:<code class="vardecl">k2</code>)</a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">! air mass in each grid box (kg)</code></a>
    <a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="typename">REAL*8</code>, <code class="typename">INTENT(IN) </code>:: <code class="vardecl">mass</code>(<code class="vardecl">i1</code>:<code class="vardecl">i2</code>, <code class="vardecl">ju1</code>:<code class="vardecl">j2</code>, <code class="vardecl">k1</code>:<code class="vardecl">k2</code>)</a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">!</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">! !INPUT/OUTPUT PARAMETERS:</code></a>
    <a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="typename">TYPE(T_GMIARRAYBUNDLE)</code>, <code class="typename">INTENT(INOUT) </code>:: <code class="vardecl">concentration</code>(<code class="vardecl">numspecies</code>)</a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">!</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">! !DESCRIPTION:</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">!   Updates diffusion through a boundary layer mixing model.</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">!</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">! !LOCAL VARIABLES:</code></a>
    <a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="typename">INTEGER </code>:: <code class="vardecl">ic</code>, <code class="vardecl">il</code>, <code class="vardecl">ij</code>, <code class="vardecl">ik</code>, <code class="vardecl">kpbl</code></a>
    <a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="typename">REAL*8 </code>:: <code class="vardecl">frac_pbl</code>, <code class="vardecl">height</code>, <code class="vardecl">mass_pbl</code>, <code class="vardecl">mixing_factor</code>, <code class="vardecl">well_mixed</code></a>
    <a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="keyword">INTRINSIC </code><code class="funcname">EXP</code></a>
    <a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="keyword">INTRINSIC </code><code class="funcname">SUM</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">!EOP</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">!------------------------------------------------------------------------------</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">!BOC</code></a>
    <a href="null.html#updatediffusion_mod_b" target="diffFile">mixing_factor = <code class="funcname">EXP</code>(-(tdt/pbl_mixing_tau))</a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">!---------------------------------------</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">! Loop over all longitudes and latitudes.</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">!---------------------------------------</code></a>
    <a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="keyword">DO </code>il=i1,i2</a>
      <a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="keyword">DO </code>ij=ju1,j2</a>
        <a href="null.html#updatediffusion_mod_b" target="diffFile">mass_pbl = <code class="constant">0.0d0</code></a>
        <a href="null.html#updatediffusion_mod_b" target="diffFile">height = <code class="constant">0.0d0</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">!-----------------------------------</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">! Find the total mass within the pbl.</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">!-----------------------------------</code></a>
  <a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="label">kloop:</code><code class="keyword">DO </code>ik=k1,k2</a>
          <a href="null.html#updatediffusion_mod_b" target="diffFile">height = height + grid_height(il, ij, ik)</a>
          <a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="keyword">IF</code> (pbl(il, ij) .GE. height) <code class="keyword">THEN</code></a>
            <a href="null.html#updatediffusion_mod_b" target="diffFile">mass_pbl = mass_pbl + mass(il, ij, ik)</a>
          <a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="keyword">ELSE</code></a>
            <a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="keyword">GOTO </code><code class="label">100</code></a>
          <a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="keyword">END IF</code></a>
        <a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="keyword">END DO </code><code class="label">kloop</code></a>
        <a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="keyword">GOTO </code><code class="label">110</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">!-------------------------------------------------------</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">! This grid box is fractionally in the PBL. Save part of</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">! its mass also, save the k index, and exit the loop.</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">!-------------------------------------------------------</code></a>
 <a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="label">100    </code>frac_pbl = (pbl(il, ij)-(height-grid_height(il, ij, ik)))/<code class="label">&</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="label">&         </code>grid_height(il, ij, ik)</a>
        <a href="null.html#updatediffusion_mod_b" target="diffFile">mass_pbl = mass_pbl + mass(il, ij, ik)*frac_pbl</a>
        <a href="null.html#updatediffusion_mod_b" target="diffFile">kpbl = ik</a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">!--------------------------------------------------------</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">! Now if a real PBL was found (kpbl &gt; k1) loop over the</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">! species, calculate a well mixed</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">! mixing ratio, and apply it to the grids within the pbl</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">! and then to the grid box</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">! which is fractionally within the pbl.</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">!---------------------------------------------------------</code></a>
 <a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="label">110    </code><code class="keyword">IF</code> (kpbl .GT. k1) <code class="keyword">THEN</code></a>
          <a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="keyword">DO </code>ic=<code class="constant">1</code>,numspecies</a>
            <a href="null.html#updatediffusion_mod_b" target="diffFile">well_mixed = (<code class="funcname">SUM</code>(concentration(ic)%parray3d(il, ij, k1:kpbl<code class="label">&</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="label">&             </code>-<code class="constant">1</code>)*mass(il, ij, k1:kpbl-<code class="constant">1</code>))+frac_pbl*concentration(ic)%<code class="label">&</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="label">&             </code>parray3d(il, ij, kpbl)*mass(il, ij, kpbl))/mass_pbl</a>
            <a href="null.html#updatediffusion_mod_b" target="diffFile">concentration(ic)%parray3d(il, ij, <code class="constant">1</code>:kpbl-<code class="constant">1</code>) = concentration<code class="label">&</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="label">&             </code>(ic)%parray3d(il, ij, k1:kpbl-<code class="constant">1</code>)*mixing_factor + <code class="label">&</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="label">&             </code>well_mixed*(<code class="constant">1.0d0</code>-mixing_factor)</a>
            <a href="null.html#updatediffusion_mod_b" target="diffFile">concentration(ic)%parray3d(il, ij, kpbl) = concentration(ic)<code class="label">&</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="label">&             </code>%parray3d(il, ij, kpbl) + frac_pbl*(concentration(ic)%<code class="label">&</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="label">&             </code>parray3d(il, ij, kpbl)*(mixing_factor-<code class="constant">1.0d0</code>)+well_mixed*(<code class="label">&</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="label">&             </code><code class="constant">1.0d0</code>-mixing_factor))</a>
          <a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="keyword">END DO</code></a>
        <a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="keyword">END IF</code></a>
      <a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="keyword">END DO</code></a>
    <a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="keyword">END DO</code></a>
<a name="adjust_kzz"></a>    <a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="keyword">RETURN</code></a>
  <a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="keyword">END SUBROUTINE </code><code class="funcname">UPDATE_PBL_MIXING</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">!EOC</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">!------------------------------------------------------------------------------</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">!BOP</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">!</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">! !IROUTINE: Adjust_Kzz</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">!</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">! !INTERFACE:</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">!</code></a>
  <a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="keyword">SUBROUTINE </code><code class="funcname">ADJUST_KZZ</code>(<code class="vardecl">press3c</code>, <code class="vardecl">tropp</code>, <code class="vardecl">kzz</code>, <code class="vardecl">i1</code>, <code class="vardecl">i2</code>, <code class="vardecl">ju1</code>, <code class="vardecl">j2</code>, <code class="vardecl">k1</code>, <code class="vardecl">k2</code>, <code class="label">&</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="label">&   </code><code class="vardecl">ilo</code>, <code class="vardecl">ihi</code>, <code class="vardecl">julo</code>, <code class="vardecl">jhi</code>)</a>
    <a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="keyword">IMPLICIT NONE</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">!</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">! !INPUT PARAMETERS</code></a>
    <a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="typename">INTEGER</code>, <code class="typename">INTENT(IN) </code>:: <code class="vardecl">i1</code>, <code class="vardecl">i2</code>, <code class="vardecl">ju1</code>, <code class="vardecl">j2</code>, <code class="vardecl">k1</code>, <code class="vardecl">k2</code>, <code class="vardecl">ilo</code>, <code class="vardecl">ihi</code>, <code class="vardecl">julo</code>, <code class="vardecl">jhi</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">! atmospheric pressure at the center </code></a>
    <a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="typename">REAL*8</code>, <code class="typename">INTENT(IN) </code>:: <code class="vardecl">press3c</code>(<code class="vardecl">ilo</code>:<code class="vardecl">ihi</code>, <code class="vardecl">julo</code>:<code class="vardecl">jhi</code>, <code class="vardecl">k1</code>:<code class="vardecl">k2</code>)</a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">! of each grid box (mb)</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">! tropopause pressure (mb)</code></a>
    <a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="typename">REAL*8</code>, <code class="typename">INTENT(IN) </code>:: <code class="vardecl">tropp</code>(<code class="vardecl">i1</code>:<code class="vardecl">i2</code>, <code class="vardecl">ju1</code>:<code class="vardecl">j2</code>)</a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">!</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">! !INPUT/OUTPUT PARAMETERS:</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">! vertical diffusion coefficients (m^2/s)</code></a>
    <a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="typename">REAL*8</code>, <code class="typename">INTENT(INOUT) </code>:: <code class="vardecl">kzz</code>(<code class="vardecl">i1</code>:<code class="vardecl">i2</code>, <code class="vardecl">ju1</code>:<code class="vardecl">j2</code>, <code class="vardecl">k1</code>:<code class="vardecl">k2</code>)</a>
    <a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="keyword">INTRINSIC </code><code class="funcname">MAXVAL</code></a>
    <a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="typename">REAL*8 </code>:: <code class="vardecl">result1</code></a>
    <a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="typename">LOGICAL</code>, DIMENSION(i2-i1+<code class="constant">1</code>, j2-ju1+<code class="constant">1</code>, k2-k1+<code class="constant">1</code>) :: <code class="vardecl">mask</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">!</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">! !DESCRIPTION:</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">!   Makes the kzz (vertical diffusion) zero above the tropopause.</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">!</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">!EOP</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">!------------------------------------------------------------------------------</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">!BOC</code></a>
    <a href="null.html#updatediffusion_mod_b" target="diffFile">result1 = <code class="funcname">MAXVAL</code>(kzz)</a>
    <a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="keyword">IF</code> (result1 .GT. <code class="constant">0.0d0</code>) <code class="keyword">THEN</code></a>
      <a href="null.html#updatediffusion_mod_b" target="diffFile">mask(<code class="constant">1</code>:i2-i1+<code class="constant">1</code>, <code class="constant">1</code>:j2-ju1+<code class="constant">1</code>, :) = press3c(i1:i2, ju1:j2, :) .LT. <code class="label">&</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="label">&       </code><code class="funcname">SPREAD</code>(tropp(:, :), <code class="constant">3</code>, k2) + <code class="constant">100.0d0</code></a>
      <a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="keyword">WHERE </code>(mask(<code class="constant">1</code>:i2-i1+<code class="constant">1</code>, <code class="constant">1</code>:j2-ju1+<code class="constant">1</code>, :)) kzz(i1:i2, ju1:j2, :) = <code class="label">&</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="label">&         </code><code class="constant">0.0d0</code></a>
    <a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="keyword">END IF</code></a>
<a name="do_vert_diffu"></a>    <a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="keyword">RETURN</code></a>
  <a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="keyword">END SUBROUTINE </code><code class="funcname">ADJUST_KZZ</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">!EOP</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">!------------------------------------------------------------------------------</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">!BOC</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">!</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">! !IROUTINE: Do_Vert_Diffu</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">!</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">! !INTERFACE:</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">!</code></a>
  <a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="keyword">SUBROUTINE </code><code class="funcname">DO_VERT_DIFFU</code>(<code class="vardecl">tdt</code>, <code class="vardecl">vert_diffu_coef</code>, <code class="vardecl">pbl</code>, <code class="vardecl">kzz</code>, <code class="vardecl">press3c</code>, <code class="label">&</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="label">&   </code><code class="vardecl">press3e</code>, <code class="vardecl">psf</code>, <code class="vardecl">concentration</code>, <code class="vardecl">isfixedconcentration</code>, <code class="vardecl">mettype</code>, <code class="vardecl">i1</code>, <code class="vardecl">i2</code>, <code class="label">&</code></a>
<a name="do_vert_diffui0"></a><a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="label">&   </code><code class="vardecl">ju1</code>, <code class="vardecl">j2</code>, <code class="vardecl">k1</code>, <code class="vardecl">k2</code>, <code class="vardecl">ilo</code>, <code class="vardecl">ihi</code>, <code class="vardecl">julo</code>, <code class="vardecl">jhi</code>, <code class="vardecl">numspecies</code>)</a>
    <a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="keyword">IMPLICIT NONE</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">!</code></a>
<a name="do_vert_diffui1"></a><a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">! !INPUT PARAMETERS:</code></a>
<a name="do_vert_diffui2"></a>    <a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="typename">INTEGER</code>, <code class="typename">INTENT(IN) </code>:: <code class="vardecl">i1</code>, <code class="vardecl">i2</code>, <code class="vardecl">ju1</code>, <code class="vardecl">j2</code>, <code class="vardecl">k1</code>, <code class="vardecl">k2</code>, <code class="vardecl">ilo</code>, <code class="vardecl">ihi</code>, <code class="vardecl">julo</code>, <code class="vardecl">jhi</code></a>
    <a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="typename">INTEGER</code>, <code class="typename">INTENT(IN) </code>:: <code class="vardecl">numspecies</code></a>
<a name="do_vert_diffui3"></a><a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">! model time step (s)</code></a>
    <a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="typename">REAL*8</code>, <code class="typename">INTENT(IN) </code>:: <code class="vardecl">tdt</code></a>
<a name="do_vert_diffui4"></a><a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">! scalar vertical diffusion coefficient (m^2/s)</code></a>
    <a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="typename">REAL*8</code>, <code class="typename">INTENT(IN) </code>:: <code class="vardecl">vert_diffu_coef</code></a>
<a name="do_vert_diffui5"></a><a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">! planetary boundary layer depth (m)</code></a>
    <a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="typename">REAL*8</code>, <code class="typename">INTENT(IN) </code>:: <code class="vardecl">pbl</code>(<code class="vardecl">i1</code>:<code class="vardecl">i2</code>, <code class="vardecl">ju1</code>:<code class="vardecl">j2</code>)</a>
<a name="do_vert_diffui6"></a><a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">! vertical diffusion coefficients (m^2/s)</code></a>
    <a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="typename">REAL*8</code>, <code class="typename">INTENT(IN) </code>:: <code class="vardecl">kzz</code>(<code class="vardecl">i1</code>:<code class="vardecl">i2</code>, <code class="vardecl">ju1</code>:<code class="vardecl">j2</code>, <code class="vardecl">k1</code>:<code class="vardecl">k2</code>)</a>
<a name="do_vert_diffui7"></a><a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">! atmospheric pressure at the center of each grid box (mb)</code></a>
    <a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="typename">REAL*8</code>, <code class="typename">INTENT(IN) </code>:: <code class="vardecl">press3c</code>(<code class="vardecl">ilo</code>:<code class="vardecl">ihi</code>, <code class="vardecl">julo</code>:<code class="vardecl">jhi</code>, <code class="vardecl">k1</code>:<code class="vardecl">k2</code>)</a>
<a name="do_vert_diffui8"></a><a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">! atmospheric pressure at the edge   of each grid box (mb)</code></a>
    <a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="typename">REAL*8</code>, <code class="typename">INTENT(IN) </code>:: <code class="vardecl">press3e</code>(<code class="vardecl">ilo</code>:<code class="vardecl">ihi</code>, <code class="vardecl">julo</code>:<code class="vardecl">jhi</code>, <code class="vardecl">k1</code>-<code class="constant">1</code>:<code class="vardecl">k2</code>)</a>
<a name="do_vert_diffui9"></a><a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">! surface pressure field known at zone centers (mb)</code></a>
<a name="do_vert_diffui10"></a>    <a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="typename">REAL*8</code>, <code class="typename">INTENT(IN) </code>:: <code class="vardecl">psf</code>(<code class="vardecl">ilo</code>:<code class="vardecl">ihi</code>, <code class="vardecl">julo</code>:<code class="vardecl">jhi</code>)</a>
<a name="do_vert_diffui11"></a>    <a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="typename">LOGICAL</code>, <code class="typename">INTENT(IN) </code>:: <code class="vardecl">isfixedconcentration</code>(<code class="vardecl">numspecies</code>)</a>
    <a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="typename">CHARACTER</code>(<code class="keyword">len</code>=esmf_maxstr), <code class="typename">INTENT(IN) </code>:: <code class="vardecl">mettype</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">!</code></a>
<a name="do_vert_diffui12"></a><a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">! !INPUT/OUTPUT PARAMETERS:</code></a>
    <a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="typename">TYPE(T_GMIARRAYBUNDLE)</code>, <code class="typename">INTENT(INOUT) </code>:: <code class="vardecl">concentration</code>(<code class="vardecl">numspecies</code>)</a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">!</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">! !DECLARED VARIABLES:</code></a>
<a name="do_vert_diffui13"></a><a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">! atmospheric scale height (m)</code></a>
    <a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="typename">REAL*8</code>, <code class="typename">PARAMETER </code>:: <code class="vardecl">hzero</code>=<code class="constant">8000.0d0</code></a>
<a name="do_vert_diffui14"></a><a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">! (m^2)</code></a>
    <a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="typename">REAL*8</code>, <code class="typename">PARAMETER </code>:: <code class="vardecl">hzero2</code>=<code class="vardecl">hzero</code>*<code class="vardecl">hzero</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">!</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">! !DESCRIPTION:</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">!   Calculates vertical diffusion using an implicit technique.</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">!   Note: Constituent mass is conserved during mixing.</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">!          Constant field should remain constant.</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">!</code></a>
<a name="do_vert_diffui15"></a><a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">! !LOCAL VARIABLES:</code></a>
<a name="do_vert_diffui16"></a>    <a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="typename">INTEGER </code>:: <code class="vardecl">ik</code>, <code class="vardecl">ic</code></a>
<a name="do_vert_diffui17"></a>    <a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="typename">REAL*8 </code>:: <code class="vardecl">avdiff</code>(<code class="vardecl">i1</code>:<code class="vardecl">i2</code>, <code class="vardecl">ju1</code>:<code class="vardecl">j2</code>, <code class="vardecl">k1</code>:<code class="vardecl">k2</code>-<code class="constant">1</code>)</a>
<a name="do_vert_diffui18"></a>    <a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="typename">REAL*8 </code>:: <code class="vardecl">bvdiff</code>(<code class="vardecl">i1</code>:<code class="vardecl">i2</code>, <code class="vardecl">ju1</code>:<code class="vardecl">j2</code>, <code class="vardecl">k1</code>:<code class="vardecl">k2</code>-<code class="constant">1</code>)</a>
<a name="do_vert_diffui19"></a>    <a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="typename">REAL*8 </code>:: <code class="vardecl">cvdiff</code>(<code class="vardecl">i1</code>:<code class="vardecl">i2</code>, <code class="vardecl">ju1</code>:<code class="vardecl">j2</code>, <code class="vardecl">k1</code>:<code class="vardecl">k2</code>-<code class="constant">1</code>)</a>
<a name="do_vert_diffui20"></a>    <a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="typename">REAL*8 </code>:: <code class="vardecl">vdiff</code>(<code class="vardecl">i1</code>:<code class="vardecl">i2</code>, <code class="vardecl">ju1</code>:<code class="vardecl">j2</code>, <code class="vardecl">k1</code>:<code class="vardecl">k2</code>-<code class="constant">1</code>)</a>
<a name="do_vert_diffui21"></a>    <a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="typename">REAL*8 </code>:: <code class="vardecl">bb</code>(<code class="vardecl">i1</code>:<code class="vardecl">i2</code>, <code class="vardecl">ju1</code>:<code class="vardecl">j2</code>, <code class="vardecl">k1</code>:<code class="vardecl">k2</code>-<code class="constant">1</code>)</a>
<a name="do_vert_diffui22"></a>    <a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="typename">REAL*8 </code>:: <code class="vardecl">cc</code>(<code class="vardecl">i1</code>:<code class="vardecl">i2</code>, <code class="vardecl">ju1</code>:<code class="vardecl">j2</code>, <code class="vardecl">k1</code>:<code class="vardecl">k2</code>-<code class="constant">1</code>)</a>
<a name="do_vert_diffui23"></a>    <a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="typename">REAL*8 </code>:: <code class="vardecl">rr</code>(<code class="vardecl">i1</code>:<code class="vardecl">i2</code>, <code class="vardecl">ju1</code>:<code class="vardecl">j2</code>, <code class="vardecl">k1</code>:<code class="vardecl">k2</code>-<code class="constant">1</code>)</a>
<a name="do_vert_diffui24"></a>    <a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="keyword">INTRINSIC </code><code class="funcname">MAXVAL</code></a>
<a name="do_vert_diffui25"></a>    <a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="keyword">INTRINSIC </code><code class="funcname">LOG</code></a>
<a name="do_vert_diffui26"></a>    <a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="keyword">INTRINSIC </code><code class="funcname">ABS</code></a>
<a name="do_vert_diffui27"></a>    <a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="keyword">INTRINSIC </code><code class="funcname">TRIM</code></a>
<a name="do_vert_diffui28"></a>    <a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="typename">REAL*8</code>, DIMENSION(i1:i2, ju1:j2) :: <code class="vardecl">abs0</code></a>
<a name="do_vert_diffui29"></a>    <a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="typename">REAL*8 </code>:: <code class="vardecl">result1</code></a>
<a name="do_vert_diffui30"></a>    <a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="typename">LOGICAL</code>, DIMENSION(i2-i1+<code class="constant">1</code>, j2-ju1+<code class="constant">1</code>) :: <code class="vardecl">mask</code></a>
    <a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="typename">LOGICAL</code>, DIMENSION(i2-i1+<code class="constant">1</code>, j2-ju1+<code class="constant">1</code>) :: <code class="vardecl">mask0</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">!</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">!EOP</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">!------------------------------------------------------------------------------</code></a>
<a name="do_vert_diffui31"></a><a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">!BOC</code></a>
<a name="do_vert_diffui32"></a>    <a href="null.html#updatediffusion_mod_b" target="diffFile">avdiff(:, :, :) = <code class="constant">0.0d0</code></a>
    <a href="null.html#updatediffusion_mod_b" target="diffFile">bvdiff(:, :, :) = <code class="constant">0.0d0</code></a>
<a name="do_vert_diffui33"></a>    <a href="null.html#updatediffusion_mod_b" target="diffFile">cvdiff(:, :, :) = <code class="constant">0.0d0</code></a>
<a name="do_vert_diffui34"></a>    <a href="null.html#updatediffusion_mod_b" target="diffFile">vdiff(:, :, :) = <code class="constant">0.0d0</code></a>
    <a href="null.html#updatediffusion_mod_b" target="diffFile">bb(:, :, :) = <code class="constant">0.0d0</code></a>
<a name="do_vert_diffui35"></a>    <a href="null.html#updatediffusion_mod_b" target="diffFile">cc(:, :, :) = <code class="constant">0.0d0</code></a>
    <a href="null.html#updatediffusion_mod_b" target="diffFile">rr(:, :, :) = <code class="constant">0.0d0</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">! --------------------------------------------------------</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">! If there was no kzz in the met file, it was set to &lt; 0.</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">! In this case calculate a vertical diffusion coefficient,</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">! otherwise use kzz.</code></a>
<a name="do_vert_diffui36"></a><a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">! --------------------------------------------------------</code></a>
<a name="do_vert_diffui37"></a>    <a href="null.html#updatediffusion_mod_b" target="diffFile">result1 = <code class="funcname">MAXVAL</code>(kzz)</a>
    <a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="keyword">IF</code> (result1 .LT. <code class="constant">0.0d0</code>) <code class="keyword">THEN</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">! ------------------------------------------------------</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">! Set up the vertical diffusion coefficients.</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">! First put height (m) into vdiff, then put simple</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">! parameterization for diffusion coefficient into vdiff,</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">! then put it into units of per mb</code></a>
<a name="do_vert_diffui46"></a><a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">! ------------------------------------------------------</code></a>
<a name="do_vert_diffui38"></a>      <a href="null.html#updatediffusion_mod_b" target="diffFile">vdiff = <code class="constant">0.0d0</code></a>
      <a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="keyword">DO </code>ik=<code class="constant">1</code>,<code class="constant">10</code></a>
<a name="do_vert_diffui39"></a>        <a href="null.html#updatediffusion_mod_b" target="diffFile">vdiff(:, :, ik) = -(hzero*<code class="funcname">LOG</code>(press3e(i1:i2, ju1:j2, ik)/psf(i1:<code class="label">&</code></a>
<a name="do_vert_diffui40"></a><a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="label">&         </code>i2, ju1:j2)))</a>
        <a href="null.html#updatediffusion_mod_bi1" target="diffFile">mask(:, :) = vdiff(:, :, ik) .LT. pbl(:, :)</a>
<a name="do_vert_diffui41"></a>        <a href="null.html#updatediffusion_mod_bi0" target="diffFile">mask0(:, :) = vdiff(:, :, ik) - pbl(:, :)*<code class="constant">0.5d0 </code>.GE. <code class="constant">0.0</code></a>
        <a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="keyword">WHERE </code>(mask0(:, :)) </a>
<a name="do_vert_diffui42"></a>          <a href="null.html#updatediffusion_mod_b" target="diffFile">abs0 = vdiff(:, :, ik) - pbl(:, :)*<code class="constant">0.5d0</code></a>
        <a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="keyword">ELSEWHERE</code></a>
          <a href="null.html#updatediffusion_mod_b" target="diffFile">abs0 = -(vdiff(:, :, ik)-pbl(:, :)*<code class="constant">0.5d0</code>)</a>
<a name="do_vert_diffui43"></a>        <a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="keyword">END WHERE</code></a>
        <a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="keyword">WHERE </code>(mask(:, :)) </a>
          <a href="null.html#updatediffusion_mod_b" target="diffFile">vdiff(:, :, ik) = vert_diffu_coef*(<code class="constant">1.0d0</code>-<code class="constant">2.0d0</code>*(abs0/pbl(:, :)<code class="label">&</code></a>
<a name="do_vert_diffui44"></a><a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="label">&           </code>))</a>
        <a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="keyword">ELSEWHERE</code></a>
<a name="do_vert_diffui45"></a>          <a href="null.html#updatediffusion_mod_b" target="diffFile">vdiff(:, :, ik) = <code class="constant">0.0d0</code></a>
        <a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="keyword">END WHERE</code></a>
        <a href="null.html#updatediffusion_mod_b" target="diffFile">vdiff(:, :, ik) = vdiff(:, :, ik)/hzero2*(press3e(i1:i2, ju1:j2<code class="label">&</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="label">&         </code>, ik)*press3e(i1:i2, ju1:j2, ik))/(press3c(i1:i2, ju1:j2, ik)-<code class="label">&</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="label">&         </code>press3c(i1:i2, ju1:j2, ik+<code class="constant">1</code>))</a>
<a name="do_vert_diffui47"></a>      <a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="keyword">END DO</code></a>
    <a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="keyword">ELSE</code></a>
      <a href="null.html#updatediffusion_mod_b" target="diffFile">vdiff(:, :, k1:k2-<code class="constant">1</code>) = kzz(:, :, k1:k2-<code class="constant">1</code>)/hzero2*(press3e(i1:i2, <code class="label">&</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="label">&       </code>ju1:j2, k1:k2-<code class="constant">1</code>)*press3e(i1:i2, ju1:j2, k1:k2-<code class="constant">1</code>))/(press3c(i1:i2<code class="label">&</code></a>
<a name="do_vert_diffui48"></a><a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="label">&       </code>, ju1:j2, k1:k2-<code class="constant">1</code>)-press3c(i1:i2, ju1:j2, k1+<code class="constant">1</code>:k2))</a>
    <a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="keyword">END IF</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">! -----------------------------------------------------------</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">! Construct the tri-diagonal matrix which will be used in the</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">! implicit vertical diffusion solution.</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">!   avdiff is the lower band</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">!   bvdiff is the main diagonal</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">!   cvdiff is the upper band</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">! -----------------------------------------------------------</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">! -----------------------</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">! First do the top layer.</code></a>
<a name="do_vert_diffui49"></a><a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">! -----------------------</code></a>
<a name="do_vert_diffui50"></a>    <a href="null.html#updatediffusion_mod_b" target="diffFile">avdiff(:, :, k2-<code class="constant">1</code>) = <code class="constant">0.0d0</code></a>
<a name="do_vert_diffui51"></a>    <a href="null.html#updatediffusion_mod_b" target="diffFile">bvdiff(:, :, k2-<code class="constant">1</code>) = vdiff(:, :, k2-<code class="constant">2</code>)</a>
    <a href="null.html#updatediffusion_mod_b" target="diffFile">cvdiff(:, :, k2-<code class="constant">1</code>) = -vdiff(:, :, k2-<code class="constant">2</code>)</a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">! ----------------------</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">! Now do all the layers.</code></a>
<a name="do_vert_diffui52"></a><a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">! ----------------------</code></a>
    <a href="null.html#updatediffusion_mod_b" target="diffFile">avdiff(:, :, k1+<code class="constant">1</code>:k2-<code class="constant">2</code>) = -vdiff(:, :, k1+<code class="constant">1</code>:k2-<code class="constant">2</code>)</a>
<a name="do_vert_diffui53"></a>    <a href="null.html#updatediffusion_mod_b" target="diffFile">bvdiff(:, :, k1+<code class="constant">1</code>:k2-<code class="constant">2</code>) = vdiff(:, :, k1+<code class="constant">1</code>:k2-<code class="constant">2</code>) + vdiff(:, :, k1:k2<code class="label">&</code></a>
<a name="do_vert_diffui54"></a><a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="label">&     </code>-<code class="constant">3</code>)</a>
    <a href="null.html#updatediffusion_mod_b" target="diffFile">cvdiff(:, :, k1+<code class="constant">1</code>:k2-<code class="constant">2</code>) = -vdiff(:, :, k1:k2-<code class="constant">3</code>)</a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">! ------------------------------------</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">! Now do the layer next to the ground.</code></a>
<a name="do_vert_diffui55"></a><a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">! ------------------------------------</code></a>
<a name="do_vert_diffui56"></a>    <a href="null.html#updatediffusion_mod_b" target="diffFile">avdiff(:, :, k1) = -vdiff(:, :, k1)</a>
<a name="do_vert_diffui57"></a>    <a href="null.html#updatediffusion_mod_b" target="diffFile">bvdiff(:, :, k1) = vdiff(:, :, k1)</a>
    <a href="null.html#updatediffusion_mod_b" target="diffFile">cvdiff(:, :, k1) = <code class="constant">0.0d0</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">! ---------------------------------------------------</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">! Now convert them to the proper dimensionless units.</code></a>
<a name="do_vert_diffui58"></a><a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">! ---------------------------------------------------</code></a>
    <a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="keyword">IF</code> (<code class="funcname">TRIM</code>(mettype) .EQ. <code class="string">'MERRA2' </code>.OR. <code class="funcname">TRIM</code>(mettype) .EQ. <code class="string">'FPIT'</code>) <code class="keyword">THEN</code></a>
      <a href="null.html#updatediffusion_mod_b" target="diffFile">avdiff(i1:i2, ju1:j2, k1:k2-<code class="constant">1</code>) = avdiff(i1:i2, ju1:j2, k1:k2-<code class="constant">1</code>)*<code class="label">&</code></a>
<a name="do_vert_diffui59"></a><a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="label">&       </code>tdt/(press3e(i1:i2, ju1:j2, k1:k2-<code class="constant">1</code>)-press3e(i1:i2, ju1:j2, k1+<code class="constant">1</code><code class="label">&</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="label">&       </code>:k2))</a>
      <a href="null.html#updatediffusion_mod_b" target="diffFile">bvdiff(i1:i2, ju1:j2, k1:k2-<code class="constant">1</code>) = bvdiff(i1:i2, ju1:j2, k1:k2-<code class="constant">1</code>)*<code class="label">&</code></a>
<a name="do_vert_diffui60"></a><a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="label">&       </code>tdt/(press3e(i1:i2, ju1:j2, k1:k2-<code class="constant">1</code>)-press3e(i1:i2, ju1:j2, k1+<code class="constant">1</code><code class="label">&</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="label">&       </code>:k2)) + <code class="constant">1.0d0</code></a>
      <a href="null.html#updatediffusion_mod_b" target="diffFile">cvdiff(i1:i2, ju1:j2, k1:k2-<code class="constant">1</code>) = cvdiff(i1:i2, ju1:j2, k1:k2-<code class="constant">1</code>)*<code class="label">&</code></a>
<a name="do_vert_diffui61"></a><a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="label">&       </code>tdt/(press3e(i1:i2, ju1:j2, k1:k2-<code class="constant">1</code>)-press3e(i1:i2, ju1:j2, k1+<code class="constant">1</code><code class="label">&</code></a>
<a name="do_vert_diffui62"></a><a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="label">&       </code>:k2))</a>
    <a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="keyword">ELSE IF</code> (<code class="funcname">TRIM</code>(mettype) .EQ. <code class="string">'MERRA1'</code>) <code class="keyword">THEN</code></a>
      <a href="null.html#updatediffusion_mod_b" target="diffFile">avdiff(i1:i2, ju1:j2, k1:k2-<code class="constant">1</code>) = avdiff(i1:i2, ju1:j2, k1:k2-<code class="constant">1</code>)*<code class="label">&</code></a>
<a name="do_vert_diffui63"></a><a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="label">&       </code>tdt/(press3e(i1:i2, ju1:j2, k1-<code class="constant">1</code>:k2-<code class="constant">2</code>)-press3e(i1:i2, ju1:j2, k1<code class="label">&</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="label">&       </code>:k2-<code class="constant">1</code>))</a>
      <a href="null.html#updatediffusion_mod_b" target="diffFile">bvdiff(i1:i2, ju1:j2, k1:k2-<code class="constant">1</code>) = bvdiff(i1:i2, ju1:j2, k1:k2-<code class="constant">1</code>)*<code class="label">&</code></a>
<a name="do_vert_diffui64"></a><a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="label">&       </code>tdt/(press3e(i1:i2, ju1:j2, k1-<code class="constant">1</code>:k2-<code class="constant">2</code>)-press3e(i1:i2, ju1:j2, k1<code class="label">&</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="label">&       </code>:k2-<code class="constant">1</code>)) + <code class="constant">1.0d0</code></a>
      <a href="null.html#updatediffusion_mod_b" target="diffFile">cvdiff(i1:i2, ju1:j2, k1:k2-<code class="constant">1</code>) = cvdiff(i1:i2, ju1:j2, k1:k2-<code class="constant">1</code>)*<code class="label">&</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="label">&       </code>tdt/(press3e(i1:i2, ju1:j2, k1-<code class="constant">1</code>:k2-<code class="constant">2</code>)-press3e(i1:i2, ju1:j2, k1<code class="label">&</code></a>
<a name="do_vert_diffui76"></a><a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="label">&       </code>:k2-<code class="constant">1</code>))</a>
    <a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="keyword">END IF</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">! ---------------------</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">! Now solve the system.</code></a>
<a name="do_vert_diffui65"></a><a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">! ---------------------</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="label">icloop:</code><code class="keyword">DO </code>ic=<code class="constant">1</code>,numspecies</a>
<a name="do_vert_diffui66"></a><a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">!   ======================================</code></a>
      <a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="keyword">IF</code> (.NOT.isfixedconcentration(ic)) <code class="keyword">THEN</code></a>
<a href="null.html#updatediffusion_mod_bi3" target="diffFile"><code class="comment">!   ======================================</code></a>
<a href="null.html#updatediffusion_mod_bi3" target="diffFile"><code class="comment">! -----------------------------------------</code></a>
<a href="null.html#updatediffusion_mod_bi3" target="diffFile"><code class="comment">! Set up the right hand side of the system.</code></a>
<a name="do_vert_diffui67"></a><a href="null.html#updatediffusion_mod_bi3" target="diffFile"><code class="comment">! -----------------------------------------</code></a>
<a name="do_vert_diffui72"></a>        <a href="null.html#updatediffusion_mod_bi3" target="diffFile">bb(:, :, k2-<code class="constant">1</code>) = bvdiff(:, :, k2-<code class="constant">1</code>)</a>
        <a href="null.html#updatediffusion_mod_bi2" target="diffFile">rr(:, :, k2-<code class="constant">1</code>) = concentration(ic)%parray3d(:, :, k2-<code class="constant">1</code>)</a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">! ---------------------------------</code></a>
<a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">! Eliminate the lower diagonal (a).</code></a>
<a name="do_vert_diffui68"></a><a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="comment">! ---------------------------------</code></a>
<a name="do_vert_diffui71"></a>        <a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="keyword">DO </code>ik=k2-<code class="constant">1</code>,k1+<code class="constant">1</code>,-<code class="constant">1</code></a>
<a name="do_vert_diffui69"></a>          <a href="null.html#updatediffusion_mod_bi7" target="diffFile">cc(:, :, ik) = cvdiff(:, :, ik)/bb(:, :, ik)</a>
          <a href="null.html#updatediffusion_mod_bi6" target="diffFile">rr(:, :, ik) = rr(:, :, ik)/bb(:, :, ik)</a>
<a name="do_vert_diffui70"></a>          <a href="null.html#updatediffusion_mod_bi5" target="diffFile">bb(:, :, ik-<code class="constant">1</code>) = bvdiff(:, :, ik-<code class="constant">1</code>) - avdiff(:, :, ik-<code class="constant">1</code>)*cc(:<code class="label">&</code></a>
<a href="null.html#updatediffusion_mod_bi5" target="diffFile"><code class="label">&           </code>, :, ik)</a>
          <a href="null.html#updatediffusion_mod_bi4" target="diffFile">rr(:, :, ik-<code class="constant">1</code>) = concentration(ic)%parray3d(:, :, ik-<code class="constant">1</code>) - <code class="label">&</code></a>
<a name="do_vert_diffui73"></a><a href="null.html#updatediffusion_mod_bi4" target="diffFile"><code class="label">&           </code>avdiff(:, :, ik-<code class="constant">1</code>)*rr(:, :, ik)</a>
        <a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="keyword">END DO</code></a>
<a href="null.html#updatediffusion_mod_bi8" target="diffFile"><code class="comment">! -------------------------------</code></a>
<a href="null.html#updatediffusion_mod_bi8" target="diffFile"><code class="comment">! Solve for the new mixing ratio.</code></a>
<a name="do_vert_diffui75"></a><a href="null.html#updatediffusion_mod_bi8" target="diffFile"><code class="comment">! -------------------------------</code></a>
<a name="do_vert_diffui74"></a>        <a href="null.html#updatediffusion_mod_bi8" target="diffFile">concentration(ic)%parray3d(:, :, k1) = rr(:, :, k1)/bb(:, :, k1)</a>
        <a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="keyword">DO </code>ik=k1+<code class="constant">1</code>,k2-<code class="constant">1</code></a>
          <a href="null.html#updatediffusion_mod_bi9" target="diffFile">concentration(ic)%parray3d(:, :, ik) = rr(:, :, ik) - <code class="label">&</code></a>
<a href="null.html#updatediffusion_mod_bi9" target="diffFile"><code class="label">&           </code>concentration(ic)%parray3d(:, :, ik-<code class="constant">1</code>)*cc(:, :, ik)</a>
        <a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="keyword">END DO</code></a>
      <a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="keyword">END IF</code></a>
    <a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="keyword">END DO </code><code class="label">icloop</code></a>
    <a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="keyword">RETURN</code></a>
  <a href="null.html#updatediffusion_mod_b" target="diffFile"><code class="keyword">END SUBROUTINE </code><code class="funcname">DO_VERT_DIFFU</code></a>
<code class="keyword">END MODULE </code><code class="funcname">UPDATEDIFFUSION_MOD</code>
</pre>
</body>
