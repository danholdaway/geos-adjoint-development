!        Generated by TAPENADE     (INRIA, Ecuador team)
!  Tapenade 3.12 (r6213) - 13 Oct 2016 10:30
!
!-------------------------------------------------------------------------
!         NASA/GSFC, Software Systems Support Office, Code 610.3         !
!-------------------------------------------------------------------------
!BOP
!
! !MODULE: GenericConvectionMethod_mod 
MODULE GENERICCONVECTIONMETHOD_MOD_D
  USE ESMF
  USE CONVECTIVETRANSPORT_MOD_D
  USE GMIARRAYBUNDLEPOINTER_MOD_D
  IMPLICIT NONE
  PRIVATE 
  PUBLIC dogenericconvectivetransport
  PUBLIC dogenericconvectivetransport_tlm

CONTAINS
!  Differentiation of dogenericconvectivetransport in forward (tangent) mode:
!   variations   of useful results: *(concentration.parray3d)
!   with respect to varying inputs: *(concentration.parray3d)
!   RW status of diff variables: *(concentration.parray3d):in-out
!   Plus diff mem management of: concentration.parray3d:in
  SUBROUTINE DOGENERICCONVECTIVETRANSPORT_TLM(det_ent, do_downdraft, pbl&
&   , cldmas, dtrn, eu, ed, md, grid_height, mass, kel, press3e, &
&   concentration, concentration_tl, isfixedconcentration, mcor, tdt, i1&
&   , i2, j1, j2, k1, k2, ilong, ivert, num_species)
    IMPLICIT NONE
!
! !INPUT PARAMETER:
    INTEGER, INTENT(IN) :: i1, i2, j1, j2, k1, k2
    INTEGER, INTENT(IN) :: ilong, ivert, num_species
    LOGICAL, INTENT(IN) :: isfixedconcentration(:)
! flag for doing detrainment then entrainment
    LOGICAL, INTENT(IN) :: det_ent
! flag for doing downdrafts
    LOGICAL, INTENT(IN) :: do_downdraft
! model time step  (s)
    REAL*8, INTENT(IN) :: tdt
! area of each grid box (m^2)
    REAL*8, INTENT(IN) :: mcor(i1:i2, j1:j2)
! planetary boundary layer thickness (m)
    REAL*8, INTENT(IN) :: pbl(i1:i2, j1:j2)
! convective mass flux in     updraft (kg/m^2/s)
    REAL*8, INTENT(IN) :: cldmas(i1:i2, j1:j2, k1:k2)
! detrainment rate (DAO:kg/m^2*s, NCAR:s^-1)
    REAL*8, INTENT(IN) :: dtrn(i1:i2, j1:j2, k1:k2)
! ntrainment into convective updraft (s^-1)
    REAL*8, INTENT(IN) :: eu(i1:i2, j1:j2, k1:k2)
! entrainment into convective downdraft (s^-1)
    REAL*8, INTENT(IN) :: ed(i1:i2, j1:j2, k1:k2)
! convective mass flux in downdraft (kg/m^2/s)
    REAL*8, INTENT(IN) :: md(i1:i2, j1:j2, k1:k2)
! grid box height  (m)
    REAL*8, INTENT(IN) :: grid_height(i1:i2, j1:j2, k1:k2)
! mass of air in each grid box (kg)
    REAL*8, INTENT(IN) :: mass(i1:i2, j1:j2, k1:k2)
! temperature      (degK)
    REAL*8, INTENT(IN) :: kel(i1:i2, j1:j2, k1:k2)
! atmospheric pressure at the edge of each grid box (mb)
    REAL*8, INTENT(IN) :: press3e(i1:i2, j1:j2, k1-1:k2)
!
! !INPUT/OUTPUT PARAMETERS:
! species concentration, known at zone centers (mixing ratio)
    TYPE(T_GMIARRAYBUNDLE), INTENT(INOUT) :: concentration(num_species)
    TYPE(T_GMIARRAYBUNDLE), INTENT(INOUT) :: concentration_tl(&
&   num_species)
!
! !DEFINED PARAMETERS:
! threshold below which we treat 
    REAL*8, PARAMETER :: mbsth=1.0d-15
! mass fluxes as zero (mb/s)
! mean surface gravity accel. (m/s^2)
    REAL*8, PARAMETER :: gmi_g=9.81d0
! pascals  per millibar
    REAL*8, PARAMETER :: paspmb=100.00d0
!
! !DESCRIPTION:
! This is the interface routine to Convective Transport.  
! It formats the gem variables to satisfy the Convective Transport routine.
!
!EOP
!------------------------------------------------------------------------
!BOC
!
! !LOCAL VARIABLES:
    CHARACTER(len=75) :: err_msg
    INTEGER :: iku
    INTEGER :: il, ij, ik, ic
! gathered index to operate over
    INTEGER :: il2g
    INTEGER :: itdt_conv
    INTEGER :: num_conv_steps
    REAL*8 :: rnum_conv_steps
    REAL*8 :: tdt_conv
    REAL*8 :: xmbsth
! gathering array
    INTEGER :: ideep(ilong)
! index of pbl height
    INTEGER :: pbli(ilong)
! velocity in convective updraft
    REAL*8 :: updraft_velocity(i1:i2)
! (m/s)
! delta pressure between interfaces
    REAL*8 :: dpi(ilong, k1:k2)
! mass detraining from updraft
    REAL*8 :: dui(ilong, k1:k2)
! mass entraining into updraft
    REAL*8 :: eui(ilong, k1:k2)
! mass flux up
    REAL*8 :: mui(ilong, k1:k2)
! mass flux down
    REAL*8 :: mdi(ilong, k1:k2)
! insoluble fraction of tracer
    REAL*8 :: fracis(i1:i2, k1:k2, num_species)
! tracer array including moisture
    REAL*8 :: qq(i1:i2, k1:k2, num_species)
    REAL*8 :: qq_tl(i1:i2, k1:k2, num_species)
    INTRINSIC MAXVAL
    INTRINSIC INT
    INTRINSIC REAL
    INTRINSIC MAX
    INTRINSIC SUM
    REAL*8 :: result1
    REAL*8, DIMENSION(i2-i1+1, j2-j1+1, k2-k1+1) :: arg1
    REAL*8 :: result2
    ideep(:) = 0
    pbli(:) = 0
    dpi(:, :) = 0.0d0
    dui(:, :) = 0.0d0
    eui(:, :) = 0.0d0
    mui(:, :) = 0.0d0
    mdi(:, :) = 0.0d0
    fracis(:, :, :) = 0.0d0
    xmbsth = mbsth
    updraft_velocity(:) = 0.0d0
! -----------------------------------------------------------
! Calculate any needed sub-cycling of the convection operator
! by comparing the mass flux over the full time step to the
! mass within the grid box.
! -----------------------------------------------------------
    result1 = SPREAD(mcor(:, :), 3, k2 - k1 + 1)
    arg1(:, :, :) = tdt*cldmas(:, :, :)*result1/mass(:, :, :)
    result2 = MAXVAL(arg1(:, :, :))
    num_conv_steps = INT(result2 + 1.0d0)
    rnum_conv_steps = REAL(num_conv_steps, 8)
    tdt_conv = tdt/rnum_conv_steps
    qq_tl = 0.0_8
ijloop:DO ij=j1,j2
      il2g = 0
illoop:DO il=i1,i2
! ----------------------------------------------------
! Verify that there is convection in the current cell.
! ----------------------------------------------------
        result1 = MAXVAL(cldmas(il, ij, :))
        IF (result1 .GE. 0.0d0) THEN
          il2g = il2g + 1
          ideep(il2g) = il
          dpi(il2g, :) = (press3e(il, ij, k2-1:k1-1:-1)-press3e(il, ij, &
&           k2:k1:-1))*paspmb
          mui(il2g, :) = cldmas(il, ij, k2:k1:-1)*gmi_g
          WHERE (0.0d0 .LT. cldmas(il, ij, k2-1:k1+1:-1) - cldmas(il, ij&
&             , k2-2:k1:-1) + dtrn(il, ij, k2-1:k1+1:-1)) 
            eui(il2g, k1+1:k2-1) = cldmas(il, ij, k2-1:k1+1:-1) - cldmas&
&             (il, ij, k2-2:k1:-1) + dtrn(il, ij, k2-1:k1+1:-1)
          ELSEWHERE
            eui(il2g, k1+1:k2-1) = 0.0d0
          END WHERE
          eui(il2g, :) = eui(il2g, :)*gmi_g
          IF (det_ent) dui(il2g, :) = dtrn(il, ij, k2:k1:-1)*gmi_g
        END IF
      END DO illoop
      IF (il2g .NE. 0) THEN
        fracis(:, :, :) = 1.0d0
! ----------------------------------------------------------------
! Find the index of the top of the planetary boundary layer (pbl).
! Convection will assume well mixed tracers below that level.
! ----------------------------------------------------------------
        DO il=1,il2g
          pbli(il) = 0
   ikloop:DO ik=k1,k2
            IF (pbl(ideep(il), ij) .LT. SUM(grid_height(ideep(il), ij, &
&               k1:ik))) GOTO 100
          END DO ikloop
          GOTO 110
 100      pbli(il) = ik
 110      IF (pbli(il) .EQ. 0) THEN
            GOTO 120
          ELSE
            pbli(il) = k2 - pbli(il)
          END IF
        END DO
itdtcloop:DO itdt_conv=1,num_conv_steps
          DO ic=1,num_species
            qq_tl(:, k2:k1:-1, ic) = concentration_tl(ic)%parray3d(:, ij&
&             , k1:k2)
            qq(:, k2:k1:-1, ic) = concentration(ic)%parray3d(:, ij, k1:&
&             k2)
          END DO
          CALL CONVECTIVETRANSPORT_TLM(il2g, tdt_conv, xmbsth, ideep, &
&                                pbli, dui, eui, mui, mdi, dpi, fracis, &
&                                qq, qq_tl, isfixedconcentration, i1, i2&
&                                , k1, k2, ilong, num_species)
          DO ic=1,num_species
            concentration_tl(ic)%parray3d(:, ij, k1:k2) = qq_tl(:, k2:k1&
&             :-1, ic)
            concentration(ic)%parray3d(:, ij, k1:k2) = qq(:, k2:k1:-1, &
&             ic)
          END DO
        END DO itdtcloop
      END IF
    END DO ijloop
    RETURN
 120 err_msg = 'Could not find pbl in doGenericConvectiveTransport.'
    PRINT*, err_msg
    STOP
  END SUBROUTINE DOGENERICCONVECTIVETRANSPORT_TLM
  SUBROUTINE DOGENERICCONVECTIVETRANSPORT(det_ent, do_downdraft, pbl, &
&   cldmas, dtrn, eu, ed, md, grid_height, mass, kel, press3e, &
&   concentration, isfixedconcentration, mcor, tdt, i1, i2, j1, j2, k1, &
&   k2, ilong, ivert, num_species)
    IMPLICIT NONE
!
! !INPUT PARAMETER:
    INTEGER, INTENT(IN) :: i1, i2, j1, j2, k1, k2
    INTEGER, INTENT(IN) :: ilong, ivert, num_species
    LOGICAL, INTENT(IN) :: isfixedconcentration(:)
! flag for doing detrainment then entrainment
    LOGICAL, INTENT(IN) :: det_ent
! flag for doing downdrafts
    LOGICAL, INTENT(IN) :: do_downdraft
! model time step  (s)
    REAL*8, INTENT(IN) :: tdt
! area of each grid box (m^2)
    REAL*8, INTENT(IN) :: mcor(i1:i2, j1:j2)
! planetary boundary layer thickness (m)
    REAL*8, INTENT(IN) :: pbl(i1:i2, j1:j2)
! convective mass flux in     updraft (kg/m^2/s)
    REAL*8, INTENT(IN) :: cldmas(i1:i2, j1:j2, k1:k2)
! detrainment rate (DAO:kg/m^2*s, NCAR:s^-1)
    REAL*8, INTENT(IN) :: dtrn(i1:i2, j1:j2, k1:k2)
! ntrainment into convective updraft (s^-1)
    REAL*8, INTENT(IN) :: eu(i1:i2, j1:j2, k1:k2)
! entrainment into convective downdraft (s^-1)
    REAL*8, INTENT(IN) :: ed(i1:i2, j1:j2, k1:k2)
! convective mass flux in downdraft (kg/m^2/s)
    REAL*8, INTENT(IN) :: md(i1:i2, j1:j2, k1:k2)
! grid box height  (m)
    REAL*8, INTENT(IN) :: grid_height(i1:i2, j1:j2, k1:k2)
! mass of air in each grid box (kg)
    REAL*8, INTENT(IN) :: mass(i1:i2, j1:j2, k1:k2)
! temperature      (degK)
    REAL*8, INTENT(IN) :: kel(i1:i2, j1:j2, k1:k2)
! atmospheric pressure at the edge of each grid box (mb)
    REAL*8, INTENT(IN) :: press3e(i1:i2, j1:j2, k1-1:k2)
!
! !INPUT/OUTPUT PARAMETERS:
! species concentration, known at zone centers (mixing ratio)
    TYPE(T_GMIARRAYBUNDLE), INTENT(INOUT) :: concentration(num_species)
!
! !DEFINED PARAMETERS:
! threshold below which we treat 
    REAL*8, PARAMETER :: mbsth=1.0d-15
! mass fluxes as zero (mb/s)
! mean surface gravity accel. (m/s^2)
    REAL*8, PARAMETER :: gmi_g=9.81d0
! pascals  per millibar
    REAL*8, PARAMETER :: paspmb=100.00d0
!
! !DESCRIPTION:
! This is the interface routine to Convective Transport.  
! It formats the gem variables to satisfy the Convective Transport routine.
!
!EOP
!------------------------------------------------------------------------
!BOC
!
! !LOCAL VARIABLES:
    CHARACTER(len=75) :: err_msg
    INTEGER :: iku
    INTEGER :: il, ij, ik, ic
! gathered index to operate over
    INTEGER :: il2g
    INTEGER :: itdt_conv
    INTEGER :: num_conv_steps
    REAL*8 :: rnum_conv_steps
    REAL*8 :: tdt_conv
    REAL*8 :: xmbsth
! gathering array
    INTEGER :: ideep(ilong)
! index of pbl height
    INTEGER :: pbli(ilong)
! velocity in convective updraft
    REAL*8 :: updraft_velocity(i1:i2)
! (m/s)
! delta pressure between interfaces
    REAL*8 :: dpi(ilong, k1:k2)
! mass detraining from updraft
    REAL*8 :: dui(ilong, k1:k2)
! mass entraining into updraft
    REAL*8 :: eui(ilong, k1:k2)
! mass flux up
    REAL*8 :: mui(ilong, k1:k2)
! mass flux down
    REAL*8 :: mdi(ilong, k1:k2)
! insoluble fraction of tracer
    REAL*8 :: fracis(i1:i2, k1:k2, num_species)
! tracer array including moisture
    REAL*8 :: qq(i1:i2, k1:k2, num_species)
    INTRINSIC MAXVAL
    INTRINSIC INT
    INTRINSIC REAL
    INTRINSIC MAX
    INTRINSIC SUM
    REAL*8 :: result1
    REAL*8, DIMENSION(i2-i1+1, j2-j1+1, k2-k1+1) :: arg1
    REAL*8 :: result2
    ideep(:) = 0
    pbli(:) = 0
    dpi(:, :) = 0.0d0
    dui(:, :) = 0.0d0
    eui(:, :) = 0.0d0
    mui(:, :) = 0.0d0
    mdi(:, :) = 0.0d0
    fracis(:, :, :) = 0.0d0
    xmbsth = mbsth
    updraft_velocity(:) = 0.0d0
! -----------------------------------------------------------
! Calculate any needed sub-cycling of the convection operator
! by comparing the mass flux over the full time step to the
! mass within the grid box.
! -----------------------------------------------------------
    result1 = SPREAD(mcor(:, :), 3, k2 - k1 + 1)
    arg1(:, :, :) = tdt*cldmas(:, :, :)*result1/mass(:, :, :)
    result2 = MAXVAL(arg1(:, :, :))
    num_conv_steps = INT(result2 + 1.0d0)
    rnum_conv_steps = REAL(num_conv_steps, 8)
    tdt_conv = tdt/rnum_conv_steps
ijloop:DO ij=j1,j2
      il2g = 0
illoop:DO il=i1,i2
! ----------------------------------------------------
! Verify that there is convection in the current cell.
! ----------------------------------------------------
        result1 = MAXVAL(cldmas(il, ij, :))
        IF (result1 .GE. 0.0d0) THEN
          il2g = il2g + 1
          ideep(il2g) = il
          dpi(il2g, :) = (press3e(il, ij, k2-1:k1-1:-1)-press3e(il, ij, &
&           k2:k1:-1))*paspmb
          mui(il2g, :) = cldmas(il, ij, k2:k1:-1)*gmi_g
          WHERE (0.0d0 .LT. cldmas(il, ij, k2-1:k1+1:-1) - cldmas(il, ij&
&             , k2-2:k1:-1) + dtrn(il, ij, k2-1:k1+1:-1)) 
            eui(il2g, k1+1:k2-1) = cldmas(il, ij, k2-1:k1+1:-1) - cldmas&
&             (il, ij, k2-2:k1:-1) + dtrn(il, ij, k2-1:k1+1:-1)
          ELSEWHERE
            eui(il2g, k1+1:k2-1) = 0.0d0
          END WHERE
          eui(il2g, :) = eui(il2g, :)*gmi_g
          IF (det_ent) dui(il2g, :) = dtrn(il, ij, k2:k1:-1)*gmi_g
        END IF
      END DO illoop
      IF (il2g .NE. 0) THEN
        fracis(:, :, :) = 1.0d0
! ----------------------------------------------------------------
! Find the index of the top of the planetary boundary layer (pbl).
! Convection will assume well mixed tracers below that level.
! ----------------------------------------------------------------
        DO il=1,il2g
          pbli(il) = 0
   ikloop:DO ik=k1,k2
            IF (pbl(ideep(il), ij) .LT. SUM(grid_height(ideep(il), ij, &
&               k1:ik))) THEN
              pbli(il) = ik
              GOTO 100
            END IF
          END DO ikloop
 100      IF (pbli(il) .EQ. 0) THEN
            err_msg = &
&             'Could not find pbl in doGenericConvectiveTransport.'
            PRINT*, err_msg
            STOP
          ELSE
            pbli(il) = k2 - pbli(il)
          END IF
        END DO
itdtcloop:DO itdt_conv=1,num_conv_steps
          DO ic=1,num_species
            qq(:, k2:k1:-1, ic) = concentration(ic)%parray3d(:, ij, k1:&
&             k2)
          END DO
          CALL CONVECTIVETRANSPORT(il2g, tdt_conv, xmbsth, ideep, pbli, &
&                            dui, eui, mui, mdi, dpi, fracis, qq, &
&                            isfixedconcentration, i1, i2, k1, k2, ilong&
&                            , num_species)
          DO ic=1,num_species
            concentration(ic)%parray3d(:, ij, k1:k2) = qq(:, k2:k1:-1, &
&             ic)
          END DO
        END DO itdtcloop
      END IF
    END DO ijloop
    RETURN
  END SUBROUTINE DOGENERICCONVECTIVETRANSPORT
END MODULE GENERICCONVECTIONMETHOD_MOD_D
