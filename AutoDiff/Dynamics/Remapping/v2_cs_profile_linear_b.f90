!        Generated by TAPENADE     (INRIA, Tropics team)
!  Tapenade 3.9 (r5096) - 24 Feb 2014 16:53
!
!  Differentiation of v2_cs_profile_linear in reverse (adjoint) mode:
!   gradient     of useful results: a4
!   with respect to varying inputs: delp a4
!   RW status of diff variables: delp:out a4:in-out
SUBROUTINE V2_CS_PROFILE_LINEAR_B(a4, a4b, delp, delpb, km, i1, i2, iv)
  IMPLICIT NONE
! A perfectly linear version of the vertical remapping algorithm
! Warning: not for general purpose; non-monotonic
! Latest: 20141211 S.-J. Lin, NOAA/GFDL
  INTEGER, INTENT(IN) :: i1, i2
! vertical dimension
  INTEGER, INTENT(IN) :: km
! iv =-1: winds
  INTEGER, INTENT(IN) :: iv
! iv = 0: positive definite scalars
! iv = 1: others
! layer pressure thickness
  REAL, INTENT(IN) :: delp(i1:i2, km)
  REAL :: delpb(i1:i2, km)
! Interpolated values
  REAL, INTENT(INOUT) :: a4(4, i1:i2, km)
  REAL, INTENT(INOUT) :: a4b(4, i1:i2, km)
!-----------------------------------------------------------------------
  REAL :: gam(i1:i2, km)
  REAL :: gamb(i1:i2, km)
  REAL :: q(i1:i2, km+1)
  REAL :: qb(i1:i2, km+1)
  REAL :: d4(i1:i2)
  REAL :: d4b(i1:i2)
  REAL :: bet, a_bot, grat
  REAL :: betb, a_botb, gratb
  INTEGER :: i, k
  REAL :: temp1
  REAL :: temp0
  REAL :: tempb9
  REAL :: tempb8
  REAL :: tempb7
  REAL :: tempb6
  REAL :: tempb5
  REAL :: tempb4
  REAL :: tempb3
  REAL :: tempb2
  REAL :: tempb1
  REAL :: tempb0
  REAL :: tempb
  REAL :: temp
  DO i=i1,i2
! grid ratio
    grat = delp(i, 2)/delp(i, 1)
    bet = grat*(grat+0.5)
    q(i, 1) = ((grat+grat)*(grat+1.)*a4(1, i, 1)+a4(1, i, 2))/bet
    gam(i, 1) = (1.+grat*(grat+1.5))/bet
  END DO
  DO k=2,km
    DO i=i1,i2
      CALL PUSHREAL4(d4(i))
      d4(i) = delp(i, k-1)/delp(i, k)
      CALL PUSHREAL4(bet)
      bet = 2. + d4(i) + d4(i) - gam(i, k-1)
      CALL PUSHREAL4(q(i, k))
      q(i, k) = (3.*(a4(1, i, k-1)+d4(i)*a4(1, i, k))-q(i, k-1))/bet
      gam(i, k) = d4(i)/bet
    END DO
  END DO
  DO i=i1,i2
    a_bot = 1. + d4(i)*(d4(i)+1.5)
    CALL PUSHREAL4(q(i, km+1))
    q(i, km+1) = (2.*d4(i)*(d4(i)+1.)*a4(1, i, km)+a4(1, i, km-1)-a_bot*&
&     q(i, km))/(d4(i)*(d4(i)+0.5)-a_bot*gam(i, km))
  END DO
  DO k=km,1,-1
    DO i=i1,i2
      CALL PUSHREAL4(q(i, k))
      q(i, k) = q(i, k) - gam(i, k)*q(i, k+1)
    END DO
  END DO
  qb = 0.0
  DO k=km,1,-1
    DO i=i2,i1,-1
      tempb9 = 3.*a4b(4, i, k)
      a4b(1, i, k) = a4b(1, i, k) + 2.*tempb9
      a4b(2, i, k) = a4b(2, i, k) - tempb9
      a4b(3, i, k) = a4b(3, i, k) - tempb9
      a4b(4, i, k) = 0.0
      qb(i, k+1) = qb(i, k+1) + a4b(3, i, k)
      a4b(3, i, k) = 0.0
      qb(i, k) = qb(i, k) + a4b(2, i, k)
      a4b(2, i, k) = 0.0
    END DO
  END DO
  gamb = 0.0
  DO k=1,km,1
    DO i=i2,i1,-1
      CALL POPREAL4(q(i, k))
      gamb(i, k) = gamb(i, k) - q(i, k+1)*qb(i, k)
      qb(i, k+1) = qb(i, k+1) - gam(i, k)*qb(i, k)
    END DO
  END DO
  d4b = 0.0
  DO i=i2,i1,-1
    a_bot = 1. + d4(i)*(d4(i)+1.5)
    CALL POPREAL4(q(i, km+1))
    temp1 = d4(i)*(d4(i)+0.5) - a_bot*gam(i, km)
    tempb6 = qb(i, km+1)/temp1
    temp0 = d4(i)*(d4(i)+1.)
    tempb7 = 2.*a4(1, i, km)*tempb6
    tempb8 = -((2.*(temp0*a4(1, i, km))+a4(1, i, km-1)-a_bot*q(i, km))*&
&     tempb6/temp1)
    a4b(1, i, km) = a4b(1, i, km) + 2.*temp0*tempb6
    a4b(1, i, km-1) = a4b(1, i, km-1) + tempb6
    a_botb = -(gam(i, km)*tempb8) - q(i, km)*tempb6
    d4b(i) = d4b(i) + (2*d4(i)+1.5)*a_botb + (2*d4(i)+0.5)*tempb8 + (2*&
&     d4(i)+1.)*tempb7
    qb(i, km) = qb(i, km) - a_bot*tempb6
    gamb(i, km) = gamb(i, km) - a_bot*tempb8
    qb(i, km+1) = 0.0
  END DO
  delpb = 0.0
  DO k=km,2,-1
    DO i=i2,i1,-1
      tempb4 = qb(i, k)/bet
      tempb3 = 3.*tempb4
      CALL POPREAL4(q(i, k))
      betb = -((3.*(a4(1, i, k-1)+d4(i)*a4(1, i, k))-q(i, k-1))*tempb4/&
&       bet) - d4(i)*gamb(i, k)/bet**2
      d4b(i) = d4b(i) + a4(1, i, k)*tempb3 + 2*betb + gamb(i, k)/bet
      gamb(i, k) = 0.0
      a4b(1, i, k-1) = a4b(1, i, k-1) + tempb3
      a4b(1, i, k) = a4b(1, i, k) + d4(i)*tempb3
      qb(i, k-1) = qb(i, k-1) - tempb4
      qb(i, k) = 0.0
      CALL POPREAL4(bet)
      gamb(i, k-1) = gamb(i, k-1) - betb
      CALL POPREAL4(d4(i))
      tempb5 = d4b(i)/delp(i, k)
      delpb(i, k-1) = delpb(i, k-1) + tempb5
      delpb(i, k) = delpb(i, k) - delp(i, k-1)*tempb5/delp(i, k)
      d4b(i) = 0.0
    END DO
  END DO
  DO i=i2,i1,-1
    grat = delp(i, 2)/delp(i, 1)
    bet = grat*(grat+0.5)
    tempb = gamb(i, 1)/bet
    gamb(i, 1) = 0.0
    tempb1 = qb(i, 1)/bet
    tempb0 = a4(1, i, 1)*tempb1
    temp = 2*grat*(grat+1.)
    betb = -((temp*a4(1, i, 1)+a4(1, i, 2))*tempb1/bet) - (grat*(grat+&
&     1.5)+1.)*tempb/bet
    gratb = (4*grat+2*1.)*tempb0 + (2*grat+0.5)*betb + (2*grat+1.5)*&
&     tempb
    a4b(1, i, 1) = a4b(1, i, 1) + temp*tempb1
    a4b(1, i, 2) = a4b(1, i, 2) + tempb1
    qb(i, 1) = 0.0
    tempb2 = gratb/delp(i, 1)
    delpb(i, 2) = delpb(i, 2) + tempb2
    delpb(i, 1) = delpb(i, 1) - delp(i, 2)*tempb2/delp(i, 1)
  END DO
END SUBROUTINE V2_CS_PROFILE_LINEAR_B

