!        Generated by TAPENADE     (INRIA, Tropics team)
!  Tapenade 3.9 (r5096) - 24 Feb 2014 16:53
!
!  Differentiation of v2_cs_profile_linear in forward (tangent) mode:
!   variations   of useful results: a4
!   with respect to varying inputs: delp a4
!   RW status of diff variables: delp:in a4:in-out
SUBROUTINE V2_CS_PROFILE_LINEAR_D(a4, a4d, delp, delpd, km, i1, i2, iv)
  IMPLICIT NONE
! A perfectly linear version of the vertical remapping algorithm
! Warning: not for general purpose; non-monotonic
! Latest: 20141211 S.-J. Lin, NOAA/GFDL
  INTEGER, INTENT(IN) :: i1, i2
! vertical dimension
  INTEGER, INTENT(IN) :: km
! iv =-1: winds
  INTEGER, INTENT(IN) :: iv
! iv = 0: positive definite scalars
! iv = 1: others
! layer pressure thickness
  REAL, INTENT(IN) :: delp(i1:i2, km)
  REAL, INTENT(IN) :: delpd(i1:i2, km)
! Interpolated values
  REAL, INTENT(INOUT) :: a4(4, i1:i2, km)
  REAL, INTENT(INOUT) :: a4d(4, i1:i2, km)
!-----------------------------------------------------------------------
  REAL :: gam(i1:i2, km)
  REAL :: gamd(i1:i2, km)
  REAL :: q(i1:i2, km+1)
  REAL :: qd(i1:i2, km+1)
  REAL :: d4(i1:i2)
  REAL :: d4d(i1:i2)
  REAL :: bet, a_bot, grat
  REAL :: betd, a_botd, gratd
  INTEGER :: i, k
  qd = 0.0
  gamd = 0.0
  DO i=i1,i2
! grid ratio
    gratd = (delpd(i, 2)*delp(i, 1)-delp(i, 2)*delpd(i, 1))/delp(i, 1)**&
&     2
    grat = delp(i, 2)/delp(i, 1)
    betd = gratd*(grat+0.5) + grat*gratd
    bet = grat*(grat+0.5)
    qd(i, 1) = (((2*gratd*(grat+1.)+(grat+grat)*gratd)*a4(1, i, 1)+(grat&
&     +grat)*(grat+1.)*a4d(1, i, 1)+a4d(1, i, 2))*bet-((grat+grat)*(grat&
&     +1.)*a4(1, i, 1)+a4(1, i, 2))*betd)/bet**2
    q(i, 1) = ((grat+grat)*(grat+1.)*a4(1, i, 1)+a4(1, i, 2))/bet
    gamd(i, 1) = ((gratd*(grat+1.5)+grat*gratd)*bet-(1.+grat*(grat+1.5))&
&     *betd)/bet**2
    gam(i, 1) = (1.+grat*(grat+1.5))/bet
  END DO
  d4d = 0.0
  DO k=2,km
    DO i=i1,i2
      d4d(i) = (delpd(i, k-1)*delp(i, k)-delp(i, k-1)*delpd(i, k))/delp(&
&       i, k)**2
      d4(i) = delp(i, k-1)/delp(i, k)
      betd = 2*d4d(i) - gamd(i, k-1)
      bet = 2. + d4(i) + d4(i) - gam(i, k-1)
      qd(i, k) = ((3.*(a4d(1, i, k-1)+d4d(i)*a4(1, i, k)+d4(i)*a4d(1, i&
&       , k))-qd(i, k-1))*bet-(3.*(a4(1, i, k-1)+d4(i)*a4(1, i, k))-q(i&
&       , k-1))*betd)/bet**2
      q(i, k) = (3.*(a4(1, i, k-1)+d4(i)*a4(1, i, k))-q(i, k-1))/bet
      gamd(i, k) = (d4d(i)*bet-d4(i)*betd)/bet**2
      gam(i, k) = d4(i)/bet
    END DO
  END DO
  DO i=i1,i2
    a_botd = d4d(i)*(d4(i)+1.5) + d4(i)*d4d(i)
    a_bot = 1. + d4(i)*(d4(i)+1.5)
    qd(i, km+1) = ((2.*((d4d(i)*(d4(i)+1.)+d4(i)*d4d(i))*a4(1, i, km)+d4&
&     (i)*(d4(i)+1.)*a4d(1, i, km))+a4d(1, i, km-1)-a_botd*q(i, km)-&
&     a_bot*qd(i, km))*(d4(i)*(d4(i)+0.5)-a_bot*gam(i, km))-(2.*d4(i)*(&
&     d4(i)+1.)*a4(1, i, km)+a4(1, i, km-1)-a_bot*q(i, km))*(d4d(i)*(d4(&
&     i)+0.5)+d4(i)*d4d(i)-a_botd*gam(i, km)-a_bot*gamd(i, km)))/(d4(i)*&
&     (d4(i)+0.5)-a_bot*gam(i, km))**2
    q(i, km+1) = (2.*d4(i)*(d4(i)+1.)*a4(1, i, km)+a4(1, i, km-1)-a_bot*&
&     q(i, km))/(d4(i)*(d4(i)+0.5)-a_bot*gam(i, km))
  END DO
  DO k=km,1,-1
    DO i=i1,i2
      qd(i, k) = qd(i, k) - gamd(i, k)*q(i, k+1) - gam(i, k)*qd(i, k+1)
      q(i, k) = q(i, k) - gam(i, k)*q(i, k+1)
    END DO
  END DO
  DO k=1,km
    DO i=i1,i2
      a4d(2, i, k) = qd(i, k)
      a4(2, i, k) = q(i, k)
      a4d(3, i, k) = qd(i, k+1)
      a4(3, i, k) = q(i, k+1)
      a4d(4, i, k) = 3.*(2.*a4d(1, i, k)-a4d(2, i, k)-a4d(3, i, k))
      a4(4, i, k) = 3.*(2.*a4(1, i, k)-(a4(2, i, k)+a4(3, i, k)))
    END DO
  END DO
END SUBROUTINE V2_CS_PROFILE_LINEAR_D

