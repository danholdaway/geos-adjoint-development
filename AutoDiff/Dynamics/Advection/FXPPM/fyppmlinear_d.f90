!        Generated by TAPENADE     (INRIA, Tropics team)
!  Tapenade 3.9 (r5096) - 24 Feb 2014 16:53
!
!  Differentiation of fyppmlinear in forward (tangent) mode:
!   variations   of useful results: flux
!   with respect to varying inputs: q c
!   RW status of diff variables: dm:(loc) q:in flux:out c:in
SUBROUTINE FYPPMLINEAR_D(c, cd, q, qd, flux, fluxd, jord, ifirst, ilast&
& , jfirst, jlast, npx, npy, dm, dmd, ppm_limiter, dya, isd, ied)
  IMPLICIT NONE
! !INPUT PARAMETERS:
!  X-Dir strip
  INTEGER, INTENT(IN) :: ifirst, ilast
!  Y-Dir strip
  INTEGER, INTENT(IN) :: jfirst, jlast
  INTEGER, INTENT(IN) :: jord
  INTEGER, INTENT(IN) :: npx, npy
  REAL, INTENT(IN) :: q(ifirst:ilast, jfirst-ng:jlast+ng)
  REAL, INTENT(IN) :: qd(ifirst:ilast, jfirst-ng:jlast+ng)
  INTEGER :: ied
  INTEGER :: isd
! Courant number
  REAL, INTENT(IN) :: c(isd:ied, js:je+1)
  REAL, INTENT(IN) :: cd(isd:ied, js:je+1)
  REAL, INTENT(IN) :: ppm_limiter
  REAL, INTENT(IN) :: dya(:, :)
! !OUTPUT PARAMETERS:
!  Flux
  REAL, INTENT(OUT) :: flux(ifirst:ilast, jfirst:jlast+1)
  REAL, INTENT(OUT) :: fluxd(ifirst:ilast, jfirst:jlast+1)
  REAL, INTENT(OUT) :: dm(ifirst:ilast, jfirst-2:jlast+2)
  REAL, INTENT(OUT) :: dmd(ifirst:ilast, jfirst-2:jlast+2)
! Local:
  REAL :: al(ifirst:ilast, jfirst-1:jlast+2)
  REAL :: ald(ifirst:ilast, jfirst-1:jlast+2)
  REAL :: bl(ifirst:ilast, jfirst-1:jlast+1)
  REAL :: bld(ifirst:ilast, jfirst-1:jlast+1)
  REAL :: br(ifirst:ilast, jfirst-1:jlast+1)
  REAL :: brd(ifirst:ilast, jfirst-1:jlast+1)
  REAL :: dq(ifirst:ilast, jfirst-3:jlast+2)
  REAL :: dl, dr, pmp, lac, ct, qe
  REAL :: xt, x0, x1
  REAL :: xtd
  INTEGER :: i, j, js3, je3, je2, jt
!dummy
  INTEGER, PARAMETER :: je=10, js=10
  INTEGER, PARAMETER :: ng=3
  INTEGER, PARAMETER :: grid_type=0
  INTRINSIC MAX
  INTRINSIC MIN
  INTRINSIC ABS
  INTRINSIC SIGN
  REAL :: min5d
  REAL :: x6d
  REAL :: y4d
  REAL :: min6
  REAL :: min5
  REAL :: min4
  REAL :: min3
  REAL :: min2
  REAL :: min1
  REAL :: x6
  REAL :: x5
  REAL :: min1d
  REAL :: x4
  REAL :: x3
  REAL :: x2
  REAL :: x2d
  REAL :: min4d
  REAL :: x5d
  REAL :: y3d
  REAL :: z1d
  REAL :: max1d
  REAL :: min3d
  REAL :: x4d
  REAL :: z1
  REAL :: y2d
  REAL :: min6d
  REAL :: y5d
  REAL :: max1
  REAL :: y5
  REAL :: min2d
  REAL :: y4
  REAL :: y3
  REAL :: y2
  REAL :: x3d
  REAL :: y1
  REAL :: y1d
  IF (3 .LT. js - 1) THEN
    js3 = js - 1
  ELSE
    js3 = 3
  END IF
  IF (npy - 3 .GT. je + 1) THEN
    je3 = je + 1
  ELSE
    je3 = npy - 3
  END IF
  IF (npy - 2 .GT. je + 2) THEN
    je2 = je + 2
  ELSE
    je2 = npy - 2
  END IF
  dmd = 0.0
  DO j=js-2,je+2
    DO i=ifirst,ilast
      xtd = 0.25*(qd(i, j+1)-qd(i, j-1))
      xt = 0.25*(q(i, j+1)-q(i, j-1))
      IF (xt .GE. 0.) THEN
        x2d = xtd
        x2 = xt
      ELSE
        x2d = -xtd
        x2 = -xt
      END IF
      IF (q(i, j-1) .LT. q(i, j)) THEN
        IF (q(i, j) .LT. q(i, j+1)) THEN
          max1d = qd(i, j+1)
          max1 = q(i, j+1)
        ELSE
          max1d = qd(i, j)
          max1 = q(i, j)
        END IF
      ELSE IF (q(i, j-1) .LT. q(i, j+1)) THEN
        max1d = qd(i, j+1)
        max1 = q(i, j+1)
      ELSE
        max1d = qd(i, j-1)
        max1 = q(i, j-1)
      END IF
      y1d = max1d - qd(i, j)
      y1 = max1 - q(i, j)
      IF (q(i, j-1) .GT. q(i, j)) THEN
        IF (q(i, j) .GT. q(i, j+1)) THEN
          min6d = qd(i, j+1)
          min6 = q(i, j+1)
        ELSE
          min6d = qd(i, j)
          min6 = q(i, j)
        END IF
      ELSE IF (q(i, j-1) .GT. q(i, j+1)) THEN
        min6d = qd(i, j+1)
        min6 = q(i, j+1)
      ELSE
        min6d = qd(i, j-1)
        min6 = q(i, j-1)
      END IF
      z1d = qd(i, j) - min6d
      z1 = q(i, j) - min6
      IF (x2 .GT. y1) THEN
        IF (y1 .GT. z1) THEN
          min1d = z1d
          min1 = z1
        ELSE
          min1d = y1d
          min1 = y1
        END IF
      ELSE IF (x2 .GT. z1) THEN
        min1d = z1d
        min1 = z1
      ELSE
        min1d = x2d
        min1 = x2
      END IF
      dmd(i, j) = min1d*SIGN(1.d0, min1*xt)
      dm(i, j) = SIGN(min1, xt)
    END DO
  END DO
  IF (grid_type .LT. 3) THEN
    ald = 0.0
    DO j=js3,je2
      DO i=ifirst,ilast
!al(i,j) = 0.5*(q(i,j-1)+q(i,j)) + r3*(dm(i,j-1) - dm(i,j))
        ald(i, j) = 7.0*(qd(i, j-1)+qd(i, j))/12.0 - (qd(i, j+1)+qd(i, j&
&         -2))/12.0
        al(i, j) = 7.0/12.0*(q(i, j-1)+q(i, j)) - 1.0/12.0*(q(i, j+1)+q(&
&         i, j-2))
      END DO
    END DO
    bld = 0.0
    brd = 0.0
    DO j=js3,je3
      DO i=ifirst,ilast
        xtd = 2.*dmd(i, j)
        xt = 2.*dm(i, j)
        IF (xt .GE. 0.) THEN
          x3d = xtd
          x3 = xt
        ELSE
          x3d = -xtd
          x3 = -xt
        END IF
        IF (al(i, j) - q(i, j) .GE. 0.) THEN
          y2d = ald(i, j) - qd(i, j)
          y2 = al(i, j) - q(i, j)
        ELSE
          y2d = -(ald(i, j)-qd(i, j))
          y2 = -(al(i, j)-q(i, j))
        END IF
        IF (x3 .GT. y2) THEN
          min2d = y2d
          min2 = y2
        ELSE
          min2d = x3d
          min2 = x3
        END IF
        bld(i, j) = -(min2d*SIGN(1.d0, min2*xt))
        bl(i, j) = -SIGN(min2, xt)
        IF (xt .GE. 0.) THEN
          x4d = xtd
          x4 = xt
        ELSE
          x4d = -xtd
          x4 = -xt
        END IF
        IF (al(i, j+1) - q(i, j) .GE. 0.) THEN
          y3d = ald(i, j+1) - qd(i, j)
          y3 = al(i, j+1) - q(i, j)
        ELSE
          y3d = -(ald(i, j+1)-qd(i, j))
          y3 = -(al(i, j+1)-q(i, j))
        END IF
        IF (x4 .GT. y3) THEN
          min3d = y3d
          min3 = y3
        ELSE
          min3d = x4d
          min3 = x4
        END IF
        brd(i, j) = min3d*SIGN(1.d0, min3*xt)
        br(i, j) = SIGN(min3, xt)
      END DO
    END DO
!--------------
! Fix the edges:
!--------------
    IF (js .EQ. 1) THEN
      DO i=ifirst,ilast
        brd(i, 2) = ald(i, 3) - qd(i, 2)
        br(i, 2) = al(i, 3) - q(i, 2)
!           xt = t11*(q(i,0)+q(i,1)) + t12*(q(i,-1)+q(i,2))   &
!              + t13*(dm(i,2)-dm(i,-1))
!!!         xt = 0.75*(q(i,0)+q(i,1)) - 0.25*(q(i,-1)+q(i,2))
        xtd = 0.5*((2.*dya(i, 1)+dya(i, 2))*(qd(i, 0)+qd(i, 1))-dya(i, 1&
&         )*(qd(i, -1)+qd(i, 2)))/(dya(i, 1)+dya(i, 2))
        xt = 0.5*((2.*dya(i, 1)+dya(i, 2))*(q(i, 0)+q(i, 1))-dya(i, 1)*(&
&         q(i, -1)+q(i, 2)))/(dya(i, 1)+dya(i, 2))
        IF (0. .LT. xt) THEN
          xt = xt
        ELSE
          xt = 0.
          xtd = 0.0
        END IF
        bld(i, 1) = xtd - qd(i, 1)
        bl(i, 1) = xt - q(i, 1)
        brd(i, 0) = xtd - qd(i, 0)
        br(i, 0) = xt - q(i, 0)
        xtd = 4.*dmd(i, -1)/7. + 11.*qd(i, -1)/14. + 3.*qd(i, 0)/14.
        xt = 4./7.*dm(i, -1) + 11./14.*q(i, -1) + 3./14.*q(i, 0)
        IF (0. .LT. xt) THEN
          xt = xt
        ELSE
          xt = 0.
          xtd = 0.0
        END IF
        bld(i, 0) = xtd - qd(i, 0)
        bl(i, 0) = xt - q(i, 0)
        xtd = 3.*qd(i, 1)/14. + 11.*qd(i, 2)/14. - 4.*dmd(i, 2)/7.
        xt = 3./14.*q(i, 1) + 11./14.*q(i, 2) - 4./7.*dm(i, 2)
        IF (0. .LT. xt) THEN
          xt = xt
        ELSE
          xt = 0.
          xtd = 0.0
        END IF
        brd(i, 1) = xtd - qd(i, 1)
        br(i, 1) = xt - q(i, 1)
        bld(i, 2) = xtd - qd(i, 2)
        bl(i, 2) = xt - q(i, 2)
      END DO
      DO j=0,2
        CALL PERT_PPM_DH_D(ilast - ifirst + 1, q(ifirst:, j), bl(ifirst:&
&                    , j), bld(ifirst:, j), br(ifirst:, j), brd(ifirst:&
&                    , j), 1)
      END DO
    END IF
    IF (je + 1 .EQ. npy) THEN
      DO i=ifirst,ilast
        bld(i, npy-2) = ald(i, npy-2) - qd(i, npy-2)
        bl(i, npy-2) = al(i, npy-2) - q(i, npy-2)
!           xt = t11*(q(i,npy-1)+q(i,npy)) + t12*(q(i,npy-2)+q(i,npy+1))   &
!               + t13*(dm(i,npy+1)-dm(i,npy-2))
!!!         xt = 0.75*(q(i,npy-1)+q(i,npy)) - 0.25*(q(i,npy-2)+q(i,npy+1))
        xtd = 0.5*((2.*dya(i, npy-1)+dya(i, npy-2))*(qd(i, npy-1)+qd(i, &
&         npy))-dya(i, npy-1)*(qd(i, npy-2)+qd(i, npy+1)))/(dya(i, npy-1&
&         )+dya(i, npy-2))
        xt = 0.5*((2.*dya(i, npy-1)+dya(i, npy-2))*(q(i, npy-1)+q(i, npy&
&         ))-dya(i, npy-1)*(q(i, npy-2)+q(i, npy+1)))/(dya(i, npy-1)+dya&
&         (i, npy-2))
        IF (0. .LT. xt) THEN
          xt = xt
        ELSE
          xt = 0.
          xtd = 0.0
        END IF
        brd(i, npy-1) = xtd - qd(i, npy-1)
        br(i, npy-1) = xt - q(i, npy-1)
        bld(i, npy) = xtd - qd(i, npy)
        bl(i, npy) = xt - q(i, npy)
        xtd = 3.*qd(i, npy)/14. + 11.*qd(i, npy+1)/14. - 4.*dmd(i, npy+1&
&         )/7.
        xt = 3./14.*q(i, npy) + 11./14.*q(i, npy+1) - 4./7.*dm(i, npy+1)
        IF (0. .LT. xt) THEN
          xt = xt
        ELSE
          xt = 0.
          xtd = 0.0
        END IF
        brd(i, npy) = xtd - qd(i, npy)
        br(i, npy) = xt - q(i, npy)
        xtd = 3.*qd(i, npy-1)/14. + 11.*qd(i, npy-2)/14. + 4.*dmd(i, npy&
&         -2)/7.
        xt = 3./14.*q(i, npy-1) + 11./14.*q(i, npy-2) + 4./7.*dm(i, npy-&
&         2)
        IF (0. .LT. xt) THEN
          xt = xt
        ELSE
          xt = 0.
          xtd = 0.0
        END IF
        brd(i, npy-2) = xtd - qd(i, npy-2)
        br(i, npy-2) = xt - q(i, npy-2)
        bld(i, npy-1) = xtd - qd(i, npy-1)
        bl(i, npy-1) = xt - q(i, npy-1)
      END DO
      DO j=npy-2,npy
        CALL PERT_PPM_DH_D(ilast - ifirst + 1, q(ifirst:, j), bl(ifirst:&
&                    , j), bld(ifirst:, j), br(ifirst:, j), brd(ifirst:&
&                    , j), 1)
      END DO
      fluxd = 0.0
    ELSE
      fluxd = 0.0
    END IF
  ELSE
    ald = 0.0
    DO j=js-1,je+2
      DO i=ifirst,ilast
!al(i,j) = 0.5*(q(i,j-1)+q(i,j)) + r3*(dm(i,j-1) - dm(i,j))
        ald(i, j) = 7.0*(qd(i, j-1)+qd(i, j))/12.0 - (qd(i, j+1)+qd(i, j&
&         -2))/12.0
        al(i, j) = 7.0/12.0*(q(i, j-1)+q(i, j)) - 1.0/12.0*(q(i, j+1)+q(&
&         i, j-2))
      END DO
    END DO
    bld = 0.0
    brd = 0.0
    DO j=js-1,je+1
      DO i=ifirst,ilast
        xtd = 2.*dmd(i, j)
        xt = 2.*dm(i, j)
        IF (xt .GE. 0.) THEN
          x5d = xtd
          x5 = xt
        ELSE
          x5d = -xtd
          x5 = -xt
        END IF
        IF (al(i, j) - q(i, j) .GE. 0.) THEN
          y4d = ald(i, j) - qd(i, j)
          y4 = al(i, j) - q(i, j)
        ELSE
          y4d = -(ald(i, j)-qd(i, j))
          y4 = -(al(i, j)-q(i, j))
        END IF
        IF (x5 .GT. y4) THEN
          min4d = y4d
          min4 = y4
        ELSE
          min4d = x5d
          min4 = x5
        END IF
        bld(i, j) = -(min4d*SIGN(1.d0, min4*xt))
        bl(i, j) = -SIGN(min4, xt)
        IF (xt .GE. 0.) THEN
          x6d = xtd
          x6 = xt
        ELSE
          x6d = -xtd
          x6 = -xt
        END IF
        IF (al(i, j+1) - q(i, j) .GE. 0.) THEN
          y5d = ald(i, j+1) - qd(i, j)
          y5 = al(i, j+1) - q(i, j)
        ELSE
          y5d = -(ald(i, j+1)-qd(i, j))
          y5 = -(al(i, j+1)-q(i, j))
        END IF
        IF (x6 .GT. y5) THEN
          min5d = y5d
          min5 = y5
        ELSE
          min5d = x6d
          min5 = x6
        END IF
        brd(i, j) = min5d*SIGN(1.d0, min5*xt)
        br(i, j) = SIGN(min5, xt)
      END DO
    END DO
    fluxd = 0.0
  END IF
  DO j=js,je+1
    DO i=ifirst,ilast
      IF (c(i, j) .GT. 0.) THEN
        fluxd(i, j) = qd(i, j-1) + (1.-c(i, j))*(brd(i, j-1)-cd(i, j)*(&
&         bl(i, j-1)+br(i, j-1))-c(i, j)*(bld(i, j-1)+brd(i, j-1))) - cd&
&         (i, j)*(br(i, j-1)-c(i, j)*(bl(i, j-1)+br(i, j-1)))
        flux(i, j) = q(i, j-1) + (1.-c(i, j))*(br(i, j-1)-c(i, j)*(bl(i&
&         , j-1)+br(i, j-1)))
      ELSE
        fluxd(i, j) = qd(i, j) + cd(i, j)*(bl(i, j)+c(i, j)*(bl(i, j)+br&
&         (i, j))) + (1.+c(i, j))*(bld(i, j)+cd(i, j)*(bl(i, j)+br(i, j)&
&         )+c(i, j)*(bld(i, j)+brd(i, j)))
        flux(i, j) = q(i, j) + (1.+c(i, j))*(bl(i, j)+c(i, j)*(bl(i, j)+&
&         br(i, j)))
      END IF
    END DO
  END DO
END SUBROUTINE FYPPMLINEAR_D

!  Differentiation of pert_ppm_dh in forward (tangent) mode:
!   variations   of useful results: al ar
!   with respect to varying inputs: al ar
SUBROUTINE PERT_PPM_DH_D(im, a0, al, ald, ar, ard, iv)
  IMPLICIT NONE
  INTEGER, INTENT(IN) :: im
  INTEGER, INTENT(IN) :: iv
  REAL*4, INTENT(IN) :: a0(im)
  REAL*4, INTENT(INOUT) :: al(im), ar(im)
  REAL*4, INTENT(INOUT) :: ald(im), ard(im)
! Local:
  REAL*4 :: a4, da1, da2, a6da, fmin
  INTEGER :: i
  REAL*4, PARAMETER :: r12=1./12.
  INTRINSIC ABS
  REAL*4 :: abs0
!-----------------------------------
! Optimized PPM in perturbation form:
!-----------------------------------
  IF (iv .EQ. 0) THEN
! Positive definite constraint
    DO i=1,im
      a4 = -(3.*(ar(i)+al(i)))
      da1 = ar(i) - al(i)
      IF (da1 .GE. 0.) THEN
        abs0 = da1
      ELSE
        abs0 = -da1
      END IF
      IF (abs0 .LT. -a4) THEN
        fmin = a0(i) + 0.25/a4*da1**2 + a4*r12
        IF (fmin .LT. 0.) THEN
          IF (ar(i) .GT. 0. .AND. al(i) .GT. 0.) THEN
            ard(i) = 0.0_4
            ar(i) = 0.
            ald(i) = 0.0_4
            al(i) = 0.
          ELSE IF (da1 .GT. 0.) THEN
            ard(i) = -(2.*ald(i))
            ar(i) = -(2.*al(i))
          ELSE
            ald(i) = -(2.*ard(i))
            al(i) = -(2.*ar(i))
          END IF
        END IF
      END IF
    END DO
  ELSE
! Standard PPM constraint
    DO i=1,im
      IF (al(i)*ar(i) .LT. 0.) THEN
        da1 = al(i) - ar(i)
        da2 = da1**2
        a6da = 3.*(al(i)+ar(i))*da1
        IF (a6da .LT. -da2) THEN
          ard(i) = -(2.*ald(i))
          ar(i) = -(2.*al(i))
        ELSE IF (a6da .GT. da2) THEN
          ald(i) = -(2.*ard(i))
          al(i) = -(2.*ar(i))
        END IF
      ELSE
! effect of dm=0 included here
        ald(i) = 0.0_4
        al(i) = 0.
        ard(i) = 0.0_4
        ar(i) = 0.
      END IF
    END DO
  END IF
END SUBROUTINE PERT_PPM_DH_D

