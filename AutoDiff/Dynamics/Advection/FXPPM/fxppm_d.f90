!        Generated by TAPENADE     (INRIA, Tropics team)
!  Tapenade 3.9 (r5096) - 24 Feb 2014 16:53
!
!  Differentiation of fxppm in forward (tangent) mode:
!   variations   of useful results: flux
!   with respect to varying inputs: q c
!   RW status of diff variables: q:in flux:out c:in
SUBROUTINE FXPPM_D(c, cd, q, qd, flux, fluxd, iord, ifirst, ilast, &
& jfirst, jlast, npx, npy, ppm_limiter, dxa)
  IMPLICIT NONE
! !INPUT PARAMETERS:
!  X-Dir strip
  INTEGER, INTENT(IN) :: ifirst, ilast
!  Y-Dir strip
  INTEGER, INTENT(IN) :: jfirst, jlast
  INTEGER, INTENT(IN) :: iord
  INTEGER, INTENT(IN) :: npx, npy
  REAL, INTENT(IN) :: q(ifirst-ng:ilast+ng, jfirst:jlast)
  REAL, INTENT(IN) :: qd(ifirst-ng:ilast+ng, jfirst:jlast)
! Courant   N (like FLUX)
  REAL, INTENT(IN) :: c(ifirst:ilast+1, jfirst:jlast)
  REAL, INTENT(IN) :: cd(ifirst:ilast+1, jfirst:jlast)
  REAL, INTENT(IN) :: ppm_limiter
  REAL, INTENT(IN) :: dxa(:, :)
! !OUTPUT PARAMETERS:
!  Flux
  REAL, INTENT(OUT) :: flux(ifirst:ilast+1, jfirst:jlast)
  REAL, INTENT(OUT) :: fluxd(ifirst:ilast+1, jfirst:jlast)
!Dummy
  INTEGER, PARAMETER :: ie=10, is=10
  REAL, PARAMETER :: b1=1./30.
  REAL, PARAMETER :: b2=-(13./60.)
  REAL, PARAMETER :: b3=-(13./60.)
  REAL, PARAMETER :: b4=0.45
  REAL, PARAMETER :: b5=-0.05
  REAL, PARAMETER :: t11=27./28., t12=-(13./28.), t13=3./7.
  REAL, PARAMETER :: s11=11./14., s14=4./7., s15=3./14.
  REAL, PARAMETER :: c1=-(2./14.)
  REAL, PARAMETER :: c2=11./14.
  REAL, PARAMETER :: c3=5./14.
  REAL, PARAMETER :: p1=7./12.
  REAL, PARAMETER :: p2=-(1./12.)
  REAL, PARAMETER :: r3=1./3.
  INTEGER, PARAMETER :: ng=3
  INTEGER, PARAMETER :: grid_type=0
! Local
  REAL :: dm1(ifirst-2:ilast+2)
  REAL :: dm1d(ifirst-2:ilast+2)
  REAL :: al(ifirst-1:ilast+2)
  REAL :: ald(ifirst-1:ilast+2)
  REAL :: bl(ifirst-1:ilast+1)
  REAL :: bld(ifirst-1:ilast+1)
  REAL :: br(ifirst-1:ilast+1)
  REAL :: brd(ifirst-1:ilast+1)
  REAL :: dq(ifirst-3:ilast+2)
  REAL :: dqd(ifirst-3:ilast+2)
  REAL :: dl, dr, pmp, lac, ct, qe
  REAL :: dld, drd, pmpd, lacd
  REAL :: xt, x1, x0
  REAL :: xtd, x1d, x0d
  INTEGER :: i, j, is3, ie3, ie2, it
  INTRINSIC MAX
  INTRINSIC MIN
  INTRINSIC ABS
  INTRINSIC SIGN
  REAL :: min5d
  REAL :: x10d
  REAL :: y28d
  REAL :: max10d
  REAL :: x19
  REAL :: y36d
  REAL :: x18
  REAL :: min29d
  REAL :: y44d
  REAL :: x17
  REAL :: x6d
  REAL :: y52d
  REAL :: x16
  REAL :: y4d
  REAL :: x15
  REAL :: z2d
  REAL :: x14
  REAL :: min9
  REAL :: x13
  REAL :: min8
  REAL :: min8d
  REAL :: x13d
  REAL :: x12
  REAL :: min7
  REAL :: x21d
  REAL :: y39d
  REAL :: x11
  REAL :: y29
  REAL :: min6
  REAL :: y10d
  REAL :: y47d
  REAL :: x10
  REAL :: y28
  REAL :: min5
  REAL :: x9d
  REAL :: y55d
  REAL :: y27
  REAL :: min4
  REAL :: max2d
  REAL :: y7d
  REAL :: min11d
  REAL :: y26
  REAL :: min3
  REAL :: min32
  REAL :: z5d
  REAL :: y25
  REAL :: min2
  REAL :: min31
  REAL :: y24
  REAL :: min1
  REAL :: min30
  REAL :: x16d
  REAL :: y23
  REAL :: x24d
  REAL :: y22
  REAL :: y13d
  REAL :: x32d
  REAL :: y21
  REAL :: y21d
  REAL :: y20
  REAL :: y57
  REAL :: max5d
  REAL :: y56
  REAL :: z8d
  REAL :: min22d
  REAL :: x9
  REAL :: y55
  REAL :: min30d
  REAL :: x8
  REAL :: y54
  REAL :: x19d
  REAL :: x7
  REAL :: y53
  REAL :: x27d
  REAL :: x6
  REAL :: y52
  REAL :: y16d
  REAL :: x35d
  REAL :: x5
  REAL :: y51
  REAL :: min1d
  REAL :: y24d
  REAL :: x4
  REAL :: y50
  REAL :: max8d
  REAL :: y32d
  REAL :: min17d
  REAL :: x3
  REAL :: min25d
  REAL :: y40d
  REAL :: x2
  REAL :: x2d
  REAL :: y19d
  REAL :: min4d
  REAL :: y27d
  REAL :: y35d
  REAL :: min28d
  REAL :: y43d
  REAL :: x5d
  REAL :: y51d
  REAL :: y3d
  REAL :: min29
  REAL :: z1d
  REAL :: min28
  REAL :: min27
  REAL :: min7d
  REAL :: x12d
  REAL :: min26
  REAL :: x20d
  REAL :: y38d
  REAL :: y19
  REAL :: min25
  REAL :: y46d
  REAL :: y18
  INTEGER :: min24
  REAL :: x8d
  REAL :: y54d
  REAL :: y17
  REAL :: x36
  REAL :: min23
  REAL :: y6d
  REAL :: min10d
  REAL :: y16
  REAL :: x35
  REAL :: min22
  REAL :: z4d
  REAL :: y15
  REAL :: x34
  REAL :: min21
  REAL :: y14
  REAL :: x33
  REAL :: min20
  REAL :: x15d
  REAL :: y13
  REAL :: x32
  REAL :: x23d
  REAL :: y12
  REAL :: x31
  REAL :: y49
  REAL :: y12d
  REAL :: y49d
  REAL :: x31d
  REAL :: y11
  REAL :: x30
  REAL :: y48
  REAL :: y20d
  REAL :: y57d
  REAL :: y10
  REAL :: y47
  REAL :: max4d
  REAL :: y9d
  REAL :: min13d
  REAL :: y46
  REAL :: z7d
  REAL :: min21d
  REAL :: y45
  REAL :: y44
  REAL :: x18d
  REAL :: y43
  REAL :: x26d
  REAL :: y42
  REAL :: y15d
  REAL :: x34d
  REAL :: y41
  REAL :: y23d
  REAL :: y40
  REAL :: max7d
  REAL :: min16d
  REAL :: y31d
  REAL :: z9
  REAL :: min32d
  REAL :: z8
  REAL :: z7
  REAL :: x29d
  REAL :: z6
  REAL :: y18d
  REAL :: z5
  REAL :: min3d
  REAL :: y26d
  REAL :: z4
  REAL :: y34d
  REAL :: min19d
  REAL :: z3
  REAL :: min27d
  REAL :: y42d
  REAL :: z2
  REAL :: x4d
  REAL :: y50d
  REAL :: z1
  REAL :: y2d
  REAL :: min19
  REAL :: min18
  REAL :: min17
  REAL :: min6d
  REAL :: x11d
  REAL :: y29d
  REAL :: x29
  REAL :: min16
  REAL :: y37d
  REAL :: x28
  REAL :: min15
  REAL :: y45d
  REAL :: x27
  INTEGER :: min14
  REAL :: x7d
  REAL :: y53d
  REAL :: x26
  REAL :: min13
  REAL :: y5d
  REAL :: x25
  REAL :: min12
  REAL :: z3d
  REAL :: x24
  REAL :: min11
  REAL :: x23
  REAL :: min10
  REAL :: min9d
  REAL :: x14d
  REAL :: x22
  REAL :: x22d
  REAL :: x21
  REAL :: y39
  REAL :: y11d
  REAL :: y48d
  REAL :: x30d
  REAL :: x20
  REAL :: y38
  REAL :: y56d
  REAL :: y37
  REAL :: max3d
  REAL :: y8d
  REAL :: min12d
  REAL :: y36
  REAL :: z6d
  REAL :: min20d
  REAL :: y35
  REAL :: y34
  REAL :: x17d
  REAL :: y33
  REAL :: max9
  REAL :: x25d
  REAL :: y32
  REAL :: max8
  REAL :: y14d
  REAL :: x33d
  REAL :: y31
  REAL :: max7
  REAL :: y22d
  REAL :: y30
  REAL :: max6
  REAL :: max6d
  REAL :: min15d
  REAL :: y30d
  REAL :: max5
  REAL :: min23d
  REAL :: z9d
  REAL :: y9
  REAL :: max4
  REAL :: min31d
  REAL :: y8
  REAL :: max3
  REAL :: y7
  REAL :: max2
  REAL :: x28d
  REAL :: y6
  INTEGER :: max1
  REAL :: y17d
  REAL :: x36d
  REAL :: y5
  REAL :: min2d
  REAL :: y25d
  REAL :: y4
  REAL :: max10
  REAL :: max9d
  REAL :: y33d
  REAL :: min18d
  REAL :: y3
  REAL :: min26d
  REAL :: y41d
  REAL :: y2
  REAL :: x3d
  REAL :: y1
  REAL :: y1d
  IF (3 .LT. is - 1) THEN
    is3 = is - 1
  ELSE
    is3 = 3
  END IF
  IF (npx - 3 .GT. ie + 1) THEN
    ie3 = ie + 1
  ELSE
    ie3 = npx - 3
  END IF
  IF (npx - 2 .GT. ie + 2) THEN
    ie2 = ie + 2
  ELSE
    ie2 = npx - 2
  END IF
  IF (iord .LE. 4) THEN
    fluxd = 0.0
    ald = 0.0
    dm1d = 0.0
    bld = 0.0
    brd = 0.0
    DO j=jfirst,jlast
      DO i=is-2,ie+2
        xtd = 0.25*(qd(i+1, j)-qd(i-1, j))
        xt = 0.25*(q(i+1, j)-q(i-1, j))
        IF (xt .GE. 0.) THEN
          x2d = xtd
          x2 = xt
        ELSE
          x2d = -xtd
          x2 = -xt
        END IF
        IF (q(i-1, j) .LT. q(i, j)) THEN
          IF (q(i, j) .LT. q(i+1, j)) THEN
            max2d = qd(i+1, j)
            max2 = q(i+1, j)
          ELSE
            max2d = qd(i, j)
            max2 = q(i, j)
          END IF
        ELSE IF (q(i-1, j) .LT. q(i+1, j)) THEN
          max2d = qd(i+1, j)
          max2 = q(i+1, j)
        ELSE
          max2d = qd(i-1, j)
          max2 = q(i-1, j)
        END IF
        y1d = max2d - qd(i, j)
        y1 = max2 - q(i, j)
        IF (q(i-1, j) .GT. q(i, j)) THEN
          IF (q(i, j) .GT. q(i+1, j)) THEN
            min23d = qd(i+1, j)
            min23 = q(i+1, j)
          ELSE
            min23d = qd(i, j)
            min23 = q(i, j)
          END IF
        ELSE IF (q(i-1, j) .GT. q(i+1, j)) THEN
          min23d = qd(i+1, j)
          min23 = q(i+1, j)
        ELSE
          min23d = qd(i-1, j)
          min23 = q(i-1, j)
        END IF
        z1d = qd(i, j) - min23d
        z1 = q(i, j) - min23
        IF (x2 .GT. y1) THEN
          IF (y1 .GT. z1) THEN
            min1d = z1d
            min1 = z1
          ELSE
            min1d = y1d
            min1 = y1
          END IF
        ELSE IF (x2 .GT. z1) THEN
          min1d = z1d
          min1 = z1
        ELSE
          min1d = x2d
          min1 = x2
        END IF
        dm1d(i) = min1d*SIGN(1.d0, min1*xt)
        dm1(i) = SIGN(min1, xt)
      END DO
      IF (grid_type .LT. 3) THEN
        IF (3 .LT. is - 1) THEN
          max1 = is - 1
        ELSE
          max1 = 3
        END IF
        IF (npx - 2 .GT. ie + 2) THEN
          min24 = ie + 2
        ELSE
          min24 = npx - 2
        END IF
        DO i=max1,min24
          ald(i) = 0.5*(qd(i-1, j)+qd(i, j)) + r3*(dm1d(i-1)-dm1d(i))
          al(i) = 0.5*(q(i-1, j)+q(i, j)) + r3*(dm1(i-1)-dm1(i))
        END DO
! Fix the edges:
        IF (is .EQ. 1) THEN
          x0d = 0.5*((2.*dxa(1, j)+dxa(2, j))*(qd(0, j)+qd(1, j))-dxa(1&
&           , j)*(qd(-1, j)+qd(2, j)))/(dxa(1, j)+dxa(2, j))
          x0 = 0.5*((2.*dxa(1, j)+dxa(2, j))*(q(0, j)+q(1, j))-dxa(1, j)&
&           *(q(-1, j)+q(2, j)))/(dxa(1, j)+dxa(2, j))
          ald(1) = x0d
          al(1) = x0
          x1d = s15*qd(0, j) + s11*qd(-1, j) + s14*dm1d(-1)
          x1 = s15*q(0, j) + s11*q(-1, j) + s14*dm1(-1)
          dm1d(0) = 0.5*(x0d-x1d)
          dm1(0) = 0.5*(x0-x1)
          IF (dm1(0) .GE. 0.) THEN
            x3d = dm1d(0)
            x3 = dm1(0)
          ELSE
            x3d = -dm1d(0)
            x3 = -dm1(0)
          END IF
          IF (q(0, j) .LT. x0) THEN
            IF (x0 .LT. x1) THEN
              max3d = x1d
              max3 = x1
            ELSE
              max3d = x0d
              max3 = x0
            END IF
          ELSE IF (q(0, j) .LT. x1) THEN
            max3d = x1d
            max3 = x1
          ELSE
            max3d = qd(0, j)
            max3 = q(0, j)
          END IF
          y2d = max3d - qd(0, j)
          y2 = max3 - q(0, j)
          IF (q(0, j) .GT. x0) THEN
            IF (x0 .GT. x1) THEN
              min25d = x1d
              min25 = x1
            ELSE
              min25d = x0d
              min25 = x0
            END IF
          ELSE IF (q(0, j) .GT. x1) THEN
            min25d = x1d
            min25 = x1
          ELSE
            min25d = qd(0, j)
            min25 = q(0, j)
          END IF
          z2d = qd(0, j) - min25d
          z2 = q(0, j) - min25
          IF (x3 .GT. y2) THEN
            IF (y2 .GT. z2) THEN
              min2d = z2d
              min2 = z2
            ELSE
              min2d = y2d
              min2 = y2
            END IF
          ELSE IF (x3 .GT. z2) THEN
            min2d = z2d
            min2 = z2
          ELSE
            min2d = x3d
            min2 = x3
          END IF
          dm1d(0) = min2d*SIGN(1.d0, min2*dm1(0))
          dm1(0) = SIGN(min2, dm1(0))
          ald(0) = 0.5*(qd(-1, j)+qd(0, j)) + r3*(dm1d(-1)-dm1d(0))
          al(0) = 0.5*(q(-1, j)+q(0, j)) + r3*(dm1(-1)-dm1(0))
!
          x1d = s15*qd(1, j) + s11*qd(2, j) - s14*dm1d(2)
          x1 = s15*q(1, j) + s11*q(2, j) - s14*dm1(2)
          dm1d(1) = 0.5*(x1d-x0d)
          dm1(1) = 0.5*(x1-x0)
          IF (dm1(1) .GE. 0.) THEN
            x4d = dm1d(1)
            x4 = dm1(1)
          ELSE
            x4d = -dm1d(1)
            x4 = -dm1(1)
          END IF
          IF (q(1, j) .LT. x0) THEN
            IF (x0 .LT. x1) THEN
              max4d = x1d
              max4 = x1
            ELSE
              max4d = x0d
              max4 = x0
            END IF
          ELSE IF (q(1, j) .LT. x1) THEN
            max4d = x1d
            max4 = x1
          ELSE
            max4d = qd(1, j)
            max4 = q(1, j)
          END IF
          y3d = max4d - qd(1, j)
          y3 = max4 - q(1, j)
          IF (q(1, j) .GT. x0) THEN
            IF (x0 .GT. x1) THEN
              min26d = x1d
              min26 = x1
            ELSE
              min26d = x0d
              min26 = x0
            END IF
          ELSE IF (q(1, j) .GT. x1) THEN
            min26d = x1d
            min26 = x1
          ELSE
            min26d = qd(1, j)
            min26 = q(1, j)
          END IF
          z3d = qd(1, j) - min26d
          z3 = q(1, j) - min26
          IF (x4 .GT. y3) THEN
            IF (y3 .GT. z3) THEN
              min3d = z3d
              min3 = z3
            ELSE
              min3d = y3d
              min3 = y3
            END IF
          ELSE IF (x4 .GT. z3) THEN
            min3d = z3d
            min3 = z3
          ELSE
            min3d = x4d
            min3 = x4
          END IF
          dm1d(1) = min3d*SIGN(1.d0, min3*dm1(1))
          dm1(1) = SIGN(min3, dm1(1))
          ald(2) = 0.5*(qd(1, j)+qd(2, j)) + r3*(dm1d(1)-dm1d(2))
          al(2) = 0.5*(q(1, j)+q(2, j)) + r3*(dm1(1)-dm1(2))
        END IF
        IF (ie + 1 .EQ. npx) THEN
          x0d = 0.5*((2.*dxa(npx-1, j)+dxa(npx-2, j))*(qd(npx-1, j)+qd(&
&           npx, j))-dxa(npx-1, j)*(qd(npx-2, j)+qd(npx+1, j)))/(dxa(npx&
&           -1, j)+dxa(npx-2, j))
          x0 = 0.5*((2.*dxa(npx-1, j)+dxa(npx-2, j))*(q(npx-1, j)+q(npx&
&           , j))-dxa(npx-1, j)*(q(npx-2, j)+q(npx+1, j)))/(dxa(npx-1, j&
&           )+dxa(npx-2, j))
          ald(npx) = x0d
          al(npx) = x0
          x1d = s15*qd(npx-1, j) + s11*qd(npx-2, j) + s14*dm1d(npx-2)
          x1 = s15*q(npx-1, j) + s11*q(npx-2, j) + s14*dm1(npx-2)
          dm1d(npx-1) = 0.5*(x0d-x1d)
          dm1(npx-1) = 0.5*(x0-x1)
          IF (dm1(npx-1) .GE. 0.) THEN
            x5d = dm1d(npx-1)
            x5 = dm1(npx-1)
          ELSE
            x5d = -dm1d(npx-1)
            x5 = -dm1(npx-1)
          END IF
          IF (q(npx-1, j) .LT. x0) THEN
            IF (x0 .LT. x1) THEN
              max5d = x1d
              max5 = x1
            ELSE
              max5d = x0d
              max5 = x0
            END IF
          ELSE IF (q(npx-1, j) .LT. x1) THEN
            max5d = x1d
            max5 = x1
          ELSE
            max5d = qd(npx-1, j)
            max5 = q(npx-1, j)
          END IF
          y4d = max5d - qd(npx-1, j)
          y4 = max5 - q(npx-1, j)
          IF (q(npx-1, j) .GT. x0) THEN
            IF (x0 .GT. x1) THEN
              min27d = x1d
              min27 = x1
            ELSE
              min27d = x0d
              min27 = x0
            END IF
          ELSE IF (q(npx-1, j) .GT. x1) THEN
            min27d = x1d
            min27 = x1
          ELSE
            min27d = qd(npx-1, j)
            min27 = q(npx-1, j)
          END IF
          z4d = qd(npx-1, j) - min27d
          z4 = q(npx-1, j) - min27
          IF (x5 .GT. y4) THEN
            IF (y4 .GT. z4) THEN
              min4d = z4d
              min4 = z4
            ELSE
              min4d = y4d
              min4 = y4
            END IF
          ELSE IF (x5 .GT. z4) THEN
            min4d = z4d
            min4 = z4
          ELSE
            min4d = x5d
            min4 = x5
          END IF
          dm1d(npx-1) = min4d*SIGN(1.d0, min4*dm1(npx-1))
          dm1(npx-1) = SIGN(min4, dm1(npx-1))
          ald(npx-1) = 0.5*(qd(npx-2, j)+qd(npx-1, j)) + r3*(dm1d(npx-2)&
&           -dm1d(npx-1))
          al(npx-1) = 0.5*(q(npx-2, j)+q(npx-1, j)) + r3*(dm1(npx-2)-dm1&
&           (npx-1))
!
          x1d = s15*qd(npx, j) + s11*qd(npx+1, j) - s14*dm1d(npx+1)
          x1 = s15*q(npx, j) + s11*q(npx+1, j) - s14*dm1(npx+1)
          dm1d(npx) = 0.5*(x1d-x0d)
          dm1(npx) = 0.5*(x1-x0)
          IF (dm1(npx) .GE. 0.) THEN
            x6d = dm1d(npx)
            x6 = dm1(npx)
          ELSE
            x6d = -dm1d(npx)
            x6 = -dm1(npx)
          END IF
          IF (q(npx, j) .LT. x0) THEN
            IF (x0 .LT. x1) THEN
              max6d = x1d
              max6 = x1
            ELSE
              max6d = x0d
              max6 = x0
            END IF
          ELSE IF (q(npx, j) .LT. x1) THEN
            max6d = x1d
            max6 = x1
          ELSE
            max6d = qd(npx, j)
            max6 = q(npx, j)
          END IF
          y5d = max6d - qd(npx, j)
          y5 = max6 - q(npx, j)
          IF (q(npx, j) .GT. x0) THEN
            IF (x0 .GT. x1) THEN
              min28d = x1d
              min28 = x1
            ELSE
              min28d = x0d
              min28 = x0
            END IF
          ELSE IF (q(npx, j) .GT. x1) THEN
            min28d = x1d
            min28 = x1
          ELSE
            min28d = qd(npx, j)
            min28 = q(npx, j)
          END IF
          z5d = qd(npx, j) - min28d
          z5 = q(npx, j) - min28
          IF (x6 .GT. y5) THEN
            IF (y5 .GT. z5) THEN
              min5d = z5d
              min5 = z5
            ELSE
              min5d = y5d
              min5 = y5
            END IF
          ELSE IF (x6 .GT. z5) THEN
            min5d = z5d
            min5 = z5
          ELSE
            min5d = x6d
            min5 = x6
          END IF
          dm1d(npx) = min5d*SIGN(1.d0, min5*dm1(npx))
          dm1(npx) = SIGN(min5, dm1(npx))
          ald(npx+1) = 0.5*(qd(npx, j)+qd(npx+1, j)) + r3*(dm1d(npx)-&
&           dm1d(npx+1))
          al(npx+1) = 0.5*(q(npx, j)+q(npx+1, j)) + r3*(dm1(npx)-dm1(npx&
&           +1))
        END IF
      ELSE
! For doubly periodic BC
        DO i=is-1,ie+2
          ald(i) = 0.5*(qd(i-1, j)+qd(i, j)) + r3*(dm1d(i-1)-dm1d(i))
          al(i) = 0.5*(q(i-1, j)+q(i, j)) + r3*(dm1(i-1)-dm1(i))
        END DO
      END IF
      IF (iord .EQ. 3) THEN
        DO i=is-1,ie+1
          bld(i) = ald(i) - qd(i, j)
          bl(i) = al(i) - q(i, j)
          brd(i) = ald(i+1) - qd(i, j)
          br(i) = al(i+1) - q(i, j)
        END DO
        CALL PERT_PPM_DH_D(ie - is + 3, q(is-1:, j), bl(is-1:), bld(is-1&
&                    :), br(is-1:), brd(is-1:), 1)
        DO i=is,ie+1
          IF (c(i, j) .GT. 0.) THEN
            fluxd(i, j) = qd(i-1, j) + (1.-c(i, j))*(brd(i-1)-cd(i, j)*(&
&             bl(i-1)+br(i-1))-c(i, j)*(bld(i-1)+brd(i-1))) - cd(i, j)*(&
&             br(i-1)-c(i, j)*(bl(i-1)+br(i-1)))
            flux(i, j) = q(i-1, j) + (1.-c(i, j))*(br(i-1)-c(i, j)*(bl(i&
&             -1)+br(i-1)))
          ELSE
            fluxd(i, j) = qd(i, j) + cd(i, j)*(bl(i)+c(i, j)*(bl(i)+br(i&
&             ))) + (1.+c(i, j))*(bld(i)+cd(i, j)*(bl(i)+br(i))+c(i, j)*&
&             (bld(i)+brd(i)))
            flux(i, j) = q(i, j) + (1.+c(i, j))*(bl(i)+c(i, j)*(bl(i)+br&
&             (i)))
          END IF
        END DO
      ELSE
        DO i=is,ie+1
          IF (c(i, j) .GT. 0.) THEN
            xtd = ppm_limiter*dm1d(i-1)
            xt = ppm_limiter*dm1(i-1)
            IF (xt .GE. 0.) THEN
              x7d = xtd
              x7 = xt
            ELSE
              x7d = -xtd
              x7 = -xt
            END IF
            IF (al(i-1) - q(i-1, j) .GE. 0.) THEN
              y6d = ald(i-1) - qd(i-1, j)
              y6 = al(i-1) - q(i-1, j)
            ELSE
              y6d = -(ald(i-1)-qd(i-1, j))
              y6 = -(al(i-1)-q(i-1, j))
            END IF
            IF (x7 .GT. y6) THEN
              min6d = y6d
              min6 = y6
            ELSE
              min6d = x7d
              min6 = x7
            END IF
            dld = min6d*SIGN(1.d0, min6*xt)
            dl = SIGN(min6, xt)
            IF (xt .GE. 0.) THEN
              x8d = xtd
              x8 = xt
            ELSE
              x8d = -xtd
              x8 = -xt
            END IF
            IF (al(i) - q(i-1, j) .GE. 0.) THEN
              y7d = ald(i) - qd(i-1, j)
              y7 = al(i) - q(i-1, j)
            ELSE
              y7d = -(ald(i)-qd(i-1, j))
              y7 = -(al(i)-q(i-1, j))
            END IF
            IF (x8 .GT. y7) THEN
              min7d = y7d
              min7 = y7
            ELSE
              min7d = x8d
              min7 = x8
            END IF
            drd = min7d*SIGN(1.d0, min7*xt)
            dr = SIGN(min7, xt)
            fluxd(i, j) = qd(i-1, j) + (1.-c(i, j))*(cd(i, j)*(dl-dr)+c(&
&             i, j)*(dld-drd)+drd) - cd(i, j)*(c(i, j)*(dl-dr)+dr)
            flux(i, j) = q(i-1, j) + (1.-c(i, j))*(c(i, j)*(dl-dr)+dr)
          ELSE
            xtd = ppm_limiter*dm1d(i)
            xt = ppm_limiter*dm1(i)
            IF (xt .GE. 0.) THEN
              x9d = xtd
              x9 = xt
            ELSE
              x9d = -xtd
              x9 = -xt
            END IF
            IF (al(i) - q(i, j) .GE. 0.) THEN
              y8d = ald(i) - qd(i, j)
              y8 = al(i) - q(i, j)
            ELSE
              y8d = -(ald(i)-qd(i, j))
              y8 = -(al(i)-q(i, j))
            END IF
            IF (x9 .GT. y8) THEN
              min8d = y8d
              min8 = y8
            ELSE
              min8d = x9d
              min8 = x9
            END IF
            dld = min8d*SIGN(1.d0, min8*xt)
            dl = SIGN(min8, xt)
            IF (xt .GE. 0.) THEN
              x10d = xtd
              x10 = xt
            ELSE
              x10d = -xtd
              x10 = -xt
            END IF
            IF (al(i+1) - q(i, j) .GE. 0.) THEN
              y9d = ald(i+1) - qd(i, j)
              y9 = al(i+1) - q(i, j)
            ELSE
              y9d = -(ald(i+1)-qd(i, j))
              y9 = -(al(i+1)-q(i, j))
            END IF
            IF (x10 .GT. y9) THEN
              min9d = y9d
              min9 = y9
            ELSE
              min9d = x10d
              min9 = x10
            END IF
            drd = min9d*SIGN(1.d0, min9*xt)
            dr = SIGN(min9, xt)
            fluxd(i, j) = qd(i, j) - cd(i, j)*(c(i, j)*(dl-dr)+dl) - (1.&
&             +c(i, j))*(cd(i, j)*(dl-dr)+c(i, j)*(dld-drd)+dld)
            flux(i, j) = q(i, j) - (1.+c(i, j))*(c(i, j)*(dl-dr)+dl)
          END IF
        END DO
      END IF
    END DO
  ELSE IF (iord .EQ. 5) THEN
    fluxd = 0.0
    dqd = 0.0
    ald = 0.0
    dm1d = 0.0
    bld = 0.0
    brd = 0.0
! PPM with Hunyh's 2nd constraint
    DO j=jfirst,jlast
      DO i=ifirst-3,ilast+2
        dqd(i) = qd(i+1, j) - qd(i, j)
        dq(i) = q(i+1, j) - q(i, j)
      END DO
      DO i=ifirst-2,ilast+2
        xtd = 0.25*(qd(i+1, j)-qd(i-1, j))
        xt = 0.25*(q(i+1, j)-q(i-1, j))
        IF (xt .GE. 0.) THEN
          x11d = xtd
          x11 = xt
        ELSE
          x11d = -xtd
          x11 = -xt
        END IF
        IF (q(i-1, j) .LT. q(i, j)) THEN
          IF (q(i, j) .LT. q(i+1, j)) THEN
            max7d = qd(i+1, j)
            max7 = q(i+1, j)
          ELSE
            max7d = qd(i, j)
            max7 = q(i, j)
          END IF
        ELSE IF (q(i-1, j) .LT. q(i+1, j)) THEN
          max7d = qd(i+1, j)
          max7 = q(i+1, j)
        ELSE
          max7d = qd(i-1, j)
          max7 = q(i-1, j)
        END IF
        y10d = max7d - qd(i, j)
        y10 = max7 - q(i, j)
        IF (q(i-1, j) .GT. q(i, j)) THEN
          IF (q(i, j) .GT. q(i+1, j)) THEN
            min29d = qd(i+1, j)
            min29 = q(i+1, j)
          ELSE
            min29d = qd(i, j)
            min29 = q(i, j)
          END IF
        ELSE IF (q(i-1, j) .GT. q(i+1, j)) THEN
          min29d = qd(i+1, j)
          min29 = q(i+1, j)
        ELSE
          min29d = qd(i-1, j)
          min29 = q(i-1, j)
        END IF
        z6d = qd(i, j) - min29d
        z6 = q(i, j) - min29
        IF (x11 .GT. y10) THEN
          IF (y10 .GT. z6) THEN
            min10d = z6d
            min10 = z6
          ELSE
            min10d = y10d
            min10 = y10
          END IF
        ELSE IF (x11 .GT. z6) THEN
          min10d = z6d
          min10 = z6
        ELSE
          min10d = x11d
          min10 = x11
        END IF
        dm1d(i) = min10d*SIGN(1.d0, min10*xt)
        dm1(i) = SIGN(min10, xt)
      END DO
      DO i=ifirst-1,ilast+2
        ald(i) = 0.5*(qd(i-1, j)+qd(i, j)) + r3*(dm1d(i-1)-dm1d(i))
        al(i) = 0.5*(q(i-1, j)+q(i, j)) + r3*(dm1(i-1)-dm1(i))
      END DO
      DO i=ifirst-1,ilast+1
        pmpd = -(2.*dqd(i))
        pmp = -(2.*dq(i))
        lacd = pmpd + 1.5*dqd(i+1)
        lac = pmp + 1.5*dq(i+1)
        IF (0. .LT. pmp) THEN
          IF (pmp .LT. lac) THEN
            x12d = lacd
            x12 = lac
          ELSE
            x12d = pmpd
            x12 = pmp
          END IF
        ELSE IF (0. .LT. lac) THEN
          x12d = lacd
          x12 = lac
        ELSE
          x12 = 0.
          x12d = 0.0
        END IF
        IF (0. .GT. pmp) THEN
          IF (pmp .GT. lac) THEN
            y44d = lacd
            y44 = lac
          ELSE
            y44d = pmpd
            y44 = pmp
          END IF
        ELSE IF (0. .GT. lac) THEN
          y44d = lacd
          y44 = lac
        ELSE
          y44 = 0.
          y44d = 0.0
        END IF
        IF (al(i) - q(i, j) .LT. y44) THEN
          y11d = y44d
          y11 = y44
        ELSE
          y11d = ald(i) - qd(i, j)
          y11 = al(i) - q(i, j)
        END IF
        IF (x12 .GT. y11) THEN
          bld(i) = y11d
          bl(i) = y11
        ELSE
          bld(i) = x12d
          bl(i) = x12
        END IF
        pmpd = 2.*dqd(i-1)
        pmp = 2.*dq(i-1)
        lacd = pmpd - 1.5*dqd(i-2)
        lac = pmp - 1.5*dq(i-2)
        IF (0. .LT. pmp) THEN
          IF (pmp .LT. lac) THEN
            x13d = lacd
            x13 = lac
          ELSE
            x13d = pmpd
            x13 = pmp
          END IF
        ELSE IF (0. .LT. lac) THEN
          x13d = lacd
          x13 = lac
        ELSE
          x13 = 0.
          x13d = 0.0
        END IF
        IF (0. .GT. pmp) THEN
          IF (pmp .GT. lac) THEN
            y45d = lacd
            y45 = lac
          ELSE
            y45d = pmpd
            y45 = pmp
          END IF
        ELSE IF (0. .GT. lac) THEN
          y45d = lacd
          y45 = lac
        ELSE
          y45 = 0.
          y45d = 0.0
        END IF
        IF (al(i+1) - q(i, j) .LT. y45) THEN
          y12d = y45d
          y12 = y45
        ELSE
          y12d = ald(i+1) - qd(i, j)
          y12 = al(i+1) - q(i, j)
        END IF
        IF (x13 .GT. y12) THEN
          brd(i) = y12d
          br(i) = y12
        ELSE
          brd(i) = x13d
          br(i) = x13
        END IF
      END DO
      DO i=ifirst,ilast+1
        IF (c(i, j) .GT. 0.) THEN
          fluxd(i, j) = qd(i-1, j) + (1.-c(i, j))*(brd(i-1)-cd(i, j)*(bl&
&           (i-1)+br(i-1))-c(i, j)*(bld(i-1)+brd(i-1))) - cd(i, j)*(br(i&
&           -1)-c(i, j)*(bl(i-1)+br(i-1)))
          flux(i, j) = q(i-1, j) + (1.-c(i, j))*(br(i-1)-c(i, j)*(bl(i-1&
&           )+br(i-1)))
        ELSE
          fluxd(i, j) = qd(i, j) + cd(i, j)*(bl(i)+c(i, j)*(bl(i)+br(i))&
&           ) + (1.+c(i, j))*(bld(i)+cd(i, j)*(bl(i)+br(i))+c(i, j)*(bld&
&           (i)+brd(i)))
          flux(i, j) = q(i, j) + (1.+c(i, j))*(bl(i)+c(i, j)*(bl(i)+br(i&
&           )))
        END IF
      END DO
    END DO
  ELSE IF (iord .EQ. 6 .OR. iord .EQ. 7) THEN
    fluxd = 0.0
    dqd = 0.0
    bld = 0.0
    brd = 0.0
    DO j=jfirst,jlast
      IF (iord .EQ. 6) THEN
! Non-monotonic "5th order" scheme (not really 5th order)
        DO i=is3,ie3
          bld(i) = b5*qd(i-2, j) + b4*qd(i-1, j) + b3*qd(i, j) + b2*qd(i&
&           +1, j) + b1*qd(i+2, j)
          bl(i) = b5*q(i-2, j) + b4*q(i-1, j) + b3*q(i, j) + b2*q(i+1, j&
&           ) + b1*q(i+2, j)
          brd(i) = b1*qd(i-2, j) + b2*qd(i-1, j) + b3*qd(i, j) + b4*qd(i&
&           +1, j) + b5*qd(i+2, j)
          br(i) = b1*q(i-2, j) + b2*q(i-1, j) + b3*q(i, j) + b4*q(i+1, j&
&           ) + b5*q(i+2, j)
        END DO
      ELSE
        DO i=is-3,ie+2
          dqd(i) = qd(i+1, j) - qd(i, j)
          dq(i) = q(i+1, j) - q(i, j)
        END DO
        DO i=is3,ie3
!-----------------------------------------------
!- Huynh's 2nd constraint + simple mono limiter
!-----------------------------------------------
          dld = b5*qd(i-2, j) + b4*qd(i-1, j) + b3*qd(i, j) + b2*qd(i+1&
&           , j) + b1*qd(i+2, j)
          dl = b5*q(i-2, j) + b4*q(i-1, j) + b3*q(i, j) + b2*q(i+1, j) +&
&           b1*q(i+2, j)
          drd = b1*qd(i-2, j) + b2*qd(i-1, j) + b3*qd(i, j) + b4*qd(i+1&
&           , j) + b5*qd(i+2, j)
          dr = b1*q(i-2, j) + b2*q(i-1, j) + b3*q(i, j) + b4*q(i+1, j) +&
&           b5*q(i+2, j)
          IF (dl .GE. 0.) THEN
            x14d = dld
            x14 = dl
          ELSE
            x14d = -dld
            x14 = -dl
          END IF
          IF (dq(i-1) .GE. 0.) THEN
            y13d = dqd(i-1)
            y13 = dq(i-1)
          ELSE
            y13d = -dqd(i-1)
            y13 = -dq(i-1)
          END IF
          IF (x14 .GT. y13) THEN
            min11d = y13d
            min11 = y13
          ELSE
            min11d = x14d
            min11 = x14
          END IF
! 1st constraint
          dld = -(min11d*SIGN(1.d0, min11*dq(i-1)))
          dl = -SIGN(min11, dq(i-1))
          pmpd = -(2.*dqd(i))
          pmp = -(2.*dq(i))
          lacd = pmpd + 1.5*dqd(i+1)
          lac = pmp + 1.5*dq(i+1)
          IF (0. .LT. pmp) THEN
            IF (pmp .LT. lac) THEN
              x15d = lacd
              x15 = lac
            ELSE
              x15d = pmpd
              x15 = pmp
            END IF
          ELSE IF (0. .LT. lac) THEN
            x15d = lacd
            x15 = lac
          ELSE
            x15 = 0.
            x15d = 0.0
          END IF
          IF (0. .GT. pmp) THEN
            IF (pmp .GT. lac) THEN
              y46d = lacd
              y46 = lac
            ELSE
              y46d = pmpd
              y46 = pmp
            END IF
          ELSE IF (0. .GT. lac) THEN
            y46d = lacd
            y46 = lac
          ELSE
            y46 = 0.
            y46d = 0.0
          END IF
          IF (dl .LT. y46) THEN
            y14d = y46d
            y14 = y46
          ELSE
            y14d = dld
            y14 = dl
          END IF
          IF (x15 .GT. y14) THEN
            bld(i) = y14d
            bl(i) = y14
          ELSE
            bld(i) = x15d
            bl(i) = x15
          END IF
          IF (dr .GE. 0.) THEN
            x16d = drd
            x16 = dr
          ELSE
            x16d = -drd
            x16 = -dr
          END IF
          IF (dq(i) .GE. 0.) THEN
            y15d = dqd(i)
            y15 = dq(i)
          ELSE
            y15d = -dqd(i)
            y15 = -dq(i)
          END IF
          IF (x16 .GT. y15) THEN
            min12d = y15d
            min12 = y15
          ELSE
            min12d = x16d
            min12 = x16
          END IF
!---
! 1st constraint
          drd = min12d*SIGN(1.d0, min12*dq(i))
          dr = SIGN(min12, dq(i))
          pmpd = 2.*dqd(i-1)
          pmp = 2.*dq(i-1)
          lacd = pmpd - 1.5*dqd(i-2)
          lac = pmp - 1.5*dq(i-2)
          IF (0. .LT. pmp) THEN
            IF (pmp .LT. lac) THEN
              x17d = lacd
              x17 = lac
            ELSE
              x17d = pmpd
              x17 = pmp
            END IF
          ELSE IF (0. .LT. lac) THEN
            x17d = lacd
            x17 = lac
          ELSE
            x17 = 0.
            x17d = 0.0
          END IF
          IF (0. .GT. pmp) THEN
            IF (pmp .GT. lac) THEN
              y47d = lacd
              y47 = lac
            ELSE
              y47d = pmpd
              y47 = pmp
            END IF
          ELSE IF (0. .GT. lac) THEN
            y47d = lacd
            y47 = lac
          ELSE
            y47 = 0.
            y47d = 0.0
          END IF
          IF (dr .LT. y47) THEN
            y16d = y47d
            y16 = y47
          ELSE
            y16d = drd
            y16 = dr
          END IF
          IF (x17 .GT. y16) THEN
            brd(i) = y16d
            br(i) = y16
          ELSE
            brd(i) = x17d
            br(i) = x17
          END IF
        END DO
      END IF
!--------------
! fix the edges
!--------------
      IF (is .EQ. 1) THEN
        brd(2) = p1*(qd(2, j)+qd(3, j)) + p2*(qd(1, j)+qd(4, j)) - qd(2&
&         , j)
        br(2) = p1*(q(2, j)+q(3, j)) + p2*(q(1, j)+q(4, j)) - q(2, j)
        xtd = 0.5*((2.*dxa(1, j)+dxa(2, j))*(qd(0, j)+qd(1, j))-dxa(1, j&
&         )*(qd(-1, j)+qd(2, j)))/(dxa(1, j)+dxa(2, j))
        xt = 0.5*((2.*dxa(1, j)+dxa(2, j))*(q(0, j)+q(1, j))-dxa(1, j)*(&
&         q(-1, j)+q(2, j)))/(dxa(1, j)+dxa(2, j))
        bld(1) = xtd - qd(1, j)
        bl(1) = xt - q(1, j)
        brd(0) = xtd - qd(0, j)
        br(0) = xt - q(0, j)
        xtd = c1*qd(-2, j) + c2*qd(-1, j) + c3*qd(0, j)
        xt = c1*q(-2, j) + c2*q(-1, j) + c3*q(0, j)
        IF (q(-1, j) .GT. q(0, j)) THEN
          y17d = qd(0, j)
          y17 = q(0, j)
        ELSE
          y17d = qd(-1, j)
          y17 = q(-1, j)
        END IF
        IF (xt .LT. y17) THEN
          xtd = y17d
          xt = y17
        ELSE
          xt = xt
        END IF
        IF (q(-1, j) .LT. q(0, j)) THEN
          y18d = qd(0, j)
          y18 = q(0, j)
        ELSE
          y18d = qd(-1, j)
          y18 = q(-1, j)
        END IF
        IF (xt .GT. y18) THEN
          xtd = y18d
          xt = y18
        ELSE
          xt = xt
        END IF
        bld(0) = xtd - qd(0, j)
        bl(0) = xt - q(0, j)
        xtd = c3*qd(1, j) + c2*qd(2, j) + c1*qd(3, j)
        xt = c3*q(1, j) + c2*q(2, j) + c1*q(3, j)
        IF (q(1, j) .GT. q(2, j)) THEN
          y19d = qd(2, j)
          y19 = q(2, j)
        ELSE
          y19d = qd(1, j)
          y19 = q(1, j)
        END IF
        IF (xt .LT. y19) THEN
          xtd = y19d
          xt = y19
        ELSE
          xt = xt
        END IF
        IF (q(1, j) .LT. q(2, j)) THEN
          y20d = qd(2, j)
          y20 = q(2, j)
        ELSE
          y20d = qd(1, j)
          y20 = q(1, j)
        END IF
        IF (xt .GT. y20) THEN
          xtd = y20d
          xt = y20
        ELSE
          xt = xt
        END IF
        brd(1) = xtd - qd(1, j)
        br(1) = xt - q(1, j)
        bld(2) = xtd - qd(2, j)
        bl(2) = xt - q(2, j)
        IF (iord .EQ. 7) CALL PERT_PPM_DH_D(3, q(0:, j), bl(0:), bld(0:)&
&                                     , br(0:), brd(0:), 1)
      END IF
      IF (ie + 1 .EQ. npx) THEN
        bld(npx-2) = p1*(qd(npx-2, j)+qd(npx-3, j)) + p2*(qd(npx-4, j)+&
&         qd(npx-1, j)) - qd(npx-2, j)
        bl(npx-2) = p1*(q(npx-2, j)+q(npx-3, j)) + p2*(q(npx-4, j)+q(npx&
&         -1, j)) - q(npx-2, j)
        xtd = 0.5*((2.*dxa(npx-1, j)+dxa(npx-2, j))*(qd(npx-1, j)+qd(npx&
&         , j))-dxa(npx-1, j)*(qd(npx-2, j)+qd(npx+1, j)))/(dxa(npx-1, j&
&         )+dxa(npx-2, j))
        xt = 0.5*((2.*dxa(npx-1, j)+dxa(npx-2, j))*(q(npx-1, j)+q(npx, j&
&         ))-dxa(npx-1, j)*(q(npx-2, j)+q(npx+1, j)))/(dxa(npx-1, j)+dxa&
&         (npx-2, j))
        brd(npx-1) = xtd - qd(npx-1, j)
        br(npx-1) = xt - q(npx-1, j)
        bld(npx) = xtd - qd(npx, j)
        bl(npx) = xt - q(npx, j)
        xtd = c3*qd(npx, j) + c2*qd(npx+1, j) + c1*qd(npx+2, j)
        xt = c3*q(npx, j) + c2*q(npx+1, j) + c1*q(npx+2, j)
        IF (q(npx, j) .GT. q(npx+1, j)) THEN
          y21d = qd(npx+1, j)
          y21 = q(npx+1, j)
        ELSE
          y21d = qd(npx, j)
          y21 = q(npx, j)
        END IF
        IF (xt .LT. y21) THEN
          xtd = y21d
          xt = y21
        ELSE
          xt = xt
        END IF
        IF (q(npx, j) .LT. q(npx+1, j)) THEN
          y22d = qd(npx+1, j)
          y22 = q(npx+1, j)
        ELSE
          y22d = qd(npx, j)
          y22 = q(npx, j)
        END IF
        IF (xt .GT. y22) THEN
          xtd = y22d
          xt = y22
        ELSE
          xt = xt
        END IF
        brd(npx) = xtd - qd(npx, j)
        br(npx) = xt - q(npx, j)
        xtd = c1*qd(npx-3, j) + c2*qd(npx-2, j) + c3*qd(npx-1, j)
        xt = c1*q(npx-3, j) + c2*q(npx-2, j) + c3*q(npx-1, j)
        IF (q(npx-2, j) .GT. q(npx-1, j)) THEN
          y23d = qd(npx-1, j)
          y23 = q(npx-1, j)
        ELSE
          y23d = qd(npx-2, j)
          y23 = q(npx-2, j)
        END IF
        IF (xt .LT. y23) THEN
          xtd = y23d
          xt = y23
        ELSE
          xt = xt
        END IF
        IF (q(npx-2, j) .LT. q(npx-1, j)) THEN
          y24d = qd(npx-1, j)
          y24 = q(npx-1, j)
        ELSE
          y24d = qd(npx-2, j)
          y24 = q(npx-2, j)
        END IF
        IF (xt .GT. y24) THEN
          xtd = y24d
          xt = y24
        ELSE
          xt = xt
        END IF
        brd(npx-2) = xtd - qd(npx-2, j)
        br(npx-2) = xt - q(npx-2, j)
        bld(npx-1) = xtd - qd(npx-1, j)
        bl(npx-1) = xt - q(npx-1, j)
        IF (iord .EQ. 7) CALL PERT_PPM_DH_D(3, q(npx-2:, j), bl(npx-2:)&
&                                     , bld(npx-2:), br(npx-2:), brd(npx&
&                                     -2:), 1)
      END IF
      DO i=ifirst,ilast+1
        IF (c(i, j) .GT. 0.) THEN
          fluxd(i, j) = qd(i-1, j) + (1.-c(i, j))*(brd(i-1)-cd(i, j)*(bl&
&           (i-1)+br(i-1))-c(i, j)*(bld(i-1)+brd(i-1))) - cd(i, j)*(br(i&
&           -1)-c(i, j)*(bl(i-1)+br(i-1)))
          flux(i, j) = q(i-1, j) + (1.-c(i, j))*(br(i-1)-c(i, j)*(bl(i-1&
&           )+br(i-1)))
        ELSE
          fluxd(i, j) = qd(i, j) + cd(i, j)*(bl(i)+c(i, j)*(bl(i)+br(i))&
&           ) + (1.+c(i, j))*(bld(i)+cd(i, j)*(bl(i)+br(i))+c(i, j)*(bld&
&           (i)+brd(i)))
          flux(i, j) = q(i, j) + (1.+c(i, j))*(bl(i)+c(i, j)*(bl(i)+br(i&
&           )))
        END IF
      END DO
    END DO
  ELSE IF (iord .LE. 10) THEN
    fluxd = 0.0
    dqd = 0.0
    ald = 0.0
    dm1d = 0.0
    bld = 0.0
    brd = 0.0
! iord=8, 9, 10
    DO j=jfirst,jlast
! grid_type check
      IF (grid_type .LT. 3) THEN
        DO i=is-3,ie+2
          dqd(i) = qd(i+1, j) - qd(i, j)
          dq(i) = q(i+1, j) - q(i, j)
        END DO
        DO i=is-2,ie+2
          xtd = 0.25*(qd(i+1, j)-qd(i-1, j))
          xt = 0.25*(q(i+1, j)-q(i-1, j))
          IF (xt .GE. 0.) THEN
            x18d = xtd
            x18 = xt
          ELSE
            x18d = -xtd
            x18 = -xt
          END IF
          IF (q(i-1, j) .LT. q(i, j)) THEN
            IF (q(i, j) .LT. q(i+1, j)) THEN
              max8d = qd(i+1, j)
              max8 = q(i+1, j)
            ELSE
              max8d = qd(i, j)
              max8 = q(i, j)
            END IF
          ELSE IF (q(i-1, j) .LT. q(i+1, j)) THEN
            max8d = qd(i+1, j)
            max8 = q(i+1, j)
          ELSE
            max8d = qd(i-1, j)
            max8 = q(i-1, j)
          END IF
          y25d = max8d - qd(i, j)
          y25 = max8 - q(i, j)
          IF (q(i-1, j) .GT. q(i, j)) THEN
            IF (q(i, j) .GT. q(i+1, j)) THEN
              min30d = qd(i+1, j)
              min30 = q(i+1, j)
            ELSE
              min30d = qd(i, j)
              min30 = q(i, j)
            END IF
          ELSE IF (q(i-1, j) .GT. q(i+1, j)) THEN
            min30d = qd(i+1, j)
            min30 = q(i+1, j)
          ELSE
            min30d = qd(i-1, j)
            min30 = q(i-1, j)
          END IF
          z7d = qd(i, j) - min30d
          z7 = q(i, j) - min30
          IF (x18 .GT. y25) THEN
            IF (y25 .GT. z7) THEN
              min13d = z7d
              min13 = z7
            ELSE
              min13d = y25d
              min13 = y25
            END IF
          ELSE IF (x18 .GT. z7) THEN
            min13d = z7d
            min13 = z7
          ELSE
            min13d = x18d
            min13 = x18
          END IF
          dm1d(i) = min13d*SIGN(1.d0, min13*xt)
          dm1(i) = SIGN(min13, xt)
        END DO
        IF (npx - 2 .GT. ie + 2) THEN
          min14 = ie + 2
        ELSE
          min14 = npx - 2
        END IF
        DO i=is3,min14
          ald(i) = 0.5*(qd(i-1, j)+qd(i, j)) + r3*(dm1d(i-1)-dm1d(i))
          al(i) = 0.5*(q(i-1, j)+q(i, j)) + r3*(dm1(i-1)-dm1(i))
        END DO
        IF (iord .EQ. 8) THEN
          DO i=is3,ie3
            xtd = 2.*dm1d(i)
            xt = 2.*dm1(i)
            IF (xt .GE. 0.) THEN
              x19d = xtd
              x19 = xt
            ELSE
              x19d = -xtd
              x19 = -xt
            END IF
            IF (al(i) - q(i, j) .GE. 0.) THEN
              y26d = ald(i) - qd(i, j)
              y26 = al(i) - q(i, j)
            ELSE
              y26d = -(ald(i)-qd(i, j))
              y26 = -(al(i)-q(i, j))
            END IF
            IF (x19 .GT. y26) THEN
              min15d = y26d
              min15 = y26
            ELSE
              min15d = x19d
              min15 = x19
            END IF
            bld(i) = -(min15d*SIGN(1.d0, min15*xt))
            bl(i) = -SIGN(min15, xt)
            IF (xt .GE. 0.) THEN
              x20d = xtd
              x20 = xt
            ELSE
              x20d = -xtd
              x20 = -xt
            END IF
            IF (al(i+1) - q(i, j) .GE. 0.) THEN
              y27d = ald(i+1) - qd(i, j)
              y27 = al(i+1) - q(i, j)
            ELSE
              y27d = -(ald(i+1)-qd(i, j))
              y27 = -(al(i+1)-q(i, j))
            END IF
            IF (x20 .GT. y27) THEN
              min16d = y27d
              min16 = y27
            ELSE
              min16d = x20d
              min16 = x20
            END IF
            brd(i) = min16d*SIGN(1.d0, min16*xt)
            br(i) = SIGN(min16, xt)
          END DO
        ELSE IF (iord .EQ. 9) THEN
          DO i=is3,ie3
            pmpd = -(2.*dqd(i))
            pmp = -(2.*dq(i))
            lacd = pmpd + 1.5*dqd(i+1)
            lac = pmp + 1.5*dq(i+1)
            IF (0. .LT. pmp) THEN
              IF (pmp .LT. lac) THEN
                x21d = lacd
                x21 = lac
              ELSE
                x21d = pmpd
                x21 = pmp
              END IF
            ELSE IF (0. .LT. lac) THEN
              x21d = lacd
              x21 = lac
            ELSE
              x21 = 0.
              x21d = 0.0
            END IF
            IF (0. .GT. pmp) THEN
              IF (pmp .GT. lac) THEN
                y48d = lacd
                y48 = lac
              ELSE
                y48d = pmpd
                y48 = pmp
              END IF
            ELSE IF (0. .GT. lac) THEN
              y48d = lacd
              y48 = lac
            ELSE
              y48 = 0.
              y48d = 0.0
            END IF
            IF (al(i) - q(i, j) .LT. y48) THEN
              y28d = y48d
              y28 = y48
            ELSE
              y28d = ald(i) - qd(i, j)
              y28 = al(i) - q(i, j)
            END IF
            IF (x21 .GT. y28) THEN
              bld(i) = y28d
              bl(i) = y28
            ELSE
              bld(i) = x21d
              bl(i) = x21
            END IF
            pmpd = 2.*dqd(i-1)
            pmp = 2.*dq(i-1)
            lacd = pmpd - 1.5*dqd(i-2)
            lac = pmp - 1.5*dq(i-2)
            IF (0. .LT. pmp) THEN
              IF (pmp .LT. lac) THEN
                x22d = lacd
                x22 = lac
              ELSE
                x22d = pmpd
                x22 = pmp
              END IF
            ELSE IF (0. .LT. lac) THEN
              x22d = lacd
              x22 = lac
            ELSE
              x22 = 0.
              x22d = 0.0
            END IF
            IF (0. .GT. pmp) THEN
              IF (pmp .GT. lac) THEN
                y49d = lacd
                y49 = lac
              ELSE
                y49d = pmpd
                y49 = pmp
              END IF
            ELSE IF (0. .GT. lac) THEN
              y49d = lacd
              y49 = lac
            ELSE
              y49 = 0.
              y49d = 0.0
            END IF
            IF (al(i+1) - q(i, j) .LT. y49) THEN
              y29d = y49d
              y29 = y49
            ELSE
              y29d = ald(i+1) - qd(i, j)
              y29 = al(i+1) - q(i, j)
            END IF
            IF (x22 .GT. y29) THEN
              brd(i) = y29d
              br(i) = y29
            ELSE
              brd(i) = x22d
              br(i) = x22
            END IF
          END DO
        ELSE
          DO i=is3,ie3
            bld(i) = ald(i) - qd(i, j)
            bl(i) = al(i) - q(i, j)
            brd(i) = ald(i+1) - qd(i, j)
            br(i) = al(i+1) - q(i, j)
            IF (dq(i-1)*dq(i) .LE. 0.) THEN
              pmpd = -(2.*dqd(i))
              pmp = -(2.*dq(i))
              lacd = pmpd + 1.5*dqd(i+1)
              lac = pmp + 1.5*dq(i+1)
              IF (0. .LT. pmp) THEN
                IF (pmp .LT. lac) THEN
                  x23d = lacd
                  x23 = lac
                ELSE
                  x23d = pmpd
                  x23 = pmp
                END IF
              ELSE IF (0. .LT. lac) THEN
                x23d = lacd
                x23 = lac
              ELSE
                x23 = 0.
                x23d = 0.0
              END IF
              IF (0. .GT. pmp) THEN
                IF (pmp .GT. lac) THEN
                  y50d = lacd
                  y50 = lac
                ELSE
                  y50d = pmpd
                  y50 = pmp
                END IF
              ELSE IF (0. .GT. lac) THEN
                y50d = lacd
                y50 = lac
              ELSE
                y50 = 0.
                y50d = 0.0
              END IF
              IF (bl(i) .LT. y50) THEN
                y30d = y50d
                y30 = y50
              ELSE
                y30d = bld(i)
                y30 = bl(i)
              END IF
              IF (x23 .GT. y30) THEN
                bld(i) = y30d
                bl(i) = y30
              ELSE
                bld(i) = x23d
                bl(i) = x23
              END IF
              pmpd = 2.*dqd(i-1)
              pmp = 2.*dq(i-1)
              lacd = pmpd - 1.5*dqd(i-2)
              lac = pmp - 1.5*dq(i-2)
              IF (0. .LT. pmp) THEN
                IF (pmp .LT. lac) THEN
                  x24d = lacd
                  x24 = lac
                ELSE
                  x24d = pmpd
                  x24 = pmp
                END IF
              ELSE IF (0. .LT. lac) THEN
                x24d = lacd
                x24 = lac
              ELSE
                x24 = 0.
                x24d = 0.0
              END IF
              IF (0. .GT. pmp) THEN
                IF (pmp .GT. lac) THEN
                  y51d = lacd
                  y51 = lac
                ELSE
                  y51d = pmpd
                  y51 = pmp
                END IF
              ELSE IF (0. .GT. lac) THEN
                y51d = lacd
                y51 = lac
              ELSE
                y51 = 0.
                y51d = 0.0
              END IF
              IF (br(i) .LT. y51) THEN
                y31d = y51d
                y31 = y51
              ELSE
                y31d = brd(i)
                y31 = br(i)
              END IF
              IF (x24 .GT. y31) THEN
                brd(i) = y31d
                br(i) = y31
              ELSE
                brd(i) = x24d
                br(i) = x24
              END IF
            END IF
          END DO
        END IF
!--------------
! fix the edges
!--------------
        IF (is .EQ. 1) THEN
          brd(2) = ald(3) - qd(2, j)
          br(2) = al(3) - q(2, j)
!             xt = t11*(q(0,j)+q(1,j)) + t12*(q(-1,j)+q(2,j)) + t13*(dm1(2)-dm1(-1))
          xtd = 0.5*((2.*dxa(1, j)+dxa(2, j))*(qd(0, j)+qd(1, j))-dxa(1&
&           , j)*(qd(-1, j)+qd(2, j)))/(dxa(1, j)+dxa(2, j))
          xt = 0.5*((2.*dxa(1, j)+dxa(2, j))*(q(0, j)+q(1, j))-dxa(1, j)&
&           *(q(-1, j)+q(2, j)))/(dxa(1, j)+dxa(2, j))
          bld(1) = xtd - qd(1, j)
          bl(1) = xt - q(1, j)
          brd(0) = xtd - qd(0, j)
          br(0) = xt - q(0, j)
          xtd = s14*dm1d(-1) - s11*dqd(-1) + qd(0, j)
          xt = s14*dm1(-1) - s11*dq(-1) + q(0, j)
!             xt = max( xt, min(q(-1,j),q(0,j)) )
!             xt = min( xt, max(q(-1,j),q(0,j)) )
          bld(0) = xtd - qd(0, j)
          bl(0) = xt - q(0, j)
          xtd = s15*qd(1, j) + s11*qd(2, j) - s14*dm1d(2)
          xt = s15*q(1, j) + s11*q(2, j) - s14*dm1(2)
!             xt = max( xt, min(q(1,j),q(2,j)) )
!             xt = min( xt, max(q(1,j),q(2,j)) )
          brd(1) = xtd - qd(1, j)
          br(1) = xt - q(1, j)
          bld(2) = xtd - qd(2, j)
          bl(2) = xt - q(2, j)
          CALL PERT_PPM_DH_D(3, q(0:, j), bl(0:), bld(0:), br(0:), brd(0&
&                      :), 1)
        END IF
        IF (ie + 1 .EQ. npx) THEN
          bld(npx-2) = ald(npx-2) - qd(npx-2, j)
          bl(npx-2) = al(npx-2) - q(npx-2, j)
!             xt = t11*(q(npx-1,j)+q(npx,j)) + t12*(q(npx-2,j)+q(npx+1,j))   &
!                                            + t13*(dm1(npx+1)-dm1(npx-2))
          xtd = 0.5*((2.*dxa(npx-1, j)+dxa(npx-2, j))*(qd(npx-1, j)+qd(&
&           npx, j))-dxa(npx-1, j)*(qd(npx-2, j)+qd(npx+1, j)))/(dxa(npx&
&           -1, j)+dxa(npx-2, j))
          xt = 0.5*((2.*dxa(npx-1, j)+dxa(npx-2, j))*(q(npx-1, j)+q(npx&
&           , j))-dxa(npx-1, j)*(q(npx-2, j)+q(npx+1, j)))/(dxa(npx-1, j&
&           )+dxa(npx-2, j))
          brd(npx-1) = xtd - qd(npx-1, j)
          br(npx-1) = xt - q(npx-1, j)
          bld(npx) = xtd - qd(npx, j)
          bl(npx) = xt - q(npx, j)
          xtd = s11*dqd(npx) - s14*dm1d(npx+1) + qd(npx, j)
          xt = s11*dq(npx) - s14*dm1(npx+1) + q(npx, j)
!             xt = min( xt, max(q(npx,j), q(npx+1,j)) )
!             xt = max( xt, min(q(npx,j), q(npx+1,j)) )
          brd(npx) = xtd - qd(npx, j)
          br(npx) = xt - q(npx, j)
          xtd = s15*qd(npx-1, j) + s11*qd(npx-2, j) + s14*dm1d(npx-2)
          xt = s15*q(npx-1, j) + s11*q(npx-2, j) + s14*dm1(npx-2)
!             xt = min( xt, max(q(npx-2,j), q(npx-1,j)) )
!             xt = max( xt, min(q(npx-2,j), q(npx-1,j)) )
          brd(npx-2) = xtd - qd(npx-2, j)
          br(npx-2) = xt - q(npx-2, j)
          bld(npx-1) = xtd - qd(npx-1, j)
          bl(npx-1) = xt - q(npx-1, j)
          CALL PERT_PPM_DH_D(3, q(npx-2:, j), bl(npx-2:), bld(npx-2:), &
&                      br(npx-2:), brd(npx-2:), 1)
        END IF
      ELSE
!---------------
! grid_type == 4
!---------------
        DO i=ifirst-2,ilast+2
          xtd = 0.25*(qd(i+1, j)-qd(i-1, j))
          xt = 0.25*(q(i+1, j)-q(i-1, j))
          IF (xt .GE. 0.) THEN
            x25d = xtd
            x25 = xt
          ELSE
            x25d = -xtd
            x25 = -xt
          END IF
          IF (q(i-1, j) .LT. q(i, j)) THEN
            IF (q(i, j) .LT. q(i+1, j)) THEN
              max9d = qd(i+1, j)
              max9 = q(i+1, j)
            ELSE
              max9d = qd(i, j)
              max9 = q(i, j)
            END IF
          ELSE IF (q(i-1, j) .LT. q(i+1, j)) THEN
            max9d = qd(i+1, j)
            max9 = q(i+1, j)
          ELSE
            max9d = qd(i-1, j)
            max9 = q(i-1, j)
          END IF
          y32d = max9d - qd(i, j)
          y32 = max9 - q(i, j)
          IF (q(i-1, j) .GT. q(i, j)) THEN
            IF (q(i, j) .GT. q(i+1, j)) THEN
              min31d = qd(i+1, j)
              min31 = q(i+1, j)
            ELSE
              min31d = qd(i, j)
              min31 = q(i, j)
            END IF
          ELSE IF (q(i-1, j) .GT. q(i+1, j)) THEN
            min31d = qd(i+1, j)
            min31 = q(i+1, j)
          ELSE
            min31d = qd(i-1, j)
            min31 = q(i-1, j)
          END IF
          z8d = qd(i, j) - min31d
          z8 = q(i, j) - min31
          IF (x25 .GT. y32) THEN
            IF (y32 .GT. z8) THEN
              min17d = z8d
              min17 = z8
            ELSE
              min17d = y32d
              min17 = y32
            END IF
          ELSE IF (x25 .GT. z8) THEN
            min17d = z8d
            min17 = z8
          ELSE
            min17d = x25d
            min17 = x25
          END IF
          dm1d(i) = min17d*SIGN(1.d0, min17*xt)
          dm1(i) = SIGN(min17, xt)
        END DO
        DO i=ifirst-1,ilast+2
          ald(i) = 0.5*(qd(i-1, j)+qd(i, j)) + r3*(dm1d(i-1)-dm1d(i))
          al(i) = 0.5*(q(i-1, j)+q(i, j)) + r3*(dm1(i-1)-dm1(i))
        END DO
        DO i=ifirst-3,ilast+2
          dqd(i) = qd(i+1, j) - qd(i, j)
          dq(i) = q(i+1, j) - q(i, j)
        END DO
        DO i=ifirst-1,ilast+1
          pmpd = -(2.*dqd(i))
          pmp = -(2.*dq(i))
          lacd = pmpd + 1.5*dqd(i+1)
          lac = pmp + 1.5*dq(i+1)
          IF (0. .LT. pmp) THEN
            IF (pmp .LT. lac) THEN
              x26d = lacd
              x26 = lac
            ELSE
              x26d = pmpd
              x26 = pmp
            END IF
          ELSE IF (0. .LT. lac) THEN
            x26d = lacd
            x26 = lac
          ELSE
            x26 = 0.
            x26d = 0.0
          END IF
          IF (0. .GT. pmp) THEN
            IF (pmp .GT. lac) THEN
              y52d = lacd
              y52 = lac
            ELSE
              y52d = pmpd
              y52 = pmp
            END IF
          ELSE IF (0. .GT. lac) THEN
            y52d = lacd
            y52 = lac
          ELSE
            y52 = 0.
            y52d = 0.0
          END IF
          IF (al(i) - q(i, j) .LT. y52) THEN
            y33d = y52d
            y33 = y52
          ELSE
            y33d = ald(i) - qd(i, j)
            y33 = al(i) - q(i, j)
          END IF
          IF (x26 .GT. y33) THEN
            bld(i) = y33d
            bl(i) = y33
          ELSE
            bld(i) = x26d
            bl(i) = x26
          END IF
          pmpd = 2.*dqd(i-1)
          pmp = 2.*dq(i-1)
          lacd = pmpd - 1.5*dqd(i-2)
          lac = pmp - 1.5*dq(i-2)
          IF (0. .LT. pmp) THEN
            IF (pmp .LT. lac) THEN
              x27d = lacd
              x27 = lac
            ELSE
              x27d = pmpd
              x27 = pmp
            END IF
          ELSE IF (0. .LT. lac) THEN
            x27d = lacd
            x27 = lac
          ELSE
            x27 = 0.
            x27d = 0.0
          END IF
          IF (0. .GT. pmp) THEN
            IF (pmp .GT. lac) THEN
              y53d = lacd
              y53 = lac
            ELSE
              y53d = pmpd
              y53 = pmp
            END IF
          ELSE IF (0. .GT. lac) THEN
            y53d = lacd
            y53 = lac
          ELSE
            y53 = 0.
            y53d = 0.0
          END IF
          IF (al(i+1) - q(i, j) .LT. y53) THEN
            y34d = y53d
            y34 = y53
          ELSE
            y34d = ald(i+1) - qd(i, j)
            y34 = al(i+1) - q(i, j)
          END IF
          IF (x27 .GT. y34) THEN
            brd(i) = y34d
            br(i) = y34
          ELSE
            brd(i) = x27d
            br(i) = x27
          END IF
        END DO
      END IF
      DO i=ifirst,ilast+1
        IF (c(i, j) .GT. 0.) THEN
          fluxd(i, j) = qd(i-1, j) + (1.-c(i, j))*(brd(i-1)-cd(i, j)*(bl&
&           (i-1)+br(i-1))-c(i, j)*(bld(i-1)+brd(i-1))) - cd(i, j)*(br(i&
&           -1)-c(i, j)*(bl(i-1)+br(i-1)))
          flux(i, j) = q(i-1, j) + (1.-c(i, j))*(br(i-1)-c(i, j)*(bl(i-1&
&           )+br(i-1)))
        ELSE
          fluxd(i, j) = qd(i, j) + cd(i, j)*(bl(i)+c(i, j)*(bl(i)+br(i))&
&           ) + (1.+c(i, j))*(bld(i)+cd(i, j)*(bl(i)+br(i))+c(i, j)*(bld&
&           (i)+brd(i)))
          flux(i, j) = q(i, j) + (1.+c(i, j))*(bl(i)+c(i, j)*(bl(i)+br(i&
&           )))
        END IF
      END DO
    END DO
  ELSE
    fluxd = 0.0
    dqd = 0.0
    ald = 0.0
    dm1d = 0.0
    bld = 0.0
    brd = 0.0
!------------------------------
! For positive definite tracers:
!------------------------------
! iord=11: PPM mono constraint (Lin 2004)
! iord=12: Huynh 2nd constraint (Lin 2004) + positive definite (Lin & Rood 1996)
! iord>12: positive definite only (Lin & Rood 1996)
    DO j=jfirst,jlast
      DO i=is-2,ie+2
        xtd = 0.25*(qd(i+1, j)-qd(i-1, j))
        xt = 0.25*(q(i+1, j)-q(i-1, j))
        IF (xt .GE. 0.) THEN
          x28d = xtd
          x28 = xt
        ELSE
          x28d = -xtd
          x28 = -xt
        END IF
        IF (q(i-1, j) .LT. q(i, j)) THEN
          IF (q(i, j) .LT. q(i+1, j)) THEN
            max10d = qd(i+1, j)
            max10 = q(i+1, j)
          ELSE
            max10d = qd(i, j)
            max10 = q(i, j)
          END IF
        ELSE IF (q(i-1, j) .LT. q(i+1, j)) THEN
          max10d = qd(i+1, j)
          max10 = q(i+1, j)
        ELSE
          max10d = qd(i-1, j)
          max10 = q(i-1, j)
        END IF
        y35d = max10d - qd(i, j)
        y35 = max10 - q(i, j)
        IF (q(i-1, j) .GT. q(i, j)) THEN
          IF (q(i, j) .GT. q(i+1, j)) THEN
            min32d = qd(i+1, j)
            min32 = q(i+1, j)
          ELSE
            min32d = qd(i, j)
            min32 = q(i, j)
          END IF
        ELSE IF (q(i-1, j) .GT. q(i+1, j)) THEN
          min32d = qd(i+1, j)
          min32 = q(i+1, j)
        ELSE
          min32d = qd(i-1, j)
          min32 = q(i-1, j)
        END IF
        z9d = qd(i, j) - min32d
        z9 = q(i, j) - min32
        IF (x28 .GT. y35) THEN
          IF (y35 .GT. z9) THEN
            min18d = z9d
            min18 = z9
          ELSE
            min18d = y35d
            min18 = y35
          END IF
        ELSE IF (x28 .GT. z9) THEN
          min18d = z9d
          min18 = z9
        ELSE
          min18d = x28d
          min18 = x28
        END IF
        dm1d(i) = min18d*SIGN(1.d0, min18*xt)
        dm1(i) = SIGN(min18, xt)
      END DO
      IF (grid_type .LT. 3) THEN
        DO i=is3,ie2
          ald(i) = 0.5*(qd(i-1, j)+qd(i, j)) + r3*(dm1d(i-1)-dm1d(i))
          al(i) = 0.5*(q(i-1, j)+q(i, j)) + r3*(dm1(i-1)-dm1(i))
        END DO
        IF (iord .EQ. 11) THEN
          DO i=is3,ie3
            xtd = 2.*dm1d(i)
            xt = 2.*dm1(i)
            IF (xt .GE. 0.) THEN
              x29d = xtd
              x29 = xt
            ELSE
              x29d = -xtd
              x29 = -xt
            END IF
            IF (al(i) - q(i, j) .GE. 0.) THEN
              y36d = ald(i) - qd(i, j)
              y36 = al(i) - q(i, j)
            ELSE
              y36d = -(ald(i)-qd(i, j))
              y36 = -(al(i)-q(i, j))
            END IF
            IF (x29 .GT. y36) THEN
              min19d = y36d
              min19 = y36
            ELSE
              min19d = x29d
              min19 = x29
            END IF
            bld(i) = -(min19d*SIGN(1.d0, min19*xt))
            bl(i) = -SIGN(min19, xt)
            IF (xt .GE. 0.) THEN
              x30d = xtd
              x30 = xt
            ELSE
              x30d = -xtd
              x30 = -xt
            END IF
            IF (al(i+1) - q(i, j) .GE. 0.) THEN
              y37d = ald(i+1) - qd(i, j)
              y37 = al(i+1) - q(i, j)
            ELSE
              y37d = -(ald(i+1)-qd(i, j))
              y37 = -(al(i+1)-q(i, j))
            END IF
            IF (x30 .GT. y37) THEN
              min20d = y37d
              min20 = y37
            ELSE
              min20d = x30d
              min20 = x30
            END IF
            brd(i) = min20d*SIGN(1.d0, min20*xt)
            br(i) = SIGN(min20, xt)
          END DO
        ELSE IF (iord .EQ. 12) THEN
          DO i=is-3,ie+2
            dqd(i) = qd(i+1, j) - qd(i, j)
            dq(i) = q(i+1, j) - q(i, j)
          END DO
          DO i=is3,ie3
            pmpd = -(2.*dqd(i))
            pmp = -(2.*dq(i))
            lacd = pmpd + 1.5*dqd(i+1)
            lac = pmp + 1.5*dq(i+1)
            IF (0. .LT. pmp) THEN
              IF (pmp .LT. lac) THEN
                x31d = lacd
                x31 = lac
              ELSE
                x31d = pmpd
                x31 = pmp
              END IF
            ELSE IF (0. .LT. lac) THEN
              x31d = lacd
              x31 = lac
            ELSE
              x31 = 0.
              x31d = 0.0
            END IF
            IF (0. .GT. pmp) THEN
              IF (pmp .GT. lac) THEN
                y54d = lacd
                y54 = lac
              ELSE
                y54d = pmpd
                y54 = pmp
              END IF
            ELSE IF (0. .GT. lac) THEN
              y54d = lacd
              y54 = lac
            ELSE
              y54 = 0.
              y54d = 0.0
            END IF
            IF (al(i) - q(i, j) .LT. y54) THEN
              y38d = y54d
              y38 = y54
            ELSE
              y38d = ald(i) - qd(i, j)
              y38 = al(i) - q(i, j)
            END IF
            IF (x31 .GT. y38) THEN
              bld(i) = y38d
              bl(i) = y38
            ELSE
              bld(i) = x31d
              bl(i) = x31
            END IF
            pmpd = 2.*dqd(i-1)
            pmp = 2.*dq(i-1)
            lacd = pmpd - 1.5*dqd(i-2)
            lac = pmp - 1.5*dq(i-2)
            IF (0. .LT. pmp) THEN
              IF (pmp .LT. lac) THEN
                x32d = lacd
                x32 = lac
              ELSE
                x32d = pmpd
                x32 = pmp
              END IF
            ELSE IF (0. .LT. lac) THEN
              x32d = lacd
              x32 = lac
            ELSE
              x32 = 0.
              x32d = 0.0
            END IF
            IF (0. .GT. pmp) THEN
              IF (pmp .GT. lac) THEN
                y55d = lacd
                y55 = lac
              ELSE
                y55d = pmpd
                y55 = pmp
              END IF
            ELSE IF (0. .GT. lac) THEN
              y55d = lacd
              y55 = lac
            ELSE
              y55 = 0.
              y55d = 0.0
            END IF
            IF (al(i+1) - q(i, j) .LT. y55) THEN
              y39d = y55d
              y39 = y55
            ELSE
              y39d = ald(i+1) - qd(i, j)
              y39 = al(i+1) - q(i, j)
            END IF
            IF (x32 .GT. y39) THEN
              brd(i) = y39d
              br(i) = y39
            ELSE
              brd(i) = x32d
              br(i) = x32
            END IF
          END DO
        ELSE
          DO i=is3,ie3
            bld(i) = ald(i) - qd(i, j)
            bl(i) = al(i) - q(i, j)
            brd(i) = ald(i+1) - qd(i, j)
            br(i) = al(i+1) - q(i, j)
          END DO
        END IF
! Positive definite constraint:
        IF (iord .NE. 11) CALL PERT_PPM_DH_D(ie3 - is3 + 1, q(is3:, j), &
&                                      bl(is3:), bld(is3:), br(is3:), &
&                                      brd(is3:), 0)
!--------------
! fix the edges
!--------------
        IF (is .EQ. 1) THEN
          brd(2) = ald(3) - qd(2, j)
          br(2) = al(3) - q(2, j)
!               xt = t11*(q(0,j)+q(1,j)) + t12*(q(-1,j)+q(2,j)) + t13*(dm1(2)-dm1(-1))
!!!             xt = 0.75*(q(0,j)+q(1,j)) - 0.25*(q(-1,j)+q(2,j))
          xtd = 0.5*((2.*dxa(1, j)+dxa(2, j))*(qd(0, j)+qd(1, j))-dxa(1&
&           , j)*(qd(-1, j)+qd(2, j)))/(dxa(1, j)+dxa(2, j))
          xt = 0.5*((2.*dxa(1, j)+dxa(2, j))*(q(0, j)+q(1, j))-dxa(1, j)&
&           *(q(-1, j)+q(2, j)))/(dxa(1, j)+dxa(2, j))
          IF (0. .LT. xt) THEN
            xt = xt
          ELSE
            xt = 0.
            xtd = 0.0
          END IF
          bld(1) = xtd - qd(1, j)
          bl(1) = xt - q(1, j)
          brd(0) = xtd - qd(0, j)
          br(0) = xt - q(0, j)
          xtd = 4.*dm1d(-1)/7. + 11.*qd(-1, j)/14. + 3.*qd(0, j)/14.
          xt = 4./7.*dm1(-1) + 11./14.*q(-1, j) + 3./14.*q(0, j)
          IF (0. .LT. xt) THEN
            xt = xt
          ELSE
            xt = 0.
            xtd = 0.0
          END IF
          bld(0) = xtd - qd(0, j)
          bl(0) = xt - q(0, j)
          xtd = 3.*qd(1, j)/14. + 11.*qd(2, j)/14. - 4.*dm1d(2)/7.
          xt = 3./14.*q(1, j) + 11./14.*q(2, j) - 4./7.*dm1(2)
          IF (0. .LT. xt) THEN
            xt = xt
          ELSE
            xt = 0.
            xtd = 0.0
          END IF
          brd(1) = xtd - qd(1, j)
          br(1) = xt - q(1, j)
          bld(2) = xtd - qd(2, j)
          bl(2) = xt - q(2, j)
          CALL PERT_PPM_DH_D(3, q(0:, j), bl(0:), bld(0:), br(0:), brd(0&
&                      :), 1)
        END IF
        IF (ie + 1 .EQ. npx) THEN
          bld(npx-2) = ald(npx-2) - qd(npx-2, j)
          bl(npx-2) = al(npx-2) - q(npx-2, j)
!               xt = t11*(q(npx-1,j)+q(npx,j)) + t12*(q(npx-2,j)+q(npx+1,j))   &
!                  + t13*(dm1(npx+1)-dm1(npx-2))
!!!             xt = 0.75*(q(npx-1,j)+q(npx,j)) - 0.25*(q(npx-2,j)+q(npx+1,j))
          xtd = 0.5*((2.*dxa(npx-1, j)+dxa(npx-2, j))*(qd(npx-1, j)+qd(&
&           npx, j))-dxa(npx-1, j)*(qd(npx-2, j)+qd(npx+1, j)))/(dxa(npx&
&           -1, j)+dxa(npx-2, j))
          xt = 0.5*((2.*dxa(npx-1, j)+dxa(npx-2, j))*(q(npx-1, j)+q(npx&
&           , j))-dxa(npx-1, j)*(q(npx-2, j)+q(npx+1, j)))/(dxa(npx-1, j&
&           )+dxa(npx-2, j))
          IF (0. .LT. xt) THEN
            xt = xt
          ELSE
            xt = 0.
            xtd = 0.0
          END IF
          brd(npx-1) = xtd - qd(npx-1, j)
          br(npx-1) = xt - q(npx-1, j)
          bld(npx) = xtd - qd(npx, j)
          bl(npx) = xt - q(npx, j)
!               br(npx) = 11./14.*q(npx+1,j) + 3./14.*q(npx,j) - 4./7.*dm1(npx+1)
          xtd = 11.*qd(npx+1, j)/14. + 3.*qd(npx, j)/14. - 4.*dm1d(npx+1&
&           )/7.
          xt = 11./14.*q(npx+1, j) + 3./14.*q(npx, j) - 4./7.*dm1(npx+1)
          IF (0. .LT. xt) THEN
            xt = xt
          ELSE
            xt = 0.
            xtd = 0.0
          END IF
          brd(npx) = xtd - qd(npx, j)
          br(npx) = xt - q(npx, j)
          xtd = 3.*qd(npx-1, j)/14. + 11.*qd(npx-2, j)/14. + 4.*dm1d(npx&
&           -2)/7.
          xt = 3./14.*q(npx-1, j) + 11./14.*q(npx-2, j) + 4./7.*dm1(npx-&
&           2)
          IF (0. .LT. xt) THEN
            xt = xt
          ELSE
            xt = 0.
            xtd = 0.0
          END IF
          brd(npx-2) = xtd - qd(npx-2, j)
          br(npx-2) = xt - q(npx-2, j)
          bld(npx-1) = xtd - qd(npx-1, j)
          bl(npx-1) = xt - q(npx-1, j)
          CALL PERT_PPM_DH_D(3, q(npx-2:, j), bl(npx-2:), bld(npx-2:), &
&                      br(npx-2:), brd(npx-2:), 1)
        END IF
      ELSE
!--------------
! grid_type >=4
!--------------
        DO i=ifirst-1,ilast+2
          ald(i) = 0.5*(qd(i-1, j)+qd(i, j)) + r3*(dm1d(i-1)-dm1d(i))
          al(i) = 0.5*(q(i-1, j)+q(i, j)) + r3*(dm1(i-1)-dm1(i))
        END DO
        IF (iord .EQ. 11) THEN
          DO i=ifirst-1,ilast+1
            xtd = 2.*dm1d(i)
            xt = 2.*dm1(i)
            IF (xt .GE. 0.) THEN
              x33d = xtd
              x33 = xt
            ELSE
              x33d = -xtd
              x33 = -xt
            END IF
            IF (al(i) - q(i, j) .GE. 0.) THEN
              y40d = ald(i) - qd(i, j)
              y40 = al(i) - q(i, j)
            ELSE
              y40d = -(ald(i)-qd(i, j))
              y40 = -(al(i)-q(i, j))
            END IF
            IF (x33 .GT. y40) THEN
              min21d = y40d
              min21 = y40
            ELSE
              min21d = x33d
              min21 = x33
            END IF
            bld(i) = -(min21d*SIGN(1.d0, min21*xt))
            bl(i) = -SIGN(min21, xt)
            IF (xt .GE. 0.) THEN
              x34d = xtd
              x34 = xt
            ELSE
              x34d = -xtd
              x34 = -xt
            END IF
            IF (al(i+1) - q(i, j) .GE. 0.) THEN
              y41d = ald(i+1) - qd(i, j)
              y41 = al(i+1) - q(i, j)
            ELSE
              y41d = -(ald(i+1)-qd(i, j))
              y41 = -(al(i+1)-q(i, j))
            END IF
            IF (x34 .GT. y41) THEN
              min22d = y41d
              min22 = y41
            ELSE
              min22d = x34d
              min22 = x34
            END IF
            brd(i) = min22d*SIGN(1.d0, min22*xt)
            br(i) = SIGN(min22, xt)
          END DO
        ELSE IF (iord .EQ. 12) THEN
          DO i=ifirst-3,ilast+2
            dqd(i) = qd(i+1, j) - qd(i, j)
            dq(i) = q(i+1, j) - q(i, j)
          END DO
          DO i=ifirst-1,ilast+1
            pmpd = -(2.*dqd(i))
            pmp = -(2.*dq(i))
            lacd = pmpd + 1.5*dqd(i+1)
            lac = pmp + 1.5*dq(i+1)
            IF (0. .LT. pmp) THEN
              IF (pmp .LT. lac) THEN
                x35d = lacd
                x35 = lac
              ELSE
                x35d = pmpd
                x35 = pmp
              END IF
            ELSE IF (0. .LT. lac) THEN
              x35d = lacd
              x35 = lac
            ELSE
              x35 = 0.
              x35d = 0.0
            END IF
            IF (0. .GT. pmp) THEN
              IF (pmp .GT. lac) THEN
                y56d = lacd
                y56 = lac
              ELSE
                y56d = pmpd
                y56 = pmp
              END IF
            ELSE IF (0. .GT. lac) THEN
              y56d = lacd
              y56 = lac
            ELSE
              y56 = 0.
              y56d = 0.0
            END IF
            IF (al(i) - q(i, j) .LT. y56) THEN
              y42d = y56d
              y42 = y56
            ELSE
              y42d = ald(i) - qd(i, j)
              y42 = al(i) - q(i, j)
            END IF
            IF (x35 .GT. y42) THEN
              bld(i) = y42d
              bl(i) = y42
            ELSE
              bld(i) = x35d
              bl(i) = x35
            END IF
            pmpd = 2.*dqd(i-1)
            pmp = 2.*dq(i-1)
            lacd = pmpd - 1.5*dqd(i-2)
            lac = pmp - 1.5*dq(i-2)
            IF (0. .LT. pmp) THEN
              IF (pmp .LT. lac) THEN
                x36d = lacd
                x36 = lac
              ELSE
                x36d = pmpd
                x36 = pmp
              END IF
            ELSE IF (0. .LT. lac) THEN
              x36d = lacd
              x36 = lac
            ELSE
              x36 = 0.
              x36d = 0.0
            END IF
            IF (0. .GT. pmp) THEN
              IF (pmp .GT. lac) THEN
                y57d = lacd
                y57 = lac
              ELSE
                y57d = pmpd
                y57 = pmp
              END IF
            ELSE IF (0. .GT. lac) THEN
              y57d = lacd
              y57 = lac
            ELSE
              y57 = 0.
              y57d = 0.0
            END IF
            IF (al(i+1) - q(i, j) .LT. y57) THEN
              y43d = y57d
              y43 = y57
            ELSE
              y43d = ald(i+1) - qd(i, j)
              y43 = al(i+1) - q(i, j)
            END IF
            IF (x36 .GT. y43) THEN
              brd(i) = y43d
              br(i) = y43
            ELSE
              brd(i) = x36d
              br(i) = x36
            END IF
          END DO
        ELSE
          DO i=is-1,ie+1
            bld(i) = ald(i) - qd(i, j)
            bl(i) = al(i) - q(i, j)
            brd(i) = ald(i+1) - qd(i, j)
            br(i) = al(i+1) - q(i, j)
          END DO
        END IF
! Positive definite constraint:
        IF (iord .NE. 11) CALL PERT_PPM_DH_D(ie - is + 3, q(is-1:, j), &
&                                      bl(is-1:), bld(is-1:), br(is-1:)&
&                                      , brd(is-1:), 0)
      END IF
      DO i=ifirst,ilast+1
        IF (c(i, j) .GT. 0.) THEN
          fluxd(i, j) = qd(i-1, j) + (1.-c(i, j))*(brd(i-1)-cd(i, j)*(bl&
&           (i-1)+br(i-1))-c(i, j)*(bld(i-1)+brd(i-1))) - cd(i, j)*(br(i&
&           -1)-c(i, j)*(bl(i-1)+br(i-1)))
          flux(i, j) = q(i-1, j) + (1.-c(i, j))*(br(i-1)-c(i, j)*(bl(i-1&
&           )+br(i-1)))
        ELSE
          fluxd(i, j) = qd(i, j) + cd(i, j)*(bl(i)+c(i, j)*(bl(i)+br(i))&
&           ) + (1.+c(i, j))*(bld(i)+cd(i, j)*(bl(i)+br(i))+c(i, j)*(bld&
&           (i)+brd(i)))
          flux(i, j) = q(i, j) + (1.+c(i, j))*(bl(i)+c(i, j)*(bl(i)+br(i&
&           )))
        END IF
      END DO
    END DO
  END IF
END SUBROUTINE FXPPM_D

!  Differentiation of pert_ppm_dh in forward (tangent) mode:
!   variations   of useful results: al ar
!   with respect to varying inputs: al ar
SUBROUTINE PERT_PPM_DH_D(im, a0, al, ald, ar, ard, iv)
  IMPLICIT NONE
  INTEGER, INTENT(IN) :: im
  INTEGER, INTENT(IN) :: iv
  REAL*4, INTENT(IN) :: a0(im)
  REAL*4, INTENT(INOUT) :: al(im), ar(im)
  REAL*4, INTENT(INOUT) :: ald(im), ard(im)
! Local:
  REAL*4 :: a4, da1, da2, a6da, fmin
  INTEGER :: i
  REAL*4, PARAMETER :: r12=1./12.
  INTRINSIC ABS
  REAL*4 :: abs0
!-----------------------------------
! Optimized PPM in perturbation form:
!-----------------------------------
  IF (iv .EQ. 0) THEN
! Positive definite constraint
    DO i=1,im
      a4 = -(3.*(ar(i)+al(i)))
      da1 = ar(i) - al(i)
      IF (da1 .GE. 0.) THEN
        abs0 = da1
      ELSE
        abs0 = -da1
      END IF
      IF (abs0 .LT. -a4) THEN
        fmin = a0(i) + 0.25/a4*da1**2 + a4*r12
        IF (fmin .LT. 0.) THEN
          IF (ar(i) .GT. 0. .AND. al(i) .GT. 0.) THEN
            ard(i) = 0.0_4
            ar(i) = 0.
            ald(i) = 0.0_4
            al(i) = 0.
          ELSE IF (da1 .GT. 0.) THEN
            ard(i) = -(2.*ald(i))
            ar(i) = -(2.*al(i))
          ELSE
            ald(i) = -(2.*ard(i))
            al(i) = -(2.*ar(i))
          END IF
        END IF
      END IF
    END DO
  ELSE
! Standard PPM constraint
    DO i=1,im
      IF (al(i)*ar(i) .LT. 0.) THEN
        da1 = al(i) - ar(i)
        da2 = da1**2
        a6da = 3.*(al(i)+ar(i))*da1
        IF (a6da .LT. -da2) THEN
          ard(i) = -(2.*ald(i))
          ar(i) = -(2.*al(i))
        ELSE IF (a6da .GT. da2) THEN
          ald(i) = -(2.*ard(i))
          al(i) = -(2.*ar(i))
        END IF
      ELSE
! effect of dm=0 included here
        ald(i) = 0.0_4
        al(i) = 0.
        ard(i) = 0.0_4
        ar(i) = 0.
      END IF
    END DO
  END IF
END SUBROUTINE PERT_PPM_DH_D

