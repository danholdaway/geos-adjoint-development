!        Generated by TAPENADE     (INRIA, Ecuador team)
!  Tapenade 3.13 (r6666) - 27 Nov 2017 17:09
!
MODULE A2D_MOD_DIFF
  IMPLICIT NONE
!-----------------
  INTEGER, PARAMETER :: kind_real=8
  PRIVATE 
  PUBLIC a2d
  PUBLIC a2d_tlm
  TYPE DOMAIN2D
      INTEGER :: dummy
  END TYPE DOMAIN2D
!data domain
!compute domain
!x/y/z-dir grid edge points per tile
!Processor layout for computation
!Processor layout for read/write
!Number of halo points, normally 3
!FV3 nml file associated with this geom
!Size of cubed sphere grid (cell center)
!MPP domain
!Tile ID
!Number of tiles, always 6
!Stackmax
!Longitude at cell center
!Latitude at cell center
!Longitude at cell center
!Latitude at cell center
!Grid area
!Model level coefficients
!Pressure at top of domain
  TYPE FV3JEDI_GEOM
      INTEGER :: isd, ied, jsd, jed
      INTEGER :: isc, iec, jsc, jec
      INTEGER :: npx, npy, npz
      INTEGER :: layout(2)
      INTEGER :: io_layout(2)
      INTEGER :: halo
      CHARACTER(len=255) :: nml_file
      INTEGER :: size_cubic_grid
      TYPE(DOMAIN2D) :: domain
      INTEGER :: ntile
      INTEGER :: ntiles=6
      INTEGER :: stackmax
      REAL(kind=kind_real), ALLOCATABLE :: grid_lon(:, :)
      REAL(kind=kind_real), ALLOCATABLE :: grid_lat(:, :)
      REAL(kind=kind_real), ALLOCATABLE :: egrid_lon(:, :)
      REAL(kind=kind_real), ALLOCATABLE :: egrid_lat(:, :)
      REAL(kind=kind_real), ALLOCATABLE :: area(:, :)
      REAL(kind=kind_real), ALLOCATABLE :: ak(:), bk(:)
      REAL(kind=kind_real) :: ptop
      REAL(kind=kind_real), ALLOCATABLE :: sin_sg(:, :, :)
      REAL(kind=kind_real), ALLOCATABLE :: cos_sg(:, :, :)
      REAL(kind=kind_real), ALLOCATABLE :: cosa_u(:, :)
      REAL(kind=kind_real), ALLOCATABLE :: cosa_v(:, :)
      REAL(kind=kind_real), ALLOCATABLE :: cosa_s(:, :)
      REAL(kind=kind_real), ALLOCATABLE :: rsin_u(:, :)
      REAL(kind=kind_real), ALLOCATABLE :: rsin_v(:, :)
      REAL(kind=kind_real), ALLOCATABLE :: rsin2(:, :)
      REAL(kind=kind_real), ALLOCATABLE :: dxa(:, :)
      REAL(kind=kind_real), ALLOCATABLE :: dya(:, :)
      REAL(kind=kind_real), ALLOCATABLE :: dx(:, :)
      REAL(kind=kind_real), ALLOCATABLE :: dy(:, :)
      REAL(kind=kind_real), ALLOCATABLE :: dxc(:, :)
      REAL(kind=kind_real), ALLOCATABLE :: dyc(:, :)
      REAL(kind=kind_real), ALLOCATABLE :: rarea(:, :)
      REAL(kind=kind_real), ALLOCATABLE :: rarea_c(:, :)
      REAL(kind=kind_real), ALLOCATABLE :: edge_w(:)
      REAL(kind=kind_real), ALLOCATABLE :: edge_e(:)
      REAL(kind=kind_real), ALLOCATABLE :: edge_s(:)
      REAL(kind=kind_real), ALLOCATABLE :: edge_n(:)
      REAL(kind=kind_real), ALLOCATABLE :: grid(:, :, :)
      REAL(kind=kind_real), ALLOCATABLE :: agrid(:, :, :)
      LOGICAL :: sw_corner, se_corner, ne_corner, nw_corner
      REAL(kind=kind_real), ALLOCATABLE :: vlon(:, :, :)
      REAL(kind=kind_real), ALLOCATABLE :: vlat(:, :, :)
      REAL(kind=kind_real), ALLOCATABLE :: edge_vect_n(:)
      REAL(kind=kind_real), ALLOCATABLE :: edge_vect_e(:)
      REAL(kind=kind_real), ALLOCATABLE :: edge_vect_s(:)
      REAL(kind=kind_real), ALLOCATABLE :: edge_vect_w(:)
      REAL(kind=kind_real), ALLOCATABLE :: es(:, :, :, :)
      REAL(kind=kind_real), ALLOCATABLE :: ew(:, :, :, :)
  END TYPE FV3JEDI_GEOM

CONTAINS
!  Differentiation of a2d in forward (tangent) mode:
!   variations   of useful results: ud vd
!   with respect to varying inputs: ua ud va vd
!   RW status of diff variables: ua:in ud:in-out va:in vd:in-out
  SUBROUTINE A2D_TLM(geom, ua, ua_tl, va, va_tl, ud, ud_tl, vd, vd_tl)
    IMPLICIT NONE
    TYPE(FV3JEDI_GEOM), INTENT(INOUT) :: geom
    REAL(kind=kind_real), INTENT(IN) :: ua(geom%isc:geom%iec, geom%jsc:&
&   geom%jec, geom%npz)
    REAL(kind=kind_real), INTENT(IN) :: ua_tl(geom%isc:geom%iec, geom%&
&   jsc:geom%jec, geom%npz)
    REAL(kind=kind_real), INTENT(IN) :: va(geom%isc:geom%iec, geom%jsc:&
&   geom%jec, geom%npz)
    REAL(kind=kind_real), INTENT(IN) :: va_tl(geom%isc:geom%iec, geom%&
&   jsc:geom%jec, geom%npz)
    REAL(kind=kind_real), INTENT(INOUT) :: ud(geom%isc:geom%iec, geom%&
&   jsc:geom%jec+1, geom%npz)
    REAL(kind=kind_real), INTENT(INOUT) :: ud_tl(geom%isc:geom%iec, geom&
&   %jsc:geom%jec+1, geom%npz)
    REAL(kind=kind_real), INTENT(INOUT) :: vd(geom%isc:geom%iec+1, geom%&
&   jsc:geom%jec, geom%npz)
    REAL(kind=kind_real), INTENT(INOUT) :: vd_tl(geom%isc:geom%iec+1, &
&   geom%jsc:geom%jec, geom%npz)
    INTEGER :: is, ie, js, je
    INTEGER :: npx, npy, npz
    INTEGER :: i, j, k, im2, jm2
    REAL(kind=kind_real) :: uatemp(geom%isd:geom%ied, geom%jsd:geom%jed&
&   , geom%npz)
    REAL(kind=kind_real) :: uatemp_tl(geom%isd:geom%ied, geom%jsd:geom%&
&   jed, geom%npz)
    REAL(kind=kind_real) :: vatemp(geom%isd:geom%ied, geom%jsd:geom%jed&
&   , geom%npz)
    REAL(kind=kind_real) :: vatemp_tl(geom%isd:geom%ied, geom%jsd:geom%&
&   jed, geom%npz)
    REAL(kind=kind_real) :: v3(geom%isc-1:geom%iec+1, geom%jsc-1:geom%&
&   jec+1, 3)
    REAL(kind=kind_real) :: v3_tl(geom%isc-1:geom%iec+1, geom%jsc-1:geom&
&   %jec+1, 3)
! 3D winds at edges
    REAL(kind=kind_real) :: ue(geom%isc-1:geom%iec+1, geom%jsc:geom%jec+&
&   1, 3)
    REAL(kind=kind_real) :: ue_tl(geom%isc-1:geom%iec+1, geom%jsc:geom%&
&   jec+1, 3)
! 3D winds at edges
    REAL(kind=kind_real) :: ve(geom%isc:geom%iec+1, geom%jsc-1:geom%jec+&
&   1, 3)
    REAL(kind=kind_real) :: ve_tl(geom%isc:geom%iec+1, geom%jsc-1:geom%&
&   jec+1, 3)
    REAL(kind=kind_real), DIMENSION(geom%isc:geom%iec) :: ut1, ut2, ut3
    REAL(kind=kind_real), DIMENSION(geom%isc:geom%iec) :: ut1_tl, ut2_tl&
&   , ut3_tl
    REAL(kind=kind_real), DIMENSION(geom%jsc:geom%jec) :: vt1, vt2, vt3
    REAL(kind=kind_real), DIMENSION(geom%jsc:geom%jec) :: vt1_tl, vt2_tl&
&   , vt3_tl
    npx = geom%npx
    npy = geom%npy
    npz = geom%npz
    is = geom%isc
    ie = geom%iec
    js = geom%jsc
    je = geom%jec
    im2 = (npx-1)/2
    jm2 = (npy-1)/2
    uatemp(:, :, :) = 0.0
    vatemp(:, :, :) = 0.0
    uatemp_tl = 0.0_8
    uatemp_tl(is:ie, js:je, :) = ua_tl
    uatemp(is:ie, js:je, :) = ua
    vatemp_tl = 0.0_8
    vatemp_tl(is:ie, js:je, :) = va_tl
    vatemp(is:ie, js:je, :) = va
    CALL MPP_UPDATE_DOMAINS_TLM(uatemp, uatemp_tl, geom%domain, complete&
&                         =.false.)
    CALL MPP_UPDATE_DOMAINS_TLM(vatemp, vatemp_tl, geom%domain, complete&
&                         =.true.)
    v3_tl = 0.0_8
    ue_tl = 0.0_8
    vt1_tl = 0.0_8
    vt2_tl = 0.0_8
    vt3_tl = 0.0_8
    ve_tl = 0.0_8
    ut1_tl = 0.0_8
    ut2_tl = 0.0_8
    ut3_tl = 0.0_8
    DO k=1,npz
      DO j=js-1,je+1
        DO i=is-1,ie+1
          v3_tl(i, j, 1) = geom%vlon(i, j, 1)*uatemp_tl(i, j, k) + geom%&
&           vlat(i, j, 1)*vatemp_tl(i, j, k)
          v3(i, j, 1) = uatemp(i, j, k)*geom%vlon(i, j, 1) + vatemp(i, j&
&           , k)*geom%vlat(i, j, 1)
          v3_tl(i, j, 2) = geom%vlon(i, j, 2)*uatemp_tl(i, j, k) + geom%&
&           vlat(i, j, 2)*vatemp_tl(i, j, k)
          v3(i, j, 2) = uatemp(i, j, k)*geom%vlon(i, j, 2) + vatemp(i, j&
&           , k)*geom%vlat(i, j, 2)
          v3_tl(i, j, 3) = geom%vlon(i, j, 3)*uatemp_tl(i, j, k) + geom%&
&           vlat(i, j, 3)*vatemp_tl(i, j, k)
          v3(i, j, 3) = uatemp(i, j, k)*geom%vlon(i, j, 3) + vatemp(i, j&
&           , k)*geom%vlat(i, j, 3)
        END DO
      END DO
      DO j=js,je+1
        DO i=is-1,ie+1
          ue_tl(i, j, 1) = v3_tl(i, j-1, 1) + v3_tl(i, j, 1)
          ue(i, j, 1) = v3(i, j-1, 1) + v3(i, j, 1)
          ue_tl(i, j, 2) = v3_tl(i, j-1, 2) + v3_tl(i, j, 2)
          ue(i, j, 2) = v3(i, j-1, 2) + v3(i, j, 2)
          ue_tl(i, j, 3) = v3_tl(i, j-1, 3) + v3_tl(i, j, 3)
          ue(i, j, 3) = v3(i, j-1, 3) + v3(i, j, 3)
        END DO
      END DO
      DO j=js-1,je+1
        DO i=is,ie+1
          ve_tl(i, j, 1) = v3_tl(i-1, j, 1) + v3_tl(i, j, 1)
          ve(i, j, 1) = v3(i-1, j, 1) + v3(i, j, 1)
          ve_tl(i, j, 2) = v3_tl(i-1, j, 2) + v3_tl(i, j, 2)
          ve(i, j, 2) = v3(i-1, j, 2) + v3(i, j, 2)
          ve_tl(i, j, 3) = v3_tl(i-1, j, 3) + v3_tl(i, j, 3)
          ve(i, j, 3) = v3(i-1, j, 3) + v3(i, j, 3)
        END DO
      END DO
      IF (is .EQ. 1) THEN
!i = 1
        DO j=js,je
          IF (j .GT. jm2) THEN
            vt1_tl(j) = geom%edge_vect_w(j)*ve_tl(1, j-1, 1) + (1.-geom%&
&             edge_vect_w(j))*ve_tl(1, j, 1)
            vt1(j) = geom%edge_vect_w(j)*ve(1, j-1, 1) + (1.-geom%&
&             edge_vect_w(j))*ve(1, j, 1)
            vt2_tl(j) = geom%edge_vect_w(j)*ve_tl(1, j-1, 2) + (1.-geom%&
&             edge_vect_w(j))*ve_tl(1, j, 2)
            vt2(j) = geom%edge_vect_w(j)*ve(1, j-1, 2) + (1.-geom%&
&             edge_vect_w(j))*ve(1, j, 2)
            vt3_tl(j) = geom%edge_vect_w(j)*ve_tl(1, j-1, 3) + (1.-geom%&
&             edge_vect_w(j))*ve_tl(1, j, 3)
            vt3(j) = geom%edge_vect_w(j)*ve(1, j-1, 3) + (1.-geom%&
&             edge_vect_w(j))*ve(1, j, 3)
          ELSE
            vt1_tl(j) = geom%edge_vect_w(j)*ve_tl(1, j+1, 1) + (1.-geom%&
&             edge_vect_w(j))*ve_tl(1, j, 1)
            vt1(j) = geom%edge_vect_w(j)*ve(1, j+1, 1) + (1.-geom%&
&             edge_vect_w(j))*ve(1, j, 1)
            vt2_tl(j) = geom%edge_vect_w(j)*ve_tl(1, j+1, 2) + (1.-geom%&
&             edge_vect_w(j))*ve_tl(1, j, 2)
            vt2(j) = geom%edge_vect_w(j)*ve(1, j+1, 2) + (1.-geom%&
&             edge_vect_w(j))*ve(1, j, 2)
            vt3_tl(j) = geom%edge_vect_w(j)*ve_tl(1, j+1, 3) + (1.-geom%&
&             edge_vect_w(j))*ve_tl(1, j, 3)
            vt3(j) = geom%edge_vect_w(j)*ve(1, j+1, 3) + (1.-geom%&
&             edge_vect_w(j))*ve(1, j, 3)
          END IF
        END DO
        DO j=js,je
          ve_tl(1, j, 1) = vt1_tl(j)
          ve(1, j, 1) = vt1(j)
          ve_tl(1, j, 2) = vt2_tl(j)
          ve(1, j, 2) = vt2(j)
          ve_tl(1, j, 3) = vt3_tl(j)
          ve(1, j, 3) = vt3(j)
        END DO
      END IF
      IF (ie + 1 .EQ. npx) THEN
!i = npx
        DO j=js,je
          IF (j .GT. jm2) THEN
            vt1_tl(j) = geom%edge_vect_e(j)*ve_tl(npx, j-1, 1) + (1.-&
&             geom%edge_vect_e(j))*ve_tl(npx, j, 1)
            vt1(j) = geom%edge_vect_e(j)*ve(npx, j-1, 1) + (1.-geom%&
&             edge_vect_e(j))*ve(npx, j, 1)
            vt2_tl(j) = geom%edge_vect_e(j)*ve_tl(npx, j-1, 2) + (1.-&
&             geom%edge_vect_e(j))*ve_tl(npx, j, 2)
            vt2(j) = geom%edge_vect_e(j)*ve(npx, j-1, 2) + (1.-geom%&
&             edge_vect_e(j))*ve(npx, j, 2)
            vt3_tl(j) = geom%edge_vect_e(j)*ve_tl(npx, j-1, 3) + (1.-&
&             geom%edge_vect_e(j))*ve_tl(npx, j, 3)
            vt3(j) = geom%edge_vect_e(j)*ve(npx, j-1, 3) + (1.-geom%&
&             edge_vect_e(j))*ve(npx, j, 3)
          ELSE
            vt1_tl(j) = geom%edge_vect_e(j)*ve_tl(npx, j+1, 1) + (1.-&
&             geom%edge_vect_e(j))*ve_tl(npx, j, 1)
            vt1(j) = geom%edge_vect_e(j)*ve(npx, j+1, 1) + (1.-geom%&
&             edge_vect_e(j))*ve(npx, j, 1)
            vt2_tl(j) = geom%edge_vect_e(j)*ve_tl(npx, j+1, 2) + (1.-&
&             geom%edge_vect_e(j))*ve_tl(npx, j, 2)
            vt2(j) = geom%edge_vect_e(j)*ve(npx, j+1, 2) + (1.-geom%&
&             edge_vect_e(j))*ve(npx, j, 2)
            vt3_tl(j) = geom%edge_vect_e(j)*ve_tl(npx, j+1, 3) + (1.-&
&             geom%edge_vect_e(j))*ve_tl(npx, j, 3)
            vt3(j) = geom%edge_vect_e(j)*ve(npx, j+1, 3) + (1.-geom%&
&             edge_vect_e(j))*ve(npx, j, 3)
          END IF
        END DO
        DO j=js,je
          ve_tl(npx, j, 1) = vt1_tl(j)
          ve(npx, j, 1) = vt1(j)
          ve_tl(npx, j, 2) = vt2_tl(j)
          ve(npx, j, 2) = vt2(j)
          ve_tl(npx, j, 3) = vt3_tl(j)
          ve(npx, j, 3) = vt3(j)
        END DO
      END IF
      IF (js .EQ. 1) THEN
!j = 1
        DO i=is,ie
          IF (i .GT. im2) THEN
            ut1_tl(i) = geom%edge_vect_s(i)*ue_tl(i-1, 1, 1) + (1.-geom%&
&             edge_vect_s(i))*ue_tl(i, 1, 1)
            ut1(i) = geom%edge_vect_s(i)*ue(i-1, 1, 1) + (1.-geom%&
&             edge_vect_s(i))*ue(i, 1, 1)
            ut2_tl(i) = geom%edge_vect_s(i)*ue_tl(i-1, 1, 2) + (1.-geom%&
&             edge_vect_s(i))*ue_tl(i, 1, 2)
            ut2(i) = geom%edge_vect_s(i)*ue(i-1, 1, 2) + (1.-geom%&
&             edge_vect_s(i))*ue(i, 1, 2)
            ut3_tl(i) = geom%edge_vect_s(i)*ue_tl(i-1, 1, 3) + (1.-geom%&
&             edge_vect_s(i))*ue_tl(i, 1, 3)
            ut3(i) = geom%edge_vect_s(i)*ue(i-1, 1, 3) + (1.-geom%&
&             edge_vect_s(i))*ue(i, 1, 3)
          ELSE
            ut1_tl(i) = geom%edge_vect_s(i)*ue_tl(i+1, 1, 1) + (1.-geom%&
&             edge_vect_s(i))*ue_tl(i, 1, 1)
            ut1(i) = geom%edge_vect_s(i)*ue(i+1, 1, 1) + (1.-geom%&
&             edge_vect_s(i))*ue(i, 1, 1)
            ut2_tl(i) = geom%edge_vect_s(i)*ue_tl(i+1, 1, 2) + (1.-geom%&
&             edge_vect_s(i))*ue_tl(i, 1, 2)
            ut2(i) = geom%edge_vect_s(i)*ue(i+1, 1, 2) + (1.-geom%&
&             edge_vect_s(i))*ue(i, 1, 2)
            ut3_tl(i) = geom%edge_vect_s(i)*ue_tl(i+1, 1, 3) + (1.-geom%&
&             edge_vect_s(i))*ue_tl(i, 1, 3)
            ut3(i) = geom%edge_vect_s(i)*ue(i+1, 1, 3) + (1.-geom%&
&             edge_vect_s(i))*ue(i, 1, 3)
          END IF
        END DO
        DO i=is,ie
          ue_tl(i, 1, 1) = ut1_tl(i)
          ue(i, 1, 1) = ut1(i)
          ue_tl(i, 1, 2) = ut2_tl(i)
          ue(i, 1, 2) = ut2(i)
          ue_tl(i, 1, 3) = ut3_tl(i)
          ue(i, 1, 3) = ut3(i)
        END DO
      END IF
      IF (je + 1 .EQ. npy) THEN
!j = npy
        DO i=is,ie
          IF (i .GT. im2) THEN
            ut1_tl(i) = geom%edge_vect_n(i)*ue_tl(i-1, npy, 1) + (1.-&
&             geom%edge_vect_n(i))*ue_tl(i, npy, 1)
            ut1(i) = geom%edge_vect_n(i)*ue(i-1, npy, 1) + (1.-geom%&
&             edge_vect_n(i))*ue(i, npy, 1)
            ut2_tl(i) = geom%edge_vect_n(i)*ue_tl(i-1, npy, 2) + (1.-&
&             geom%edge_vect_n(i))*ue_tl(i, npy, 2)
            ut2(i) = geom%edge_vect_n(i)*ue(i-1, npy, 2) + (1.-geom%&
&             edge_vect_n(i))*ue(i, npy, 2)
            ut3_tl(i) = geom%edge_vect_n(i)*ue_tl(i-1, npy, 3) + (1.-&
&             geom%edge_vect_n(i))*ue_tl(i, npy, 3)
            ut3(i) = geom%edge_vect_n(i)*ue(i-1, npy, 3) + (1.-geom%&
&             edge_vect_n(i))*ue(i, npy, 3)
          ELSE
            ut1_tl(i) = geom%edge_vect_n(i)*ue_tl(i+1, npy, 1) + (1.-&
&             geom%edge_vect_n(i))*ue_tl(i, npy, 1)
            ut1(i) = geom%edge_vect_n(i)*ue(i+1, npy, 1) + (1.-geom%&
&             edge_vect_n(i))*ue(i, npy, 1)
            ut2_tl(i) = geom%edge_vect_n(i)*ue_tl(i+1, npy, 2) + (1.-&
&             geom%edge_vect_n(i))*ue_tl(i, npy, 2)
            ut2(i) = geom%edge_vect_n(i)*ue(i+1, npy, 2) + (1.-geom%&
&             edge_vect_n(i))*ue(i, npy, 2)
            ut3_tl(i) = geom%edge_vect_n(i)*ue_tl(i+1, npy, 3) + (1.-&
&             geom%edge_vect_n(i))*ue_tl(i, npy, 3)
            ut3(i) = geom%edge_vect_n(i)*ue(i+1, npy, 3) + (1.-geom%&
&             edge_vect_n(i))*ue(i, npy, 3)
          END IF
        END DO
        DO i=is,ie
          ue_tl(i, npy, 1) = ut1_tl(i)
          ue(i, npy, 1) = ut1(i)
          ue_tl(i, npy, 2) = ut2_tl(i)
          ue(i, npy, 2) = ut2(i)
          ue_tl(i, npy, 3) = ut3_tl(i)
          ue(i, npy, 3) = ut3(i)
        END DO
      END IF
      DO j=js,je+1
        DO i=is,ie
          ud_tl(i, j, k) = 0.5*(geom%es(1, i, j, 1)*ue_tl(i, j, 1)+geom%&
&           es(2, i, j, 1)*ue_tl(i, j, 2)+geom%es(3, i, j, 1)*ue_tl(i, j&
&           , 3))
          ud(i, j, k) = 0.5*(ue(i, j, 1)*geom%es(1, i, j, 1)+ue(i, j, 2)&
&           *geom%es(2, i, j, 1)+ue(i, j, 3)*geom%es(3, i, j, 1))
        END DO
      END DO
      DO j=js,je
        DO i=is,ie+1
          vd_tl(i, j, k) = 0.5*(geom%ew(1, i, j, 2)*ve_tl(i, j, 1)+geom%&
&           ew(2, i, j, 2)*ve_tl(i, j, 2)+geom%ew(3, i, j, 2)*ve_tl(i, j&
&           , 3))
          vd(i, j, k) = 0.5*(ve(i, j, 1)*geom%ew(1, i, j, 2)+ve(i, j, 2)&
&           *geom%ew(2, i, j, 2)+ve(i, j, 3)*geom%ew(3, i, j, 2))
        END DO
      END DO
    END DO
  END SUBROUTINE A2D_TLM
  SUBROUTINE A2D(geom, ua, va, ud, vd)
    IMPLICIT NONE
    TYPE(FV3JEDI_GEOM), INTENT(INOUT) :: geom
    REAL(kind=kind_real), INTENT(IN) :: ua(geom%isc:geom%iec, geom%jsc:&
&   geom%jec, geom%npz)
    REAL(kind=kind_real), INTENT(IN) :: va(geom%isc:geom%iec, geom%jsc:&
&   geom%jec, geom%npz)
    REAL(kind=kind_real), INTENT(INOUT) :: ud(geom%isc:geom%iec, geom%&
&   jsc:geom%jec+1, geom%npz)
    REAL(kind=kind_real), INTENT(INOUT) :: vd(geom%isc:geom%iec+1, geom%&
&   jsc:geom%jec, geom%npz)
    INTEGER :: is, ie, js, je
    INTEGER :: npx, npy, npz
    INTEGER :: i, j, k, im2, jm2
    REAL(kind=kind_real) :: uatemp(geom%isd:geom%ied, geom%jsd:geom%jed&
&   , geom%npz)
    REAL(kind=kind_real) :: vatemp(geom%isd:geom%ied, geom%jsd:geom%jed&
&   , geom%npz)
    REAL(kind=kind_real) :: v3(geom%isc-1:geom%iec+1, geom%jsc-1:geom%&
&   jec+1, 3)
! 3D winds at edges
    REAL(kind=kind_real) :: ue(geom%isc-1:geom%iec+1, geom%jsc:geom%jec+&
&   1, 3)
! 3D winds at edges
    REAL(kind=kind_real) :: ve(geom%isc:geom%iec+1, geom%jsc-1:geom%jec+&
&   1, 3)
    REAL(kind=kind_real), DIMENSION(geom%isc:geom%iec) :: ut1, ut2, ut3
    REAL(kind=kind_real), DIMENSION(geom%jsc:geom%jec) :: vt1, vt2, vt3
    npx = geom%npx
    npy = geom%npy
    npz = geom%npz
    is = geom%isc
    ie = geom%iec
    js = geom%jsc
    je = geom%jec
    im2 = (npx-1)/2
    jm2 = (npy-1)/2
    uatemp(:, :, :) = 0.0
    vatemp(:, :, :) = 0.0
    uatemp(is:ie, js:je, :) = ua
    vatemp(is:ie, js:je, :) = va
    CALL MPP_UPDATE_DOMAINS(uatemp, geom%domain, .false.)
    CALL MPP_UPDATE_DOMAINS(vatemp, geom%domain, .true.)
    DO k=1,npz
      DO j=js-1,je+1
        DO i=is-1,ie+1
          v3(i, j, 1) = uatemp(i, j, k)*geom%vlon(i, j, 1) + vatemp(i, j&
&           , k)*geom%vlat(i, j, 1)
          v3(i, j, 2) = uatemp(i, j, k)*geom%vlon(i, j, 2) + vatemp(i, j&
&           , k)*geom%vlat(i, j, 2)
          v3(i, j, 3) = uatemp(i, j, k)*geom%vlon(i, j, 3) + vatemp(i, j&
&           , k)*geom%vlat(i, j, 3)
        END DO
      END DO
      DO j=js,je+1
        DO i=is-1,ie+1
          ue(i, j, 1) = v3(i, j-1, 1) + v3(i, j, 1)
          ue(i, j, 2) = v3(i, j-1, 2) + v3(i, j, 2)
          ue(i, j, 3) = v3(i, j-1, 3) + v3(i, j, 3)
        END DO
      END DO
      DO j=js-1,je+1
        DO i=is,ie+1
          ve(i, j, 1) = v3(i-1, j, 1) + v3(i, j, 1)
          ve(i, j, 2) = v3(i-1, j, 2) + v3(i, j, 2)
          ve(i, j, 3) = v3(i-1, j, 3) + v3(i, j, 3)
        END DO
      END DO
      IF (is .EQ. 1) THEN
!i = 1
        DO j=js,je
          IF (j .GT. jm2) THEN
            vt1(j) = geom%edge_vect_w(j)*ve(1, j-1, 1) + (1.-geom%&
&             edge_vect_w(j))*ve(1, j, 1)
            vt2(j) = geom%edge_vect_w(j)*ve(1, j-1, 2) + (1.-geom%&
&             edge_vect_w(j))*ve(1, j, 2)
            vt3(j) = geom%edge_vect_w(j)*ve(1, j-1, 3) + (1.-geom%&
&             edge_vect_w(j))*ve(1, j, 3)
          ELSE
            vt1(j) = geom%edge_vect_w(j)*ve(1, j+1, 1) + (1.-geom%&
&             edge_vect_w(j))*ve(1, j, 1)
            vt2(j) = geom%edge_vect_w(j)*ve(1, j+1, 2) + (1.-geom%&
&             edge_vect_w(j))*ve(1, j, 2)
            vt3(j) = geom%edge_vect_w(j)*ve(1, j+1, 3) + (1.-geom%&
&             edge_vect_w(j))*ve(1, j, 3)
          END IF
        END DO
        DO j=js,je
          ve(1, j, 1) = vt1(j)
          ve(1, j, 2) = vt2(j)
          ve(1, j, 3) = vt3(j)
        END DO
      END IF
      IF (ie + 1 .EQ. npx) THEN
!i = npx
        DO j=js,je
          IF (j .GT. jm2) THEN
            vt1(j) = geom%edge_vect_e(j)*ve(npx, j-1, 1) + (1.-geom%&
&             edge_vect_e(j))*ve(npx, j, 1)
            vt2(j) = geom%edge_vect_e(j)*ve(npx, j-1, 2) + (1.-geom%&
&             edge_vect_e(j))*ve(npx, j, 2)
            vt3(j) = geom%edge_vect_e(j)*ve(npx, j-1, 3) + (1.-geom%&
&             edge_vect_e(j))*ve(npx, j, 3)
          ELSE
            vt1(j) = geom%edge_vect_e(j)*ve(npx, j+1, 1) + (1.-geom%&
&             edge_vect_e(j))*ve(npx, j, 1)
            vt2(j) = geom%edge_vect_e(j)*ve(npx, j+1, 2) + (1.-geom%&
&             edge_vect_e(j))*ve(npx, j, 2)
            vt3(j) = geom%edge_vect_e(j)*ve(npx, j+1, 3) + (1.-geom%&
&             edge_vect_e(j))*ve(npx, j, 3)
          END IF
        END DO
        DO j=js,je
          ve(npx, j, 1) = vt1(j)
          ve(npx, j, 2) = vt2(j)
          ve(npx, j, 3) = vt3(j)
        END DO
      END IF
      IF (js .EQ. 1) THEN
!j = 1
        DO i=is,ie
          IF (i .GT. im2) THEN
            ut1(i) = geom%edge_vect_s(i)*ue(i-1, 1, 1) + (1.-geom%&
&             edge_vect_s(i))*ue(i, 1, 1)
            ut2(i) = geom%edge_vect_s(i)*ue(i-1, 1, 2) + (1.-geom%&
&             edge_vect_s(i))*ue(i, 1, 2)
            ut3(i) = geom%edge_vect_s(i)*ue(i-1, 1, 3) + (1.-geom%&
&             edge_vect_s(i))*ue(i, 1, 3)
          ELSE
            ut1(i) = geom%edge_vect_s(i)*ue(i+1, 1, 1) + (1.-geom%&
&             edge_vect_s(i))*ue(i, 1, 1)
            ut2(i) = geom%edge_vect_s(i)*ue(i+1, 1, 2) + (1.-geom%&
&             edge_vect_s(i))*ue(i, 1, 2)
            ut3(i) = geom%edge_vect_s(i)*ue(i+1, 1, 3) + (1.-geom%&
&             edge_vect_s(i))*ue(i, 1, 3)
          END IF
        END DO
        DO i=is,ie
          ue(i, 1, 1) = ut1(i)
          ue(i, 1, 2) = ut2(i)
          ue(i, 1, 3) = ut3(i)
        END DO
      END IF
      IF (je + 1 .EQ. npy) THEN
!j = npy
        DO i=is,ie
          IF (i .GT. im2) THEN
            ut1(i) = geom%edge_vect_n(i)*ue(i-1, npy, 1) + (1.-geom%&
&             edge_vect_n(i))*ue(i, npy, 1)
            ut2(i) = geom%edge_vect_n(i)*ue(i-1, npy, 2) + (1.-geom%&
&             edge_vect_n(i))*ue(i, npy, 2)
            ut3(i) = geom%edge_vect_n(i)*ue(i-1, npy, 3) + (1.-geom%&
&             edge_vect_n(i))*ue(i, npy, 3)
          ELSE
            ut1(i) = geom%edge_vect_n(i)*ue(i+1, npy, 1) + (1.-geom%&
&             edge_vect_n(i))*ue(i, npy, 1)
            ut2(i) = geom%edge_vect_n(i)*ue(i+1, npy, 2) + (1.-geom%&
&             edge_vect_n(i))*ue(i, npy, 2)
            ut3(i) = geom%edge_vect_n(i)*ue(i+1, npy, 3) + (1.-geom%&
&             edge_vect_n(i))*ue(i, npy, 3)
          END IF
        END DO
        DO i=is,ie
          ue(i, npy, 1) = ut1(i)
          ue(i, npy, 2) = ut2(i)
          ue(i, npy, 3) = ut3(i)
        END DO
      END IF
      DO j=js,je+1
        DO i=is,ie
          ud(i, j, k) = 0.5*(ue(i, j, 1)*geom%es(1, i, j, 1)+ue(i, j, 2)&
&           *geom%es(2, i, j, 1)+ue(i, j, 3)*geom%es(3, i, j, 1))
        END DO
      END DO
      DO j=js,je
        DO i=is,ie+1
          vd(i, j, k) = 0.5*(ve(i, j, 1)*geom%ew(1, i, j, 2)+ve(i, j, 2)&
&           *geom%ew(2, i, j, 2)+ve(i, j, 3)*geom%ew(3, i, j, 2))
        END DO
      END DO
    END DO
  END SUBROUTINE A2D
!  Differentiation of mpp_update_domains in forward (tangent) mode:
!   variations   of useful results: field
!   with respect to varying inputs: field
!-----------------
  SUBROUTINE MPP_UPDATE_DOMAINS_TLM(field, field_tl, domain, complete)
    IMPLICIT NONE
    REAL(kind=kind_real), INTENT(INOUT) :: field(:, :, :)
    REAL(kind=kind_real), INTENT(INOUT) :: field_tl(:, :, :)
    TYPE(DOMAIN2D), INTENT(IN) :: domain
    LOGICAL, INTENT(IN) :: complete
    IF (complete) THEN
      field_tl = domain%dummy*(field_tl*field+field*field_tl)
      field = field*field*domain%dummy
    END IF
  END SUBROUTINE MPP_UPDATE_DOMAINS_TLM
!-----------------
  SUBROUTINE MPP_UPDATE_DOMAINS(field, domain, complete)
    IMPLICIT NONE
    REAL(kind=kind_real), INTENT(INOUT) :: field(:, :, :)
    TYPE(DOMAIN2D), INTENT(IN) :: domain
    LOGICAL, INTENT(IN) :: complete
    IF (complete) field = field*field*domain%dummy
  END SUBROUTINE MPP_UPDATE_DOMAINS
END MODULE A2D_MOD_DIFF
