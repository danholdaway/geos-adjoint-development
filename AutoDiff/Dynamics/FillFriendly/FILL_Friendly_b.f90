!        Generated by TAPENADE     (INRIA, Tropics team)
!  Tapenade 3.9 (r5096) - 24 Feb 2014 16:53
!
!  Differentiation of fill_friendly in reverse (adjoint) mode:
!   gradient     of useful results: q
!   with respect to varying inputs: q
!   RW status of diff variables: q:in-out
SUBROUTINE FILL_FRIENDLY_B(im, jm, lm, q, qb, dp)
  IMPLICIT NONE
!Inputs
  INTEGER, INTENT(IN) :: im, jm, lm
  REAL*8, INTENT(IN) :: dp(im, jm, lm)
!Prognostic
  REAL*8, INTENT(INOUT) :: q(im, jm, lm)
  REAL*8 :: qb(im, jm, lm)
!Locals
  INTEGER :: i, j, l
  REAL*8 :: qtemp1(im, jm), qtemp2(im, jm)
  REAL*8 :: qtemp1b(im, jm), qtemp2b(im, jm)
  INTRINSIC ABS
  INTRINSIC MAX
  INTEGER :: branch
  REAL*8 :: tempb
  REAL*8 :: abs0
  qtemp1 = 0.0
  DO l=1,lm
    qtemp1(:, :) = qtemp1(:, :) + q(:, :, l)*dp(:, :, l)
  END DO
  DO i=1,im
    DO j=1,jm
      DO l=1,lm
        IF (q(i, j, l) .LT. 0.0) THEN
          q(i, j, l) = 0.0
          CALL PUSHCONTROL1B(1)
        ELSE
          CALL PUSHCONTROL1B(0)
        END IF
      END DO
    END DO
  END DO
  qtemp2 = 0.0
  DO l=1,lm
    qtemp2(:, :) = qtemp2(:, :) + q(:, :, l)*dp(:, :, l)
  END DO
  DO i=1,im
    DO j=1,jm
      IF (qtemp2(i, j) .GE. 0.) THEN
        abs0 = qtemp2(i, j)
      ELSE
        abs0 = -qtemp2(i, j)
      END IF
      IF (abs0 .GT. 0.0) THEN
        IF (qtemp1(i, j)/qtemp2(i, j) .LT. 0.0) THEN
          qtemp2(i, j) = 0.0
          CALL PUSHCONTROL2B(1)
        ELSE
          CALL PUSHREAL8(qtemp2(i, j))
          qtemp2(i, j) = qtemp1(i, j)/qtemp2(i, j)
          CALL PUSHCONTROL2B(2)
        END IF
      ELSE
        CALL PUSHCONTROL2B(0)
      END IF
    END DO
  END DO
  qtemp2b = 0.0_8
  DO l=lm,1,-1
    qtemp2b = qtemp2b + q(:, :, l)*qb(:, :, l)
    qb(:, :, l) = qtemp2(:, :)*qb(:, :, l)
  END DO
  qtemp1b = 0.0_8
  DO i=im,1,-1
    DO j=jm,1,-1
      CALL POPCONTROL2B(branch)
      IF (branch .NE. 0) THEN
        IF (branch .EQ. 1) THEN
          qtemp2b(i, j) = 0.0_8
        ELSE
          CALL POPREAL8(qtemp2(i, j))
          tempb = qtemp2b(i, j)/qtemp2(i, j)
          qtemp1b(i, j) = qtemp1b(i, j) + tempb
          qtemp2b(i, j) = -(qtemp1(i, j)*tempb/qtemp2(i, j))
        END IF
      END IF
    END DO
  END DO
  DO l=lm,1,-1
    qb(:, :, l) = qb(:, :, l) + dp(:, :, l)*qtemp2b
  END DO
  DO i=im,1,-1
    DO j=jm,1,-1
      DO l=lm,1,-1
        CALL POPCONTROL1B(branch)
        IF (branch .NE. 0) qb(i, j, l) = 0.0_8
      END DO
    END DO
  END DO
  DO l=lm,1,-1
    qb(:, :, l) = qb(:, :, l) + dp(:, :, l)*qtemp1b
  END DO
END SUBROUTINE FILL_FRIENDLY_B

