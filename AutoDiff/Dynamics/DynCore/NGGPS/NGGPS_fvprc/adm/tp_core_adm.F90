!        Generated by TAPENADE     (INRIA, Ecuador team)
!  Tapenade 3.12 (r6213) - 13 Oct 2016 10:30
!
MODULE TP_CORE_MOD_B
!BOP
!
! !MODULE: tp_core --- A collection of routines to support FV transport
!
  USE FV_MP_MOD_B, ONLY : ng
  USE FV_GRID_UTILS_MOD_B, ONLY : big_number
  USE FV_ARRAYS_MOD_B, ONLY : fv_grid_type, fv_grid_bounds_type
  USE FV_ARRAYS_MOD_B, ONLY : real4, real8, 8
  IMPLICIT NONE
  PRIVATE 
  PUBLIC fv_tp_2d, fv_tp_2d, pert_ppm, copy_corners
  PUBLIC fv_tp_2d_adm, fv_tp_2d_fwd, fv_tp_2d_bwd, pert_ppm_adm, &
& copy_corners_adm
  REAL(fvprc), PARAMETER :: r3=1./3.
  REAL(fvprc), PARAMETER :: near_zero=1.e-25
  REAL(fvprc), PARAMETER :: ppm_limiter=2.0
!#ifdef WAVE_FORM
!! Suresh & Huynh scheme 2.2 (purtabation form)
!! The wave-form is more diffusive than scheme 2.1
! real(FVPRC), parameter:: b1 =   0.0375
! real(FVPRC), parameter:: b2 =  -7./30.
! real(FVPRC), parameter:: b3 =  -23./120.
! real(FVPRC), parameter:: b4 =  13./30.
! real(FVPRC), parameter:: b5 = -11./240.
!#else
! scheme 2.1: perturbation form
  REAL(fvprc), PARAMETER :: b1=1./30.
  REAL(fvprc), PARAMETER :: b2=-(13./60.)
  REAL(fvprc), PARAMETER :: b3=-(13./60.)
  REAL(fvprc), PARAMETER :: b4=0.45
  REAL(fvprc), PARAMETER :: b5=-0.05
!#endif
  REAL(fvprc), PARAMETER :: t11=27./28., t12=-(13./28.), t13=3./7.
  REAL(fvprc), PARAMETER :: s11=11./14., s14=4./7., s15=3./14.
!----------------------------------------------------
! volume-conserving cubic with 2nd drv=0 at end point:
!----------------------------------------------------
! Non-monotonic
  REAL(fvprc), PARAMETER :: c1=-(2./14.)
  REAL(fvprc), PARAMETER :: c2=11./14.
  REAL(fvprc), PARAMETER :: c3=5./14.
!----------------------
! PPM volume mean form:
!----------------------
! 0.58333333
  REAL(fvprc), PARAMETER :: p1=7./12.
  REAL(fvprc), PARAMETER :: p2=-(1./12.)
  EXTERNAL FV_TP_2D_FB_ADM

CONTAINS
!  Differentiation of fv_tp_2d in reverse (adjoint) mode (with options r8 split(a2b_edge_mod.a2b_ord2 a2b_edge_mod.a2b_ord4 a2
!b_edge_mod.extrap_corner  dyn_core_mod.dyn_core dyn_core_mod.pk3_halo dyn_core_mod.pln_halo dyn_core_mod.pe_halo dyn_core_mod
!.adv_pe dyn_core_mod.p_grad_c dyn_core_mod.nh_p_grad dyn_core_mod.split_p_grad dyn_core_mod.one_grad_p dyn_core_mod.grad1_p_upda
!te dyn_core_mod.mix_dp dyn_core_mod.geopk dyn_core_mod.del2_cubed fv_dynamics_mod.fv_dynamics fv_dynamics_mod.rayleigh_super fv_
!dynamics_mod.rayleigh_friction fv_dynamics_mod.compute_aam fv_dynamics_mod.geos_to_fv3 fv_grid_utils_mod.cubed_to_latlon fv_grid
!_utils_mod.c2l_ord4 fv_grid_utils_mod.c2l_ord2 fv_mapz_mod.lagrangian_to_eulerian fv_mapz_mod.compute_total_energy fv_mapz_mod.p
!kez fv_mapz_mod.remap_z fv_mapz_mod.map_scalar fv_mapz_mod.map1_ppm fv_mapz_mod.mapn_tracer fv_mapz_mod.map1_q2 f
!v_mapz_mod.map1_cubic fv_mapz_mod.scalar_profile_linear fv_mapz_mod.cs_profile_linear fv_mapz_mod.steepz fv_tracer2d_mod.t
!racer_2d fv_tracer2d_mod.tracer_2d_nested nh_core_mod.update_dz_c nh_core_mod.update_dz_d nh_core_mod.riem_solver_c nh_core_mod.
!riem_solver3 nh_core_mod.rim_2d nh_core_mod.sim3_solver nh_core_mod.sim3p0_solver nh_core_mod.sim1_solver nh_core_mod.sim_solver
! nh_core_mod.edge_profile sw_core_mod.c_sw sw_core_mod.d_sw sw_core_mod.divergence_corner sw_core_mod.divergence_corner_nest sw_
!core_mod.d2a2c_vect sw_core_mod.edge_interpolate4 sw_core_mod.fill2_4corners sw_core_mod.fill_4corners sw_core_mod.compute_div_d
!amping_fb sw_core_mod.smag_corner sw_core_mod.ytp_v sw_core_mod.xtp_u tp_core_mod.fv_tp_2d tp_core_mod.copy_corners_
!fb tp_core_mod.xtp tp_core_mod.ytp tp_core_mod.xppm0 tp_core_mod.yppm0 tp_core_mod.fxppm tp_core_mod.fyppm tp_
!core_mod.deln_flux)):
!   gradient     of useful results: xfx q mass mfx mfy ra_x ra_y
!                yfx fx fy crx cry
!   with respect to varying inputs: xfx q mass mfx mfy ra_x ra_y
!                yfx fx fy crx cry
!   q(i+0.5) = p1*(q(i-1)+q(i)) + p2*(q(i-2)+q(i+1))
!  integer:: is, ie, js, je, isd, ied, jsd, jed
!
!EOP
!-----------------------------------------------------------------------
  SUBROUTINE FV_TP_2D_ADM(q, q_ad, crx, crx_ad, cry, cry_ad, npx, npy, &
&   hord, fx, fx_ad, fy, fy_ad, xfx, xfx_ad, yfx, yfx_ad, gridstruct, bd&
&   , ra_x, ra_x_ad, ra_y, ra_y_ad, mfx, mfx_ad, mfy, mfy_ad, mass, &
&   mass_ad, nord, damp_c)
    IMPLICIT NONE
    TYPE(FV_GRID_BOUNDS_TYPE), INTENT(IN) :: bd
    INTEGER, INTENT(IN) :: npx, npy
    INTEGER, INTENT(IN) :: hord
!
    REAL(fvprc), INTENT(IN) :: crx(bd%is:bd%ie+1, bd%jsd:bd%jed)
    REAL(fvprc) :: crx_ad(bd%is:bd%ie+1, bd%jsd:bd%jed)
!
    REAL(fvprc), INTENT(IN) :: xfx(bd%is:bd%ie+1, bd%jsd:bd%jed)
    REAL(fvprc) :: xfx_ad(bd%is:bd%ie+1, bd%jsd:bd%jed)
!
    REAL(fvprc), INTENT(IN) :: cry(bd%isd:bd%ied, bd%js:bd%je+1)
    REAL(fvprc) :: cry_ad(bd%isd:bd%ied, bd%js:bd%je+1)
!
    REAL(fvprc), INTENT(IN) :: yfx(bd%isd:bd%ied, bd%js:bd%je+1)
    REAL(fvprc) :: yfx_ad(bd%isd:bd%ied, bd%js:bd%je+1)
    REAL(fvprc), INTENT(IN) :: ra_x(bd%is:bd%ie, bd%jsd:bd%jed)
    REAL(fvprc) :: ra_x_ad(bd%is:bd%ie, bd%jsd:bd%jed)
    REAL(fvprc), INTENT(IN) :: ra_y(bd%isd:bd%ied, bd%js:bd%je)
    REAL(fvprc) :: ra_y_ad(bd%isd:bd%ied, bd%js:bd%je)
! transported scalar
    REAL(fvprc), INTENT(INOUT) :: q(bd%isd:bd%ied, bd%jsd:bd%jed)
    REAL(fvprc), INTENT(INOUT) :: q_ad(bd%isd:bd%ied, bd%jsd:bd%jed)
! Flux in x ( E )
    REAL(fvprc) :: fx(bd%is:bd%ie+1, bd%js:bd%je)
    REAL(fvprc) :: fx_ad(bd%is:bd%ie+1, bd%js:bd%je)
! Flux in y ( N )
    REAL(fvprc) :: fy(bd%is:bd%ie, bd%js:bd%je+1)
    REAL(fvprc) :: fy_ad(bd%is:bd%ie, bd%js:bd%je+1)
    TYPE(FV_GRID_TYPE), INTENT(IN), TARGET :: gridstruct
! optional Arguments:
! Mass Flux X-Dir
    REAL(fvprc), OPTIONAL, INTENT(IN) :: mfx(bd%is:bd%ie+1, bd%js:bd%je)
    REAL(fvprc), OPTIONAL :: mfx_ad(bd%is:bd%ie+1, bd%js:bd%je)
! Mass Flux Y-Dir
    REAL(fvprc), OPTIONAL, INTENT(IN) :: mfy(bd%is:bd%ie, bd%js:bd%je+1)
    REAL(fvprc), OPTIONAL :: mfy_ad(bd%is:bd%ie, bd%js:bd%je+1)
    REAL(fvprc), OPTIONAL, INTENT(IN) :: mass(bd%isd:bd%ied, bd%jsd:bd%&
&   jed)
    REAL(fvprc), OPTIONAL :: mass_ad(bd%isd:bd%ied, bd%jsd:bd%jed)
    REAL(fvprc), OPTIONAL, INTENT(IN) :: damp_c
    INTEGER, OPTIONAL, INTENT(IN) :: nord
! Local:
    INTEGER :: ord_ou, ord_in
    REAL(fvprc) :: q_i(bd%isd:bd%ied, bd%js:bd%je)
    REAL(fvprc) :: q_i_ad(bd%isd:bd%ied, bd%js:bd%je)
    REAL(fvprc) :: q_j(bd%is:bd%ie, bd%jsd:bd%jed)
    REAL(fvprc) :: q_j_ad(bd%is:bd%ie, bd%jsd:bd%jed)
    REAL(fvprc) :: fx2(bd%is:bd%ie+1, bd%jsd:bd%jed)
    REAL(fvprc) :: fx2_ad(bd%is:bd%ie+1, bd%jsd:bd%jed)
    REAL(fvprc) :: fy2(bd%isd:bd%ied, bd%js:bd%je+1)
    REAL(fvprc) :: fy2_ad(bd%isd:bd%ied, bd%js:bd%je+1)
    REAL(fvprc) :: fyy(bd%isd:bd%ied, bd%js:bd%je+1)
    REAL(fvprc) :: fyy_ad(bd%isd:bd%ied, bd%js:bd%je+1)
    REAL(fvprc) :: fx1(bd%is:bd%ie+1)
    REAL(fvprc) :: fx1_ad(bd%is:bd%ie+1)
    REAL(fvprc) :: damp
    INTEGER :: i, j
    INTEGER :: is, ie, js, je, isd, ied, jsd, jed
    INTRINSIC PRESENT
    REAL(fvprc) :: temp_ad
    REAL(fvprc) :: temp_ad0
    REAL(fvprc) :: temp_ad1
    REAL(fvprc) :: temp_ad2
    REAL(fvprc) :: temp_ad3
    REAL(fvprc) :: temp_ad4
    INTEGER :: branch
!   real(FVPRC), pointer, dimension(:,:) :: area, rarea
    is = bd%is
    ie = bd%ie
    js = bd%js
    je = bd%je
    isd = bd%isd
    ied = bd%ied
    jsd = bd%jsd
    jed = bd%jed
!! Initalize pointers
!   area    => gridstruct%area  
!   rarea   => gridstruct%rarea 
    ord_in = hord
    ord_ou = hord
    IF (.NOT.gridstruct%nested) THEN
      CALL PUSHREALARRAY_ADM(q, 8*(bd%ied-bd%isd+1)*(bd%jed-bd%jsd+1)/8&
&                  )
      CALL COPY_CORNERS(q, npx, npy, 2, gridstruct%nested, bd, &
&                 gridstruct%sw_corner, gridstruct%se_corner, gridstruct&
&                 %nw_corner, gridstruct%ne_corner)
      CALL PUSHCONTROL1B(0)
    ELSE
      CALL PUSHCONTROL1B(1)
    END IF
    IF (ord_in .LT. 0) THEN
      CALL YPPM0(fy2, q, cry, ord_in, isd, ied, js, je, npx, npy, bd, &
&          gridstruct%dya, gridstruct%nested, gridstruct%grid_type)
      CALL PUSHCONTROL1B(1)
    ELSE
      CALL YTP(fy2, q, cry, ord_in, isd, ied, js, je, npx, npy, bd, &
&        gridstruct%dya, gridstruct%nested, gridstruct%grid_type)
      CALL PUSHCONTROL1B(0)
    END IF
    DO j=js,je+1
      DO i=isd,ied
        fyy(i, j) = yfx(i, j)*fy2(i, j)
      END DO
    END DO
    DO j=js,je
      DO i=isd,ied
        q_i(i, j) = (q(i, j)*gridstruct%area(i, j)+fyy(i, j)-fyy(i, j+1)&
&         )/ra_y(i, j)
      END DO
    END DO
    IF (ord_ou .LT. 0) THEN
      CALL PUSHREALARRAY_ADM(fx, 8*(bd%ie-bd%is+2)*(bd%je-bd%js+1)/8)
      CALL XPPM0(fx, q_i, crx(is:ie+1, js:je), ord_ou, is, ie, js, je, &
&          npx, npy, bd, gridstruct%dxa, gridstruct%nested, gridstruct%&
&          grid_type)
      CALL PUSHCONTROL1B(0)
    ELSE
      CALL PUSHREALARRAY_ADM(fx, 8*(bd%ie-bd%is+2)*(bd%je-bd%js+1)/8)
      CALL XTP(fx, q_i, crx(is:ie+1, js:je), ord_ou, is, ie, js, je, npx&
&        , npy, bd, gridstruct%dxa, gridstruct%nested, gridstruct%&
&        grid_type)
      CALL PUSHCONTROL1B(1)
    END IF
    IF (.NOT.gridstruct%nested) THEN
      CALL PUSHREALARRAY_ADM(q, 8*(bd%ied-bd%isd+1)*(bd%jed-bd%jsd+1)/8&
&                  )
      CALL COPY_CORNERS(q, npx, npy, 1, gridstruct%nested, bd, &
&                 gridstruct%sw_corner, gridstruct%se_corner, gridstruct&
&                 %nw_corner, gridstruct%ne_corner)
      CALL PUSHCONTROL1B(0)
    ELSE
      CALL PUSHCONTROL1B(1)
    END IF
    IF (ord_in .LT. 0) THEN
      CALL XPPM0(fx2, q, crx, ord_in, is, ie, jsd, jed, npx, npy, bd, &
&          gridstruct%dxa, gridstruct%nested, gridstruct%grid_type)
      CALL PUSHCONTROL1B(1)
    ELSE
      CALL XTP(fx2, q, crx, ord_in, is, ie, jsd, jed, npx, npy, bd, &
&        gridstruct%dxa, gridstruct%nested, gridstruct%grid_type)
      CALL PUSHCONTROL1B(0)
    END IF
    CALL PUSHREALARRAY_ADM(fx1, 8*(bd%ie-bd%is+2)/8)
    DO j=jsd,jed
      DO i=is,ie+1
        fx1(i) = xfx(i, j)*fx2(i, j)
      END DO
      DO i=is,ie
        q_j(i, j) = (q(i, j)*gridstruct%area(i, j)+fx1(i)-fx1(i+1))/ra_x&
&         (i, j)
      END DO
    END DO
    IF (ord_ou .LT. 0) THEN
      CALL PUSHREALARRAY_ADM(fy, 8*(bd%ie-bd%is+1)*(bd%je-bd%js+2)/8)
      CALL YPPM0(fy, q_j, cry, ord_ou, is, ie, js, je, npx, npy, bd, &
&          gridstruct%dya, gridstruct%nested, gridstruct%grid_type)
      CALL PUSHCONTROL1B(0)
    ELSE
      CALL PUSHREALARRAY_ADM(fy, 8*(bd%ie-bd%is+1)*(bd%je-bd%js+2)/8)
      CALL YTP(fy, q_j, cry, ord_ou, is, ie, js, je, npx, npy, bd, &
&        gridstruct%dya, gridstruct%nested, gridstruct%grid_type)
      CALL PUSHCONTROL1B(1)
    END IF
!----------------
! Flux averaging:
!----------------
    IF (PRESENT(mfx) .AND. PRESENT(mfy)) THEN
      IF (PRESENT(nord) .AND. PRESENT(damp_c) .AND. PRESENT(mass)) THEN
        IF (damp_c .GT. 1.e-4) THEN
          damp = (damp_c*gridstruct%da_min)**(nord+1)
          CALL DELN_FLUX_ADM(nord, npx, npy, damp, q, q_ad, fx, fx_ad, &
&                      fy, fy_ad, gridstruct, bd, mass, mass_ad)
        END IF
      END IF
      fy2_ad = 0.0_FVPRC
      DO j=je+1,js,-1
        DO i=ie,is,-1
          temp_ad1 = 0.5*mfy(i, j)*fy_ad(i, j)
          fy2_ad(i, j) = fy2_ad(i, j) + temp_ad1
          mfy_ad(i, j) = mfy_ad(i, j) + 0.5*(fy(i, j)+fy2(i, j))*fy_ad(i&
&           , j)
          fy_ad(i, j) = temp_ad1
        END DO
      END DO
      fx2_ad = 0.0_FVPRC
      DO j=je,js,-1
        DO i=ie+1,is,-1
          temp_ad0 = 0.5*mfx(i, j)*fx_ad(i, j)
          fx2_ad(i, j) = fx2_ad(i, j) + temp_ad0
          mfx_ad(i, j) = mfx_ad(i, j) + 0.5*(fx(i, j)+fx2(i, j))*fx_ad(i&
&           , j)
          fx_ad(i, j) = temp_ad0
        END DO
      END DO
    ELSE
      IF (PRESENT(nord) .AND. PRESENT(damp_c)) THEN
        IF (damp_c .GT. 1.e-4) THEN
          damp = (damp_c*gridstruct%da_min)**(nord+1)
          CALL DELN_FLUX_ADM(nord, npx, npy, damp, q, q_ad, fx, fx_ad, &
&                      fy, fy_ad, gridstruct, bd)
        END IF
      END IF
      fy2_ad = 0.0_FVPRC
      DO j=je+1,js,-1
        DO i=ie,is,-1
          temp_ad3 = 0.5*yfx(i, j)*fy_ad(i, j)
          fy2_ad(i, j) = fy2_ad(i, j) + temp_ad3
          yfx_ad(i, j) = yfx_ad(i, j) + 0.5*(fy(i, j)+fy2(i, j))*fy_ad(i&
&           , j)
          fy_ad(i, j) = temp_ad3
        END DO
      END DO
      fx2_ad = 0.0_FVPRC
      DO j=je,js,-1
        DO i=ie+1,is,-1
          temp_ad2 = 0.5*xfx(i, j)*fx_ad(i, j)
          fx2_ad(i, j) = fx2_ad(i, j) + temp_ad2
          xfx_ad(i, j) = xfx_ad(i, j) + 0.5*(fx(i, j)+fx2(i, j))*fx_ad(i&
&           , j)
          fx_ad(i, j) = temp_ad2
        END DO
      END DO
    END IF
    CALL POPCONTROL1B(branch)
    IF (branch .EQ. 0) THEN
      CALL POPREALARRAY_ADM(fy, 8*(bd%ie-bd%is+1)*(bd%je-bd%js+2)/8)
      q_j_ad = 0.0_FVPRC
      CALL YPPM0_ADM(fy, fy_ad, q_j, q_j_ad, cry, cry_ad, ord_ou, is, ie&
&              , js, je, npx, npy, bd, gridstruct%dya, gridstruct%nested&
&              , gridstruct%grid_type)
    ELSE
      CALL POPREALARRAY_ADM(fy, 8*(bd%ie-bd%is+1)*(bd%je-bd%js+2)/8)
      q_j_ad = 0.0_FVPRC
      CALL YTP_ADM(fy, fy_ad, q_j, q_j_ad, cry, cry_ad, ord_ou, is, ie, &
&            js, je, npx, npy, bd, gridstruct%dya, gridstruct%nested, &
&            gridstruct%grid_type)
    END IF
    fx1_ad = 0.0_FVPRC
    CALL POPREALARRAY_ADM(fx1, 8*(bd%ie-bd%is+2)/8)
    DO j=jsd,jed
      DO i=is,ie+1
        fx1(i) = xfx(i, j)*fx2(i, j)
      END DO
      DO i=ie,is,-1
        temp_ad4 = q_j_ad(i, j)/ra_x(i, j)
        q_ad(i, j) = q_ad(i, j) + gridstruct%area(i, j)*temp_ad4
        fx1_ad(i) = fx1_ad(i) + temp_ad4
        fx1_ad(i+1) = fx1_ad(i+1) - temp_ad4
        ra_x_ad(i, j) = ra_x_ad(i, j) - (gridstruct%area(i, j)*q(i, j)+&
&         fx1(i)-fx1(i+1))*temp_ad4/ra_x(i, j)
        q_j_ad(i, j) = 0.0_FVPRC
      END DO
      DO i=ie+1,is,-1
        xfx_ad(i, j) = xfx_ad(i, j) + fx2(i, j)*fx1_ad(i)
        fx2_ad(i, j) = fx2_ad(i, j) + xfx(i, j)*fx1_ad(i)
        fx1_ad(i) = 0.0_FVPRC
      END DO
    END DO
    CALL POPCONTROL1B(branch)
    IF (branch .EQ. 0) THEN
      CALL XTP_ADM(fx2, fx2_ad, q, q_ad, crx, crx_ad, ord_in, is, ie, &
&            jsd, jed, npx, npy, bd, gridstruct%dxa, gridstruct%nested, &
&            gridstruct%grid_type)
    ELSE
      CALL XPPM0_ADM(fx2, fx2_ad, q, q_ad, crx, crx_ad, ord_in, is, ie, &
&              jsd, jed, npx, npy, bd, gridstruct%dxa, gridstruct%nested&
&              , gridstruct%grid_type)
    END IF
    CALL POPCONTROL1B(branch)
    IF (branch .EQ. 0) THEN
      CALL POPREALARRAY_ADM(q, 8*(bd%ied-bd%isd+1)*(bd%jed-bd%jsd+1)/8)
      CALL COPY_CORNERS_ADM(q, q_ad, npx, npy, 1, gridstruct%nested, bd&
&                     , gridstruct%sw_corner, gridstruct%se_corner, &
&                     gridstruct%nw_corner, gridstruct%ne_corner)
    END IF
    CALL POPCONTROL1B(branch)
    IF (branch .EQ. 0) THEN
      CALL POPREALARRAY_ADM(fx, 8*(bd%ie-bd%is+2)*(bd%je-bd%js+1)/8)
      q_i_ad = 0.0_FVPRC
      CALL XPPM0_ADM(fx, fx_ad, q_i, q_i_ad, crx(is:ie+1, js:je), crx_ad&
&              (is:ie+1, js:je), ord_ou, is, ie, js, je, npx, npy, bd, &
&              gridstruct%dxa, gridstruct%nested, gridstruct%grid_type)
    ELSE
      CALL POPREALARRAY_ADM(fx, 8*(bd%ie-bd%is+2)*(bd%je-bd%js+1)/8)
      q_i_ad = 0.0_FVPRC
      CALL XTP_ADM(fx, fx_ad, q_i, q_i_ad, crx(is:ie+1, js:je), crx_ad(&
&            is:ie+1, js:je), ord_ou, is, ie, js, je, npx, npy, bd, &
&            gridstruct%dxa, gridstruct%nested, gridstruct%grid_type)
    END IF
    fyy_ad = 0.0_FVPRC
    DO j=je,js,-1
      DO i=ied,isd,-1
        temp_ad = q_i_ad(i, j)/ra_y(i, j)
        q_ad(i, j) = q_ad(i, j) + gridstruct%area(i, j)*temp_ad
        fyy_ad(i, j) = fyy_ad(i, j) + temp_ad
        fyy_ad(i, j+1) = fyy_ad(i, j+1) - temp_ad
        ra_y_ad(i, j) = ra_y_ad(i, j) - (gridstruct%area(i, j)*q(i, j)+&
&         fyy(i, j)-fyy(i, j+1))*temp_ad/ra_y(i, j)
        q_i_ad(i, j) = 0.0_FVPRC
      END DO
    END DO
    DO j=je+1,js,-1
      DO i=ied,isd,-1
        yfx_ad(i, j) = yfx_ad(i, j) + fy2(i, j)*fyy_ad(i, j)
        fy2_ad(i, j) = fy2_ad(i, j) + yfx(i, j)*fyy_ad(i, j)
        fyy_ad(i, j) = 0.0_FVPRC
      END DO
    END DO
    CALL POPCONTROL1B(branch)
    IF (branch .EQ. 0) THEN
      CALL YTP_ADM(fy2, fy2_ad, q, q_ad, cry, cry_ad, ord_in, isd, ied, &
&            js, je, npx, npy, bd, gridstruct%dya, gridstruct%nested, &
&            gridstruct%grid_type)
    ELSE
      CALL YPPM0_ADM(fy2, fy2_ad, q, q_ad, cry, cry_ad, ord_in, isd, ied&
&              , js, je, npx, npy, bd, gridstruct%dya, gridstruct%nested&
&              , gridstruct%grid_type)
    END IF
    CALL POPCONTROL1B(branch)
    IF (branch .EQ. 0) THEN
      CALL POPREALARRAY_ADM(q, 8*(bd%ied-bd%isd+1)*(bd%jed-bd%jsd+1)/8)
      CALL COPY_CORNERS_ADM(q, q_ad, npx, npy, 2, gridstruct%nested, bd&
&                     , gridstruct%sw_corner, gridstruct%se_corner, &
&                     gridstruct%nw_corner, gridstruct%ne_corner)
    END IF
  END SUBROUTINE FV_TP_2D_ADM
!   q(i+0.5) = p1*(q(i-1)+q(i)) + p2*(q(i-2)+q(i+1))
!  integer:: is, ie, js, je, isd, ied, jsd, jed
!
!EOP
!-----------------------------------------------------------------------
  SUBROUTINE FV_TP_2D(q, crx, cry, npx, npy, hord, fx, fy, xfx, yfx, &
&   gridstruct, bd, ra_x, ra_y, mfx, mfy, mass, nord, damp_c)
    IMPLICIT NONE
    TYPE(FV_GRID_BOUNDS_TYPE), INTENT(IN) :: bd
    INTEGER, INTENT(IN) :: npx, npy
    INTEGER, INTENT(IN) :: hord
!
    REAL(fvprc), INTENT(IN) :: crx(bd%is:bd%ie+1, bd%jsd:bd%jed)
!
    REAL(fvprc), INTENT(IN) :: xfx(bd%is:bd%ie+1, bd%jsd:bd%jed)
!
    REAL(fvprc), INTENT(IN) :: cry(bd%isd:bd%ied, bd%js:bd%je+1)
!
    REAL(fvprc), INTENT(IN) :: yfx(bd%isd:bd%ied, bd%js:bd%je+1)
    REAL(fvprc), INTENT(IN) :: ra_x(bd%is:bd%ie, bd%jsd:bd%jed)
    REAL(fvprc), INTENT(IN) :: ra_y(bd%isd:bd%ied, bd%js:bd%je)
! transported scalar
    REAL(fvprc), INTENT(INOUT) :: q(bd%isd:bd%ied, bd%jsd:bd%jed)
! Flux in x ( E )
    REAL(fvprc), INTENT(OUT) :: fx(bd%is:bd%ie+1, bd%js:bd%je)
! Flux in y ( N )
    REAL(fvprc), INTENT(OUT) :: fy(bd%is:bd%ie, bd%js:bd%je+1)
    TYPE(FV_GRID_TYPE), INTENT(IN), TARGET :: gridstruct
! optional Arguments:
! Mass Flux X-Dir
    REAL(fvprc), OPTIONAL, INTENT(IN) :: mfx(bd%is:bd%ie+1, bd%js:bd%je)
! Mass Flux Y-Dir
    REAL(fvprc), OPTIONAL, INTENT(IN) :: mfy(bd%is:bd%ie, bd%js:bd%je+1)
    REAL(fvprc), OPTIONAL, INTENT(IN) :: mass(bd%isd:bd%ied, bd%jsd:bd%&
&   jed)
    REAL(fvprc), OPTIONAL, INTENT(IN) :: damp_c
    INTEGER, OPTIONAL, INTENT(IN) :: nord
! Local:
    INTEGER :: ord_ou, ord_in
    REAL(fvprc) :: q_i(bd%isd:bd%ied, bd%js:bd%je)
    REAL(fvprc) :: q_j(bd%is:bd%ie, bd%jsd:bd%jed)
    REAL(fvprc) :: fx2(bd%is:bd%ie+1, bd%jsd:bd%jed)
    REAL(fvprc) :: fy2(bd%isd:bd%ied, bd%js:bd%je+1)
    REAL(fvprc) :: fyy(bd%isd:bd%ied, bd%js:bd%je+1)
    REAL(fvprc) :: fx1(bd%is:bd%ie+1)
    REAL(fvprc) :: damp
    INTEGER :: i, j
    INTEGER :: is, ie, js, je, isd, ied, jsd, jed
    INTRINSIC PRESENT
!   real(FVPRC), pointer, dimension(:,:) :: area, rarea
    is = bd%is
    ie = bd%ie
    js = bd%js
    je = bd%je
    isd = bd%isd
    ied = bd%ied
    jsd = bd%jsd
    jed = bd%jed
!! Initalize pointers
!   area    => gridstruct%area  
!   rarea   => gridstruct%rarea 
    ord_in = hord
    ord_ou = hord
    IF (.NOT.gridstruct%nested) CALL COPY_CORNERS(q, npx, npy, 2, &
&                                           gridstruct%nested, bd, &
&                                           gridstruct%sw_corner, &
&                                           gridstruct%se_corner, &
&                                           gridstruct%nw_corner, &
&                                           gridstruct%ne_corner)
    IF (ord_in .LT. 0) THEN
      CALL YPPM0(fy2, q, cry, ord_in, isd, ied, js, je, npx, npy, bd, &
&          gridstruct%dya, gridstruct%nested, gridstruct%grid_type)
    ELSE
      CALL YTP(fy2, q, cry, ord_in, isd, ied, js, je, npx, npy, bd, &
&        gridstruct%dya, gridstruct%nested, gridstruct%grid_type)
    END IF
    DO j=js,je+1
      DO i=isd,ied
        fyy(i, j) = yfx(i, j)*fy2(i, j)
      END DO
    END DO
    DO j=js,je
      DO i=isd,ied
        q_i(i, j) = (q(i, j)*gridstruct%area(i, j)+fyy(i, j)-fyy(i, j+1)&
&         )/ra_y(i, j)
      END DO
    END DO
    IF (ord_ou .LT. 0) THEN
      CALL XPPM0(fx, q_i, crx(is:ie+1, js:je), ord_ou, is, ie, js, je, &
&          npx, npy, bd, gridstruct%dxa, gridstruct%nested, gridstruct%&
&          grid_type)
    ELSE
      CALL XTP(fx, q_i, crx(is:ie+1, js:je), ord_ou, is, ie, js, je, npx&
&        , npy, bd, gridstruct%dxa, gridstruct%nested, gridstruct%&
&        grid_type)
    END IF
    IF (.NOT.gridstruct%nested) CALL COPY_CORNERS(q, npx, npy, 1, &
&                                           gridstruct%nested, bd, &
&                                           gridstruct%sw_corner, &
&                                           gridstruct%se_corner, &
&                                           gridstruct%nw_corner, &
&                                           gridstruct%ne_corner)
    IF (ord_in .LT. 0) THEN
      CALL XPPM0(fx2, q, crx, ord_in, is, ie, jsd, jed, npx, npy, bd, &
&          gridstruct%dxa, gridstruct%nested, gridstruct%grid_type)
    ELSE
      CALL XTP(fx2, q, crx, ord_in, is, ie, jsd, jed, npx, npy, bd, &
&        gridstruct%dxa, gridstruct%nested, gridstruct%grid_type)
    END IF
    DO j=jsd,jed
      DO i=is,ie+1
        fx1(i) = xfx(i, j)*fx2(i, j)
      END DO
      DO i=is,ie
        q_j(i, j) = (q(i, j)*gridstruct%area(i, j)+fx1(i)-fx1(i+1))/ra_x&
&         (i, j)
      END DO
    END DO
    IF (ord_ou .LT. 0) THEN
      CALL YPPM0(fy, q_j, cry, ord_ou, is, ie, js, je, npx, npy, bd, &
&          gridstruct%dya, gridstruct%nested, gridstruct%grid_type)
    ELSE
      CALL YTP(fy, q_j, cry, ord_ou, is, ie, js, je, npx, npy, bd, &
&        gridstruct%dya, gridstruct%nested, gridstruct%grid_type)
    END IF
!----------------
! Flux averaging:
!----------------
    IF (PRESENT(mfx) .AND. PRESENT(mfy)) THEN
!---------------------------------
! For transport of pt and tracers
!---------------------------------
      DO j=js,je
        DO i=is,ie+1
          fx(i, j) = 0.5*(fx(i, j)+fx2(i, j))*mfx(i, j)
        END DO
      END DO
      DO j=js,je+1
        DO i=is,ie
          fy(i, j) = 0.5*(fy(i, j)+fy2(i, j))*mfy(i, j)
        END DO
      END DO
      IF (PRESENT(nord) .AND. PRESENT(damp_c) .AND. PRESENT(mass)) THEN
        IF (damp_c .GT. 1.e-4) THEN
          damp = (damp_c*gridstruct%da_min)**(nord+1)
          CALL DELN_FLUX(nord, npx, npy, damp, q, fx, fy, gridstruct, bd&
&                  , mass)
        END IF
      END IF
    ELSE
!---------------------------------
! For transport of delp, vorticity
!---------------------------------
      DO j=js,je
        DO i=is,ie+1
          fx(i, j) = 0.5*(fx(i, j)+fx2(i, j))*xfx(i, j)
        END DO
      END DO
      DO j=js,je+1
        DO i=is,ie
          fy(i, j) = 0.5*(fy(i, j)+fy2(i, j))*yfx(i, j)
        END DO
      END DO
      IF (PRESENT(nord) .AND. PRESENT(damp_c)) THEN
        IF (damp_c .GT. 1.e-4) THEN
          damp = (damp_c*gridstruct%da_min)**(nord+1)
          CALL DELN_FLUX(nord, npx, npy, damp, q, fx, fy, gridstruct, bd&
&                 )
        END IF
      END IF
    END IF
  END SUBROUTINE FV_TP_2D
!  Differentiation of xtp in reverse (adjoint) mode (with options r8 split(a2b_edge_mod.a2b_ord2 a2b_edge_mod.a2b_ord4 a2b_edg
!e_mod.extrap_corner  dyn_core_mod.dyn_core dyn_core_mod.pk3_halo dyn_core_mod.pln_halo dyn_core_mod.pe_halo dyn_core_mod.adv_
!pe dyn_core_mod.p_grad_c dyn_core_mod.nh_p_grad dyn_core_mod.split_p_grad dyn_core_mod.one_grad_p dyn_core_mod.grad1_p_update dy
!n_core_mod.mix_dp dyn_core_mod.geopk dyn_core_mod.del2_cubed fv_dynamics_mod.fv_dynamics fv_dynamics_mod.rayleigh_super fv_dynam
!ics_mod.rayleigh_friction fv_dynamics_mod.compute_aam fv_dynamics_mod.geos_to_fv3 fv_grid_utils_mod.cubed_to_latlon fv_grid_util
!s_mod.c2l_ord4 fv_grid_utils_mod.c2l_ord2 fv_mapz_mod.lagrangian_to_eulerian fv_mapz_mod.compute_total_energy fv_mapz_mod.pkez f
!v_mapz_mod.remap_z fv_mapz_mod.map_scalar fv_mapz_mod.map1_ppm fv_mapz_mod.mapn_tracer fv_mapz_mod.map1_q2 fv_map
!z_mod.map1_cubic fv_mapz_mod.scalar_profile_linear fv_mapz_mod.cs_profile_linear fv_mapz_mod.steepz fv_tracer2d_mod.tracer
!_2d fv_tracer2d_mod.tracer_2d_nested nh_core_mod.update_dz_c nh_core_mod.update_dz_d nh_core_mod.riem_solver_c nh_core_mod.riem_
!solver3 nh_core_mod.rim_2d nh_core_mod.sim3_solver nh_core_mod.sim3p0_solver nh_core_mod.sim1_solver nh_core_mod.sim_solver nh_c
!ore_mod.edge_profile sw_core_mod.c_sw sw_core_mod.d_sw sw_core_mod.divergence_corner sw_core_mod.divergence_corner_nest sw_core_
!mod.d2a2c_vect sw_core_mod.edge_interpolate4 sw_core_mod.fill2_4corners sw_core_mod.fill_4corners sw_core_mod.compute_div_dampin
!g_fb sw_core_mod.smag_corner sw_core_mod.ytp_v sw_core_mod.xtp_u tp_core_mod.fv_tp_2d tp_core_mod.copy_corners tp
!_core_mod.xtp tp_core_mod.ytp tp_core_mod.xppm0 tp_core_mod.yppm0 tp_core_mod.fxppm tp_core_mod.fyppm tp_core_
!mod.deln_flux)):
!   gradient     of useful results: q fx c
!   with respect to varying inputs: q fx c
  SUBROUTINE XTP_ADM(fx, fx_ad, q, q_ad, c, c_ad, iord, ifirst, ilast, &
&   jfirst, jlast, npx, npy, bd, dxa, nested, grid_type)
    IMPLICIT NONE
    TYPE(FV_GRID_BOUNDS_TYPE), INTENT(IN) :: bd
!  X-Dir strip
    INTEGER, INTENT(IN) :: ifirst, ilast
!  Y-Dir strip
    INTEGER, INTENT(IN) :: jfirst, jlast
    INTEGER, INTENT(IN) :: npx, npy
    INTEGER, INTENT(IN) :: iord
! Courant numbers
    REAL(fvprc), INTENT(IN) :: c(bd%is:bd%ie+1, jfirst:jlast)
    REAL(fvprc) :: c_ad(bd%is:bd%ie+1, jfirst:jlast)
    REAL(fvprc), INTENT(IN) :: q(bd%isd:bd%ied, jfirst:jlast)
    REAL(fvprc) :: q_ad(bd%isd:bd%ied, jfirst:jlast)
    REAL(fvprc) :: fx(ifirst:ilast+1, jfirst:jlast)
    REAL(fvprc) :: fx_ad(ifirst:ilast+1, jfirst:jlast)
    REAL(fvprc), INTENT(IN) :: dxa(bd%isd:bd%ied, bd%jsd:bd%jed)
    LOGICAL, INTENT(IN) :: nested
    INTEGER, INTENT(IN) :: grid_type
! Local:
    REAL(fvprc) :: dm(bd%is-2:bd%ie+2)
    REAL(fvprc) :: dm_ad(bd%is-2:bd%ie+2)
    REAL(fvprc) :: x0l, x0r, x1
    REAL(fvprc) :: x0l_ad, x0r_ad, x1_ad
    INTEGER :: i, j
    INTEGER :: is, ie, js, je, isd, ied, jsd, jed
    INTRINSIC ABS
    INTRINSIC MAX
    INTRINSIC MIN
    INTRINSIC SIGN
    REAL(fvprc) :: min1
    REAL(fvprc) :: min1_ad
    REAL(fvprc) :: min2
    REAL(fvprc) :: min2_ad
    REAL(fvprc) :: min3
    REAL(fvprc) :: min3_ad
    REAL(fvprc) :: min4
    REAL(fvprc) :: min4_ad
    REAL(fvprc) :: min5
    REAL(fvprc) :: min5_ad
    REAL(fvprc) :: max1
    REAL(fvprc) :: max1_ad
    REAL(fvprc) :: min6
    REAL(fvprc) :: min6_ad
    REAL(fvprc) :: max2
    REAL(fvprc) :: max2_ad
    REAL(fvprc) :: min7
    REAL(fvprc) :: min7_ad
    REAL(fvprc) :: max3
    REAL(fvprc) :: max3_ad
    REAL(fvprc) :: min8
    REAL(fvprc) :: min8_ad
    REAL(fvprc) :: max4
    REAL(fvprc) :: max4_ad
    REAL(fvprc) :: min9
    REAL(fvprc) :: min9_ad
    REAL(fvprc) :: max5
    REAL(fvprc) :: max5_ad
    REAL(fvprc) :: min10
    REAL(fvprc) :: min10_ad
    REAL(fvprc) :: temp_ad
    REAL(fvprc) :: temp_ad0
    REAL(fvprc) :: temp_ad1
    REAL(fvprc) :: temp_ad2
    REAL(fvprc) :: temp_ad3
    REAL(fvprc) :: temp_ad4
    REAL(fvprc) :: x2_ad
    REAL(fvprc) :: y1_ad
    REAL(fvprc) :: z1_ad
    REAL(fvprc) :: temp_ad5
    REAL(fvprc) :: temp_ad6
    REAL(fvprc) :: temp_ad7
    REAL(fvprc) :: x3_ad
    REAL(fvprc) :: y2_ad
    REAL(fvprc) :: z2_ad
    REAL(fvprc) :: temp_ad8
    REAL(fvprc) :: x4_ad
    REAL(fvprc) :: y3_ad
    REAL(fvprc) :: z3_ad
    REAL(fvprc) :: temp_ad9
    REAL(fvprc) :: temp_ad10
    REAL(fvprc) :: temp_ad11
    REAL(fvprc) :: x5_ad
    REAL(fvprc) :: y4_ad
    REAL(fvprc) :: z4_ad
    REAL(fvprc) :: temp_ad12
    REAL(fvprc) :: x6_ad
    REAL(fvprc) :: y5_ad
    REAL(fvprc) :: z5_ad
    INTEGER :: branch
    REAL(fvprc) :: x6
    REAL(fvprc) :: x5
    REAL(fvprc) :: x4
    REAL(fvprc) :: x3
    REAL(fvprc) :: x2
    REAL(fvprc) :: z5
    REAL(fvprc) :: z4
    REAL(fvprc) :: z3
    REAL(fvprc) :: z2
    REAL(fvprc) :: z1
    REAL(fvprc) :: y5
    REAL(fvprc) :: y4
    REAL(fvprc) :: y3
    REAL(fvprc) :: y2
    REAL(fvprc) :: y1
    is = bd%is
    ie = bd%ie
    IF (iord .EQ. 1) THEN
      DO j=jfirst,jlast
        DO i=ifirst,ilast+1
          IF (c(i, j) .GT. 0.) THEN
            CALL PUSHCONTROL1B(1)
          ELSE
            CALL PUSHCONTROL1B(0)
          END IF
        END DO
      END DO
      DO j=jlast,jfirst,-1
        DO i=ilast+1,ifirst,-1
          CALL POPCONTROL1B(branch)
          IF (branch .EQ. 0) THEN
            q_ad(i, j) = q_ad(i, j) + fx_ad(i, j)
            fx_ad(i, j) = 0.0_FVPRC
          ELSE
            q_ad(i-1, j) = q_ad(i-1, j) + fx_ad(i, j)
            fx_ad(i, j) = 0.0_FVPRC
          END IF
        END DO
      END DO
    ELSE IF (iord .EQ. 333) THEN
!Advection using third order scheme
      DO j=jfirst,jlast
        DO i=ifirst,ilast+1
          IF (c(i, j) .GT. 0.) THEN
            CALL PUSHCONTROL1B(1)
          ELSE
            CALL PUSHCONTROL1B(0)
          END IF
        END DO
      END DO
      DO j=jlast,jfirst,-1
        DO i=ilast+1,ifirst,-1
          CALL POPCONTROL1B(branch)
          IF (branch .EQ. 0) THEN
            temp_ad2 = fx_ad(i, j)/6.0
            temp_ad3 = -(0.5*c(i, j)*fx_ad(i, j))
            temp_ad4 = c(i, j)**2*fx_ad(i, j)/6.0
            q_ad(i-1, j) = q_ad(i-1, j) + temp_ad4 - temp_ad3 + 2.0*&
&             temp_ad2
            q_ad(i, j) = q_ad(i, j) + temp_ad3 - 2.0*temp_ad4 + 5.0*&
&             temp_ad2
            q_ad(i+1, j) = q_ad(i+1, j) + temp_ad4 - temp_ad2
            c_ad(i, j) = c_ad(i, j) + ((q(i+1, j)-2.0*q(i, j)+q(i-1, j))&
&             *2*c(i, j)/6.0-0.5*(q(i, j)-q(i-1, j)))*fx_ad(i, j)
            fx_ad(i, j) = 0.0_FVPRC
          ELSE
            temp_ad = fx_ad(i, j)/6.0
            temp_ad0 = -(0.5*c(i, j)*fx_ad(i, j))
            temp_ad1 = c(i, j)**2*fx_ad(i, j)/6.0
            q_ad(i, j) = q_ad(i, j) + temp_ad1 + temp_ad0 + 2.0*temp_ad
            q_ad(i-1, j) = q_ad(i-1, j) + 5.0*temp_ad - temp_ad0 - 2.0*&
&             temp_ad1
            q_ad(i-2, j) = q_ad(i-2, j) + temp_ad1 - temp_ad
            c_ad(i, j) = c_ad(i, j) + ((q(i, j)-2.0*q(i-1, j)+q(i-2, j))&
&             *2*c(i, j)/6.0-0.5*(q(i, j)-q(i-1, j)))*fx_ad(i, j)
            fx_ad(i, j) = 0.0_FVPRC
          END IF
        END DO
      END DO
    ELSE IF (iord .EQ. 2) THEN
      DO j=jfirst,jlast
        DO i=is-2,ie+2
          CALL PUSHREALARRAY_ADM(dm(i))
          dm(i) = 0.25*(q(i+1, j)-q(i-1, j))
          IF (dm(i) .GE. 0.) THEN
            x2 = dm(i)
            CALL PUSHCONTROL1B(0)
          ELSE
            x2 = -dm(i)
            CALL PUSHCONTROL1B(1)
          END IF
          IF (q(i-1, j) .LT. q(i, j)) THEN
            IF (q(i, j) .LT. q(i+1, j)) THEN
              max1 = q(i+1, j)
              CALL PUSHCONTROL2B(0)
            ELSE
              max1 = q(i, j)
              CALL PUSHCONTROL2B(1)
            END IF
          ELSE IF (q(i-1, j) .LT. q(i+1, j)) THEN
            max1 = q(i+1, j)
            CALL PUSHCONTROL2B(2)
          ELSE
            max1 = q(i-1, j)
            CALL PUSHCONTROL2B(3)
          END IF
          y1 = max1 - q(i, j)
          IF (q(i-1, j) .GT. q(i, j)) THEN
            IF (q(i, j) .GT. q(i+1, j)) THEN
              min6 = q(i+1, j)
              CALL PUSHCONTROL2B(0)
            ELSE
              min6 = q(i, j)
              CALL PUSHCONTROL2B(1)
            END IF
          ELSE IF (q(i-1, j) .GT. q(i+1, j)) THEN
            min6 = q(i+1, j)
            CALL PUSHCONTROL2B(2)
          ELSE
            min6 = q(i-1, j)
            CALL PUSHCONTROL2B(3)
          END IF
          z1 = q(i, j) - min6
          IF (x2 .GT. y1) THEN
            IF (y1 .GT. z1) THEN
              CALL PUSHREALARRAY_ADM(min1)
              min1 = z1
              CALL PUSHCONTROL2B(0)
            ELSE
              CALL PUSHREALARRAY_ADM(min1)
              min1 = y1
              CALL PUSHCONTROL2B(1)
            END IF
          ELSE IF (x2 .GT. z1) THEN
            CALL PUSHREALARRAY_ADM(min1)
            min1 = z1
            CALL PUSHCONTROL2B(2)
          ELSE
            CALL PUSHREALARRAY_ADM(min1)
            min1 = x2
            CALL PUSHCONTROL2B(3)
          END IF
          CALL PUSHREALARRAY_ADM(dm(i))
          dm(i) = SIGN(min1, dm(i))
        END DO
        IF (grid_type .LT. 3 .AND. (.NOT.nested)) THEN
!--------------
! fix the edges 
!  NOW: interpolation to the edge (originally from PL07, appendix C) generalized first for variable dx, then for dx which differs
! between the two sides of the edge
!--------------
          IF (is .EQ. 1) THEN
!             x0 = 0.5*(3.0*(q(0,j)+q(1,j))   &
!                - (q(-1,j)+q(2,j)))/ ( 2.0 )
!             x0 = 0.5*((2.*dxa(1,j)+dxa(2,j))*(q(0,j)+q(1,j))   &
!                - dxa(1,j)*(q(-1,j)+q(2,j)))/ ( dxa(1,j)+dxa(2,j))
            x0l = 0.5*((2.*dxa(0, j)+dxa(-1, j))*q(0, j)-dxa(0, j)*q(-1&
&             , j))/(dxa(0, j)+dxa(-1, j))
            x0r = 0.5*((2.*dxa(1, j)+dxa(2, j))*q(1, j)-dxa(1, j)*q(2, j&
&             ))/(dxa(1, j)+dxa(2, j))
            x1 = s15*q(1, j) + s11*q(2, j) - s14*dm(2)
            CALL PUSHREALARRAY_ADM(dm(1))
            dm(1) = 0.5*(x1-x0l-x0r)
            IF (dm(1) .GE. 0.) THEN
              x3 = dm(1)
              CALL PUSHCONTROL1B(0)
            ELSE
              x3 = -dm(1)
              CALL PUSHCONTROL1B(1)
            END IF
            IF (q(1, j) .LT. x0l + x0r) THEN
              IF (x0l + x0r .LT. x1) THEN
                max2 = x1
                CALL PUSHCONTROL2B(0)
              ELSE
                max2 = x0l + x0r
                CALL PUSHCONTROL2B(1)
              END IF
            ELSE IF (q(1, j) .LT. x1) THEN
              max2 = x1
              CALL PUSHCONTROL2B(2)
            ELSE
              max2 = q(1, j)
              CALL PUSHCONTROL2B(3)
            END IF
            y2 = max2 - q(1, j)
            IF (q(1, j) .GT. x0l + x0r) THEN
              IF (x0l + x0r .GT. x1) THEN
                min7 = x1
                CALL PUSHCONTROL2B(0)
              ELSE
                min7 = x0l + x0r
                CALL PUSHCONTROL2B(1)
              END IF
            ELSE IF (q(1, j) .GT. x1) THEN
              min7 = x1
              CALL PUSHCONTROL2B(2)
            ELSE
              min7 = q(1, j)
              CALL PUSHCONTROL2B(3)
            END IF
            z2 = q(1, j) - min7
            IF (x3 .GT. y2) THEN
              IF (y2 .GT. z2) THEN
                CALL PUSHREALARRAY_ADM(min2)
                min2 = z2
                CALL PUSHCONTROL2B(0)
              ELSE
                CALL PUSHREALARRAY_ADM(min2)
                min2 = y2
                CALL PUSHCONTROL2B(1)
              END IF
            ELSE IF (x3 .GT. z2) THEN
              CALL PUSHREALARRAY_ADM(min2)
              min2 = z2
              CALL PUSHCONTROL2B(2)
            ELSE
              CALL PUSHREALARRAY_ADM(min2)
              min2 = x3
              CALL PUSHCONTROL2B(3)
            END IF
            CALL PUSHREALARRAY_ADM(dm(1))
            dm(1) = SIGN(min2, dm(1))
!
            x1 = s15*q(0, j) + s11*q(-1, j) + s14*dm(-1)
            CALL PUSHREALARRAY_ADM(dm(0))
            dm(0) = 0.5*(x0r+x0l-x1)
            IF (dm(0) .GE. 0.) THEN
              x4 = dm(0)
              CALL PUSHCONTROL1B(0)
            ELSE
              x4 = -dm(0)
              CALL PUSHCONTROL1B(1)
            END IF
            IF (q(0, j) .LT. x0l + x0r) THEN
              IF (x0l + x0r .LT. x1) THEN
                max3 = x1
                CALL PUSHCONTROL2B(0)
              ELSE
                max3 = x0l + x0r
                CALL PUSHCONTROL2B(1)
              END IF
            ELSE IF (q(0, j) .LT. x1) THEN
              max3 = x1
              CALL PUSHCONTROL2B(2)
            ELSE
              max3 = q(0, j)
              CALL PUSHCONTROL2B(3)
            END IF
            y3 = max3 - q(0, j)
            IF (q(0, j) .GT. x0l + x0r) THEN
              IF (x0l + x0r .GT. x1) THEN
                min8 = x1
                CALL PUSHCONTROL2B(0)
              ELSE
                min8 = x0l + x0r
                CALL PUSHCONTROL2B(1)
              END IF
            ELSE IF (q(0, j) .GT. x1) THEN
              min8 = x1
              CALL PUSHCONTROL2B(2)
            ELSE
              min8 = q(0, j)
              CALL PUSHCONTROL2B(3)
            END IF
            z3 = q(0, j) - min8
            IF (x4 .GT. y3) THEN
              IF (y3 .GT. z3) THEN
                CALL PUSHREALARRAY_ADM(min3)
                min3 = z3
                CALL PUSHCONTROL2B(0)
              ELSE
                CALL PUSHREALARRAY_ADM(min3)
                min3 = y3
                CALL PUSHCONTROL2B(1)
              END IF
            ELSE IF (x4 .GT. z3) THEN
              CALL PUSHREALARRAY_ADM(min3)
              min3 = z3
              CALL PUSHCONTROL2B(2)
            ELSE
              CALL PUSHREALARRAY_ADM(min3)
              min3 = x4
              CALL PUSHCONTROL2B(3)
            END IF
            CALL PUSHREALARRAY_ADM(dm(0))
            dm(0) = SIGN(min3, dm(0))
            CALL PUSHCONTROL1B(0)
          ELSE
            CALL PUSHCONTROL1B(1)
          END IF
          IF (ie + 1 .EQ. npx) THEN
!              x0 = 0.5*(3.0*(q(npx-1,j)+q(npx,j))   &
!                - (q(npx-2,j)+q(npx+1,j)))/( 2.0 )
!              x0 = 0.5*( (2.*dxa(npx-1,j)+dxa(npx-2,j))*(q(npx-1,j)+q(npx,j))   &
!                - dxa(npx-1,j)*(q(npx-2,j)+q(npx+1,j)))/( dxa(npx-1,j)+dxa(npx-2,j))
            x0l = 0.5*((2.*dxa(npx-1, j)+dxa(npx-2, j))*q(npx-1, j)-dxa(&
&             npx-1, j)*q(npx-2, j))/(dxa(npx-1, j)+dxa(npx-2, j))
            x0r = 0.5*((2.*dxa(npx, j)+dxa(npx+1, j))*q(npx, j)-dxa(npx&
&             , j)*q(npx+1, j))/(dxa(npx, j)+dxa(npx+1, j))
            x1 = s15*q(npx-1, j) + s11*q(npx-2, j) + s14*dm(npx-2)
            CALL PUSHREALARRAY_ADM(dm(npx-1))
            dm(npx-1) = 0.5*(x0r+x0l-x1)
            IF (dm(npx-1) .GE. 0.) THEN
              x5 = dm(npx-1)
              CALL PUSHCONTROL1B(0)
            ELSE
              x5 = -dm(npx-1)
              CALL PUSHCONTROL1B(1)
            END IF
            IF (q(npx-1, j) .LT. x0l + x0r) THEN
              IF (x0l + x0r .LT. x1) THEN
                max4 = x1
                CALL PUSHCONTROL2B(0)
              ELSE
                max4 = x0l + x0r
                CALL PUSHCONTROL2B(1)
              END IF
            ELSE IF (q(npx-1, j) .LT. x1) THEN
              max4 = x1
              CALL PUSHCONTROL2B(2)
            ELSE
              max4 = q(npx-1, j)
              CALL PUSHCONTROL2B(3)
            END IF
            y4 = max4 - q(npx-1, j)
            IF (q(npx-1, j) .GT. x0l + x0r) THEN
              IF (x0l + x0r .GT. x1) THEN
                min9 = x1
                CALL PUSHCONTROL2B(0)
              ELSE
                min9 = x0l + x0r
                CALL PUSHCONTROL2B(1)
              END IF
            ELSE IF (q(npx-1, j) .GT. x1) THEN
              min9 = x1
              CALL PUSHCONTROL2B(2)
            ELSE
              min9 = q(npx-1, j)
              CALL PUSHCONTROL2B(3)
            END IF
            z4 = q(npx-1, j) - min9
            IF (x5 .GT. y4) THEN
              IF (y4 .GT. z4) THEN
                CALL PUSHREALARRAY_ADM(min4)
                min4 = z4
                CALL PUSHCONTROL2B(0)
              ELSE
                CALL PUSHREALARRAY_ADM(min4)
                min4 = y4
                CALL PUSHCONTROL2B(1)
              END IF
            ELSE IF (x5 .GT. z4) THEN
              CALL PUSHREALARRAY_ADM(min4)
              min4 = z4
              CALL PUSHCONTROL2B(2)
            ELSE
              CALL PUSHREALARRAY_ADM(min4)
              min4 = x5
              CALL PUSHCONTROL2B(3)
            END IF
            CALL PUSHREALARRAY_ADM(dm(npx-1))
            dm(npx-1) = SIGN(min4, dm(npx-1))
!
            x1 = s15*q(npx, j) + s11*q(npx+1, j) - s14*dm(npx+1)
            CALL PUSHREALARRAY_ADM(dm(npx))
            dm(npx) = 0.5*(x1-x0r-x0l)
            IF (dm(npx) .GE. 0.) THEN
              x6 = dm(npx)
              CALL PUSHCONTROL1B(0)
            ELSE
              x6 = -dm(npx)
              CALL PUSHCONTROL1B(1)
            END IF
            IF (q(npx, j) .LT. x0l + x0r) THEN
              IF (x0l + x0r .LT. x1) THEN
                max5 = x1
                CALL PUSHCONTROL2B(0)
              ELSE
                max5 = x0l + x0r
                CALL PUSHCONTROL2B(1)
              END IF
            ELSE IF (q(npx, j) .LT. x1) THEN
              max5 = x1
              CALL PUSHCONTROL2B(2)
            ELSE
              max5 = q(npx, j)
              CALL PUSHCONTROL2B(3)
            END IF
            y5 = max5 - q(npx, j)
            IF (q(npx, j) .GT. x0l + x0r) THEN
              IF (x0l + x0r .GT. x1) THEN
                min10 = x1
                CALL PUSHCONTROL2B(0)
              ELSE
                min10 = x0l + x0r
                CALL PUSHCONTROL2B(1)
              END IF
            ELSE IF (q(npx, j) .GT. x1) THEN
              min10 = x1
              CALL PUSHCONTROL2B(2)
            ELSE
              min10 = q(npx, j)
              CALL PUSHCONTROL2B(3)
            END IF
            z5 = q(npx, j) - min10
            IF (x6 .GT. y5) THEN
              IF (y5 .GT. z5) THEN
                CALL PUSHREALARRAY_ADM(min5)
                min5 = z5
                CALL PUSHCONTROL2B(0)
              ELSE
                CALL PUSHREALARRAY_ADM(min5)
                min5 = y5
                CALL PUSHCONTROL2B(1)
              END IF
            ELSE IF (x6 .GT. z5) THEN
              CALL PUSHREALARRAY_ADM(min5)
              min5 = z5
              CALL PUSHCONTROL2B(2)
            ELSE
              CALL PUSHREALARRAY_ADM(min5)
              min5 = x6
              CALL PUSHCONTROL2B(3)
            END IF
            CALL PUSHREALARRAY_ADM(dm(npx))
            dm(npx) = SIGN(min5, dm(npx))
            CALL PUSHCONTROL2B(2)
          ELSE
            CALL PUSHCONTROL2B(1)
          END IF
        ELSE
          CALL PUSHCONTROL2B(0)
        END IF
        DO i=is,ie+1
          IF (c(i, j) .GT. 0.) THEN
            CALL PUSHCONTROL1B(1)
          ELSE
            CALL PUSHCONTROL1B(0)
          END IF
        END DO
      END DO
      dm_ad = 0.0_FVPRC
      DO j=jlast,jfirst,-1
        DO i=ie+1,is,-1
          CALL POPCONTROL1B(branch)
          IF (branch .EQ. 0) THEN
            q_ad(i, j) = q_ad(i, j) + fx_ad(i, j)
            c_ad(i, j) = c_ad(i, j) - dm(i)*fx_ad(i, j)
            dm_ad(i) = dm_ad(i) - (c(i, j)+1.)*fx_ad(i, j)
            fx_ad(i, j) = 0.0_FVPRC
          ELSE
            q_ad(i-1, j) = q_ad(i-1, j) + fx_ad(i, j)
            c_ad(i, j) = c_ad(i, j) - dm(i-1)*fx_ad(i, j)
            dm_ad(i-1) = dm_ad(i-1) + (1.-c(i, j))*fx_ad(i, j)
            fx_ad(i, j) = 0.0_FVPRC
          END IF
        END DO
        CALL POPCONTROL2B(branch)
        IF (branch .NE. 0) THEN
          IF (branch .NE. 1) THEN
            CALL POPREALARRAY_ADM(dm(npx))
            min5_ad = SIGN(1.d0, min5*dm(npx))*dm_ad(npx)
            dm_ad(npx) = 0.0_FVPRC
            CALL POPCONTROL2B(branch)
            IF (branch .LT. 2) THEN
              IF (branch .EQ. 0) THEN
                CALL POPREALARRAY_ADM(min5)
                z5_ad = min5_ad
                y5_ad = 0.0_FVPRC
              ELSE
                CALL POPREALARRAY_ADM(min5)
                y5_ad = min5_ad
                z5_ad = 0.0_FVPRC
              END IF
              x6_ad = 0.0_FVPRC
            ELSE
              IF (branch .EQ. 2) THEN
                CALL POPREALARRAY_ADM(min5)
                z5_ad = min5_ad
                x6_ad = 0.0_FVPRC
              ELSE
                CALL POPREALARRAY_ADM(min5)
                x6_ad = min5_ad
                z5_ad = 0.0_FVPRC
              END IF
              y5_ad = 0.0_FVPRC
            END IF
            q_ad(npx, j) = q_ad(npx, j) + z5_ad
            min10_ad = -z5_ad
            CALL POPCONTROL2B(branch)
            IF (branch .LT. 2) THEN
              IF (branch .EQ. 0) THEN
                x1_ad = min10_ad
                x0l_ad = 0.0_FVPRC
                x0r_ad = 0.0_FVPRC
              ELSE
                x0l_ad = min10_ad
                x0r_ad = min10_ad
                x1_ad = 0.0_FVPRC
              END IF
            ELSE
              IF (branch .EQ. 2) THEN
                x1_ad = min10_ad
              ELSE
                q_ad(npx, j) = q_ad(npx, j) + min10_ad
                x1_ad = 0.0_FVPRC
              END IF
              x0l_ad = 0.0_FVPRC
              x0r_ad = 0.0_FVPRC
            END IF
            max5_ad = y5_ad
            q_ad(npx, j) = q_ad(npx, j) - y5_ad
            CALL POPCONTROL2B(branch)
            IF (branch .LT. 2) THEN
              IF (branch .EQ. 0) THEN
                x1_ad = x1_ad + max5_ad
              ELSE
                x0l_ad = x0l_ad + max5_ad
                x0r_ad = x0r_ad + max5_ad
              END IF
            ELSE IF (branch .EQ. 2) THEN
              x1_ad = x1_ad + max5_ad
            ELSE
              q_ad(npx, j) = q_ad(npx, j) + max5_ad
            END IF
            CALL POPCONTROL1B(branch)
            IF (branch .EQ. 0) THEN
              dm_ad(npx) = dm_ad(npx) + x6_ad
            ELSE
              dm_ad(npx) = dm_ad(npx) - x6_ad
            END IF
            CALL POPREALARRAY_ADM(dm(npx))
            temp_ad12 = 0.5*dm_ad(npx)
            x1_ad = x1_ad + temp_ad12
            x0r_ad = x0r_ad - temp_ad12
            x0l_ad = x0l_ad - temp_ad12
            dm_ad(npx) = 0.0_FVPRC
            q_ad(npx, j) = q_ad(npx, j) + s15*x1_ad
            q_ad(npx+1, j) = q_ad(npx+1, j) + s11*x1_ad
            dm_ad(npx+1) = dm_ad(npx+1) - s14*x1_ad
            CALL POPREALARRAY_ADM(dm(npx-1))
            min4_ad = SIGN(1.d0, min4*dm(npx-1))*dm_ad(npx-1)
            dm_ad(npx-1) = 0.0_FVPRC
            CALL POPCONTROL2B(branch)
            IF (branch .LT. 2) THEN
              IF (branch .EQ. 0) THEN
                CALL POPREALARRAY_ADM(min4)
                z4_ad = min4_ad
                y4_ad = 0.0_FVPRC
              ELSE
                CALL POPREALARRAY_ADM(min4)
                y4_ad = min4_ad
                z4_ad = 0.0_FVPRC
              END IF
              x5_ad = 0.0_FVPRC
            ELSE
              IF (branch .EQ. 2) THEN
                CALL POPREALARRAY_ADM(min4)
                z4_ad = min4_ad
                x5_ad = 0.0_FVPRC
              ELSE
                CALL POPREALARRAY_ADM(min4)
                x5_ad = min4_ad
                z4_ad = 0.0_FVPRC
              END IF
              y4_ad = 0.0_FVPRC
            END IF
            q_ad(npx-1, j) = q_ad(npx-1, j) + z4_ad
            min9_ad = -z4_ad
            CALL POPCONTROL2B(branch)
            IF (branch .LT. 2) THEN
              IF (branch .EQ. 0) THEN
                x1_ad = min9_ad
              ELSE
                x0l_ad = x0l_ad + min9_ad
                x0r_ad = x0r_ad + min9_ad
                x1_ad = 0.0_FVPRC
              END IF
            ELSE IF (branch .EQ. 2) THEN
              x1_ad = min9_ad
            ELSE
              q_ad(npx-1, j) = q_ad(npx-1, j) + min9_ad
              x1_ad = 0.0_FVPRC
            END IF
            max4_ad = y4_ad
            q_ad(npx-1, j) = q_ad(npx-1, j) - y4_ad
            CALL POPCONTROL2B(branch)
            IF (branch .LT. 2) THEN
              IF (branch .EQ. 0) THEN
                x1_ad = x1_ad + max4_ad
              ELSE
                x0l_ad = x0l_ad + max4_ad
                x0r_ad = x0r_ad + max4_ad
              END IF
            ELSE IF (branch .EQ. 2) THEN
              x1_ad = x1_ad + max4_ad
            ELSE
              q_ad(npx-1, j) = q_ad(npx-1, j) + max4_ad
            END IF
            CALL POPCONTROL1B(branch)
            IF (branch .EQ. 0) THEN
              dm_ad(npx-1) = dm_ad(npx-1) + x5_ad
            ELSE
              dm_ad(npx-1) = dm_ad(npx-1) - x5_ad
            END IF
            CALL POPREALARRAY_ADM(dm(npx-1))
            temp_ad9 = 0.5*dm_ad(npx-1)
            x0r_ad = x0r_ad + temp_ad9
            x0l_ad = x0l_ad + temp_ad9
            x1_ad = x1_ad - temp_ad9
            dm_ad(npx-1) = 0.0_FVPRC
            q_ad(npx-1, j) = q_ad(npx-1, j) + s15*x1_ad
            q_ad(npx-2, j) = q_ad(npx-2, j) + s11*x1_ad
            dm_ad(npx-2) = dm_ad(npx-2) + s14*x1_ad
            temp_ad10 = 0.5*x0r_ad/(dxa(npx, j)+dxa(npx+1, j))
            q_ad(npx, j) = q_ad(npx, j) + (dxa(npx, j)*2.+dxa(npx+1, j))&
&             *temp_ad10
            q_ad(npx+1, j) = q_ad(npx+1, j) - dxa(npx, j)*temp_ad10
            temp_ad11 = 0.5*x0l_ad/(dxa(npx-1, j)+dxa(npx-2, j))
            q_ad(npx-1, j) = q_ad(npx-1, j) + (dxa(npx-1, j)*2.+dxa(npx-&
&             2, j))*temp_ad11
            q_ad(npx-2, j) = q_ad(npx-2, j) - dxa(npx-1, j)*temp_ad11
          END IF
          CALL POPCONTROL1B(branch)
          IF (branch .EQ. 0) THEN
            CALL POPREALARRAY_ADM(dm(0))
            min3_ad = SIGN(1.d0, min3*dm(0))*dm_ad(0)
            dm_ad(0) = 0.0_FVPRC
            CALL POPCONTROL2B(branch)
            IF (branch .LT. 2) THEN
              IF (branch .EQ. 0) THEN
                CALL POPREALARRAY_ADM(min3)
                z3_ad = min3_ad
                y3_ad = 0.0_FVPRC
              ELSE
                CALL POPREALARRAY_ADM(min3)
                y3_ad = min3_ad
                z3_ad = 0.0_FVPRC
              END IF
              x4_ad = 0.0_FVPRC
            ELSE
              IF (branch .EQ. 2) THEN
                CALL POPREALARRAY_ADM(min3)
                z3_ad = min3_ad
                x4_ad = 0.0_FVPRC
              ELSE
                CALL POPREALARRAY_ADM(min3)
                x4_ad = min3_ad
                z3_ad = 0.0_FVPRC
              END IF
              y3_ad = 0.0_FVPRC
            END IF
            q_ad(0, j) = q_ad(0, j) + z3_ad
            min8_ad = -z3_ad
            CALL POPCONTROL2B(branch)
            IF (branch .LT. 2) THEN
              IF (branch .EQ. 0) THEN
                x1_ad = min8_ad
                x0l_ad = 0.0_FVPRC
                x0r_ad = 0.0_FVPRC
              ELSE
                x0l_ad = min8_ad
                x0r_ad = min8_ad
                x1_ad = 0.0_FVPRC
              END IF
            ELSE
              IF (branch .EQ. 2) THEN
                x1_ad = min8_ad
              ELSE
                q_ad(0, j) = q_ad(0, j) + min8_ad
                x1_ad = 0.0_FVPRC
              END IF
              x0l_ad = 0.0_FVPRC
              x0r_ad = 0.0_FVPRC
            END IF
            max3_ad = y3_ad
            q_ad(0, j) = q_ad(0, j) - y3_ad
            CALL POPCONTROL2B(branch)
            IF (branch .LT. 2) THEN
              IF (branch .EQ. 0) THEN
                x1_ad = x1_ad + max3_ad
              ELSE
                x0l_ad = x0l_ad + max3_ad
                x0r_ad = x0r_ad + max3_ad
              END IF
            ELSE IF (branch .EQ. 2) THEN
              x1_ad = x1_ad + max3_ad
            ELSE
              q_ad(0, j) = q_ad(0, j) + max3_ad
            END IF
            CALL POPCONTROL1B(branch)
            IF (branch .EQ. 0) THEN
              dm_ad(0) = dm_ad(0) + x4_ad
            ELSE
              dm_ad(0) = dm_ad(0) - x4_ad
            END IF
            CALL POPREALARRAY_ADM(dm(0))
            temp_ad8 = 0.5*dm_ad(0)
            x0r_ad = x0r_ad + temp_ad8
            x0l_ad = x0l_ad + temp_ad8
            x1_ad = x1_ad - temp_ad8
            dm_ad(0) = 0.0_FVPRC
            q_ad(0, j) = q_ad(0, j) + s15*x1_ad
            q_ad(-1, j) = q_ad(-1, j) + s11*x1_ad
            dm_ad(-1) = dm_ad(-1) + s14*x1_ad
            CALL POPREALARRAY_ADM(dm(1))
            min2_ad = SIGN(1.d0, min2*dm(1))*dm_ad(1)
            dm_ad(1) = 0.0_FVPRC
            CALL POPCONTROL2B(branch)
            IF (branch .LT. 2) THEN
              IF (branch .EQ. 0) THEN
                CALL POPREALARRAY_ADM(min2)
                z2_ad = min2_ad
                y2_ad = 0.0_FVPRC
              ELSE
                CALL POPREALARRAY_ADM(min2)
                y2_ad = min2_ad
                z2_ad = 0.0_FVPRC
              END IF
              x3_ad = 0.0_FVPRC
            ELSE
              IF (branch .EQ. 2) THEN
                CALL POPREALARRAY_ADM(min2)
                z2_ad = min2_ad
                x3_ad = 0.0_FVPRC
              ELSE
                CALL POPREALARRAY_ADM(min2)
                x3_ad = min2_ad
                z2_ad = 0.0_FVPRC
              END IF
              y2_ad = 0.0_FVPRC
            END IF
            q_ad(1, j) = q_ad(1, j) + z2_ad
            min7_ad = -z2_ad
            CALL POPCONTROL2B(branch)
            IF (branch .LT. 2) THEN
              IF (branch .EQ. 0) THEN
                x1_ad = min7_ad
              ELSE
                x0l_ad = x0l_ad + min7_ad
                x0r_ad = x0r_ad + min7_ad
                x1_ad = 0.0_FVPRC
              END IF
            ELSE IF (branch .EQ. 2) THEN
              x1_ad = min7_ad
            ELSE
              q_ad(1, j) = q_ad(1, j) + min7_ad
              x1_ad = 0.0_FVPRC
            END IF
            max2_ad = y2_ad
            q_ad(1, j) = q_ad(1, j) - y2_ad
            CALL POPCONTROL2B(branch)
            IF (branch .LT. 2) THEN
              IF (branch .EQ. 0) THEN
                x1_ad = x1_ad + max2_ad
              ELSE
                x0l_ad = x0l_ad + max2_ad
                x0r_ad = x0r_ad + max2_ad
              END IF
            ELSE IF (branch .EQ. 2) THEN
              x1_ad = x1_ad + max2_ad
            ELSE
              q_ad(1, j) = q_ad(1, j) + max2_ad
            END IF
            CALL POPCONTROL1B(branch)
            IF (branch .EQ. 0) THEN
              dm_ad(1) = dm_ad(1) + x3_ad
            ELSE
              dm_ad(1) = dm_ad(1) - x3_ad
            END IF
            CALL POPREALARRAY_ADM(dm(1))
            temp_ad5 = 0.5*dm_ad(1)
            x1_ad = x1_ad + temp_ad5
            x0l_ad = x0l_ad - temp_ad5
            x0r_ad = x0r_ad - temp_ad5
            dm_ad(1) = 0.0_FVPRC
            q_ad(1, j) = q_ad(1, j) + s15*x1_ad
            q_ad(2, j) = q_ad(2, j) + s11*x1_ad
            dm_ad(2) = dm_ad(2) - s14*x1_ad
            temp_ad6 = 0.5*x0r_ad/(dxa(1, j)+dxa(2, j))
            q_ad(1, j) = q_ad(1, j) + (dxa(1, j)*2.+dxa(2, j))*temp_ad6
            q_ad(2, j) = q_ad(2, j) - dxa(1, j)*temp_ad6
            temp_ad7 = 0.5*x0l_ad/(dxa(0, j)+dxa(-1, j))
            q_ad(0, j) = q_ad(0, j) + (dxa(0, j)*2.+dxa(-1, j))*temp_ad7
            q_ad(-1, j) = q_ad(-1, j) - dxa(0, j)*temp_ad7
          END IF
        END IF
        DO i=ie+2,is-2,-1
          CALL POPREALARRAY_ADM(dm(i))
          min1_ad = SIGN(1.d0, min1*dm(i))*dm_ad(i)
          dm_ad(i) = 0.0_FVPRC
          CALL POPCONTROL2B(branch)
          IF (branch .LT. 2) THEN
            IF (branch .EQ. 0) THEN
              CALL POPREALARRAY_ADM(min1)
              z1_ad = min1_ad
              y1_ad = 0.0_FVPRC
            ELSE
              CALL POPREALARRAY_ADM(min1)
              y1_ad = min1_ad
              z1_ad = 0.0_FVPRC
            END IF
            x2_ad = 0.0_FVPRC
          ELSE
            IF (branch .EQ. 2) THEN
              CALL POPREALARRAY_ADM(min1)
              z1_ad = min1_ad
              x2_ad = 0.0_FVPRC
            ELSE
              CALL POPREALARRAY_ADM(min1)
              x2_ad = min1_ad
              z1_ad = 0.0_FVPRC
            END IF
            y1_ad = 0.0_FVPRC
          END IF
          q_ad(i, j) = q_ad(i, j) + z1_ad
          min6_ad = -z1_ad
          CALL POPCONTROL2B(branch)
          IF (branch .LT. 2) THEN
            IF (branch .EQ. 0) THEN
              q_ad(i+1, j) = q_ad(i+1, j) + min6_ad
            ELSE
              q_ad(i, j) = q_ad(i, j) + min6_ad
            END IF
          ELSE IF (branch .EQ. 2) THEN
            q_ad(i+1, j) = q_ad(i+1, j) + min6_ad
          ELSE
            q_ad(i-1, j) = q_ad(i-1, j) + min6_ad
          END IF
          max1_ad = y1_ad
          q_ad(i, j) = q_ad(i, j) - y1_ad
          CALL POPCONTROL2B(branch)
          IF (branch .LT. 2) THEN
            IF (branch .EQ. 0) THEN
              q_ad(i+1, j) = q_ad(i+1, j) + max1_ad
            ELSE
              q_ad(i, j) = q_ad(i, j) + max1_ad
            END IF
          ELSE IF (branch .EQ. 2) THEN
            q_ad(i+1, j) = q_ad(i+1, j) + max1_ad
          ELSE
            q_ad(i-1, j) = q_ad(i-1, j) + max1_ad
          END IF
          CALL POPCONTROL1B(branch)
          IF (branch .EQ. 0) THEN
            dm_ad(i) = dm_ad(i) + x2_ad
          ELSE
            dm_ad(i) = dm_ad(i) - x2_ad
          END IF
          CALL POPREALARRAY_ADM(dm(i))
          q_ad(i+1, j) = q_ad(i+1, j) + 0.25*dm_ad(i)
          q_ad(i-1, j) = q_ad(i-1, j) - 0.25*dm_ad(i)
          dm_ad(i) = 0.0_FVPRC
        END DO
      END DO
    ELSE
      CALL FXPPM_ADM(c, c_ad, q, q_ad, fx, fx_ad, iord, ifirst, ilast, &
&              jfirst, jlast, npx, npy, bd, dxa, nested, grid_type)
    END IF
  END SUBROUTINE XTP_ADM
  SUBROUTINE XTP(fx, q, c, iord, ifirst, ilast, jfirst, jlast, npx, npy&
&   , bd, dxa, nested, grid_type)
    IMPLICIT NONE
    TYPE(FV_GRID_BOUNDS_TYPE), INTENT(IN) :: bd
!  X-Dir strip
    INTEGER, INTENT(IN) :: ifirst, ilast
!  Y-Dir strip
    INTEGER, INTENT(IN) :: jfirst, jlast
    INTEGER, INTENT(IN) :: npx, npy
    INTEGER, INTENT(IN) :: iord
! Courant numbers
    REAL(fvprc), INTENT(IN) :: c(bd%is:bd%ie+1, jfirst:jlast)
    REAL(fvprc), INTENT(IN) :: q(bd%isd:bd%ied, jfirst:jlast)
    REAL(fvprc), INTENT(OUT) :: fx(ifirst:ilast+1, jfirst:jlast)
    REAL(fvprc), INTENT(IN) :: dxa(bd%isd:bd%ied, bd%jsd:bd%jed)
    LOGICAL, INTENT(IN) :: nested
    INTEGER, INTENT(IN) :: grid_type
! Local:
    REAL(fvprc) :: dm(bd%is-2:bd%ie+2)
    REAL(fvprc) :: x0l, x0r, x1
    INTEGER :: i, j
    INTEGER :: is, ie, js, je, isd, ied, jsd, jed
    INTRINSIC ABS
    INTRINSIC MAX
    INTRINSIC MIN
    INTRINSIC SIGN
    REAL(fvprc) :: min1
    REAL(fvprc) :: min2
    REAL(fvprc) :: min3
    REAL(fvprc) :: min4
    REAL(fvprc) :: min5
    REAL(fvprc) :: max1
    REAL(fvprc) :: min6
    REAL(fvprc) :: max2
    REAL(fvprc) :: min7
    REAL(fvprc) :: max3
    REAL(fvprc) :: min8
    REAL(fvprc) :: max4
    REAL(fvprc) :: min9
    REAL(fvprc) :: max5
    REAL(fvprc) :: min10
    REAL(fvprc) :: x6
    REAL(fvprc) :: x5
    REAL(fvprc) :: x4
    REAL(fvprc) :: x3
    REAL(fvprc) :: x2
    REAL(fvprc) :: z5
    REAL(fvprc) :: z4
    REAL(fvprc) :: z3
    REAL(fvprc) :: z2
    REAL(fvprc) :: z1
    REAL(fvprc) :: y5
    REAL(fvprc) :: y4
    REAL(fvprc) :: y3
    REAL(fvprc) :: y2
    REAL(fvprc) :: y1
    is = bd%is
    ie = bd%ie
    js = bd%js
    je = bd%je
    isd = bd%isd
    ied = bd%ied
    jsd = bd%jsd
    jed = bd%jed
    IF (iord .EQ. 1) THEN
      DO j=jfirst,jlast
        DO i=ifirst,ilast+1
          IF (c(i, j) .GT. 0.) THEN
            fx(i, j) = q(i-1, j)
          ELSE
            fx(i, j) = q(i, j)
          END IF
        END DO
      END DO
    ELSE IF (iord .EQ. 333) THEN
!Advection using third order scheme
      DO j=jfirst,jlast
        DO i=ifirst,ilast+1
          IF (c(i, j) .GT. 0.) THEN
            fx(i, j) = (2.0*q(i, j)+5.0*q(i-1, j)-q(i-2, j))/6.0 - 0.5*c&
&             (i, j)*(q(i, j)-q(i-1, j)) + c(i, j)*c(i, j)/6.0*(q(i, j)-&
&             2.0*q(i-1, j)+q(i-2, j))
          ELSE
            fx(i, j) = (2.0*q(i-1, j)+5.0*q(i, j)-q(i+1, j))/6.0 - 0.5*c&
&             (i, j)*(q(i, j)-q(i-1, j)) + c(i, j)*c(i, j)/6.0*(q(i+1, j&
&             )-2.0*q(i, j)+q(i-1, j))
          END IF
        END DO
      END DO
    ELSE IF (iord .EQ. 2) THEN
      DO j=jfirst,jlast
        DO i=is-2,ie+2
          dm(i) = 0.25*(q(i+1, j)-q(i-1, j))
          IF (dm(i) .GE. 0.) THEN
            x2 = dm(i)
          ELSE
            x2 = -dm(i)
          END IF
          IF (q(i-1, j) .LT. q(i, j)) THEN
            IF (q(i, j) .LT. q(i+1, j)) THEN
              max1 = q(i+1, j)
            ELSE
              max1 = q(i, j)
            END IF
          ELSE IF (q(i-1, j) .LT. q(i+1, j)) THEN
            max1 = q(i+1, j)
          ELSE
            max1 = q(i-1, j)
          END IF
          y1 = max1 - q(i, j)
          IF (q(i-1, j) .GT. q(i, j)) THEN
            IF (q(i, j) .GT. q(i+1, j)) THEN
              min6 = q(i+1, j)
            ELSE
              min6 = q(i, j)
            END IF
          ELSE IF (q(i-1, j) .GT. q(i+1, j)) THEN
            min6 = q(i+1, j)
          ELSE
            min6 = q(i-1, j)
          END IF
          z1 = q(i, j) - min6
          IF (x2 .GT. y1) THEN
            IF (y1 .GT. z1) THEN
              min1 = z1
            ELSE
              min1 = y1
            END IF
          ELSE IF (x2 .GT. z1) THEN
            min1 = z1
          ELSE
            min1 = x2
          END IF
          dm(i) = SIGN(min1, dm(i))
        END DO
        IF (grid_type .LT. 3 .AND. (.NOT.nested)) THEN
!--------------
! fix the edges 
!  NOW: interpolation to the edge (originally from PL07, appendix C) generalized first for variable dx, then for dx which differs
! between the two sides of the edge
!--------------
          IF (is .EQ. 1) THEN
!             x0 = 0.5*(3.0*(q(0,j)+q(1,j))   &
!                - (q(-1,j)+q(2,j)))/ ( 2.0 )
!             x0 = 0.5*((2.*dxa(1,j)+dxa(2,j))*(q(0,j)+q(1,j))   &
!                - dxa(1,j)*(q(-1,j)+q(2,j)))/ ( dxa(1,j)+dxa(2,j))
            x0l = 0.5*((2.*dxa(0, j)+dxa(-1, j))*q(0, j)-dxa(0, j)*q(-1&
&             , j))/(dxa(0, j)+dxa(-1, j))
            x0r = 0.5*((2.*dxa(1, j)+dxa(2, j))*q(1, j)-dxa(1, j)*q(2, j&
&             ))/(dxa(1, j)+dxa(2, j))
            x1 = s15*q(1, j) + s11*q(2, j) - s14*dm(2)
            dm(1) = 0.5*(x1-x0l-x0r)
            IF (dm(1) .GE. 0.) THEN
              x3 = dm(1)
            ELSE
              x3 = -dm(1)
            END IF
            IF (q(1, j) .LT. x0l + x0r) THEN
              IF (x0l + x0r .LT. x1) THEN
                max2 = x1
              ELSE
                max2 = x0l + x0r
              END IF
            ELSE IF (q(1, j) .LT. x1) THEN
              max2 = x1
            ELSE
              max2 = q(1, j)
            END IF
            y2 = max2 - q(1, j)
            IF (q(1, j) .GT. x0l + x0r) THEN
              IF (x0l + x0r .GT. x1) THEN
                min7 = x1
              ELSE
                min7 = x0l + x0r
              END IF
            ELSE IF (q(1, j) .GT. x1) THEN
              min7 = x1
            ELSE
              min7 = q(1, j)
            END IF
            z2 = q(1, j) - min7
            IF (x3 .GT. y2) THEN
              IF (y2 .GT. z2) THEN
                min2 = z2
              ELSE
                min2 = y2
              END IF
            ELSE IF (x3 .GT. z2) THEN
              min2 = z2
            ELSE
              min2 = x3
            END IF
            dm(1) = SIGN(min2, dm(1))
!
            x1 = s15*q(0, j) + s11*q(-1, j) + s14*dm(-1)
            dm(0) = 0.5*(x0r+x0l-x1)
            IF (dm(0) .GE. 0.) THEN
              x4 = dm(0)
            ELSE
              x4 = -dm(0)
            END IF
            IF (q(0, j) .LT. x0l + x0r) THEN
              IF (x0l + x0r .LT. x1) THEN
                max3 = x1
              ELSE
                max3 = x0l + x0r
              END IF
            ELSE IF (q(0, j) .LT. x1) THEN
              max3 = x1
            ELSE
              max3 = q(0, j)
            END IF
            y3 = max3 - q(0, j)
            IF (q(0, j) .GT. x0l + x0r) THEN
              IF (x0l + x0r .GT. x1) THEN
                min8 = x1
              ELSE
                min8 = x0l + x0r
              END IF
            ELSE IF (q(0, j) .GT. x1) THEN
              min8 = x1
            ELSE
              min8 = q(0, j)
            END IF
            z3 = q(0, j) - min8
            IF (x4 .GT. y3) THEN
              IF (y3 .GT. z3) THEN
                min3 = z3
              ELSE
                min3 = y3
              END IF
            ELSE IF (x4 .GT. z3) THEN
              min3 = z3
            ELSE
              min3 = x4
            END IF
            dm(0) = SIGN(min3, dm(0))
          END IF
          IF (ie + 1 .EQ. npx) THEN
!              x0 = 0.5*(3.0*(q(npx-1,j)+q(npx,j))   &
!                - (q(npx-2,j)+q(npx+1,j)))/( 2.0 )
!              x0 = 0.5*( (2.*dxa(npx-1,j)+dxa(npx-2,j))*(q(npx-1,j)+q(npx,j))   &
!                - dxa(npx-1,j)*(q(npx-2,j)+q(npx+1,j)))/( dxa(npx-1,j)+dxa(npx-2,j))
            x0l = 0.5*((2.*dxa(npx-1, j)+dxa(npx-2, j))*q(npx-1, j)-dxa(&
&             npx-1, j)*q(npx-2, j))/(dxa(npx-1, j)+dxa(npx-2, j))
            x0r = 0.5*((2.*dxa(npx, j)+dxa(npx+1, j))*q(npx, j)-dxa(npx&
&             , j)*q(npx+1, j))/(dxa(npx, j)+dxa(npx+1, j))
            x1 = s15*q(npx-1, j) + s11*q(npx-2, j) + s14*dm(npx-2)
            dm(npx-1) = 0.5*(x0r+x0l-x1)
            IF (dm(npx-1) .GE. 0.) THEN
              x5 = dm(npx-1)
            ELSE
              x5 = -dm(npx-1)
            END IF
            IF (q(npx-1, j) .LT. x0l + x0r) THEN
              IF (x0l + x0r .LT. x1) THEN
                max4 = x1
              ELSE
                max4 = x0l + x0r
              END IF
            ELSE IF (q(npx-1, j) .LT. x1) THEN
              max4 = x1
            ELSE
              max4 = q(npx-1, j)
            END IF
            y4 = max4 - q(npx-1, j)
            IF (q(npx-1, j) .GT. x0l + x0r) THEN
              IF (x0l + x0r .GT. x1) THEN
                min9 = x1
              ELSE
                min9 = x0l + x0r
              END IF
            ELSE IF (q(npx-1, j) .GT. x1) THEN
              min9 = x1
            ELSE
              min9 = q(npx-1, j)
            END IF
            z4 = q(npx-1, j) - min9
            IF (x5 .GT. y4) THEN
              IF (y4 .GT. z4) THEN
                min4 = z4
              ELSE
                min4 = y4
              END IF
            ELSE IF (x5 .GT. z4) THEN
              min4 = z4
            ELSE
              min4 = x5
            END IF
            dm(npx-1) = SIGN(min4, dm(npx-1))
!
            x1 = s15*q(npx, j) + s11*q(npx+1, j) - s14*dm(npx+1)
            dm(npx) = 0.5*(x1-x0r-x0l)
            IF (dm(npx) .GE. 0.) THEN
              x6 = dm(npx)
            ELSE
              x6 = -dm(npx)
            END IF
            IF (q(npx, j) .LT. x0l + x0r) THEN
              IF (x0l + x0r .LT. x1) THEN
                max5 = x1
              ELSE
                max5 = x0l + x0r
              END IF
            ELSE IF (q(npx, j) .LT. x1) THEN
              max5 = x1
            ELSE
              max5 = q(npx, j)
            END IF
            y5 = max5 - q(npx, j)
            IF (q(npx, j) .GT. x0l + x0r) THEN
              IF (x0l + x0r .GT. x1) THEN
                min10 = x1
              ELSE
                min10 = x0l + x0r
              END IF
            ELSE IF (q(npx, j) .GT. x1) THEN
              min10 = x1
            ELSE
              min10 = q(npx, j)
            END IF
            z5 = q(npx, j) - min10
            IF (x6 .GT. y5) THEN
              IF (y5 .GT. z5) THEN
                min5 = z5
              ELSE
                min5 = y5
              END IF
            ELSE IF (x6 .GT. z5) THEN
              min5 = z5
            ELSE
              min5 = x6
            END IF
            dm(npx) = SIGN(min5, dm(npx))
          END IF
        END IF
        DO i=is,ie+1
          IF (c(i, j) .GT. 0.) THEN
            fx(i, j) = q(i-1, j) + (1.-c(i, j))*dm(i-1)
          ELSE
            fx(i, j) = q(i, j) - (1.+c(i, j))*dm(i)
          END IF
        END DO
      END DO
    ELSE
      CALL FXPPM(c, q, fx, iord, ifirst, ilast, jfirst, jlast, npx, npy&
&          , bd, dxa, nested, grid_type)
    END IF
  END SUBROUTINE XTP
!  Differentiation of ytp in reverse (adjoint) mode (with options r8 split(a2b_edge_mod.a2b_ord2 a2b_edge_mod.a2b_ord4 a2b_edg
!e_mod.extrap_corner  dyn_core_mod.dyn_core dyn_core_mod.pk3_halo dyn_core_mod.pln_halo dyn_core_mod.pe_halo dyn_core_mod.adv_
!pe dyn_core_mod.p_grad_c dyn_core_mod.nh_p_grad dyn_core_mod.split_p_grad dyn_core_mod.one_grad_p dyn_core_mod.grad1_p_update dy
!n_core_mod.mix_dp dyn_core_mod.geopk dyn_core_mod.del2_cubed fv_dynamics_mod.fv_dynamics fv_dynamics_mod.rayleigh_super fv_dynam
!ics_mod.rayleigh_friction fv_dynamics_mod.compute_aam fv_dynamics_mod.geos_to_fv3 fv_grid_utils_mod.cubed_to_latlon fv_grid_util
!s_mod.c2l_ord4 fv_grid_utils_mod.c2l_ord2 fv_mapz_mod.lagrangian_to_eulerian fv_mapz_mod.compute_total_energy fv_mapz_mod.pkez f
!v_mapz_mod.remap_z fv_mapz_mod.map_scalar fv_mapz_mod.map1_ppm fv_mapz_mod.mapn_tracer fv_mapz_mod.map1_q2 fv_map
!z_mod.map1_cubic fv_mapz_mod.scalar_profile_linear fv_mapz_mod.cs_profile_linear fv_mapz_mod.steepz fv_tracer2d_mod.tracer
!_2d fv_tracer2d_mod.tracer_2d_nested nh_core_mod.update_dz_c nh_core_mod.update_dz_d nh_core_mod.riem_solver_c nh_core_mod.riem_
!solver3 nh_core_mod.rim_2d nh_core_mod.sim3_solver nh_core_mod.sim3p0_solver nh_core_mod.sim1_solver nh_core_mod.sim_solver nh_c
!ore_mod.edge_profile sw_core_mod.c_sw sw_core_mod.d_sw sw_core_mod.divergence_corner sw_core_mod.divergence_corner_nest sw_core_
!mod.d2a2c_vect sw_core_mod.edge_interpolate4 sw_core_mod.fill2_4corners sw_core_mod.fill_4corners sw_core_mod.compute_div_dampin
!g_fb sw_core_mod.smag_corner sw_core_mod.ytp_v sw_core_mod.xtp_u tp_core_mod.fv_tp_2d tp_core_mod.copy_corners tp
!_core_mod.xtp tp_core_mod.ytp tp_core_mod.xppm0 tp_core_mod.yppm0 tp_core_mod.fxppm tp_core_mod.fyppm tp_core_
!mod.deln_flux)):
!   gradient     of useful results: q fy c
!   with respect to varying inputs: q fy c
  SUBROUTINE YTP_ADM(fy, fy_ad, q, q_ad, c, c_ad, jord, ifirst, ilast, &
&   jfirst, jlast, npx, npy, bd, dya, nested, grid_type)
    IMPLICIT NONE
    TYPE(FV_GRID_BOUNDS_TYPE), INTENT(IN) :: bd
    INTEGER, INTENT(IN) :: npx, npy
!  X-Dir strip
    INTEGER, INTENT(IN) :: ifirst, ilast
!  Y-Dir strip
    INTEGER, INTENT(IN) :: jfirst, jlast
    INTEGER, INTENT(IN) :: jord
    REAL(fvprc), INTENT(IN) :: q(ifirst:ilast, jfirst-ng:jlast+ng)
    REAL(fvprc) :: q_ad(ifirst:ilast, jfirst-ng:jlast+ng)
! Courant number
    REAL(fvprc), INTENT(IN) :: c(bd%isd:bd%ied, bd%js:bd%je+1)
    REAL(fvprc) :: c_ad(bd%isd:bd%ied, bd%js:bd%je+1)
!  Flux
    REAL(fvprc) :: fy(ifirst:ilast, jfirst:jlast+1)
    REAL(fvprc) :: fy_ad(ifirst:ilast, jfirst:jlast+1)
    REAL(fvprc), INTENT(IN) :: dya(bd%isd:bd%ied, bd%jsd:bd%jed)
    LOGICAL, INTENT(IN) :: nested
    INTEGER, INTENT(IN) :: grid_type
! !LOCAL VARIABLES:
    REAL(fvprc) :: dm(ifirst:ilast, jfirst-2:jlast+2)
    REAL(fvprc) :: dm_ad(ifirst:ilast, jfirst-2:jlast+2)
    REAL(fvprc) :: x0l, x0r, x1
    REAL(fvprc) :: x0l_ad, x0r_ad, x1_ad
    INTEGER :: i, j
    INTEGER :: is, ie, js, je, isd, ied, jsd, jed
    INTRINSIC ABS
    INTRINSIC MAX
    INTRINSIC MIN
    INTRINSIC SIGN
    REAL(fvprc) :: min1
    REAL(fvprc) :: min1_ad
    REAL(fvprc) :: min2
    REAL(fvprc) :: min2_ad
    REAL(fvprc) :: min3
    REAL(fvprc) :: min3_ad
    REAL(fvprc) :: min4
    REAL(fvprc) :: min4_ad
    REAL(fvprc) :: min5
    REAL(fvprc) :: min5_ad
    REAL(fvprc) :: max1
    REAL(fvprc) :: max1_ad
    REAL(fvprc) :: min6
    REAL(fvprc) :: min6_ad
    REAL(fvprc) :: max2
    REAL(fvprc) :: max2_ad
    REAL(fvprc) :: min7
    REAL(fvprc) :: min7_ad
    REAL(fvprc) :: max3
    REAL(fvprc) :: max3_ad
    REAL(fvprc) :: min8
    REAL(fvprc) :: min8_ad
    REAL(fvprc) :: max4
    REAL(fvprc) :: max4_ad
    REAL(fvprc) :: min9
    REAL(fvprc) :: min9_ad
    REAL(fvprc) :: max5
    REAL(fvprc) :: max5_ad
    REAL(fvprc) :: min10
    REAL(fvprc) :: min10_ad
    REAL(fvprc) :: temp_ad
    REAL(fvprc) :: temp_ad0
    REAL(fvprc) :: temp_ad1
    REAL(fvprc) :: temp_ad2
    REAL(fvprc) :: temp_ad3
    REAL(fvprc) :: temp_ad4
    REAL(fvprc) :: x2_ad
    REAL(fvprc) :: y1_ad
    REAL(fvprc) :: z1_ad
    REAL(fvprc) :: temp_ad5
    REAL(fvprc) :: temp_ad6
    REAL(fvprc) :: temp_ad7
    REAL(fvprc) :: x3_ad
    REAL(fvprc) :: y2_ad
    REAL(fvprc) :: z2_ad
    REAL(fvprc) :: temp_ad8
    REAL(fvprc) :: x4_ad
    REAL(fvprc) :: y3_ad
    REAL(fvprc) :: z3_ad
    REAL(fvprc) :: temp_ad9
    REAL(fvprc) :: temp_ad10
    REAL(fvprc) :: temp_ad11
    REAL(fvprc) :: x5_ad
    REAL(fvprc) :: y4_ad
    REAL(fvprc) :: z4_ad
    REAL(fvprc) :: temp_ad12
    REAL(fvprc) :: x6_ad
    REAL(fvprc) :: y5_ad
    REAL(fvprc) :: z5_ad
    INTEGER :: branch
    REAL(fvprc) :: x6
    REAL(fvprc) :: x5
    REAL(fvprc) :: x4
    REAL(fvprc) :: x3
    REAL(fvprc) :: x2
    REAL(fvprc) :: z5
    REAL(fvprc) :: z4
    REAL(fvprc) :: z3
    REAL(fvprc) :: z2
    REAL(fvprc) :: z1
    REAL(fvprc) :: y5
    REAL(fvprc) :: y4
    REAL(fvprc) :: y3
    REAL(fvprc) :: y2
    REAL(fvprc) :: y1
    js = bd%js
    je = bd%je
    IF (jord .EQ. 1) THEN
      DO j=jfirst,jlast+1
        DO i=ifirst,ilast
          IF (c(i, j) .GT. 0.) THEN
            CALL PUSHCONTROL1B(1)
          ELSE
            CALL PUSHCONTROL1B(0)
          END IF
        END DO
      END DO
      DO j=jlast+1,jfirst,-1
        DO i=ilast,ifirst,-1
          CALL POPCONTROL1B(branch)
          IF (branch .EQ. 0) THEN
            q_ad(i, j) = q_ad(i, j) + fy_ad(i, j)
            fy_ad(i, j) = 0.0_FVPRC
          ELSE
            q_ad(i, j-1) = q_ad(i, j-1) + fy_ad(i, j)
            fy_ad(i, j) = 0.0_FVPRC
          END IF
        END DO
      END DO
    ELSE IF (jord .EQ. 333) THEN
!Advected using third order scheme
      DO j=jfirst,jlast+1
        DO i=ifirst,ilast
          IF (c(i, j) .GT. 0.) THEN
            CALL PUSHCONTROL1B(1)
          ELSE
            CALL PUSHCONTROL1B(0)
          END IF
        END DO
      END DO
      DO j=jlast+1,jfirst,-1
        DO i=ilast,ifirst,-1
          CALL POPCONTROL1B(branch)
          IF (branch .EQ. 0) THEN
            temp_ad2 = fy_ad(i, j)/6.0
            temp_ad3 = -(0.5*c(i, j)*fy_ad(i, j))
            temp_ad4 = c(i, j)**2*fy_ad(i, j)/6.0
            q_ad(i, j-1) = q_ad(i, j-1) + temp_ad4 - temp_ad3 + 2.0*&
&             temp_ad2
            q_ad(i, j) = q_ad(i, j) + temp_ad3 - 2.0*temp_ad4 + 5.0*&
&             temp_ad2
            q_ad(i, j+1) = q_ad(i, j+1) + temp_ad4 - temp_ad2
            c_ad(i, j) = c_ad(i, j) + ((q(i, j+1)-2.0*q(i, j)+q(i, j-1))&
&             *2*c(i, j)/6.0-0.5*(q(i, j)-q(i, j-1)))*fy_ad(i, j)
            fy_ad(i, j) = 0.0_FVPRC
          ELSE
            temp_ad = fy_ad(i, j)/6.0
            temp_ad0 = -(0.5*c(i, j)*fy_ad(i, j))
            temp_ad1 = c(i, j)**2*fy_ad(i, j)/6.0
            q_ad(i, j) = q_ad(i, j) + temp_ad1 + temp_ad0 + 2.0*temp_ad
            q_ad(i, j-1) = q_ad(i, j-1) + 5.0*temp_ad - temp_ad0 - 2.0*&
&             temp_ad1
            q_ad(i, j-2) = q_ad(i, j-2) + temp_ad1 - temp_ad
            c_ad(i, j) = c_ad(i, j) + ((q(i, j)-2.0*q(i, j-1)+q(i, j-2))&
&             *2*c(i, j)/6.0-0.5*(q(i, j)-q(i, j-1)))*fy_ad(i, j)
            fy_ad(i, j) = 0.0_FVPRC
          END IF
        END DO
      END DO
    ELSE IF (jord .EQ. 2) THEN
      DO j=jfirst-2,jlast+2
        DO i=ifirst,ilast
          dm(i, j) = 0.25*(q(i, j+1)-q(i, j-1))
          IF (dm(i, j) .GE. 0.) THEN
            x2 = dm(i, j)
            CALL PUSHCONTROL1B(0)
          ELSE
            x2 = -dm(i, j)
            CALL PUSHCONTROL1B(1)
          END IF
          IF (q(i, j-1) .LT. q(i, j)) THEN
            IF (q(i, j) .LT. q(i, j+1)) THEN
              max1 = q(i, j+1)
              CALL PUSHCONTROL2B(0)
            ELSE
              max1 = q(i, j)
              CALL PUSHCONTROL2B(1)
            END IF
          ELSE IF (q(i, j-1) .LT. q(i, j+1)) THEN
            max1 = q(i, j+1)
            CALL PUSHCONTROL2B(2)
          ELSE
            max1 = q(i, j-1)
            CALL PUSHCONTROL2B(3)
          END IF
          y1 = max1 - q(i, j)
          IF (q(i, j-1) .GT. q(i, j)) THEN
            IF (q(i, j) .GT. q(i, j+1)) THEN
              min6 = q(i, j+1)
              CALL PUSHCONTROL2B(0)
            ELSE
              min6 = q(i, j)
              CALL PUSHCONTROL2B(1)
            END IF
          ELSE IF (q(i, j-1) .GT. q(i, j+1)) THEN
            min6 = q(i, j+1)
            CALL PUSHCONTROL2B(2)
          ELSE
            min6 = q(i, j-1)
            CALL PUSHCONTROL2B(3)
          END IF
          z1 = q(i, j) - min6
          IF (x2 .GT. y1) THEN
            IF (y1 .GT. z1) THEN
              CALL PUSHREALARRAY_ADM(min1)
              min1 = z1
              CALL PUSHCONTROL2B(0)
            ELSE
              CALL PUSHREALARRAY_ADM(min1)
              min1 = y1
              CALL PUSHCONTROL2B(1)
            END IF
          ELSE IF (x2 .GT. z1) THEN
            CALL PUSHREALARRAY_ADM(min1)
            min1 = z1
            CALL PUSHCONTROL2B(2)
          ELSE
            CALL PUSHREALARRAY_ADM(min1)
            min1 = x2
            CALL PUSHCONTROL2B(3)
          END IF
          CALL PUSHREALARRAY_ADM(dm(i, j))
          dm(i, j) = SIGN(min1, dm(i, j))
        END DO
      END DO
!--------------
! Fix the edges:
!--------------
      IF (grid_type .LT. 3 .AND. (.NOT.nested)) THEN
        IF (js .EQ. 1) THEN
          DO i=ifirst,ilast
!            x0 = 0.5*(3.0*(q(i,0)+q(i,1))   &
!               - (q(i,-1)+q(i,2))) / ( 2.0 )
!            x0 = 0.5*((2.*dya(i,1)+dya(i,2))*(q(i,0)+q(i,1))   &
!               -dya(i,1)*(q(i,-1)+q(i,2))) / ( dya(i,1)+dya(i,2) )
            x0l = 0.5*((2.*dya(i, 0)+dya(i, -1))*q(i, 0)-dya(i, 0)*q(i, &
&             -1))/(dya(i, 0)+dya(i, -1))
            x0r = 0.5*((2.*dya(i, 1)+dya(i, 2))*q(i, 1)-dya(i, 1)*q(i, 2&
&             ))/(dya(i, 1)+dya(i, 2))
            x1 = s15*q(i, 1) + s11*q(i, 2) - s14*dm(i, 2)
            dm(i, 1) = 0.5*(x1-x0l-x0r)
            IF (dm(i, 1) .GE. 0.) THEN
              x3 = dm(i, 1)
              CALL PUSHCONTROL1B(0)
            ELSE
              x3 = -dm(i, 1)
              CALL PUSHCONTROL1B(1)
            END IF
            IF (q(i, 1) .LT. x0l + x0r) THEN
              IF (x0l + x0r .LT. x1) THEN
                max2 = x1
                CALL PUSHCONTROL2B(0)
              ELSE
                max2 = x0l + x0r
                CALL PUSHCONTROL2B(1)
              END IF
            ELSE IF (q(i, 1) .LT. x1) THEN
              max2 = x1
              CALL PUSHCONTROL2B(2)
            ELSE
              max2 = q(i, 1)
              CALL PUSHCONTROL2B(3)
            END IF
            y2 = max2 - q(i, 1)
            IF (q(i, 1) .GT. x0l + x0r) THEN
              IF (x0l + x0r .GT. x1) THEN
                min7 = x1
                CALL PUSHCONTROL2B(0)
              ELSE
                min7 = x0l + x0r
                CALL PUSHCONTROL2B(1)
              END IF
            ELSE IF (q(i, 1) .GT. x1) THEN
              min7 = x1
              CALL PUSHCONTROL2B(2)
            ELSE
              min7 = q(i, 1)
              CALL PUSHCONTROL2B(3)
            END IF
            z2 = q(i, 1) - min7
            IF (x3 .GT. y2) THEN
              IF (y2 .GT. z2) THEN
                CALL PUSHREALARRAY_ADM(min2)
                min2 = z2
                CALL PUSHCONTROL2B(0)
              ELSE
                CALL PUSHREALARRAY_ADM(min2)
                min2 = y2
                CALL PUSHCONTROL2B(1)
              END IF
            ELSE IF (x3 .GT. z2) THEN
              CALL PUSHREALARRAY_ADM(min2)
              min2 = z2
              CALL PUSHCONTROL2B(2)
            ELSE
              CALL PUSHREALARRAY_ADM(min2)
              min2 = x3
              CALL PUSHCONTROL2B(3)
            END IF
            CALL PUSHREALARRAY_ADM(dm(i, 1))
            dm(i, 1) = SIGN(min2, dm(i, 1))
!
            x1 = s15*q(i, 0) + s11*q(i, -1) + s14*dm(i, -1)
            CALL PUSHREALARRAY_ADM(dm(i, 0))
            dm(i, 0) = 0.5*(x0l+x0r-x1)
            IF (dm(i, 0) .GE. 0.) THEN
              x4 = dm(i, 0)
              CALL PUSHCONTROL1B(0)
            ELSE
              x4 = -dm(i, 0)
              CALL PUSHCONTROL1B(1)
            END IF
            IF (q(i, 0) .LT. x0l + x0r) THEN
              IF (x0l + x0r .LT. x1) THEN
                max3 = x1
                CALL PUSHCONTROL2B(0)
              ELSE
                max3 = x0l + x0r
                CALL PUSHCONTROL2B(1)
              END IF
            ELSE IF (q(i, 0) .LT. x1) THEN
              max3 = x1
              CALL PUSHCONTROL2B(2)
            ELSE
              max3 = q(i, 0)
              CALL PUSHCONTROL2B(3)
            END IF
            y3 = max3 - q(i, 0)
            IF (q(i, 0) .GT. x0l + x0r) THEN
              IF (x0l + x0r .GT. x1) THEN
                min8 = x1
                CALL PUSHCONTROL2B(0)
              ELSE
                min8 = x0l + x0r
                CALL PUSHCONTROL2B(1)
              END IF
            ELSE IF (q(i, 0) .GT. x1) THEN
              min8 = x1
              CALL PUSHCONTROL2B(2)
            ELSE
              min8 = q(i, 0)
              CALL PUSHCONTROL2B(3)
            END IF
            z3 = q(i, 0) - min8
            IF (x4 .GT. y3) THEN
              IF (y3 .GT. z3) THEN
                CALL PUSHREALARRAY_ADM(min3)
                min3 = z3
                CALL PUSHCONTROL2B(0)
              ELSE
                CALL PUSHREALARRAY_ADM(min3)
                min3 = y3
                CALL PUSHCONTROL2B(1)
              END IF
            ELSE IF (x4 .GT. z3) THEN
              CALL PUSHREALARRAY_ADM(min3)
              min3 = z3
              CALL PUSHCONTROL2B(2)
            ELSE
              CALL PUSHREALARRAY_ADM(min3)
              min3 = x4
              CALL PUSHCONTROL2B(3)
            END IF
            CALL PUSHREALARRAY_ADM(dm(i, 0))
            dm(i, 0) = SIGN(min3, dm(i, 0))
          END DO
          CALL PUSHCONTROL1B(0)
        ELSE
          CALL PUSHCONTROL1B(1)
        END IF
        IF (je + 1 .EQ. npy) THEN
          DO i=ifirst,ilast
!            x0 = 0.5*(3.0*(q(i,npy-1)+q(i,npy))  &
!               - (q(i,npy-2)+q(i,npy+1)))/(2.0)
!            x0 = 0.5*((2.*dya(i,npy-1)+dya(i,npy-2))*(q(i,npy-1)+q(i,npy))  &
!               -dya(i,npy-1)*(q(i,npy-2)+q(i,npy+1)))/(dya(i,npy-1)+dya(i,npy-2))
            x0l = 0.5*((2.*dya(i, npy-1)+dya(i, npy-2))*q(i, npy-1)-dya(&
&             i, npy-1)*q(i, npy-2))/(dya(i, npy-1)+dya(i, npy-2))
            x0r = 0.5*((2.*dya(i, npy)+dya(i, npy+1))*q(i, npy)-dya(i, &
&             npy)*q(i, npy+1))/(dya(i, npy)+dya(i, npy+1))
            x1 = s15*q(i, npy-1) + s11*q(i, npy-2) + s14*dm(i, npy-2)
            CALL PUSHREALARRAY_ADM(dm(i, npy-1))
            dm(i, npy-1) = 0.5*(x0l+x0r-x1)
            IF (dm(i, npy-1) .GE. 0.) THEN
              x5 = dm(i, npy-1)
              CALL PUSHCONTROL1B(0)
            ELSE
              x5 = -dm(i, npy-1)
              CALL PUSHCONTROL1B(1)
            END IF
            IF (q(i, npy-1) .LT. x0l + x0r) THEN
              IF (x0l + x0r .LT. x1) THEN
                max4 = x1
                CALL PUSHCONTROL2B(0)
              ELSE
                max4 = x0l + x0r
                CALL PUSHCONTROL2B(1)
              END IF
            ELSE IF (q(i, npy-1) .LT. x1) THEN
              max4 = x1
              CALL PUSHCONTROL2B(2)
            ELSE
              max4 = q(i, npy-1)
              CALL PUSHCONTROL2B(3)
            END IF
            y4 = max4 - q(i, npy-1)
            IF (q(i, npy-1) .GT. x0l + x0r) THEN
              IF (x0l + x0r .GT. x1) THEN
                min9 = x1
                CALL PUSHCONTROL2B(0)
              ELSE
                min9 = x0l + x0r
                CALL PUSHCONTROL2B(1)
              END IF
            ELSE IF (q(i, npy-1) .GT. x1) THEN
              min9 = x1
              CALL PUSHCONTROL2B(2)
            ELSE
              min9 = q(i, npy-1)
              CALL PUSHCONTROL2B(3)
            END IF
            z4 = q(i, npy-1) - min9
            IF (x5 .GT. y4) THEN
              IF (y4 .GT. z4) THEN
                CALL PUSHREALARRAY_ADM(min4)
                min4 = z4
                CALL PUSHCONTROL2B(0)
              ELSE
                CALL PUSHREALARRAY_ADM(min4)
                min4 = y4
                CALL PUSHCONTROL2B(1)
              END IF
            ELSE IF (x5 .GT. z4) THEN
              CALL PUSHREALARRAY_ADM(min4)
              min4 = z4
              CALL PUSHCONTROL2B(2)
            ELSE
              CALL PUSHREALARRAY_ADM(min4)
              min4 = x5
              CALL PUSHCONTROL2B(3)
            END IF
            CALL PUSHREALARRAY_ADM(dm(i, npy-1))
            dm(i, npy-1) = SIGN(min4, dm(i, npy-1))
!
            x1 = s15*q(i, npy) + s11*q(i, npy+1) - s14*dm(i, npy+1)
            CALL PUSHREALARRAY_ADM(dm(i, npy))
            dm(i, npy) = 0.5*(x1-x0l-x0r)
            IF (dm(i, npy) .GE. 0.) THEN
              x6 = dm(i, npy)
              CALL PUSHCONTROL1B(0)
            ELSE
              x6 = -dm(i, npy)
              CALL PUSHCONTROL1B(1)
            END IF
            IF (q(i, npy) .LT. x0l + x0r) THEN
              IF (x0l + x0r .LT. x1) THEN
                max5 = x1
                CALL PUSHCONTROL2B(0)
              ELSE
                max5 = x0l + x0r
                CALL PUSHCONTROL2B(1)
              END IF
            ELSE IF (q(i, npy) .LT. x1) THEN
              max5 = x1
              CALL PUSHCONTROL2B(2)
            ELSE
              max5 = q(i, npy)
              CALL PUSHCONTROL2B(3)
            END IF
            y5 = max5 - q(i, npy)
            IF (q(i, npy) .GT. x0l + x0r) THEN
              IF (x0l + x0r .GT. x1) THEN
                min10 = x1
                CALL PUSHCONTROL2B(0)
              ELSE
                min10 = x0l + x0r
                CALL PUSHCONTROL2B(1)
              END IF
            ELSE IF (q(i, npy) .GT. x1) THEN
              min10 = x1
              CALL PUSHCONTROL2B(2)
            ELSE
              min10 = q(i, npy)
              CALL PUSHCONTROL2B(3)
            END IF
            z5 = q(i, npy) - min10
            IF (x6 .GT. y5) THEN
              IF (y5 .GT. z5) THEN
                CALL PUSHREALARRAY_ADM(min5)
                min5 = z5
                CALL PUSHCONTROL2B(0)
              ELSE
                CALL PUSHREALARRAY_ADM(min5)
                min5 = y5
                CALL PUSHCONTROL2B(1)
              END IF
            ELSE IF (x6 .GT. z5) THEN
              CALL PUSHREALARRAY_ADM(min5)
              min5 = z5
              CALL PUSHCONTROL2B(2)
            ELSE
              CALL PUSHREALARRAY_ADM(min5)
              min5 = x6
              CALL PUSHCONTROL2B(3)
            END IF
            CALL PUSHREALARRAY_ADM(dm(i, npy))
            dm(i, npy) = SIGN(min5, dm(i, npy))
          END DO
          CALL PUSHCONTROL2B(2)
        ELSE
          CALL PUSHCONTROL2B(1)
        END IF
      ELSE
        CALL PUSHCONTROL2B(0)
      END IF
      DO j=jfirst,jlast+1
        DO i=ifirst,ilast
          IF (c(i, j) .GT. 0.) THEN
            CALL PUSHCONTROL1B(1)
          ELSE
            CALL PUSHCONTROL1B(0)
          END IF
        END DO
      END DO
      dm_ad = 0.0_FVPRC
      DO j=jlast+1,jfirst,-1
        DO i=ilast,ifirst,-1
          CALL POPCONTROL1B(branch)
          IF (branch .EQ. 0) THEN
            q_ad(i, j) = q_ad(i, j) + fy_ad(i, j)
            c_ad(i, j) = c_ad(i, j) - dm(i, j)*fy_ad(i, j)
            dm_ad(i, j) = dm_ad(i, j) - (c(i, j)+1.)*fy_ad(i, j)
            fy_ad(i, j) = 0.0_FVPRC
          ELSE
            q_ad(i, j-1) = q_ad(i, j-1) + fy_ad(i, j)
            c_ad(i, j) = c_ad(i, j) - dm(i, j-1)*fy_ad(i, j)
            dm_ad(i, j-1) = dm_ad(i, j-1) + (1.-c(i, j))*fy_ad(i, j)
            fy_ad(i, j) = 0.0_FVPRC
          END IF
        END DO
      END DO
      CALL POPCONTROL2B(branch)
      IF (branch .NE. 0) THEN
        IF (branch .NE. 1) THEN
          DO i=ilast,ifirst,-1
            CALL POPREALARRAY_ADM(dm(i, npy))
            min5_ad = SIGN(1.d0, min5*dm(i, npy))*dm_ad(i, npy)
            dm_ad(i, npy) = 0.0_FVPRC
            CALL POPCONTROL2B(branch)
            IF (branch .LT. 2) THEN
              IF (branch .EQ. 0) THEN
                CALL POPREALARRAY_ADM(min5)
                z5_ad = min5_ad
                y5_ad = 0.0_FVPRC
              ELSE
                CALL POPREALARRAY_ADM(min5)
                y5_ad = min5_ad
                z5_ad = 0.0_FVPRC
              END IF
              x6_ad = 0.0_FVPRC
            ELSE
              IF (branch .EQ. 2) THEN
                CALL POPREALARRAY_ADM(min5)
                z5_ad = min5_ad
                x6_ad = 0.0_FVPRC
              ELSE
                CALL POPREALARRAY_ADM(min5)
                x6_ad = min5_ad
                z5_ad = 0.0_FVPRC
              END IF
              y5_ad = 0.0_FVPRC
            END IF
            q_ad(i, npy) = q_ad(i, npy) + z5_ad
            min10_ad = -z5_ad
            CALL POPCONTROL2B(branch)
            IF (branch .LT. 2) THEN
              IF (branch .EQ. 0) THEN
                x1_ad = min10_ad
                x0l_ad = 0.0_FVPRC
                x0r_ad = 0.0_FVPRC
              ELSE
                x0l_ad = min10_ad
                x0r_ad = min10_ad
                x1_ad = 0.0_FVPRC
              END IF
            ELSE
              IF (branch .EQ. 2) THEN
                x1_ad = min10_ad
              ELSE
                q_ad(i, npy) = q_ad(i, npy) + min10_ad
                x1_ad = 0.0_FVPRC
              END IF
              x0l_ad = 0.0_FVPRC
              x0r_ad = 0.0_FVPRC
            END IF
            max5_ad = y5_ad
            q_ad(i, npy) = q_ad(i, npy) - y5_ad
            CALL POPCONTROL2B(branch)
            IF (branch .LT. 2) THEN
              IF (branch .EQ. 0) THEN
                x1_ad = x1_ad + max5_ad
              ELSE
                x0l_ad = x0l_ad + max5_ad
                x0r_ad = x0r_ad + max5_ad
              END IF
            ELSE IF (branch .EQ. 2) THEN
              x1_ad = x1_ad + max5_ad
            ELSE
              q_ad(i, npy) = q_ad(i, npy) + max5_ad
            END IF
            CALL POPCONTROL1B(branch)
            IF (branch .EQ. 0) THEN
              dm_ad(i, npy) = dm_ad(i, npy) + x6_ad
            ELSE
              dm_ad(i, npy) = dm_ad(i, npy) - x6_ad
            END IF
            CALL POPREALARRAY_ADM(dm(i, npy))
            temp_ad12 = 0.5*dm_ad(i, npy)
            x1_ad = x1_ad + temp_ad12
            x0l_ad = x0l_ad - temp_ad12
            x0r_ad = x0r_ad - temp_ad12
            dm_ad(i, npy) = 0.0_FVPRC
            q_ad(i, npy) = q_ad(i, npy) + s15*x1_ad
            q_ad(i, npy+1) = q_ad(i, npy+1) + s11*x1_ad
            dm_ad(i, npy+1) = dm_ad(i, npy+1) - s14*x1_ad
            CALL POPREALARRAY_ADM(dm(i, npy-1))
            min4_ad = SIGN(1.d0, min4*dm(i, npy-1))*dm_ad(i, npy-1)
            dm_ad(i, npy-1) = 0.0_FVPRC
            CALL POPCONTROL2B(branch)
            IF (branch .LT. 2) THEN
              IF (branch .EQ. 0) THEN
                CALL POPREALARRAY_ADM(min4)
                z4_ad = min4_ad
                y4_ad = 0.0_FVPRC
              ELSE
                CALL POPREALARRAY_ADM(min4)
                y4_ad = min4_ad
                z4_ad = 0.0_FVPRC
              END IF
              x5_ad = 0.0_FVPRC
            ELSE
              IF (branch .EQ. 2) THEN
                CALL POPREALARRAY_ADM(min4)
                z4_ad = min4_ad
                x5_ad = 0.0_FVPRC
              ELSE
                CALL POPREALARRAY_ADM(min4)
                x5_ad = min4_ad
                z4_ad = 0.0_FVPRC
              END IF
              y4_ad = 0.0_FVPRC
            END IF
            q_ad(i, npy-1) = q_ad(i, npy-1) + z4_ad
            min9_ad = -z4_ad
            CALL POPCONTROL2B(branch)
            IF (branch .LT. 2) THEN
              IF (branch .EQ. 0) THEN
                x1_ad = min9_ad
              ELSE
                x0l_ad = x0l_ad + min9_ad
                x0r_ad = x0r_ad + min9_ad
                x1_ad = 0.0_FVPRC
              END IF
            ELSE IF (branch .EQ. 2) THEN
              x1_ad = min9_ad
            ELSE
              q_ad(i, npy-1) = q_ad(i, npy-1) + min9_ad
              x1_ad = 0.0_FVPRC
            END IF
            max4_ad = y4_ad
            q_ad(i, npy-1) = q_ad(i, npy-1) - y4_ad
            CALL POPCONTROL2B(branch)
            IF (branch .LT. 2) THEN
              IF (branch .EQ. 0) THEN
                x1_ad = x1_ad + max4_ad
              ELSE
                x0l_ad = x0l_ad + max4_ad
                x0r_ad = x0r_ad + max4_ad
              END IF
            ELSE IF (branch .EQ. 2) THEN
              x1_ad = x1_ad + max4_ad
            ELSE
              q_ad(i, npy-1) = q_ad(i, npy-1) + max4_ad
            END IF
            CALL POPCONTROL1B(branch)
            IF (branch .EQ. 0) THEN
              dm_ad(i, npy-1) = dm_ad(i, npy-1) + x5_ad
            ELSE
              dm_ad(i, npy-1) = dm_ad(i, npy-1) - x5_ad
            END IF
            CALL POPREALARRAY_ADM(dm(i, npy-1))
            temp_ad9 = 0.5*dm_ad(i, npy-1)
            x0l_ad = x0l_ad + temp_ad9
            x0r_ad = x0r_ad + temp_ad9
            x1_ad = x1_ad - temp_ad9
            dm_ad(i, npy-1) = 0.0_FVPRC
            q_ad(i, npy-1) = q_ad(i, npy-1) + s15*x1_ad
            q_ad(i, npy-2) = q_ad(i, npy-2) + s11*x1_ad
            dm_ad(i, npy-2) = dm_ad(i, npy-2) + s14*x1_ad
            temp_ad10 = 0.5*x0r_ad/(dya(i, npy)+dya(i, npy+1))
            q_ad(i, npy) = q_ad(i, npy) + (dya(i, npy)*2.+dya(i, npy+1))&
&             *temp_ad10
            q_ad(i, npy+1) = q_ad(i, npy+1) - dya(i, npy)*temp_ad10
            temp_ad11 = 0.5*x0l_ad/(dya(i, npy-1)+dya(i, npy-2))
            q_ad(i, npy-1) = q_ad(i, npy-1) + (dya(i, npy-1)*2.+dya(i, &
&             npy-2))*temp_ad11
            q_ad(i, npy-2) = q_ad(i, npy-2) - dya(i, npy-1)*temp_ad11
          END DO
        END IF
        CALL POPCONTROL1B(branch)
        IF (branch .EQ. 0) THEN
          DO i=ilast,ifirst,-1
            CALL POPREALARRAY_ADM(dm(i, 0))
            min3_ad = SIGN(1.d0, min3*dm(i, 0))*dm_ad(i, 0)
            dm_ad(i, 0) = 0.0_FVPRC
            CALL POPCONTROL2B(branch)
            IF (branch .LT. 2) THEN
              IF (branch .EQ. 0) THEN
                CALL POPREALARRAY_ADM(min3)
                z3_ad = min3_ad
                y3_ad = 0.0_FVPRC
              ELSE
                CALL POPREALARRAY_ADM(min3)
                y3_ad = min3_ad
                z3_ad = 0.0_FVPRC
              END IF
              x4_ad = 0.0_FVPRC
            ELSE
              IF (branch .EQ. 2) THEN
                CALL POPREALARRAY_ADM(min3)
                z3_ad = min3_ad
                x4_ad = 0.0_FVPRC
              ELSE
                CALL POPREALARRAY_ADM(min3)
                x4_ad = min3_ad
                z3_ad = 0.0_FVPRC
              END IF
              y3_ad = 0.0_FVPRC
            END IF
            q_ad(i, 0) = q_ad(i, 0) + z3_ad
            min8_ad = -z3_ad
            CALL POPCONTROL2B(branch)
            IF (branch .LT. 2) THEN
              IF (branch .EQ. 0) THEN
                x1_ad = min8_ad
                x0l_ad = 0.0_FVPRC
                x0r_ad = 0.0_FVPRC
              ELSE
                x0l_ad = min8_ad
                x0r_ad = min8_ad
                x1_ad = 0.0_FVPRC
              END IF
            ELSE
              IF (branch .EQ. 2) THEN
                x1_ad = min8_ad
              ELSE
                q_ad(i, 0) = q_ad(i, 0) + min8_ad
                x1_ad = 0.0_FVPRC
              END IF
              x0l_ad = 0.0_FVPRC
              x0r_ad = 0.0_FVPRC
            END IF
            max3_ad = y3_ad
            q_ad(i, 0) = q_ad(i, 0) - y3_ad
            CALL POPCONTROL2B(branch)
            IF (branch .LT. 2) THEN
              IF (branch .EQ. 0) THEN
                x1_ad = x1_ad + max3_ad
              ELSE
                x0l_ad = x0l_ad + max3_ad
                x0r_ad = x0r_ad + max3_ad
              END IF
            ELSE IF (branch .EQ. 2) THEN
              x1_ad = x1_ad + max3_ad
            ELSE
              q_ad(i, 0) = q_ad(i, 0) + max3_ad
            END IF
            CALL POPCONTROL1B(branch)
            IF (branch .EQ. 0) THEN
              dm_ad(i, 0) = dm_ad(i, 0) + x4_ad
            ELSE
              dm_ad(i, 0) = dm_ad(i, 0) - x4_ad
            END IF
            CALL POPREALARRAY_ADM(dm(i, 0))
            temp_ad8 = 0.5*dm_ad(i, 0)
            x0l_ad = x0l_ad + temp_ad8
            x0r_ad = x0r_ad + temp_ad8
            x1_ad = x1_ad - temp_ad8
            dm_ad(i, 0) = 0.0_FVPRC
            q_ad(i, 0) = q_ad(i, 0) + s15*x1_ad
            q_ad(i, -1) = q_ad(i, -1) + s11*x1_ad
            dm_ad(i, -1) = dm_ad(i, -1) + s14*x1_ad
            CALL POPREALARRAY_ADM(dm(i, 1))
            min2_ad = SIGN(1.d0, min2*dm(i, 1))*dm_ad(i, 1)
            dm_ad(i, 1) = 0.0_FVPRC
            CALL POPCONTROL2B(branch)
            IF (branch .LT. 2) THEN
              IF (branch .EQ. 0) THEN
                CALL POPREALARRAY_ADM(min2)
                z2_ad = min2_ad
                y2_ad = 0.0_FVPRC
              ELSE
                CALL POPREALARRAY_ADM(min2)
                y2_ad = min2_ad
                z2_ad = 0.0_FVPRC
              END IF
              x3_ad = 0.0_FVPRC
            ELSE
              IF (branch .EQ. 2) THEN
                CALL POPREALARRAY_ADM(min2)
                z2_ad = min2_ad
                x3_ad = 0.0_FVPRC
              ELSE
                CALL POPREALARRAY_ADM(min2)
                x3_ad = min2_ad
                z2_ad = 0.0_FVPRC
              END IF
              y2_ad = 0.0_FVPRC
            END IF
            q_ad(i, 1) = q_ad(i, 1) + z2_ad
            min7_ad = -z2_ad
            CALL POPCONTROL2B(branch)
            IF (branch .LT. 2) THEN
              IF (branch .EQ. 0) THEN
                x1_ad = min7_ad
              ELSE
                x0l_ad = x0l_ad + min7_ad
                x0r_ad = x0r_ad + min7_ad
                x1_ad = 0.0_FVPRC
              END IF
            ELSE IF (branch .EQ. 2) THEN
              x1_ad = min7_ad
            ELSE
              q_ad(i, 1) = q_ad(i, 1) + min7_ad
              x1_ad = 0.0_FVPRC
            END IF
            max2_ad = y2_ad
            q_ad(i, 1) = q_ad(i, 1) - y2_ad
            CALL POPCONTROL2B(branch)
            IF (branch .LT. 2) THEN
              IF (branch .EQ. 0) THEN
                x1_ad = x1_ad + max2_ad
              ELSE
                x0l_ad = x0l_ad + max2_ad
                x0r_ad = x0r_ad + max2_ad
              END IF
            ELSE IF (branch .EQ. 2) THEN
              x1_ad = x1_ad + max2_ad
            ELSE
              q_ad(i, 1) = q_ad(i, 1) + max2_ad
            END IF
            CALL POPCONTROL1B(branch)
            IF (branch .EQ. 0) THEN
              dm_ad(i, 1) = dm_ad(i, 1) + x3_ad
            ELSE
              dm_ad(i, 1) = dm_ad(i, 1) - x3_ad
            END IF
            temp_ad5 = 0.5*dm_ad(i, 1)
            x1_ad = x1_ad + temp_ad5
            x0l_ad = x0l_ad - temp_ad5
            x0r_ad = x0r_ad - temp_ad5
            dm_ad(i, 1) = 0.0_FVPRC
            q_ad(i, 1) = q_ad(i, 1) + s15*x1_ad
            q_ad(i, 2) = q_ad(i, 2) + s11*x1_ad
            dm_ad(i, 2) = dm_ad(i, 2) - s14*x1_ad
            temp_ad6 = 0.5*x0r_ad/(dya(i, 1)+dya(i, 2))
            q_ad(i, 1) = q_ad(i, 1) + (dya(i, 1)*2.+dya(i, 2))*temp_ad6
            q_ad(i, 2) = q_ad(i, 2) - dya(i, 1)*temp_ad6
            temp_ad7 = 0.5*x0l_ad/(dya(i, 0)+dya(i, -1))
            q_ad(i, 0) = q_ad(i, 0) + (dya(i, 0)*2.+dya(i, -1))*temp_ad7
            q_ad(i, -1) = q_ad(i, -1) - dya(i, 0)*temp_ad7
          END DO
        END IF
      END IF
      DO j=jlast+2,jfirst-2,-1
        DO i=ilast,ifirst,-1
          CALL POPREALARRAY_ADM(dm(i, j))
          min1_ad = SIGN(1.d0, min1*dm(i, j))*dm_ad(i, j)
          dm_ad(i, j) = 0.0_FVPRC
          CALL POPCONTROL2B(branch)
          IF (branch .LT. 2) THEN
            IF (branch .EQ. 0) THEN
              CALL POPREALARRAY_ADM(min1)
              z1_ad = min1_ad
              y1_ad = 0.0_FVPRC
            ELSE
              CALL POPREALARRAY_ADM(min1)
              y1_ad = min1_ad
              z1_ad = 0.0_FVPRC
            END IF
            x2_ad = 0.0_FVPRC
          ELSE
            IF (branch .EQ. 2) THEN
              CALL POPREALARRAY_ADM(min1)
              z1_ad = min1_ad
              x2_ad = 0.0_FVPRC
            ELSE
              CALL POPREALARRAY_ADM(min1)
              x2_ad = min1_ad
              z1_ad = 0.0_FVPRC
            END IF
            y1_ad = 0.0_FVPRC
          END IF
          q_ad(i, j) = q_ad(i, j) + z1_ad
          min6_ad = -z1_ad
          CALL POPCONTROL2B(branch)
          IF (branch .LT. 2) THEN
            IF (branch .EQ. 0) THEN
              q_ad(i, j+1) = q_ad(i, j+1) + min6_ad
            ELSE
              q_ad(i, j) = q_ad(i, j) + min6_ad
            END IF
          ELSE IF (branch .EQ. 2) THEN
            q_ad(i, j+1) = q_ad(i, j+1) + min6_ad
          ELSE
            q_ad(i, j-1) = q_ad(i, j-1) + min6_ad
          END IF
          max1_ad = y1_ad
          q_ad(i, j) = q_ad(i, j) - y1_ad
          CALL POPCONTROL2B(branch)
          IF (branch .LT. 2) THEN
            IF (branch .EQ. 0) THEN
              q_ad(i, j+1) = q_ad(i, j+1) + max1_ad
            ELSE
              q_ad(i, j) = q_ad(i, j) + max1_ad
            END IF
          ELSE IF (branch .EQ. 2) THEN
            q_ad(i, j+1) = q_ad(i, j+1) + max1_ad
          ELSE
            q_ad(i, j-1) = q_ad(i, j-1) + max1_ad
          END IF
          CALL POPCONTROL1B(branch)
          IF (branch .EQ. 0) THEN
            dm_ad(i, j) = dm_ad(i, j) + x2_ad
          ELSE
            dm_ad(i, j) = dm_ad(i, j) - x2_ad
          END IF
          q_ad(i, j+1) = q_ad(i, j+1) + 0.25*dm_ad(i, j)
          q_ad(i, j-1) = q_ad(i, j-1) - 0.25*dm_ad(i, j)
          dm_ad(i, j) = 0.0_FVPRC
        END DO
      END DO
    ELSE
      CALL FYPPM_ADM(c, c_ad, q, q_ad, fy, fy_ad, jord, ifirst, ilast, &
&              jfirst, jlast, npx, npy, dm, dm_ad, bd, dya, nested, &
&              grid_type)
    END IF
  END SUBROUTINE YTP_ADM
  SUBROUTINE YTP(fy, q, c, jord, ifirst, ilast, jfirst, jlast, npx, npy&
&   , bd, dya, nested, grid_type)
    IMPLICIT NONE
    TYPE(FV_GRID_BOUNDS_TYPE), INTENT(IN) :: bd
    INTEGER, INTENT(IN) :: npx, npy
!  X-Dir strip
    INTEGER, INTENT(IN) :: ifirst, ilast
!  Y-Dir strip
    INTEGER, INTENT(IN) :: jfirst, jlast
    INTEGER, INTENT(IN) :: jord
    REAL(fvprc), INTENT(IN) :: q(ifirst:ilast, jfirst-ng:jlast+ng)
! Courant number
    REAL(fvprc), INTENT(IN) :: c(bd%isd:bd%ied, bd%js:bd%je+1)
!  Flux
    REAL(fvprc), INTENT(OUT) :: fy(ifirst:ilast, jfirst:jlast+1)
    REAL(fvprc), INTENT(IN) :: dya(bd%isd:bd%ied, bd%jsd:bd%jed)
    LOGICAL, INTENT(IN) :: nested
    INTEGER, INTENT(IN) :: grid_type
! !LOCAL VARIABLES:
    REAL(fvprc) :: dm(ifirst:ilast, jfirst-2:jlast+2)
    REAL(fvprc) :: x0l, x0r, x1
    INTEGER :: i, j
    INTEGER :: is, ie, js, je, isd, ied, jsd, jed
    INTRINSIC ABS
    INTRINSIC MAX
    INTRINSIC MIN
    INTRINSIC SIGN
    REAL(fvprc) :: min1
    REAL(fvprc) :: min2
    REAL(fvprc) :: min3
    REAL(fvprc) :: min4
    REAL(fvprc) :: min5
    REAL(fvprc) :: max1
    REAL(fvprc) :: min6
    REAL(fvprc) :: max2
    REAL(fvprc) :: min7
    REAL(fvprc) :: max3
    REAL(fvprc) :: min8
    REAL(fvprc) :: max4
    REAL(fvprc) :: min9
    REAL(fvprc) :: max5
    REAL(fvprc) :: min10
    REAL(fvprc) :: x6
    REAL(fvprc) :: x5
    REAL(fvprc) :: x4
    REAL(fvprc) :: x3
    REAL(fvprc) :: x2
    REAL(fvprc) :: z5
    REAL(fvprc) :: z4
    REAL(fvprc) :: z3
    REAL(fvprc) :: z2
    REAL(fvprc) :: z1
    REAL(fvprc) :: y5
    REAL(fvprc) :: y4
    REAL(fvprc) :: y3
    REAL(fvprc) :: y2
    REAL(fvprc) :: y1
    is = bd%is
    ie = bd%ie
    js = bd%js
    je = bd%je
    isd = bd%isd
    ied = bd%ied
    jsd = bd%jsd
    jed = bd%jed
    IF (jord .EQ. 1) THEN
      DO j=jfirst,jlast+1
        DO i=ifirst,ilast
          IF (c(i, j) .GT. 0.) THEN
            fy(i, j) = q(i, j-1)
          ELSE
            fy(i, j) = q(i, j)
          END IF
        END DO
      END DO
    ELSE IF (jord .EQ. 333) THEN
!Advected using third order scheme
      DO j=jfirst,jlast+1
        DO i=ifirst,ilast
          IF (c(i, j) .GT. 0.) THEN
            fy(i, j) = (2.0*q(i, j)+5.0*q(i, j-1)-q(i, j-2))/6.0 - 0.5*c&
&             (i, j)*(q(i, j)-q(i, j-1)) + c(i, j)*c(i, j)/6.0*(q(i, j)-&
&             2.0*q(i, j-1)+q(i, j-2))
          ELSE
            fy(i, j) = (2.0*q(i, j-1)+5.0*q(i, j)-q(i, j+1))/6.0 - 0.5*c&
&             (i, j)*(q(i, j)-q(i, j-1)) + c(i, j)*c(i, j)/6.0*(q(i, j+1&
&             )-2.0*q(i, j)+q(i, j-1))
          END IF
        END DO
      END DO
    ELSE IF (jord .EQ. 2) THEN
      DO j=jfirst-2,jlast+2
        DO i=ifirst,ilast
          dm(i, j) = 0.25*(q(i, j+1)-q(i, j-1))
          IF (dm(i, j) .GE. 0.) THEN
            x2 = dm(i, j)
          ELSE
            x2 = -dm(i, j)
          END IF
          IF (q(i, j-1) .LT. q(i, j)) THEN
            IF (q(i, j) .LT. q(i, j+1)) THEN
              max1 = q(i, j+1)
            ELSE
              max1 = q(i, j)
            END IF
          ELSE IF (q(i, j-1) .LT. q(i, j+1)) THEN
            max1 = q(i, j+1)
          ELSE
            max1 = q(i, j-1)
          END IF
          y1 = max1 - q(i, j)
          IF (q(i, j-1) .GT. q(i, j)) THEN
            IF (q(i, j) .GT. q(i, j+1)) THEN
              min6 = q(i, j+1)
            ELSE
              min6 = q(i, j)
            END IF
          ELSE IF (q(i, j-1) .GT. q(i, j+1)) THEN
            min6 = q(i, j+1)
          ELSE
            min6 = q(i, j-1)
          END IF
          z1 = q(i, j) - min6
          IF (x2 .GT. y1) THEN
            IF (y1 .GT. z1) THEN
              min1 = z1
            ELSE
              min1 = y1
            END IF
          ELSE IF (x2 .GT. z1) THEN
            min1 = z1
          ELSE
            min1 = x2
          END IF
          dm(i, j) = SIGN(min1, dm(i, j))
        END DO
      END DO
!--------------
! Fix the edges:
!--------------
      IF (grid_type .LT. 3 .AND. (.NOT.nested)) THEN
        IF (js .EQ. 1) THEN
          DO i=ifirst,ilast
!            x0 = 0.5*(3.0*(q(i,0)+q(i,1))   &
!               - (q(i,-1)+q(i,2))) / ( 2.0 )
!            x0 = 0.5*((2.*dya(i,1)+dya(i,2))*(q(i,0)+q(i,1))   &
!               -dya(i,1)*(q(i,-1)+q(i,2))) / ( dya(i,1)+dya(i,2) )
            x0l = 0.5*((2.*dya(i, 0)+dya(i, -1))*q(i, 0)-dya(i, 0)*q(i, &
&             -1))/(dya(i, 0)+dya(i, -1))
            x0r = 0.5*((2.*dya(i, 1)+dya(i, 2))*q(i, 1)-dya(i, 1)*q(i, 2&
&             ))/(dya(i, 1)+dya(i, 2))
            x1 = s15*q(i, 1) + s11*q(i, 2) - s14*dm(i, 2)
            dm(i, 1) = 0.5*(x1-x0l-x0r)
            IF (dm(i, 1) .GE. 0.) THEN
              x3 = dm(i, 1)
            ELSE
              x3 = -dm(i, 1)
            END IF
            IF (q(i, 1) .LT. x0l + x0r) THEN
              IF (x0l + x0r .LT. x1) THEN
                max2 = x1
              ELSE
                max2 = x0l + x0r
              END IF
            ELSE IF (q(i, 1) .LT. x1) THEN
              max2 = x1
            ELSE
              max2 = q(i, 1)
            END IF
            y2 = max2 - q(i, 1)
            IF (q(i, 1) .GT. x0l + x0r) THEN
              IF (x0l + x0r .GT. x1) THEN
                min7 = x1
              ELSE
                min7 = x0l + x0r
              END IF
            ELSE IF (q(i, 1) .GT. x1) THEN
              min7 = x1
            ELSE
              min7 = q(i, 1)
            END IF
            z2 = q(i, 1) - min7
            IF (x3 .GT. y2) THEN
              IF (y2 .GT. z2) THEN
                min2 = z2
              ELSE
                min2 = y2
              END IF
            ELSE IF (x3 .GT. z2) THEN
              min2 = z2
            ELSE
              min2 = x3
            END IF
            dm(i, 1) = SIGN(min2, dm(i, 1))
!
            x1 = s15*q(i, 0) + s11*q(i, -1) + s14*dm(i, -1)
            dm(i, 0) = 0.5*(x0l+x0r-x1)
            IF (dm(i, 0) .GE. 0.) THEN
              x4 = dm(i, 0)
            ELSE
              x4 = -dm(i, 0)
            END IF
            IF (q(i, 0) .LT. x0l + x0r) THEN
              IF (x0l + x0r .LT. x1) THEN
                max3 = x1
              ELSE
                max3 = x0l + x0r
              END IF
            ELSE IF (q(i, 0) .LT. x1) THEN
              max3 = x1
            ELSE
              max3 = q(i, 0)
            END IF
            y3 = max3 - q(i, 0)
            IF (q(i, 0) .GT. x0l + x0r) THEN
              IF (x0l + x0r .GT. x1) THEN
                min8 = x1
              ELSE
                min8 = x0l + x0r
              END IF
            ELSE IF (q(i, 0) .GT. x1) THEN
              min8 = x1
            ELSE
              min8 = q(i, 0)
            END IF
            z3 = q(i, 0) - min8
            IF (x4 .GT. y3) THEN
              IF (y3 .GT. z3) THEN
                min3 = z3
              ELSE
                min3 = y3
              END IF
            ELSE IF (x4 .GT. z3) THEN
              min3 = z3
            ELSE
              min3 = x4
            END IF
            dm(i, 0) = SIGN(min3, dm(i, 0))
          END DO
        END IF
        IF (je + 1 .EQ. npy) THEN
          DO i=ifirst,ilast
!            x0 = 0.5*(3.0*(q(i,npy-1)+q(i,npy))  &
!               - (q(i,npy-2)+q(i,npy+1)))/(2.0)
!            x0 = 0.5*((2.*dya(i,npy-1)+dya(i,npy-2))*(q(i,npy-1)+q(i,npy))  &
!               -dya(i,npy-1)*(q(i,npy-2)+q(i,npy+1)))/(dya(i,npy-1)+dya(i,npy-2))
            x0l = 0.5*((2.*dya(i, npy-1)+dya(i, npy-2))*q(i, npy-1)-dya(&
&             i, npy-1)*q(i, npy-2))/(dya(i, npy-1)+dya(i, npy-2))
            x0r = 0.5*((2.*dya(i, npy)+dya(i, npy+1))*q(i, npy)-dya(i, &
&             npy)*q(i, npy+1))/(dya(i, npy)+dya(i, npy+1))
            x1 = s15*q(i, npy-1) + s11*q(i, npy-2) + s14*dm(i, npy-2)
            dm(i, npy-1) = 0.5*(x0l+x0r-x1)
            IF (dm(i, npy-1) .GE. 0.) THEN
              x5 = dm(i, npy-1)
            ELSE
              x5 = -dm(i, npy-1)
            END IF
            IF (q(i, npy-1) .LT. x0l + x0r) THEN
              IF (x0l + x0r .LT. x1) THEN
                max4 = x1
              ELSE
                max4 = x0l + x0r
              END IF
            ELSE IF (q(i, npy-1) .LT. x1) THEN
              max4 = x1
            ELSE
              max4 = q(i, npy-1)
            END IF
            y4 = max4 - q(i, npy-1)
            IF (q(i, npy-1) .GT. x0l + x0r) THEN
              IF (x0l + x0r .GT. x1) THEN
                min9 = x1
              ELSE
                min9 = x0l + x0r
              END IF
            ELSE IF (q(i, npy-1) .GT. x1) THEN
              min9 = x1
            ELSE
              min9 = q(i, npy-1)
            END IF
            z4 = q(i, npy-1) - min9
            IF (x5 .GT. y4) THEN
              IF (y4 .GT. z4) THEN
                min4 = z4
              ELSE
                min4 = y4
              END IF
            ELSE IF (x5 .GT. z4) THEN
              min4 = z4
            ELSE
              min4 = x5
            END IF
            dm(i, npy-1) = SIGN(min4, dm(i, npy-1))
!
            x1 = s15*q(i, npy) + s11*q(i, npy+1) - s14*dm(i, npy+1)
            dm(i, npy) = 0.5*(x1-x0l-x0r)
            IF (dm(i, npy) .GE. 0.) THEN
              x6 = dm(i, npy)
            ELSE
              x6 = -dm(i, npy)
            END IF
            IF (q(i, npy) .LT. x0l + x0r) THEN
              IF (x0l + x0r .LT. x1) THEN
                max5 = x1
              ELSE
                max5 = x0l + x0r
              END IF
            ELSE IF (q(i, npy) .LT. x1) THEN
              max5 = x1
            ELSE
              max5 = q(i, npy)
            END IF
            y5 = max5 - q(i, npy)
            IF (q(i, npy) .GT. x0l + x0r) THEN
              IF (x0l + x0r .GT. x1) THEN
                min10 = x1
              ELSE
                min10 = x0l + x0r
              END IF
            ELSE IF (q(i, npy) .GT. x1) THEN
              min10 = x1
            ELSE
              min10 = q(i, npy)
            END IF
            z5 = q(i, npy) - min10
            IF (x6 .GT. y5) THEN
              IF (y5 .GT. z5) THEN
                min5 = z5
              ELSE
                min5 = y5
              END IF
            ELSE IF (x6 .GT. z5) THEN
              min5 = z5
            ELSE
              min5 = x6
            END IF
            dm(i, npy) = SIGN(min5, dm(i, npy))
          END DO
        END IF
      END IF
      DO j=jfirst,jlast+1
        DO i=ifirst,ilast
          IF (c(i, j) .GT. 0.) THEN
            fy(i, j) = q(i, j-1) + (1.-c(i, j))*dm(i, j-1)
          ELSE
            fy(i, j) = q(i, j) - (1.+c(i, j))*dm(i, j)
          END IF
        END DO
      END DO
    ELSE
      CALL FYPPM(c, q, fy, jord, ifirst, ilast, jfirst, jlast, npx, npy&
&          , dm, bd, dya, nested, grid_type)
    END IF
  END SUBROUTINE YTP
!  Differentiation of xppm0 in reverse (adjoint) mode (with options r8 split(a2b_edge_mod.a2b_ord2 a2b_edge_mod.a2b_ord4 a2b_e
!dge_mod.extrap_corner  dyn_core_mod.dyn_core dyn_core_mod.pk3_halo dyn_core_mod.pln_halo dyn_core_mod.pe_halo dyn_core_mod.ad
!v_pe dyn_core_mod.p_grad_c dyn_core_mod.nh_p_grad dyn_core_mod.split_p_grad dyn_core_mod.one_grad_p dyn_core_mod.grad1_p_update 
!dyn_core_mod.mix_dp dyn_core_mod.geopk dyn_core_mod.del2_cubed fv_dynamics_mod.fv_dynamics fv_dynamics_mod.rayleigh_super fv_dyn
!amics_mod.rayleigh_friction fv_dynamics_mod.compute_aam fv_dynamics_mod.geos_to_fv3 fv_grid_utils_mod.cubed_to_latlon fv_grid_ut
!ils_mod.c2l_ord4 fv_grid_utils_mod.c2l_ord2 fv_mapz_mod.lagrangian_to_eulerian fv_mapz_mod.compute_total_energy fv_mapz_mod.pkez
! fv_mapz_mod.remap_z fv_mapz_mod.map_scalar fv_mapz_mod.map1_ppm fv_mapz_mod.mapn_tracer fv_mapz_mod.map1_q2 fv_m
!apz_mod.map1_cubic fv_mapz_mod.scalar_profile_linear fv_mapz_mod.cs_profile_linear fv_mapz_mod.steepz fv_tracer2d_mod.trac
!er_2d fv_tracer2d_mod.tracer_2d_nested nh_core_mod.update_dz_c nh_core_mod.update_dz_d nh_core_mod.riem_solver_c nh_core_mod.rie
!m_solver3 nh_core_mod.rim_2d nh_core_mod.sim3_solver nh_core_mod.sim3p0_solver nh_core_mod.sim1_solver nh_core_mod.sim_solver nh
!_core_mod.edge_profile sw_core_mod.c_sw sw_core_mod.d_sw sw_core_mod.divergence_corner sw_core_mod.divergence_corner_nest sw_cor
!e_mod.d2a2c_vect sw_core_mod.edge_interpolate4 sw_core_mod.fill2_4corners sw_core_mod.fill_4corners sw_core_mod.compute_div_damp
!ing_fb sw_core_mod.smag_corner sw_core_mod.ytp_v sw_core_mod.xtp_u tp_core_mod.fv_tp_2d tp_core_mod.copy_corners 
!tp_core_mod.xtp tp_core_mod.ytp tp_core_mod.xppm0 tp_core_mod.yppm0 tp_core_mod.fxppm tp_core_mod.fyppm tp_cor
!e_mod.deln_flux)):
!   gradient     of useful results: q flux c
!   with respect to varying inputs: q flux c
!#ifdef XPPM_2D
! subroutine xppm0(flux, q, c, iord, ifirst, ilast, jfirst, jlast, npx, npy, bd, dxa, nested, grid_type)
! type(fv_grid_bounds_type), intent(IN) :: bd
! integer, INTENT(IN) :: ifirst, ilast               !  X-Dir strip
! integer, INTENT(IN) :: jfirst, jlast               !  Y-Dir strip
! integer, INTENT(IN) :: iord
! integer, INTENT(IN) :: npx, npy
! real(FVPRC)   , INTENT(IN) :: q(ifirst-ng:ilast+ng,jfirst:jlast)
! real(FVPRC)   , INTENT(IN) :: c(ifirst   :ilast+1 ,jfirst:jlast) ! Courant   N (like FLUX)
! real(FVPRC)   , intent(IN) :: dxa(bd%isd:bd%ied,bd%jsd:bd%jed)
! logical, intent(IN) :: nested
! integer, intent(IN) :: grid_type
!! !OUTPUT PARAMETERS:
! real(FVPRC)  , INTENT(OUT) :: flux(ifirst:ilast+1,jfirst:jlast) !  Flux
!! Local
! real(FVPRC), dimension(3*jfirst:3*jlast+2) :: q_tmp, bl_tmp, br_tmp
! real(FVPRC), dimension(ifirst-1:ilast+1,jfirst:jlast):: bl, br
! real(FVPRC)  al(ifirst-1:ilast+2,jfirst:jlast)
! real(FVPRC)  dm(ifirst-2:ilast+2,jfirst:jlast)
! real(FVPRC)  dq(ifirst-3:ilast+2,jfirst:jlast)
! logical extm(ifirst-2:ilast+2,jfirst:jlast)
! integer i, j, ie3, is1, ie1
! real(FVPRC) xt, pmp_1, lac_1, pmp_2, lac_2
!
! if ( .not. nested .and. grid_type<3 ) then
!    is1 = max(3,is-1);  ie3 = min(npx-2,ie+2)
!                        ie1 = min(npx-3,ie+1)
! else
!    is1 = is-1;         ie3 = ie+2
!                        ie1 = ie+1
! end if
!
! if ( abs(iord) < 8 ) then
!
!    ! ord = -5: linear scheme based on PPM 4th order interpolation
!    ! ord = -6: linear PPM with 2-delta filter
!    ! ord = -7: (-6) with additional Positive definite constraint:
!
!    do j=jfirst,jlast
!       do i=is1, ie3
!          al(i,j) = p1*(q(i-1,j)+q(i,j)) + p2*(q(i-2,j)+q(i+1,j))
!       enddo
!    enddo
!    if ( .not. nested .and. grid_type<3 ) then
!       if ( is==1 ) then
!          do j=jfirst,jlast
!             al(0,j) = c1*q(-2,j) + c2*q(-1,j) + c3*q(0,j)
!             al(1,j) = 0.5*(((2.*dxa(0,j)+dxa(-1,j))*q(0,j)-dxa(0,j)*q(-1,j))/(dxa(-1,j)+dxa(0,j)) &
!                  +      ((2.*dxa(1,j)+dxa( 2,j))*q(1,j)-dxa(1,j)*q(2,j))/(dxa(1, j)+dxa(2,j)))
!             al(2,j) = c3*q(1,j) + c2*q(2,j) +c1*q(3,j)
!          enddo
!          if(iord==-7) then
!             do j=jfirst,jlast
!                al(0,j) = max(0., al(0,j))
!                al(1,j) = max(0., al(1,j))
!                al(2,j) = max(0., al(2,j))
!             enddo
!          endif
!       endif
!       if ( (ie+1)==npx ) then
!          do j=jfirst,jlast
!             al(npx-1,j) = c1*q(npx-3,j) + c2*q(npx-2,j) + c3*q(npx-1,j)
!             al(npx,j) = 0.5*(((2.*dxa(npx-1,j)+dxa(npx-2,j))*q(npx-1,j)-dxa(npx-1,j)*q(npx-2,j))/(dxa(npx-2,j)+dxa(npx-1,j)) &
!                  +      ((2.*dxa(npx,  j)+dxa(npx+1,j))*q(npx,j)-dxa(npx,  j)*q(npx+1,j))/(dxa(npx,  j)+dxa(npx+1,j)))
!             al(npx+1,j) = c3*q(npx,j) + c2*q(npx+1,j) + c1*q(npx+2,j)
!          enddo
!          if(iord==-7) then
!             do j=jfirst,jlast
!                al(npx-1,j) = max(0., al(npx-1,j))
!                al(npx,  j) = max(0., al(npx  ,j))
!                al(npx+1,j) = max(0., al(npx+1,j))
!             enddo
!          endif
!       endif
!    endif
!
!    if ( iord==-5 ) then
!       do j=jfirst,jlast
!          do i=ifirst-1,ilast+1
!             bl(i,j) = al(i,j)   - q(i,j)
!             br(i,j) = al(i+1,j) - q(i,j)
!          enddo
!       enddo
!    else
!       do j=jfirst,jlast
!          do i=ifirst-3,ilast+2
!             dq(i,j) = q(i+1,j) - q(i,j)
!          enddo
!       enddo
!       do j=jfirst,jlast
!          do i=ifirst-2, ilast+2
!             if ( dq(i-1,j)*dq(i,j) > 0. ) then
!                extm(i,j) = .false.
!             else
!                extm(i,j) = .true.
!             endif
!          enddo
!       enddo
!       do j=jfirst,jlast
!          do i=ifirst-1,ilast+1
!             if ( extm(i-1,j).and.extm(i,j).and.extm(i+1,j) ) then
!                bl(i,j) = 0.
!                br(i,j) = 0.
!             else
!                bl(i,j) = al(i,j)   - q(i,j)
!                br(i,j) = al(i+1,j) - q(i,j)
!             endif
!          enddo
!       enddo
!       ! Additional positive definite constraint:
!       if(iord==-7) call pert_ppm(ilast-ifirst+3, q(ifirst-1,j), bl(ifirst-1,j), br(ifirst-1,j), 0)
!    endif
! else
!
!! Monotonic constraints:
!! ord = 8: PPM with Lin's PPM fast monotone constraint
!! ord = 10: PPM with Lin's modification of Huynh 2nd constraint
!! ord = 13: 10 plus positive definite constraint
!    do j=jfirst,jlast
!!DEC$ VECTOR ALWAYS
!       do i=is-2,ie+2
!          xt = 0.25*(q(i+1,j) - q(i-1,j))
!          dm(i,j) = sign(min(abs(xt), max(q(i-1,j), q(i,j), q(i+1,j)) - q(i,j),  &
!               q(i,j) - min(q(i-1,j), q(i,j), q(i+1,j))), xt)
!       enddo
!    enddo
!    do j=jfirst,jlast
!!DEC$ VECTOR ALWAYS
!       do i=is1,ie1+1
!          al(i,j) = 0.5*(q(i-1,j)+q(i,j)) + r3*(dm(i-1,j)-dm(i,j))
!       enddo
!    enddo
!    if ( iord==-8 ) then
!       do j=jfirst,jlast
!!DEC$ VECTOR ALWAYS
!          do i=is1, ie1
!             xt = 2.*dm(i,j)
!             bl(i,j) = -sign(min(abs(xt), abs(al(i,j  )-q(i,j))), xt)
!             br(i,j) =  sign(min(abs(xt), abs(al(i+1,j)-q(i,j))), xt)
!          enddo
!       enddo
!    else
!       do j=jfirst,jlast
!          do i=is1-2, ie1+1
!             dq(i,j) = q(i+1,j) - q(i,j)
!          enddo
!       enddo
!       do j=jfirst,jlast
!          do i=is1, ie1
!             bl(i,j) = al(i,j  ) - q(i,j)
!             br(i,j) = al(i+1,j) - q(i,j)
!             if ( abs(dm(i-1,j))+abs(dm(i,j))+abs(dm(i+1,j)) < near_zero ) then
!                bl(i,j) = 0.
!                br(i,j) = 0.
!             elseif( abs(3.*(bl(i,j)+br(i,j))) > abs(bl(i,j)-br(i,j)) ) then
!                pmp_1 = -(dq(i,j) + dq(i,j))
!                lac_1 = pmp_1 + 1.5*dq(i+1,j)
!                bl(i,j) = min( max(0., pmp_1, lac_1), max(bl(i,j), min(0., pmp_1, lac_1)) )
!                pmp_2 = dq(i-1,j) + dq(i-1,j)
!                lac_2 = pmp_2 - 1.5*dq(i-2,j)
!                br(i,j) = min( max(0., pmp_2, lac_2), max(br(i,j), min(0., pmp_2, lac_2)) )
!             endif
!          enddo
!       enddo
!    endif
!    ! Positive definite constraint:
!    if(iord==-9 .or. iord==-13) call pert_ppm(ie1-is1+1, q(is1,j), bl(is1,j), br(is1,j), 0)
!
!    if (.not. nested .and. grid_type<3) then
!       if ( is==1 ) then
!          do j=jfirst,jlast
!             bl_tmp(3*j) = s14*dm(-1,j) + s11*(q(-1,j)-q(0,j))
!
!             xt = 0.5*(((2.*dxa(0,j)+dxa(-1,j))*q(0,j)-dxa(0,j)*q(-1,j))/(dxa(-1,j)+dxa(0,j)) &
!                  +      ((2.*dxa(1,j)+dxa( 2,j))*q(1,j)-dxa(1,j)*q(2,j))/(dxa(1, j)+dxa(2,j)))
!             br_tmp(3*j) = xt - q(0,j)
!             bl_tmp(3*j+1) = xt - q(1,j)
!             xt = s15*q(1,j) + s11*q(2,j) - s14*dm(2,j)
!             br_tmp(3*j+1) = xt - q(1,j)
!             bl_tmp(3*j+2) = xt - q(2,j)
!             br_tmp(3*j+2) = al(3,j) - q(2,j)
!             q_tmp(j*3:j*3+2) = q(0:2,j)
!          enddo
!          call pert_ppm(3*(jlast-jfirst+1), q_tmp, bl_tmp, br_tmp, 1)
!          do j=jfirst,jlast
!             bl(0:2,j) = bl_tmp(j*3:j*3+2)
!             br(0:2,j) = br_tmp(j*3:j*3+2)
!          enddo
!      endif
!      if ( (ie+1)==npx ) then
!         do j=jfirst,jlast
!            bl_tmp(3*j) = al(npx-2,j) - q(npx-2,j)
!
!            xt = s15*q(npx-1,j) + s11*q(npx-2,j) + s14*dm(npx-2,j)
!            br_tmp(3*j) = xt - q(npx-2,j)
!            bl_tmp(3*j+1) = xt - q(npx-1,j)
!
!            xt = 0.5*(((2.*dxa(npx-1,j)+dxa(npx-2,j))*q(npx-1,j)-dxa(npx-1,j)*q(npx-2,j))/(dxa(npx-2,j)+dxa(npx-1,j)) &
!               +      ((2.*dxa(npx,  j)+dxa(npx+1,j))*q(npx,j  )-dxa(npx,  j)*q(npx+1,j))/(dxa(npx,  j)+dxa(npx+1,j)))
!            br_tmp(3*j+1) = xt - q(npx-1,j)
!            bl_tmp(3*j+2) = xt - q(npx,j  )
!
!            br_tmp(3*j+2) = s11*(q(npx+1,j)-q(npx,j)) - s14*dm(npx+1,j)
!            q_tmp(j*3:j*3+2) = q(npx-2:npx,j)
!         enddo
!         call pert_ppm(3*(jlast-jfirst+1), q_tmp, bl_tmp, br_tmp, 1)
!
!         do j=jfirst,jlast
!            bl(npx-2:npx,j) = bl_tmp(j*3:j*3+2)
!            br(npx-2:npx,j) = br_tmp(j*3:j*3+2)
!         enddo
!      endif
!    endif
!
!  endif
!
!  do j=jfirst,jlast
!!DEC$ VECTOR ALWAYS
!     do i=ifirst,ilast+1
!        if( c(i,j)>0. ) then
!           flux(i,j) = q(i-1,j) + (1.-c(i,j))*(br(i-1,j)-c(i,j)*(bl(i-1,j)+br(i-1,j)))
!        else
!           flux(i,j) = q(i,j  ) + (1.+c(i,j))*(bl(i,j  )+c(i,j)*(bl(i,j  )+br(i,j  )))
!        endif
!     enddo
!  enddo
!
! end subroutine xppm0
!#else
  SUBROUTINE XPPM0_ADM(flux, flux_ad, q, q_ad, c, c_ad, iord, ifirst, &
&   ilast, jfirst, jlast, npx, npy, bd, dxa, nested, grid_type)
    IMPLICIT NONE
    TYPE(FV_GRID_BOUNDS_TYPE), INTENT(IN) :: bd
!  X-Dir strip
    INTEGER, INTENT(IN) :: ifirst, ilast
!  Y-Dir strip
    INTEGER, INTENT(IN) :: jfirst, jlast
    INTEGER, INTENT(IN) :: iord
    INTEGER, INTENT(IN) :: npx, npy
    REAL(fvprc), INTENT(IN) :: q(ifirst-ng:ilast+ng, jfirst:jlast)
    REAL(fvprc) :: q_ad(ifirst-ng:ilast+ng, jfirst:jlast)
! Courant   N (like FLUX)
    REAL(fvprc), INTENT(IN) :: c(ifirst:ilast+1, jfirst:jlast)
    REAL(fvprc) :: c_ad(ifirst:ilast+1, jfirst:jlast)
    REAL(fvprc), INTENT(IN) :: dxa(bd%isd:bd%ied, bd%jsd:bd%jed)
    LOGICAL, INTENT(IN) :: nested
    INTEGER, INTENT(IN) :: grid_type
! !OUTPUT PARAMETERS:
!  Flux
    REAL(fvprc) :: flux(ifirst:ilast+1, jfirst:jlast)
    REAL(fvprc) :: flux_ad(ifirst:ilast+1, jfirst:jlast)
! Local
    REAL(fvprc), DIMENSION(ifirst-ng:ilast+ng) :: q1
    REAL(fvprc), DIMENSION(ifirst-ng:ilast+ng) :: q1_ad
    REAL(fvprc), DIMENSION(ifirst-1:ilast+1) :: bl, br
    REAL(fvprc), DIMENSION(ifirst-1:ilast+1) :: bl_ad, br_ad
    REAL(fvprc) :: al(ifirst-1:ilast+2)
    REAL(fvprc) :: al_ad(ifirst-1:ilast+2)
    REAL(fvprc) :: dm(ifirst-2:ilast+2)
    REAL(fvprc) :: dm_ad(ifirst-2:ilast+2)
    REAL(fvprc) :: dq(ifirst-3:ilast+2)
    REAL(fvprc) :: dq_ad(ifirst-3:ilast+2)
    LOGICAL :: extm(ifirst-2:ilast+2)
    INTEGER :: i, j, ie3, is1, ie1
    REAL(fvprc) :: xt, pmp_1, lac_1, pmp_2, lac_2
    REAL(fvprc) :: xt_ad, pmp_1_ad, lac_1_ad, pmp_2_ad, lac_2_ad
    INTEGER :: is, ie, js, je, isd, ied, jsd, jed
    INTRINSIC MAX
    INTRINSIC MIN
    INTRINSIC ABS
    INTRINSIC SIGN
    INTEGER :: abs0
    REAL(fvprc) :: min1
    REAL(fvprc) :: min1_ad
    REAL(fvprc) :: min2
    REAL(fvprc) :: min2_ad
    REAL(fvprc) :: min3
    REAL(fvprc) :: min3_ad
    REAL(fvprc) :: abs1
    REAL(fvprc) :: abs2
    REAL(fvprc) :: max1
    REAL(fvprc) :: max1_ad
    REAL(fvprc) :: min4
    REAL(fvprc) :: min4_ad
    REAL(fvprc) :: abs3
    REAL(fvprc) :: abs4
    REAL(fvprc) :: abs5
    INTEGER :: arg1
    REAL(fvprc) :: temp_ad
    REAL(fvprc) :: temp_ad0
    REAL(fvprc) :: temp_ad1
    REAL(fvprc) :: temp_ad2
    REAL(fvprc) :: x1_ad
    REAL(fvprc) :: y1_ad
    REAL(fvprc) :: z1_ad
    REAL(fvprc) :: x2_ad
    REAL(fvprc) :: y2_ad
    REAL(fvprc) :: x3_ad
    REAL(fvprc) :: y3_ad
    REAL(fvprc) :: x4_ad
    REAL(fvprc) :: y6_ad
    REAL(fvprc) :: y4_ad
    REAL(fvprc) :: x5_ad
    REAL(fvprc) :: y7_ad
    REAL(fvprc) :: y5_ad
    REAL(fvprc) :: temp_ad3
    REAL(fvprc) :: temp_ad4
    REAL(fvprc) :: temp_ad5
    REAL(fvprc) :: temp_ad6
    REAL(fvprc) :: temp
    REAL(fvprc) :: temp_ad7
    REAL(fvprc) :: temp_ad8
    REAL(fvprc) :: temp_ad9
    REAL(fvprc) :: temp_ad10
    INTEGER :: branch
    REAL(fvprc) :: x5
    REAL(fvprc) :: x4
    REAL(fvprc) :: x3
    REAL(fvprc) :: x2
    REAL(fvprc) :: x1
    REAL(fvprc) :: z1
    REAL(fvprc) :: y7
    REAL(fvprc) :: y6
    REAL(fvprc) :: y5
    REAL(fvprc) :: y4
    REAL(fvprc) :: y3
    REAL(fvprc) :: y2
    REAL(fvprc) :: y1
    is = bd%is
    ie = bd%ie
    IF (.NOT.nested .AND. grid_type .LT. 3) THEN
      IF (3 .LT. is - 1) THEN
        is1 = is - 1
      ELSE
        is1 = 3
      END IF
      IF (npx - 2 .GT. ie + 2) THEN
        ie3 = ie + 2
      ELSE
        ie3 = npx - 2
      END IF
      IF (npx - 3 .GT. ie + 1) THEN
        CALL PUSHCONTROL1B(1)
        ie1 = ie + 1
      ELSE
        CALL PUSHCONTROL1B(1)
        ie1 = npx - 3
      END IF
    ELSE
      CALL PUSHCONTROL1B(0)
      is1 = is - 1
      ie3 = ie + 2
      ie1 = ie + 1
    END IF
    DO j=jfirst,jlast
      DO i=ifirst-ng,ilast+ng
        CALL PUSHREALARRAY_ADM(q1(i))
        q1(i) = q(i, j)
      END DO
      IF (iord .GE. 0.) THEN
        abs0 = iord
      ELSE
        abs0 = -iord
      END IF
      IF (abs0 .LT. 8) THEN
! ord = -5: linear scheme based on PPM 4th order interpolation
! ord = -6: linear PPM with 2-delta filter
! ord = -7: (-6) with additional Positive definite constraint:
        DO i=is1,ie3
          al(i) = p1*(q1(i-1)+q1(i)) + p2*(q1(i-2)+q1(i+1))
        END DO
        IF (.NOT.nested .AND. grid_type .LT. 3) THEN
          IF (is .EQ. 1) THEN
            al(0) = c1*q1(-2) + c2*q1(-1) + c3*q1(0)
            al(1) = 0.5*(((2.*dxa(0, j)+dxa(-1, j))*q1(0)-dxa(0, j)*q1(-&
&             1))/(dxa(-1, j)+dxa(0, j))+((2.*dxa(1, j)+dxa(2, j))*q1(1)&
&             -dxa(1, j)*q1(2))/(dxa(1, j)+dxa(2, j)))
            al(2) = c3*q1(1) + c2*q1(2) + c1*q1(3)
            IF (iord .EQ. -7) THEN
              IF (0. .LT. al(0)) THEN
                CALL PUSHCONTROL1B(0)
                al(0) = al(0)
              ELSE
                al(0) = 0.
                CALL PUSHCONTROL1B(1)
              END IF
              IF (0. .LT. al(1)) THEN
                CALL PUSHCONTROL1B(0)
                al(1) = al(1)
              ELSE
                al(1) = 0.
                CALL PUSHCONTROL1B(1)
              END IF
              IF (0. .LT. al(2)) THEN
                CALL PUSHCONTROL2B(3)
                al(2) = al(2)
              ELSE
                al(2) = 0.
                CALL PUSHCONTROL2B(2)
              END IF
            ELSE
              CALL PUSHCONTROL2B(0)
            END IF
          ELSE
            CALL PUSHCONTROL2B(1)
          END IF
          IF (ie + 1 .EQ. npx) THEN
            al(npx-1) = c1*q1(npx-3) + c2*q1(npx-2) + c3*q1(npx-1)
            al(npx) = 0.5*(((2.*dxa(npx-1, j)+dxa(npx-2, j))*q1(npx-1)-&
&             dxa(npx-1, j)*q1(npx-2))/(dxa(npx-2, j)+dxa(npx-1, j))+((&
&             2.*dxa(npx, j)+dxa(npx+1, j))*q1(npx)-dxa(npx, j)*q1(npx+1&
&             ))/(dxa(npx, j)+dxa(npx+1, j)))
            al(npx+1) = c3*q1(npx) + c2*q1(npx+1) + c1*q1(npx+2)
            IF (iord .EQ. -7) THEN
              IF (0. .LT. al(npx-1)) THEN
                CALL PUSHCONTROL1B(0)
                al(npx-1) = al(npx-1)
              ELSE
                al(npx-1) = 0.
                CALL PUSHCONTROL1B(1)
              END IF
              IF (0. .LT. al(npx)) THEN
                CALL PUSHCONTROL1B(0)
                al(npx) = al(npx)
              ELSE
                al(npx) = 0.
                CALL PUSHCONTROL1B(1)
              END IF
              IF (0. .LT. al(npx+1)) THEN
                CALL PUSHCONTROL3B(4)
                al(npx+1) = al(npx+1)
              ELSE
                al(npx+1) = 0.
                CALL PUSHCONTROL3B(3)
              END IF
            ELSE
              CALL PUSHCONTROL3B(0)
            END IF
          ELSE
            CALL PUSHCONTROL3B(1)
          END IF
        ELSE
          CALL PUSHCONTROL3B(2)
        END IF
        IF (iord .EQ. -5) THEN
          DO i=ifirst-1,ilast+1
            CALL PUSHREALARRAY_ADM(bl(i))
            bl(i) = al(i) - q1(i)
            CALL PUSHREALARRAY_ADM(br(i))
            br(i) = al(i+1) - q1(i)
          END DO
          CALL PUSHCONTROL3B(5)
        ELSE
          DO i=ifirst-3,ilast+2
            dq(i) = q1(i+1) - q1(i)
          END DO
          DO i=ifirst-2,ilast+2
            IF (dq(i-1)*dq(i) .GT. 0.) THEN
              CALL PUSHCONTROL1B(1)
              extm(i) = .false.
            ELSE
              CALL PUSHCONTROL1B(0)
              extm(i) = .true.
            END IF
          END DO
          DO i=ifirst-1,ilast+1
            IF (extm(i-1) .AND. extm(i) .AND. extm(i+1)) THEN
              CALL PUSHREALARRAY_ADM(bl(i))
              bl(i) = 0.
              CALL PUSHREALARRAY_ADM(br(i))
              br(i) = 0.
              CALL PUSHCONTROL1B(1)
            ELSE
              CALL PUSHREALARRAY_ADM(bl(i))
              bl(i) = al(i) - q1(i)
              CALL PUSHREALARRAY_ADM(br(i))
              br(i) = al(i+1) - q1(i)
              CALL PUSHCONTROL1B(0)
            END IF
          END DO
! Additional positive definite constraint:
          IF (iord .EQ. -7) THEN
            arg1 = ilast - ifirst + 3
            CALL PUSHREALARRAY_ADM(br(ifirst-1), 8*(ilast-ifirst+3)/8)
            CALL PUSHREALARRAY_ADM(bl(ifirst-1), 8*(ilast-ifirst+3)/8)
            CALL PERT_PPM(arg1, q1(ifirst-1), bl(ifirst-1), br(ifirst-1)&
&                   , 0)
            CALL PUSHCONTROL3B(4)
          ELSE
            CALL PUSHCONTROL3B(3)
          END IF
        END IF
      ELSE
! Monotonic constraints:
! ord = 8: PPM with Lin's PPM fast monotone constraint
! ord = 10: PPM with Lin's modification of Huynh 2nd constraint
! ord = 13: 10 plus positive definite constraint
        DO i=is-2,ie+2
          CALL PUSHREALARRAY_ADM(xt)
          xt = 0.25*(q1(i+1)-q1(i-1))
          IF (xt .GE. 0.) THEN
            x1 = xt
            CALL PUSHCONTROL1B(0)
          ELSE
            x1 = -xt
            CALL PUSHCONTROL1B(1)
          END IF
          IF (q1(i-1) .LT. q1(i)) THEN
            IF (q1(i) .LT. q1(i+1)) THEN
              max1 = q1(i+1)
              CALL PUSHCONTROL2B(0)
            ELSE
              max1 = q1(i)
              CALL PUSHCONTROL2B(1)
            END IF
          ELSE IF (q1(i-1) .LT. q1(i+1)) THEN
            max1 = q1(i+1)
            CALL PUSHCONTROL2B(2)
          ELSE
            max1 = q1(i-1)
            CALL PUSHCONTROL2B(3)
          END IF
          y1 = max1 - q1(i)
          IF (q1(i-1) .GT. q1(i)) THEN
            IF (q1(i) .GT. q1(i+1)) THEN
              min4 = q1(i+1)
              CALL PUSHCONTROL2B(0)
            ELSE
              min4 = q1(i)
              CALL PUSHCONTROL2B(1)
            END IF
          ELSE IF (q1(i-1) .GT. q1(i+1)) THEN
            min4 = q1(i+1)
            CALL PUSHCONTROL2B(2)
          ELSE
            min4 = q1(i-1)
            CALL PUSHCONTROL2B(3)
          END IF
          z1 = q1(i) - min4
          IF (x1 .GT. y1) THEN
            IF (y1 .GT. z1) THEN
              CALL PUSHREALARRAY_ADM(min1)
              min1 = z1
              CALL PUSHCONTROL2B(0)
            ELSE
              CALL PUSHREALARRAY_ADM(min1)
              min1 = y1
              CALL PUSHCONTROL2B(1)
            END IF
          ELSE IF (x1 .GT. z1) THEN
            CALL PUSHREALARRAY_ADM(min1)
            min1 = z1
            CALL PUSHCONTROL2B(2)
          ELSE
            CALL PUSHREALARRAY_ADM(min1)
            min1 = x1
            CALL PUSHCONTROL2B(3)
          END IF
          dm(i) = SIGN(min1, xt)
        END DO
        DO i=is1,ie1+1
          al(i) = 0.5*(q1(i-1)+q1(i)) + r3*(dm(i-1)-dm(i))
        END DO
        IF (iord .EQ. -8) THEN
          DO i=is1,ie1
            CALL PUSHREALARRAY_ADM(xt)
            xt = 2.*dm(i)
            IF (xt .GE. 0.) THEN
              x2 = xt
              CALL PUSHCONTROL1B(0)
            ELSE
              x2 = -xt
              CALL PUSHCONTROL1B(1)
            END IF
            IF (al(i) - q1(i) .GE. 0.) THEN
              y2 = al(i) - q1(i)
              CALL PUSHCONTROL1B(0)
            ELSE
              y2 = -(al(i)-q1(i))
              CALL PUSHCONTROL1B(1)
            END IF
            IF (x2 .GT. y2) THEN
              CALL PUSHREALARRAY_ADM(min2)
              min2 = y2
              CALL PUSHCONTROL1B(0)
            ELSE
              CALL PUSHREALARRAY_ADM(min2)
              min2 = x2
              CALL PUSHCONTROL1B(1)
            END IF
            CALL PUSHREALARRAY_ADM(bl(i))
            bl(i) = -SIGN(min2, xt)
            IF (xt .GE. 0.) THEN
              x3 = xt
              CALL PUSHCONTROL1B(0)
            ELSE
              x3 = -xt
              CALL PUSHCONTROL1B(1)
            END IF
            IF (al(i+1) - q1(i) .GE. 0.) THEN
              y3 = al(i+1) - q1(i)
              CALL PUSHCONTROL1B(0)
            ELSE
              y3 = -(al(i+1)-q1(i))
              CALL PUSHCONTROL1B(1)
            END IF
            IF (x3 .GT. y3) THEN
              CALL PUSHREALARRAY_ADM(min3)
              min3 = y3
              CALL PUSHCONTROL1B(0)
            ELSE
              CALL PUSHREALARRAY_ADM(min3)
              min3 = x3
              CALL PUSHCONTROL1B(1)
            END IF
            CALL PUSHREALARRAY_ADM(br(i))
            br(i) = SIGN(min3, xt)
          END DO
          CALL PUSHCONTROL1B(0)
        ELSE
          DO i=is1-2,ie1+1
            dq(i) = q1(i+1) - q1(i)
          END DO
          DO i=is1,ie1
            CALL PUSHREALARRAY_ADM(bl(i))
            bl(i) = al(i) - q1(i)
            CALL PUSHREALARRAY_ADM(br(i))
            br(i) = al(i+1) - q1(i)
            IF (dm(i-1) .GE. 0.) THEN
              abs1 = dm(i-1)
            ELSE
              abs1 = -dm(i-1)
            END IF
            IF (dm(i) .GE. 0.) THEN
              abs3 = dm(i)
            ELSE
              abs3 = -dm(i)
            END IF
            IF (dm(i+1) .GE. 0.) THEN
              abs5 = dm(i+1)
            ELSE
              abs5 = -dm(i+1)
            END IF
            IF (abs1 + abs3 + abs5 .LT. near_zero) THEN
              bl(i) = 0.
              br(i) = 0.
              CALL PUSHCONTROL2B(3)
            ELSE
              IF (3.*(bl(i)+br(i)) .GE. 0.) THEN
                abs2 = 3.*(bl(i)+br(i))
              ELSE
                abs2 = -(3.*(bl(i)+br(i)))
              END IF
              IF (bl(i) - br(i) .GE. 0.) THEN
                abs4 = bl(i) - br(i)
              ELSE
                abs4 = -(bl(i)-br(i))
              END IF
              IF (abs2 .GT. abs4) THEN
                pmp_1 = -(dq(i)+dq(i))
                lac_1 = pmp_1 + 1.5*dq(i+1)
                IF (0. .LT. pmp_1) THEN
                  IF (pmp_1 .LT. lac_1) THEN
                    x4 = lac_1
                    CALL PUSHCONTROL2B(0)
                  ELSE
                    x4 = pmp_1
                    CALL PUSHCONTROL2B(1)
                  END IF
                ELSE IF (0. .LT. lac_1) THEN
                  x4 = lac_1
                  CALL PUSHCONTROL2B(2)
                ELSE
                  CALL PUSHCONTROL2B(3)
                  x4 = 0.
                END IF
                IF (0. .GT. pmp_1) THEN
                  IF (pmp_1 .GT. lac_1) THEN
                    y6 = lac_1
                    CALL PUSHCONTROL2B(0)
                  ELSE
                    y6 = pmp_1
                    CALL PUSHCONTROL2B(1)
                  END IF
                ELSE IF (0. .GT. lac_1) THEN
                  y6 = lac_1
                  CALL PUSHCONTROL2B(2)
                ELSE
                  y6 = 0.
                  CALL PUSHCONTROL2B(3)
                END IF
                IF (bl(i) .LT. y6) THEN
                  y4 = y6
                  CALL PUSHCONTROL1B(0)
                ELSE
                  y4 = bl(i)
                  CALL PUSHCONTROL1B(1)
                END IF
                IF (x4 .GT. y4) THEN
                  bl(i) = y4
                  CALL PUSHCONTROL1B(0)
                ELSE
                  bl(i) = x4
                  CALL PUSHCONTROL1B(1)
                END IF
                pmp_2 = dq(i-1) + dq(i-1)
                lac_2 = pmp_2 - 1.5*dq(i-2)
                IF (0. .LT. pmp_2) THEN
                  IF (pmp_2 .LT. lac_2) THEN
                    x5 = lac_2
                    CALL PUSHCONTROL2B(0)
                  ELSE
                    x5 = pmp_2
                    CALL PUSHCONTROL2B(1)
                  END IF
                ELSE IF (0. .LT. lac_2) THEN
                  x5 = lac_2
                  CALL PUSHCONTROL2B(2)
                ELSE
                  CALL PUSHCONTROL2B(3)
                  x5 = 0.
                END IF
                IF (0. .GT. pmp_2) THEN
                  IF (pmp_2 .GT. lac_2) THEN
                    y7 = lac_2
                    CALL PUSHCONTROL2B(0)
                  ELSE
                    y7 = pmp_2
                    CALL PUSHCONTROL2B(1)
                  END IF
                ELSE IF (0. .GT. lac_2) THEN
                  y7 = lac_2
                  CALL PUSHCONTROL2B(2)
                ELSE
                  y7 = 0.
                  CALL PUSHCONTROL2B(3)
                END IF
                IF (br(i) .LT. y7) THEN
                  y5 = y7
                  CALL PUSHCONTROL1B(0)
                ELSE
                  y5 = br(i)
                  CALL PUSHCONTROL1B(1)
                END IF
                IF (x5 .GT. y5) THEN
                  br(i) = y5
                  CALL PUSHCONTROL2B(1)
                ELSE
                  br(i) = x5
                  CALL PUSHCONTROL2B(2)
                END IF
              ELSE
                CALL PUSHCONTROL2B(0)
              END IF
            END IF
          END DO
          CALL PUSHCONTROL1B(1)
        END IF
! Positive definite constraint:
        IF (iord .EQ. -9 .OR. iord .EQ. -13) THEN
          arg1 = ie1 - is1 + 1
          CALL PUSHREALARRAY_ADM(br(is1), 8*(ilast-is1+2)/8)
          CALL PUSHREALARRAY_ADM(bl(is1), 8*(ilast-is1+2)/8)
          CALL PERT_PPM(arg1, q1(is1), bl(is1), br(is1), 0)
          CALL PUSHCONTROL1B(0)
        ELSE
          CALL PUSHCONTROL1B(1)
        END IF
        IF (.NOT.nested .AND. grid_type .LT. 3) THEN
          IF (is .EQ. 1) THEN
            CALL PUSHREALARRAY_ADM(bl(0))
            bl(0) = s14*dm(-1) + s11*(q1(-1)-q1(0))
            CALL PUSHREALARRAY_ADM(xt)
            xt = 0.5*(((2.*dxa(0, j)+dxa(-1, j))*q1(0)-dxa(0, j)*q1(-1))&
&             /(dxa(-1, j)+dxa(0, j))+((2.*dxa(1, j)+dxa(2, j))*q1(1)-&
&             dxa(1, j)*q1(2))/(dxa(1, j)+dxa(2, j)))
            CALL PUSHREALARRAY_ADM(br(0))
            br(0) = xt - q1(0)
            CALL PUSHREALARRAY_ADM(bl(1))
            bl(1) = xt - q1(1)
            xt = s15*q1(1) + s11*q1(2) - s14*dm(2)
            CALL PUSHREALARRAY_ADM(br(1))
            br(1) = xt - q1(1)
            CALL PUSHREALARRAY_ADM(bl(2))
            bl(2) = xt - q1(2)
            CALL PUSHREALARRAY_ADM(br(2))
            br(2) = al(3) - q1(2)
            CALL PUSHREALARRAY_ADM(br(0), 8*(ilast+2)/8)
            CALL PUSHREALARRAY_ADM(bl(0), 8*(ilast+2)/8)
            CALL PERT_PPM(3, q1(0), bl(0), br(0), 1)
            CALL PUSHCONTROL1B(0)
          ELSE
            CALL PUSHCONTROL1B(1)
          END IF
          IF (ie + 1 .EQ. npx) THEN
            CALL PUSHREALARRAY_ADM(bl(npx-2))
            bl(npx-2) = al(npx-2) - q1(npx-2)
            CALL PUSHREALARRAY_ADM(xt)
            xt = s15*q1(npx-1) + s11*q1(npx-2) + s14*dm(npx-2)
            CALL PUSHREALARRAY_ADM(br(npx-2))
            br(npx-2) = xt - q1(npx-2)
            CALL PUSHREALARRAY_ADM(bl(npx-1))
            bl(npx-1) = xt - q1(npx-1)
            xt = 0.5*(((2.*dxa(npx-1, j)+dxa(npx-2, j))*q1(npx-1)-dxa(&
&             npx-1, j)*q1(npx-2))/(dxa(npx-2, j)+dxa(npx-1, j))+((2.*&
&             dxa(npx, j)+dxa(npx+1, j))*q1(npx)-dxa(npx, j)*q1(npx+1))/&
&             (dxa(npx, j)+dxa(npx+1, j)))
            CALL PUSHREALARRAY_ADM(br(npx-1))
            br(npx-1) = xt - q1(npx-1)
            CALL PUSHREALARRAY_ADM(bl(npx))
            bl(npx) = xt - q1(npx)
            CALL PUSHREALARRAY_ADM(br(npx))
            br(npx) = s11*(q1(npx+1)-q1(npx)) - s14*dm(npx+1)
            CALL PUSHREALARRAY_ADM(br(npx-2), 8*(ilast-npx+4)/8)
            CALL PUSHREALARRAY_ADM(bl(npx-2), 8*(ilast-npx+4)/8)
            CALL PERT_PPM(3, q1(npx-2), bl(npx-2), br(npx-2), 1)
            CALL PUSHCONTROL3B(2)
          ELSE
            CALL PUSHCONTROL3B(1)
          END IF
        ELSE
          CALL PUSHCONTROL3B(0)
        END IF
      END IF
      DO i=ifirst,ilast+1
        IF (c(i, j) .GT. 0.) THEN
          CALL PUSHCONTROL1B(1)
        ELSE
          CALL PUSHCONTROL1B(0)
        END IF
      END DO
    END DO
    dm_ad = 0.0_FVPRC
    dq_ad = 0.0_FVPRC
    al_ad = 0.0_FVPRC
    bl_ad = 0.0_FVPRC
    br_ad = 0.0_FVPRC
    q1_ad = 0.0_FVPRC
    DO j=jlast,jfirst,-1
      DO i=ilast+1,ifirst,-1
        CALL POPCONTROL1B(branch)
        IF (branch .EQ. 0) THEN
          temp_ad9 = (c(i, j)+1.)*flux_ad(i, j)
          temp_ad10 = c(i, j)*temp_ad9
          q1_ad(i) = q1_ad(i) + flux_ad(i, j)
          c_ad(i, j) = c_ad(i, j) + (bl(i)+br(i))*temp_ad9 + (bl(i)+c(i&
&           , j)*(bl(i)+br(i)))*flux_ad(i, j)
          bl_ad(i) = bl_ad(i) + temp_ad10 + temp_ad9
          br_ad(i) = br_ad(i) + temp_ad10
          flux_ad(i, j) = 0.0_FVPRC
        ELSE
          temp = bl(i-1) + br(i-1)
          temp_ad7 = (1.-c(i, j))*flux_ad(i, j)
          temp_ad8 = -(c(i, j)*temp_ad7)
          q1_ad(i-1) = q1_ad(i-1) + flux_ad(i, j)
          c_ad(i, j) = c_ad(i, j) - temp*temp_ad7 - (br(i-1)-c(i, j)*&
&           temp)*flux_ad(i, j)
          br_ad(i-1) = br_ad(i-1) + temp_ad8 + temp_ad7
          bl_ad(i-1) = bl_ad(i-1) + temp_ad8
          flux_ad(i, j) = 0.0_FVPRC
        END IF
      END DO
      CALL POPCONTROL3B(branch)
      IF (branch .LT. 3) THEN
        IF (branch .NE. 0) THEN
          IF (branch .NE. 1) THEN
            CALL POPREALARRAY_ADM(bl(npx-2), 8*(ilast-npx+4)/8)
            CALL POPREALARRAY_ADM(br(npx-2), 8*(ilast-npx+4)/8)
            CALL PERT_PPM_ADM(3, q1(npx-2), bl(npx-2:), bl_ad(npx-2:), &
&                       br(npx-2:), br_ad(npx-2:), 1)
            CALL POPREALARRAY_ADM(br(npx))
            q1_ad(npx+1) = q1_ad(npx+1) + s11*br_ad(npx)
            q1_ad(npx) = q1_ad(npx) - bl_ad(npx) - s11*br_ad(npx)
            dm_ad(npx+1) = dm_ad(npx+1) - s14*br_ad(npx)
            br_ad(npx) = 0.0_FVPRC
            CALL POPREALARRAY_ADM(bl(npx))
            xt_ad = br_ad(npx-1) + bl_ad(npx)
            bl_ad(npx) = 0.0_FVPRC
            CALL POPREALARRAY_ADM(br(npx-1))
            temp_ad5 = 0.5*xt_ad/(dxa(npx-2, j)+dxa(npx-1, j))
            q1_ad(npx-1) = q1_ad(npx-1) + (dxa(npx-1, j)*2.+dxa(npx-2, j&
&             ))*temp_ad5 - br_ad(npx-1)
            br_ad(npx-1) = 0.0_FVPRC
            temp_ad6 = 0.5*xt_ad/(dxa(npx, j)+dxa(npx+1, j))
            q1_ad(npx-2) = q1_ad(npx-2) - dxa(npx-1, j)*temp_ad5
            q1_ad(npx) = q1_ad(npx) + (dxa(npx, j)*2.+dxa(npx+1, j))*&
&             temp_ad6
            q1_ad(npx+1) = q1_ad(npx+1) - dxa(npx, j)*temp_ad6
            CALL POPREALARRAY_ADM(bl(npx-1))
            xt_ad = br_ad(npx-2) + bl_ad(npx-1)
            q1_ad(npx-1) = q1_ad(npx-1) - bl_ad(npx-1)
            bl_ad(npx-1) = 0.0_FVPRC
            CALL POPREALARRAY_ADM(br(npx-2))
            q1_ad(npx-2) = q1_ad(npx-2) - br_ad(npx-2)
            br_ad(npx-2) = 0.0_FVPRC
            CALL POPREALARRAY_ADM(xt)
            q1_ad(npx-1) = q1_ad(npx-1) + s15*xt_ad
            q1_ad(npx-2) = q1_ad(npx-2) + s11*xt_ad - bl_ad(npx-2)
            dm_ad(npx-2) = dm_ad(npx-2) + s14*xt_ad
            CALL POPREALARRAY_ADM(bl(npx-2))
            al_ad(npx-2) = al_ad(npx-2) + bl_ad(npx-2)
            bl_ad(npx-2) = 0.0_FVPRC
          END IF
          CALL POPCONTROL1B(branch)
          IF (branch .EQ. 0) THEN
            CALL POPREALARRAY_ADM(bl(0), 8*(ilast+2)/8)
            CALL POPREALARRAY_ADM(br(0), 8*(ilast+2)/8)
            CALL PERT_PPM_ADM(3, q1(0), bl(0:), bl_ad(0:), br(0:), br_ad&
&                       (0:), 1)
            CALL POPREALARRAY_ADM(br(2))
            al_ad(3) = al_ad(3) + br_ad(2)
            q1_ad(2) = q1_ad(2) - bl_ad(2) - br_ad(2)
            br_ad(2) = 0.0_FVPRC
            CALL POPREALARRAY_ADM(bl(2))
            xt_ad = br_ad(1) + bl_ad(2)
            bl_ad(2) = 0.0_FVPRC
            CALL POPREALARRAY_ADM(br(1))
            q1_ad(1) = q1_ad(1) + s15*xt_ad - br_ad(1)
            br_ad(1) = 0.0_FVPRC
            q1_ad(2) = q1_ad(2) + s11*xt_ad
            dm_ad(2) = dm_ad(2) - s14*xt_ad
            CALL POPREALARRAY_ADM(bl(1))
            xt_ad = br_ad(0) + bl_ad(1)
            q1_ad(1) = q1_ad(1) - bl_ad(1)
            bl_ad(1) = 0.0_FVPRC
            CALL POPREALARRAY_ADM(br(0))
            CALL POPREALARRAY_ADM(xt)
            temp_ad3 = 0.5*xt_ad/(dxa(-1, j)+dxa(0, j))
            q1_ad(0) = q1_ad(0) + (dxa(0, j)*2.+dxa(-1, j))*temp_ad3 - &
&             br_ad(0)
            br_ad(0) = 0.0_FVPRC
            temp_ad4 = 0.5*xt_ad/(dxa(1, j)+dxa(2, j))
            q1_ad(-1) = q1_ad(-1) - dxa(0, j)*temp_ad3
            q1_ad(1) = q1_ad(1) + (dxa(1, j)*2.+dxa(2, j))*temp_ad4
            q1_ad(2) = q1_ad(2) - dxa(1, j)*temp_ad4
            CALL POPREALARRAY_ADM(bl(0))
            dm_ad(-1) = dm_ad(-1) + s14*bl_ad(0)
            q1_ad(-1) = q1_ad(-1) + s11*bl_ad(0)
            q1_ad(0) = q1_ad(0) - s11*bl_ad(0)
            bl_ad(0) = 0.0_FVPRC
          END IF
        END IF
        CALL POPCONTROL1B(branch)
        IF (branch .EQ. 0) THEN
          arg1 = ie1 - is1 + 1
          CALL POPREALARRAY_ADM(bl(is1), 8*(ilast-is1+2)/8)
          CALL POPREALARRAY_ADM(br(is1), 8*(ilast-is1+2)/8)
          CALL PERT_PPM_ADM(arg1, q1(is1), bl(is1:), bl_ad(is1:), br(is1&
&                     :), br_ad(is1:), 0)
        END IF
        CALL POPCONTROL1B(branch)
        IF (branch .EQ. 0) THEN
          DO i=ie1,is1,-1
            CALL POPREALARRAY_ADM(br(i))
            min3_ad = SIGN(1.d0, min3*xt)*br_ad(i)
            br_ad(i) = 0.0_FVPRC
            CALL POPCONTROL1B(branch)
            IF (branch .EQ. 0) THEN
              CALL POPREALARRAY_ADM(min3)
              y3_ad = min3_ad
              x3_ad = 0.0_FVPRC
            ELSE
              CALL POPREALARRAY_ADM(min3)
              x3_ad = min3_ad
              y3_ad = 0.0_FVPRC
            END IF
            CALL POPCONTROL1B(branch)
            IF (branch .EQ. 0) THEN
              al_ad(i+1) = al_ad(i+1) + y3_ad
              q1_ad(i) = q1_ad(i) - y3_ad
            ELSE
              q1_ad(i) = q1_ad(i) + y3_ad
              al_ad(i+1) = al_ad(i+1) - y3_ad
            END IF
            CALL POPCONTROL1B(branch)
            IF (branch .EQ. 0) THEN
              xt_ad = x3_ad
            ELSE
              xt_ad = -x3_ad
            END IF
            CALL POPREALARRAY_ADM(bl(i))
            min2_ad = -(SIGN(1.d0, min2*xt)*bl_ad(i))
            bl_ad(i) = 0.0_FVPRC
            CALL POPCONTROL1B(branch)
            IF (branch .EQ. 0) THEN
              CALL POPREALARRAY_ADM(min2)
              y2_ad = min2_ad
              x2_ad = 0.0_FVPRC
            ELSE
              CALL POPREALARRAY_ADM(min2)
              x2_ad = min2_ad
              y2_ad = 0.0_FVPRC
            END IF
            CALL POPCONTROL1B(branch)
            IF (branch .EQ. 0) THEN
              al_ad(i) = al_ad(i) + y2_ad
              q1_ad(i) = q1_ad(i) - y2_ad
            ELSE
              q1_ad(i) = q1_ad(i) + y2_ad
              al_ad(i) = al_ad(i) - y2_ad
            END IF
            CALL POPCONTROL1B(branch)
            IF (branch .EQ. 0) THEN
              xt_ad = xt_ad + x2_ad
            ELSE
              xt_ad = xt_ad - x2_ad
            END IF
            CALL POPREALARRAY_ADM(xt)
            dm_ad(i) = dm_ad(i) + 2.*xt_ad
          END DO
        ELSE
          DO i=ie1,is1,-1
            CALL POPCONTROL2B(branch)
            IF (branch .LT. 2) THEN
              IF (branch .EQ. 0) THEN
                GOTO 100
              ELSE
                y5_ad = br_ad(i)
                br_ad(i) = 0.0_FVPRC
                x5_ad = 0.0_FVPRC
              END IF
            ELSE IF (branch .EQ. 2) THEN
              x5_ad = br_ad(i)
              br_ad(i) = 0.0_FVPRC
              y5_ad = 0.0_FVPRC
            ELSE
              br_ad(i) = 0.0_FVPRC
              bl_ad(i) = 0.0_FVPRC
              GOTO 100
            END IF
            CALL POPCONTROL1B(branch)
            IF (branch .EQ. 0) THEN
              y7_ad = y5_ad
            ELSE
              br_ad(i) = br_ad(i) + y5_ad
              y7_ad = 0.0_FVPRC
            END IF
            CALL POPCONTROL2B(branch)
            IF (branch .LT. 2) THEN
              IF (branch .EQ. 0) THEN
                lac_2_ad = y7_ad
                pmp_2_ad = 0.0_FVPRC
              ELSE
                pmp_2_ad = y7_ad
                lac_2_ad = 0.0_FVPRC
              END IF
            ELSE
              IF (branch .EQ. 2) THEN
                lac_2_ad = y7_ad
              ELSE
                lac_2_ad = 0.0_FVPRC
              END IF
              pmp_2_ad = 0.0_FVPRC
            END IF
            CALL POPCONTROL2B(branch)
            IF (branch .LT. 2) THEN
              IF (branch .EQ. 0) THEN
                lac_2_ad = lac_2_ad + x5_ad
              ELSE
                pmp_2_ad = pmp_2_ad + x5_ad
              END IF
            ELSE IF (branch .EQ. 2) THEN
              lac_2_ad = lac_2_ad + x5_ad
            END IF
            pmp_2_ad = pmp_2_ad + lac_2_ad
            dq_ad(i-2) = dq_ad(i-2) - 1.5*lac_2_ad
            dq_ad(i-1) = dq_ad(i-1) + 2*pmp_2_ad
            CALL POPCONTROL1B(branch)
            IF (branch .EQ. 0) THEN
              y4_ad = bl_ad(i)
              bl_ad(i) = 0.0_FVPRC
              x4_ad = 0.0_FVPRC
            ELSE
              x4_ad = bl_ad(i)
              bl_ad(i) = 0.0_FVPRC
              y4_ad = 0.0_FVPRC
            END IF
            CALL POPCONTROL1B(branch)
            IF (branch .EQ. 0) THEN
              y6_ad = y4_ad
            ELSE
              bl_ad(i) = bl_ad(i) + y4_ad
              y6_ad = 0.0_FVPRC
            END IF
            CALL POPCONTROL2B(branch)
            IF (branch .LT. 2) THEN
              IF (branch .EQ. 0) THEN
                lac_1_ad = y6_ad
                pmp_1_ad = 0.0_FVPRC
              ELSE
                pmp_1_ad = y6_ad
                lac_1_ad = 0.0_FVPRC
              END IF
            ELSE
              IF (branch .EQ. 2) THEN
                lac_1_ad = y6_ad
              ELSE
                lac_1_ad = 0.0_FVPRC
              END IF
              pmp_1_ad = 0.0_FVPRC
            END IF
            CALL POPCONTROL2B(branch)
            IF (branch .LT. 2) THEN
              IF (branch .EQ. 0) THEN
                lac_1_ad = lac_1_ad + x4_ad
              ELSE
                pmp_1_ad = pmp_1_ad + x4_ad
              END IF
            ELSE IF (branch .EQ. 2) THEN
              lac_1_ad = lac_1_ad + x4_ad
            END IF
            pmp_1_ad = pmp_1_ad + lac_1_ad
            dq_ad(i+1) = dq_ad(i+1) + 1.5*lac_1_ad
            dq_ad(i) = dq_ad(i) - 2*pmp_1_ad
 100        CALL POPREALARRAY_ADM(br(i))
            al_ad(i+1) = al_ad(i+1) + br_ad(i)
            q1_ad(i) = q1_ad(i) - bl_ad(i) - br_ad(i)
            br_ad(i) = 0.0_FVPRC
            CALL POPREALARRAY_ADM(bl(i))
            al_ad(i) = al_ad(i) + bl_ad(i)
            bl_ad(i) = 0.0_FVPRC
          END DO
          DO i=ie1+1,is1-2,-1
            q1_ad(i+1) = q1_ad(i+1) + dq_ad(i)
            q1_ad(i) = q1_ad(i) - dq_ad(i)
            dq_ad(i) = 0.0_FVPRC
          END DO
        END IF
        DO i=ie1+1,is1,-1
          q1_ad(i-1) = q1_ad(i-1) + 0.5*al_ad(i)
          q1_ad(i) = q1_ad(i) + 0.5*al_ad(i)
          dm_ad(i-1) = dm_ad(i-1) + r3*al_ad(i)
          dm_ad(i) = dm_ad(i) - r3*al_ad(i)
          al_ad(i) = 0.0_FVPRC
        END DO
        DO i=ie+2,is-2,-1
          xt = 0.25*(q1(i+1)-q1(i-1))
          min1_ad = SIGN(1.d0, min1*xt)*dm_ad(i)
          dm_ad(i) = 0.0_FVPRC
          CALL POPCONTROL2B(branch)
          IF (branch .LT. 2) THEN
            IF (branch .EQ. 0) THEN
              CALL POPREALARRAY_ADM(min1)
              z1_ad = min1_ad
              y1_ad = 0.0_FVPRC
            ELSE
              CALL POPREALARRAY_ADM(min1)
              y1_ad = min1_ad
              z1_ad = 0.0_FVPRC
            END IF
            x1_ad = 0.0_FVPRC
          ELSE
            IF (branch .EQ. 2) THEN
              CALL POPREALARRAY_ADM(min1)
              z1_ad = min1_ad
              x1_ad = 0.0_FVPRC
            ELSE
              CALL POPREALARRAY_ADM(min1)
              x1_ad = min1_ad
              z1_ad = 0.0_FVPRC
            END IF
            y1_ad = 0.0_FVPRC
          END IF
          q1_ad(i) = q1_ad(i) + z1_ad
          min4_ad = -z1_ad
          CALL POPCONTROL2B(branch)
          IF (branch .LT. 2) THEN
            IF (branch .EQ. 0) THEN
              q1_ad(i+1) = q1_ad(i+1) + min4_ad
            ELSE
              q1_ad(i) = q1_ad(i) + min4_ad
            END IF
          ELSE IF (branch .EQ. 2) THEN
            q1_ad(i+1) = q1_ad(i+1) + min4_ad
          ELSE
            q1_ad(i-1) = q1_ad(i-1) + min4_ad
          END IF
          max1_ad = y1_ad
          q1_ad(i) = q1_ad(i) - y1_ad
          CALL POPCONTROL2B(branch)
          IF (branch .LT. 2) THEN
            IF (branch .EQ. 0) THEN
              q1_ad(i+1) = q1_ad(i+1) + max1_ad
            ELSE
              q1_ad(i) = q1_ad(i) + max1_ad
            END IF
          ELSE IF (branch .EQ. 2) THEN
            q1_ad(i+1) = q1_ad(i+1) + max1_ad
          ELSE
            q1_ad(i-1) = q1_ad(i-1) + max1_ad
          END IF
          CALL POPCONTROL1B(branch)
          IF (branch .EQ. 0) THEN
            xt_ad = x1_ad
          ELSE
            xt_ad = -x1_ad
          END IF
          CALL POPREALARRAY_ADM(xt)
          q1_ad(i+1) = q1_ad(i+1) + 0.25*xt_ad
          q1_ad(i-1) = q1_ad(i-1) - 0.25*xt_ad
        END DO
      ELSE
        IF (branch .NE. 3) THEN
          IF (branch .EQ. 4) THEN
            arg1 = ilast - ifirst + 3
            CALL POPREALARRAY_ADM(bl(ifirst-1), 8*(ilast-ifirst+3)/8)
            CALL POPREALARRAY_ADM(br(ifirst-1), 8*(ilast-ifirst+3)/8)
            CALL PERT_PPM_ADM(arg1, q1(ifirst-1), bl(ifirst-1:), bl_ad(&
&                       ifirst-1:), br(ifirst-1:), br_ad(ifirst-1:), 0)
          ELSE
            DO i=ilast+1,ifirst-1,-1
              CALL POPREALARRAY_ADM(br(i))
              al_ad(i+1) = al_ad(i+1) + br_ad(i)
              q1_ad(i) = q1_ad(i) - bl_ad(i) - br_ad(i)
              br_ad(i) = 0.0_FVPRC
              CALL POPREALARRAY_ADM(bl(i))
              al_ad(i) = al_ad(i) + bl_ad(i)
              bl_ad(i) = 0.0_FVPRC
            END DO
            GOTO 110
          END IF
        END IF
        DO i=ilast+1,ifirst-1,-1
          CALL POPCONTROL1B(branch)
          IF (branch .EQ. 0) THEN
            CALL POPREALARRAY_ADM(br(i))
            al_ad(i+1) = al_ad(i+1) + br_ad(i)
            q1_ad(i) = q1_ad(i) - bl_ad(i) - br_ad(i)
            br_ad(i) = 0.0_FVPRC
            CALL POPREALARRAY_ADM(bl(i))
            al_ad(i) = al_ad(i) + bl_ad(i)
            bl_ad(i) = 0.0_FVPRC
          ELSE
            CALL POPREALARRAY_ADM(br(i))
            br_ad(i) = 0.0_FVPRC
            CALL POPREALARRAY_ADM(bl(i))
            bl_ad(i) = 0.0_FVPRC
          END IF
        END DO
        DO i=ilast+2,ifirst-2,-1
          CALL POPCONTROL1B(branch)
        END DO
        DO i=ilast+2,ifirst-3,-1
          q1_ad(i+1) = q1_ad(i+1) + dq_ad(i)
          q1_ad(i) = q1_ad(i) - dq_ad(i)
          dq_ad(i) = 0.0_FVPRC
        END DO
 110    CALL POPCONTROL3B(branch)
        IF (branch .LT. 2) THEN
          IF (branch .NE. 0) GOTO 120
        ELSE IF (branch .EQ. 2) THEN
          GOTO 130
        ELSE
          IF (branch .EQ. 3) al_ad(npx+1) = 0.0_FVPRC
          CALL POPCONTROL1B(branch)
          IF (branch .NE. 0) al_ad(npx) = 0.0_FVPRC
          CALL POPCONTROL1B(branch)
          IF (branch .NE. 0) al_ad(npx-1) = 0.0_FVPRC
        END IF
        q1_ad(npx) = q1_ad(npx) + c3*al_ad(npx+1)
        q1_ad(npx+1) = q1_ad(npx+1) + c2*al_ad(npx+1)
        q1_ad(npx+2) = q1_ad(npx+2) + c1*al_ad(npx+1)
        al_ad(npx+1) = 0.0_FVPRC
        temp_ad1 = 0.5*al_ad(npx)/(dxa(npx-2, j)+dxa(npx-1, j))
        temp_ad2 = 0.5*al_ad(npx)/(dxa(npx, j)+dxa(npx+1, j))
        q1_ad(npx-1) = q1_ad(npx-1) + (dxa(npx-1, j)*2.+dxa(npx-2, j))*&
&         temp_ad1
        q1_ad(npx-2) = q1_ad(npx-2) - dxa(npx-1, j)*temp_ad1
        q1_ad(npx) = q1_ad(npx) + (dxa(npx, j)*2.+dxa(npx+1, j))*&
&         temp_ad2
        q1_ad(npx+1) = q1_ad(npx+1) - dxa(npx, j)*temp_ad2
        al_ad(npx) = 0.0_FVPRC
        q1_ad(npx-3) = q1_ad(npx-3) + c1*al_ad(npx-1)
        q1_ad(npx-2) = q1_ad(npx-2) + c2*al_ad(npx-1)
        q1_ad(npx-1) = q1_ad(npx-1) + c3*al_ad(npx-1)
        al_ad(npx-1) = 0.0_FVPRC
 120    CALL POPCONTROL2B(branch)
        IF (branch .LT. 2) THEN
          IF (branch .NE. 0) GOTO 130
        ELSE
          IF (branch .EQ. 2) al_ad(2) = 0.0_FVPRC
          CALL POPCONTROL1B(branch)
          IF (branch .NE. 0) al_ad(1) = 0.0_FVPRC
          CALL POPCONTROL1B(branch)
          IF (branch .NE. 0) al_ad(0) = 0.0_FVPRC
        END IF
        q1_ad(1) = q1_ad(1) + c3*al_ad(2)
        q1_ad(2) = q1_ad(2) + c2*al_ad(2)
        q1_ad(3) = q1_ad(3) + c1*al_ad(2)
        al_ad(2) = 0.0_FVPRC
        temp_ad = 0.5*al_ad(1)/(dxa(-1, j)+dxa(0, j))
        temp_ad0 = 0.5*al_ad(1)/(dxa(1, j)+dxa(2, j))
        q1_ad(0) = q1_ad(0) + (dxa(0, j)*2.+dxa(-1, j))*temp_ad
        q1_ad(-1) = q1_ad(-1) - dxa(0, j)*temp_ad
        q1_ad(1) = q1_ad(1) + (dxa(1, j)*2.+dxa(2, j))*temp_ad0
        q1_ad(2) = q1_ad(2) - dxa(1, j)*temp_ad0
        al_ad(1) = 0.0_FVPRC
        q1_ad(-2) = q1_ad(-2) + c1*al_ad(0)
        q1_ad(-1) = q1_ad(-1) + c2*al_ad(0)
        q1_ad(0) = q1_ad(0) + c3*al_ad(0)
        al_ad(0) = 0.0_FVPRC
 130    DO i=ie3,is1,-1
          q1_ad(i-1) = q1_ad(i-1) + p1*al_ad(i)
          q1_ad(i) = q1_ad(i) + p1*al_ad(i)
          q1_ad(i-2) = q1_ad(i-2) + p2*al_ad(i)
          q1_ad(i+1) = q1_ad(i+1) + p2*al_ad(i)
          al_ad(i) = 0.0_FVPRC
        END DO
      END IF
      DO i=ilast+ng,ifirst-ng,-1
        CALL POPREALARRAY_ADM(q1(i))
        q_ad(i, j) = q_ad(i, j) + q1_ad(i)
        q1_ad(i) = 0.0_FVPRC
      END DO
    END DO
    CALL POPCONTROL1B(branch)
  END SUBROUTINE XPPM0_ADM
!#ifdef XPPM_2D
! subroutine xppm0(flux, q, c, iord, ifirst, ilast, jfirst, jlast, npx, npy, bd, dxa, nested, grid_type)
! type(fv_grid_bounds_type), intent(IN) :: bd
! integer, INTENT(IN) :: ifirst, ilast               !  X-Dir strip
! integer, INTENT(IN) :: jfirst, jlast               !  Y-Dir strip
! integer, INTENT(IN) :: iord
! integer, INTENT(IN) :: npx, npy
! real(FVPRC)   , INTENT(IN) :: q(ifirst-ng:ilast+ng,jfirst:jlast)
! real(FVPRC)   , INTENT(IN) :: c(ifirst   :ilast+1 ,jfirst:jlast) ! Courant   N (like FLUX)
! real(FVPRC)   , intent(IN) :: dxa(bd%isd:bd%ied,bd%jsd:bd%jed)
! logical, intent(IN) :: nested
! integer, intent(IN) :: grid_type
!! !OUTPUT PARAMETERS:
! real(FVPRC)  , INTENT(OUT) :: flux(ifirst:ilast+1,jfirst:jlast) !  Flux
!! Local
! real(FVPRC), dimension(3*jfirst:3*jlast+2) :: q_tmp, bl_tmp, br_tmp
! real(FVPRC), dimension(ifirst-1:ilast+1,jfirst:jlast):: bl, br
! real(FVPRC)  al(ifirst-1:ilast+2,jfirst:jlast)
! real(FVPRC)  dm(ifirst-2:ilast+2,jfirst:jlast)
! real(FVPRC)  dq(ifirst-3:ilast+2,jfirst:jlast)
! logical extm(ifirst-2:ilast+2,jfirst:jlast)
! integer i, j, ie3, is1, ie1
! real(FVPRC) xt, pmp_1, lac_1, pmp_2, lac_2
!
! if ( .not. nested .and. grid_type<3 ) then
!    is1 = max(3,is-1);  ie3 = min(npx-2,ie+2)
!                        ie1 = min(npx-3,ie+1)
! else
!    is1 = is-1;         ie3 = ie+2
!                        ie1 = ie+1
! end if
!
! if ( abs(iord) < 8 ) then
!
!    ! ord = -5: linear scheme based on PPM 4th order interpolation
!    ! ord = -6: linear PPM with 2-delta filter
!    ! ord = -7: (-6) with additional Positive definite constraint:
!
!    do j=jfirst,jlast
!       do i=is1, ie3
!          al(i,j) = p1*(q(i-1,j)+q(i,j)) + p2*(q(i-2,j)+q(i+1,j))
!       enddo
!    enddo
!    if ( .not. nested .and. grid_type<3 ) then
!       if ( is==1 ) then
!          do j=jfirst,jlast
!             al(0,j) = c1*q(-2,j) + c2*q(-1,j) + c3*q(0,j)
!             al(1,j) = 0.5*(((2.*dxa(0,j)+dxa(-1,j))*q(0,j)-dxa(0,j)*q(-1,j))/(dxa(-1,j)+dxa(0,j)) &
!                  +      ((2.*dxa(1,j)+dxa( 2,j))*q(1,j)-dxa(1,j)*q(2,j))/(dxa(1, j)+dxa(2,j)))
!             al(2,j) = c3*q(1,j) + c2*q(2,j) +c1*q(3,j)
!          enddo
!          if(iord==-7) then
!             do j=jfirst,jlast
!                al(0,j) = max(0., al(0,j))
!                al(1,j) = max(0., al(1,j))
!                al(2,j) = max(0., al(2,j))
!             enddo
!          endif
!       endif
!       if ( (ie+1)==npx ) then
!          do j=jfirst,jlast
!             al(npx-1,j) = c1*q(npx-3,j) + c2*q(npx-2,j) + c3*q(npx-1,j)
!             al(npx,j) = 0.5*(((2.*dxa(npx-1,j)+dxa(npx-2,j))*q(npx-1,j)-dxa(npx-1,j)*q(npx-2,j))/(dxa(npx-2,j)+dxa(npx-1,j)) &
!                  +      ((2.*dxa(npx,  j)+dxa(npx+1,j))*q(npx,j)-dxa(npx,  j)*q(npx+1,j))/(dxa(npx,  j)+dxa(npx+1,j)))
!             al(npx+1,j) = c3*q(npx,j) + c2*q(npx+1,j) + c1*q(npx+2,j)
!          enddo
!          if(iord==-7) then
!             do j=jfirst,jlast
!                al(npx-1,j) = max(0., al(npx-1,j))
!                al(npx,  j) = max(0., al(npx  ,j))
!                al(npx+1,j) = max(0., al(npx+1,j))
!             enddo
!          endif
!       endif
!    endif
!
!    if ( iord==-5 ) then
!       do j=jfirst,jlast
!          do i=ifirst-1,ilast+1
!             bl(i,j) = al(i,j)   - q(i,j)
!             br(i,j) = al(i+1,j) - q(i,j)
!          enddo
!       enddo
!    else
!       do j=jfirst,jlast
!          do i=ifirst-3,ilast+2
!             dq(i,j) = q(i+1,j) - q(i,j)
!          enddo
!       enddo
!       do j=jfirst,jlast
!          do i=ifirst-2, ilast+2
!             if ( dq(i-1,j)*dq(i,j) > 0. ) then
!                extm(i,j) = .false.
!             else
!                extm(i,j) = .true.
!             endif
!          enddo
!       enddo
!       do j=jfirst,jlast
!          do i=ifirst-1,ilast+1
!             if ( extm(i-1,j).and.extm(i,j).and.extm(i+1,j) ) then
!                bl(i,j) = 0.
!                br(i,j) = 0.
!             else
!                bl(i,j) = al(i,j)   - q(i,j)
!                br(i,j) = al(i+1,j) - q(i,j)
!             endif
!          enddo
!       enddo
!       ! Additional positive definite constraint:
!       if(iord==-7) call pert_ppm(ilast-ifirst+3, q(ifirst-1,j), bl(ifirst-1,j), br(ifirst-1,j), 0)
!    endif
! else
!
!! Monotonic constraints:
!! ord = 8: PPM with Lin's PPM fast monotone constraint
!! ord = 10: PPM with Lin's modification of Huynh 2nd constraint
!! ord = 13: 10 plus positive definite constraint
!    do j=jfirst,jlast
!!DEC$ VECTOR ALWAYS
!       do i=is-2,ie+2
!          xt = 0.25*(q(i+1,j) - q(i-1,j))
!          dm(i,j) = sign(min(abs(xt), max(q(i-1,j), q(i,j), q(i+1,j)) - q(i,j),  &
!               q(i,j) - min(q(i-1,j), q(i,j), q(i+1,j))), xt)
!       enddo
!    enddo
!    do j=jfirst,jlast
!!DEC$ VECTOR ALWAYS
!       do i=is1,ie1+1
!          al(i,j) = 0.5*(q(i-1,j)+q(i,j)) + r3*(dm(i-1,j)-dm(i,j))
!       enddo
!    enddo
!    if ( iord==-8 ) then
!       do j=jfirst,jlast
!!DEC$ VECTOR ALWAYS
!          do i=is1, ie1
!             xt = 2.*dm(i,j)
!             bl(i,j) = -sign(min(abs(xt), abs(al(i,j  )-q(i,j))), xt)
!             br(i,j) =  sign(min(abs(xt), abs(al(i+1,j)-q(i,j))), xt)
!          enddo
!       enddo
!    else
!       do j=jfirst,jlast
!          do i=is1-2, ie1+1
!             dq(i,j) = q(i+1,j) - q(i,j)
!          enddo
!       enddo
!       do j=jfirst,jlast
!          do i=is1, ie1
!             bl(i,j) = al(i,j  ) - q(i,j)
!             br(i,j) = al(i+1,j) - q(i,j)
!             if ( abs(dm(i-1,j))+abs(dm(i,j))+abs(dm(i+1,j)) < near_zero ) then
!                bl(i,j) = 0.
!                br(i,j) = 0.
!             elseif( abs(3.*(bl(i,j)+br(i,j))) > abs(bl(i,j)-br(i,j)) ) then
!                pmp_1 = -(dq(i,j) + dq(i,j))
!                lac_1 = pmp_1 + 1.5*dq(i+1,j)
!                bl(i,j) = min( max(0., pmp_1, lac_1), max(bl(i,j), min(0., pmp_1, lac_1)) )
!                pmp_2 = dq(i-1,j) + dq(i-1,j)
!                lac_2 = pmp_2 - 1.5*dq(i-2,j)
!                br(i,j) = min( max(0., pmp_2, lac_2), max(br(i,j), min(0., pmp_2, lac_2)) )
!             endif
!          enddo
!       enddo
!    endif
!    ! Positive definite constraint:
!    if(iord==-9 .or. iord==-13) call pert_ppm(ie1-is1+1, q(is1,j), bl(is1,j), br(is1,j), 0)
!
!    if (.not. nested .and. grid_type<3) then
!       if ( is==1 ) then
!          do j=jfirst,jlast
!             bl_tmp(3*j) = s14*dm(-1,j) + s11*(q(-1,j)-q(0,j))
!
!             xt = 0.5*(((2.*dxa(0,j)+dxa(-1,j))*q(0,j)-dxa(0,j)*q(-1,j))/(dxa(-1,j)+dxa(0,j)) &
!                  +      ((2.*dxa(1,j)+dxa( 2,j))*q(1,j)-dxa(1,j)*q(2,j))/(dxa(1, j)+dxa(2,j)))
!             br_tmp(3*j) = xt - q(0,j)
!             bl_tmp(3*j+1) = xt - q(1,j)
!             xt = s15*q(1,j) + s11*q(2,j) - s14*dm(2,j)
!             br_tmp(3*j+1) = xt - q(1,j)
!             bl_tmp(3*j+2) = xt - q(2,j)
!             br_tmp(3*j+2) = al(3,j) - q(2,j)
!             q_tmp(j*3:j*3+2) = q(0:2,j)
!          enddo
!          call pert_ppm(3*(jlast-jfirst+1), q_tmp, bl_tmp, br_tmp, 1)
!          do j=jfirst,jlast
!             bl(0:2,j) = bl_tmp(j*3:j*3+2)
!             br(0:2,j) = br_tmp(j*3:j*3+2)
!          enddo
!      endif
!      if ( (ie+1)==npx ) then
!         do j=jfirst,jlast
!            bl_tmp(3*j) = al(npx-2,j) - q(npx-2,j)
!
!            xt = s15*q(npx-1,j) + s11*q(npx-2,j) + s14*dm(npx-2,j)
!            br_tmp(3*j) = xt - q(npx-2,j)
!            bl_tmp(3*j+1) = xt - q(npx-1,j)
!
!            xt = 0.5*(((2.*dxa(npx-1,j)+dxa(npx-2,j))*q(npx-1,j)-dxa(npx-1,j)*q(npx-2,j))/(dxa(npx-2,j)+dxa(npx-1,j)) &
!               +      ((2.*dxa(npx,  j)+dxa(npx+1,j))*q(npx,j  )-dxa(npx,  j)*q(npx+1,j))/(dxa(npx,  j)+dxa(npx+1,j)))
!            br_tmp(3*j+1) = xt - q(npx-1,j)
!            bl_tmp(3*j+2) = xt - q(npx,j  )
!
!            br_tmp(3*j+2) = s11*(q(npx+1,j)-q(npx,j)) - s14*dm(npx+1,j)
!            q_tmp(j*3:j*3+2) = q(npx-2:npx,j)
!         enddo
!         call pert_ppm(3*(jlast-jfirst+1), q_tmp, bl_tmp, br_tmp, 1)
!
!         do j=jfirst,jlast
!            bl(npx-2:npx,j) = bl_tmp(j*3:j*3+2)
!            br(npx-2:npx,j) = br_tmp(j*3:j*3+2)
!         enddo
!      endif
!    endif
!
!  endif
!
!  do j=jfirst,jlast
!!DEC$ VECTOR ALWAYS
!     do i=ifirst,ilast+1
!        if( c(i,j)>0. ) then
!           flux(i,j) = q(i-1,j) + (1.-c(i,j))*(br(i-1,j)-c(i,j)*(bl(i-1,j)+br(i-1,j)))
!        else
!           flux(i,j) = q(i,j  ) + (1.+c(i,j))*(bl(i,j  )+c(i,j)*(bl(i,j  )+br(i,j  )))
!        endif
!     enddo
!  enddo
!
! end subroutine xppm0
!#else
  SUBROUTINE XPPM0(flux, q, c, iord, ifirst, ilast, jfirst, jlast, npx, &
&   npy, bd, dxa, nested, grid_type)
    IMPLICIT NONE
    TYPE(FV_GRID_BOUNDS_TYPE), INTENT(IN) :: bd
!  X-Dir strip
    INTEGER, INTENT(IN) :: ifirst, ilast
!  Y-Dir strip
    INTEGER, INTENT(IN) :: jfirst, jlast
    INTEGER, INTENT(IN) :: iord
    INTEGER, INTENT(IN) :: npx, npy
    REAL(fvprc), INTENT(IN) :: q(ifirst-ng:ilast+ng, jfirst:jlast)
! Courant   N (like FLUX)
    REAL(fvprc), INTENT(IN) :: c(ifirst:ilast+1, jfirst:jlast)
    REAL(fvprc), INTENT(IN) :: dxa(bd%isd:bd%ied, bd%jsd:bd%jed)
    LOGICAL, INTENT(IN) :: nested
    INTEGER, INTENT(IN) :: grid_type
! !OUTPUT PARAMETERS:
!  Flux
    REAL(fvprc), INTENT(OUT) :: flux(ifirst:ilast+1, jfirst:jlast)
! Local
    REAL(fvprc), DIMENSION(ifirst-ng:ilast+ng) :: q1
    REAL(fvprc), DIMENSION(ifirst-1:ilast+1) :: bl, br
    REAL(fvprc) :: al(ifirst-1:ilast+2)
    REAL(fvprc) :: dm(ifirst-2:ilast+2)
    REAL(fvprc) :: dq(ifirst-3:ilast+2)
    LOGICAL :: extm(ifirst-2:ilast+2)
    INTEGER :: i, j, ie3, is1, ie1
    REAL(fvprc) :: xt, pmp_1, lac_1, pmp_2, lac_2
    INTEGER :: is, ie, js, je, isd, ied, jsd, jed
    INTRINSIC MAX
    INTRINSIC MIN
    INTRINSIC ABS
    INTRINSIC SIGN
    INTEGER :: abs0
    REAL(fvprc) :: min1
    REAL(fvprc) :: min2
    REAL(fvprc) :: min3
    REAL(fvprc) :: abs1
    REAL(fvprc) :: abs2
    REAL(fvprc) :: max1
    REAL(fvprc) :: min4
    REAL(fvprc) :: abs3
    REAL(fvprc) :: abs4
    REAL(fvprc) :: abs5
    INTEGER :: arg1
    REAL(fvprc) :: x5
    REAL(fvprc) :: x4
    REAL(fvprc) :: x3
    REAL(fvprc) :: x2
    REAL(fvprc) :: x1
    REAL(fvprc) :: z1
    REAL(fvprc) :: y7
    REAL(fvprc) :: y6
    REAL(fvprc) :: y5
    REAL(fvprc) :: y4
    REAL(fvprc) :: y3
    REAL(fvprc) :: y2
    REAL(fvprc) :: y1
    is = bd%is
    ie = bd%ie
    js = bd%js
    je = bd%je
    isd = bd%isd
    ied = bd%ied
    jsd = bd%jsd
    jed = bd%jed
    IF (.NOT.nested .AND. grid_type .LT. 3) THEN
      IF (3 .LT. is - 1) THEN
        is1 = is - 1
      ELSE
        is1 = 3
      END IF
      IF (npx - 2 .GT. ie + 2) THEN
        ie3 = ie + 2
      ELSE
        ie3 = npx - 2
      END IF
      IF (npx - 3 .GT. ie + 1) THEN
        ie1 = ie + 1
      ELSE
        ie1 = npx - 3
      END IF
    ELSE
      is1 = is - 1
      ie3 = ie + 2
      ie1 = ie + 1
    END IF
    DO j=jfirst,jlast
      DO i=ifirst-ng,ilast+ng
        q1(i) = q(i, j)
      END DO
      IF (iord .GE. 0.) THEN
        abs0 = iord
      ELSE
        abs0 = -iord
      END IF
      IF (abs0 .LT. 8) THEN
! ord = -5: linear scheme based on PPM 4th order interpolation
! ord = -6: linear PPM with 2-delta filter
! ord = -7: (-6) with additional Positive definite constraint:
        DO i=is1,ie3
          al(i) = p1*(q1(i-1)+q1(i)) + p2*(q1(i-2)+q1(i+1))
        END DO
        IF (.NOT.nested .AND. grid_type .LT. 3) THEN
          IF (is .EQ. 1) THEN
            al(0) = c1*q1(-2) + c2*q1(-1) + c3*q1(0)
            al(1) = 0.5*(((2.*dxa(0, j)+dxa(-1, j))*q1(0)-dxa(0, j)*q1(-&
&             1))/(dxa(-1, j)+dxa(0, j))+((2.*dxa(1, j)+dxa(2, j))*q1(1)&
&             -dxa(1, j)*q1(2))/(dxa(1, j)+dxa(2, j)))
            al(2) = c3*q1(1) + c2*q1(2) + c1*q1(3)
            IF (iord .EQ. -7) THEN
              IF (0. .LT. al(0)) THEN
                al(0) = al(0)
              ELSE
                al(0) = 0.
              END IF
              IF (0. .LT. al(1)) THEN
                al(1) = al(1)
              ELSE
                al(1) = 0.
              END IF
              IF (0. .LT. al(2)) THEN
                al(2) = al(2)
              ELSE
                al(2) = 0.
              END IF
            END IF
          END IF
          IF (ie + 1 .EQ. npx) THEN
            al(npx-1) = c1*q1(npx-3) + c2*q1(npx-2) + c3*q1(npx-1)
            al(npx) = 0.5*(((2.*dxa(npx-1, j)+dxa(npx-2, j))*q1(npx-1)-&
&             dxa(npx-1, j)*q1(npx-2))/(dxa(npx-2, j)+dxa(npx-1, j))+((&
&             2.*dxa(npx, j)+dxa(npx+1, j))*q1(npx)-dxa(npx, j)*q1(npx+1&
&             ))/(dxa(npx, j)+dxa(npx+1, j)))
            al(npx+1) = c3*q1(npx) + c2*q1(npx+1) + c1*q1(npx+2)
            IF (iord .EQ. -7) THEN
              IF (0. .LT. al(npx-1)) THEN
                al(npx-1) = al(npx-1)
              ELSE
                al(npx-1) = 0.
              END IF
              IF (0. .LT. al(npx)) THEN
                al(npx) = al(npx)
              ELSE
                al(npx) = 0.
              END IF
              IF (0. .LT. al(npx+1)) THEN
                al(npx+1) = al(npx+1)
              ELSE
                al(npx+1) = 0.
              END IF
            END IF
          END IF
        END IF
        IF (iord .EQ. -5) THEN
          DO i=ifirst-1,ilast+1
            bl(i) = al(i) - q1(i)
            br(i) = al(i+1) - q1(i)
          END DO
        ELSE
          DO i=ifirst-3,ilast+2
            dq(i) = q1(i+1) - q1(i)
          END DO
          DO i=ifirst-2,ilast+2
            IF (dq(i-1)*dq(i) .GT. 0.) THEN
              extm(i) = .false.
            ELSE
              extm(i) = .true.
            END IF
          END DO
          DO i=ifirst-1,ilast+1
            IF (extm(i-1) .AND. extm(i) .AND. extm(i+1)) THEN
              bl(i) = 0.
              br(i) = 0.
            ELSE
              bl(i) = al(i) - q1(i)
              br(i) = al(i+1) - q1(i)
            END IF
          END DO
! Additional positive definite constraint:
          IF (iord .EQ. -7) THEN
            arg1 = ilast - ifirst + 3
            CALL PERT_PPM(arg1, q1(ifirst-1), bl(ifirst-1), br(ifirst-1)&
&                   , 0)
          END IF
        END IF
      ELSE
! Monotonic constraints:
! ord = 8: PPM with Lin's PPM fast monotone constraint
! ord = 10: PPM with Lin's modification of Huynh 2nd constraint
! ord = 13: 10 plus positive definite constraint
        DO i=is-2,ie+2
          xt = 0.25*(q1(i+1)-q1(i-1))
          IF (xt .GE. 0.) THEN
            x1 = xt
          ELSE
            x1 = -xt
          END IF
          IF (q1(i-1) .LT. q1(i)) THEN
            IF (q1(i) .LT. q1(i+1)) THEN
              max1 = q1(i+1)
            ELSE
              max1 = q1(i)
            END IF
          ELSE IF (q1(i-1) .LT. q1(i+1)) THEN
            max1 = q1(i+1)
          ELSE
            max1 = q1(i-1)
          END IF
          y1 = max1 - q1(i)
          IF (q1(i-1) .GT. q1(i)) THEN
            IF (q1(i) .GT. q1(i+1)) THEN
              min4 = q1(i+1)
            ELSE
              min4 = q1(i)
            END IF
          ELSE IF (q1(i-1) .GT. q1(i+1)) THEN
            min4 = q1(i+1)
          ELSE
            min4 = q1(i-1)
          END IF
          z1 = q1(i) - min4
          IF (x1 .GT. y1) THEN
            IF (y1 .GT. z1) THEN
              min1 = z1
            ELSE
              min1 = y1
            END IF
          ELSE IF (x1 .GT. z1) THEN
            min1 = z1
          ELSE
            min1 = x1
          END IF
          dm(i) = SIGN(min1, xt)
        END DO
        DO i=is1,ie1+1
          al(i) = 0.5*(q1(i-1)+q1(i)) + r3*(dm(i-1)-dm(i))
        END DO
        IF (iord .EQ. -8) THEN
          DO i=is1,ie1
            xt = 2.*dm(i)
            IF (xt .GE. 0.) THEN
              x2 = xt
            ELSE
              x2 = -xt
            END IF
            IF (al(i) - q1(i) .GE. 0.) THEN
              y2 = al(i) - q1(i)
            ELSE
              y2 = -(al(i)-q1(i))
            END IF
            IF (x2 .GT. y2) THEN
              min2 = y2
            ELSE
              min2 = x2
            END IF
            bl(i) = -SIGN(min2, xt)
            IF (xt .GE. 0.) THEN
              x3 = xt
            ELSE
              x3 = -xt
            END IF
            IF (al(i+1) - q1(i) .GE. 0.) THEN
              y3 = al(i+1) - q1(i)
            ELSE
              y3 = -(al(i+1)-q1(i))
            END IF
            IF (x3 .GT. y3) THEN
              min3 = y3
            ELSE
              min3 = x3
            END IF
            br(i) = SIGN(min3, xt)
          END DO
        ELSE
          DO i=is1-2,ie1+1
            dq(i) = q1(i+1) - q1(i)
          END DO
          DO i=is1,ie1
            bl(i) = al(i) - q1(i)
            br(i) = al(i+1) - q1(i)
            IF (dm(i-1) .GE. 0.) THEN
              abs1 = dm(i-1)
            ELSE
              abs1 = -dm(i-1)
            END IF
            IF (dm(i) .GE. 0.) THEN
              abs3 = dm(i)
            ELSE
              abs3 = -dm(i)
            END IF
            IF (dm(i+1) .GE. 0.) THEN
              abs5 = dm(i+1)
            ELSE
              abs5 = -dm(i+1)
            END IF
            IF (abs1 + abs3 + abs5 .LT. near_zero) THEN
              bl(i) = 0.
              br(i) = 0.
            ELSE
              IF (3.*(bl(i)+br(i)) .GE. 0.) THEN
                abs2 = 3.*(bl(i)+br(i))
              ELSE
                abs2 = -(3.*(bl(i)+br(i)))
              END IF
              IF (bl(i) - br(i) .GE. 0.) THEN
                abs4 = bl(i) - br(i)
              ELSE
                abs4 = -(bl(i)-br(i))
              END IF
              IF (abs2 .GT. abs4) THEN
                pmp_1 = -(dq(i)+dq(i))
                lac_1 = pmp_1 + 1.5*dq(i+1)
                IF (0. .LT. pmp_1) THEN
                  IF (pmp_1 .LT. lac_1) THEN
                    x4 = lac_1
                  ELSE
                    x4 = pmp_1
                  END IF
                ELSE IF (0. .LT. lac_1) THEN
                  x4 = lac_1
                ELSE
                  x4 = 0.
                END IF
                IF (0. .GT. pmp_1) THEN
                  IF (pmp_1 .GT. lac_1) THEN
                    y6 = lac_1
                  ELSE
                    y6 = pmp_1
                  END IF
                ELSE IF (0. .GT. lac_1) THEN
                  y6 = lac_1
                ELSE
                  y6 = 0.
                END IF
                IF (bl(i) .LT. y6) THEN
                  y4 = y6
                ELSE
                  y4 = bl(i)
                END IF
                IF (x4 .GT. y4) THEN
                  bl(i) = y4
                ELSE
                  bl(i) = x4
                END IF
                pmp_2 = dq(i-1) + dq(i-1)
                lac_2 = pmp_2 - 1.5*dq(i-2)
                IF (0. .LT. pmp_2) THEN
                  IF (pmp_2 .LT. lac_2) THEN
                    x5 = lac_2
                  ELSE
                    x5 = pmp_2
                  END IF
                ELSE IF (0. .LT. lac_2) THEN
                  x5 = lac_2
                ELSE
                  x5 = 0.
                END IF
                IF (0. .GT. pmp_2) THEN
                  IF (pmp_2 .GT. lac_2) THEN
                    y7 = lac_2
                  ELSE
                    y7 = pmp_2
                  END IF
                ELSE IF (0. .GT. lac_2) THEN
                  y7 = lac_2
                ELSE
                  y7 = 0.
                END IF
                IF (br(i) .LT. y7) THEN
                  y5 = y7
                ELSE
                  y5 = br(i)
                END IF
                IF (x5 .GT. y5) THEN
                  br(i) = y5
                ELSE
                  br(i) = x5
                END IF
              END IF
            END IF
          END DO
        END IF
! Positive definite constraint:
        IF (iord .EQ. -9 .OR. iord .EQ. -13) THEN
          arg1 = ie1 - is1 + 1
          CALL PERT_PPM(arg1, q1(is1), bl(is1), br(is1), 0)
        END IF
        IF (.NOT.nested .AND. grid_type .LT. 3) THEN
          IF (is .EQ. 1) THEN
            bl(0) = s14*dm(-1) + s11*(q1(-1)-q1(0))
            xt = 0.5*(((2.*dxa(0, j)+dxa(-1, j))*q1(0)-dxa(0, j)*q1(-1))&
&             /(dxa(-1, j)+dxa(0, j))+((2.*dxa(1, j)+dxa(2, j))*q1(1)-&
&             dxa(1, j)*q1(2))/(dxa(1, j)+dxa(2, j)))
            br(0) = xt - q1(0)
            bl(1) = xt - q1(1)
            xt = s15*q1(1) + s11*q1(2) - s14*dm(2)
            br(1) = xt - q1(1)
            bl(2) = xt - q1(2)
            br(2) = al(3) - q1(2)
            CALL PERT_PPM(3, q1(0), bl(0), br(0), 1)
          END IF
          IF (ie + 1 .EQ. npx) THEN
            bl(npx-2) = al(npx-2) - q1(npx-2)
            xt = s15*q1(npx-1) + s11*q1(npx-2) + s14*dm(npx-2)
            br(npx-2) = xt - q1(npx-2)
            bl(npx-1) = xt - q1(npx-1)
            xt = 0.5*(((2.*dxa(npx-1, j)+dxa(npx-2, j))*q1(npx-1)-dxa(&
&             npx-1, j)*q1(npx-2))/(dxa(npx-2, j)+dxa(npx-1, j))+((2.*&
&             dxa(npx, j)+dxa(npx+1, j))*q1(npx)-dxa(npx, j)*q1(npx+1))/&
&             (dxa(npx, j)+dxa(npx+1, j)))
            br(npx-1) = xt - q1(npx-1)
            bl(npx) = xt - q1(npx)
            br(npx) = s11*(q1(npx+1)-q1(npx)) - s14*dm(npx+1)
            CALL PERT_PPM(3, q1(npx-2), bl(npx-2), br(npx-2), 1)
          END IF
        END IF
      END IF
      DO i=ifirst,ilast+1
        IF (c(i, j) .GT. 0.) THEN
          flux(i, j) = q1(i-1) + (1.-c(i, j))*(br(i-1)-c(i, j)*(bl(i-1)+&
&           br(i-1)))
        ELSE
          flux(i, j) = q1(i) + (1.+c(i, j))*(bl(i)+c(i, j)*(bl(i)+br(i))&
&           )
        END IF
      END DO
    END DO
  END SUBROUTINE XPPM0
!  Differentiation of yppm0 in reverse (adjoint) mode (with options r8 split(a2b_edge_mod.a2b_ord2 a2b_edge_mod.a2b_ord4 a2b_e
!dge_mod.extrap_corner  dyn_core_mod.dyn_core dyn_core_mod.pk3_halo dyn_core_mod.pln_halo dyn_core_mod.pe_halo dyn_core_mod.ad
!v_pe dyn_core_mod.p_grad_c dyn_core_mod.nh_p_grad dyn_core_mod.split_p_grad dyn_core_mod.one_grad_p dyn_core_mod.grad1_p_update 
!dyn_core_mod.mix_dp dyn_core_mod.geopk dyn_core_mod.del2_cubed fv_dynamics_mod.fv_dynamics fv_dynamics_mod.rayleigh_super fv_dyn
!amics_mod.rayleigh_friction fv_dynamics_mod.compute_aam fv_dynamics_mod.geos_to_fv3 fv_grid_utils_mod.cubed_to_latlon fv_grid_ut
!ils_mod.c2l_ord4 fv_grid_utils_mod.c2l_ord2 fv_mapz_mod.lagrangian_to_eulerian fv_mapz_mod.compute_total_energy fv_mapz_mod.pkez
! fv_mapz_mod.remap_z fv_mapz_mod.map_scalar fv_mapz_mod.map1_ppm fv_mapz_mod.mapn_tracer fv_mapz_mod.map1_q2 fv_m
!apz_mod.map1_cubic fv_mapz_mod.scalar_profile_linear fv_mapz_mod.cs_profile_linear fv_mapz_mod.steepz fv_tracer2d_mod.trac
!er_2d fv_tracer2d_mod.tracer_2d_nested nh_core_mod.update_dz_c nh_core_mod.update_dz_d nh_core_mod.riem_solver_c nh_core_mod.rie
!m_solver3 nh_core_mod.rim_2d nh_core_mod.sim3_solver nh_core_mod.sim3p0_solver nh_core_mod.sim1_solver nh_core_mod.sim_solver nh
!_core_mod.edge_profile sw_core_mod.c_sw sw_core_mod.d_sw sw_core_mod.divergence_corner sw_core_mod.divergence_corner_nest sw_cor
!e_mod.d2a2c_vect sw_core_mod.edge_interpolate4 sw_core_mod.fill2_4corners sw_core_mod.fill_4corners sw_core_mod.compute_div_damp
!ing_fb sw_core_mod.smag_corner sw_core_mod.ytp_v sw_core_mod.xtp_u tp_core_mod.fv_tp_2d tp_core_mod.copy_corners 
!tp_core_mod.xtp tp_core_mod.ytp tp_core_mod.xppm0 tp_core_mod.yppm0 tp_core_mod.fxppm tp_core_mod.fyppm tp_cor
!e_mod.deln_flux)):
!   gradient     of useful results: q flux c
!   with respect to varying inputs: q flux c
!#endif
  SUBROUTINE YPPM0_ADM(flux, flux_ad, q, q_ad, c, c_ad, jord, ifirst, &
&   ilast, jfirst, jlast, npx, npy, bd, dya, nested, grid_type)
    IMPLICIT NONE
    TYPE(FV_GRID_BOUNDS_TYPE), INTENT(IN) :: bd
!  X-Dir strip
    INTEGER, INTENT(IN) :: ifirst, ilast
!  Y-Dir strip
    INTEGER, INTENT(IN) :: jfirst, jlast
    INTEGER, INTENT(IN) :: jord
    INTEGER, INTENT(IN) :: npx, npy
    REAL(fvprc), INTENT(IN) :: q(ifirst:ilast, jfirst-ng:jlast+ng)
    REAL(fvprc) :: q_ad(ifirst:ilast, jfirst-ng:jlast+ng)
! Courant number
    REAL(fvprc), INTENT(IN) :: c(bd%isd:bd%ied, bd%js:bd%je+1)
    REAL(fvprc) :: c_ad(bd%isd:bd%ied, bd%js:bd%je+1)
!  Flux
    REAL(fvprc) :: flux(ifirst:ilast, jfirst:jlast+1)
    REAL(fvprc) :: flux_ad(ifirst:ilast, jfirst:jlast+1)
    REAL(fvprc), INTENT(IN) :: dya(bd%isd:bd%ied, bd%jsd:bd%jed)
    LOGICAL, INTENT(IN) :: nested
    INTEGER, INTENT(IN) :: grid_type
! Local:
    REAL(fvprc) :: dm(ifirst:ilast, jfirst-2:jlast+2)
    REAL(fvprc) :: dm_ad(ifirst:ilast, jfirst-2:jlast+2)
    REAL(fvprc) :: al(ifirst:ilast, jfirst-1:jlast+2)
    REAL(fvprc) :: al_ad(ifirst:ilast, jfirst-1:jlast+2)
    REAL(fvprc) :: bl(ifirst:ilast, jfirst-1:jlast+1)
    REAL(fvprc) :: bl_ad(ifirst:ilast, jfirst-1:jlast+1)
    REAL(fvprc) :: br(ifirst:ilast, jfirst-1:jlast+1)
    REAL(fvprc) :: br_ad(ifirst:ilast, jfirst-1:jlast+1)
    REAL(fvprc) :: dq(ifirst:ilast, jfirst-3:jlast+2)
    REAL(fvprc) :: dq_ad(ifirst:ilast, jfirst-3:jlast+2)
    LOGICAL :: extm(ifirst:ilast, jfirst-2:jlast+2)
    REAL(fvprc) :: xt, pmp_1, lac_1, pmp_2, lac_2
    REAL(fvprc) :: xt_ad, pmp_1_ad, lac_1_ad, pmp_2_ad, lac_2_ad
    INTEGER :: i, j, js1, je3, je1
    INTEGER :: is, ie, js, je, isd, ied, jsd, jed
    INTRINSIC MAX
    INTRINSIC MIN
    INTRINSIC ABS
    INTRINSIC SIGN
    INTEGER :: abs0
    REAL(fvprc) :: min1
    REAL(fvprc) :: min1_ad
    REAL(fvprc) :: min2
    REAL(fvprc) :: min2_ad
    REAL(fvprc) :: min3
    REAL(fvprc) :: min3_ad
    REAL(fvprc) :: abs1
    REAL(fvprc) :: abs2
    REAL(fvprc) :: max1
    REAL(fvprc) :: max1_ad
    REAL(fvprc) :: min4
    REAL(fvprc) :: min4_ad
    REAL(fvprc) :: abs3
    REAL(fvprc) :: abs4
    REAL(fvprc) :: abs5
    INTEGER :: arg1
    REAL(fvprc) :: temp_ad
    REAL(fvprc) :: temp_ad0
    REAL(fvprc) :: temp_ad1
    REAL(fvprc) :: temp_ad2
    REAL(fvprc) :: x1_ad
    REAL(fvprc) :: y1_ad
    REAL(fvprc) :: z1_ad
    REAL(fvprc) :: x2_ad
    REAL(fvprc) :: y2_ad
    REAL(fvprc) :: x3_ad
    REAL(fvprc) :: y3_ad
    REAL(fvprc) :: x4_ad
    REAL(fvprc) :: y6_ad
    REAL(fvprc) :: y4_ad
    REAL(fvprc) :: x5_ad
    REAL(fvprc) :: y7_ad
    REAL(fvprc) :: y5_ad
    REAL(fvprc) :: temp_ad3
    REAL(fvprc) :: temp_ad4
    REAL(fvprc) :: temp_ad5
    REAL(fvprc) :: temp_ad6
    REAL(fvprc) :: temp
    REAL(fvprc) :: temp_ad7
    REAL(fvprc) :: temp_ad8
    REAL(fvprc) :: temp0
    REAL(fvprc) :: temp_ad9
    REAL(fvprc) :: temp_ad10
    INTEGER :: branch
    REAL(fvprc) :: x5
    REAL(fvprc) :: x4
    REAL(fvprc) :: x3
    REAL(fvprc) :: x2
    REAL(fvprc) :: x1
    REAL(fvprc) :: z1
    REAL(fvprc) :: y7
    REAL(fvprc) :: y6
    REAL(fvprc) :: y5
    REAL(fvprc) :: y4
    REAL(fvprc) :: y3
    REAL(fvprc) :: y2
    REAL(fvprc) :: y1
    js = bd%js
    je = bd%je
    IF (.NOT.nested .AND. grid_type .LT. 3) THEN
      IF (3 .LT. js - 1) THEN
        js1 = js - 1
      ELSE
        js1 = 3
      END IF
      IF (npy - 2 .GT. je + 2) THEN
        je3 = je + 2
      ELSE
        je3 = npy - 2
      END IF
      IF (npy - 3 .GT. je + 1) THEN
        CALL PUSHCONTROL1B(1)
        je1 = je + 1
      ELSE
        CALL PUSHCONTROL1B(1)
        je1 = npy - 3
      END IF
    ELSE
      CALL PUSHCONTROL1B(0)
! Nested grid OR Doubly periodic domain:
      js1 = js - 1
      je3 = je + 2
      je1 = je + 1
    END IF
    IF (jord .GE. 0.) THEN
      abs0 = jord
    ELSE
      abs0 = -jord
    END IF
    IF (abs0 .LT. 8) THEN
! ord = -5: linear scheme based on PPM 4th order interpolation
! ord = -6: linear PPM with 2-delta filter
! ord = -7: (-6) with additional Positive definite constraint:
      DO j=js1,je3
        DO i=ifirst,ilast
          al(i, j) = p1*(q(i, j-1)+q(i, j)) + p2*(q(i, j-2)+q(i, j+1))
        END DO
      END DO
      IF (.NOT.nested .AND. grid_type .LT. 3) THEN
        IF (js .EQ. 1) THEN
          DO i=ifirst,ilast
            al(i, 0) = c1*q(i, -2) + c2*q(i, -1) + c3*q(i, 0)
            al(i, 1) = 0.5*(((2.*dya(i, 0)+dya(i, -1))*q(i, 0)-dya(i, 0)&
&             *q(i, -1))/(dya(i, -1)+dya(i, 0))+((2.*dya(i, 1)+dya(i, 2)&
&             )*q(i, 1)-dya(i, 1)*q(i, 2))/(dya(i, 1)+dya(i, 2)))
            al(i, 2) = c3*q(i, 1) + c2*q(i, 2) + c1*q(i, 3)
          END DO
          IF (jord .EQ. -7) THEN
            DO i=ifirst,ilast
              IF (0. .LT. al(i, 0)) THEN
                CALL PUSHCONTROL1B(0)
                al(i, 0) = al(i, 0)
              ELSE
                al(i, 0) = 0.
                CALL PUSHCONTROL1B(1)
              END IF
              IF (0. .LT. al(i, 1)) THEN
                CALL PUSHCONTROL1B(0)
                al(i, 1) = al(i, 1)
              ELSE
                al(i, 1) = 0.
                CALL PUSHCONTROL1B(1)
              END IF
              IF (0. .LT. al(i, 2)) THEN
                CALL PUSHCONTROL1B(0)
                al(i, 2) = al(i, 2)
              ELSE
                al(i, 2) = 0.
                CALL PUSHCONTROL1B(1)
              END IF
            END DO
            CALL PUSHCONTROL2B(0)
          ELSE
            CALL PUSHCONTROL2B(1)
          END IF
        ELSE
          CALL PUSHCONTROL2B(2)
        END IF
        IF (je + 1 .EQ. npy) THEN
          DO i=ifirst,ilast
            al(i, npy-1) = c1*q(i, npy-3) + c2*q(i, npy-2) + c3*q(i, npy&
&             -1)
            al(i, npy) = 0.5*(((2.*dya(i, npy-1)+dya(i, npy-2))*q(i, npy&
&             -1)-dya(i, npy-1)*q(i, npy-2))/(dya(i, npy-2)+dya(i, npy-1&
&             ))+((2.*dya(i, npy)+dya(i, npy+1))*q(i, npy)-dya(i, npy)*q&
&             (i, npy+1))/(dya(i, npy)+dya(i, npy+1)))
            al(i, npy+1) = c3*q(i, npy) + c2*q(i, npy+1) + c1*q(i, npy+2&
&             )
          END DO
          IF (jord .EQ. -7) THEN
            DO i=ifirst,ilast
              IF (0. .LT. al(i, npy-1)) THEN
                CALL PUSHCONTROL1B(0)
                al(i, npy-1) = al(i, npy-1)
              ELSE
                al(i, npy-1) = 0.
                CALL PUSHCONTROL1B(1)
              END IF
              IF (0. .LT. al(i, npy)) THEN
                CALL PUSHCONTROL1B(0)
                al(i, npy) = al(i, npy)
              ELSE
                al(i, npy) = 0.
                CALL PUSHCONTROL1B(1)
              END IF
              IF (0. .LT. al(i, npy+1)) THEN
                CALL PUSHCONTROL1B(0)
                al(i, npy+1) = al(i, npy+1)
              ELSE
                al(i, npy+1) = 0.
                CALL PUSHCONTROL1B(1)
              END IF
            END DO
            CALL PUSHCONTROL2B(0)
          ELSE
            CALL PUSHCONTROL2B(1)
          END IF
        ELSE
          CALL PUSHCONTROL2B(2)
        END IF
      ELSE
        CALL PUSHCONTROL2B(3)
      END IF
      IF (jord .EQ. -5) THEN
        DO j=jfirst-1,jlast+1
          DO i=ifirst,ilast
            bl(i, j) = al(i, j) - q(i, j)
            br(i, j) = al(i, j+1) - q(i, j)
          END DO
        END DO
        CALL PUSHCONTROL3B(5)
      ELSE
        DO j=jfirst-3,jlast+2
          DO i=ifirst,ilast
            dq(i, j) = q(i, j+1) - q(i, j)
          END DO
        END DO
        DO j=jfirst-2,jlast+2
          DO i=ifirst,ilast
            IF (dq(i, j-1)*dq(i, j) .GT. 0.) THEN
              CALL PUSHCONTROL1B(1)
              extm(i, j) = .false.
            ELSE
              CALL PUSHCONTROL1B(0)
              extm(i, j) = .true.
            END IF
          END DO
        END DO
        DO j=jfirst-1,jlast+1
          DO i=ifirst,ilast
            IF (extm(i, j-1) .AND. extm(i, j) .AND. extm(i, j+1)) THEN
              bl(i, j) = 0.
              br(i, j) = 0.
              CALL PUSHCONTROL1B(1)
            ELSE
              bl(i, j) = al(i, j) - q(i, j)
              br(i, j) = al(i, j+1) - q(i, j)
              CALL PUSHCONTROL1B(0)
            END IF
          END DO
        END DO
! Additional positive definite constraint:
        IF (jord .EQ. -7) THEN
          DO j=jfirst-1,jlast+1
            arg1 = ilast - ifirst + 1
            CALL PUSHREALARRAY_ADM(br(ifirst, j), 8*(ilast-ifirst+1)/8)
            CALL PUSHREALARRAY_ADM(bl(ifirst, j), 8*(ilast-ifirst+1)/8)
            CALL PERT_PPM(arg1, q(ifirst, j), bl(ifirst, j), br(ifirst, &
&                   j), 0)
          END DO
          CALL PUSHCONTROL3B(4)
        ELSE
          CALL PUSHCONTROL3B(3)
        END IF
      END IF
    ELSE
! Monotonic constraints:
! ord = 8: PPM with Lin's PPM fast monotone constraint
! ord > 8: PPM with Lin's modification of Huynh 2nd constraint
      DO j=js-2,je+2
        DO i=ifirst,ilast
          xt = 0.25*(q(i, j+1)-q(i, j-1))
          IF (xt .GE. 0.) THEN
            x1 = xt
            CALL PUSHCONTROL1B(0)
          ELSE
            x1 = -xt
            CALL PUSHCONTROL1B(1)
          END IF
          IF (q(i, j-1) .LT. q(i, j)) THEN
            IF (q(i, j) .LT. q(i, j+1)) THEN
              max1 = q(i, j+1)
              CALL PUSHCONTROL2B(0)
            ELSE
              max1 = q(i, j)
              CALL PUSHCONTROL2B(1)
            END IF
          ELSE IF (q(i, j-1) .LT. q(i, j+1)) THEN
            max1 = q(i, j+1)
            CALL PUSHCONTROL2B(2)
          ELSE
            max1 = q(i, j-1)
            CALL PUSHCONTROL2B(3)
          END IF
          y1 = max1 - q(i, j)
          IF (q(i, j-1) .GT. q(i, j)) THEN
            IF (q(i, j) .GT. q(i, j+1)) THEN
              min4 = q(i, j+1)
              CALL PUSHCONTROL2B(0)
            ELSE
              min4 = q(i, j)
              CALL PUSHCONTROL2B(1)
            END IF
          ELSE IF (q(i, j-1) .GT. q(i, j+1)) THEN
            min4 = q(i, j+1)
            CALL PUSHCONTROL2B(2)
          ELSE
            min4 = q(i, j-1)
            CALL PUSHCONTROL2B(3)
          END IF
          z1 = q(i, j) - min4
          IF (x1 .GT. y1) THEN
            IF (y1 .GT. z1) THEN
              CALL PUSHREALARRAY_ADM(min1)
              min1 = z1
              CALL PUSHCONTROL2B(0)
            ELSE
              CALL PUSHREALARRAY_ADM(min1)
              min1 = y1
              CALL PUSHCONTROL2B(1)
            END IF
          ELSE IF (x1 .GT. z1) THEN
            CALL PUSHREALARRAY_ADM(min1)
            min1 = z1
            CALL PUSHCONTROL2B(2)
          ELSE
            CALL PUSHREALARRAY_ADM(min1)
            min1 = x1
            CALL PUSHCONTROL2B(3)
          END IF
          dm(i, j) = SIGN(min1, xt)
        END DO
      END DO
      DO j=js1,je1+1
        DO i=ifirst,ilast
          al(i, j) = 0.5*(q(i, j-1)+q(i, j)) + r3*(dm(i, j-1)-dm(i, j))
        END DO
      END DO
      IF (jord .EQ. -8) THEN
        DO j=js1,je1
          DO i=ifirst,ilast
            xt = 2.*dm(i, j)
            IF (xt .GE. 0.) THEN
              x2 = xt
              CALL PUSHCONTROL1B(0)
            ELSE
              x2 = -xt
              CALL PUSHCONTROL1B(1)
            END IF
            IF (al(i, j) - q(i, j) .GE. 0.) THEN
              y2 = al(i, j) - q(i, j)
              CALL PUSHCONTROL1B(0)
            ELSE
              y2 = -(al(i, j)-q(i, j))
              CALL PUSHCONTROL1B(1)
            END IF
            IF (x2 .GT. y2) THEN
              CALL PUSHREALARRAY_ADM(min2)
              min2 = y2
              CALL PUSHCONTROL1B(0)
            ELSE
              CALL PUSHREALARRAY_ADM(min2)
              min2 = x2
              CALL PUSHCONTROL1B(1)
            END IF
            bl(i, j) = -SIGN(min2, xt)
            IF (xt .GE. 0.) THEN
              x3 = xt
              CALL PUSHCONTROL1B(0)
            ELSE
              x3 = -xt
              CALL PUSHCONTROL1B(1)
            END IF
            IF (al(i, j+1) - q(i, j) .GE. 0.) THEN
              y3 = al(i, j+1) - q(i, j)
              CALL PUSHCONTROL1B(0)
            ELSE
              y3 = -(al(i, j+1)-q(i, j))
              CALL PUSHCONTROL1B(1)
            END IF
            IF (x3 .GT. y3) THEN
              CALL PUSHREALARRAY_ADM(min3)
              min3 = y3
              CALL PUSHCONTROL1B(0)
            ELSE
              CALL PUSHREALARRAY_ADM(min3)
              min3 = x3
              CALL PUSHCONTROL1B(1)
            END IF
            br(i, j) = SIGN(min3, xt)
          END DO
        END DO
        CALL PUSHCONTROL1B(0)
      ELSE
        DO j=js1-2,je1+1
          DO i=ifirst,ilast
            dq(i, j) = q(i, j+1) - q(i, j)
          END DO
        END DO
        DO j=js1,je1
          DO i=ifirst,ilast
            bl(i, j) = al(i, j) - q(i, j)
            br(i, j) = al(i, j+1) - q(i, j)
            IF (dm(i, j-1) .GE. 0.) THEN
              abs1 = dm(i, j-1)
            ELSE
              abs1 = -dm(i, j-1)
            END IF
            IF (dm(i, j) .GE. 0.) THEN
              abs3 = dm(i, j)
            ELSE
              abs3 = -dm(i, j)
            END IF
            IF (dm(i, j+1) .GE. 0.) THEN
              abs5 = dm(i, j+1)
            ELSE
              abs5 = -dm(i, j+1)
            END IF
            IF (abs1 + abs3 + abs5 .LT. near_zero) THEN
              bl(i, j) = 0.
              br(i, j) = 0.
              CALL PUSHCONTROL2B(3)
            ELSE
              IF (3.*(bl(i, j)+br(i, j)) .GE. 0.) THEN
                abs2 = 3.*(bl(i, j)+br(i, j))
              ELSE
                abs2 = -(3.*(bl(i, j)+br(i, j)))
              END IF
              IF (bl(i, j) - br(i, j) .GE. 0.) THEN
                abs4 = bl(i, j) - br(i, j)
              ELSE
                abs4 = -(bl(i, j)-br(i, j))
              END IF
              IF (abs2 .GT. abs4) THEN
                pmp_1 = -(2.*dq(i, j))
                lac_1 = pmp_1 + 1.5*dq(i, j+1)
                IF (0. .LT. pmp_1) THEN
                  IF (pmp_1 .LT. lac_1) THEN
                    x4 = lac_1
                    CALL PUSHCONTROL2B(0)
                  ELSE
                    x4 = pmp_1
                    CALL PUSHCONTROL2B(1)
                  END IF
                ELSE IF (0. .LT. lac_1) THEN
                  x4 = lac_1
                  CALL PUSHCONTROL2B(2)
                ELSE
                  CALL PUSHCONTROL2B(3)
                  x4 = 0.
                END IF
                IF (0. .GT. pmp_1) THEN
                  IF (pmp_1 .GT. lac_1) THEN
                    y6 = lac_1
                    CALL PUSHCONTROL2B(0)
                  ELSE
                    y6 = pmp_1
                    CALL PUSHCONTROL2B(1)
                  END IF
                ELSE IF (0. .GT. lac_1) THEN
                  y6 = lac_1
                  CALL PUSHCONTROL2B(2)
                ELSE
                  y6 = 0.
                  CALL PUSHCONTROL2B(3)
                END IF
                IF (bl(i, j) .LT. y6) THEN
                  y4 = y6
                  CALL PUSHCONTROL1B(0)
                ELSE
                  y4 = bl(i, j)
                  CALL PUSHCONTROL1B(1)
                END IF
                IF (x4 .GT. y4) THEN
                  bl(i, j) = y4
                  CALL PUSHCONTROL1B(0)
                ELSE
                  bl(i, j) = x4
                  CALL PUSHCONTROL1B(1)
                END IF
                pmp_2 = 2.*dq(i, j-1)
                lac_2 = pmp_2 - 1.5*dq(i, j-2)
                IF (0. .LT. pmp_2) THEN
                  IF (pmp_2 .LT. lac_2) THEN
                    x5 = lac_2
                    CALL PUSHCONTROL2B(0)
                  ELSE
                    x5 = pmp_2
                    CALL PUSHCONTROL2B(1)
                  END IF
                ELSE IF (0. .LT. lac_2) THEN
                  x5 = lac_2
                  CALL PUSHCONTROL2B(2)
                ELSE
                  CALL PUSHCONTROL2B(3)
                  x5 = 0.
                END IF
                IF (0. .GT. pmp_2) THEN
                  IF (pmp_2 .GT. lac_2) THEN
                    y7 = lac_2
                    CALL PUSHCONTROL2B(0)
                  ELSE
                    y7 = pmp_2
                    CALL PUSHCONTROL2B(1)
                  END IF
                ELSE IF (0. .GT. lac_2) THEN
                  y7 = lac_2
                  CALL PUSHCONTROL2B(2)
                ELSE
                  y7 = 0.
                  CALL PUSHCONTROL2B(3)
                END IF
                IF (br(i, j) .LT. y7) THEN
                  y5 = y7
                  CALL PUSHCONTROL1B(0)
                ELSE
                  y5 = br(i, j)
                  CALL PUSHCONTROL1B(1)
                END IF
                IF (x5 .GT. y5) THEN
                  br(i, j) = y5
                  CALL PUSHCONTROL2B(1)
                ELSE
                  br(i, j) = x5
                  CALL PUSHCONTROL2B(2)
                END IF
              ELSE
                CALL PUSHCONTROL2B(0)
              END IF
            END IF
          END DO
        END DO
        CALL PUSHCONTROL1B(1)
      END IF
      IF (jord .EQ. -9 .OR. jord .EQ. -13) THEN
! Positive definite constraint:
        DO j=js1,je1
          arg1 = ilast - ifirst + 1
          CALL PUSHREALARRAY_ADM(br(ifirst, j), 8*(ilast-ifirst+1)/8)
          CALL PUSHREALARRAY_ADM(bl(ifirst, j), 8*(ilast-ifirst+1)/8)
          CALL PERT_PPM(arg1, q(ifirst, j), bl(ifirst, j), br(ifirst, j)&
&                 , 0)
        END DO
        CALL PUSHCONTROL1B(0)
      ELSE
        CALL PUSHCONTROL1B(1)
      END IF
      IF (.NOT.nested .AND. grid_type .LT. 3) THEN
        IF (js .EQ. 1) THEN
          DO i=ifirst,ilast
            bl(i, 0) = s14*dm(i, -1) + s11*(q(i, -1)-q(i, 0))
            xt = 0.5*(((2.*dya(i, 0)+dya(i, -1))*q(i, 0)-dya(i, 0)*q(i, &
&             -1))/(dya(i, -1)+dya(i, 0))+((2.*dya(i, 1)+dya(i, 2))*q(i&
&             , 1)-dya(i, 1)*q(i, 2))/(dya(i, 1)+dya(i, 2)))
            br(i, 0) = xt - q(i, 0)
            bl(i, 1) = xt - q(i, 1)
            xt = s15*q(i, 1) + s11*q(i, 2) - s14*dm(i, 2)
            br(i, 1) = xt - q(i, 1)
            bl(i, 2) = xt - q(i, 2)
            br(i, 2) = al(i, 3) - q(i, 2)
          END DO
          arg1 = 3*(ilast-ifirst+1)
          CALL PUSHREALARRAY_ADM(br(ifirst, 0), 8*(ilast-ifirst+1)/8)
          CALL PUSHREALARRAY_ADM(bl(ifirst, 0), 8*(ilast-ifirst+1)/8)
          CALL PERT_PPM(arg1, q(ifirst, 0), bl(ifirst, 0), br(ifirst, 0)&
&                 , 1)
          CALL PUSHCONTROL1B(0)
        ELSE
          CALL PUSHCONTROL1B(1)
        END IF
        IF (je + 1 .EQ. npy) THEN
          DO i=ifirst,ilast
            bl(i, npy-2) = al(i, npy-2) - q(i, npy-2)
            xt = s15*q(i, npy-1) + s11*q(i, npy-2) + s14*dm(i, npy-2)
            br(i, npy-2) = xt - q(i, npy-2)
            bl(i, npy-1) = xt - q(i, npy-1)
            xt = 0.5*(((2.*dya(i, npy-1)+dya(i, npy-2))*q(i, npy-1)-dya(&
&             i, npy-1)*q(i, npy-2))/(dya(i, npy-2)+dya(i, npy-1))+((2.*&
&             dya(i, npy)+dya(i, npy+1))*q(i, npy)-dya(i, npy)*q(i, npy+&
&             1))/(dya(i, npy)+dya(i, npy+1)))
            br(i, npy-1) = xt - q(i, npy-1)
            bl(i, npy) = xt - q(i, npy)
            br(i, npy) = s11*(q(i, npy+1)-q(i, npy)) - s14*dm(i, npy+1)
          END DO
          arg1 = 3*(ilast-ifirst+1)
          CALL PUSHREALARRAY_ADM(br(ifirst, npy-2), 8*(ilast-ifirst+1)/&
&                       8)
          CALL PUSHREALARRAY_ADM(bl(ifirst, npy-2), 8*(ilast-ifirst+1)/&
&                       8)
          CALL PERT_PPM(arg1, q(ifirst, npy-2), bl(ifirst, npy-2), br(&
&                 ifirst, npy-2), 1)
          CALL PUSHCONTROL3B(2)
        ELSE
          CALL PUSHCONTROL3B(1)
        END IF
      ELSE
        CALL PUSHCONTROL3B(0)
      END IF
    END IF
    DO j=jfirst,jlast+1
      DO i=ifirst,ilast
        IF (c(i, j) .GT. 0.) THEN
          CALL PUSHCONTROL1B(1)
        ELSE
          CALL PUSHCONTROL1B(0)
        END IF
      END DO
    END DO
    bl_ad = 0.0_FVPRC
    br_ad = 0.0_FVPRC
    DO j=jlast+1,jfirst,-1
      DO i=ilast,ifirst,-1
        CALL POPCONTROL1B(branch)
        IF (branch .EQ. 0) THEN
          temp0 = bl(i, j) + br(i, j)
          temp_ad9 = (c(i, j)+1.)*flux_ad(i, j)
          temp_ad10 = c(i, j)*temp_ad9
          q_ad(i, j) = q_ad(i, j) + flux_ad(i, j)
          c_ad(i, j) = c_ad(i, j) + temp0*temp_ad9 + (bl(i, j)+c(i, j)*&
&           temp0)*flux_ad(i, j)
          bl_ad(i, j) = bl_ad(i, j) + temp_ad10 + temp_ad9
          br_ad(i, j) = br_ad(i, j) + temp_ad10
          flux_ad(i, j) = 0.0_FVPRC
        ELSE
          temp = bl(i, j-1) + br(i, j-1)
          temp_ad7 = (1.-c(i, j))*flux_ad(i, j)
          temp_ad8 = -(c(i, j)*temp_ad7)
          q_ad(i, j-1) = q_ad(i, j-1) + flux_ad(i, j)
          c_ad(i, j) = c_ad(i, j) - temp*temp_ad7 - (br(i, j-1)-c(i, j)*&
&           temp)*flux_ad(i, j)
          br_ad(i, j-1) = br_ad(i, j-1) + temp_ad8 + temp_ad7
          bl_ad(i, j-1) = bl_ad(i, j-1) + temp_ad8
          flux_ad(i, j) = 0.0_FVPRC
        END IF
      END DO
    END DO
    CALL POPCONTROL3B(branch)
    IF (branch .LT. 3) THEN
      IF (branch .EQ. 0) THEN
        dm_ad = 0.0_FVPRC
        al_ad = 0.0_FVPRC
      ELSE
        IF (branch .EQ. 1) THEN
          dm_ad = 0.0_FVPRC
          al_ad = 0.0_FVPRC
        ELSE
          CALL POPREALARRAY_ADM(bl(ifirst, npy-2), 8*(ilast-ifirst+1)/8&
&                     )
          CALL POPREALARRAY_ADM(br(ifirst, npy-2), 8*(ilast-ifirst+1)/8&
&                     )
          CALL PERT_PPM_ADM(arg1, q(ifirst, npy-2), bl(ifirst:, npy-2), &
&                     bl_ad(ifirst:, npy-2), br(ifirst:, npy-2), br_ad(&
&                     ifirst:, npy-2), 1)
          dm_ad = 0.0_FVPRC
          al_ad = 0.0_FVPRC
          DO i=ilast,ifirst,-1
            q_ad(i, npy+1) = q_ad(i, npy+1) + s11*br_ad(i, npy)
            q_ad(i, npy) = q_ad(i, npy) - bl_ad(i, npy) - s11*br_ad(i, &
&             npy)
            dm_ad(i, npy+1) = dm_ad(i, npy+1) - s14*br_ad(i, npy)
            br_ad(i, npy) = 0.0_FVPRC
            xt_ad = br_ad(i, npy-1) + bl_ad(i, npy)
            bl_ad(i, npy) = 0.0_FVPRC
            temp_ad5 = 0.5*xt_ad/(dya(i, npy-2)+dya(i, npy-1))
            q_ad(i, npy-1) = q_ad(i, npy-1) + (dya(i, npy-1)*2.+dya(i, &
&             npy-2))*temp_ad5 - br_ad(i, npy-1)
            br_ad(i, npy-1) = 0.0_FVPRC
            temp_ad6 = 0.5*xt_ad/(dya(i, npy)+dya(i, npy+1))
            q_ad(i, npy-2) = q_ad(i, npy-2) - dya(i, npy-1)*temp_ad5
            q_ad(i, npy) = q_ad(i, npy) + (dya(i, npy)*2.+dya(i, npy+1))&
&             *temp_ad6
            q_ad(i, npy+1) = q_ad(i, npy+1) - dya(i, npy)*temp_ad6
            xt_ad = br_ad(i, npy-2) + bl_ad(i, npy-1)
            q_ad(i, npy-1) = q_ad(i, npy-1) - bl_ad(i, npy-1)
            bl_ad(i, npy-1) = 0.0_FVPRC
            q_ad(i, npy-2) = q_ad(i, npy-2) - br_ad(i, npy-2)
            br_ad(i, npy-2) = 0.0_FVPRC
            q_ad(i, npy-1) = q_ad(i, npy-1) + s15*xt_ad
            q_ad(i, npy-2) = q_ad(i, npy-2) + s11*xt_ad - bl_ad(i, npy-2&
&             )
            dm_ad(i, npy-2) = dm_ad(i, npy-2) + s14*xt_ad
            al_ad(i, npy-2) = al_ad(i, npy-2) + bl_ad(i, npy-2)
            bl_ad(i, npy-2) = 0.0_FVPRC
          END DO
        END IF
        CALL POPCONTROL1B(branch)
        IF (branch .EQ. 0) THEN
          arg1 = 3*(ilast-ifirst+1)
          CALL POPREALARRAY_ADM(bl(ifirst, 0), 8*(ilast-ifirst+1)/8)
          CALL POPREALARRAY_ADM(br(ifirst, 0), 8*(ilast-ifirst+1)/8)
          CALL PERT_PPM_ADM(arg1, q(ifirst, 0), bl(ifirst:, 0), bl_ad(&
&                     ifirst:, 0), br(ifirst:, 0), br_ad(ifirst:, 0), 1)
          DO i=ilast,ifirst,-1
            al_ad(i, 3) = al_ad(i, 3) + br_ad(i, 2)
            q_ad(i, 2) = q_ad(i, 2) - bl_ad(i, 2) - br_ad(i, 2)
            br_ad(i, 2) = 0.0_FVPRC
            xt_ad = br_ad(i, 1) + bl_ad(i, 2)
            bl_ad(i, 2) = 0.0_FVPRC
            q_ad(i, 1) = q_ad(i, 1) + s15*xt_ad - br_ad(i, 1)
            br_ad(i, 1) = 0.0_FVPRC
            q_ad(i, 2) = q_ad(i, 2) + s11*xt_ad
            dm_ad(i, 2) = dm_ad(i, 2) - s14*xt_ad
            xt_ad = br_ad(i, 0) + bl_ad(i, 1)
            q_ad(i, 1) = q_ad(i, 1) - bl_ad(i, 1)
            bl_ad(i, 1) = 0.0_FVPRC
            temp_ad3 = 0.5*xt_ad/(dya(i, -1)+dya(i, 0))
            q_ad(i, 0) = q_ad(i, 0) + (dya(i, 0)*2.+dya(i, -1))*temp_ad3&
&             - br_ad(i, 0)
            br_ad(i, 0) = 0.0_FVPRC
            temp_ad4 = 0.5*xt_ad/(dya(i, 1)+dya(i, 2))
            q_ad(i, -1) = q_ad(i, -1) - dya(i, 0)*temp_ad3
            q_ad(i, 1) = q_ad(i, 1) + (dya(i, 1)*2.+dya(i, 2))*temp_ad4
            q_ad(i, 2) = q_ad(i, 2) - dya(i, 1)*temp_ad4
            dm_ad(i, -1) = dm_ad(i, -1) + s14*bl_ad(i, 0)
            q_ad(i, -1) = q_ad(i, -1) + s11*bl_ad(i, 0)
            q_ad(i, 0) = q_ad(i, 0) - s11*bl_ad(i, 0)
            bl_ad(i, 0) = 0.0_FVPRC
          END DO
        END IF
      END IF
      CALL POPCONTROL1B(branch)
      IF (branch .EQ. 0) THEN
        DO j=je1,js1,-1
          arg1 = ilast - ifirst + 1
          CALL POPREALARRAY_ADM(bl(ifirst, j), 8*(ilast-ifirst+1)/8)
          CALL POPREALARRAY_ADM(br(ifirst, j), 8*(ilast-ifirst+1)/8)
          CALL PERT_PPM_ADM(arg1, q(ifirst, j), bl(ifirst:, j), bl_ad(&
&                     ifirst:, j), br(ifirst:, j), br_ad(ifirst:, j), 0)
        END DO
      END IF
      CALL POPCONTROL1B(branch)
      IF (branch .EQ. 0) THEN
        DO j=je1,js1,-1
          DO i=ilast,ifirst,-1
            xt = 2.*dm(i, j)
            min3_ad = SIGN(1.d0, min3*xt)*br_ad(i, j)
            br_ad(i, j) = 0.0_FVPRC
            CALL POPCONTROL1B(branch)
            IF (branch .EQ. 0) THEN
              CALL POPREALARRAY_ADM(min3)
              y3_ad = min3_ad
              x3_ad = 0.0_FVPRC
            ELSE
              CALL POPREALARRAY_ADM(min3)
              x3_ad = min3_ad
              y3_ad = 0.0_FVPRC
            END IF
            CALL POPCONTROL1B(branch)
            IF (branch .EQ. 0) THEN
              al_ad(i, j+1) = al_ad(i, j+1) + y3_ad
              q_ad(i, j) = q_ad(i, j) - y3_ad
            ELSE
              q_ad(i, j) = q_ad(i, j) + y3_ad
              al_ad(i, j+1) = al_ad(i, j+1) - y3_ad
            END IF
            CALL POPCONTROL1B(branch)
            IF (branch .EQ. 0) THEN
              xt_ad = x3_ad
            ELSE
              xt_ad = -x3_ad
            END IF
            min2_ad = -(SIGN(1.d0, min2*xt)*bl_ad(i, j))
            bl_ad(i, j) = 0.0_FVPRC
            CALL POPCONTROL1B(branch)
            IF (branch .EQ. 0) THEN
              CALL POPREALARRAY_ADM(min2)
              y2_ad = min2_ad
              x2_ad = 0.0_FVPRC
            ELSE
              CALL POPREALARRAY_ADM(min2)
              x2_ad = min2_ad
              y2_ad = 0.0_FVPRC
            END IF
            CALL POPCONTROL1B(branch)
            IF (branch .EQ. 0) THEN
              al_ad(i, j) = al_ad(i, j) + y2_ad
              q_ad(i, j) = q_ad(i, j) - y2_ad
            ELSE
              q_ad(i, j) = q_ad(i, j) + y2_ad
              al_ad(i, j) = al_ad(i, j) - y2_ad
            END IF
            CALL POPCONTROL1B(branch)
            IF (branch .EQ. 0) THEN
              xt_ad = xt_ad + x2_ad
            ELSE
              xt_ad = xt_ad - x2_ad
            END IF
            dm_ad(i, j) = dm_ad(i, j) + 2.*xt_ad
          END DO
        END DO
      ELSE
        dq_ad = 0.0_FVPRC
        DO j=je1,js1,-1
          DO i=ilast,ifirst,-1
            CALL POPCONTROL2B(branch)
            IF (branch .LT. 2) THEN
              IF (branch .EQ. 0) THEN
                GOTO 100
              ELSE
                y5_ad = br_ad(i, j)
                br_ad(i, j) = 0.0_FVPRC
                x5_ad = 0.0_FVPRC
              END IF
            ELSE IF (branch .EQ. 2) THEN
              x5_ad = br_ad(i, j)
              br_ad(i, j) = 0.0_FVPRC
              y5_ad = 0.0_FVPRC
            ELSE
              br_ad(i, j) = 0.0_FVPRC
              bl_ad(i, j) = 0.0_FVPRC
              GOTO 100
            END IF
            CALL POPCONTROL1B(branch)
            IF (branch .EQ. 0) THEN
              y7_ad = y5_ad
            ELSE
              br_ad(i, j) = br_ad(i, j) + y5_ad
              y7_ad = 0.0_FVPRC
            END IF
            CALL POPCONTROL2B(branch)
            IF (branch .LT. 2) THEN
              IF (branch .EQ. 0) THEN
                lac_2_ad = y7_ad
                pmp_2_ad = 0.0_FVPRC
              ELSE
                pmp_2_ad = y7_ad
                lac_2_ad = 0.0_FVPRC
              END IF
            ELSE
              IF (branch .EQ. 2) THEN
                lac_2_ad = y7_ad
              ELSE
                lac_2_ad = 0.0_FVPRC
              END IF
              pmp_2_ad = 0.0_FVPRC
            END IF
            CALL POPCONTROL2B(branch)
            IF (branch .LT. 2) THEN
              IF (branch .EQ. 0) THEN
                lac_2_ad = lac_2_ad + x5_ad
              ELSE
                pmp_2_ad = pmp_2_ad + x5_ad
              END IF
            ELSE IF (branch .EQ. 2) THEN
              lac_2_ad = lac_2_ad + x5_ad
            END IF
            pmp_2_ad = pmp_2_ad + lac_2_ad
            dq_ad(i, j-2) = dq_ad(i, j-2) - 1.5*lac_2_ad
            dq_ad(i, j-1) = dq_ad(i, j-1) + 2.*pmp_2_ad
            CALL POPCONTROL1B(branch)
            IF (branch .EQ. 0) THEN
              y4_ad = bl_ad(i, j)
              bl_ad(i, j) = 0.0_FVPRC
              x4_ad = 0.0_FVPRC
            ELSE
              x4_ad = bl_ad(i, j)
              bl_ad(i, j) = 0.0_FVPRC
              y4_ad = 0.0_FVPRC
            END IF
            CALL POPCONTROL1B(branch)
            IF (branch .EQ. 0) THEN
              y6_ad = y4_ad
            ELSE
              bl_ad(i, j) = bl_ad(i, j) + y4_ad
              y6_ad = 0.0_FVPRC
            END IF
            CALL POPCONTROL2B(branch)
            IF (branch .LT. 2) THEN
              IF (branch .EQ. 0) THEN
                lac_1_ad = y6_ad
                pmp_1_ad = 0.0_FVPRC
              ELSE
                pmp_1_ad = y6_ad
                lac_1_ad = 0.0_FVPRC
              END IF
            ELSE
              IF (branch .EQ. 2) THEN
                lac_1_ad = y6_ad
              ELSE
                lac_1_ad = 0.0_FVPRC
              END IF
              pmp_1_ad = 0.0_FVPRC
            END IF
            CALL POPCONTROL2B(branch)
            IF (branch .LT. 2) THEN
              IF (branch .EQ. 0) THEN
                lac_1_ad = lac_1_ad + x4_ad
              ELSE
                pmp_1_ad = pmp_1_ad + x4_ad
              END IF
            ELSE IF (branch .EQ. 2) THEN
              lac_1_ad = lac_1_ad + x4_ad
            END IF
            pmp_1_ad = pmp_1_ad + lac_1_ad
            dq_ad(i, j+1) = dq_ad(i, j+1) + 1.5*lac_1_ad
            dq_ad(i, j) = dq_ad(i, j) - 2.*pmp_1_ad
 100        al_ad(i, j+1) = al_ad(i, j+1) + br_ad(i, j)
            q_ad(i, j) = q_ad(i, j) - bl_ad(i, j) - br_ad(i, j)
            br_ad(i, j) = 0.0_FVPRC
            al_ad(i, j) = al_ad(i, j) + bl_ad(i, j)
            bl_ad(i, j) = 0.0_FVPRC
          END DO
        END DO
        DO j=je1+1,js1-2,-1
          DO i=ilast,ifirst,-1
            q_ad(i, j+1) = q_ad(i, j+1) + dq_ad(i, j)
            q_ad(i, j) = q_ad(i, j) - dq_ad(i, j)
            dq_ad(i, j) = 0.0_FVPRC
          END DO
        END DO
      END IF
      DO j=je1+1,js1,-1
        DO i=ilast,ifirst,-1
          q_ad(i, j-1) = q_ad(i, j-1) + 0.5*al_ad(i, j)
          q_ad(i, j) = q_ad(i, j) + 0.5*al_ad(i, j)
          dm_ad(i, j-1) = dm_ad(i, j-1) + r3*al_ad(i, j)
          dm_ad(i, j) = dm_ad(i, j) - r3*al_ad(i, j)
          al_ad(i, j) = 0.0_FVPRC
        END DO
      END DO
      DO j=je+2,js-2,-1
        DO i=ilast,ifirst,-1
          xt = 0.25*(q(i, j+1)-q(i, j-1))
          min1_ad = SIGN(1.d0, min1*xt)*dm_ad(i, j)
          dm_ad(i, j) = 0.0_FVPRC
          CALL POPCONTROL2B(branch)
          IF (branch .LT. 2) THEN
            IF (branch .EQ. 0) THEN
              CALL POPREALARRAY_ADM(min1)
              z1_ad = min1_ad
              y1_ad = 0.0_FVPRC
            ELSE
              CALL POPREALARRAY_ADM(min1)
              y1_ad = min1_ad
              z1_ad = 0.0_FVPRC
            END IF
            x1_ad = 0.0_FVPRC
          ELSE
            IF (branch .EQ. 2) THEN
              CALL POPREALARRAY_ADM(min1)
              z1_ad = min1_ad
              x1_ad = 0.0_FVPRC
            ELSE
              CALL POPREALARRAY_ADM(min1)
              x1_ad = min1_ad
              z1_ad = 0.0_FVPRC
            END IF
            y1_ad = 0.0_FVPRC
          END IF
          q_ad(i, j) = q_ad(i, j) + z1_ad
          min4_ad = -z1_ad
          CALL POPCONTROL2B(branch)
          IF (branch .LT. 2) THEN
            IF (branch .EQ. 0) THEN
              q_ad(i, j+1) = q_ad(i, j+1) + min4_ad
            ELSE
              q_ad(i, j) = q_ad(i, j) + min4_ad
            END IF
          ELSE IF (branch .EQ. 2) THEN
            q_ad(i, j+1) = q_ad(i, j+1) + min4_ad
          ELSE
            q_ad(i, j-1) = q_ad(i, j-1) + min4_ad
          END IF
          max1_ad = y1_ad
          q_ad(i, j) = q_ad(i, j) - y1_ad
          CALL POPCONTROL2B(branch)
          IF (branch .LT. 2) THEN
            IF (branch .EQ. 0) THEN
              q_ad(i, j+1) = q_ad(i, j+1) + max1_ad
            ELSE
              q_ad(i, j) = q_ad(i, j) + max1_ad
            END IF
          ELSE IF (branch .EQ. 2) THEN
            q_ad(i, j+1) = q_ad(i, j+1) + max1_ad
          ELSE
            q_ad(i, j-1) = q_ad(i, j-1) + max1_ad
          END IF
          CALL POPCONTROL1B(branch)
          IF (branch .EQ. 0) THEN
            xt_ad = x1_ad
          ELSE
            xt_ad = -x1_ad
          END IF
          q_ad(i, j+1) = q_ad(i, j+1) + 0.25*xt_ad
          q_ad(i, j-1) = q_ad(i, j-1) - 0.25*xt_ad
        END DO
      END DO
    ELSE
      IF (branch .NE. 3) THEN
        IF (branch .EQ. 4) THEN
          DO j=jlast+1,jfirst-1,-1
            arg1 = ilast - ifirst + 1
            CALL POPREALARRAY_ADM(bl(ifirst, j), 8*(ilast-ifirst+1)/8)
            CALL POPREALARRAY_ADM(br(ifirst, j), 8*(ilast-ifirst+1)/8)
            CALL PERT_PPM_ADM(arg1, q(ifirst, j), bl(ifirst:, j), bl_ad(&
&                       ifirst:, j), br(ifirst:, j), br_ad(ifirst:, j), &
&                       0)
          END DO
        ELSE
          al_ad = 0.0_FVPRC
          DO j=jlast+1,jfirst-1,-1
            DO i=ilast,ifirst,-1
              al_ad(i, j+1) = al_ad(i, j+1) + br_ad(i, j)
              q_ad(i, j) = q_ad(i, j) - bl_ad(i, j) - br_ad(i, j)
              br_ad(i, j) = 0.0_FVPRC
              al_ad(i, j) = al_ad(i, j) + bl_ad(i, j)
              bl_ad(i, j) = 0.0_FVPRC
            END DO
          END DO
          GOTO 110
        END IF
      END IF
      al_ad = 0.0_FVPRC
      DO j=jlast+1,jfirst-1,-1
        DO i=ilast,ifirst,-1
          CALL POPCONTROL1B(branch)
          IF (branch .EQ. 0) THEN
            al_ad(i, j+1) = al_ad(i, j+1) + br_ad(i, j)
            q_ad(i, j) = q_ad(i, j) - bl_ad(i, j) - br_ad(i, j)
            br_ad(i, j) = 0.0_FVPRC
            al_ad(i, j) = al_ad(i, j) + bl_ad(i, j)
            bl_ad(i, j) = 0.0_FVPRC
          ELSE
            br_ad(i, j) = 0.0_FVPRC
            bl_ad(i, j) = 0.0_FVPRC
          END IF
        END DO
      END DO
      DO j=jlast+2,jfirst-2,-1
        DO i=ilast,ifirst,-1
          CALL POPCONTROL1B(branch)
        END DO
      END DO
 110  CALL POPCONTROL2B(branch)
      IF (branch .LT. 2) THEN
        IF (branch .EQ. 0) THEN
          DO i=ilast,ifirst,-1
            CALL POPCONTROL1B(branch)
            IF (branch .NE. 0) al_ad(i, npy+1) = 0.0_FVPRC
            CALL POPCONTROL1B(branch)
            IF (branch .NE. 0) al_ad(i, npy) = 0.0_FVPRC
            CALL POPCONTROL1B(branch)
            IF (branch .NE. 0) al_ad(i, npy-1) = 0.0_FVPRC
          END DO
        END IF
        DO i=ilast,ifirst,-1
          q_ad(i, npy) = q_ad(i, npy) + c3*al_ad(i, npy+1)
          q_ad(i, npy+1) = q_ad(i, npy+1) + c2*al_ad(i, npy+1)
          q_ad(i, npy+2) = q_ad(i, npy+2) + c1*al_ad(i, npy+1)
          al_ad(i, npy+1) = 0.0_FVPRC
          temp_ad1 = 0.5*al_ad(i, npy)/(dya(i, npy-2)+dya(i, npy-1))
          temp_ad2 = 0.5*al_ad(i, npy)/(dya(i, npy)+dya(i, npy+1))
          q_ad(i, npy-1) = q_ad(i, npy-1) + (dya(i, npy-1)*2.+dya(i, npy&
&           -2))*temp_ad1
          q_ad(i, npy-2) = q_ad(i, npy-2) - dya(i, npy-1)*temp_ad1
          q_ad(i, npy) = q_ad(i, npy) + (dya(i, npy)*2.+dya(i, npy+1))*&
&           temp_ad2
          q_ad(i, npy+1) = q_ad(i, npy+1) - dya(i, npy)*temp_ad2
          al_ad(i, npy) = 0.0_FVPRC
          q_ad(i, npy-3) = q_ad(i, npy-3) + c1*al_ad(i, npy-1)
          q_ad(i, npy-2) = q_ad(i, npy-2) + c2*al_ad(i, npy-1)
          q_ad(i, npy-1) = q_ad(i, npy-1) + c3*al_ad(i, npy-1)
          al_ad(i, npy-1) = 0.0_FVPRC
        END DO
      ELSE IF (branch .NE. 2) THEN
        GOTO 120
      END IF
      CALL POPCONTROL2B(branch)
      IF (branch .EQ. 0) THEN
        DO i=ilast,ifirst,-1
          CALL POPCONTROL1B(branch)
          IF (branch .NE. 0) al_ad(i, 2) = 0.0_FVPRC
          CALL POPCONTROL1B(branch)
          IF (branch .NE. 0) al_ad(i, 1) = 0.0_FVPRC
          CALL POPCONTROL1B(branch)
          IF (branch .NE. 0) al_ad(i, 0) = 0.0_FVPRC
        END DO
      ELSE IF (branch .NE. 1) THEN
        GOTO 120
      END IF
      DO i=ilast,ifirst,-1
        q_ad(i, 1) = q_ad(i, 1) + c3*al_ad(i, 2)
        q_ad(i, 2) = q_ad(i, 2) + c2*al_ad(i, 2)
        q_ad(i, 3) = q_ad(i, 3) + c1*al_ad(i, 2)
        al_ad(i, 2) = 0.0_FVPRC
        temp_ad = 0.5*al_ad(i, 1)/(dya(i, -1)+dya(i, 0))
        temp_ad0 = 0.5*al_ad(i, 1)/(dya(i, 1)+dya(i, 2))
        q_ad(i, 0) = q_ad(i, 0) + (dya(i, 0)*2.+dya(i, -1))*temp_ad
        q_ad(i, -1) = q_ad(i, -1) - dya(i, 0)*temp_ad
        q_ad(i, 1) = q_ad(i, 1) + (dya(i, 1)*2.+dya(i, 2))*temp_ad0
        q_ad(i, 2) = q_ad(i, 2) - dya(i, 1)*temp_ad0
        al_ad(i, 1) = 0.0_FVPRC
        q_ad(i, -2) = q_ad(i, -2) + c1*al_ad(i, 0)
        q_ad(i, -1) = q_ad(i, -1) + c2*al_ad(i, 0)
        q_ad(i, 0) = q_ad(i, 0) + c3*al_ad(i, 0)
        al_ad(i, 0) = 0.0_FVPRC
      END DO
 120  DO j=je3,js1,-1
        DO i=ilast,ifirst,-1
          q_ad(i, j-1) = q_ad(i, j-1) + p1*al_ad(i, j)
          q_ad(i, j) = q_ad(i, j) + p1*al_ad(i, j)
          q_ad(i, j-2) = q_ad(i, j-2) + p2*al_ad(i, j)
          q_ad(i, j+1) = q_ad(i, j+1) + p2*al_ad(i, j)
          al_ad(i, j) = 0.0_FVPRC
        END DO
      END DO
    END IF
    CALL POPCONTROL1B(branch)
  END SUBROUTINE YPPM0_ADM
!#endif
  SUBROUTINE YPPM0(flux, q, c, jord, ifirst, ilast, jfirst, jlast, npx, &
&   npy, bd, dya, nested, grid_type)
    IMPLICIT NONE
    TYPE(FV_GRID_BOUNDS_TYPE), INTENT(IN) :: bd
!  X-Dir strip
    INTEGER, INTENT(IN) :: ifirst, ilast
!  Y-Dir strip
    INTEGER, INTENT(IN) :: jfirst, jlast
    INTEGER, INTENT(IN) :: jord
    INTEGER, INTENT(IN) :: npx, npy
    REAL(fvprc), INTENT(IN) :: q(ifirst:ilast, jfirst-ng:jlast+ng)
! Courant number
    REAL(fvprc), INTENT(IN) :: c(bd%isd:bd%ied, bd%js:bd%je+1)
!  Flux
    REAL(fvprc), INTENT(OUT) :: flux(ifirst:ilast, jfirst:jlast+1)
    REAL(fvprc), INTENT(IN) :: dya(bd%isd:bd%ied, bd%jsd:bd%jed)
    LOGICAL, INTENT(IN) :: nested
    INTEGER, INTENT(IN) :: grid_type
! Local:
    REAL(fvprc) :: dm(ifirst:ilast, jfirst-2:jlast+2)
    REAL(fvprc) :: al(ifirst:ilast, jfirst-1:jlast+2)
    REAL(fvprc) :: bl(ifirst:ilast, jfirst-1:jlast+1)
    REAL(fvprc) :: br(ifirst:ilast, jfirst-1:jlast+1)
    REAL(fvprc) :: dq(ifirst:ilast, jfirst-3:jlast+2)
    LOGICAL :: extm(ifirst:ilast, jfirst-2:jlast+2)
    REAL(fvprc) :: xt, pmp_1, lac_1, pmp_2, lac_2
    INTEGER :: i, j, js1, je3, je1
    INTEGER :: is, ie, js, je, isd, ied, jsd, jed
    INTRINSIC MAX
    INTRINSIC MIN
    INTRINSIC ABS
    INTRINSIC SIGN
    INTEGER :: abs0
    REAL(fvprc) :: min1
    REAL(fvprc) :: min2
    REAL(fvprc) :: min3
    REAL(fvprc) :: abs1
    REAL(fvprc) :: abs2
    REAL(fvprc) :: max1
    REAL(fvprc) :: min4
    REAL(fvprc) :: abs3
    REAL(fvprc) :: abs4
    REAL(fvprc) :: abs5
    INTEGER :: arg1
    REAL(fvprc) :: x5
    REAL(fvprc) :: x4
    REAL(fvprc) :: x3
    REAL(fvprc) :: x2
    REAL(fvprc) :: x1
    REAL(fvprc) :: z1
    REAL(fvprc) :: y7
    REAL(fvprc) :: y6
    REAL(fvprc) :: y5
    REAL(fvprc) :: y4
    REAL(fvprc) :: y3
    REAL(fvprc) :: y2
    REAL(fvprc) :: y1
    is = bd%is
    ie = bd%ie
    js = bd%js
    je = bd%je
    isd = bd%isd
    ied = bd%ied
    jsd = bd%jsd
    jed = bd%jed
    IF (.NOT.nested .AND. grid_type .LT. 3) THEN
      IF (3 .LT. js - 1) THEN
        js1 = js - 1
      ELSE
        js1 = 3
      END IF
      IF (npy - 2 .GT. je + 2) THEN
        je3 = je + 2
      ELSE
        je3 = npy - 2
      END IF
      IF (npy - 3 .GT. je + 1) THEN
        je1 = je + 1
      ELSE
        je1 = npy - 3
      END IF
    ELSE
! Nested grid OR Doubly periodic domain:
      js1 = js - 1
      je3 = je + 2
      je1 = je + 1
    END IF
    IF (jord .GE. 0.) THEN
      abs0 = jord
    ELSE
      abs0 = -jord
    END IF
    IF (abs0 .LT. 8) THEN
! ord = -5: linear scheme based on PPM 4th order interpolation
! ord = -6: linear PPM with 2-delta filter
! ord = -7: (-6) with additional Positive definite constraint:
      DO j=js1,je3
        DO i=ifirst,ilast
          al(i, j) = p1*(q(i, j-1)+q(i, j)) + p2*(q(i, j-2)+q(i, j+1))
        END DO
      END DO
      IF (.NOT.nested .AND. grid_type .LT. 3) THEN
        IF (js .EQ. 1) THEN
          DO i=ifirst,ilast
            al(i, 0) = c1*q(i, -2) + c2*q(i, -1) + c3*q(i, 0)
            al(i, 1) = 0.5*(((2.*dya(i, 0)+dya(i, -1))*q(i, 0)-dya(i, 0)&
&             *q(i, -1))/(dya(i, -1)+dya(i, 0))+((2.*dya(i, 1)+dya(i, 2)&
&             )*q(i, 1)-dya(i, 1)*q(i, 2))/(dya(i, 1)+dya(i, 2)))
            al(i, 2) = c3*q(i, 1) + c2*q(i, 2) + c1*q(i, 3)
          END DO
          IF (jord .EQ. -7) THEN
            DO i=ifirst,ilast
              IF (0. .LT. al(i, 0)) THEN
                al(i, 0) = al(i, 0)
              ELSE
                al(i, 0) = 0.
              END IF
              IF (0. .LT. al(i, 1)) THEN
                al(i, 1) = al(i, 1)
              ELSE
                al(i, 1) = 0.
              END IF
              IF (0. .LT. al(i, 2)) THEN
                al(i, 2) = al(i, 2)
              ELSE
                al(i, 2) = 0.
              END IF
            END DO
          END IF
        END IF
        IF (je + 1 .EQ. npy) THEN
          DO i=ifirst,ilast
            al(i, npy-1) = c1*q(i, npy-3) + c2*q(i, npy-2) + c3*q(i, npy&
&             -1)
            al(i, npy) = 0.5*(((2.*dya(i, npy-1)+dya(i, npy-2))*q(i, npy&
&             -1)-dya(i, npy-1)*q(i, npy-2))/(dya(i, npy-2)+dya(i, npy-1&
&             ))+((2.*dya(i, npy)+dya(i, npy+1))*q(i, npy)-dya(i, npy)*q&
&             (i, npy+1))/(dya(i, npy)+dya(i, npy+1)))
            al(i, npy+1) = c3*q(i, npy) + c2*q(i, npy+1) + c1*q(i, npy+2&
&             )
          END DO
          IF (jord .EQ. -7) THEN
            DO i=ifirst,ilast
              IF (0. .LT. al(i, npy-1)) THEN
                al(i, npy-1) = al(i, npy-1)
              ELSE
                al(i, npy-1) = 0.
              END IF
              IF (0. .LT. al(i, npy)) THEN
                al(i, npy) = al(i, npy)
              ELSE
                al(i, npy) = 0.
              END IF
              IF (0. .LT. al(i, npy+1)) THEN
                al(i, npy+1) = al(i, npy+1)
              ELSE
                al(i, npy+1) = 0.
              END IF
            END DO
          END IF
        END IF
      END IF
      IF (jord .EQ. -5) THEN
        DO j=jfirst-1,jlast+1
          DO i=ifirst,ilast
            bl(i, j) = al(i, j) - q(i, j)
            br(i, j) = al(i, j+1) - q(i, j)
          END DO
        END DO
      ELSE
        DO j=jfirst-3,jlast+2
          DO i=ifirst,ilast
            dq(i, j) = q(i, j+1) - q(i, j)
          END DO
        END DO
        DO j=jfirst-2,jlast+2
          DO i=ifirst,ilast
            IF (dq(i, j-1)*dq(i, j) .GT. 0.) THEN
              extm(i, j) = .false.
            ELSE
              extm(i, j) = .true.
            END IF
          END DO
        END DO
        DO j=jfirst-1,jlast+1
          DO i=ifirst,ilast
            IF (extm(i, j-1) .AND. extm(i, j) .AND. extm(i, j+1)) THEN
              bl(i, j) = 0.
              br(i, j) = 0.
            ELSE
              bl(i, j) = al(i, j) - q(i, j)
              br(i, j) = al(i, j+1) - q(i, j)
            END IF
          END DO
        END DO
! Additional positive definite constraint:
        IF (jord .EQ. -7) THEN
          DO j=jfirst-1,jlast+1
            arg1 = ilast - ifirst + 1
            CALL PERT_PPM(arg1, q(ifirst, j), bl(ifirst, j), br(ifirst, &
&                   j), 0)
          END DO
        END IF
      END IF
    ELSE
! Monotonic constraints:
! ord = 8: PPM with Lin's PPM fast monotone constraint
! ord > 8: PPM with Lin's modification of Huynh 2nd constraint
      DO j=js-2,je+2
        DO i=ifirst,ilast
          xt = 0.25*(q(i, j+1)-q(i, j-1))
          IF (xt .GE. 0.) THEN
            x1 = xt
          ELSE
            x1 = -xt
          END IF
          IF (q(i, j-1) .LT. q(i, j)) THEN
            IF (q(i, j) .LT. q(i, j+1)) THEN
              max1 = q(i, j+1)
            ELSE
              max1 = q(i, j)
            END IF
          ELSE IF (q(i, j-1) .LT. q(i, j+1)) THEN
            max1 = q(i, j+1)
          ELSE
            max1 = q(i, j-1)
          END IF
          y1 = max1 - q(i, j)
          IF (q(i, j-1) .GT. q(i, j)) THEN
            IF (q(i, j) .GT. q(i, j+1)) THEN
              min4 = q(i, j+1)
            ELSE
              min4 = q(i, j)
            END IF
          ELSE IF (q(i, j-1) .GT. q(i, j+1)) THEN
            min4 = q(i, j+1)
          ELSE
            min4 = q(i, j-1)
          END IF
          z1 = q(i, j) - min4
          IF (x1 .GT. y1) THEN
            IF (y1 .GT. z1) THEN
              min1 = z1
            ELSE
              min1 = y1
            END IF
          ELSE IF (x1 .GT. z1) THEN
            min1 = z1
          ELSE
            min1 = x1
          END IF
          dm(i, j) = SIGN(min1, xt)
        END DO
      END DO
      DO j=js1,je1+1
        DO i=ifirst,ilast
          al(i, j) = 0.5*(q(i, j-1)+q(i, j)) + r3*(dm(i, j-1)-dm(i, j))
        END DO
      END DO
      IF (jord .EQ. -8) THEN
        DO j=js1,je1
          DO i=ifirst,ilast
            xt = 2.*dm(i, j)
            IF (xt .GE. 0.) THEN
              x2 = xt
            ELSE
              x2 = -xt
            END IF
            IF (al(i, j) - q(i, j) .GE. 0.) THEN
              y2 = al(i, j) - q(i, j)
            ELSE
              y2 = -(al(i, j)-q(i, j))
            END IF
            IF (x2 .GT. y2) THEN
              min2 = y2
            ELSE
              min2 = x2
            END IF
            bl(i, j) = -SIGN(min2, xt)
            IF (xt .GE. 0.) THEN
              x3 = xt
            ELSE
              x3 = -xt
            END IF
            IF (al(i, j+1) - q(i, j) .GE. 0.) THEN
              y3 = al(i, j+1) - q(i, j)
            ELSE
              y3 = -(al(i, j+1)-q(i, j))
            END IF
            IF (x3 .GT. y3) THEN
              min3 = y3
            ELSE
              min3 = x3
            END IF
            br(i, j) = SIGN(min3, xt)
          END DO
        END DO
      ELSE
        DO j=js1-2,je1+1
          DO i=ifirst,ilast
            dq(i, j) = q(i, j+1) - q(i, j)
          END DO
        END DO
        DO j=js1,je1
          DO i=ifirst,ilast
            bl(i, j) = al(i, j) - q(i, j)
            br(i, j) = al(i, j+1) - q(i, j)
            IF (dm(i, j-1) .GE. 0.) THEN
              abs1 = dm(i, j-1)
            ELSE
              abs1 = -dm(i, j-1)
            END IF
            IF (dm(i, j) .GE. 0.) THEN
              abs3 = dm(i, j)
            ELSE
              abs3 = -dm(i, j)
            END IF
            IF (dm(i, j+1) .GE. 0.) THEN
              abs5 = dm(i, j+1)
            ELSE
              abs5 = -dm(i, j+1)
            END IF
            IF (abs1 + abs3 + abs5 .LT. near_zero) THEN
              bl(i, j) = 0.
              br(i, j) = 0.
            ELSE
              IF (3.*(bl(i, j)+br(i, j)) .GE. 0.) THEN
                abs2 = 3.*(bl(i, j)+br(i, j))
              ELSE
                abs2 = -(3.*(bl(i, j)+br(i, j)))
              END IF
              IF (bl(i, j) - br(i, j) .GE. 0.) THEN
                abs4 = bl(i, j) - br(i, j)
              ELSE
                abs4 = -(bl(i, j)-br(i, j))
              END IF
              IF (abs2 .GT. abs4) THEN
                pmp_1 = -(2.*dq(i, j))
                lac_1 = pmp_1 + 1.5*dq(i, j+1)
                IF (0. .LT. pmp_1) THEN
                  IF (pmp_1 .LT. lac_1) THEN
                    x4 = lac_1
                  ELSE
                    x4 = pmp_1
                  END IF
                ELSE IF (0. .LT. lac_1) THEN
                  x4 = lac_1
                ELSE
                  x4 = 0.
                END IF
                IF (0. .GT. pmp_1) THEN
                  IF (pmp_1 .GT. lac_1) THEN
                    y6 = lac_1
                  ELSE
                    y6 = pmp_1
                  END IF
                ELSE IF (0. .GT. lac_1) THEN
                  y6 = lac_1
                ELSE
                  y6 = 0.
                END IF
                IF (bl(i, j) .LT. y6) THEN
                  y4 = y6
                ELSE
                  y4 = bl(i, j)
                END IF
                IF (x4 .GT. y4) THEN
                  bl(i, j) = y4
                ELSE
                  bl(i, j) = x4
                END IF
                pmp_2 = 2.*dq(i, j-1)
                lac_2 = pmp_2 - 1.5*dq(i, j-2)
                IF (0. .LT. pmp_2) THEN
                  IF (pmp_2 .LT. lac_2) THEN
                    x5 = lac_2
                  ELSE
                    x5 = pmp_2
                  END IF
                ELSE IF (0. .LT. lac_2) THEN
                  x5 = lac_2
                ELSE
                  x5 = 0.
                END IF
                IF (0. .GT. pmp_2) THEN
                  IF (pmp_2 .GT. lac_2) THEN
                    y7 = lac_2
                  ELSE
                    y7 = pmp_2
                  END IF
                ELSE IF (0. .GT. lac_2) THEN
                  y7 = lac_2
                ELSE
                  y7 = 0.
                END IF
                IF (br(i, j) .LT. y7) THEN
                  y5 = y7
                ELSE
                  y5 = br(i, j)
                END IF
                IF (x5 .GT. y5) THEN
                  br(i, j) = y5
                ELSE
                  br(i, j) = x5
                END IF
              END IF
            END IF
          END DO
        END DO
      END IF
      IF (jord .EQ. -9 .OR. jord .EQ. -13) THEN
! Positive definite constraint:
        DO j=js1,je1
          arg1 = ilast - ifirst + 1
          CALL PERT_PPM(arg1, q(ifirst, j), bl(ifirst, j), br(ifirst, j)&
&                 , 0)
        END DO
      END IF
      IF (.NOT.nested .AND. grid_type .LT. 3) THEN
        IF (js .EQ. 1) THEN
          DO i=ifirst,ilast
            bl(i, 0) = s14*dm(i, -1) + s11*(q(i, -1)-q(i, 0))
            xt = 0.5*(((2.*dya(i, 0)+dya(i, -1))*q(i, 0)-dya(i, 0)*q(i, &
&             -1))/(dya(i, -1)+dya(i, 0))+((2.*dya(i, 1)+dya(i, 2))*q(i&
&             , 1)-dya(i, 1)*q(i, 2))/(dya(i, 1)+dya(i, 2)))
            br(i, 0) = xt - q(i, 0)
            bl(i, 1) = xt - q(i, 1)
            xt = s15*q(i, 1) + s11*q(i, 2) - s14*dm(i, 2)
            br(i, 1) = xt - q(i, 1)
            bl(i, 2) = xt - q(i, 2)
            br(i, 2) = al(i, 3) - q(i, 2)
          END DO
          arg1 = 3*(ilast-ifirst+1)
          CALL PERT_PPM(arg1, q(ifirst, 0), bl(ifirst, 0), br(ifirst, 0)&
&                 , 1)
        END IF
        IF (je + 1 .EQ. npy) THEN
          DO i=ifirst,ilast
            bl(i, npy-2) = al(i, npy-2) - q(i, npy-2)
            xt = s15*q(i, npy-1) + s11*q(i, npy-2) + s14*dm(i, npy-2)
            br(i, npy-2) = xt - q(i, npy-2)
            bl(i, npy-1) = xt - q(i, npy-1)
            xt = 0.5*(((2.*dya(i, npy-1)+dya(i, npy-2))*q(i, npy-1)-dya(&
&             i, npy-1)*q(i, npy-2))/(dya(i, npy-2)+dya(i, npy-1))+((2.*&
&             dya(i, npy)+dya(i, npy+1))*q(i, npy)-dya(i, npy)*q(i, npy+&
&             1))/(dya(i, npy)+dya(i, npy+1)))
            br(i, npy-1) = xt - q(i, npy-1)
            bl(i, npy) = xt - q(i, npy)
            br(i, npy) = s11*(q(i, npy+1)-q(i, npy)) - s14*dm(i, npy+1)
          END DO
          arg1 = 3*(ilast-ifirst+1)
          CALL PERT_PPM(arg1, q(ifirst, npy-2), bl(ifirst, npy-2), br(&
&                 ifirst, npy-2), 1)
        END IF
      END IF
    END IF
    DO j=jfirst,jlast+1
      DO i=ifirst,ilast
        IF (c(i, j) .GT. 0.) THEN
          flux(i, j) = q(i, j-1) + (1.-c(i, j))*(br(i, j-1)-c(i, j)*(bl(&
&           i, j-1)+br(i, j-1)))
        ELSE
          flux(i, j) = q(i, j) + (1.+c(i, j))*(bl(i, j)+c(i, j)*(bl(i, j&
&           )+br(i, j)))
        END IF
      END DO
    END DO
  END SUBROUTINE YPPM0
!  Differentiation of fxppm in reverse (adjoint) mode (with options r8 split(a2b_edge_mod.a2b_ord2 a2b_edge_mod.a2b_ord4 a2b_e
!dge_mod.extrap_corner  dyn_core_mod.dyn_core dyn_core_mod.pk3_halo dyn_core_mod.pln_halo dyn_core_mod.pe_halo dyn_core_mod.ad
!v_pe dyn_core_mod.p_grad_c dyn_core_mod.nh_p_grad dyn_core_mod.split_p_grad dyn_core_mod.one_grad_p dyn_core_mod.grad1_p_update 
!dyn_core_mod.mix_dp dyn_core_mod.geopk dyn_core_mod.del2_cubed fv_dynamics_mod.fv_dynamics fv_dynamics_mod.rayleigh_super fv_dyn
!amics_mod.rayleigh_friction fv_dynamics_mod.compute_aam fv_dynamics_mod.geos_to_fv3 fv_grid_utils_mod.cubed_to_latlon fv_grid_ut
!ils_mod.c2l_ord4 fv_grid_utils_mod.c2l_ord2 fv_mapz_mod.lagrangian_to_eulerian fv_mapz_mod.compute_total_energy fv_mapz_mod.pkez
! fv_mapz_mod.remap_z fv_mapz_mod.map_scalar fv_mapz_mod.map1_ppm fv_mapz_mod.mapn_tracer fv_mapz_mod.map1_q2 fv_m
!apz_mod.map1_cubic fv_mapz_mod.scalar_profile_linear fv_mapz_mod.cs_profile_linear fv_mapz_mod.steepz fv_tracer2d_mod.trac
!er_2d fv_tracer2d_mod.tracer_2d_nested nh_core_mod.update_dz_c nh_core_mod.update_dz_d nh_core_mod.riem_solver_c nh_core_mod.rie
!m_solver3 nh_core_mod.rim_2d nh_core_mod.sim3_solver nh_core_mod.sim3p0_solver nh_core_mod.sim1_solver nh_core_mod.sim_solver nh
!_core_mod.edge_profile sw_core_mod.c_sw sw_core_mod.d_sw sw_core_mod.divergence_corner sw_core_mod.divergence_corner_nest sw_cor
!e_mod.d2a2c_vect sw_core_mod.edge_interpolate4 sw_core_mod.fill2_4corners sw_core_mod.fill_4corners sw_core_mod.compute_div_damp
!ing_fb sw_core_mod.smag_corner sw_core_mod.ytp_v sw_core_mod.xtp_u tp_core_mod.fv_tp_2d tp_core_mod.copy_corners 
!tp_core_mod.xtp tp_core_mod.ytp tp_core_mod.xppm0 tp_core_mod.yppm0 tp_core_mod.fxppm tp_core_mod.fyppm tp_cor
!e_mod.deln_flux)):
!   gradient     of useful results: q flux c
!   with respect to varying inputs: q flux c
  SUBROUTINE FXPPM_ADM(c, c_ad, q, q_ad, flux, flux_ad, iord, ifirst, &
&   ilast, jfirst, jlast, npx, npy, bd, dxa, nested, grid_type)
    IMPLICIT NONE
! !INPUT PARAMETERS:
    TYPE(FV_GRID_BOUNDS_TYPE), INTENT(IN) :: bd
!  X-Dir strip
    INTEGER, INTENT(IN) :: ifirst, ilast
!  Y-Dir strip
    INTEGER, INTENT(IN) :: jfirst, jlast
    INTEGER, INTENT(IN) :: iord
    INTEGER, INTENT(IN) :: npx, npy
    REAL(fvprc), INTENT(IN) :: q(ifirst-ng:ilast+ng, jfirst:jlast)
    REAL(fvprc) :: q_ad(ifirst-ng:ilast+ng, jfirst:jlast)
! Courant   N (like FLUX)
    REAL(fvprc), INTENT(IN) :: c(ifirst:ilast+1, jfirst:jlast)
    REAL(fvprc) :: c_ad(ifirst:ilast+1, jfirst:jlast)
    REAL(fvprc), INTENT(IN) :: dxa(bd%isd:bd%ied, bd%jsd:bd%jed)
    LOGICAL, INTENT(IN) :: nested
    INTEGER, INTENT(IN) :: grid_type
! !OUTPUT PARAMETERS:
!  Flux
    REAL(fvprc) :: flux(ifirst:ilast+1, jfirst:jlast)
    REAL(fvprc) :: flux_ad(ifirst:ilast+1, jfirst:jlast)
! Local
    LOGICAL :: extm(ifirst-2:ilast+2)
    REAL(fvprc) :: dm1(ifirst-2:ilast+2)
    REAL(fvprc) :: dm1_ad(ifirst-2:ilast+2)
    REAL(fvprc) :: al(ifirst-1:ilast+2)
    REAL(fvprc) :: al_ad(ifirst-1:ilast+2)
    REAL(fvprc) :: bl(ifirst-1:ilast+1)
    REAL(fvprc) :: bl_ad(ifirst-1:ilast+1)
    REAL(fvprc) :: br(ifirst-1:ilast+1)
    REAL(fvprc) :: br_ad(ifirst-1:ilast+1)
    REAL(fvprc) :: dq(ifirst-3:ilast+2)
    REAL(fvprc) :: dq_ad(ifirst-3:ilast+2)
    REAL(fvprc) :: dl, dr, pmp, lac, ct, qe
    REAL(fvprc) :: dl_ad, dr_ad, pmp_ad, lac_ad
    REAL(fvprc) :: pmp_1, lac_1, pmp_2, lac_2
    REAL(fvprc) :: pmp_1_ad, lac_1_ad, pmp_2_ad, lac_2_ad
    REAL(fvprc) :: xt, x1, x0, x0l, x0r
    REAL(fvprc) :: xt_ad, x1_ad, x0_ad, x0l_ad, x0r_ad
    INTEGER :: i, j, is3, ie3, it
    REAL(fvprc) :: bl6(ifirst-1:ilast+1, jfirst:jlast)
    REAL(fvprc) :: bl6_ad(ifirst-1:ilast+1, jfirst:jlast)
    REAL(fvprc) :: br6(ifirst-1:ilast+1, jfirst:jlast)
    REAL(fvprc) :: br6_ad(ifirst-1:ilast+1, jfirst:jlast)
    INTEGER :: is, ie, js, je, isd, ied, jsd, jed
    INTRINSIC MAX
    INTRINSIC MIN
    INTRINSIC ABS
    INTRINSIC SIGN
    REAL(fvprc) :: min1
    REAL(fvprc) :: min1_ad
    REAL(fvprc) :: min2
    REAL(fvprc) :: min2_ad
    REAL(fvprc) :: min3
    REAL(fvprc) :: min3_ad
    REAL(fvprc) :: min4
    REAL(fvprc) :: min4_ad
    REAL(fvprc) :: min5
    REAL(fvprc) :: min5_ad
    REAL(fvprc) :: min6
    REAL(fvprc) :: min6_ad
    REAL(fvprc) :: min7
    REAL(fvprc) :: min7_ad
    REAL(fvprc) :: min8
    REAL(fvprc) :: min8_ad
    REAL(fvprc) :: min9
    REAL(fvprc) :: min9_ad
    REAL(fvprc) :: min10
    REAL(fvprc) :: min10_ad
    REAL(fvprc) :: min11
    REAL(fvprc) :: min11_ad
    REAL(fvprc) :: min12
    REAL(fvprc) :: min12_ad
    REAL(fvprc) :: min13
    REAL(fvprc) :: min13_ad
    REAL(fvprc) :: abs0
    REAL(fvprc) :: abs1
    REAL(fvprc) :: min14
    REAL(fvprc) :: min14_ad
    REAL(fvprc) :: min15
    REAL(fvprc) :: min15_ad
    REAL(fvprc) :: min16
    REAL(fvprc) :: min16_ad
    REAL(fvprc) :: min17
    REAL(fvprc) :: min17_ad
    REAL(fvprc) :: abs2
    REAL(fvprc) :: abs3
    REAL(fvprc) :: min18
    REAL(fvprc) :: min18_ad
    REAL(fvprc) :: min19
    REAL(fvprc) :: min19_ad
    REAL(fvprc) :: max1
    REAL(fvprc) :: max1_ad
    REAL(fvprc) :: min20
    REAL(fvprc) :: min20_ad
    REAL(fvprc) :: max2
    REAL(fvprc) :: max2_ad
    REAL(fvprc) :: min21
    REAL(fvprc) :: min21_ad
    REAL(fvprc) :: max3
    REAL(fvprc) :: max3_ad
    REAL(fvprc) :: min22
    REAL(fvprc) :: min22_ad
    REAL(fvprc) :: max4
    REAL(fvprc) :: max4_ad
    REAL(fvprc) :: min23
    REAL(fvprc) :: min23_ad
    REAL(fvprc) :: max5
    REAL(fvprc) :: max5_ad
    REAL(fvprc) :: min24
    REAL(fvprc) :: min24_ad
    REAL(fvprc) :: max6
    REAL(fvprc) :: max6_ad
    REAL(fvprc) :: min25
    REAL(fvprc) :: min25_ad
    REAL(fvprc) :: max7
    REAL(fvprc) :: max7_ad
    REAL(fvprc) :: min26
    REAL(fvprc) :: min26_ad
    REAL(fvprc) :: abs4
    REAL(fvprc) :: abs5
    REAL(fvprc) :: max8
    REAL(fvprc) :: max8_ad
    REAL(fvprc) :: min27
    REAL(fvprc) :: min27_ad
    REAL(fvprc) :: max9
    REAL(fvprc) :: max9_ad
    REAL(fvprc) :: min28
    REAL(fvprc) :: min28_ad
    REAL(fvprc) :: abs6
    REAL(fvprc) :: abs7
    REAL(fvprc) :: abs8
    REAL(fvprc) :: abs9
    INTEGER :: arg1
    REAL(fvprc) :: x2_ad
    REAL(fvprc) :: y1_ad
    REAL(fvprc) :: z1_ad
    REAL(fvprc) :: temp_ad
    REAL(fvprc) :: temp_ad0
    REAL(fvprc) :: x3_ad
    REAL(fvprc) :: y2_ad
    REAL(fvprc) :: z2_ad
    REAL(fvprc) :: x4_ad
    REAL(fvprc) :: y3_ad
    REAL(fvprc) :: z3_ad
    REAL(fvprc) :: temp_ad1
    REAL(fvprc) :: temp_ad2
    REAL(fvprc) :: x5_ad
    REAL(fvprc) :: y4_ad
    REAL(fvprc) :: z4_ad
    REAL(fvprc) :: x6_ad
    REAL(fvprc) :: y5_ad
    REAL(fvprc) :: z5_ad
    REAL(fvprc) :: temp
    REAL(fvprc) :: temp_ad3
    REAL(fvprc) :: temp_ad4
    REAL(fvprc) :: temp_ad5
    REAL(fvprc) :: temp_ad6
    REAL(fvprc) :: x7_ad
    REAL(fvprc) :: y6_ad
    REAL(fvprc) :: x8_ad
    REAL(fvprc) :: y7_ad
    REAL(fvprc) :: temp_ad7
    REAL(fvprc) :: temp_ad8
    REAL(fvprc) :: x9_ad
    REAL(fvprc) :: y8_ad
    REAL(fvprc) :: x10_ad
    REAL(fvprc) :: y9_ad
    REAL(fvprc) :: temp_ad9
    REAL(fvprc) :: temp_ad10
    REAL(fvprc) :: x11_ad
    REAL(fvprc) :: y10_ad
    REAL(fvprc) :: z6_ad
    REAL(fvprc) :: x12_ad
    REAL(fvprc) :: y34_ad
    REAL(fvprc) :: y11_ad
    REAL(fvprc) :: x13_ad
    REAL(fvprc) :: y35_ad
    REAL(fvprc) :: y12_ad
    REAL(fvprc) :: temp0
    REAL(fvprc) :: temp_ad11
    REAL(fvprc) :: temp_ad12
    REAL(fvprc) :: temp_ad13
    REAL(fvprc) :: temp_ad14
    REAL(fvprc) :: temp_ad15
    REAL(fvprc) :: temp_ad16
    REAL(fvprc) :: temp_ad17
    REAL(fvprc) :: temp_ad18
    REAL(fvprc) :: temp1
    REAL(fvprc) :: temp_ad19
    REAL(fvprc) :: temp_ad20
    REAL(fvprc) :: temp2
    REAL(fvprc) :: temp_ad21
    REAL(fvprc) :: temp_ad22
    REAL(fvprc) :: x14_ad
    REAL(fvprc) :: y13_ad
    REAL(fvprc) :: z7_ad
    REAL(fvprc) :: x15_ad
    REAL(fvprc) :: y14_ad
    REAL(fvprc) :: x16_ad
    REAL(fvprc) :: y15_ad
    REAL(fvprc) :: x17_ad
    REAL(fvprc) :: y36_ad
    REAL(fvprc) :: y16_ad
    REAL(fvprc) :: x18_ad
    REAL(fvprc) :: y37_ad
    REAL(fvprc) :: y17_ad
    REAL(fvprc) :: x19_ad
    REAL(fvprc) :: y38_ad
    REAL(fvprc) :: y18_ad
    REAL(fvprc) :: x20_ad
    REAL(fvprc) :: y39_ad
    REAL(fvprc) :: y19_ad
    REAL(fvprc) :: temp_ad23
    REAL(fvprc) :: temp_ad24
    REAL(fvprc) :: temp_ad25
    REAL(fvprc) :: temp_ad26
    REAL(fvprc) :: x21_ad
    REAL(fvprc) :: y20_ad
    REAL(fvprc) :: z8_ad
    REAL(fvprc) :: x22_ad
    REAL(fvprc) :: y40_ad
    REAL(fvprc) :: y21_ad
    REAL(fvprc) :: x23_ad
    REAL(fvprc) :: y41_ad
    REAL(fvprc) :: y22_ad
    REAL(fvprc) :: temp3
    REAL(fvprc) :: temp_ad27
    REAL(fvprc) :: temp_ad28
    REAL(fvprc) :: temp_ad29
    REAL(fvprc) :: temp_ad30
    REAL(fvprc) :: x24_ad
    REAL(fvprc) :: y23_ad
    REAL(fvprc) :: z9_ad
    REAL(fvprc) :: x25_ad
    REAL(fvprc) :: y24_ad
    REAL(fvprc) :: x26_ad
    REAL(fvprc) :: y25_ad
    REAL(fvprc) :: x27_ad
    REAL(fvprc) :: y42_ad
    REAL(fvprc) :: y26_ad
    REAL(fvprc) :: x28_ad
    REAL(fvprc) :: y43_ad
    REAL(fvprc) :: y27_ad
    REAL(fvprc) :: x29_ad
    REAL(fvprc) :: y44_ad
    REAL(fvprc) :: y28_ad
    REAL(fvprc) :: x30_ad
    REAL(fvprc) :: y45_ad
    REAL(fvprc) :: y29_ad
    REAL(fvprc) :: temp_ad31
    REAL(fvprc) :: temp_ad32
    REAL(fvprc) :: temp_ad33
    REAL(fvprc) :: temp_ad34
    REAL(fvprc) :: x31_ad
    REAL(fvprc) :: y30_ad
    REAL(fvprc) :: x32_ad
    REAL(fvprc) :: y31_ad
    REAL(fvprc) :: x33_ad
    REAL(fvprc) :: y46_ad
    REAL(fvprc) :: y32_ad
    REAL(fvprc) :: x34_ad
    REAL(fvprc) :: y47_ad
    REAL(fvprc) :: y33_ad
    REAL(fvprc) :: temp4
    REAL(fvprc) :: temp_ad35
    REAL(fvprc) :: temp_ad36
    REAL(fvprc) :: temp_ad37
    REAL(fvprc) :: temp_ad38
    INTEGER :: branch
    INTEGER :: ad_from
    INTEGER :: ad_to
    INTEGER :: ad_from0
    INTEGER :: ad_to0
    INTEGER :: ad_from1
    INTEGER :: ad_to1
    INTEGER :: ad_from2
    INTEGER :: ad_to2
    REAL(fvprc) :: x19
    REAL(fvprc) :: x18
    REAL(fvprc) :: x17
    REAL(fvprc) :: x16
    REAL(fvprc) :: x15
    REAL(fvprc) :: x14
    REAL(fvprc) :: x13
    REAL(fvprc) :: x12
    REAL(fvprc) :: x11
    REAL(fvprc) :: y29
    REAL(fvprc) :: x10
    REAL(fvprc) :: y28
    REAL(fvprc) :: y27
    REAL(fvprc) :: y26
    REAL(fvprc) :: y25
    REAL(fvprc) :: y24
    REAL(fvprc) :: y23
    REAL(fvprc) :: y22
    REAL(fvprc) :: y21
    REAL(fvprc) :: y20
    REAL(fvprc) :: x9
    REAL(fvprc) :: x8
    REAL(fvprc) :: x7
    REAL(fvprc) :: x6
    REAL(fvprc) :: x5
    REAL(fvprc) :: x4
    REAL(fvprc) :: x3
    REAL(fvprc) :: x2
    REAL(fvprc) :: y19
    REAL(fvprc) :: y18
    REAL(fvprc) :: y17
    REAL(fvprc) :: y16
    REAL(fvprc) :: y15
    REAL(fvprc) :: x34
    REAL(fvprc) :: y14
    REAL(fvprc) :: x33
    REAL(fvprc) :: y13
    REAL(fvprc) :: x32
    REAL(fvprc) :: y12
    REAL(fvprc) :: x31
    REAL(fvprc) :: y11
    REAL(fvprc) :: x30
    REAL(fvprc) :: y10
    REAL(fvprc) :: y47
    REAL(fvprc) :: y46
    REAL(fvprc) :: y45
    REAL(fvprc) :: y44
    REAL(fvprc) :: y43
    REAL(fvprc) :: y42
    REAL(fvprc) :: y41
    REAL(fvprc) :: y40
    REAL(fvprc) :: z9
    REAL(fvprc) :: z8
    REAL(fvprc) :: z7
    REAL(fvprc) :: z6
    REAL(fvprc) :: z5
    REAL(fvprc) :: z4
    REAL(fvprc) :: z3
    REAL(fvprc) :: z2
    REAL(fvprc) :: z1
    REAL(fvprc) :: x29
    REAL(fvprc) :: x28
    REAL(fvprc) :: x27
    REAL(fvprc) :: x26
    REAL(fvprc) :: x25
    REAL(fvprc) :: x24
    REAL(fvprc) :: x23
    REAL(fvprc) :: x22
    REAL(fvprc) :: x21
    REAL(fvprc) :: y39
    REAL(fvprc) :: x20
    REAL(fvprc) :: y38
    REAL(fvprc) :: y37
    REAL(fvprc) :: y36
    REAL(fvprc) :: y35
    REAL(fvprc) :: y34
    REAL(fvprc) :: y33
    REAL(fvprc) :: y32
    REAL(fvprc) :: y31
    REAL(fvprc) :: y30
    REAL(fvprc) :: y9
    REAL(fvprc) :: y8
    REAL(fvprc) :: y7
    REAL(fvprc) :: y6
    REAL(fvprc) :: y5
    REAL(fvprc) :: y4
    REAL(fvprc) :: y3
    REAL(fvprc) :: y2
    REAL(fvprc) :: y1
    is = bd%is
    ie = bd%ie
    IF (nested) THEN
      CALL PUSHCONTROL1B(0)
      is3 = is - 1
      ie3 = ie + 1
    ELSE
      IF (3 .LT. is - 1) THEN
        is3 = is - 1
      ELSE
        is3 = 3
      END IF
      IF (npx - 3 .GT. ie + 1) THEN
        CALL PUSHCONTROL1B(1)
        ie3 = ie + 1
      ELSE
        CALL PUSHCONTROL1B(1)
        ie3 = npx - 3
      END IF
    END IF
    IF (iord .LE. 4) THEN
      DO j=jfirst,jlast
        DO i=is-2,ie+2
          xt = 0.25*(q(i+1, j)-q(i-1, j))
          IF (xt .GE. 0.) THEN
            x2 = xt
            CALL PUSHCONTROL1B(0)
          ELSE
            x2 = -xt
            CALL PUSHCONTROL1B(1)
          END IF
          IF (q(i-1, j) .LT. q(i, j)) THEN
            IF (q(i, j) .LT. q(i+1, j)) THEN
              max1 = q(i+1, j)
              CALL PUSHCONTROL2B(0)
            ELSE
              max1 = q(i, j)
              CALL PUSHCONTROL2B(1)
            END IF
          ELSE IF (q(i-1, j) .LT. q(i+1, j)) THEN
            max1 = q(i+1, j)
            CALL PUSHCONTROL2B(2)
          ELSE
            max1 = q(i-1, j)
            CALL PUSHCONTROL2B(3)
          END IF
          y1 = max1 - q(i, j)
          IF (q(i-1, j) .GT. q(i, j)) THEN
            IF (q(i, j) .GT. q(i+1, j)) THEN
              min20 = q(i+1, j)
              CALL PUSHCONTROL2B(0)
            ELSE
              min20 = q(i, j)
              CALL PUSHCONTROL2B(1)
            END IF
          ELSE IF (q(i-1, j) .GT. q(i+1, j)) THEN
            min20 = q(i+1, j)
            CALL PUSHCONTROL2B(2)
          ELSE
            min20 = q(i-1, j)
            CALL PUSHCONTROL2B(3)
          END IF
          z1 = q(i, j) - min20
          IF (x2 .GT. y1) THEN
            IF (y1 .GT. z1) THEN
              CALL PUSHREALARRAY_ADM(min1)
              min1 = z1
              CALL PUSHCONTROL2B(0)
            ELSE
              CALL PUSHREALARRAY_ADM(min1)
              min1 = y1
              CALL PUSHCONTROL2B(1)
            END IF
          ELSE IF (x2 .GT. z1) THEN
            CALL PUSHREALARRAY_ADM(min1)
            min1 = z1
            CALL PUSHCONTROL2B(2)
          ELSE
            CALL PUSHREALARRAY_ADM(min1)
            min1 = x2
            CALL PUSHCONTROL2B(3)
          END IF
          CALL PUSHREALARRAY_ADM(dm1(i))
          dm1(i) = SIGN(min1, xt)
        END DO
        IF (grid_type .LT. 3) THEN
          DO i=is3,ie3+1
!        do i=max(3,is-1),min(npx-2,ie+2)
            al(i) = 0.5*(q(i-1, j)+q(i, j)) + r3*(dm1(i-1)-dm1(i))
          END DO
!.not. nested
! Fix the edges:
          IF (.NOT.nested) THEN
            IF (is .EQ. 1) THEN
              x0l = 0.5*((2.*dxa(0, j)+dxa(-1, j))*q(0, j)-dxa(0, j)*q(-&
&               1, j))/(dxa(0, j)+dxa(-1, j))
              x0r = 0.5*((2.*dxa(1, j)+dxa(2, j))*q(1, j)-dxa(1, j)*q(2&
&               , j))/(dxa(1, j)+dxa(2, j))
              x0 = x0l + x0r
              al(1) = x0
              x1 = s15*q(0, j) + s11*q(-1, j) + s14*dm1(-1)
              CALL PUSHREALARRAY_ADM(dm1(0))
              dm1(0) = 0.5*(x0-x1)
              IF (dm1(0) .GE. 0.) THEN
                x3 = dm1(0)
                CALL PUSHCONTROL1B(0)
              ELSE
                x3 = -dm1(0)
                CALL PUSHCONTROL1B(1)
              END IF
              IF (q(0, j) .LT. x0) THEN
                IF (x0 .LT. x1) THEN
                  max2 = x1
                  CALL PUSHCONTROL2B(0)
                ELSE
                  max2 = x0
                  CALL PUSHCONTROL2B(1)
                END IF
              ELSE IF (q(0, j) .LT. x1) THEN
                max2 = x1
                CALL PUSHCONTROL2B(2)
              ELSE
                max2 = q(0, j)
                CALL PUSHCONTROL2B(3)
              END IF
              y2 = max2 - q(0, j)
              IF (q(0, j) .GT. x0) THEN
                IF (x0 .GT. x1) THEN
                  min21 = x1
                  CALL PUSHCONTROL2B(0)
                ELSE
                  min21 = x0
                  CALL PUSHCONTROL2B(1)
                END IF
              ELSE IF (q(0, j) .GT. x1) THEN
                min21 = x1
                CALL PUSHCONTROL2B(2)
              ELSE
                min21 = q(0, j)
                CALL PUSHCONTROL2B(3)
              END IF
              z2 = q(0, j) - min21
              IF (x3 .GT. y2) THEN
                IF (y2 .GT. z2) THEN
                  CALL PUSHREALARRAY_ADM(min2)
                  min2 = z2
                  CALL PUSHCONTROL2B(0)
                ELSE
                  CALL PUSHREALARRAY_ADM(min2)
                  min2 = y2
                  CALL PUSHCONTROL2B(1)
                END IF
              ELSE IF (x3 .GT. z2) THEN
                CALL PUSHREALARRAY_ADM(min2)
                min2 = z2
                CALL PUSHCONTROL2B(2)
              ELSE
                CALL PUSHREALARRAY_ADM(min2)
                min2 = x3
                CALL PUSHCONTROL2B(3)
              END IF
              CALL PUSHREALARRAY_ADM(dm1(0))
              dm1(0) = SIGN(min2, dm1(0))
              al(0) = 0.5*(q(-1, j)+q(0, j)) + r3*(dm1(-1)-dm1(0))
!
              x1 = s15*q(1, j) + s11*q(2, j) - s14*dm1(2)
              CALL PUSHREALARRAY_ADM(dm1(1))
              dm1(1) = 0.5*(x1-x0)
              IF (dm1(1) .GE. 0.) THEN
                x4 = dm1(1)
                CALL PUSHCONTROL1B(0)
              ELSE
                x4 = -dm1(1)
                CALL PUSHCONTROL1B(1)
              END IF
              IF (q(1, j) .LT. x0) THEN
                IF (x0 .LT. x1) THEN
                  max3 = x1
                  CALL PUSHCONTROL2B(0)
                ELSE
                  max3 = x0
                  CALL PUSHCONTROL2B(1)
                END IF
              ELSE IF (q(1, j) .LT. x1) THEN
                max3 = x1
                CALL PUSHCONTROL2B(2)
              ELSE
                max3 = q(1, j)
                CALL PUSHCONTROL2B(3)
              END IF
              y3 = max3 - q(1, j)
              IF (q(1, j) .GT. x0) THEN
                IF (x0 .GT. x1) THEN
                  min22 = x1
                  CALL PUSHCONTROL2B(0)
                ELSE
                  min22 = x0
                  CALL PUSHCONTROL2B(1)
                END IF
              ELSE IF (q(1, j) .GT. x1) THEN
                min22 = x1
                CALL PUSHCONTROL2B(2)
              ELSE
                min22 = q(1, j)
                CALL PUSHCONTROL2B(3)
              END IF
              z3 = q(1, j) - min22
              IF (x4 .GT. y3) THEN
                IF (y3 .GT. z3) THEN
                  CALL PUSHREALARRAY_ADM(min3)
                  min3 = z3
                  CALL PUSHCONTROL2B(0)
                ELSE
                  CALL PUSHREALARRAY_ADM(min3)
                  min3 = y3
                  CALL PUSHCONTROL2B(1)
                END IF
              ELSE IF (x4 .GT. z3) THEN
                CALL PUSHREALARRAY_ADM(min3)
                min3 = z3
                CALL PUSHCONTROL2B(2)
              ELSE
                CALL PUSHREALARRAY_ADM(min3)
                min3 = x4
                CALL PUSHCONTROL2B(3)
              END IF
              CALL PUSHREALARRAY_ADM(dm1(1))
              dm1(1) = SIGN(min3, dm1(1))
              al(2) = 0.5*(q(1, j)+q(2, j)) + r3*(dm1(1)-dm1(2))
              CALL PUSHCONTROL1B(0)
            ELSE
              CALL PUSHCONTROL1B(1)
            END IF
            IF (ie + 1 .EQ. npx) THEN
              x0l = 0.5*((2.*dxa(npx-1, j)+dxa(npx-2, j))*q(npx-1, j)-&
&               dxa(npx-1, j)*q(npx-2, j))/(dxa(npx-1, j)+dxa(npx-2, j))
              x0r = 0.5*((2.*dxa(npx, j)+dxa(npx+1, j))*q(npx, j)-dxa(&
&               npx, j)*q(npx+1, j))/(dxa(npx, j)+dxa(npx+1, j))
              x0 = x0l + x0r
              al(npx) = x0
              x1 = s15*q(npx-1, j) + s11*q(npx-2, j) + s14*dm1(npx-2)
              CALL PUSHREALARRAY_ADM(dm1(npx-1))
              dm1(npx-1) = 0.5*(x0-x1)
              IF (dm1(npx-1) .GE. 0.) THEN
                x5 = dm1(npx-1)
                CALL PUSHCONTROL1B(0)
              ELSE
                x5 = -dm1(npx-1)
                CALL PUSHCONTROL1B(1)
              END IF
              IF (q(npx-1, j) .LT. x0) THEN
                IF (x0 .LT. x1) THEN
                  max4 = x1
                  CALL PUSHCONTROL2B(0)
                ELSE
                  max4 = x0
                  CALL PUSHCONTROL2B(1)
                END IF
              ELSE IF (q(npx-1, j) .LT. x1) THEN
                max4 = x1
                CALL PUSHCONTROL2B(2)
              ELSE
                max4 = q(npx-1, j)
                CALL PUSHCONTROL2B(3)
              END IF
              y4 = max4 - q(npx-1, j)
              IF (q(npx-1, j) .GT. x0) THEN
                IF (x0 .GT. x1) THEN
                  min23 = x1
                  CALL PUSHCONTROL2B(0)
                ELSE
                  min23 = x0
                  CALL PUSHCONTROL2B(1)
                END IF
              ELSE IF (q(npx-1, j) .GT. x1) THEN
                min23 = x1
                CALL PUSHCONTROL2B(2)
              ELSE
                min23 = q(npx-1, j)
                CALL PUSHCONTROL2B(3)
              END IF
              z4 = q(npx-1, j) - min23
              IF (x5 .GT. y4) THEN
                IF (y4 .GT. z4) THEN
                  CALL PUSHREALARRAY_ADM(min4)
                  min4 = z4
                  CALL PUSHCONTROL2B(0)
                ELSE
                  CALL PUSHREALARRAY_ADM(min4)
                  min4 = y4
                  CALL PUSHCONTROL2B(1)
                END IF
              ELSE IF (x5 .GT. z4) THEN
                CALL PUSHREALARRAY_ADM(min4)
                min4 = z4
                CALL PUSHCONTROL2B(2)
              ELSE
                CALL PUSHREALARRAY_ADM(min4)
                min4 = x5
                CALL PUSHCONTROL2B(3)
              END IF
              CALL PUSHREALARRAY_ADM(dm1(npx-1))
              dm1(npx-1) = SIGN(min4, dm1(npx-1))
              al(npx-1) = 0.5*(q(npx-2, j)+q(npx-1, j)) + r3*(dm1(npx-2)&
&               -dm1(npx-1))
!
              x1 = s15*q(npx, j) + s11*q(npx+1, j) - s14*dm1(npx+1)
              CALL PUSHREALARRAY_ADM(dm1(npx))
              dm1(npx) = 0.5*(x1-x0)
              IF (dm1(npx) .GE. 0.) THEN
                x6 = dm1(npx)
                CALL PUSHCONTROL1B(0)
              ELSE
                x6 = -dm1(npx)
                CALL PUSHCONTROL1B(1)
              END IF
              IF (q(npx, j) .LT. x0) THEN
                IF (x0 .LT. x1) THEN
                  max5 = x1
                  CALL PUSHCONTROL2B(0)
                ELSE
                  max5 = x0
                  CALL PUSHCONTROL2B(1)
                END IF
              ELSE IF (q(npx, j) .LT. x1) THEN
                max5 = x1
                CALL PUSHCONTROL2B(2)
              ELSE
                max5 = q(npx, j)
                CALL PUSHCONTROL2B(3)
              END IF
              y5 = max5 - q(npx, j)
              IF (q(npx, j) .GT. x0) THEN
                IF (x0 .GT. x1) THEN
                  min24 = x1
                  CALL PUSHCONTROL2B(0)
                ELSE
                  min24 = x0
                  CALL PUSHCONTROL2B(1)
                END IF
              ELSE IF (q(npx, j) .GT. x1) THEN
                min24 = x1
                CALL PUSHCONTROL2B(2)
              ELSE
                min24 = q(npx, j)
                CALL PUSHCONTROL2B(3)
              END IF
              z5 = q(npx, j) - min24
              IF (x6 .GT. y5) THEN
                IF (y5 .GT. z5) THEN
                  CALL PUSHREALARRAY_ADM(min5)
                  min5 = z5
                  CALL PUSHCONTROL2B(0)
                ELSE
                  CALL PUSHREALARRAY_ADM(min5)
                  min5 = y5
                  CALL PUSHCONTROL2B(1)
                END IF
              ELSE IF (x6 .GT. z5) THEN
                CALL PUSHREALARRAY_ADM(min5)
                min5 = z5
                CALL PUSHCONTROL2B(2)
              ELSE
                CALL PUSHREALARRAY_ADM(min5)
                min5 = x6
                CALL PUSHCONTROL2B(3)
              END IF
              CALL PUSHREALARRAY_ADM(dm1(npx))
              dm1(npx) = SIGN(min5, dm1(npx))
              al(npx+1) = 0.5*(q(npx, j)+q(npx+1, j)) + r3*(dm1(npx)-dm1&
&               (npx+1))
              CALL PUSHCONTROL2B(0)
            ELSE
              CALL PUSHCONTROL2B(1)
            END IF
          ELSE
            CALL PUSHCONTROL2B(2)
          END IF
        ELSE
! For doubly periodic BC
          DO i=is-1,ie+2
            al(i) = 0.5*(q(i-1, j)+q(i, j)) + r3*(dm1(i-1)-dm1(i))
          END DO
          CALL PUSHCONTROL2B(3)
        END IF
        IF (iord .EQ. 3) THEN
          DO i=is-1,ie+1
            CALL PUSHREALARRAY_ADM(bl(i))
            bl(i) = al(i) - q(i, j)
            CALL PUSHREALARRAY_ADM(br(i))
            br(i) = al(i+1) - q(i, j)
          END DO
          arg1 = ie - is + 3
          CALL PUSHREALARRAY_ADM(br(is-1), 8*(ilast-is+3)/8)
          CALL PUSHREALARRAY_ADM(bl(is-1), 8*(ilast-is+3)/8)
          CALL PERT_PPM(arg1, q(is-1, j), bl(is-1), br(is-1), 1)
          DO i=is,ie+1
            IF (c(i, j) .GT. 0.) THEN
              CALL PUSHCONTROL1B(1)
            ELSE
              CALL PUSHCONTROL1B(0)
            END IF
          END DO
          CALL PUSHCONTROL1B(1)
        ELSE
          DO i=is,ie+1
            IF (c(i, j) .GT. 0.) THEN
              xt = ppm_limiter*dm1(i-1)
              IF (xt .GE. 0.) THEN
                x7 = xt
                CALL PUSHCONTROL1B(0)
              ELSE
                x7 = -xt
                CALL PUSHCONTROL1B(1)
              END IF
              IF (al(i-1) - q(i-1, j) .GE. 0.) THEN
                y6 = al(i-1) - q(i-1, j)
                CALL PUSHCONTROL1B(0)
              ELSE
                y6 = -(al(i-1)-q(i-1, j))
                CALL PUSHCONTROL1B(1)
              END IF
              IF (x7 .GT. y6) THEN
                CALL PUSHREALARRAY_ADM(min6)
                min6 = y6
                CALL PUSHCONTROL1B(0)
              ELSE
                CALL PUSHREALARRAY_ADM(min6)
                min6 = x7
                CALL PUSHCONTROL1B(1)
              END IF
              CALL PUSHREALARRAY_ADM(dl)
              dl = SIGN(min6, xt)
              IF (xt .GE. 0.) THEN
                x8 = xt
                CALL PUSHCONTROL1B(0)
              ELSE
                x8 = -xt
                CALL PUSHCONTROL1B(1)
              END IF
              IF (al(i) - q(i-1, j) .GE. 0.) THEN
                y7 = al(i) - q(i-1, j)
                CALL PUSHCONTROL1B(0)
              ELSE
                y7 = -(al(i)-q(i-1, j))
                CALL PUSHCONTROL1B(1)
              END IF
              IF (x8 .GT. y7) THEN
                CALL PUSHREALARRAY_ADM(min7)
                min7 = y7
                CALL PUSHCONTROL1B(0)
              ELSE
                CALL PUSHREALARRAY_ADM(min7)
                min7 = x8
                CALL PUSHCONTROL1B(1)
              END IF
              CALL PUSHREALARRAY_ADM(dr)
              dr = SIGN(min7, xt)
              CALL PUSHCONTROL1B(1)
            ELSE
              xt = ppm_limiter*dm1(i)
              IF (xt .GE. 0.) THEN
                x9 = xt
                CALL PUSHCONTROL1B(0)
              ELSE
                x9 = -xt
                CALL PUSHCONTROL1B(1)
              END IF
              IF (al(i) - q(i, j) .GE. 0.) THEN
                y8 = al(i) - q(i, j)
                CALL PUSHCONTROL1B(0)
              ELSE
                y8 = -(al(i)-q(i, j))
                CALL PUSHCONTROL1B(1)
              END IF
              IF (x9 .GT. y8) THEN
                CALL PUSHREALARRAY_ADM(min8)
                min8 = y8
                CALL PUSHCONTROL1B(0)
              ELSE
                CALL PUSHREALARRAY_ADM(min8)
                min8 = x9
                CALL PUSHCONTROL1B(1)
              END IF
              CALL PUSHREALARRAY_ADM(dl)
              dl = SIGN(min8, xt)
              IF (xt .GE. 0.) THEN
                x10 = xt
                CALL PUSHCONTROL1B(0)
              ELSE
                x10 = -xt
                CALL PUSHCONTROL1B(1)
              END IF
              IF (al(i+1) - q(i, j) .GE. 0.) THEN
                y9 = al(i+1) - q(i, j)
                CALL PUSHCONTROL1B(0)
              ELSE
                y9 = -(al(i+1)-q(i, j))
                CALL PUSHCONTROL1B(1)
              END IF
              IF (x10 .GT. y9) THEN
                CALL PUSHREALARRAY_ADM(min9)
                min9 = y9
                CALL PUSHCONTROL1B(0)
              ELSE
                CALL PUSHREALARRAY_ADM(min9)
                min9 = x10
                CALL PUSHCONTROL1B(1)
              END IF
              CALL PUSHREALARRAY_ADM(dr)
              dr = SIGN(min9, xt)
              CALL PUSHCONTROL1B(0)
            END IF
          END DO
          CALL PUSHCONTROL1B(0)
        END IF
      END DO
      al_ad = 0.0_FVPRC
      dm1_ad = 0.0_FVPRC
      bl_ad = 0.0_FVPRC
      br_ad = 0.0_FVPRC
      DO j=jlast,jfirst,-1
        CALL POPCONTROL1B(branch)
        IF (branch .EQ. 0) THEN
          DO i=ie+1,is,-1
            CALL POPCONTROL1B(branch)
            IF (branch .EQ. 0) THEN
              temp_ad9 = -((c(i, j)+1.)*flux_ad(i, j))
              temp_ad10 = c(i, j)*temp_ad9
              q_ad(i, j) = q_ad(i, j) + flux_ad(i, j)
              c_ad(i, j) = c_ad(i, j) + (dl-dr)*temp_ad9 - (c(i, j)*(dl-&
&               dr)+dl)*flux_ad(i, j)
              dl_ad = temp_ad9 + temp_ad10
              dr_ad = -temp_ad10
              flux_ad(i, j) = 0.0_FVPRC
              xt = ppm_limiter*dm1(i)
              CALL POPREALARRAY_ADM(dr)
              min9_ad = SIGN(1.d0, min9*xt)*dr_ad
              CALL POPCONTROL1B(branch)
              IF (branch .EQ. 0) THEN
                CALL POPREALARRAY_ADM(min9)
                y9_ad = min9_ad
                x10_ad = 0.0_FVPRC
              ELSE
                CALL POPREALARRAY_ADM(min9)
                x10_ad = min9_ad
                y9_ad = 0.0_FVPRC
              END IF
              CALL POPCONTROL1B(branch)
              IF (branch .EQ. 0) THEN
                al_ad(i+1) = al_ad(i+1) + y9_ad
                q_ad(i, j) = q_ad(i, j) - y9_ad
              ELSE
                q_ad(i, j) = q_ad(i, j) + y9_ad
                al_ad(i+1) = al_ad(i+1) - y9_ad
              END IF
              CALL POPCONTROL1B(branch)
              IF (branch .EQ. 0) THEN
                xt_ad = x10_ad
              ELSE
                xt_ad = -x10_ad
              END IF
              CALL POPREALARRAY_ADM(dl)
              min8_ad = SIGN(1.d0, min8*xt)*dl_ad
              CALL POPCONTROL1B(branch)
              IF (branch .EQ. 0) THEN
                CALL POPREALARRAY_ADM(min8)
                y8_ad = min8_ad
                x9_ad = 0.0_FVPRC
              ELSE
                CALL POPREALARRAY_ADM(min8)
                x9_ad = min8_ad
                y8_ad = 0.0_FVPRC
              END IF
              CALL POPCONTROL1B(branch)
              IF (branch .EQ. 0) THEN
                al_ad(i) = al_ad(i) + y8_ad
                q_ad(i, j) = q_ad(i, j) - y8_ad
              ELSE
                q_ad(i, j) = q_ad(i, j) + y8_ad
                al_ad(i) = al_ad(i) - y8_ad
              END IF
              CALL POPCONTROL1B(branch)
              IF (branch .EQ. 0) THEN
                xt_ad = xt_ad + x9_ad
              ELSE
                xt_ad = xt_ad - x9_ad
              END IF
              dm1_ad(i) = dm1_ad(i) + ppm_limiter*xt_ad
            ELSE
              temp_ad7 = (1.-c(i, j))*flux_ad(i, j)
              temp_ad8 = c(i, j)*temp_ad7
              q_ad(i-1, j) = q_ad(i-1, j) + flux_ad(i, j)
              c_ad(i, j) = c_ad(i, j) + (dl-dr)*temp_ad7 - (c(i, j)*(dl-&
&               dr)+dr)*flux_ad(i, j)
              dl_ad = temp_ad8
              dr_ad = temp_ad7 - temp_ad8
              flux_ad(i, j) = 0.0_FVPRC
              xt = ppm_limiter*dm1(i-1)
              CALL POPREALARRAY_ADM(dr)
              min7_ad = SIGN(1.d0, min7*xt)*dr_ad
              CALL POPCONTROL1B(branch)
              IF (branch .EQ. 0) THEN
                CALL POPREALARRAY_ADM(min7)
                y7_ad = min7_ad
                x8_ad = 0.0_FVPRC
              ELSE
                CALL POPREALARRAY_ADM(min7)
                x8_ad = min7_ad
                y7_ad = 0.0_FVPRC
              END IF
              CALL POPCONTROL1B(branch)
              IF (branch .EQ. 0) THEN
                al_ad(i) = al_ad(i) + y7_ad
                q_ad(i-1, j) = q_ad(i-1, j) - y7_ad
              ELSE
                q_ad(i-1, j) = q_ad(i-1, j) + y7_ad
                al_ad(i) = al_ad(i) - y7_ad
              END IF
              CALL POPCONTROL1B(branch)
              IF (branch .EQ. 0) THEN
                xt_ad = x8_ad
              ELSE
                xt_ad = -x8_ad
              END IF
              CALL POPREALARRAY_ADM(dl)
              min6_ad = SIGN(1.d0, min6*xt)*dl_ad
              CALL POPCONTROL1B(branch)
              IF (branch .EQ. 0) THEN
                CALL POPREALARRAY_ADM(min6)
                y6_ad = min6_ad
                x7_ad = 0.0_FVPRC
              ELSE
                CALL POPREALARRAY_ADM(min6)
                x7_ad = min6_ad
                y6_ad = 0.0_FVPRC
              END IF
              CALL POPCONTROL1B(branch)
              IF (branch .EQ. 0) THEN
                al_ad(i-1) = al_ad(i-1) + y6_ad
                q_ad(i-1, j) = q_ad(i-1, j) - y6_ad
              ELSE
                q_ad(i-1, j) = q_ad(i-1, j) + y6_ad
                al_ad(i-1) = al_ad(i-1) - y6_ad
              END IF
              CALL POPCONTROL1B(branch)
              IF (branch .EQ. 0) THEN
                xt_ad = xt_ad + x7_ad
              ELSE
                xt_ad = xt_ad - x7_ad
              END IF
              dm1_ad(i-1) = dm1_ad(i-1) + ppm_limiter*xt_ad
            END IF
          END DO
        ELSE
          DO i=ie+1,is,-1
            CALL POPCONTROL1B(branch)
            IF (branch .EQ. 0) THEN
              temp_ad5 = (c(i, j)+1.)*flux_ad(i, j)
              temp_ad6 = c(i, j)*temp_ad5
              q_ad(i, j) = q_ad(i, j) + flux_ad(i, j)
              c_ad(i, j) = c_ad(i, j) + (bl(i)+br(i))*temp_ad5 + (bl(i)+&
&               c(i, j)*(bl(i)+br(i)))*flux_ad(i, j)
              bl_ad(i) = bl_ad(i) + temp_ad6 + temp_ad5
              br_ad(i) = br_ad(i) + temp_ad6
              flux_ad(i, j) = 0.0_FVPRC
            ELSE
              temp = bl(i-1) + br(i-1)
              temp_ad3 = (1.-c(i, j))*flux_ad(i, j)
              temp_ad4 = -(c(i, j)*temp_ad3)
              q_ad(i-1, j) = q_ad(i-1, j) + flux_ad(i, j)
              c_ad(i, j) = c_ad(i, j) - temp*temp_ad3 - (br(i-1)-c(i, j)&
&               *temp)*flux_ad(i, j)
              br_ad(i-1) = br_ad(i-1) + temp_ad4 + temp_ad3
              bl_ad(i-1) = bl_ad(i-1) + temp_ad4
              flux_ad(i, j) = 0.0_FVPRC
            END IF
          END DO
          arg1 = ie - is + 3
          CALL POPREALARRAY_ADM(bl(is-1), 8*(ilast-is+3)/8)
          CALL POPREALARRAY_ADM(br(is-1), 8*(ilast-is+3)/8)
          CALL PERT_PPM_ADM(arg1, q(is-1, j), bl(is-1:), bl_ad(is-1:), &
&                     br(is-1:), br_ad(is-1:), 1)
          DO i=ie+1,is-1,-1
            CALL POPREALARRAY_ADM(br(i))
            al_ad(i+1) = al_ad(i+1) + br_ad(i)
            q_ad(i, j) = q_ad(i, j) - bl_ad(i) - br_ad(i)
            br_ad(i) = 0.0_FVPRC
            CALL POPREALARRAY_ADM(bl(i))
            al_ad(i) = al_ad(i) + bl_ad(i)
            bl_ad(i) = 0.0_FVPRC
          END DO
        END IF
        CALL POPCONTROL2B(branch)
        IF (branch .LT. 2) THEN
          IF (branch .EQ. 0) THEN
            q_ad(npx, j) = q_ad(npx, j) + 0.5*al_ad(npx+1)
            q_ad(npx+1, j) = q_ad(npx+1, j) + 0.5*al_ad(npx+1)
            dm1_ad(npx) = dm1_ad(npx) + r3*al_ad(npx+1)
            dm1_ad(npx+1) = dm1_ad(npx+1) - r3*al_ad(npx+1)
            al_ad(npx+1) = 0.0_FVPRC
            CALL POPREALARRAY_ADM(dm1(npx))
            min5_ad = SIGN(1.d0, min5*dm1(npx))*dm1_ad(npx)
            dm1_ad(npx) = 0.0_FVPRC
            CALL POPCONTROL2B(branch)
            IF (branch .LT. 2) THEN
              IF (branch .EQ. 0) THEN
                CALL POPREALARRAY_ADM(min5)
                z5_ad = min5_ad
                y5_ad = 0.0_FVPRC
              ELSE
                CALL POPREALARRAY_ADM(min5)
                y5_ad = min5_ad
                z5_ad = 0.0_FVPRC
              END IF
              x6_ad = 0.0_FVPRC
            ELSE
              IF (branch .EQ. 2) THEN
                CALL POPREALARRAY_ADM(min5)
                z5_ad = min5_ad
                x6_ad = 0.0_FVPRC
              ELSE
                CALL POPREALARRAY_ADM(min5)
                x6_ad = min5_ad
                z5_ad = 0.0_FVPRC
              END IF
              y5_ad = 0.0_FVPRC
            END IF
            q_ad(npx, j) = q_ad(npx, j) + z5_ad
            min24_ad = -z5_ad
            CALL POPCONTROL2B(branch)
            IF (branch .LT. 2) THEN
              IF (branch .EQ. 0) THEN
                x1_ad = min24_ad
                x0_ad = 0.0_FVPRC
              ELSE
                x0_ad = min24_ad
                x1_ad = 0.0_FVPRC
              END IF
            ELSE
              IF (branch .EQ. 2) THEN
                x1_ad = min24_ad
              ELSE
                q_ad(npx, j) = q_ad(npx, j) + min24_ad
                x1_ad = 0.0_FVPRC
              END IF
              x0_ad = 0.0_FVPRC
            END IF
            max5_ad = y5_ad
            q_ad(npx, j) = q_ad(npx, j) - y5_ad
            CALL POPCONTROL2B(branch)
            IF (branch .LT. 2) THEN
              IF (branch .EQ. 0) THEN
                x1_ad = x1_ad + max5_ad
              ELSE
                x0_ad = x0_ad + max5_ad
              END IF
            ELSE IF (branch .EQ. 2) THEN
              x1_ad = x1_ad + max5_ad
            ELSE
              q_ad(npx, j) = q_ad(npx, j) + max5_ad
            END IF
            CALL POPCONTROL1B(branch)
            IF (branch .EQ. 0) THEN
              dm1_ad(npx) = dm1_ad(npx) + x6_ad
            ELSE
              dm1_ad(npx) = dm1_ad(npx) - x6_ad
            END IF
            CALL POPREALARRAY_ADM(dm1(npx))
            x1_ad = x1_ad + 0.5*dm1_ad(npx)
            x0_ad = x0_ad - 0.5*dm1_ad(npx)
            dm1_ad(npx) = 0.0_FVPRC
            q_ad(npx, j) = q_ad(npx, j) + s15*x1_ad
            q_ad(npx+1, j) = q_ad(npx+1, j) + s11*x1_ad
            dm1_ad(npx+1) = dm1_ad(npx+1) - s14*x1_ad
            q_ad(npx-2, j) = q_ad(npx-2, j) + 0.5*al_ad(npx-1)
            q_ad(npx-1, j) = q_ad(npx-1, j) + 0.5*al_ad(npx-1)
            dm1_ad(npx-2) = dm1_ad(npx-2) + r3*al_ad(npx-1)
            dm1_ad(npx-1) = dm1_ad(npx-1) - r3*al_ad(npx-1)
            al_ad(npx-1) = 0.0_FVPRC
            CALL POPREALARRAY_ADM(dm1(npx-1))
            min4_ad = SIGN(1.d0, min4*dm1(npx-1))*dm1_ad(npx-1)
            dm1_ad(npx-1) = 0.0_FVPRC
            CALL POPCONTROL2B(branch)
            IF (branch .LT. 2) THEN
              IF (branch .EQ. 0) THEN
                CALL POPREALARRAY_ADM(min4)
                z4_ad = min4_ad
                y4_ad = 0.0_FVPRC
              ELSE
                CALL POPREALARRAY_ADM(min4)
                y4_ad = min4_ad
                z4_ad = 0.0_FVPRC
              END IF
              x5_ad = 0.0_FVPRC
            ELSE
              IF (branch .EQ. 2) THEN
                CALL POPREALARRAY_ADM(min4)
                z4_ad = min4_ad
                x5_ad = 0.0_FVPRC
              ELSE
                CALL POPREALARRAY_ADM(min4)
                x5_ad = min4_ad
                z4_ad = 0.0_FVPRC
              END IF
              y4_ad = 0.0_FVPRC
            END IF
            q_ad(npx-1, j) = q_ad(npx-1, j) + z4_ad
            min23_ad = -z4_ad
            CALL POPCONTROL2B(branch)
            IF (branch .LT. 2) THEN
              IF (branch .EQ. 0) THEN
                x1_ad = min23_ad
              ELSE
                x0_ad = x0_ad + min23_ad
                x1_ad = 0.0_FVPRC
              END IF
            ELSE IF (branch .EQ. 2) THEN
              x1_ad = min23_ad
            ELSE
              q_ad(npx-1, j) = q_ad(npx-1, j) + min23_ad
              x1_ad = 0.0_FVPRC
            END IF
            max4_ad = y4_ad
            q_ad(npx-1, j) = q_ad(npx-1, j) - y4_ad
            CALL POPCONTROL2B(branch)
            IF (branch .LT. 2) THEN
              IF (branch .EQ. 0) THEN
                x1_ad = x1_ad + max4_ad
              ELSE
                x0_ad = x0_ad + max4_ad
              END IF
            ELSE IF (branch .EQ. 2) THEN
              x1_ad = x1_ad + max4_ad
            ELSE
              q_ad(npx-1, j) = q_ad(npx-1, j) + max4_ad
            END IF
            CALL POPCONTROL1B(branch)
            IF (branch .EQ. 0) THEN
              dm1_ad(npx-1) = dm1_ad(npx-1) + x5_ad
            ELSE
              dm1_ad(npx-1) = dm1_ad(npx-1) - x5_ad
            END IF
            CALL POPREALARRAY_ADM(dm1(npx-1))
            x0_ad = x0_ad + al_ad(npx) + 0.5*dm1_ad(npx-1)
            x1_ad = x1_ad - 0.5*dm1_ad(npx-1)
            dm1_ad(npx-1) = 0.0_FVPRC
            q_ad(npx-1, j) = q_ad(npx-1, j) + s15*x1_ad
            q_ad(npx-2, j) = q_ad(npx-2, j) + s11*x1_ad
            dm1_ad(npx-2) = dm1_ad(npx-2) + s14*x1_ad
            al_ad(npx) = 0.0_FVPRC
            x0l_ad = x0_ad
            x0r_ad = x0_ad
            temp_ad1 = 0.5*x0r_ad/(dxa(npx, j)+dxa(npx+1, j))
            q_ad(npx, j) = q_ad(npx, j) + (dxa(npx, j)*2.+dxa(npx+1, j))&
&             *temp_ad1
            q_ad(npx+1, j) = q_ad(npx+1, j) - dxa(npx, j)*temp_ad1
            temp_ad2 = 0.5*x0l_ad/(dxa(npx-1, j)+dxa(npx-2, j))
            q_ad(npx-1, j) = q_ad(npx-1, j) + (dxa(npx-1, j)*2.+dxa(npx-&
&             2, j))*temp_ad2
            q_ad(npx-2, j) = q_ad(npx-2, j) - dxa(npx-1, j)*temp_ad2
          END IF
          CALL POPCONTROL1B(branch)
          IF (branch .EQ. 0) THEN
            q_ad(1, j) = q_ad(1, j) + 0.5*al_ad(2)
            q_ad(2, j) = q_ad(2, j) + 0.5*al_ad(2)
            dm1_ad(1) = dm1_ad(1) + r3*al_ad(2)
            dm1_ad(2) = dm1_ad(2) - r3*al_ad(2)
            al_ad(2) = 0.0_FVPRC
            CALL POPREALARRAY_ADM(dm1(1))
            min3_ad = SIGN(1.d0, min3*dm1(1))*dm1_ad(1)
            dm1_ad(1) = 0.0_FVPRC
            CALL POPCONTROL2B(branch)
            IF (branch .LT. 2) THEN
              IF (branch .EQ. 0) THEN
                CALL POPREALARRAY_ADM(min3)
                z3_ad = min3_ad
                y3_ad = 0.0_FVPRC
              ELSE
                CALL POPREALARRAY_ADM(min3)
                y3_ad = min3_ad
                z3_ad = 0.0_FVPRC
              END IF
              x4_ad = 0.0_FVPRC
            ELSE
              IF (branch .EQ. 2) THEN
                CALL POPREALARRAY_ADM(min3)
                z3_ad = min3_ad
                x4_ad = 0.0_FVPRC
              ELSE
                CALL POPREALARRAY_ADM(min3)
                x4_ad = min3_ad
                z3_ad = 0.0_FVPRC
              END IF
              y3_ad = 0.0_FVPRC
            END IF
            q_ad(1, j) = q_ad(1, j) + z3_ad
            min22_ad = -z3_ad
            CALL POPCONTROL2B(branch)
            IF (branch .LT. 2) THEN
              IF (branch .EQ. 0) THEN
                x1_ad = min22_ad
                x0_ad = 0.0_FVPRC
              ELSE
                x0_ad = min22_ad
                x1_ad = 0.0_FVPRC
              END IF
            ELSE
              IF (branch .EQ. 2) THEN
                x1_ad = min22_ad
              ELSE
                q_ad(1, j) = q_ad(1, j) + min22_ad
                x1_ad = 0.0_FVPRC
              END IF
              x0_ad = 0.0_FVPRC
            END IF
            max3_ad = y3_ad
            q_ad(1, j) = q_ad(1, j) - y3_ad
            CALL POPCONTROL2B(branch)
            IF (branch .LT. 2) THEN
              IF (branch .EQ. 0) THEN
                x1_ad = x1_ad + max3_ad
              ELSE
                x0_ad = x0_ad + max3_ad
              END IF
            ELSE IF (branch .EQ. 2) THEN
              x1_ad = x1_ad + max3_ad
            ELSE
              q_ad(1, j) = q_ad(1, j) + max3_ad
            END IF
            CALL POPCONTROL1B(branch)
            IF (branch .EQ. 0) THEN
              dm1_ad(1) = dm1_ad(1) + x4_ad
            ELSE
              dm1_ad(1) = dm1_ad(1) - x4_ad
            END IF
            CALL POPREALARRAY_ADM(dm1(1))
            x1_ad = x1_ad + 0.5*dm1_ad(1)
            x0_ad = x0_ad - 0.5*dm1_ad(1)
            dm1_ad(1) = 0.0_FVPRC
            q_ad(1, j) = q_ad(1, j) + s15*x1_ad
            q_ad(2, j) = q_ad(2, j) + s11*x1_ad
            dm1_ad(2) = dm1_ad(2) - s14*x1_ad
            q_ad(-1, j) = q_ad(-1, j) + 0.5*al_ad(0)
            q_ad(0, j) = q_ad(0, j) + 0.5*al_ad(0)
            dm1_ad(-1) = dm1_ad(-1) + r3*al_ad(0)
            dm1_ad(0) = dm1_ad(0) - r3*al_ad(0)
            al_ad(0) = 0.0_FVPRC
            CALL POPREALARRAY_ADM(dm1(0))
            min2_ad = SIGN(1.d0, min2*dm1(0))*dm1_ad(0)
            dm1_ad(0) = 0.0_FVPRC
            CALL POPCONTROL2B(branch)
            IF (branch .LT. 2) THEN
              IF (branch .EQ. 0) THEN
                CALL POPREALARRAY_ADM(min2)
                z2_ad = min2_ad
                y2_ad = 0.0_FVPRC
              ELSE
                CALL POPREALARRAY_ADM(min2)
                y2_ad = min2_ad
                z2_ad = 0.0_FVPRC
              END IF
              x3_ad = 0.0_FVPRC
            ELSE
              IF (branch .EQ. 2) THEN
                CALL POPREALARRAY_ADM(min2)
                z2_ad = min2_ad
                x3_ad = 0.0_FVPRC
              ELSE
                CALL POPREALARRAY_ADM(min2)
                x3_ad = min2_ad
                z2_ad = 0.0_FVPRC
              END IF
              y2_ad = 0.0_FVPRC
            END IF
            q_ad(0, j) = q_ad(0, j) + z2_ad
            min21_ad = -z2_ad
            CALL POPCONTROL2B(branch)
            IF (branch .LT. 2) THEN
              IF (branch .EQ. 0) THEN
                x1_ad = min21_ad
              ELSE
                x0_ad = x0_ad + min21_ad
                x1_ad = 0.0_FVPRC
              END IF
            ELSE IF (branch .EQ. 2) THEN
              x1_ad = min21_ad
            ELSE
              q_ad(0, j) = q_ad(0, j) + min21_ad
              x1_ad = 0.0_FVPRC
            END IF
            max2_ad = y2_ad
            q_ad(0, j) = q_ad(0, j) - y2_ad
            CALL POPCONTROL2B(branch)
            IF (branch .LT. 2) THEN
              IF (branch .EQ. 0) THEN
                x1_ad = x1_ad + max2_ad
              ELSE
                x0_ad = x0_ad + max2_ad
              END IF
            ELSE IF (branch .EQ. 2) THEN
              x1_ad = x1_ad + max2_ad
            ELSE
              q_ad(0, j) = q_ad(0, j) + max2_ad
            END IF
            CALL POPCONTROL1B(branch)
            IF (branch .EQ. 0) THEN
              dm1_ad(0) = dm1_ad(0) + x3_ad
            ELSE
              dm1_ad(0) = dm1_ad(0) - x3_ad
            END IF
            CALL POPREALARRAY_ADM(dm1(0))
            x0_ad = x0_ad + al_ad(1) + 0.5*dm1_ad(0)
            x1_ad = x1_ad - 0.5*dm1_ad(0)
            dm1_ad(0) = 0.0_FVPRC
            q_ad(0, j) = q_ad(0, j) + s15*x1_ad
            q_ad(-1, j) = q_ad(-1, j) + s11*x1_ad
            dm1_ad(-1) = dm1_ad(-1) + s14*x1_ad
            al_ad(1) = 0.0_FVPRC
            x0l_ad = x0_ad
            x0r_ad = x0_ad
            temp_ad = 0.5*x0r_ad/(dxa(1, j)+dxa(2, j))
            q_ad(1, j) = q_ad(1, j) + (dxa(1, j)*2.+dxa(2, j))*temp_ad
            q_ad(2, j) = q_ad(2, j) - dxa(1, j)*temp_ad
            temp_ad0 = 0.5*x0l_ad/(dxa(0, j)+dxa(-1, j))
            q_ad(0, j) = q_ad(0, j) + (dxa(0, j)*2.+dxa(-1, j))*temp_ad0
            q_ad(-1, j) = q_ad(-1, j) - dxa(0, j)*temp_ad0
          END IF
        ELSE IF (branch .NE. 2) THEN
          DO i=ie+2,is-1,-1
            q_ad(i-1, j) = q_ad(i-1, j) + 0.5*al_ad(i)
            q_ad(i, j) = q_ad(i, j) + 0.5*al_ad(i)
            dm1_ad(i-1) = dm1_ad(i-1) + r3*al_ad(i)
            dm1_ad(i) = dm1_ad(i) - r3*al_ad(i)
            al_ad(i) = 0.0_FVPRC
          END DO
          GOTO 100
        END IF
        DO i=ie3+1,is3,-1
          q_ad(i-1, j) = q_ad(i-1, j) + 0.5*al_ad(i)
          q_ad(i, j) = q_ad(i, j) + 0.5*al_ad(i)
          dm1_ad(i-1) = dm1_ad(i-1) + r3*al_ad(i)
          dm1_ad(i) = dm1_ad(i) - r3*al_ad(i)
          al_ad(i) = 0.0_FVPRC
        END DO
 100    DO i=ie+2,is-2,-1
          xt = 0.25*(q(i+1, j)-q(i-1, j))
          CALL POPREALARRAY_ADM(dm1(i))
          min1_ad = SIGN(1.d0, min1*xt)*dm1_ad(i)
          dm1_ad(i) = 0.0_FVPRC
          CALL POPCONTROL2B(branch)
          IF (branch .LT. 2) THEN
            IF (branch .EQ. 0) THEN
              CALL POPREALARRAY_ADM(min1)
              z1_ad = min1_ad
              y1_ad = 0.0_FVPRC
            ELSE
              CALL POPREALARRAY_ADM(min1)
              y1_ad = min1_ad
              z1_ad = 0.0_FVPRC
            END IF
            x2_ad = 0.0_FVPRC
          ELSE
            IF (branch .EQ. 2) THEN
              CALL POPREALARRAY_ADM(min1)
              z1_ad = min1_ad
              x2_ad = 0.0_FVPRC
            ELSE
              CALL POPREALARRAY_ADM(min1)
              x2_ad = min1_ad
              z1_ad = 0.0_FVPRC
            END IF
            y1_ad = 0.0_FVPRC
          END IF
          q_ad(i, j) = q_ad(i, j) + z1_ad
          min20_ad = -z1_ad
          CALL POPCONTROL2B(branch)
          IF (branch .LT. 2) THEN
            IF (branch .EQ. 0) THEN
              q_ad(i+1, j) = q_ad(i+1, j) + min20_ad
            ELSE
              q_ad(i, j) = q_ad(i, j) + min20_ad
            END IF
          ELSE IF (branch .EQ. 2) THEN
            q_ad(i+1, j) = q_ad(i+1, j) + min20_ad
          ELSE
            q_ad(i-1, j) = q_ad(i-1, j) + min20_ad
          END IF
          max1_ad = y1_ad
          q_ad(i, j) = q_ad(i, j) - y1_ad
          CALL POPCONTROL2B(branch)
          IF (branch .LT. 2) THEN
            IF (branch .EQ. 0) THEN
              q_ad(i+1, j) = q_ad(i+1, j) + max1_ad
            ELSE
              q_ad(i, j) = q_ad(i, j) + max1_ad
            END IF
          ELSE IF (branch .EQ. 2) THEN
            q_ad(i+1, j) = q_ad(i+1, j) + max1_ad
          ELSE
            q_ad(i-1, j) = q_ad(i-1, j) + max1_ad
          END IF
          CALL POPCONTROL1B(branch)
          IF (branch .EQ. 0) THEN
            xt_ad = x2_ad
          ELSE
            xt_ad = -x2_ad
          END IF
          q_ad(i+1, j) = q_ad(i+1, j) + 0.25*xt_ad
          q_ad(i-1, j) = q_ad(i-1, j) - 0.25*xt_ad
        END DO
      END DO
    ELSE IF (iord .EQ. 5) THEN
! PPM with Hunyh's 2nd constraint
      DO j=jfirst,jlast
        DO i=ifirst-3,ilast+2
          dq(i) = q(i+1, j) - q(i, j)
        END DO
        DO i=ifirst-2,ilast+2
          xt = 0.25*(q(i+1, j)-q(i-1, j))
          IF (xt .GE. 0.) THEN
            x11 = xt
            CALL PUSHCONTROL1B(0)
          ELSE
            x11 = -xt
            CALL PUSHCONTROL1B(1)
          END IF
          IF (q(i-1, j) .LT. q(i, j)) THEN
            IF (q(i, j) .LT. q(i+1, j)) THEN
              max6 = q(i+1, j)
              CALL PUSHCONTROL2B(0)
            ELSE
              max6 = q(i, j)
              CALL PUSHCONTROL2B(1)
            END IF
          ELSE IF (q(i-1, j) .LT. q(i+1, j)) THEN
            max6 = q(i+1, j)
            CALL PUSHCONTROL2B(2)
          ELSE
            max6 = q(i-1, j)
            CALL PUSHCONTROL2B(3)
          END IF
          y10 = max6 - q(i, j)
          IF (q(i-1, j) .GT. q(i, j)) THEN
            IF (q(i, j) .GT. q(i+1, j)) THEN
              min25 = q(i+1, j)
              CALL PUSHCONTROL2B(0)
            ELSE
              min25 = q(i, j)
              CALL PUSHCONTROL2B(1)
            END IF
          ELSE IF (q(i-1, j) .GT. q(i+1, j)) THEN
            min25 = q(i+1, j)
            CALL PUSHCONTROL2B(2)
          ELSE
            min25 = q(i-1, j)
            CALL PUSHCONTROL2B(3)
          END IF
          z6 = q(i, j) - min25
          IF (x11 .GT. y10) THEN
            IF (y10 .GT. z6) THEN
              CALL PUSHREALARRAY_ADM(min10)
              min10 = z6
              CALL PUSHCONTROL2B(0)
            ELSE
              CALL PUSHREALARRAY_ADM(min10)
              min10 = y10
              CALL PUSHCONTROL2B(1)
            END IF
          ELSE IF (x11 .GT. z6) THEN
            CALL PUSHREALARRAY_ADM(min10)
            min10 = z6
            CALL PUSHCONTROL2B(2)
          ELSE
            CALL PUSHREALARRAY_ADM(min10)
            min10 = x11
            CALL PUSHCONTROL2B(3)
          END IF
          dm1(i) = SIGN(min10, xt)
        END DO
        DO i=ifirst-1,ilast+2
          al(i) = 0.5*(q(i-1, j)+q(i, j)) + r3*(dm1(i-1)-dm1(i))
        END DO
        DO i=ifirst-1,ilast+1
          pmp_1 = -(2.*dq(i))
          lac_1 = pmp_1 + 1.5*dq(i+1)
          IF (0. .LT. pmp_1) THEN
            IF (pmp_1 .LT. lac_1) THEN
              x12 = lac_1
              CALL PUSHCONTROL2B(0)
            ELSE
              x12 = pmp_1
              CALL PUSHCONTROL2B(1)
            END IF
          ELSE IF (0. .LT. lac_1) THEN
            x12 = lac_1
            CALL PUSHCONTROL2B(2)
          ELSE
            CALL PUSHCONTROL2B(3)
            x12 = 0.
          END IF
          IF (0. .GT. pmp_1) THEN
            IF (pmp_1 .GT. lac_1) THEN
              y34 = lac_1
              CALL PUSHCONTROL2B(0)
            ELSE
              y34 = pmp_1
              CALL PUSHCONTROL2B(1)
            END IF
          ELSE IF (0. .GT. lac_1) THEN
            y34 = lac_1
            CALL PUSHCONTROL2B(2)
          ELSE
            y34 = 0.
            CALL PUSHCONTROL2B(3)
          END IF
          IF (al(i) - q(i, j) .LT. y34) THEN
            y11 = y34
            CALL PUSHCONTROL1B(0)
          ELSE
            y11 = al(i) - q(i, j)
            CALL PUSHCONTROL1B(1)
          END IF
          IF (x12 .GT. y11) THEN
            CALL PUSHREALARRAY_ADM(bl(i))
            bl(i) = y11
            CALL PUSHCONTROL1B(0)
          ELSE
            CALL PUSHREALARRAY_ADM(bl(i))
            bl(i) = x12
            CALL PUSHCONTROL1B(1)
          END IF
          pmp_2 = 2.*dq(i-1)
          lac_2 = pmp_2 - 1.5*dq(i-2)
          IF (0. .LT. pmp_2) THEN
            IF (pmp_2 .LT. lac_2) THEN
              x13 = lac_2
              CALL PUSHCONTROL2B(0)
            ELSE
              x13 = pmp_2
              CALL PUSHCONTROL2B(1)
            END IF
          ELSE IF (0. .LT. lac_2) THEN
            x13 = lac_2
            CALL PUSHCONTROL2B(2)
          ELSE
            CALL PUSHCONTROL2B(3)
            x13 = 0.
          END IF
          IF (0. .GT. pmp_2) THEN
            IF (pmp_2 .GT. lac_2) THEN
              y35 = lac_2
              CALL PUSHCONTROL2B(0)
            ELSE
              y35 = pmp_2
              CALL PUSHCONTROL2B(1)
            END IF
          ELSE IF (0. .GT. lac_2) THEN
            y35 = lac_2
            CALL PUSHCONTROL2B(2)
          ELSE
            y35 = 0.
            CALL PUSHCONTROL2B(3)
          END IF
          IF (al(i+1) - q(i, j) .LT. y35) THEN
            y12 = y35
            CALL PUSHCONTROL1B(0)
          ELSE
            y12 = al(i+1) - q(i, j)
            CALL PUSHCONTROL1B(1)
          END IF
          IF (x13 .GT. y12) THEN
            CALL PUSHREALARRAY_ADM(br(i))
            br(i) = y12
            CALL PUSHCONTROL1B(0)
          ELSE
            CALL PUSHREALARRAY_ADM(br(i))
            br(i) = x13
            CALL PUSHCONTROL1B(1)
          END IF
        END DO
        DO i=ifirst,ilast+1
          IF (c(i, j) .GT. 0.) THEN
            CALL PUSHCONTROL1B(1)
          ELSE
            CALL PUSHCONTROL1B(0)
          END IF
        END DO
      END DO
      dq_ad = 0.0_FVPRC
      al_ad = 0.0_FVPRC
      dm1_ad = 0.0_FVPRC
      bl_ad = 0.0_FVPRC
      br_ad = 0.0_FVPRC
      DO j=jlast,jfirst,-1
        DO i=ilast+1,ifirst,-1
          CALL POPCONTROL1B(branch)
          IF (branch .EQ. 0) THEN
            temp_ad13 = (c(i, j)+1.)*flux_ad(i, j)
            temp_ad14 = c(i, j)*temp_ad13
            q_ad(i, j) = q_ad(i, j) + flux_ad(i, j)
            c_ad(i, j) = c_ad(i, j) + (bl(i)+br(i))*temp_ad13 + (bl(i)+c&
&             (i, j)*(bl(i)+br(i)))*flux_ad(i, j)
            bl_ad(i) = bl_ad(i) + temp_ad14 + temp_ad13
            br_ad(i) = br_ad(i) + temp_ad14
            flux_ad(i, j) = 0.0_FVPRC
          ELSE
            temp0 = bl(i-1) + br(i-1)
            temp_ad11 = (1.-c(i, j))*flux_ad(i, j)
            temp_ad12 = -(c(i, j)*temp_ad11)
            q_ad(i-1, j) = q_ad(i-1, j) + flux_ad(i, j)
            c_ad(i, j) = c_ad(i, j) - temp0*temp_ad11 - (br(i-1)-c(i, j)&
&             *temp0)*flux_ad(i, j)
            br_ad(i-1) = br_ad(i-1) + temp_ad12 + temp_ad11
            bl_ad(i-1) = bl_ad(i-1) + temp_ad12
            flux_ad(i, j) = 0.0_FVPRC
          END IF
        END DO
        DO i=ilast+1,ifirst-1,-1
          CALL POPCONTROL1B(branch)
          IF (branch .EQ. 0) THEN
            CALL POPREALARRAY_ADM(br(i))
            y12_ad = br_ad(i)
            br_ad(i) = 0.0_FVPRC
            x13_ad = 0.0_FVPRC
          ELSE
            CALL POPREALARRAY_ADM(br(i))
            x13_ad = br_ad(i)
            br_ad(i) = 0.0_FVPRC
            y12_ad = 0.0_FVPRC
          END IF
          CALL POPCONTROL1B(branch)
          IF (branch .EQ. 0) THEN
            y35_ad = y12_ad
          ELSE
            al_ad(i+1) = al_ad(i+1) + y12_ad
            q_ad(i, j) = q_ad(i, j) - y12_ad
            y35_ad = 0.0_FVPRC
          END IF
          CALL POPCONTROL2B(branch)
          IF (branch .LT. 2) THEN
            IF (branch .EQ. 0) THEN
              lac_2_ad = y35_ad
              pmp_2_ad = 0.0_FVPRC
            ELSE
              pmp_2_ad = y35_ad
              lac_2_ad = 0.0_FVPRC
            END IF
          ELSE
            IF (branch .EQ. 2) THEN
              lac_2_ad = y35_ad
            ELSE
              lac_2_ad = 0.0_FVPRC
            END IF
            pmp_2_ad = 0.0_FVPRC
          END IF
          CALL POPCONTROL2B(branch)
          IF (branch .LT. 2) THEN
            IF (branch .EQ. 0) THEN
              lac_2_ad = lac_2_ad + x13_ad
            ELSE
              pmp_2_ad = pmp_2_ad + x13_ad
            END IF
          ELSE IF (branch .EQ. 2) THEN
            lac_2_ad = lac_2_ad + x13_ad
          END IF
          pmp_2_ad = pmp_2_ad + lac_2_ad
          dq_ad(i-2) = dq_ad(i-2) - 1.5*lac_2_ad
          dq_ad(i-1) = dq_ad(i-1) + 2.*pmp_2_ad
          CALL POPCONTROL1B(branch)
          IF (branch .EQ. 0) THEN
            CALL POPREALARRAY_ADM(bl(i))
            y11_ad = bl_ad(i)
            bl_ad(i) = 0.0_FVPRC
            x12_ad = 0.0_FVPRC
          ELSE
            CALL POPREALARRAY_ADM(bl(i))
            x12_ad = bl_ad(i)
            bl_ad(i) = 0.0_FVPRC
            y11_ad = 0.0_FVPRC
          END IF
          CALL POPCONTROL1B(branch)
          IF (branch .EQ. 0) THEN
            y34_ad = y11_ad
          ELSE
            al_ad(i) = al_ad(i) + y11_ad
            q_ad(i, j) = q_ad(i, j) - y11_ad
            y34_ad = 0.0_FVPRC
          END IF
          CALL POPCONTROL2B(branch)
          IF (branch .LT. 2) THEN
            IF (branch .EQ. 0) THEN
              lac_1_ad = y34_ad
              pmp_1_ad = 0.0_FVPRC
            ELSE
              pmp_1_ad = y34_ad
              lac_1_ad = 0.0_FVPRC
            END IF
          ELSE
            IF (branch .EQ. 2) THEN
              lac_1_ad = y34_ad
            ELSE
              lac_1_ad = 0.0_FVPRC
            END IF
            pmp_1_ad = 0.0_FVPRC
          END IF
          CALL POPCONTROL2B(branch)
          IF (branch .LT. 2) THEN
            IF (branch .EQ. 0) THEN
              lac_1_ad = lac_1_ad + x12_ad
            ELSE
              pmp_1_ad = pmp_1_ad + x12_ad
            END IF
          ELSE IF (branch .EQ. 2) THEN
            lac_1_ad = lac_1_ad + x12_ad
          END IF
          pmp_1_ad = pmp_1_ad + lac_1_ad
          dq_ad(i+1) = dq_ad(i+1) + 1.5*lac_1_ad
          dq_ad(i) = dq_ad(i) - 2.*pmp_1_ad
        END DO
        DO i=ilast+2,ifirst-1,-1
          q_ad(i-1, j) = q_ad(i-1, j) + 0.5*al_ad(i)
          q_ad(i, j) = q_ad(i, j) + 0.5*al_ad(i)
          dm1_ad(i-1) = dm1_ad(i-1) + r3*al_ad(i)
          dm1_ad(i) = dm1_ad(i) - r3*al_ad(i)
          al_ad(i) = 0.0_FVPRC
        END DO
        DO i=ilast+2,ifirst-2,-1
          xt = 0.25*(q(i+1, j)-q(i-1, j))
          min10_ad = SIGN(1.d0, min10*xt)*dm1_ad(i)
          dm1_ad(i) = 0.0_FVPRC
          CALL POPCONTROL2B(branch)
          IF (branch .LT. 2) THEN
            IF (branch .EQ. 0) THEN
              CALL POPREALARRAY_ADM(min10)
              z6_ad = min10_ad
              y10_ad = 0.0_FVPRC
            ELSE
              CALL POPREALARRAY_ADM(min10)
              y10_ad = min10_ad
              z6_ad = 0.0_FVPRC
            END IF
            x11_ad = 0.0_FVPRC
          ELSE
            IF (branch .EQ. 2) THEN
              CALL POPREALARRAY_ADM(min10)
              z6_ad = min10_ad
              x11_ad = 0.0_FVPRC
            ELSE
              CALL POPREALARRAY_ADM(min10)
              x11_ad = min10_ad
              z6_ad = 0.0_FVPRC
            END IF
            y10_ad = 0.0_FVPRC
          END IF
          q_ad(i, j) = q_ad(i, j) + z6_ad
          min25_ad = -z6_ad
          CALL POPCONTROL2B(branch)
          IF (branch .LT. 2) THEN
            IF (branch .EQ. 0) THEN
              q_ad(i+1, j) = q_ad(i+1, j) + min25_ad
            ELSE
              q_ad(i, j) = q_ad(i, j) + min25_ad
            END IF
          ELSE IF (branch .EQ. 2) THEN
            q_ad(i+1, j) = q_ad(i+1, j) + min25_ad
          ELSE
            q_ad(i-1, j) = q_ad(i-1, j) + min25_ad
          END IF
          max6_ad = y10_ad
          q_ad(i, j) = q_ad(i, j) - y10_ad
          CALL POPCONTROL2B(branch)
          IF (branch .LT. 2) THEN
            IF (branch .EQ. 0) THEN
              q_ad(i+1, j) = q_ad(i+1, j) + max6_ad
            ELSE
              q_ad(i, j) = q_ad(i, j) + max6_ad
            END IF
          ELSE IF (branch .EQ. 2) THEN
            q_ad(i+1, j) = q_ad(i+1, j) + max6_ad
          ELSE
            q_ad(i-1, j) = q_ad(i-1, j) + max6_ad
          END IF
          CALL POPCONTROL1B(branch)
          IF (branch .EQ. 0) THEN
            xt_ad = x11_ad
          ELSE
            xt_ad = -x11_ad
          END IF
          q_ad(i+1, j) = q_ad(i+1, j) + 0.25*xt_ad
          q_ad(i-1, j) = q_ad(i-1, j) - 0.25*xt_ad
        END DO
        DO i=ilast+2,ifirst-3,-1
          q_ad(i+1, j) = q_ad(i+1, j) + dq_ad(i)
          q_ad(i, j) = q_ad(i, j) - dq_ad(i)
          dq_ad(i) = 0.0_FVPRC
        END DO
      END DO
    ELSE IF (iord .EQ. 6 .OR. iord .EQ. 7) THEN
!do j=jfirst,jlast
      IF (iord .EQ. 6) THEN
!#ifdef UN_PPM
!        do i=ifirst-1,ilast+2
!           al(i) = p1*(q(i-1,j)+q(i,j)) + p2*(q(i-2,j)+q(i+1,j))
!        enddo
!        do i=is3, ie3
!           bl6(i,j) = al(i)   - q(i,j)
!           br6(i) = al(i+1) - q(i,j)
!        enddo
!#else
        DO j=jfirst,jlast
          DO i=is3,ie3
            bl6(i, j) = b5*q(i-2, j) + b4*q(i-1, j) + b3*q(i, j) + b2*q(&
&             i+1, j) + b1*q(i+2, j)
            br6(i, j) = b1*q(i-2, j) + b2*q(i-1, j) + b3*q(i, j) + b4*q(&
&             i+1, j) + b5*q(i+2, j)
          END DO
        END DO
        CALL PUSHCONTROL1B(1)
      ELSE
!#endif
        DO j=jfirst,jlast
          DO i=is-3,ie+2
            dq(i) = q(i+1, j) - q(i, j)
          END DO
          DO i=is-2,ie+2
            IF (dq(i-1)*dq(i) .GT. 0.) THEN
              CALL PUSHCONTROL1B(1)
              extm(i) = .false.
            ELSE
              CALL PUSHCONTROL1B(0)
              extm(i) = .true.
            END IF
          END DO
          DO i=is3,ie3
!            if ( extm(i) .and. (extm(i-1) .or. extm(i+1)) ) then
            IF (extm(i-1) .AND. extm(i) .AND. extm(i+1)) THEN
! 2-delta-wave filter:
              bl6(i, j) = 0.
              br6(i, j) = 0.
              CALL PUSHCONTROL1B(1)
            ELSE
              bl6(i, j) = b5*q(i-2, j) + b4*q(i-1, j) + b3*q(i, j) + b2*&
&               q(i+1, j) + b1*q(i+2, j)
              br6(i, j) = b1*q(i-2, j) + b2*q(i-1, j) + b3*q(i, j) + b4*&
&               q(i+1, j) + b5*q(i+2, j)
              CALL PUSHCONTROL1B(0)
            END IF
          END DO
        END DO
        CALL PUSHCONTROL1B(0)
      END IF
!--------------
! fix the edges
!--------------
      DO j=jfirst,jlast
        IF (.NOT.nested) THEN
          IF (is .EQ. 1) THEN
            x0l = 0.5*((2.*dxa(0, j)+dxa(-1, j))*q(0, j)-dxa(0, j)*q(-1&
&             , j))/(dxa(0, j)+dxa(-1, j))
            x0r = 0.5*((2.*dxa(1, j)+dxa(2, j))*q(1, j)-dxa(1, j)*q(2, j&
&             ))/(dxa(1, j)+dxa(2, j))
            br6(2, j) = p1*(q(2, j)+q(3, j)) + p2*(q(1, j)+q(4, j)) - q(&
&             2, j)
            xt = x0l + x0r
            bl6(1, j) = xt - q(1, j)
            br6(0, j) = xt - q(0, j)
            xt = c1*q(-2, j) + c2*q(-1, j) + c3*q(0, j)
!#ifdef DO_MONO_EDGE
!             xt = max( xt, min(q(-1,j),q(0,j)) )
!             xt = min( xt, max(q(-1,j),q(0,j)) )
!#endif
            bl6(0, j) = xt - q(0, j)
            xt = c3*q(1, j) + c2*q(2, j) + c1*q(3, j)
!#ifdef DO_MONO_EDGE
!             xt = max( xt, min(q(1,j),q(2,j)) )
!             xt = min( xt, max(q(1,j),q(2,j)) )
!#endif
            br6(1, j) = xt - q(1, j)
            bl6(2, j) = xt - q(2, j)
            CALL PUSHCONTROL1B(0)
          ELSE
            CALL PUSHCONTROL1B(1)
          END IF
          IF (ie + 1 .EQ. npx) THEN
            x0l = 0.5*((2.*dxa(npx-1, j)+dxa(npx-2, j))*q(npx-1, j)-dxa(&
&             npx-1, j)*q(npx-2, j))/(dxa(npx-1, j)+dxa(npx-2, j))
            x0r = 0.5*((2.*dxa(npx, j)+dxa(npx+1, j))*q(npx, j)-dxa(npx&
&             , j)*q(npx+1, j))/(dxa(npx, j)+dxa(npx+1, j))
            bl6(npx-2, j) = p1*(q(npx-2, j)+q(npx-3, j)) + p2*(q(npx-4, &
&             j)+q(npx-1, j)) - q(npx-2, j)
!             xt = x0L*gridstruct%sin_sg(npx-1,j,3) + x0R*gridstruct%sin_sg(npx,j,1)
!             xt = 2.*xt / (gridstruct%sin_sg(npx,j,1) + gridstruct%sin_sg(npx-1,j,3))
            xt = x0l + x0r
            br6(npx-1, j) = xt - q(npx-1, j)
            bl6(npx, j) = xt - q(npx, j)
            xt = c3*q(npx, j) + c2*q(npx+1, j) + c1*q(npx+2, j)
!#ifdef DO_MONO_EDGE
!             xt = max( xt, min(q(npx,j),q(npx+1,j)) )
!             xt = min( xt, max(q(npx,j),q(npx+1,j)) )
!#endif
            br6(npx, j) = xt - q(npx, j)
            xt = c1*q(npx-3, j) + c2*q(npx-2, j) + c3*q(npx-1, j)
!#ifdef DO_MONO_EDGE
!             xt = max( xt, min(q(npx-2,j),q(npx-1,j)) )
!             xt = min( xt, max(q(npx-2,j),q(npx-1,j)) )
!#endif
            br6(npx-2, j) = xt - q(npx-2, j)
            bl6(npx-1, j) = xt - q(npx-1, j)
            CALL PUSHCONTROL2B(0)
          ELSE
            CALL PUSHCONTROL2B(1)
          END IF
        ELSE
          CALL PUSHCONTROL2B(2)
        END IF
! Positive definite constraint:
        IF (iord .EQ. 7) THEN
          arg1 = ilast - ifirst + 3
          CALL PUSHREALARRAY_ADM(br6(ifirst-1, j), 8*(ilast-ifirst+3)/8&
&                      )
          CALL PUSHREALARRAY_ADM(bl6(ifirst-1, j), 8*(ilast-ifirst+3)/8&
&                      )
          CALL PERT_PPM(arg1, q(ifirst-1, j), bl6(ifirst-1, j), br6(&
&                 ifirst-1, j), 0)
          CALL PUSHCONTROL1B(1)
        ELSE
          CALL PUSHCONTROL1B(0)
        END IF
      END DO
      DO j=jfirst,jlast
        DO i=ifirst,ilast+1
          IF (c(i, j) .GT. 0.) THEN
            CALL PUSHCONTROL1B(1)
          ELSE
            CALL PUSHCONTROL1B(0)
          END IF
        END DO
      END DO
      br6_ad = 0.0_FVPRC
      bl6_ad = 0.0_FVPRC
      DO j=jlast,jfirst,-1
        DO i=ilast+1,ifirst,-1
          CALL POPCONTROL1B(branch)
          IF (branch .EQ. 0) THEN
            temp2 = bl6(i, j) + br6(i, j)
            temp_ad21 = (c(i, j)+1.)*flux_ad(i, j)
            temp_ad22 = c(i, j)*temp_ad21
            q_ad(i, j) = q_ad(i, j) + flux_ad(i, j)
            c_ad(i, j) = c_ad(i, j) + temp2*temp_ad21 + (bl6(i, j)+c(i, &
&             j)*temp2)*flux_ad(i, j)
            bl6_ad(i, j) = bl6_ad(i, j) + temp_ad22 + temp_ad21
            br6_ad(i, j) = br6_ad(i, j) + temp_ad22
            flux_ad(i, j) = 0.0_FVPRC
          ELSE
            temp1 = bl6(i-1, j) + br6(i-1, j)
            temp_ad19 = (1.-c(i, j))*flux_ad(i, j)
            temp_ad20 = -(c(i, j)*temp_ad19)
            q_ad(i-1, j) = q_ad(i-1, j) + flux_ad(i, j)
            c_ad(i, j) = c_ad(i, j) - temp1*temp_ad19 - (br6(i-1, j)-c(i&
&             , j)*temp1)*flux_ad(i, j)
            br6_ad(i-1, j) = br6_ad(i-1, j) + temp_ad20 + temp_ad19
            bl6_ad(i-1, j) = bl6_ad(i-1, j) + temp_ad20
            flux_ad(i, j) = 0.0_FVPRC
          END IF
        END DO
      END DO
      DO 110 j=jlast,jfirst,-1
        CALL POPCONTROL1B(branch)
        IF (branch .NE. 0) THEN
          arg1 = ilast - ifirst + 3
          CALL POPREALARRAY_ADM(bl6(ifirst-1, j), 8*(ilast-ifirst+3)/8)
          CALL POPREALARRAY_ADM(br6(ifirst-1, j), 8*(ilast-ifirst+3)/8)
          CALL PERT_PPM_ADM(arg1, q(ifirst-1, j), bl6(ifirst-1:, j), &
&                     bl6_ad(ifirst-1:, j), br6(ifirst-1:, j), br6_ad(&
&                     ifirst-1:, j), 0)
        END IF
        CALL POPCONTROL2B(branch)
        IF (branch .EQ. 0) THEN
          xt_ad = br6_ad(npx-2, j) + bl6_ad(npx-1, j)
          q_ad(npx-1, j) = q_ad(npx-1, j) - bl6_ad(npx-1, j)
          bl6_ad(npx-1, j) = 0.0_FVPRC
          q_ad(npx-2, j) = q_ad(npx-2, j) - br6_ad(npx-2, j)
          br6_ad(npx-2, j) = 0.0_FVPRC
          q_ad(npx-3, j) = q_ad(npx-3, j) + c1*xt_ad
          q_ad(npx-2, j) = q_ad(npx-2, j) + c2*xt_ad
          q_ad(npx-1, j) = q_ad(npx-1, j) + c3*xt_ad
          xt_ad = br6_ad(npx, j)
          q_ad(npx, j) = q_ad(npx, j) + c3*xt_ad - br6_ad(npx, j)
          br6_ad(npx, j) = 0.0_FVPRC
          q_ad(npx+1, j) = q_ad(npx+1, j) + c2*xt_ad
          q_ad(npx+2, j) = q_ad(npx+2, j) + c1*xt_ad
          xt_ad = br6_ad(npx-1, j) + bl6_ad(npx, j)
          q_ad(npx, j) = q_ad(npx, j) - bl6_ad(npx, j)
          bl6_ad(npx, j) = 0.0_FVPRC
          q_ad(npx-1, j) = q_ad(npx-1, j) - br6_ad(npx-1, j)
          br6_ad(npx-1, j) = 0.0_FVPRC
          x0l_ad = xt_ad
          x0r_ad = xt_ad
          q_ad(npx-2, j) = q_ad(npx-2, j) + (p1-1.0)*bl6_ad(npx-2, j)
          q_ad(npx-3, j) = q_ad(npx-3, j) + p1*bl6_ad(npx-2, j)
          q_ad(npx-4, j) = q_ad(npx-4, j) + p2*bl6_ad(npx-2, j)
          q_ad(npx-1, j) = q_ad(npx-1, j) + p2*bl6_ad(npx-2, j)
          bl6_ad(npx-2, j) = 0.0_FVPRC
          temp_ad17 = 0.5*x0r_ad/(dxa(npx, j)+dxa(npx+1, j))
          q_ad(npx, j) = q_ad(npx, j) + (dxa(npx, j)*2.+dxa(npx+1, j))*&
&           temp_ad17
          q_ad(npx+1, j) = q_ad(npx+1, j) - dxa(npx, j)*temp_ad17
          temp_ad18 = 0.5*x0l_ad/(dxa(npx-1, j)+dxa(npx-2, j))
          q_ad(npx-1, j) = q_ad(npx-1, j) + (dxa(npx-1, j)*2.+dxa(npx-2&
&           , j))*temp_ad18
          q_ad(npx-2, j) = q_ad(npx-2, j) - dxa(npx-1, j)*temp_ad18
        ELSE IF (branch .NE. 1) THEN
          GOTO 110
        END IF
        CALL POPCONTROL1B(branch)
        IF (branch .EQ. 0) THEN
          xt_ad = br6_ad(1, j) + bl6_ad(2, j)
          q_ad(2, j) = q_ad(2, j) - bl6_ad(2, j)
          bl6_ad(2, j) = 0.0_FVPRC
          q_ad(1, j) = q_ad(1, j) + c3*xt_ad - br6_ad(1, j)
          br6_ad(1, j) = 0.0_FVPRC
          q_ad(2, j) = q_ad(2, j) + c2*xt_ad
          q_ad(3, j) = q_ad(3, j) + c1*xt_ad
          xt_ad = bl6_ad(0, j)
          q_ad(0, j) = q_ad(0, j) - bl6_ad(0, j)
          bl6_ad(0, j) = 0.0_FVPRC
          q_ad(-2, j) = q_ad(-2, j) + c1*xt_ad
          q_ad(-1, j) = q_ad(-1, j) + c2*xt_ad
          q_ad(0, j) = q_ad(0, j) + c3*xt_ad - br6_ad(0, j)
          xt_ad = bl6_ad(1, j) + br6_ad(0, j)
          br6_ad(0, j) = 0.0_FVPRC
          q_ad(1, j) = q_ad(1, j) - bl6_ad(1, j)
          bl6_ad(1, j) = 0.0_FVPRC
          x0l_ad = xt_ad
          x0r_ad = xt_ad
          q_ad(2, j) = q_ad(2, j) + (p1-1.0)*br6_ad(2, j)
          q_ad(3, j) = q_ad(3, j) + p1*br6_ad(2, j)
          q_ad(1, j) = q_ad(1, j) + p2*br6_ad(2, j)
          q_ad(4, j) = q_ad(4, j) + p2*br6_ad(2, j)
          br6_ad(2, j) = 0.0_FVPRC
          temp_ad15 = 0.5*x0r_ad/(dxa(1, j)+dxa(2, j))
          q_ad(1, j) = q_ad(1, j) + (dxa(1, j)*2.+dxa(2, j))*temp_ad15
          q_ad(2, j) = q_ad(2, j) - dxa(1, j)*temp_ad15
          temp_ad16 = 0.5*x0l_ad/(dxa(0, j)+dxa(-1, j))
          q_ad(0, j) = q_ad(0, j) + (dxa(0, j)*2.+dxa(-1, j))*temp_ad16
          q_ad(-1, j) = q_ad(-1, j) - dxa(0, j)*temp_ad16
        END IF
 110  CONTINUE
      CALL POPCONTROL1B(branch)
      IF (branch .EQ. 0) THEN
        DO j=jlast,jfirst,-1
          DO i=ie3,is3,-1
            CALL POPCONTROL1B(branch)
            IF (branch .EQ. 0) THEN
              q_ad(i-2, j) = q_ad(i-2, j) + b1*br6_ad(i, j)
              q_ad(i-1, j) = q_ad(i-1, j) + b2*br6_ad(i, j)
              q_ad(i, j) = q_ad(i, j) + b3*br6_ad(i, j)
              q_ad(i+1, j) = q_ad(i+1, j) + b4*br6_ad(i, j)
              q_ad(i+2, j) = q_ad(i+2, j) + b5*br6_ad(i, j)
              br6_ad(i, j) = 0.0_FVPRC
              q_ad(i-2, j) = q_ad(i-2, j) + b5*bl6_ad(i, j)
              q_ad(i-1, j) = q_ad(i-1, j) + b4*bl6_ad(i, j)
              q_ad(i, j) = q_ad(i, j) + b3*bl6_ad(i, j)
              q_ad(i+1, j) = q_ad(i+1, j) + b2*bl6_ad(i, j)
              q_ad(i+2, j) = q_ad(i+2, j) + b1*bl6_ad(i, j)
              bl6_ad(i, j) = 0.0_FVPRC
            ELSE
              br6_ad(i, j) = 0.0_FVPRC
              bl6_ad(i, j) = 0.0_FVPRC
            END IF
          END DO
          DO i=ie+2,is-2,-1
            CALL POPCONTROL1B(branch)
          END DO
        END DO
      ELSE
        DO j=jlast,jfirst,-1
          DO i=ie3,is3,-1
            q_ad(i-2, j) = q_ad(i-2, j) + b1*br6_ad(i, j)
            q_ad(i-1, j) = q_ad(i-1, j) + b2*br6_ad(i, j)
            q_ad(i, j) = q_ad(i, j) + b3*br6_ad(i, j)
            q_ad(i+1, j) = q_ad(i+1, j) + b4*br6_ad(i, j)
            q_ad(i+2, j) = q_ad(i+2, j) + b5*br6_ad(i, j)
            br6_ad(i, j) = 0.0_FVPRC
            q_ad(i-2, j) = q_ad(i-2, j) + b5*bl6_ad(i, j)
            q_ad(i-1, j) = q_ad(i-1, j) + b4*bl6_ad(i, j)
            q_ad(i, j) = q_ad(i, j) + b3*bl6_ad(i, j)
            q_ad(i+1, j) = q_ad(i+1, j) + b2*bl6_ad(i, j)
            q_ad(i+2, j) = q_ad(i+2, j) + b1*bl6_ad(i, j)
            bl6_ad(i, j) = 0.0_FVPRC
          END DO
        END DO
      END IF
    ELSE IF (iord .LE. 10) THEN
! iord=8, 9, 10
      DO j=jfirst,jlast
! grid_type check
        IF (grid_type .LT. 3) THEN
          DO i=is-3,ie+2
            dq(i) = q(i+1, j) - q(i, j)
          END DO
          DO i=is-2,ie+2
            CALL PUSHREALARRAY_ADM(xt)
            xt = 0.25*(q(i+1, j)-q(i-1, j))
            IF (xt .GE. 0.) THEN
              x14 = xt
              CALL PUSHCONTROL1B(0)
            ELSE
              x14 = -xt
              CALL PUSHCONTROL1B(1)
            END IF
            IF (q(i-1, j) .LT. q(i, j)) THEN
              IF (q(i, j) .LT. q(i+1, j)) THEN
                max7 = q(i+1, j)
                CALL PUSHCONTROL2B(0)
              ELSE
                max7 = q(i, j)
                CALL PUSHCONTROL2B(1)
              END IF
            ELSE IF (q(i-1, j) .LT. q(i+1, j)) THEN
              max7 = q(i+1, j)
              CALL PUSHCONTROL2B(2)
            ELSE
              max7 = q(i-1, j)
              CALL PUSHCONTROL2B(3)
            END IF
            y13 = max7 - q(i, j)
            IF (q(i-1, j) .GT. q(i, j)) THEN
              IF (q(i, j) .GT. q(i+1, j)) THEN
                min26 = q(i+1, j)
                CALL PUSHCONTROL2B(0)
              ELSE
                min26 = q(i, j)
                CALL PUSHCONTROL2B(1)
              END IF
            ELSE IF (q(i-1, j) .GT. q(i+1, j)) THEN
              min26 = q(i+1, j)
              CALL PUSHCONTROL2B(2)
            ELSE
              min26 = q(i-1, j)
              CALL PUSHCONTROL2B(3)
            END IF
            z7 = q(i, j) - min26
            IF (x14 .GT. y13) THEN
              IF (y13 .GT. z7) THEN
                CALL PUSHREALARRAY_ADM(min11)
                min11 = z7
                CALL PUSHCONTROL2B(0)
              ELSE
                CALL PUSHREALARRAY_ADM(min11)
                min11 = y13
                CALL PUSHCONTROL2B(1)
              END IF
            ELSE IF (x14 .GT. z7) THEN
              CALL PUSHREALARRAY_ADM(min11)
              min11 = z7
              CALL PUSHCONTROL2B(2)
            ELSE
              CALL PUSHREALARRAY_ADM(min11)
              min11 = x14
              CALL PUSHCONTROL2B(3)
            END IF
            dm1(i) = SIGN(min11, xt)
          END DO
!        do i=is3,min(npx-2,ie+2)
          DO i=is3,ie3+1
            al(i) = 0.5*(q(i-1, j)+q(i, j)) + r3*(dm1(i-1)-dm1(i))
          END DO
          IF (iord .EQ. 8) THEN
            DO i=is3,ie3
              CALL PUSHREALARRAY_ADM(xt)
              xt = 2.*dm1(i)
              IF (xt .GE. 0.) THEN
                x15 = xt
                CALL PUSHCONTROL1B(0)
              ELSE
                x15 = -xt
                CALL PUSHCONTROL1B(1)
              END IF
              IF (al(i) - q(i, j) .GE. 0.) THEN
                y14 = al(i) - q(i, j)
                CALL PUSHCONTROL1B(0)
              ELSE
                y14 = -(al(i)-q(i, j))
                CALL PUSHCONTROL1B(1)
              END IF
              IF (x15 .GT. y14) THEN
                CALL PUSHREALARRAY_ADM(min12)
                min12 = y14
                CALL PUSHCONTROL1B(0)
              ELSE
                CALL PUSHREALARRAY_ADM(min12)
                min12 = x15
                CALL PUSHCONTROL1B(1)
              END IF
              CALL PUSHREALARRAY_ADM(bl(i))
              bl(i) = -SIGN(min12, xt)
              IF (xt .GE. 0.) THEN
                x16 = xt
                CALL PUSHCONTROL1B(0)
              ELSE
                x16 = -xt
                CALL PUSHCONTROL1B(1)
              END IF
              IF (al(i+1) - q(i, j) .GE. 0.) THEN
                y15 = al(i+1) - q(i, j)
                CALL PUSHCONTROL1B(0)
              ELSE
                y15 = -(al(i+1)-q(i, j))
                CALL PUSHCONTROL1B(1)
              END IF
              IF (x16 .GT. y15) THEN
                CALL PUSHREALARRAY_ADM(min13)
                min13 = y15
                CALL PUSHCONTROL1B(0)
              ELSE
                CALL PUSHREALARRAY_ADM(min13)
                min13 = x16
                CALL PUSHCONTROL1B(1)
              END IF
              CALL PUSHREALARRAY_ADM(br(i))
              br(i) = SIGN(min13, xt)
            END DO
            CALL PUSHCONTROL2B(0)
          ELSE IF (iord .EQ. 9) THEN
            DO i=is3,ie3
              pmp_1 = -(2.*dq(i))
              lac_1 = pmp_1 + 1.5*dq(i+1)
              IF (0. .LT. pmp_1) THEN
                IF (pmp_1 .LT. lac_1) THEN
                  x17 = lac_1
                  CALL PUSHCONTROL2B(0)
                ELSE
                  x17 = pmp_1
                  CALL PUSHCONTROL2B(1)
                END IF
              ELSE IF (0. .LT. lac_1) THEN
                x17 = lac_1
                CALL PUSHCONTROL2B(2)
              ELSE
                CALL PUSHCONTROL2B(3)
                x17 = 0.
              END IF
              IF (0. .GT. pmp_1) THEN
                IF (pmp_1 .GT. lac_1) THEN
                  y36 = lac_1
                  CALL PUSHCONTROL2B(0)
                ELSE
                  y36 = pmp_1
                  CALL PUSHCONTROL2B(1)
                END IF
              ELSE IF (0. .GT. lac_1) THEN
                y36 = lac_1
                CALL PUSHCONTROL2B(2)
              ELSE
                y36 = 0.
                CALL PUSHCONTROL2B(3)
              END IF
              IF (al(i) - q(i, j) .LT. y36) THEN
                y16 = y36
                CALL PUSHCONTROL1B(0)
              ELSE
                y16 = al(i) - q(i, j)
                CALL PUSHCONTROL1B(1)
              END IF
              IF (x17 .GT. y16) THEN
                CALL PUSHREALARRAY_ADM(bl(i))
                bl(i) = y16
                CALL PUSHCONTROL1B(0)
              ELSE
                CALL PUSHREALARRAY_ADM(bl(i))
                bl(i) = x17
                CALL PUSHCONTROL1B(1)
              END IF
              pmp_2 = 2.*dq(i-1)
              lac_2 = pmp_2 - 1.5*dq(i-2)
              IF (0. .LT. pmp_2) THEN
                IF (pmp_2 .LT. lac_2) THEN
                  x18 = lac_2
                  CALL PUSHCONTROL2B(0)
                ELSE
                  x18 = pmp_2
                  CALL PUSHCONTROL2B(1)
                END IF
              ELSE IF (0. .LT. lac_2) THEN
                x18 = lac_2
                CALL PUSHCONTROL2B(2)
              ELSE
                CALL PUSHCONTROL2B(3)
                x18 = 0.
              END IF
              IF (0. .GT. pmp_2) THEN
                IF (pmp_2 .GT. lac_2) THEN
                  y37 = lac_2
                  CALL PUSHCONTROL2B(0)
                ELSE
                  y37 = pmp_2
                  CALL PUSHCONTROL2B(1)
                END IF
              ELSE IF (0. .GT. lac_2) THEN
                y37 = lac_2
                CALL PUSHCONTROL2B(2)
              ELSE
                y37 = 0.
                CALL PUSHCONTROL2B(3)
              END IF
              IF (al(i+1) - q(i, j) .LT. y37) THEN
                y17 = y37
                CALL PUSHCONTROL1B(0)
              ELSE
                y17 = al(i+1) - q(i, j)
                CALL PUSHCONTROL1B(1)
              END IF
              IF (x18 .GT. y17) THEN
                CALL PUSHREALARRAY_ADM(br(i))
                br(i) = y17
                CALL PUSHCONTROL1B(0)
              ELSE
                CALL PUSHREALARRAY_ADM(br(i))
                br(i) = x18
                CALL PUSHCONTROL1B(1)
              END IF
            END DO
            CALL PUSHCONTROL2B(1)
          ELSE
! iord=10
            DO i=is3,ie3
              CALL PUSHREALARRAY_ADM(bl(i))
              bl(i) = al(i) - q(i, j)
              CALL PUSHREALARRAY_ADM(br(i))
              br(i) = al(i+1) - q(i, j)
              IF (dm1(i-1) .GE. 0.) THEN
                abs0 = dm1(i-1)
              ELSE
                abs0 = -dm1(i-1)
              END IF
              IF (dm1(i) .GE. 0.) THEN
                abs4 = dm1(i)
              ELSE
                abs4 = -dm1(i)
              END IF
              IF (dm1(i+1) .GE. 0.) THEN
                abs8 = dm1(i+1)
              ELSE
                abs8 = -dm1(i+1)
              END IF
              IF (abs0 + abs4 + abs8 .LT. near_zero) THEN
                bl(i) = 0.
                br(i) = 0.
                CALL PUSHCONTROL2B(3)
              ELSE
                IF (3.*(bl(i)+br(i)) .GE. 0.) THEN
                  abs1 = 3.*(bl(i)+br(i))
                ELSE
                  abs1 = -(3.*(bl(i)+br(i)))
                END IF
                IF (bl(i) - br(i) .GE. 0.) THEN
                  abs5 = bl(i) - br(i)
                ELSE
                  abs5 = -(bl(i)-br(i))
                END IF
                IF (abs1 .GT. abs5) THEN
                  pmp_1 = -(dq(i)+dq(i))
                  lac_1 = pmp_1 + 1.5*dq(i+1)
                  IF (0. .LT. pmp_1) THEN
                    IF (pmp_1 .LT. lac_1) THEN
                      x19 = lac_1
                      CALL PUSHCONTROL2B(0)
                    ELSE
                      x19 = pmp_1
                      CALL PUSHCONTROL2B(1)
                    END IF
                  ELSE IF (0. .LT. lac_1) THEN
                    x19 = lac_1
                    CALL PUSHCONTROL2B(2)
                  ELSE
                    CALL PUSHCONTROL2B(3)
                    x19 = 0.
                  END IF
                  IF (0. .GT. pmp_1) THEN
                    IF (pmp_1 .GT. lac_1) THEN
                      y38 = lac_1
                      CALL PUSHCONTROL2B(0)
                    ELSE
                      y38 = pmp_1
                      CALL PUSHCONTROL2B(1)
                    END IF
                  ELSE IF (0. .GT. lac_1) THEN
                    y38 = lac_1
                    CALL PUSHCONTROL2B(2)
                  ELSE
                    y38 = 0.
                    CALL PUSHCONTROL2B(3)
                  END IF
                  IF (bl(i) .LT. y38) THEN
                    y18 = y38
                    CALL PUSHCONTROL1B(0)
                  ELSE
                    y18 = bl(i)
                    CALL PUSHCONTROL1B(1)
                  END IF
                  IF (x19 .GT. y18) THEN
                    bl(i) = y18
                    CALL PUSHCONTROL1B(0)
                  ELSE
                    bl(i) = x19
                    CALL PUSHCONTROL1B(1)
                  END IF
                  pmp_2 = dq(i-1) + dq(i-1)
                  lac_2 = pmp_2 - 1.5*dq(i-2)
                  IF (0. .LT. pmp_2) THEN
                    IF (pmp_2 .LT. lac_2) THEN
                      x20 = lac_2
                      CALL PUSHCONTROL2B(0)
                    ELSE
                      x20 = pmp_2
                      CALL PUSHCONTROL2B(1)
                    END IF
                  ELSE IF (0. .LT. lac_2) THEN
                    x20 = lac_2
                    CALL PUSHCONTROL2B(2)
                  ELSE
                    CALL PUSHCONTROL2B(3)
                    x20 = 0.
                  END IF
                  IF (0. .GT. pmp_2) THEN
                    IF (pmp_2 .GT. lac_2) THEN
                      y39 = lac_2
                      CALL PUSHCONTROL2B(0)
                    ELSE
                      y39 = pmp_2
                      CALL PUSHCONTROL2B(1)
                    END IF
                  ELSE IF (0. .GT. lac_2) THEN
                    y39 = lac_2
                    CALL PUSHCONTROL2B(2)
                  ELSE
                    y39 = 0.
                    CALL PUSHCONTROL2B(3)
                  END IF
                  IF (br(i) .LT. y39) THEN
                    y19 = y39
                    CALL PUSHCONTROL1B(0)
                  ELSE
                    y19 = br(i)
                    CALL PUSHCONTROL1B(1)
                  END IF
                  IF (x20 .GT. y19) THEN
                    br(i) = y19
                    CALL PUSHCONTROL2B(1)
                  ELSE
                    br(i) = x20
                    CALL PUSHCONTROL2B(2)
                  END IF
                ELSE
                  CALL PUSHCONTROL2B(0)
                END IF
              END IF
            END DO
            CALL PUSHCONTROL2B(2)
          END IF
!--------------
! fix the edges
!--------------
          IF (.NOT.nested) THEN
            IF (is .EQ. 1) THEN
              x0l = 0.5*((2.*dxa(0, j)+dxa(-1, j))*q(0, j)-dxa(0, j)*q(-&
&               1, j))/(dxa(0, j)+dxa(-1, j))
              x0r = 0.5*((2.*dxa(1, j)+dxa(2, j))*q(1, j)-dxa(1, j)*q(2&
&               , j))/(dxa(1, j)+dxa(2, j))
              CALL PUSHREALARRAY_ADM(br(2))
              br(2) = al(3) - q(2, j)
              CALL PUSHREALARRAY_ADM(xt)
              xt = x0l + x0r
!lmh              xt = 0.5*((2.*dxa(1,j)+dxa(2,j))*(q(0,j)+q(1,j))   &
!lmh                 - dxa(1,j)*(q(-1,j)+q(2,j)))/ ( dxa(1,j)+dxa(2,j))
              CALL PUSHREALARRAY_ADM(bl(1))
              bl(1) = xt - q(1, j)
              CALL PUSHREALARRAY_ADM(br(0))
              br(0) = xt - q(0, j)
              xt = s14*dm1(-1) - s11*dq(-1) + q(0, j)
!             xt = max( xt, min(q(-1,j),q(0,j)) )
!             xt = min( xt, max(q(-1,j),q(0,j)) )
              CALL PUSHREALARRAY_ADM(bl(0))
              bl(0) = xt - q(0, j)
              xt = s15*q(1, j) + s11*q(2, j) - s14*dm1(2)
!             xt = max( xt, min(q(1,j),q(2,j)) )
!             xt = min( xt, max(q(1,j),q(2,j)) )
              CALL PUSHREALARRAY_ADM(br(1))
              br(1) = xt - q(1, j)
              CALL PUSHREALARRAY_ADM(bl(2))
              bl(2) = xt - q(2, j)
              CALL PUSHREALARRAY_ADM(br(0), 8*(ilast+2)/8)
              CALL PUSHREALARRAY_ADM(bl(0), 8*(ilast+2)/8)
              CALL PERT_PPM(3, q(0, j), bl(0), br(0), 1)
              CALL PUSHCONTROL1B(0)
            ELSE
              CALL PUSHCONTROL1B(1)
            END IF
            IF (ie + 1 .EQ. npx) THEN
              CALL PUSHREALARRAY_ADM(bl(npx-2))
              bl(npx-2) = al(npx-2) - q(npx-2, j)
              x0l = 0.5*((2.*dxa(npx-1, j)+dxa(npx-2, j))*q(npx-1, j)-&
&               dxa(npx-1, j)*q(npx-2, j))/(dxa(npx-1, j)+dxa(npx-2, j))
              x0r = 0.5*((2.*dxa(npx, j)+dxa(npx+1, j))*q(npx, j)-dxa(&
&               npx, j)*q(npx+1, j))/(dxa(npx, j)+dxa(npx+1, j))
              CALL PUSHREALARRAY_ADM(xt)
              xt = x0l + x0r
!lmh              xt = 0.5*( (2.*dxa(npx-1,j)+dxa(npx-2,j))*(q(npx-1,j)+q(npx,j))   &
!lmh                 - dxa(npx-1,j)*(q(npx-2,j)+q(npx+1,j)))/( dxa(npx-1,j)+dxa(npx-2,j))
              CALL PUSHREALARRAY_ADM(br(npx-1))
              br(npx-1) = xt - q(npx-1, j)
              CALL PUSHREALARRAY_ADM(bl(npx))
              bl(npx) = xt - q(npx, j)
              xt = s11*dq(npx) - s14*dm1(npx+1) + q(npx, j)
!             xt = min( xt, max(q(npx,j), q(npx+1,j)) )
!             xt = max( xt, min(q(npx,j), q(npx+1,j)) )
              CALL PUSHREALARRAY_ADM(br(npx))
              br(npx) = xt - q(npx, j)
              xt = s15*q(npx-1, j) + s11*q(npx-2, j) + s14*dm1(npx-2)
!             xt = min( xt, max(q(npx-2,j), q(npx-1,j)) )
!             xt = max( xt, min(q(npx-2,j), q(npx-1,j)) )
              CALL PUSHREALARRAY_ADM(br(npx-2))
              br(npx-2) = xt - q(npx-2, j)
              CALL PUSHREALARRAY_ADM(bl(npx-1))
              bl(npx-1) = xt - q(npx-1, j)
              CALL PUSHREALARRAY_ADM(br(npx-2), 8*(ilast-npx+4)/8)
              CALL PUSHREALARRAY_ADM(bl(npx-2), 8*(ilast-npx+4)/8)
              CALL PERT_PPM(3, q(npx-2, j), bl(npx-2), br(npx-2), 1)
              CALL PUSHCONTROL2B(3)
            ELSE
              CALL PUSHCONTROL2B(2)
            END IF
          ELSE
            CALL PUSHCONTROL2B(1)
          END IF
        ELSE
!---------------
! grid_type == 4
!---------------
          DO i=ifirst-2,ilast+2
            CALL PUSHREALARRAY_ADM(xt)
            xt = 0.25*(q(i+1, j)-q(i-1, j))
            IF (xt .GE. 0.) THEN
              x21 = xt
              CALL PUSHCONTROL1B(0)
            ELSE
              x21 = -xt
              CALL PUSHCONTROL1B(1)
            END IF
            IF (q(i-1, j) .LT. q(i, j)) THEN
              IF (q(i, j) .LT. q(i+1, j)) THEN
                max8 = q(i+1, j)
                CALL PUSHCONTROL2B(0)
              ELSE
                max8 = q(i, j)
                CALL PUSHCONTROL2B(1)
              END IF
            ELSE IF (q(i-1, j) .LT. q(i+1, j)) THEN
              max8 = q(i+1, j)
              CALL PUSHCONTROL2B(2)
            ELSE
              max8 = q(i-1, j)
              CALL PUSHCONTROL2B(3)
            END IF
            y20 = max8 - q(i, j)
            IF (q(i-1, j) .GT. q(i, j)) THEN
              IF (q(i, j) .GT. q(i+1, j)) THEN
                min27 = q(i+1, j)
                CALL PUSHCONTROL2B(0)
              ELSE
                min27 = q(i, j)
                CALL PUSHCONTROL2B(1)
              END IF
            ELSE IF (q(i-1, j) .GT. q(i+1, j)) THEN
              min27 = q(i+1, j)
              CALL PUSHCONTROL2B(2)
            ELSE
              min27 = q(i-1, j)
              CALL PUSHCONTROL2B(3)
            END IF
            z8 = q(i, j) - min27
            IF (x21 .GT. y20) THEN
              IF (y20 .GT. z8) THEN
                CALL PUSHREALARRAY_ADM(min14)
                min14 = z8
                CALL PUSHCONTROL2B(0)
              ELSE
                CALL PUSHREALARRAY_ADM(min14)
                min14 = y20
                CALL PUSHCONTROL2B(1)
              END IF
            ELSE IF (x21 .GT. z8) THEN
              CALL PUSHREALARRAY_ADM(min14)
              min14 = z8
              CALL PUSHCONTROL2B(2)
            ELSE
              CALL PUSHREALARRAY_ADM(min14)
              min14 = x21
              CALL PUSHCONTROL2B(3)
            END IF
            dm1(i) = SIGN(min14, xt)
          END DO
          DO i=ifirst-1,ilast+2
            al(i) = 0.5*(q(i-1, j)+q(i, j)) + r3*(dm1(i-1)-dm1(i))
          END DO
          DO i=ifirst-3,ilast+2
            dq(i) = q(i+1, j) - q(i, j)
          END DO
          DO i=ifirst-1,ilast+1
            pmp = -(2.*dq(i))
            lac = pmp + 1.5*dq(i+1)
            IF (0. .LT. pmp) THEN
              IF (pmp .LT. lac) THEN
                x22 = lac
                CALL PUSHCONTROL2B(0)
              ELSE
                x22 = pmp
                CALL PUSHCONTROL2B(1)
              END IF
            ELSE IF (0. .LT. lac) THEN
              x22 = lac
              CALL PUSHCONTROL2B(2)
            ELSE
              CALL PUSHCONTROL2B(3)
              x22 = 0.
            END IF
            IF (0. .GT. pmp) THEN
              IF (pmp .GT. lac) THEN
                y40 = lac
                CALL PUSHCONTROL2B(0)
              ELSE
                y40 = pmp
                CALL PUSHCONTROL2B(1)
              END IF
            ELSE IF (0. .GT. lac) THEN
              y40 = lac
              CALL PUSHCONTROL2B(2)
            ELSE
              y40 = 0.
              CALL PUSHCONTROL2B(3)
            END IF
            IF (al(i) - q(i, j) .LT. y40) THEN
              y21 = y40
              CALL PUSHCONTROL1B(0)
            ELSE
              y21 = al(i) - q(i, j)
              CALL PUSHCONTROL1B(1)
            END IF
            IF (x22 .GT. y21) THEN
              CALL PUSHREALARRAY_ADM(bl(i))
              bl(i) = y21
              CALL PUSHCONTROL1B(0)
            ELSE
              CALL PUSHREALARRAY_ADM(bl(i))
              bl(i) = x22
              CALL PUSHCONTROL1B(1)
            END IF
            pmp = 2.*dq(i-1)
            lac = pmp - 1.5*dq(i-2)
            IF (0. .LT. pmp) THEN
              IF (pmp .LT. lac) THEN
                x23 = lac
                CALL PUSHCONTROL2B(0)
              ELSE
                x23 = pmp
                CALL PUSHCONTROL2B(1)
              END IF
            ELSE IF (0. .LT. lac) THEN
              x23 = lac
              CALL PUSHCONTROL2B(2)
            ELSE
              CALL PUSHCONTROL2B(3)
              x23 = 0.
            END IF
            IF (0. .GT. pmp) THEN
              IF (pmp .GT. lac) THEN
                y41 = lac
                CALL PUSHCONTROL2B(0)
              ELSE
                y41 = pmp
                CALL PUSHCONTROL2B(1)
              END IF
            ELSE IF (0. .GT. lac) THEN
              y41 = lac
              CALL PUSHCONTROL2B(2)
            ELSE
              y41 = 0.
              CALL PUSHCONTROL2B(3)
            END IF
            IF (al(i+1) - q(i, j) .LT. y41) THEN
              y22 = y41
              CALL PUSHCONTROL1B(0)
            ELSE
              y22 = al(i+1) - q(i, j)
              CALL PUSHCONTROL1B(1)
            END IF
            IF (x23 .GT. y22) THEN
              CALL PUSHREALARRAY_ADM(br(i))
              br(i) = y22
              CALL PUSHCONTROL1B(0)
            ELSE
              CALL PUSHREALARRAY_ADM(br(i))
              br(i) = x23
              CALL PUSHCONTROL1B(1)
            END IF
          END DO
          CALL PUSHCONTROL2B(0)
        END IF
        DO i=ifirst,ilast+1
          IF (c(i, j) .GT. 0.) THEN
            CALL PUSHCONTROL1B(1)
          ELSE
            CALL PUSHCONTROL1B(0)
          END IF
        END DO
      END DO
      dq_ad = 0.0_FVPRC
      al_ad = 0.0_FVPRC
      dm1_ad = 0.0_FVPRC
      bl_ad = 0.0_FVPRC
      br_ad = 0.0_FVPRC
      DO 130 j=jlast,jfirst,-1
        DO i=ilast+1,ifirst,-1
          CALL POPCONTROL1B(branch)
          IF (branch .EQ. 0) THEN
            temp_ad29 = (c(i, j)+1.)*flux_ad(i, j)
            temp_ad30 = c(i, j)*temp_ad29
            q_ad(i, j) = q_ad(i, j) + flux_ad(i, j)
            c_ad(i, j) = c_ad(i, j) + (bl(i)+br(i))*temp_ad29 + (bl(i)+c&
&             (i, j)*(bl(i)+br(i)))*flux_ad(i, j)
            bl_ad(i) = bl_ad(i) + temp_ad30 + temp_ad29
            br_ad(i) = br_ad(i) + temp_ad30
            flux_ad(i, j) = 0.0_FVPRC
          ELSE
            temp3 = bl(i-1) + br(i-1)
            temp_ad27 = (1.-c(i, j))*flux_ad(i, j)
            temp_ad28 = -(c(i, j)*temp_ad27)
            q_ad(i-1, j) = q_ad(i-1, j) + flux_ad(i, j)
            c_ad(i, j) = c_ad(i, j) - temp3*temp_ad27 - (br(i-1)-c(i, j)&
&             *temp3)*flux_ad(i, j)
            br_ad(i-1) = br_ad(i-1) + temp_ad28 + temp_ad27
            bl_ad(i-1) = bl_ad(i-1) + temp_ad28
            flux_ad(i, j) = 0.0_FVPRC
          END IF
        END DO
        CALL POPCONTROL2B(branch)
        IF (branch .LT. 2) THEN
          IF (branch .EQ. 0) THEN
            DO i=ilast+1,ifirst-1,-1
              CALL POPCONTROL1B(branch)
              IF (branch .EQ. 0) THEN
                CALL POPREALARRAY_ADM(br(i))
                y22_ad = br_ad(i)
                br_ad(i) = 0.0_FVPRC
                x23_ad = 0.0_FVPRC
              ELSE
                CALL POPREALARRAY_ADM(br(i))
                x23_ad = br_ad(i)
                br_ad(i) = 0.0_FVPRC
                y22_ad = 0.0_FVPRC
              END IF
              CALL POPCONTROL1B(branch)
              IF (branch .EQ. 0) THEN
                y41_ad = y22_ad
              ELSE
                al_ad(i+1) = al_ad(i+1) + y22_ad
                q_ad(i, j) = q_ad(i, j) - y22_ad
                y41_ad = 0.0_FVPRC
              END IF
              CALL POPCONTROL2B(branch)
              IF (branch .LT. 2) THEN
                IF (branch .EQ. 0) THEN
                  lac_ad = y41_ad
                  pmp_ad = 0.0_FVPRC
                ELSE
                  pmp_ad = y41_ad
                  lac_ad = 0.0_FVPRC
                END IF
              ELSE
                IF (branch .EQ. 2) THEN
                  lac_ad = y41_ad
                ELSE
                  lac_ad = 0.0_FVPRC
                END IF
                pmp_ad = 0.0_FVPRC
              END IF
              CALL POPCONTROL2B(branch)
              IF (branch .LT. 2) THEN
                IF (branch .EQ. 0) THEN
                  lac_ad = lac_ad + x23_ad
                ELSE
                  pmp_ad = pmp_ad + x23_ad
                END IF
              ELSE IF (branch .EQ. 2) THEN
                lac_ad = lac_ad + x23_ad
              END IF
              pmp_ad = pmp_ad + lac_ad
              dq_ad(i-2) = dq_ad(i-2) - 1.5*lac_ad
              dq_ad(i-1) = dq_ad(i-1) + 2.*pmp_ad
              CALL POPCONTROL1B(branch)
              IF (branch .EQ. 0) THEN
                CALL POPREALARRAY_ADM(bl(i))
                y21_ad = bl_ad(i)
                bl_ad(i) = 0.0_FVPRC
                x22_ad = 0.0_FVPRC
              ELSE
                CALL POPREALARRAY_ADM(bl(i))
                x22_ad = bl_ad(i)
                bl_ad(i) = 0.0_FVPRC
                y21_ad = 0.0_FVPRC
              END IF
              CALL POPCONTROL1B(branch)
              IF (branch .EQ. 0) THEN
                y40_ad = y21_ad
              ELSE
                al_ad(i) = al_ad(i) + y21_ad
                q_ad(i, j) = q_ad(i, j) - y21_ad
                y40_ad = 0.0_FVPRC
              END IF
              CALL POPCONTROL2B(branch)
              IF (branch .LT. 2) THEN
                IF (branch .EQ. 0) THEN
                  lac_ad = y40_ad
                  pmp_ad = 0.0_FVPRC
                ELSE
                  pmp_ad = y40_ad
                  lac_ad = 0.0_FVPRC
                END IF
              ELSE
                IF (branch .EQ. 2) THEN
                  lac_ad = y40_ad
                ELSE
                  lac_ad = 0.0_FVPRC
                END IF
                pmp_ad = 0.0_FVPRC
              END IF
              CALL POPCONTROL2B(branch)
              IF (branch .LT. 2) THEN
                IF (branch .EQ. 0) THEN
                  lac_ad = lac_ad + x22_ad
                ELSE
                  pmp_ad = pmp_ad + x22_ad
                END IF
              ELSE IF (branch .EQ. 2) THEN
                lac_ad = lac_ad + x22_ad
              END IF
              pmp_ad = pmp_ad + lac_ad
              dq_ad(i+1) = dq_ad(i+1) + 1.5*lac_ad
              dq_ad(i) = dq_ad(i) - 2.*pmp_ad
            END DO
            DO i=ilast+2,ifirst-3,-1
              q_ad(i+1, j) = q_ad(i+1, j) + dq_ad(i)
              q_ad(i, j) = q_ad(i, j) - dq_ad(i)
              dq_ad(i) = 0.0_FVPRC
            END DO
            DO i=ilast+2,ifirst-1,-1
              q_ad(i-1, j) = q_ad(i-1, j) + 0.5*al_ad(i)
              q_ad(i, j) = q_ad(i, j) + 0.5*al_ad(i)
              dm1_ad(i-1) = dm1_ad(i-1) + r3*al_ad(i)
              dm1_ad(i) = dm1_ad(i) - r3*al_ad(i)
              al_ad(i) = 0.0_FVPRC
            END DO
            DO i=ilast+2,ifirst-2,-1
              xt = 0.25*(q(i+1, j)-q(i-1, j))
              min14_ad = SIGN(1.d0, min14*xt)*dm1_ad(i)
              dm1_ad(i) = 0.0_FVPRC
              CALL POPCONTROL2B(branch)
              IF (branch .LT. 2) THEN
                IF (branch .EQ. 0) THEN
                  CALL POPREALARRAY_ADM(min14)
                  z8_ad = min14_ad
                  y20_ad = 0.0_FVPRC
                ELSE
                  CALL POPREALARRAY_ADM(min14)
                  y20_ad = min14_ad
                  z8_ad = 0.0_FVPRC
                END IF
                x21_ad = 0.0_FVPRC
              ELSE
                IF (branch .EQ. 2) THEN
                  CALL POPREALARRAY_ADM(min14)
                  z8_ad = min14_ad
                  x21_ad = 0.0_FVPRC
                ELSE
                  CALL POPREALARRAY_ADM(min14)
                  x21_ad = min14_ad
                  z8_ad = 0.0_FVPRC
                END IF
                y20_ad = 0.0_FVPRC
              END IF
              q_ad(i, j) = q_ad(i, j) + z8_ad
              min27_ad = -z8_ad
              CALL POPCONTROL2B(branch)
              IF (branch .LT. 2) THEN
                IF (branch .EQ. 0) THEN
                  q_ad(i+1, j) = q_ad(i+1, j) + min27_ad
                ELSE
                  q_ad(i, j) = q_ad(i, j) + min27_ad
                END IF
              ELSE IF (branch .EQ. 2) THEN
                q_ad(i+1, j) = q_ad(i+1, j) + min27_ad
              ELSE
                q_ad(i-1, j) = q_ad(i-1, j) + min27_ad
              END IF
              max8_ad = y20_ad
              q_ad(i, j) = q_ad(i, j) - y20_ad
              CALL POPCONTROL2B(branch)
              IF (branch .LT. 2) THEN
                IF (branch .EQ. 0) THEN
                  q_ad(i+1, j) = q_ad(i+1, j) + max8_ad
                ELSE
                  q_ad(i, j) = q_ad(i, j) + max8_ad
                END IF
              ELSE IF (branch .EQ. 2) THEN
                q_ad(i+1, j) = q_ad(i+1, j) + max8_ad
              ELSE
                q_ad(i-1, j) = q_ad(i-1, j) + max8_ad
              END IF
              CALL POPCONTROL1B(branch)
              IF (branch .EQ. 0) THEN
                xt_ad = x21_ad
              ELSE
                xt_ad = -x21_ad
              END IF
              CALL POPREALARRAY_ADM(xt)
              q_ad(i+1, j) = q_ad(i+1, j) + 0.25*xt_ad
              q_ad(i-1, j) = q_ad(i-1, j) - 0.25*xt_ad
            END DO
            GOTO 130
          END IF
        ELSE
          IF (branch .NE. 2) THEN
            CALL POPREALARRAY_ADM(bl(npx-2), 8*(ilast-npx+4)/8)
            CALL POPREALARRAY_ADM(br(npx-2), 8*(ilast-npx+4)/8)
            CALL PERT_PPM_ADM(3, q(npx-2, j), bl(npx-2:), bl_ad(npx-2:)&
&                       , br(npx-2:), br_ad(npx-2:), 1)
            CALL POPREALARRAY_ADM(bl(npx-1))
            xt_ad = br_ad(npx-2) + bl_ad(npx-1)
            q_ad(npx-1, j) = q_ad(npx-1, j) - bl_ad(npx-1)
            bl_ad(npx-1) = 0.0_FVPRC
            CALL POPREALARRAY_ADM(br(npx-2))
            q_ad(npx-2, j) = q_ad(npx-2, j) - br_ad(npx-2)
            br_ad(npx-2) = 0.0_FVPRC
            q_ad(npx-1, j) = q_ad(npx-1, j) + s15*xt_ad
            q_ad(npx-2, j) = q_ad(npx-2, j) + s11*xt_ad
            dm1_ad(npx-2) = dm1_ad(npx-2) + s14*xt_ad
            CALL POPREALARRAY_ADM(br(npx))
            xt_ad = br_ad(npx)
            q_ad(npx, j) = q_ad(npx, j) + xt_ad - bl_ad(npx) - br_ad(npx&
&             )
            br_ad(npx) = 0.0_FVPRC
            dq_ad(npx) = dq_ad(npx) + s11*xt_ad
            dm1_ad(npx+1) = dm1_ad(npx+1) - s14*xt_ad
            CALL POPREALARRAY_ADM(bl(npx))
            xt_ad = br_ad(npx-1) + bl_ad(npx)
            bl_ad(npx) = 0.0_FVPRC
            CALL POPREALARRAY_ADM(br(npx-1))
            q_ad(npx-1, j) = q_ad(npx-1, j) - br_ad(npx-1)
            br_ad(npx-1) = 0.0_FVPRC
            CALL POPREALARRAY_ADM(xt)
            x0l_ad = xt_ad
            x0r_ad = xt_ad
            temp_ad25 = 0.5*x0r_ad/(dxa(npx, j)+dxa(npx+1, j))
            q_ad(npx, j) = q_ad(npx, j) + (dxa(npx, j)*2.+dxa(npx+1, j))&
&             *temp_ad25
            q_ad(npx+1, j) = q_ad(npx+1, j) - dxa(npx, j)*temp_ad25
            temp_ad26 = 0.5*x0l_ad/(dxa(npx-1, j)+dxa(npx-2, j))
            q_ad(npx-1, j) = q_ad(npx-1, j) + (dxa(npx-1, j)*2.+dxa(npx-&
&             2, j))*temp_ad26
            q_ad(npx-2, j) = q_ad(npx-2, j) - bl_ad(npx-2) - dxa(npx-1, &
&             j)*temp_ad26
            CALL POPREALARRAY_ADM(bl(npx-2))
            al_ad(npx-2) = al_ad(npx-2) + bl_ad(npx-2)
            bl_ad(npx-2) = 0.0_FVPRC
          END IF
          CALL POPCONTROL1B(branch)
          IF (branch .EQ. 0) THEN
            CALL POPREALARRAY_ADM(bl(0), 8*(ilast+2)/8)
            CALL POPREALARRAY_ADM(br(0), 8*(ilast+2)/8)
            CALL PERT_PPM_ADM(3, q(0, j), bl(0:), bl_ad(0:), br(0:), &
&                       br_ad(0:), 1)
            CALL POPREALARRAY_ADM(bl(2))
            xt_ad = br_ad(1) + bl_ad(2)
            q_ad(2, j) = q_ad(2, j) - bl_ad(2)
            bl_ad(2) = 0.0_FVPRC
            CALL POPREALARRAY_ADM(br(1))
            q_ad(1, j) = q_ad(1, j) + s15*xt_ad - br_ad(1)
            br_ad(1) = 0.0_FVPRC
            q_ad(2, j) = q_ad(2, j) + s11*xt_ad
            dm1_ad(2) = dm1_ad(2) - s14*xt_ad
            CALL POPREALARRAY_ADM(bl(0))
            xt_ad = bl_ad(0)
            q_ad(0, j) = q_ad(0, j) + xt_ad - br_ad(0) - bl_ad(0)
            bl_ad(0) = 0.0_FVPRC
            dm1_ad(-1) = dm1_ad(-1) + s14*xt_ad
            dq_ad(-1) = dq_ad(-1) - s11*xt_ad
            CALL POPREALARRAY_ADM(br(0))
            xt_ad = bl_ad(1) + br_ad(0)
            br_ad(0) = 0.0_FVPRC
            CALL POPREALARRAY_ADM(bl(1))
            q_ad(1, j) = q_ad(1, j) - bl_ad(1)
            bl_ad(1) = 0.0_FVPRC
            CALL POPREALARRAY_ADM(xt)
            x0l_ad = xt_ad
            x0r_ad = xt_ad
            CALL POPREALARRAY_ADM(br(2))
            al_ad(3) = al_ad(3) + br_ad(2)
            q_ad(2, j) = q_ad(2, j) - br_ad(2)
            br_ad(2) = 0.0_FVPRC
            temp_ad23 = 0.5*x0r_ad/(dxa(1, j)+dxa(2, j))
            q_ad(1, j) = q_ad(1, j) + (dxa(1, j)*2.+dxa(2, j))*temp_ad23
            q_ad(2, j) = q_ad(2, j) - dxa(1, j)*temp_ad23
            temp_ad24 = 0.5*x0l_ad/(dxa(0, j)+dxa(-1, j))
            q_ad(0, j) = q_ad(0, j) + (dxa(0, j)*2.+dxa(-1, j))*&
&             temp_ad24
            q_ad(-1, j) = q_ad(-1, j) - dxa(0, j)*temp_ad24
          END IF
        END IF
        CALL POPCONTROL2B(branch)
        IF (branch .EQ. 0) THEN
          DO i=ie3,is3,-1
            CALL POPREALARRAY_ADM(br(i))
            min13_ad = SIGN(1.d0, min13*xt)*br_ad(i)
            br_ad(i) = 0.0_FVPRC
            CALL POPCONTROL1B(branch)
            IF (branch .EQ. 0) THEN
              CALL POPREALARRAY_ADM(min13)
              y15_ad = min13_ad
              x16_ad = 0.0_FVPRC
            ELSE
              CALL POPREALARRAY_ADM(min13)
              x16_ad = min13_ad
              y15_ad = 0.0_FVPRC
            END IF
            CALL POPCONTROL1B(branch)
            IF (branch .EQ. 0) THEN
              al_ad(i+1) = al_ad(i+1) + y15_ad
              q_ad(i, j) = q_ad(i, j) - y15_ad
            ELSE
              q_ad(i, j) = q_ad(i, j) + y15_ad
              al_ad(i+1) = al_ad(i+1) - y15_ad
            END IF
            CALL POPCONTROL1B(branch)
            IF (branch .EQ. 0) THEN
              xt_ad = x16_ad
            ELSE
              xt_ad = -x16_ad
            END IF
            CALL POPREALARRAY_ADM(bl(i))
            min12_ad = -(SIGN(1.d0, min12*xt)*bl_ad(i))
            bl_ad(i) = 0.0_FVPRC
            CALL POPCONTROL1B(branch)
            IF (branch .EQ. 0) THEN
              CALL POPREALARRAY_ADM(min12)
              y14_ad = min12_ad
              x15_ad = 0.0_FVPRC
            ELSE
              CALL POPREALARRAY_ADM(min12)
              x15_ad = min12_ad
              y14_ad = 0.0_FVPRC
            END IF
            CALL POPCONTROL1B(branch)
            IF (branch .EQ. 0) THEN
              al_ad(i) = al_ad(i) + y14_ad
              q_ad(i, j) = q_ad(i, j) - y14_ad
            ELSE
              q_ad(i, j) = q_ad(i, j) + y14_ad
              al_ad(i) = al_ad(i) - y14_ad
            END IF
            CALL POPCONTROL1B(branch)
            IF (branch .EQ. 0) THEN
              xt_ad = xt_ad + x15_ad
            ELSE
              xt_ad = xt_ad - x15_ad
            END IF
            CALL POPREALARRAY_ADM(xt)
            dm1_ad(i) = dm1_ad(i) + 2.*xt_ad
          END DO
        ELSE IF (branch .EQ. 1) THEN
          DO i=ie3,is3,-1
            CALL POPCONTROL1B(branch)
            IF (branch .EQ. 0) THEN
              CALL POPREALARRAY_ADM(br(i))
              y17_ad = br_ad(i)
              br_ad(i) = 0.0_FVPRC
              x18_ad = 0.0_FVPRC
            ELSE
              CALL POPREALARRAY_ADM(br(i))
              x18_ad = br_ad(i)
              br_ad(i) = 0.0_FVPRC
              y17_ad = 0.0_FVPRC
            END IF
            CALL POPCONTROL1B(branch)
            IF (branch .EQ. 0) THEN
              y37_ad = y17_ad
            ELSE
              al_ad(i+1) = al_ad(i+1) + y17_ad
              q_ad(i, j) = q_ad(i, j) - y17_ad
              y37_ad = 0.0_FVPRC
            END IF
            CALL POPCONTROL2B(branch)
            IF (branch .LT. 2) THEN
              IF (branch .EQ. 0) THEN
                lac_2_ad = y37_ad
                pmp_2_ad = 0.0_FVPRC
              ELSE
                pmp_2_ad = y37_ad
                lac_2_ad = 0.0_FVPRC
              END IF
            ELSE
              IF (branch .EQ. 2) THEN
                lac_2_ad = y37_ad
              ELSE
                lac_2_ad = 0.0_FVPRC
              END IF
              pmp_2_ad = 0.0_FVPRC
            END IF
            CALL POPCONTROL2B(branch)
            IF (branch .LT. 2) THEN
              IF (branch .EQ. 0) THEN
                lac_2_ad = lac_2_ad + x18_ad
              ELSE
                pmp_2_ad = pmp_2_ad + x18_ad
              END IF
            ELSE IF (branch .EQ. 2) THEN
              lac_2_ad = lac_2_ad + x18_ad
            END IF
            pmp_2_ad = pmp_2_ad + lac_2_ad
            dq_ad(i-2) = dq_ad(i-2) - 1.5*lac_2_ad
            dq_ad(i-1) = dq_ad(i-1) + 2.*pmp_2_ad
            CALL POPCONTROL1B(branch)
            IF (branch .EQ. 0) THEN
              CALL POPREALARRAY_ADM(bl(i))
              y16_ad = bl_ad(i)
              bl_ad(i) = 0.0_FVPRC
              x17_ad = 0.0_FVPRC
            ELSE
              CALL POPREALARRAY_ADM(bl(i))
              x17_ad = bl_ad(i)
              bl_ad(i) = 0.0_FVPRC
              y16_ad = 0.0_FVPRC
            END IF
            CALL POPCONTROL1B(branch)
            IF (branch .EQ. 0) THEN
              y36_ad = y16_ad
            ELSE
              al_ad(i) = al_ad(i) + y16_ad
              q_ad(i, j) = q_ad(i, j) - y16_ad
              y36_ad = 0.0_FVPRC
            END IF
            CALL POPCONTROL2B(branch)
            IF (branch .LT. 2) THEN
              IF (branch .EQ. 0) THEN
                lac_1_ad = y36_ad
                pmp_1_ad = 0.0_FVPRC
              ELSE
                pmp_1_ad = y36_ad
                lac_1_ad = 0.0_FVPRC
              END IF
            ELSE
              IF (branch .EQ. 2) THEN
                lac_1_ad = y36_ad
              ELSE
                lac_1_ad = 0.0_FVPRC
              END IF
              pmp_1_ad = 0.0_FVPRC
            END IF
            CALL POPCONTROL2B(branch)
            IF (branch .LT. 2) THEN
              IF (branch .EQ. 0) THEN
                lac_1_ad = lac_1_ad + x17_ad
              ELSE
                pmp_1_ad = pmp_1_ad + x17_ad
              END IF
            ELSE IF (branch .EQ. 2) THEN
              lac_1_ad = lac_1_ad + x17_ad
            END IF
            pmp_1_ad = pmp_1_ad + lac_1_ad
            dq_ad(i+1) = dq_ad(i+1) + 1.5*lac_1_ad
            dq_ad(i) = dq_ad(i) - 2.*pmp_1_ad
          END DO
        ELSE
          DO i=ie3,is3,-1
            CALL POPCONTROL2B(branch)
            IF (branch .LT. 2) THEN
              IF (branch .EQ. 0) THEN
                GOTO 120
              ELSE
                y19_ad = br_ad(i)
                br_ad(i) = 0.0_FVPRC
                x20_ad = 0.0_FVPRC
              END IF
            ELSE IF (branch .EQ. 2) THEN
              x20_ad = br_ad(i)
              br_ad(i) = 0.0_FVPRC
              y19_ad = 0.0_FVPRC
            ELSE
              br_ad(i) = 0.0_FVPRC
              bl_ad(i) = 0.0_FVPRC
              GOTO 120
            END IF
            CALL POPCONTROL1B(branch)
            IF (branch .EQ. 0) THEN
              y39_ad = y19_ad
            ELSE
              br_ad(i) = br_ad(i) + y19_ad
              y39_ad = 0.0_FVPRC
            END IF
            CALL POPCONTROL2B(branch)
            IF (branch .LT. 2) THEN
              IF (branch .EQ. 0) THEN
                lac_2_ad = y39_ad
                pmp_2_ad = 0.0_FVPRC
              ELSE
                pmp_2_ad = y39_ad
                lac_2_ad = 0.0_FVPRC
              END IF
            ELSE
              IF (branch .EQ. 2) THEN
                lac_2_ad = y39_ad
              ELSE
                lac_2_ad = 0.0_FVPRC
              END IF
              pmp_2_ad = 0.0_FVPRC
            END IF
            CALL POPCONTROL2B(branch)
            IF (branch .LT. 2) THEN
              IF (branch .EQ. 0) THEN
                lac_2_ad = lac_2_ad + x20_ad
              ELSE
                pmp_2_ad = pmp_2_ad + x20_ad
              END IF
            ELSE IF (branch .EQ. 2) THEN
              lac_2_ad = lac_2_ad + x20_ad
            END IF
            pmp_2_ad = pmp_2_ad + lac_2_ad
            dq_ad(i-2) = dq_ad(i-2) - 1.5*lac_2_ad
            dq_ad(i-1) = dq_ad(i-1) + 2*pmp_2_ad
            CALL POPCONTROL1B(branch)
            IF (branch .EQ. 0) THEN
              y18_ad = bl_ad(i)
              bl_ad(i) = 0.0_FVPRC
              x19_ad = 0.0_FVPRC
            ELSE
              x19_ad = bl_ad(i)
              bl_ad(i) = 0.0_FVPRC
              y18_ad = 0.0_FVPRC
            END IF
            CALL POPCONTROL1B(branch)
            IF (branch .EQ. 0) THEN
              y38_ad = y18_ad
            ELSE
              bl_ad(i) = bl_ad(i) + y18_ad
              y38_ad = 0.0_FVPRC
            END IF
            CALL POPCONTROL2B(branch)
            IF (branch .LT. 2) THEN
              IF (branch .EQ. 0) THEN
                lac_1_ad = y38_ad
                pmp_1_ad = 0.0_FVPRC
              ELSE
                pmp_1_ad = y38_ad
                lac_1_ad = 0.0_FVPRC
              END IF
            ELSE
              IF (branch .EQ. 2) THEN
                lac_1_ad = y38_ad
              ELSE
                lac_1_ad = 0.0_FVPRC
              END IF
              pmp_1_ad = 0.0_FVPRC
            END IF
            CALL POPCONTROL2B(branch)
            IF (branch .LT. 2) THEN
              IF (branch .EQ. 0) THEN
                lac_1_ad = lac_1_ad + x19_ad
              ELSE
                pmp_1_ad = pmp_1_ad + x19_ad
              END IF
            ELSE IF (branch .EQ. 2) THEN
              lac_1_ad = lac_1_ad + x19_ad
            END IF
            pmp_1_ad = pmp_1_ad + lac_1_ad
            dq_ad(i+1) = dq_ad(i+1) + 1.5*lac_1_ad
            dq_ad(i) = dq_ad(i) - 2*pmp_1_ad
 120        CALL POPREALARRAY_ADM(br(i))
            al_ad(i+1) = al_ad(i+1) + br_ad(i)
            q_ad(i, j) = q_ad(i, j) - bl_ad(i) - br_ad(i)
            br_ad(i) = 0.0_FVPRC
            CALL POPREALARRAY_ADM(bl(i))
            al_ad(i) = al_ad(i) + bl_ad(i)
            bl_ad(i) = 0.0_FVPRC
          END DO
        END IF
        DO i=ie3+1,is3,-1
          q_ad(i-1, j) = q_ad(i-1, j) + 0.5*al_ad(i)
          q_ad(i, j) = q_ad(i, j) + 0.5*al_ad(i)
          dm1_ad(i-1) = dm1_ad(i-1) + r3*al_ad(i)
          dm1_ad(i) = dm1_ad(i) - r3*al_ad(i)
          al_ad(i) = 0.0_FVPRC
        END DO
        DO i=ie+2,is-2,-1
          xt = 0.25*(q(i+1, j)-q(i-1, j))
          min11_ad = SIGN(1.d0, min11*xt)*dm1_ad(i)
          dm1_ad(i) = 0.0_FVPRC
          CALL POPCONTROL2B(branch)
          IF (branch .LT. 2) THEN
            IF (branch .EQ. 0) THEN
              CALL POPREALARRAY_ADM(min11)
              z7_ad = min11_ad
              y13_ad = 0.0_FVPRC
            ELSE
              CALL POPREALARRAY_ADM(min11)
              y13_ad = min11_ad
              z7_ad = 0.0_FVPRC
            END IF
            x14_ad = 0.0_FVPRC
          ELSE
            IF (branch .EQ. 2) THEN
              CALL POPREALARRAY_ADM(min11)
              z7_ad = min11_ad
              x14_ad = 0.0_FVPRC
            ELSE
              CALL POPREALARRAY_ADM(min11)
              x14_ad = min11_ad
              z7_ad = 0.0_FVPRC
            END IF
            y13_ad = 0.0_FVPRC
          END IF
          q_ad(i, j) = q_ad(i, j) + z7_ad
          min26_ad = -z7_ad
          CALL POPCONTROL2B(branch)
          IF (branch .LT. 2) THEN
            IF (branch .EQ. 0) THEN
              q_ad(i+1, j) = q_ad(i+1, j) + min26_ad
            ELSE
              q_ad(i, j) = q_ad(i, j) + min26_ad
            END IF
          ELSE IF (branch .EQ. 2) THEN
            q_ad(i+1, j) = q_ad(i+1, j) + min26_ad
          ELSE
            q_ad(i-1, j) = q_ad(i-1, j) + min26_ad
          END IF
          max7_ad = y13_ad
          q_ad(i, j) = q_ad(i, j) - y13_ad
          CALL POPCONTROL2B(branch)
          IF (branch .LT. 2) THEN
            IF (branch .EQ. 0) THEN
              q_ad(i+1, j) = q_ad(i+1, j) + max7_ad
            ELSE
              q_ad(i, j) = q_ad(i, j) + max7_ad
            END IF
          ELSE IF (branch .EQ. 2) THEN
            q_ad(i+1, j) = q_ad(i+1, j) + max7_ad
          ELSE
            q_ad(i-1, j) = q_ad(i-1, j) + max7_ad
          END IF
          CALL POPCONTROL1B(branch)
          IF (branch .EQ. 0) THEN
            xt_ad = x14_ad
          ELSE
            xt_ad = -x14_ad
          END IF
          CALL POPREALARRAY_ADM(xt)
          q_ad(i+1, j) = q_ad(i+1, j) + 0.25*xt_ad
          q_ad(i-1, j) = q_ad(i-1, j) - 0.25*xt_ad
        END DO
        DO i=ie+2,is-3,-1
          q_ad(i+1, j) = q_ad(i+1, j) + dq_ad(i)
          q_ad(i, j) = q_ad(i, j) - dq_ad(i)
          dq_ad(i) = 0.0_FVPRC
        END DO
 130  CONTINUE
    ELSE
!------------------------------
! For positive definite tracers:
!------------------------------
! iord=11: PPM mono constraint (Lin 2004)
! iord=12: Huynh 2nd constraint (Lin 2004) + positive definite (Lin & Rood 1996)
! iord>12: positive definite
      DO j=jfirst,jlast
        DO i=is-2,ie+2
          CALL PUSHREALARRAY_ADM(xt)
          xt = 0.25*(q(i+1, j)-q(i-1, j))
          IF (xt .GE. 0.) THEN
            x24 = xt
            CALL PUSHCONTROL1B(0)
          ELSE
            x24 = -xt
            CALL PUSHCONTROL1B(1)
          END IF
          IF (q(i-1, j) .LT. q(i, j)) THEN
            IF (q(i, j) .LT. q(i+1, j)) THEN
              max9 = q(i+1, j)
              CALL PUSHCONTROL2B(0)
            ELSE
              max9 = q(i, j)
              CALL PUSHCONTROL2B(1)
            END IF
          ELSE IF (q(i-1, j) .LT. q(i+1, j)) THEN
            max9 = q(i+1, j)
            CALL PUSHCONTROL2B(2)
          ELSE
            max9 = q(i-1, j)
            CALL PUSHCONTROL2B(3)
          END IF
          y23 = max9 - q(i, j)
          IF (q(i-1, j) .GT. q(i, j)) THEN
            IF (q(i, j) .GT. q(i+1, j)) THEN
              min28 = q(i+1, j)
              CALL PUSHCONTROL2B(0)
            ELSE
              min28 = q(i, j)
              CALL PUSHCONTROL2B(1)
            END IF
          ELSE IF (q(i-1, j) .GT. q(i+1, j)) THEN
            min28 = q(i+1, j)
            CALL PUSHCONTROL2B(2)
          ELSE
            min28 = q(i-1, j)
            CALL PUSHCONTROL2B(3)
          END IF
          z9 = q(i, j) - min28
          IF (x24 .GT. y23) THEN
            IF (y23 .GT. z9) THEN
              CALL PUSHREALARRAY_ADM(min15)
              min15 = z9
              CALL PUSHCONTROL2B(0)
            ELSE
              CALL PUSHREALARRAY_ADM(min15)
              min15 = y23
              CALL PUSHCONTROL2B(1)
            END IF
          ELSE IF (x24 .GT. z9) THEN
            CALL PUSHREALARRAY_ADM(min15)
            min15 = z9
            CALL PUSHCONTROL2B(2)
          ELSE
            CALL PUSHREALARRAY_ADM(min15)
            min15 = x24
            CALL PUSHCONTROL2B(3)
          END IF
          dm1(i) = SIGN(min15, xt)
        END DO
        IF (grid_type .LT. 3) THEN
          IF (nested .AND. iord .NE. 14) THEN
            CALL PUSHINTEGER4(is3)
            is3 = is - 1
            ie3 = ie + 1
            CALL PUSHCONTROL1B(1)
          ELSE
            IF (3 .LT. is - 1) THEN
              CALL PUSHINTEGER4(is3)
              is3 = is - 1
              CALL PUSHCONTROL1B(0)
            ELSE
              CALL PUSHINTEGER4(is3)
              is3 = 3
              CALL PUSHCONTROL1B(1)
            END IF
            IF (npx - 3 .GT. ie + 1) THEN
              CALL PUSHCONTROL1B(0)
              ie3 = ie + 1
            ELSE
              CALL PUSHCONTROL1B(0)
              ie3 = npx - 3
            END IF
          END IF
          ad_from = is3
!             do i=is3,min(npx-2,ie+2)
          DO i=ad_from,ie3+1
            al(i) = 0.5*(q(i-1, j)+q(i, j)) + r3*(dm1(i-1)-dm1(i))
          END DO
          CALL PUSHINTEGER4(i - 1)
          CALL PUSHINTEGER4(ad_from)
          IF (iord .EQ. 11) THEN
            ad_from0 = is3
            DO i=ad_from0,ie3
              CALL PUSHREALARRAY_ADM(xt)
              xt = 2.*dm1(i)
              IF (xt .GE. 0.) THEN
                x25 = xt
                CALL PUSHCONTROL1B(0)
              ELSE
                x25 = -xt
                CALL PUSHCONTROL1B(1)
              END IF
              IF (al(i) - q(i, j) .GE. 0.) THEN
                y24 = al(i) - q(i, j)
                CALL PUSHCONTROL1B(0)
              ELSE
                y24 = -(al(i)-q(i, j))
                CALL PUSHCONTROL1B(1)
              END IF
              IF (x25 .GT. y24) THEN
                CALL PUSHREALARRAY_ADM(min16)
                min16 = y24
                CALL PUSHCONTROL1B(0)
              ELSE
                CALL PUSHREALARRAY_ADM(min16)
                min16 = x25
                CALL PUSHCONTROL1B(1)
              END IF
              CALL PUSHREALARRAY_ADM(bl(i))
              bl(i) = -SIGN(min16, xt)
              IF (xt .GE. 0.) THEN
                x26 = xt
                CALL PUSHCONTROL1B(0)
              ELSE
                x26 = -xt
                CALL PUSHCONTROL1B(1)
              END IF
              IF (al(i+1) - q(i, j) .GE. 0.) THEN
                y25 = al(i+1) - q(i, j)
                CALL PUSHCONTROL1B(0)
              ELSE
                y25 = -(al(i+1)-q(i, j))
                CALL PUSHCONTROL1B(1)
              END IF
              IF (x26 .GT. y25) THEN
                CALL PUSHREALARRAY_ADM(min17)
                min17 = y25
                CALL PUSHCONTROL1B(0)
              ELSE
                CALL PUSHREALARRAY_ADM(min17)
                min17 = x26
                CALL PUSHCONTROL1B(1)
              END IF
              CALL PUSHREALARRAY_ADM(br(i))
              br(i) = SIGN(min17, xt)
            END DO
            CALL PUSHINTEGER4(i - 1)
            CALL PUSHINTEGER4(ad_from0)
            CALL PUSHCONTROL2B(0)
          ELSE IF (iord .EQ. 12) THEN
            DO i=is-3,ie+2
              dq(i) = q(i+1, j) - q(i, j)
            END DO
            ad_from1 = is3
            DO i=ad_from1,ie3
              pmp = -(2.*dq(i))
              lac = pmp + 1.5*dq(i+1)
              IF (0. .LT. pmp) THEN
                IF (pmp .LT. lac) THEN
                  x27 = lac
                  CALL PUSHCONTROL2B(0)
                ELSE
                  x27 = pmp
                  CALL PUSHCONTROL2B(1)
                END IF
              ELSE IF (0. .LT. lac) THEN
                x27 = lac
                CALL PUSHCONTROL2B(2)
              ELSE
                CALL PUSHCONTROL2B(3)
                x27 = 0.
              END IF
              IF (0. .GT. pmp) THEN
                IF (pmp .GT. lac) THEN
                  y42 = lac
                  CALL PUSHCONTROL2B(0)
                ELSE
                  y42 = pmp
                  CALL PUSHCONTROL2B(1)
                END IF
              ELSE IF (0. .GT. lac) THEN
                y42 = lac
                CALL PUSHCONTROL2B(2)
              ELSE
                y42 = 0.
                CALL PUSHCONTROL2B(3)
              END IF
              IF (al(i) - q(i, j) .LT. y42) THEN
                y26 = y42
                CALL PUSHCONTROL1B(0)
              ELSE
                y26 = al(i) - q(i, j)
                CALL PUSHCONTROL1B(1)
              END IF
              IF (x27 .GT. y26) THEN
                CALL PUSHREALARRAY_ADM(bl(i))
                bl(i) = y26
                CALL PUSHCONTROL1B(0)
              ELSE
                CALL PUSHREALARRAY_ADM(bl(i))
                bl(i) = x27
                CALL PUSHCONTROL1B(1)
              END IF
              pmp = 2.*dq(i-1)
              lac = pmp - 1.5*dq(i-2)
              IF (0. .LT. pmp) THEN
                IF (pmp .LT. lac) THEN
                  x28 = lac
                  CALL PUSHCONTROL2B(0)
                ELSE
                  x28 = pmp
                  CALL PUSHCONTROL2B(1)
                END IF
              ELSE IF (0. .LT. lac) THEN
                x28 = lac
                CALL PUSHCONTROL2B(2)
              ELSE
                CALL PUSHCONTROL2B(3)
                x28 = 0.
              END IF
              IF (0. .GT. pmp) THEN
                IF (pmp .GT. lac) THEN
                  y43 = lac
                  CALL PUSHCONTROL2B(0)
                ELSE
                  y43 = pmp
                  CALL PUSHCONTROL2B(1)
                END IF
              ELSE IF (0. .GT. lac) THEN
                y43 = lac
                CALL PUSHCONTROL2B(2)
              ELSE
                y43 = 0.
                CALL PUSHCONTROL2B(3)
              END IF
              IF (al(i+1) - q(i, j) .LT. y43) THEN
                y27 = y43
                CALL PUSHCONTROL1B(0)
              ELSE
                y27 = al(i+1) - q(i, j)
                CALL PUSHCONTROL1B(1)
              END IF
              IF (x28 .GT. y27) THEN
                CALL PUSHREALARRAY_ADM(br(i))
                br(i) = y27
                CALL PUSHCONTROL1B(0)
              ELSE
                CALL PUSHREALARRAY_ADM(br(i))
                br(i) = x28
                CALL PUSHCONTROL1B(1)
              END IF
            END DO
            CALL PUSHINTEGER4(i - 1)
            CALL PUSHINTEGER4(ad_from1)
            CALL PUSHCONTROL2B(1)
          ELSE
            DO i=is-3,ie+2
              dq(i) = q(i+1, j) - q(i, j)
            END DO
            ad_from2 = is3
            DO i=ad_from2,ie3
              IF (dm1(i-1) .GE. 0.) THEN
                abs2 = dm1(i-1)
              ELSE
                abs2 = -dm1(i-1)
              END IF
              IF (dm1(i) .GE. 0.) THEN
                abs6 = dm1(i)
              ELSE
                abs6 = -dm1(i)
              END IF
              IF (dm1(i+1) .GE. 0.) THEN
                abs9 = dm1(i+1)
              ELSE
                abs9 = -dm1(i+1)
              END IF
              IF (abs2 + abs6 + abs9 .LT. near_zero) THEN
                CALL PUSHREALARRAY_ADM(bl(i))
                bl(i) = 0.
                CALL PUSHREALARRAY_ADM(br(i))
                br(i) = 0.
                CALL PUSHCONTROL2B(3)
              ELSE
                CALL PUSHREALARRAY_ADM(bl(i))
                bl(i) = al(i) - q(i, j)
                CALL PUSHREALARRAY_ADM(br(i))
                br(i) = al(i+1) - q(i, j)
                IF (3.*(bl(i)+br(i)) .GE. 0.) THEN
                  abs3 = 3.*(bl(i)+br(i))
                ELSE
                  abs3 = -(3.*(bl(i)+br(i)))
                END IF
                IF (bl(i) - br(i) .GE. 0.) THEN
                  abs7 = bl(i) - br(i)
                ELSE
                  abs7 = -(bl(i)-br(i))
                END IF
                IF (abs3 .GT. abs7) THEN
                  pmp_1 = -(dq(i)+dq(i))
                  lac_1 = pmp_1 + 1.5*dq(i+1)
                  IF (0. .LT. pmp_1) THEN
                    IF (pmp_1 .LT. lac_1) THEN
                      x29 = lac_1
                      CALL PUSHCONTROL2B(0)
                    ELSE
                      x29 = pmp_1
                      CALL PUSHCONTROL2B(1)
                    END IF
                  ELSE IF (0. .LT. lac_1) THEN
                    x29 = lac_1
                    CALL PUSHCONTROL2B(2)
                  ELSE
                    CALL PUSHCONTROL2B(3)
                    x29 = 0.
                  END IF
                  IF (0. .GT. pmp_1) THEN
                    IF (pmp_1 .GT. lac_1) THEN
                      y44 = lac_1
                      CALL PUSHCONTROL2B(0)
                    ELSE
                      y44 = pmp_1
                      CALL PUSHCONTROL2B(1)
                    END IF
                  ELSE IF (0. .GT. lac_1) THEN
                    y44 = lac_1
                    CALL PUSHCONTROL2B(2)
                  ELSE
                    y44 = 0.
                    CALL PUSHCONTROL2B(3)
                  END IF
                  IF (bl(i) .LT. y44) THEN
                    y28 = y44
                    CALL PUSHCONTROL1B(0)
                  ELSE
                    y28 = bl(i)
                    CALL PUSHCONTROL1B(1)
                  END IF
                  IF (x29 .GT. y28) THEN
                    bl(i) = y28
                    CALL PUSHCONTROL1B(0)
                  ELSE
                    bl(i) = x29
                    CALL PUSHCONTROL1B(1)
                  END IF
                  pmp_2 = dq(i-1) + dq(i-1)
                  lac_2 = pmp_2 - 1.5*dq(i-2)
                  IF (0. .LT. pmp_2) THEN
                    IF (pmp_2 .LT. lac_2) THEN
                      x30 = lac_2
                      CALL PUSHCONTROL2B(0)
                    ELSE
                      x30 = pmp_2
                      CALL PUSHCONTROL2B(1)
                    END IF
                  ELSE IF (0. .LT. lac_2) THEN
                    x30 = lac_2
                    CALL PUSHCONTROL2B(2)
                  ELSE
                    CALL PUSHCONTROL2B(3)
                    x30 = 0.
                  END IF
                  IF (0. .GT. pmp_2) THEN
                    IF (pmp_2 .GT. lac_2) THEN
                      y45 = lac_2
                      CALL PUSHCONTROL2B(0)
                    ELSE
                      y45 = pmp_2
                      CALL PUSHCONTROL2B(1)
                    END IF
                  ELSE IF (0. .GT. lac_2) THEN
                    y45 = lac_2
                    CALL PUSHCONTROL2B(2)
                  ELSE
                    y45 = 0.
                    CALL PUSHCONTROL2B(3)
                  END IF
                  IF (br(i) .LT. y45) THEN
                    y29 = y45
                    CALL PUSHCONTROL1B(0)
                  ELSE
                    y29 = br(i)
                    CALL PUSHCONTROL1B(1)
                  END IF
                  IF (x30 .GT. y29) THEN
                    br(i) = y29
                    CALL PUSHCONTROL2B(1)
                  ELSE
                    br(i) = x30
                    CALL PUSHCONTROL2B(2)
                  END IF
                ELSE
                  CALL PUSHCONTROL2B(0)
                END IF
              END IF
            END DO
            CALL PUSHINTEGER4(i - 1)
            CALL PUSHINTEGER4(ad_from2)
            CALL PUSHCONTROL2B(2)
          END IF
! Positive definite constraint:
          IF (iord .NE. 11) THEN
            CALL PUSHINTEGER4(arg1)
            arg1 = ie3 - is3 + 1
            CALL PUSHREALARRAY_ADM(br(is3), 8*(ilast-is3+2)/8)
            CALL PUSHREALARRAY_ADM(bl(is3), 8*(ilast-is3+2)/8)
            CALL PERT_PPM(arg1, q(is3, j), bl(is3), br(is3), 0)
            CALL PUSHCONTROL1B(0)
          ELSE
            CALL PUSHCONTROL1B(1)
          END IF
!--------------
! fix the edges
!--------------
          IF (nested) THEN
            CALL PUSHCONTROL3B(4)
          ELSE
            IF (is .EQ. 1) THEN
              x0l = 0.5*((2.*dxa(0, j)+dxa(-1, j))*q(0, j)-dxa(0, j)*q(-&
&               1, j))/(dxa(0, j)+dxa(-1, j))
              x0r = 0.5*((2.*dxa(1, j)+dxa(2, j))*q(1, j)-dxa(1, j)*q(2&
&               , j))/(dxa(1, j)+dxa(2, j))
              CALL PUSHREALARRAY_ADM(br(2))
              br(2) = al(3) - q(2, j)
!               xt = t11*(q(0,j)+q(1,j)) + t12*(q(-1,j)+q(2,j)) + t13*(dm1(2)-dm1(-1))
!!!             xt = 0.75*(q(0,j)+q(1,j)) - 0.25*(q(-1,j)+q(2,j))
              CALL PUSHREALARRAY_ADM(xt)
              xt = x0l + x0r
              IF (0. .LT. xt) THEN
                CALL PUSHCONTROL1B(0)
                xt = xt
              ELSE
                xt = 0.
                CALL PUSHCONTROL1B(1)
              END IF
              CALL PUSHREALARRAY_ADM(bl(1))
              bl(1) = xt - q(1, j)
              CALL PUSHREALARRAY_ADM(br(0))
              br(0) = xt - q(0, j)
              xt = 4./7.*dm1(-1) + 11./14.*q(-1, j) + 3./14.*q(0, j)
              IF (0. .LT. xt) THEN
                CALL PUSHCONTROL1B(0)
                xt = xt
              ELSE
                xt = 0.
                CALL PUSHCONTROL1B(1)
              END IF
              CALL PUSHREALARRAY_ADM(bl(0))
              bl(0) = xt - q(0, j)
              xt = 3./14.*q(1, j) + 11./14.*q(2, j) - 4./7.*dm1(2)
              IF (0. .LT. xt) THEN
                CALL PUSHCONTROL1B(0)
                xt = xt
              ELSE
                xt = 0.
                CALL PUSHCONTROL1B(1)
              END IF
              CALL PUSHREALARRAY_ADM(br(1))
              br(1) = xt - q(1, j)
              CALL PUSHREALARRAY_ADM(bl(2))
              bl(2) = xt - q(2, j)
              CALL PUSHREALARRAY_ADM(br(0), 8*(ilast+2)/8)
              CALL PUSHREALARRAY_ADM(bl(0), 8*(ilast+2)/8)
              CALL PERT_PPM(3, q(0, j), bl(0), br(0), 1)
              CALL PUSHCONTROL1B(0)
            ELSE
              CALL PUSHCONTROL1B(1)
            END IF
            IF (ie + 1 .EQ. npx) THEN
              x0l = 0.5*((2.*dxa(npx-1, j)+dxa(npx-2, j))*q(npx-1, j)-&
&               dxa(npx-1, j)*q(npx-2, j))/(dxa(npx-1, j)+dxa(npx-2, j))
              x0r = 0.5*((2.*dxa(npx, j)+dxa(npx+1, j))*q(npx, j)-dxa(&
&               npx, j)*q(npx+1, j))/(dxa(npx, j)+dxa(npx+1, j))
              CALL PUSHREALARRAY_ADM(bl(npx-2))
              bl(npx-2) = al(npx-2) - q(npx-2, j)
!               xt = t11*(q(npx-1,j)+q(npx,j)) + t12*(q(npx-2,j)+q(npx+1,j))   &
!                  + t13*(dm1(npx+1)-dm1(npx-2))
!!!             xt = 0.75*(q(npx-1,j)+q(npx,j)) - 0.25*(q(npx-2,j)+q(npx+1,j))
              CALL PUSHREALARRAY_ADM(xt)
              xt = x0l + x0r
              IF (0. .LT. xt) THEN
                CALL PUSHCONTROL1B(0)
                xt = xt
              ELSE
                xt = 0.
                CALL PUSHCONTROL1B(1)
              END IF
              CALL PUSHREALARRAY_ADM(br(npx-1))
              br(npx-1) = xt - q(npx-1, j)
              CALL PUSHREALARRAY_ADM(bl(npx))
              bl(npx) = xt - q(npx, j)
!               br(npx) = 11./14.*q(npx+1,j) + 3./14.*q(npx,j) - 4./7.*dm1(npx+1)
              xt = 11./14.*q(npx+1, j) + 3./14.*q(npx, j) - 4./7.*dm1(&
&               npx+1)
              IF (0. .LT. xt) THEN
                CALL PUSHCONTROL1B(0)
                xt = xt
              ELSE
                xt = 0.
                CALL PUSHCONTROL1B(1)
              END IF
              CALL PUSHREALARRAY_ADM(br(npx))
              br(npx) = xt - q(npx, j)
              xt = 3./14.*q(npx-1, j) + 11./14.*q(npx-2, j) + 4./7.*dm1(&
&               npx-2)
              IF (0. .LT. xt) THEN
                CALL PUSHCONTROL1B(0)
                xt = xt
              ELSE
                xt = 0.
                CALL PUSHCONTROL1B(1)
              END IF
              CALL PUSHREALARRAY_ADM(br(npx-2))
              br(npx-2) = xt - q(npx-2, j)
              CALL PUSHREALARRAY_ADM(bl(npx-1))
              bl(npx-1) = xt - q(npx-1, j)
              CALL PUSHREALARRAY_ADM(br(npx-2), 8*(ilast-npx+4)/8)
              CALL PUSHREALARRAY_ADM(bl(npx-2), 8*(ilast-npx+4)/8)
              CALL PERT_PPM(3, q(npx-2, j), bl(npx-2), br(npx-2), 1)
              CALL PUSHCONTROL3B(3)
            ELSE
              CALL PUSHCONTROL3B(2)
            END IF
          END IF
        ELSE
!--------------
! grid_type >=4
!--------------
          DO i=ifirst-1,ilast+2
            al(i) = 0.5*(q(i-1, j)+q(i, j)) + r3*(dm1(i-1)-dm1(i))
          END DO
          IF (iord .EQ. 11) THEN
            DO i=ifirst-1,ilast+1
              CALL PUSHREALARRAY_ADM(xt)
              xt = 2.*dm1(i)
              IF (xt .GE. 0.) THEN
                x31 = xt
                CALL PUSHCONTROL1B(0)
              ELSE
                x31 = -xt
                CALL PUSHCONTROL1B(1)
              END IF
              IF (al(i) - q(i, j) .GE. 0.) THEN
                y30 = al(i) - q(i, j)
                CALL PUSHCONTROL1B(0)
              ELSE
                y30 = -(al(i)-q(i, j))
                CALL PUSHCONTROL1B(1)
              END IF
              IF (x31 .GT. y30) THEN
                CALL PUSHREALARRAY_ADM(min18)
                min18 = y30
                CALL PUSHCONTROL1B(0)
              ELSE
                CALL PUSHREALARRAY_ADM(min18)
                min18 = x31
                CALL PUSHCONTROL1B(1)
              END IF
              CALL PUSHREALARRAY_ADM(bl(i))
              bl(i) = -SIGN(min18, xt)
              IF (xt .GE. 0.) THEN
                x32 = xt
                CALL PUSHCONTROL1B(0)
              ELSE
                x32 = -xt
                CALL PUSHCONTROL1B(1)
              END IF
              IF (al(i+1) - q(i, j) .GE. 0.) THEN
                y31 = al(i+1) - q(i, j)
                CALL PUSHCONTROL1B(0)
              ELSE
                y31 = -(al(i+1)-q(i, j))
                CALL PUSHCONTROL1B(1)
              END IF
              IF (x32 .GT. y31) THEN
                CALL PUSHREALARRAY_ADM(min19)
                min19 = y31
                CALL PUSHCONTROL1B(0)
              ELSE
                CALL PUSHREALARRAY_ADM(min19)
                min19 = x32
                CALL PUSHCONTROL1B(1)
              END IF
              CALL PUSHREALARRAY_ADM(br(i))
              br(i) = SIGN(min19, xt)
            END DO
            CALL PUSHCONTROL2B(0)
          ELSE IF (iord .EQ. 12) THEN
            DO i=ifirst-3,ilast+2
              dq(i) = q(i+1, j) - q(i, j)
            END DO
            DO i=ifirst-1,ilast+1
              pmp = -(2.*dq(i))
              lac = pmp + 1.5*dq(i+1)
              IF (0. .LT. pmp) THEN
                IF (pmp .LT. lac) THEN
                  x33 = lac
                  CALL PUSHCONTROL2B(0)
                ELSE
                  x33 = pmp
                  CALL PUSHCONTROL2B(1)
                END IF
              ELSE IF (0. .LT. lac) THEN
                x33 = lac
                CALL PUSHCONTROL2B(2)
              ELSE
                CALL PUSHCONTROL2B(3)
                x33 = 0.
              END IF
              IF (0. .GT. pmp) THEN
                IF (pmp .GT. lac) THEN
                  y46 = lac
                  CALL PUSHCONTROL2B(0)
                ELSE
                  y46 = pmp
                  CALL PUSHCONTROL2B(1)
                END IF
              ELSE IF (0. .GT. lac) THEN
                y46 = lac
                CALL PUSHCONTROL2B(2)
              ELSE
                y46 = 0.
                CALL PUSHCONTROL2B(3)
              END IF
              IF (al(i) - q(i, j) .LT. y46) THEN
                y32 = y46
                CALL PUSHCONTROL1B(0)
              ELSE
                y32 = al(i) - q(i, j)
                CALL PUSHCONTROL1B(1)
              END IF
              IF (x33 .GT. y32) THEN
                CALL PUSHREALARRAY_ADM(bl(i))
                bl(i) = y32
                CALL PUSHCONTROL1B(0)
              ELSE
                CALL PUSHREALARRAY_ADM(bl(i))
                bl(i) = x33
                CALL PUSHCONTROL1B(1)
              END IF
              pmp = 2.*dq(i-1)
              lac = pmp - 1.5*dq(i-2)
              IF (0. .LT. pmp) THEN
                IF (pmp .LT. lac) THEN
                  x34 = lac
                  CALL PUSHCONTROL2B(0)
                ELSE
                  x34 = pmp
                  CALL PUSHCONTROL2B(1)
                END IF
              ELSE IF (0. .LT. lac) THEN
                x34 = lac
                CALL PUSHCONTROL2B(2)
              ELSE
                CALL PUSHCONTROL2B(3)
                x34 = 0.
              END IF
              IF (0. .GT. pmp) THEN
                IF (pmp .GT. lac) THEN
                  y47 = lac
                  CALL PUSHCONTROL2B(0)
                ELSE
                  y47 = pmp
                  CALL PUSHCONTROL2B(1)
                END IF
              ELSE IF (0. .GT. lac) THEN
                y47 = lac
                CALL PUSHCONTROL2B(2)
              ELSE
                y47 = 0.
                CALL PUSHCONTROL2B(3)
              END IF
              IF (al(i+1) - q(i, j) .LT. y47) THEN
                y33 = y47
                CALL PUSHCONTROL1B(0)
              ELSE
                y33 = al(i+1) - q(i, j)
                CALL PUSHCONTROL1B(1)
              END IF
              IF (x34 .GT. y33) THEN
                CALL PUSHREALARRAY_ADM(br(i))
                br(i) = y33
                CALL PUSHCONTROL1B(0)
              ELSE
                CALL PUSHREALARRAY_ADM(br(i))
                br(i) = x34
                CALL PUSHCONTROL1B(1)
              END IF
            END DO
            CALL PUSHCONTROL2B(1)
          ELSE
            DO i=is-1,ie+1
              CALL PUSHREALARRAY_ADM(bl(i))
              bl(i) = al(i) - q(i, j)
              CALL PUSHREALARRAY_ADM(br(i))
              br(i) = al(i+1) - q(i, j)
            END DO
            CALL PUSHCONTROL2B(2)
          END IF
! Positive definite constraint:
          IF (iord .NE. 11) THEN
            CALL PUSHINTEGER4(arg1)
            arg1 = ilast - ifirst + 3
            CALL PUSHREALARRAY_ADM(br(ifirst-1), 8*(ilast-ifirst+3)/8)
            CALL PUSHREALARRAY_ADM(bl(ifirst-1), 8*(ilast-ifirst+3)/8)
            CALL PERT_PPM(arg1, q(ifirst-1, j), bl(ifirst-1), br(ifirst-&
&                   1), 0)
            CALL PUSHCONTROL3B(1)
          ELSE
            CALL PUSHCONTROL3B(0)
          END IF
        END IF
        DO i=ifirst,ilast+1
          IF (c(i, j) .GT. 0.) THEN
            CALL PUSHCONTROL1B(1)
          ELSE
            CALL PUSHCONTROL1B(0)
          END IF
        END DO
      END DO
      dq_ad = 0.0_FVPRC
      al_ad = 0.0_FVPRC
      dm1_ad = 0.0_FVPRC
      bl_ad = 0.0_FVPRC
      br_ad = 0.0_FVPRC
      DO j=jlast,jfirst,-1
        DO i=ilast+1,ifirst,-1
          CALL POPCONTROL1B(branch)
          IF (branch .EQ. 0) THEN
            temp_ad37 = (c(i, j)+1.)*flux_ad(i, j)
            temp_ad38 = c(i, j)*temp_ad37
            q_ad(i, j) = q_ad(i, j) + flux_ad(i, j)
            c_ad(i, j) = c_ad(i, j) + (bl(i)+br(i))*temp_ad37 + (bl(i)+c&
&             (i, j)*(bl(i)+br(i)))*flux_ad(i, j)
            bl_ad(i) = bl_ad(i) + temp_ad38 + temp_ad37
            br_ad(i) = br_ad(i) + temp_ad38
            flux_ad(i, j) = 0.0_FVPRC
          ELSE
            temp4 = bl(i-1) + br(i-1)
            temp_ad35 = (1.-c(i, j))*flux_ad(i, j)
            temp_ad36 = -(c(i, j)*temp_ad35)
            q_ad(i-1, j) = q_ad(i-1, j) + flux_ad(i, j)
            c_ad(i, j) = c_ad(i, j) - temp4*temp_ad35 - (br(i-1)-c(i, j)&
&             *temp4)*flux_ad(i, j)
            br_ad(i-1) = br_ad(i-1) + temp_ad36 + temp_ad35
            bl_ad(i-1) = bl_ad(i-1) + temp_ad36
            flux_ad(i, j) = 0.0_FVPRC
          END IF
        END DO
        CALL POPCONTROL3B(branch)
        IF (branch .LT. 2) THEN
          IF (branch .NE. 0) THEN
            arg1 = ilast - ifirst + 3
            CALL POPREALARRAY_ADM(bl(ifirst-1), 8*(ilast-ifirst+3)/8)
            CALL POPREALARRAY_ADM(br(ifirst-1), 8*(ilast-ifirst+3)/8)
            CALL PERT_PPM_ADM(arg1, q(ifirst-1, j), bl(ifirst-1:), bl_ad&
&                       (ifirst-1:), br(ifirst-1:), br_ad(ifirst-1:), 0)
            CALL POPINTEGER4(arg1)
          END IF
          CALL POPCONTROL2B(branch)
          IF (branch .EQ. 0) THEN
            DO i=ilast+1,ifirst-1,-1
              CALL POPREALARRAY_ADM(br(i))
              min19_ad = SIGN(1.d0, min19*xt)*br_ad(i)
              br_ad(i) = 0.0_FVPRC
              CALL POPCONTROL1B(branch)
              IF (branch .EQ. 0) THEN
                CALL POPREALARRAY_ADM(min19)
                y31_ad = min19_ad
                x32_ad = 0.0_FVPRC
              ELSE
                CALL POPREALARRAY_ADM(min19)
                x32_ad = min19_ad
                y31_ad = 0.0_FVPRC
              END IF
              CALL POPCONTROL1B(branch)
              IF (branch .EQ. 0) THEN
                al_ad(i+1) = al_ad(i+1) + y31_ad
                q_ad(i, j) = q_ad(i, j) - y31_ad
              ELSE
                q_ad(i, j) = q_ad(i, j) + y31_ad
                al_ad(i+1) = al_ad(i+1) - y31_ad
              END IF
              CALL POPCONTROL1B(branch)
              IF (branch .EQ. 0) THEN
                xt_ad = x32_ad
              ELSE
                xt_ad = -x32_ad
              END IF
              CALL POPREALARRAY_ADM(bl(i))
              min18_ad = -(SIGN(1.d0, min18*xt)*bl_ad(i))
              bl_ad(i) = 0.0_FVPRC
              CALL POPCONTROL1B(branch)
              IF (branch .EQ. 0) THEN
                CALL POPREALARRAY_ADM(min18)
                y30_ad = min18_ad
                x31_ad = 0.0_FVPRC
              ELSE
                CALL POPREALARRAY_ADM(min18)
                x31_ad = min18_ad
                y30_ad = 0.0_FVPRC
              END IF
              CALL POPCONTROL1B(branch)
              IF (branch .EQ. 0) THEN
                al_ad(i) = al_ad(i) + y30_ad
                q_ad(i, j) = q_ad(i, j) - y30_ad
              ELSE
                q_ad(i, j) = q_ad(i, j) + y30_ad
                al_ad(i) = al_ad(i) - y30_ad
              END IF
              CALL POPCONTROL1B(branch)
              IF (branch .EQ. 0) THEN
                xt_ad = xt_ad + x31_ad
              ELSE
                xt_ad = xt_ad - x31_ad
              END IF
              CALL POPREALARRAY_ADM(xt)
              dm1_ad(i) = dm1_ad(i) + 2.*xt_ad
            END DO
          ELSE IF (branch .EQ. 1) THEN
            DO i=ilast+1,ifirst-1,-1
              CALL POPCONTROL1B(branch)
              IF (branch .EQ. 0) THEN
                CALL POPREALARRAY_ADM(br(i))
                y33_ad = br_ad(i)
                br_ad(i) = 0.0_FVPRC
                x34_ad = 0.0_FVPRC
              ELSE
                CALL POPREALARRAY_ADM(br(i))
                x34_ad = br_ad(i)
                br_ad(i) = 0.0_FVPRC
                y33_ad = 0.0_FVPRC
              END IF
              CALL POPCONTROL1B(branch)
              IF (branch .EQ. 0) THEN
                y47_ad = y33_ad
              ELSE
                al_ad(i+1) = al_ad(i+1) + y33_ad
                q_ad(i, j) = q_ad(i, j) - y33_ad
                y47_ad = 0.0_FVPRC
              END IF
              CALL POPCONTROL2B(branch)
              IF (branch .LT. 2) THEN
                IF (branch .EQ. 0) THEN
                  lac_ad = y47_ad
                  pmp_ad = 0.0_FVPRC
                ELSE
                  pmp_ad = y47_ad
                  lac_ad = 0.0_FVPRC
                END IF
              ELSE
                IF (branch .EQ. 2) THEN
                  lac_ad = y47_ad
                ELSE
                  lac_ad = 0.0_FVPRC
                END IF
                pmp_ad = 0.0_FVPRC
              END IF
              CALL POPCONTROL2B(branch)
              IF (branch .LT. 2) THEN
                IF (branch .EQ. 0) THEN
                  lac_ad = lac_ad + x34_ad
                ELSE
                  pmp_ad = pmp_ad + x34_ad
                END IF
              ELSE IF (branch .EQ. 2) THEN
                lac_ad = lac_ad + x34_ad
              END IF
              pmp_ad = pmp_ad + lac_ad
              dq_ad(i-2) = dq_ad(i-2) - 1.5*lac_ad
              dq_ad(i-1) = dq_ad(i-1) + 2.*pmp_ad
              CALL POPCONTROL1B(branch)
              IF (branch .EQ. 0) THEN
                CALL POPREALARRAY_ADM(bl(i))
                y32_ad = bl_ad(i)
                bl_ad(i) = 0.0_FVPRC
                x33_ad = 0.0_FVPRC
              ELSE
                CALL POPREALARRAY_ADM(bl(i))
                x33_ad = bl_ad(i)
                bl_ad(i) = 0.0_FVPRC
                y32_ad = 0.0_FVPRC
              END IF
              CALL POPCONTROL1B(branch)
              IF (branch .EQ. 0) THEN
                y46_ad = y32_ad
              ELSE
                al_ad(i) = al_ad(i) + y32_ad
                q_ad(i, j) = q_ad(i, j) - y32_ad
                y46_ad = 0.0_FVPRC
              END IF
              CALL POPCONTROL2B(branch)
              IF (branch .LT. 2) THEN
                IF (branch .EQ. 0) THEN
                  lac_ad = y46_ad
                  pmp_ad = 0.0_FVPRC
                ELSE
                  pmp_ad = y46_ad
                  lac_ad = 0.0_FVPRC
                END IF
              ELSE
                IF (branch .EQ. 2) THEN
                  lac_ad = y46_ad
                ELSE
                  lac_ad = 0.0_FVPRC
                END IF
                pmp_ad = 0.0_FVPRC
              END IF
              CALL POPCONTROL2B(branch)
              IF (branch .LT. 2) THEN
                IF (branch .EQ. 0) THEN
                  lac_ad = lac_ad + x33_ad
                ELSE
                  pmp_ad = pmp_ad + x33_ad
                END IF
              ELSE IF (branch .EQ. 2) THEN
                lac_ad = lac_ad + x33_ad
              END IF
              pmp_ad = pmp_ad + lac_ad
              dq_ad(i+1) = dq_ad(i+1) + 1.5*lac_ad
              dq_ad(i) = dq_ad(i) - 2.*pmp_ad
            END DO
            DO i=ilast+2,ifirst-3,-1
              q_ad(i+1, j) = q_ad(i+1, j) + dq_ad(i)
              q_ad(i, j) = q_ad(i, j) - dq_ad(i)
              dq_ad(i) = 0.0_FVPRC
            END DO
          ELSE
            DO i=ie+1,is-1,-1
              CALL POPREALARRAY_ADM(br(i))
              al_ad(i+1) = al_ad(i+1) + br_ad(i)
              q_ad(i, j) = q_ad(i, j) - bl_ad(i) - br_ad(i)
              br_ad(i) = 0.0_FVPRC
              CALL POPREALARRAY_ADM(bl(i))
              al_ad(i) = al_ad(i) + bl_ad(i)
              bl_ad(i) = 0.0_FVPRC
            END DO
          END IF
          DO i=ilast+2,ifirst-1,-1
            q_ad(i-1, j) = q_ad(i-1, j) + 0.5*al_ad(i)
            q_ad(i, j) = q_ad(i, j) + 0.5*al_ad(i)
            dm1_ad(i-1) = dm1_ad(i-1) + r3*al_ad(i)
            dm1_ad(i) = dm1_ad(i) - r3*al_ad(i)
            al_ad(i) = 0.0_FVPRC
          END DO
        ELSE
          IF (branch .NE. 2) THEN
            IF (branch .EQ. 3) THEN
              CALL POPREALARRAY_ADM(bl(npx-2), 8*(ilast-npx+4)/8)
              CALL POPREALARRAY_ADM(br(npx-2), 8*(ilast-npx+4)/8)
              CALL PERT_PPM_ADM(3, q(npx-2, j), bl(npx-2:), bl_ad(npx-2:&
&                         ), br(npx-2:), br_ad(npx-2:), 1)
              CALL POPREALARRAY_ADM(bl(npx-1))
              xt_ad = br_ad(npx-2) + bl_ad(npx-1)
              q_ad(npx-1, j) = q_ad(npx-1, j) - bl_ad(npx-1)
              bl_ad(npx-1) = 0.0_FVPRC
              CALL POPREALARRAY_ADM(br(npx-2))
              q_ad(npx-2, j) = q_ad(npx-2, j) - br_ad(npx-2)
              br_ad(npx-2) = 0.0_FVPRC
              CALL POPCONTROL1B(branch)
              IF (branch .NE. 0) xt_ad = 0.0_FVPRC
              q_ad(npx-1, j) = q_ad(npx-1, j) + 3.*xt_ad/14.
              q_ad(npx-2, j) = q_ad(npx-2, j) + 11.*xt_ad/14.
              dm1_ad(npx-2) = dm1_ad(npx-2) + 4.*xt_ad/7.
              CALL POPREALARRAY_ADM(br(npx))
              xt_ad = br_ad(npx)
              q_ad(npx, j) = q_ad(npx, j) - br_ad(npx)
              br_ad(npx) = 0.0_FVPRC
              CALL POPCONTROL1B(branch)
              IF (branch .NE. 0) xt_ad = 0.0_FVPRC
              q_ad(npx+1, j) = q_ad(npx+1, j) + 11.*xt_ad/14.
              q_ad(npx, j) = q_ad(npx, j) + 3.*xt_ad/14. - bl_ad(npx)
              dm1_ad(npx+1) = dm1_ad(npx+1) - 4.*xt_ad/7.
              CALL POPREALARRAY_ADM(bl(npx))
              xt_ad = br_ad(npx-1) + bl_ad(npx)
              bl_ad(npx) = 0.0_FVPRC
              CALL POPREALARRAY_ADM(br(npx-1))
              q_ad(npx-1, j) = q_ad(npx-1, j) - br_ad(npx-1)
              br_ad(npx-1) = 0.0_FVPRC
              CALL POPCONTROL1B(branch)
              IF (branch .NE. 0) xt_ad = 0.0_FVPRC
              CALL POPREALARRAY_ADM(xt)
              x0l_ad = xt_ad
              x0r_ad = xt_ad
              CALL POPREALARRAY_ADM(bl(npx-2))
              al_ad(npx-2) = al_ad(npx-2) + bl_ad(npx-2)
              q_ad(npx-2, j) = q_ad(npx-2, j) - bl_ad(npx-2)
              bl_ad(npx-2) = 0.0_FVPRC
              temp_ad33 = 0.5*x0r_ad/(dxa(npx, j)+dxa(npx+1, j))
              q_ad(npx, j) = q_ad(npx, j) + (dxa(npx, j)*2.+dxa(npx+1, j&
&               ))*temp_ad33
              q_ad(npx+1, j) = q_ad(npx+1, j) - dxa(npx, j)*temp_ad33
              temp_ad34 = 0.5*x0l_ad/(dxa(npx-1, j)+dxa(npx-2, j))
              q_ad(npx-1, j) = q_ad(npx-1, j) + (dxa(npx-1, j)*2.+dxa(&
&               npx-2, j))*temp_ad34
              q_ad(npx-2, j) = q_ad(npx-2, j) - dxa(npx-1, j)*temp_ad34
            ELSE
              GOTO 140
            END IF
          END IF
          CALL POPCONTROL1B(branch)
          IF (branch .EQ. 0) THEN
            CALL POPREALARRAY_ADM(bl(0), 8*(ilast+2)/8)
            CALL POPREALARRAY_ADM(br(0), 8*(ilast+2)/8)
            CALL PERT_PPM_ADM(3, q(0, j), bl(0:), bl_ad(0:), br(0:), &
&                       br_ad(0:), 1)
            CALL POPREALARRAY_ADM(bl(2))
            xt_ad = br_ad(1) + bl_ad(2)
            q_ad(2, j) = q_ad(2, j) - bl_ad(2)
            bl_ad(2) = 0.0_FVPRC
            CALL POPREALARRAY_ADM(br(1))
            q_ad(1, j) = q_ad(1, j) - br_ad(1)
            br_ad(1) = 0.0_FVPRC
            CALL POPCONTROL1B(branch)
            IF (branch .NE. 0) xt_ad = 0.0_FVPRC
            q_ad(1, j) = q_ad(1, j) + 3.*xt_ad/14.
            q_ad(2, j) = q_ad(2, j) + 11.*xt_ad/14.
            dm1_ad(2) = dm1_ad(2) - 4.*xt_ad/7.
            CALL POPREALARRAY_ADM(bl(0))
            xt_ad = bl_ad(0)
            q_ad(0, j) = q_ad(0, j) - bl_ad(0)
            bl_ad(0) = 0.0_FVPRC
            CALL POPCONTROL1B(branch)
            IF (branch .NE. 0) xt_ad = 0.0_FVPRC
            dm1_ad(-1) = dm1_ad(-1) + 4.*xt_ad/7.
            q_ad(-1, j) = q_ad(-1, j) + 11.*xt_ad/14.
            q_ad(0, j) = q_ad(0, j) + 3.*xt_ad/14. - br_ad(0)
            CALL POPREALARRAY_ADM(br(0))
            xt_ad = bl_ad(1) + br_ad(0)
            br_ad(0) = 0.0_FVPRC
            CALL POPREALARRAY_ADM(bl(1))
            q_ad(1, j) = q_ad(1, j) - bl_ad(1)
            bl_ad(1) = 0.0_FVPRC
            CALL POPCONTROL1B(branch)
            IF (branch .NE. 0) xt_ad = 0.0_FVPRC
            CALL POPREALARRAY_ADM(xt)
            x0l_ad = xt_ad
            x0r_ad = xt_ad
            CALL POPREALARRAY_ADM(br(2))
            al_ad(3) = al_ad(3) + br_ad(2)
            q_ad(2, j) = q_ad(2, j) - br_ad(2)
            br_ad(2) = 0.0_FVPRC
            temp_ad31 = 0.5*x0r_ad/(dxa(1, j)+dxa(2, j))
            q_ad(1, j) = q_ad(1, j) + (dxa(1, j)*2.+dxa(2, j))*temp_ad31
            q_ad(2, j) = q_ad(2, j) - dxa(1, j)*temp_ad31
            temp_ad32 = 0.5*x0l_ad/(dxa(0, j)+dxa(-1, j))
            q_ad(0, j) = q_ad(0, j) + (dxa(0, j)*2.+dxa(-1, j))*&
&             temp_ad32
            q_ad(-1, j) = q_ad(-1, j) - dxa(0, j)*temp_ad32
          END IF
 140      CALL POPCONTROL1B(branch)
          IF (branch .EQ. 0) THEN
            CALL POPREALARRAY_ADM(bl(is3), 8*(ilast-is3+2)/8)
            CALL POPREALARRAY_ADM(br(is3), 8*(ilast-is3+2)/8)
            CALL PERT_PPM_ADM(arg1, q(is3, j), bl(is3:), bl_ad(is3:), br&
&                       (is3:), br_ad(is3:), 0)
            CALL POPINTEGER4(arg1)
          END IF
          CALL POPCONTROL2B(branch)
          IF (branch .EQ. 0) THEN
            CALL POPINTEGER4(ad_from0)
            CALL POPINTEGER4(ad_to0)
            DO i=ad_to0,ad_from0,-1
              CALL POPREALARRAY_ADM(br(i))
              min17_ad = SIGN(1.d0, min17*xt)*br_ad(i)
              br_ad(i) = 0.0_FVPRC
              CALL POPCONTROL1B(branch)
              IF (branch .EQ. 0) THEN
                CALL POPREALARRAY_ADM(min17)
                y25_ad = min17_ad
                x26_ad = 0.0_FVPRC
              ELSE
                CALL POPREALARRAY_ADM(min17)
                x26_ad = min17_ad
                y25_ad = 0.0_FVPRC
              END IF
              CALL POPCONTROL1B(branch)
              IF (branch .EQ. 0) THEN
                al_ad(i+1) = al_ad(i+1) + y25_ad
                q_ad(i, j) = q_ad(i, j) - y25_ad
              ELSE
                q_ad(i, j) = q_ad(i, j) + y25_ad
                al_ad(i+1) = al_ad(i+1) - y25_ad
              END IF
              CALL POPCONTROL1B(branch)
              IF (branch .EQ. 0) THEN
                xt_ad = x26_ad
              ELSE
                xt_ad = -x26_ad
              END IF
              CALL POPREALARRAY_ADM(bl(i))
              min16_ad = -(SIGN(1.d0, min16*xt)*bl_ad(i))
              bl_ad(i) = 0.0_FVPRC
              CALL POPCONTROL1B(branch)
              IF (branch .EQ. 0) THEN
                CALL POPREALARRAY_ADM(min16)
                y24_ad = min16_ad
                x25_ad = 0.0_FVPRC
              ELSE
                CALL POPREALARRAY_ADM(min16)
                x25_ad = min16_ad
                y24_ad = 0.0_FVPRC
              END IF
              CALL POPCONTROL1B(branch)
              IF (branch .EQ. 0) THEN
                al_ad(i) = al_ad(i) + y24_ad
                q_ad(i, j) = q_ad(i, j) - y24_ad
              ELSE
                q_ad(i, j) = q_ad(i, j) + y24_ad
                al_ad(i) = al_ad(i) - y24_ad
              END IF
              CALL POPCONTROL1B(branch)
              IF (branch .EQ. 0) THEN
                xt_ad = xt_ad + x25_ad
              ELSE
                xt_ad = xt_ad - x25_ad
              END IF
              CALL POPREALARRAY_ADM(xt)
              dm1_ad(i) = dm1_ad(i) + 2.*xt_ad
            END DO
          ELSE IF (branch .EQ. 1) THEN
            CALL POPINTEGER4(ad_from1)
            CALL POPINTEGER4(ad_to1)
            DO i=ad_to1,ad_from1,-1
              CALL POPCONTROL1B(branch)
              IF (branch .EQ. 0) THEN
                CALL POPREALARRAY_ADM(br(i))
                y27_ad = br_ad(i)
                br_ad(i) = 0.0_FVPRC
                x28_ad = 0.0_FVPRC
              ELSE
                CALL POPREALARRAY_ADM(br(i))
                x28_ad = br_ad(i)
                br_ad(i) = 0.0_FVPRC
                y27_ad = 0.0_FVPRC
              END IF
              CALL POPCONTROL1B(branch)
              IF (branch .EQ. 0) THEN
                y43_ad = y27_ad
              ELSE
                al_ad(i+1) = al_ad(i+1) + y27_ad
                q_ad(i, j) = q_ad(i, j) - y27_ad
                y43_ad = 0.0_FVPRC
              END IF
              CALL POPCONTROL2B(branch)
              IF (branch .LT. 2) THEN
                IF (branch .EQ. 0) THEN
                  lac_ad = y43_ad
                  pmp_ad = 0.0_FVPRC
                ELSE
                  pmp_ad = y43_ad
                  lac_ad = 0.0_FVPRC
                END IF
              ELSE
                IF (branch .EQ. 2) THEN
                  lac_ad = y43_ad
                ELSE
                  lac_ad = 0.0_FVPRC
                END IF
                pmp_ad = 0.0_FVPRC
              END IF
              CALL POPCONTROL2B(branch)
              IF (branch .LT. 2) THEN
                IF (branch .EQ. 0) THEN
                  lac_ad = lac_ad + x28_ad
                ELSE
                  pmp_ad = pmp_ad + x28_ad
                END IF
              ELSE IF (branch .EQ. 2) THEN
                lac_ad = lac_ad + x28_ad
              END IF
              pmp_ad = pmp_ad + lac_ad
              dq_ad(i-2) = dq_ad(i-2) - 1.5*lac_ad
              dq_ad(i-1) = dq_ad(i-1) + 2.*pmp_ad
              CALL POPCONTROL1B(branch)
              IF (branch .EQ. 0) THEN
                CALL POPREALARRAY_ADM(bl(i))
                y26_ad = bl_ad(i)
                bl_ad(i) = 0.0_FVPRC
                x27_ad = 0.0_FVPRC
              ELSE
                CALL POPREALARRAY_ADM(bl(i))
                x27_ad = bl_ad(i)
                bl_ad(i) = 0.0_FVPRC
                y26_ad = 0.0_FVPRC
              END IF
              CALL POPCONTROL1B(branch)
              IF (branch .EQ. 0) THEN
                y42_ad = y26_ad
              ELSE
                al_ad(i) = al_ad(i) + y26_ad
                q_ad(i, j) = q_ad(i, j) - y26_ad
                y42_ad = 0.0_FVPRC
              END IF
              CALL POPCONTROL2B(branch)
              IF (branch .LT. 2) THEN
                IF (branch .EQ. 0) THEN
                  lac_ad = y42_ad
                  pmp_ad = 0.0_FVPRC
                ELSE
                  pmp_ad = y42_ad
                  lac_ad = 0.0_FVPRC
                END IF
              ELSE
                IF (branch .EQ. 2) THEN
                  lac_ad = y42_ad
                ELSE
                  lac_ad = 0.0_FVPRC
                END IF
                pmp_ad = 0.0_FVPRC
              END IF
              CALL POPCONTROL2B(branch)
              IF (branch .LT. 2) THEN
                IF (branch .EQ. 0) THEN
                  lac_ad = lac_ad + x27_ad
                ELSE
                  pmp_ad = pmp_ad + x27_ad
                END IF
              ELSE IF (branch .EQ. 2) THEN
                lac_ad = lac_ad + x27_ad
              END IF
              pmp_ad = pmp_ad + lac_ad
              dq_ad(i+1) = dq_ad(i+1) + 1.5*lac_ad
              dq_ad(i) = dq_ad(i) - 2.*pmp_ad
            END DO
            DO i=ie+2,is-3,-1
              q_ad(i+1, j) = q_ad(i+1, j) + dq_ad(i)
              q_ad(i, j) = q_ad(i, j) - dq_ad(i)
              dq_ad(i) = 0.0_FVPRC
            END DO
          ELSE
            CALL POPINTEGER4(ad_from2)
            CALL POPINTEGER4(ad_to2)
            DO 160 i=ad_to2,ad_from2,-1
              CALL POPCONTROL2B(branch)
              IF (branch .LT. 2) THEN
                IF (branch .EQ. 0) THEN
                  GOTO 150
                ELSE
                  y29_ad = br_ad(i)
                  br_ad(i) = 0.0_FVPRC
                  x30_ad = 0.0_FVPRC
                END IF
              ELSE IF (branch .EQ. 2) THEN
                x30_ad = br_ad(i)
                br_ad(i) = 0.0_FVPRC
                y29_ad = 0.0_FVPRC
              ELSE
                CALL POPREALARRAY_ADM(br(i))
                br_ad(i) = 0.0_FVPRC
                CALL POPREALARRAY_ADM(bl(i))
                bl_ad(i) = 0.0_FVPRC
                GOTO 160
              END IF
              CALL POPCONTROL1B(branch)
              IF (branch .EQ. 0) THEN
                y45_ad = y29_ad
              ELSE
                br_ad(i) = br_ad(i) + y29_ad
                y45_ad = 0.0_FVPRC
              END IF
              CALL POPCONTROL2B(branch)
              IF (branch .LT. 2) THEN
                IF (branch .EQ. 0) THEN
                  lac_2_ad = y45_ad
                  pmp_2_ad = 0.0_FVPRC
                ELSE
                  pmp_2_ad = y45_ad
                  lac_2_ad = 0.0_FVPRC
                END IF
              ELSE
                IF (branch .EQ. 2) THEN
                  lac_2_ad = y45_ad
                ELSE
                  lac_2_ad = 0.0_FVPRC
                END IF
                pmp_2_ad = 0.0_FVPRC
              END IF
              CALL POPCONTROL2B(branch)
              IF (branch .LT. 2) THEN
                IF (branch .EQ. 0) THEN
                  lac_2_ad = lac_2_ad + x30_ad
                ELSE
                  pmp_2_ad = pmp_2_ad + x30_ad
                END IF
              ELSE IF (branch .EQ. 2) THEN
                lac_2_ad = lac_2_ad + x30_ad
              END IF
              pmp_2_ad = pmp_2_ad + lac_2_ad
              dq_ad(i-2) = dq_ad(i-2) - 1.5*lac_2_ad
              dq_ad(i-1) = dq_ad(i-1) + 2*pmp_2_ad
              CALL POPCONTROL1B(branch)
              IF (branch .EQ. 0) THEN
                y28_ad = bl_ad(i)
                bl_ad(i) = 0.0_FVPRC
                x29_ad = 0.0_FVPRC
              ELSE
                x29_ad = bl_ad(i)
                bl_ad(i) = 0.0_FVPRC
                y28_ad = 0.0_FVPRC
              END IF
              CALL POPCONTROL1B(branch)
              IF (branch .EQ. 0) THEN
                y44_ad = y28_ad
              ELSE
                bl_ad(i) = bl_ad(i) + y28_ad
                y44_ad = 0.0_FVPRC
              END IF
              CALL POPCONTROL2B(branch)
              IF (branch .LT. 2) THEN
                IF (branch .EQ. 0) THEN
                  lac_1_ad = y44_ad
                  pmp_1_ad = 0.0_FVPRC
                ELSE
                  pmp_1_ad = y44_ad
                  lac_1_ad = 0.0_FVPRC
                END IF
              ELSE
                IF (branch .EQ. 2) THEN
                  lac_1_ad = y44_ad
                ELSE
                  lac_1_ad = 0.0_FVPRC
                END IF
                pmp_1_ad = 0.0_FVPRC
              END IF
              CALL POPCONTROL2B(branch)
              IF (branch .LT. 2) THEN
                IF (branch .EQ. 0) THEN
                  lac_1_ad = lac_1_ad + x29_ad
                ELSE
                  pmp_1_ad = pmp_1_ad + x29_ad
                END IF
              ELSE IF (branch .EQ. 2) THEN
                lac_1_ad = lac_1_ad + x29_ad
              END IF
              pmp_1_ad = pmp_1_ad + lac_1_ad
              dq_ad(i+1) = dq_ad(i+1) + 1.5*lac_1_ad
              dq_ad(i) = dq_ad(i) - 2*pmp_1_ad
 150          CALL POPREALARRAY_ADM(br(i))
              al_ad(i+1) = al_ad(i+1) + br_ad(i)
              q_ad(i, j) = q_ad(i, j) - bl_ad(i) - br_ad(i)
              br_ad(i) = 0.0_FVPRC
              CALL POPREALARRAY_ADM(bl(i))
              al_ad(i) = al_ad(i) + bl_ad(i)
              bl_ad(i) = 0.0_FVPRC
 160        CONTINUE
            DO i=ie+2,is-3,-1
              q_ad(i+1, j) = q_ad(i+1, j) + dq_ad(i)
              q_ad(i, j) = q_ad(i, j) - dq_ad(i)
              dq_ad(i) = 0.0_FVPRC
            END DO
          END IF
          CALL POPINTEGER4(ad_from)
          CALL POPINTEGER4(ad_to)
          DO i=ad_to,ad_from,-1
            q_ad(i-1, j) = q_ad(i-1, j) + 0.5*al_ad(i)
            q_ad(i, j) = q_ad(i, j) + 0.5*al_ad(i)
            dm1_ad(i-1) = dm1_ad(i-1) + r3*al_ad(i)
            dm1_ad(i) = dm1_ad(i) - r3*al_ad(i)
            al_ad(i) = 0.0_FVPRC
          END DO
          CALL POPCONTROL1B(branch)
          IF (branch .EQ. 0) THEN
            CALL POPCONTROL1B(branch)
            IF (branch .EQ. 0) THEN
              CALL POPINTEGER4(is3)
            ELSE
              CALL POPINTEGER4(is3)
            END IF
          ELSE
            CALL POPINTEGER4(is3)
          END IF
        END IF
        DO i=ie+2,is-2,-1
          xt = 0.25*(q(i+1, j)-q(i-1, j))
          min15_ad = SIGN(1.d0, min15*xt)*dm1_ad(i)
          dm1_ad(i) = 0.0_FVPRC
          CALL POPCONTROL2B(branch)
          IF (branch .LT. 2) THEN
            IF (branch .EQ. 0) THEN
              CALL POPREALARRAY_ADM(min15)
              z9_ad = min15_ad
              y23_ad = 0.0_FVPRC
            ELSE
              CALL POPREALARRAY_ADM(min15)
              y23_ad = min15_ad
              z9_ad = 0.0_FVPRC
            END IF
            x24_ad = 0.0_FVPRC
          ELSE
            IF (branch .EQ. 2) THEN
              CALL POPREALARRAY_ADM(min15)
              z9_ad = min15_ad
              x24_ad = 0.0_FVPRC
            ELSE
              CALL POPREALARRAY_ADM(min15)
              x24_ad = min15_ad
              z9_ad = 0.0_FVPRC
            END IF
            y23_ad = 0.0_FVPRC
          END IF
          q_ad(i, j) = q_ad(i, j) + z9_ad
          min28_ad = -z9_ad
          CALL POPCONTROL2B(branch)
          IF (branch .LT. 2) THEN
            IF (branch .EQ. 0) THEN
              q_ad(i+1, j) = q_ad(i+1, j) + min28_ad
            ELSE
              q_ad(i, j) = q_ad(i, j) + min28_ad
            END IF
          ELSE IF (branch .EQ. 2) THEN
            q_ad(i+1, j) = q_ad(i+1, j) + min28_ad
          ELSE
            q_ad(i-1, j) = q_ad(i-1, j) + min28_ad
          END IF
          max9_ad = y23_ad
          q_ad(i, j) = q_ad(i, j) - y23_ad
          CALL POPCONTROL2B(branch)
          IF (branch .LT. 2) THEN
            IF (branch .EQ. 0) THEN
              q_ad(i+1, j) = q_ad(i+1, j) + max9_ad
            ELSE
              q_ad(i, j) = q_ad(i, j) + max9_ad
            END IF
          ELSE IF (branch .EQ. 2) THEN
            q_ad(i+1, j) = q_ad(i+1, j) + max9_ad
          ELSE
            q_ad(i-1, j) = q_ad(i-1, j) + max9_ad
          END IF
          CALL POPCONTROL1B(branch)
          IF (branch .EQ. 0) THEN
            xt_ad = x24_ad
          ELSE
            xt_ad = -x24_ad
          END IF
          CALL POPREALARRAY_ADM(xt)
          q_ad(i+1, j) = q_ad(i+1, j) + 0.25*xt_ad
          q_ad(i-1, j) = q_ad(i-1, j) - 0.25*xt_ad
        END DO
      END DO
    END IF
    CALL POPCONTROL1B(branch)
  END SUBROUTINE FXPPM_ADM
  SUBROUTINE FXPPM(c, q, flux, iord, ifirst, ilast, jfirst, jlast, npx, &
&   npy, bd, dxa, nested, grid_type)
    IMPLICIT NONE
! !INPUT PARAMETERS:
    TYPE(FV_GRID_BOUNDS_TYPE), INTENT(IN) :: bd
!  X-Dir strip
    INTEGER, INTENT(IN) :: ifirst, ilast
!  Y-Dir strip
    INTEGER, INTENT(IN) :: jfirst, jlast
    INTEGER, INTENT(IN) :: iord
    INTEGER, INTENT(IN) :: npx, npy
    REAL(fvprc), INTENT(IN) :: q(ifirst-ng:ilast+ng, jfirst:jlast)
! Courant   N (like FLUX)
    REAL(fvprc), INTENT(IN) :: c(ifirst:ilast+1, jfirst:jlast)
    REAL(fvprc), INTENT(IN) :: dxa(bd%isd:bd%ied, bd%jsd:bd%jed)
    LOGICAL, INTENT(IN) :: nested
    INTEGER, INTENT(IN) :: grid_type
! !OUTPUT PARAMETERS:
!  Flux
    REAL(fvprc), INTENT(OUT) :: flux(ifirst:ilast+1, jfirst:jlast)
! Local
    LOGICAL :: extm(ifirst-2:ilast+2)
    REAL(fvprc) :: dm1(ifirst-2:ilast+2)
    REAL(fvprc) :: al(ifirst-1:ilast+2)
    REAL(fvprc) :: bl(ifirst-1:ilast+1)
    REAL(fvprc) :: br(ifirst-1:ilast+1)
    REAL(fvprc) :: dq(ifirst-3:ilast+2)
    REAL(fvprc) :: dl, dr, pmp, lac, ct, qe
    REAL(fvprc) :: pmp_1, lac_1, pmp_2, lac_2
    REAL(fvprc) :: xt, x1, x0, x0l, x0r
    INTEGER :: i, j, is3, ie3, it
    REAL(fvprc) :: bl6(ifirst-1:ilast+1, jfirst:jlast)
    REAL(fvprc) :: br6(ifirst-1:ilast+1, jfirst:jlast)
    INTEGER :: is, ie, js, je, isd, ied, jsd, jed
    INTRINSIC MAX
    INTRINSIC MIN
    INTRINSIC ABS
    INTRINSIC SIGN
    REAL(fvprc) :: min1
    REAL(fvprc) :: min2
    REAL(fvprc) :: min3
    REAL(fvprc) :: min4
    REAL(fvprc) :: min5
    REAL(fvprc) :: min6
    REAL(fvprc) :: min7
    REAL(fvprc) :: min8
    REAL(fvprc) :: min9
    REAL(fvprc) :: min10
    REAL(fvprc) :: min11
    REAL(fvprc) :: min12
    REAL(fvprc) :: min13
    REAL(fvprc) :: abs0
    REAL(fvprc) :: abs1
    REAL(fvprc) :: min14
    REAL(fvprc) :: min15
    REAL(fvprc) :: min16
    REAL(fvprc) :: min17
    REAL(fvprc) :: abs2
    REAL(fvprc) :: abs3
    REAL(fvprc) :: min18
    REAL(fvprc) :: min19
    REAL(fvprc) :: max1
    REAL(fvprc) :: min20
    REAL(fvprc) :: max2
    REAL(fvprc) :: min21
    REAL(fvprc) :: max3
    REAL(fvprc) :: min22
    REAL(fvprc) :: max4
    REAL(fvprc) :: min23
    REAL(fvprc) :: max5
    REAL(fvprc) :: min24
    REAL(fvprc) :: max6
    REAL(fvprc) :: min25
    REAL(fvprc) :: max7
    REAL(fvprc) :: min26
    REAL(fvprc) :: abs4
    REAL(fvprc) :: abs5
    REAL(fvprc) :: max8
    REAL(fvprc) :: min27
    REAL(fvprc) :: max9
    REAL(fvprc) :: min28
    REAL(fvprc) :: abs6
    REAL(fvprc) :: abs7
    REAL(fvprc) :: abs8
    REAL(fvprc) :: abs9
    INTEGER :: arg1
    REAL(fvprc) :: x19
    REAL(fvprc) :: x18
    REAL(fvprc) :: x17
    REAL(fvprc) :: x16
    REAL(fvprc) :: x15
    REAL(fvprc) :: x14
    REAL(fvprc) :: x13
    REAL(fvprc) :: x12
    REAL(fvprc) :: x11
    REAL(fvprc) :: y29
    REAL(fvprc) :: x10
    REAL(fvprc) :: y28
    REAL(fvprc) :: y27
    REAL(fvprc) :: y26
    REAL(fvprc) :: y25
    REAL(fvprc) :: y24
    REAL(fvprc) :: y23
    REAL(fvprc) :: y22
    REAL(fvprc) :: y21
    REAL(fvprc) :: y20
    REAL(fvprc) :: x9
    REAL(fvprc) :: x8
    REAL(fvprc) :: x7
    REAL(fvprc) :: x6
    REAL(fvprc) :: x5
    REAL(fvprc) :: x4
    REAL(fvprc) :: x3
    REAL(fvprc) :: x2
    REAL(fvprc) :: y19
    REAL(fvprc) :: y18
    REAL(fvprc) :: y17
    REAL(fvprc) :: y16
    REAL(fvprc) :: y15
    REAL(fvprc) :: x34
    REAL(fvprc) :: y14
    REAL(fvprc) :: x33
    REAL(fvprc) :: y13
    REAL(fvprc) :: x32
    REAL(fvprc) :: y12
    REAL(fvprc) :: x31
    REAL(fvprc) :: y11
    REAL(fvprc) :: x30
    REAL(fvprc) :: y10
    REAL(fvprc) :: y47
    REAL(fvprc) :: y46
    REAL(fvprc) :: y45
    REAL(fvprc) :: y44
    REAL(fvprc) :: y43
    REAL(fvprc) :: y42
    REAL(fvprc) :: y41
    REAL(fvprc) :: y40
    REAL(fvprc) :: z9
    REAL(fvprc) :: z8
    REAL(fvprc) :: z7
    REAL(fvprc) :: z6
    REAL(fvprc) :: z5
    REAL(fvprc) :: z4
    REAL(fvprc) :: z3
    REAL(fvprc) :: z2
    REAL(fvprc) :: z1
    REAL(fvprc) :: x29
    REAL(fvprc) :: x28
    REAL(fvprc) :: x27
    REAL(fvprc) :: x26
    REAL(fvprc) :: x25
    REAL(fvprc) :: x24
    REAL(fvprc) :: x23
    REAL(fvprc) :: x22
    REAL(fvprc) :: x21
    REAL(fvprc) :: y39
    REAL(fvprc) :: x20
    REAL(fvprc) :: y38
    REAL(fvprc) :: y37
    REAL(fvprc) :: y36
    REAL(fvprc) :: y35
    REAL(fvprc) :: y34
    REAL(fvprc) :: y33
    REAL(fvprc) :: y32
    REAL(fvprc) :: y31
    REAL(fvprc) :: y30
    REAL(fvprc) :: y9
    REAL(fvprc) :: y8
    REAL(fvprc) :: y7
    REAL(fvprc) :: y6
    REAL(fvprc) :: y5
    REAL(fvprc) :: y4
    REAL(fvprc) :: y3
    REAL(fvprc) :: y2
    REAL(fvprc) :: y1
    is = bd%is
    ie = bd%ie
    js = bd%js
    je = bd%je
    isd = bd%isd
    ied = bd%ied
    jsd = bd%jsd
    jed = bd%jed
    x0 = big_number
    IF (nested) THEN
      is3 = is - 1
      ie3 = ie + 1
    ELSE
      IF (3 .LT. is - 1) THEN
        is3 = is - 1
      ELSE
        is3 = 3
      END IF
      IF (npx - 3 .GT. ie + 1) THEN
        ie3 = ie + 1
      ELSE
        ie3 = npx - 3
      END IF
    END IF
    IF (iord .LE. 4) THEN
      DO j=jfirst,jlast
        DO i=is-2,ie+2
          xt = 0.25*(q(i+1, j)-q(i-1, j))
          IF (xt .GE. 0.) THEN
            x2 = xt
          ELSE
            x2 = -xt
          END IF
          IF (q(i-1, j) .LT. q(i, j)) THEN
            IF (q(i, j) .LT. q(i+1, j)) THEN
              max1 = q(i+1, j)
            ELSE
              max1 = q(i, j)
            END IF
          ELSE IF (q(i-1, j) .LT. q(i+1, j)) THEN
            max1 = q(i+1, j)
          ELSE
            max1 = q(i-1, j)
          END IF
          y1 = max1 - q(i, j)
          IF (q(i-1, j) .GT. q(i, j)) THEN
            IF (q(i, j) .GT. q(i+1, j)) THEN
              min20 = q(i+1, j)
            ELSE
              min20 = q(i, j)
            END IF
          ELSE IF (q(i-1, j) .GT. q(i+1, j)) THEN
            min20 = q(i+1, j)
          ELSE
            min20 = q(i-1, j)
          END IF
          z1 = q(i, j) - min20
          IF (x2 .GT. y1) THEN
            IF (y1 .GT. z1) THEN
              min1 = z1
            ELSE
              min1 = y1
            END IF
          ELSE IF (x2 .GT. z1) THEN
            min1 = z1
          ELSE
            min1 = x2
          END IF
          dm1(i) = SIGN(min1, xt)
        END DO
        IF (grid_type .LT. 3) THEN
          DO i=is3,ie3+1
!        do i=max(3,is-1),min(npx-2,ie+2)
            al(i) = 0.5*(q(i-1, j)+q(i, j)) + r3*(dm1(i-1)-dm1(i))
          END DO
!.not. nested
! Fix the edges:
          IF (.NOT.nested) THEN
            IF (is .EQ. 1) THEN
              x0l = 0.5*((2.*dxa(0, j)+dxa(-1, j))*q(0, j)-dxa(0, j)*q(-&
&               1, j))/(dxa(0, j)+dxa(-1, j))
              x0r = 0.5*((2.*dxa(1, j)+dxa(2, j))*q(1, j)-dxa(1, j)*q(2&
&               , j))/(dxa(1, j)+dxa(2, j))
              x0 = x0l + x0r
              al(1) = x0
              x1 = s15*q(0, j) + s11*q(-1, j) + s14*dm1(-1)
              dm1(0) = 0.5*(x0-x1)
              IF (dm1(0) .GE. 0.) THEN
                x3 = dm1(0)
              ELSE
                x3 = -dm1(0)
              END IF
              IF (q(0, j) .LT. x0) THEN
                IF (x0 .LT. x1) THEN
                  max2 = x1
                ELSE
                  max2 = x0
                END IF
              ELSE IF (q(0, j) .LT. x1) THEN
                max2 = x1
              ELSE
                max2 = q(0, j)
              END IF
              y2 = max2 - q(0, j)
              IF (q(0, j) .GT. x0) THEN
                IF (x0 .GT. x1) THEN
                  min21 = x1
                ELSE
                  min21 = x0
                END IF
              ELSE IF (q(0, j) .GT. x1) THEN
                min21 = x1
              ELSE
                min21 = q(0, j)
              END IF
              z2 = q(0, j) - min21
              IF (x3 .GT. y2) THEN
                IF (y2 .GT. z2) THEN
                  min2 = z2
                ELSE
                  min2 = y2
                END IF
              ELSE IF (x3 .GT. z2) THEN
                min2 = z2
              ELSE
                min2 = x3
              END IF
              dm1(0) = SIGN(min2, dm1(0))
              al(0) = 0.5*(q(-1, j)+q(0, j)) + r3*(dm1(-1)-dm1(0))
!
              x1 = s15*q(1, j) + s11*q(2, j) - s14*dm1(2)
              dm1(1) = 0.5*(x1-x0)
              IF (dm1(1) .GE. 0.) THEN
                x4 = dm1(1)
              ELSE
                x4 = -dm1(1)
              END IF
              IF (q(1, j) .LT. x0) THEN
                IF (x0 .LT. x1) THEN
                  max3 = x1
                ELSE
                  max3 = x0
                END IF
              ELSE IF (q(1, j) .LT. x1) THEN
                max3 = x1
              ELSE
                max3 = q(1, j)
              END IF
              y3 = max3 - q(1, j)
              IF (q(1, j) .GT. x0) THEN
                IF (x0 .GT. x1) THEN
                  min22 = x1
                ELSE
                  min22 = x0
                END IF
              ELSE IF (q(1, j) .GT. x1) THEN
                min22 = x1
              ELSE
                min22 = q(1, j)
              END IF
              z3 = q(1, j) - min22
              IF (x4 .GT. y3) THEN
                IF (y3 .GT. z3) THEN
                  min3 = z3
                ELSE
                  min3 = y3
                END IF
              ELSE IF (x4 .GT. z3) THEN
                min3 = z3
              ELSE
                min3 = x4
              END IF
              dm1(1) = SIGN(min3, dm1(1))
              al(2) = 0.5*(q(1, j)+q(2, j)) + r3*(dm1(1)-dm1(2))
            END IF
            IF (ie + 1 .EQ. npx) THEN
              x0l = 0.5*((2.*dxa(npx-1, j)+dxa(npx-2, j))*q(npx-1, j)-&
&               dxa(npx-1, j)*q(npx-2, j))/(dxa(npx-1, j)+dxa(npx-2, j))
              x0r = 0.5*((2.*dxa(npx, j)+dxa(npx+1, j))*q(npx, j)-dxa(&
&               npx, j)*q(npx+1, j))/(dxa(npx, j)+dxa(npx+1, j))
              x0 = x0l + x0r
              al(npx) = x0
              x1 = s15*q(npx-1, j) + s11*q(npx-2, j) + s14*dm1(npx-2)
              dm1(npx-1) = 0.5*(x0-x1)
              IF (dm1(npx-1) .GE. 0.) THEN
                x5 = dm1(npx-1)
              ELSE
                x5 = -dm1(npx-1)
              END IF
              IF (q(npx-1, j) .LT. x0) THEN
                IF (x0 .LT. x1) THEN
                  max4 = x1
                ELSE
                  max4 = x0
                END IF
              ELSE IF (q(npx-1, j) .LT. x1) THEN
                max4 = x1
              ELSE
                max4 = q(npx-1, j)
              END IF
              y4 = max4 - q(npx-1, j)
              IF (q(npx-1, j) .GT. x0) THEN
                IF (x0 .GT. x1) THEN
                  min23 = x1
                ELSE
                  min23 = x0
                END IF
              ELSE IF (q(npx-1, j) .GT. x1) THEN
                min23 = x1
              ELSE
                min23 = q(npx-1, j)
              END IF
              z4 = q(npx-1, j) - min23
              IF (x5 .GT. y4) THEN
                IF (y4 .GT. z4) THEN
                  min4 = z4
                ELSE
                  min4 = y4
                END IF
              ELSE IF (x5 .GT. z4) THEN
                min4 = z4
              ELSE
                min4 = x5
              END IF
              dm1(npx-1) = SIGN(min4, dm1(npx-1))
              al(npx-1) = 0.5*(q(npx-2, j)+q(npx-1, j)) + r3*(dm1(npx-2)&
&               -dm1(npx-1))
!
              x1 = s15*q(npx, j) + s11*q(npx+1, j) - s14*dm1(npx+1)
              dm1(npx) = 0.5*(x1-x0)
              IF (dm1(npx) .GE. 0.) THEN
                x6 = dm1(npx)
              ELSE
                x6 = -dm1(npx)
              END IF
              IF (q(npx, j) .LT. x0) THEN
                IF (x0 .LT. x1) THEN
                  max5 = x1
                ELSE
                  max5 = x0
                END IF
              ELSE IF (q(npx, j) .LT. x1) THEN
                max5 = x1
              ELSE
                max5 = q(npx, j)
              END IF
              y5 = max5 - q(npx, j)
              IF (q(npx, j) .GT. x0) THEN
                IF (x0 .GT. x1) THEN
                  min24 = x1
                ELSE
                  min24 = x0
                END IF
              ELSE IF (q(npx, j) .GT. x1) THEN
                min24 = x1
              ELSE
                min24 = q(npx, j)
              END IF
              z5 = q(npx, j) - min24
              IF (x6 .GT. y5) THEN
                IF (y5 .GT. z5) THEN
                  min5 = z5
                ELSE
                  min5 = y5
                END IF
              ELSE IF (x6 .GT. z5) THEN
                min5 = z5
              ELSE
                min5 = x6
              END IF
              dm1(npx) = SIGN(min5, dm1(npx))
              al(npx+1) = 0.5*(q(npx, j)+q(npx+1, j)) + r3*(dm1(npx)-dm1&
&               (npx+1))
            END IF
          END IF
        ELSE
! For doubly periodic BC
          DO i=is-1,ie+2
            al(i) = 0.5*(q(i-1, j)+q(i, j)) + r3*(dm1(i-1)-dm1(i))
          END DO
        END IF
        IF (iord .EQ. 3) THEN
          DO i=is-1,ie+1
            bl(i) = al(i) - q(i, j)
            br(i) = al(i+1) - q(i, j)
          END DO
          arg1 = ie - is + 3
          CALL PERT_PPM(arg1, q(is-1, j), bl(is-1), br(is-1), 1)
          DO i=is,ie+1
            IF (c(i, j) .GT. 0.) THEN
              flux(i, j) = q(i-1, j) + (1.-c(i, j))*(br(i-1)-c(i, j)*(bl&
&               (i-1)+br(i-1)))
            ELSE
              flux(i, j) = q(i, j) + (1.+c(i, j))*(bl(i)+c(i, j)*(bl(i)+&
&               br(i)))
            END IF
          END DO
        ELSE
          DO i=is,ie+1
            IF (c(i, j) .GT. 0.) THEN
              xt = ppm_limiter*dm1(i-1)
              IF (xt .GE. 0.) THEN
                x7 = xt
              ELSE
                x7 = -xt
              END IF
              IF (al(i-1) - q(i-1, j) .GE. 0.) THEN
                y6 = al(i-1) - q(i-1, j)
              ELSE
                y6 = -(al(i-1)-q(i-1, j))
              END IF
              IF (x7 .GT. y6) THEN
                min6 = y6
              ELSE
                min6 = x7
              END IF
              dl = SIGN(min6, xt)
              IF (xt .GE. 0.) THEN
                x8 = xt
              ELSE
                x8 = -xt
              END IF
              IF (al(i) - q(i-1, j) .GE. 0.) THEN
                y7 = al(i) - q(i-1, j)
              ELSE
                y7 = -(al(i)-q(i-1, j))
              END IF
              IF (x8 .GT. y7) THEN
                min7 = y7
              ELSE
                min7 = x8
              END IF
              dr = SIGN(min7, xt)
              flux(i, j) = q(i-1, j) + (1.-c(i, j))*(c(i, j)*(dl-dr)+dr)
            ELSE
              xt = ppm_limiter*dm1(i)
              IF (xt .GE. 0.) THEN
                x9 = xt
              ELSE
                x9 = -xt
              END IF
              IF (al(i) - q(i, j) .GE. 0.) THEN
                y8 = al(i) - q(i, j)
              ELSE
                y8 = -(al(i)-q(i, j))
              END IF
              IF (x9 .GT. y8) THEN
                min8 = y8
              ELSE
                min8 = x9
              END IF
              dl = SIGN(min8, xt)
              IF (xt .GE. 0.) THEN
                x10 = xt
              ELSE
                x10 = -xt
              END IF
              IF (al(i+1) - q(i, j) .GE. 0.) THEN
                y9 = al(i+1) - q(i, j)
              ELSE
                y9 = -(al(i+1)-q(i, j))
              END IF
              IF (x10 .GT. y9) THEN
                min9 = y9
              ELSE
                min9 = x10
              END IF
              dr = SIGN(min9, xt)
              flux(i, j) = q(i, j) - (1.+c(i, j))*(c(i, j)*(dl-dr)+dl)
            END IF
          END DO
        END IF
      END DO
    ELSE IF (iord .EQ. 5) THEN
! PPM with Hunyh's 2nd constraint
      DO j=jfirst,jlast
        DO i=ifirst-3,ilast+2
          dq(i) = q(i+1, j) - q(i, j)
        END DO
        DO i=ifirst-2,ilast+2
          xt = 0.25*(q(i+1, j)-q(i-1, j))
          IF (xt .GE. 0.) THEN
            x11 = xt
          ELSE
            x11 = -xt
          END IF
          IF (q(i-1, j) .LT. q(i, j)) THEN
            IF (q(i, j) .LT. q(i+1, j)) THEN
              max6 = q(i+1, j)
            ELSE
              max6 = q(i, j)
            END IF
          ELSE IF (q(i-1, j) .LT. q(i+1, j)) THEN
            max6 = q(i+1, j)
          ELSE
            max6 = q(i-1, j)
          END IF
          y10 = max6 - q(i, j)
          IF (q(i-1, j) .GT. q(i, j)) THEN
            IF (q(i, j) .GT. q(i+1, j)) THEN
              min25 = q(i+1, j)
            ELSE
              min25 = q(i, j)
            END IF
          ELSE IF (q(i-1, j) .GT. q(i+1, j)) THEN
            min25 = q(i+1, j)
          ELSE
            min25 = q(i-1, j)
          END IF
          z6 = q(i, j) - min25
          IF (x11 .GT. y10) THEN
            IF (y10 .GT. z6) THEN
              min10 = z6
            ELSE
              min10 = y10
            END IF
          ELSE IF (x11 .GT. z6) THEN
            min10 = z6
          ELSE
            min10 = x11
          END IF
          dm1(i) = SIGN(min10, xt)
        END DO
        DO i=ifirst-1,ilast+2
          al(i) = 0.5*(q(i-1, j)+q(i, j)) + r3*(dm1(i-1)-dm1(i))
        END DO
        DO i=ifirst-1,ilast+1
          pmp_1 = -(2.*dq(i))
          lac_1 = pmp_1 + 1.5*dq(i+1)
          IF (0. .LT. pmp_1) THEN
            IF (pmp_1 .LT. lac_1) THEN
              x12 = lac_1
            ELSE
              x12 = pmp_1
            END IF
          ELSE IF (0. .LT. lac_1) THEN
            x12 = lac_1
          ELSE
            x12 = 0.
          END IF
          IF (0. .GT. pmp_1) THEN
            IF (pmp_1 .GT. lac_1) THEN
              y34 = lac_1
            ELSE
              y34 = pmp_1
            END IF
          ELSE IF (0. .GT. lac_1) THEN
            y34 = lac_1
          ELSE
            y34 = 0.
          END IF
          IF (al(i) - q(i, j) .LT. y34) THEN
            y11 = y34
          ELSE
            y11 = al(i) - q(i, j)
          END IF
          IF (x12 .GT. y11) THEN
            bl(i) = y11
          ELSE
            bl(i) = x12
          END IF
          pmp_2 = 2.*dq(i-1)
          lac_2 = pmp_2 - 1.5*dq(i-2)
          IF (0. .LT. pmp_2) THEN
            IF (pmp_2 .LT. lac_2) THEN
              x13 = lac_2
            ELSE
              x13 = pmp_2
            END IF
          ELSE IF (0. .LT. lac_2) THEN
            x13 = lac_2
          ELSE
            x13 = 0.
          END IF
          IF (0. .GT. pmp_2) THEN
            IF (pmp_2 .GT. lac_2) THEN
              y35 = lac_2
            ELSE
              y35 = pmp_2
            END IF
          ELSE IF (0. .GT. lac_2) THEN
            y35 = lac_2
          ELSE
            y35 = 0.
          END IF
          IF (al(i+1) - q(i, j) .LT. y35) THEN
            y12 = y35
          ELSE
            y12 = al(i+1) - q(i, j)
          END IF
          IF (x13 .GT. y12) THEN
            br(i) = y12
          ELSE
            br(i) = x13
          END IF
        END DO
        DO i=ifirst,ilast+1
          IF (c(i, j) .GT. 0.) THEN
            flux(i, j) = q(i-1, j) + (1.-c(i, j))*(br(i-1)-c(i, j)*(bl(i&
&             -1)+br(i-1)))
          ELSE
            flux(i, j) = q(i, j) + (1.+c(i, j))*(bl(i)+c(i, j)*(bl(i)+br&
&             (i)))
          END IF
        END DO
      END DO
    ELSE IF (iord .EQ. 6 .OR. iord .EQ. 7) THEN
!do j=jfirst,jlast
      IF (iord .EQ. 6) THEN
!#ifdef UN_PPM
!        do i=ifirst-1,ilast+2
!           al(i) = p1*(q(i-1,j)+q(i,j)) + p2*(q(i-2,j)+q(i+1,j))
!        enddo
!        do i=is3, ie3
!           bl6(i,j) = al(i)   - q(i,j)
!           br6(i) = al(i+1) - q(i,j)
!        enddo
!#else
        DO j=jfirst,jlast
          DO i=is3,ie3
            bl6(i, j) = b5*q(i-2, j) + b4*q(i-1, j) + b3*q(i, j) + b2*q(&
&             i+1, j) + b1*q(i+2, j)
            br6(i, j) = b1*q(i-2, j) + b2*q(i-1, j) + b3*q(i, j) + b4*q(&
&             i+1, j) + b5*q(i+2, j)
          END DO
        END DO
      ELSE
!#endif
        DO j=jfirst,jlast
          DO i=is-3,ie+2
            dq(i) = q(i+1, j) - q(i, j)
          END DO
          DO i=is-2,ie+2
            IF (dq(i-1)*dq(i) .GT. 0.) THEN
              extm(i) = .false.
            ELSE
              extm(i) = .true.
            END IF
          END DO
          DO i=is3,ie3
!            if ( extm(i) .and. (extm(i-1) .or. extm(i+1)) ) then
            IF (extm(i-1) .AND. extm(i) .AND. extm(i+1)) THEN
! 2-delta-wave filter:
              bl6(i, j) = 0.
              br6(i, j) = 0.
            ELSE
              bl6(i, j) = b5*q(i-2, j) + b4*q(i-1, j) + b3*q(i, j) + b2*&
&               q(i+1, j) + b1*q(i+2, j)
              br6(i, j) = b1*q(i-2, j) + b2*q(i-1, j) + b3*q(i, j) + b4*&
&               q(i+1, j) + b5*q(i+2, j)
            END IF
          END DO
        END DO
      END IF
!--------------
! fix the edges
!--------------
      DO j=jfirst,jlast
        IF (.NOT.nested) THEN
          IF (is .EQ. 1) THEN
            x0l = 0.5*((2.*dxa(0, j)+dxa(-1, j))*q(0, j)-dxa(0, j)*q(-1&
&             , j))/(dxa(0, j)+dxa(-1, j))
            x0r = 0.5*((2.*dxa(1, j)+dxa(2, j))*q(1, j)-dxa(1, j)*q(2, j&
&             ))/(dxa(1, j)+dxa(2, j))
            br6(2, j) = p1*(q(2, j)+q(3, j)) + p2*(q(1, j)+q(4, j)) - q(&
&             2, j)
            xt = x0l + x0r
            bl6(1, j) = xt - q(1, j)
            br6(0, j) = xt - q(0, j)
            xt = c1*q(-2, j) + c2*q(-1, j) + c3*q(0, j)
!#ifdef DO_MONO_EDGE
!             xt = max( xt, min(q(-1,j),q(0,j)) )
!             xt = min( xt, max(q(-1,j),q(0,j)) )
!#endif
            bl6(0, j) = xt - q(0, j)
            xt = c3*q(1, j) + c2*q(2, j) + c1*q(3, j)
!#ifdef DO_MONO_EDGE
!             xt = max( xt, min(q(1,j),q(2,j)) )
!             xt = min( xt, max(q(1,j),q(2,j)) )
!#endif
            br6(1, j) = xt - q(1, j)
            bl6(2, j) = xt - q(2, j)
          END IF
          IF (ie + 1 .EQ. npx) THEN
            x0l = 0.5*((2.*dxa(npx-1, j)+dxa(npx-2, j))*q(npx-1, j)-dxa(&
&             npx-1, j)*q(npx-2, j))/(dxa(npx-1, j)+dxa(npx-2, j))
            x0r = 0.5*((2.*dxa(npx, j)+dxa(npx+1, j))*q(npx, j)-dxa(npx&
&             , j)*q(npx+1, j))/(dxa(npx, j)+dxa(npx+1, j))
            bl6(npx-2, j) = p1*(q(npx-2, j)+q(npx-3, j)) + p2*(q(npx-4, &
&             j)+q(npx-1, j)) - q(npx-2, j)
!             xt = x0L*gridstruct%sin_sg(npx-1,j,3) + x0R*gridstruct%sin_sg(npx,j,1)
!             xt = 2.*xt / (gridstruct%sin_sg(npx,j,1) + gridstruct%sin_sg(npx-1,j,3))
            xt = x0l + x0r
            br6(npx-1, j) = xt - q(npx-1, j)
            bl6(npx, j) = xt - q(npx, j)
            xt = c3*q(npx, j) + c2*q(npx+1, j) + c1*q(npx+2, j)
!#ifdef DO_MONO_EDGE
!             xt = max( xt, min(q(npx,j),q(npx+1,j)) )
!             xt = min( xt, max(q(npx,j),q(npx+1,j)) )
!#endif
            br6(npx, j) = xt - q(npx, j)
            xt = c1*q(npx-3, j) + c2*q(npx-2, j) + c3*q(npx-1, j)
!#ifdef DO_MONO_EDGE
!             xt = max( xt, min(q(npx-2,j),q(npx-1,j)) )
!             xt = min( xt, max(q(npx-2,j),q(npx-1,j)) )
!#endif
            br6(npx-2, j) = xt - q(npx-2, j)
            bl6(npx-1, j) = xt - q(npx-1, j)
          END IF
        END IF
! Positive definite constraint:
        IF (iord .EQ. 7) THEN
          arg1 = ilast - ifirst + 3
          CALL PERT_PPM(arg1, q(ifirst-1, j), bl6(ifirst-1, j), br6(&
&                 ifirst-1, j), 0)
        END IF
      END DO
      DO j=jfirst,jlast
        DO i=ifirst,ilast+1
          IF (c(i, j) .GT. 0.) THEN
            flux(i, j) = q(i-1, j) + (1.-c(i, j))*(br6(i-1, j)-c(i, j)*(&
&             bl6(i-1, j)+br6(i-1, j)))
          ELSE
            flux(i, j) = q(i, j) + (1.+c(i, j))*(bl6(i, j)+c(i, j)*(bl6(&
&             i, j)+br6(i, j)))
          END IF
        END DO
      END DO
    ELSE IF (iord .LE. 10) THEN
! iord=8, 9, 10
      DO j=jfirst,jlast
! grid_type check
        IF (grid_type .LT. 3) THEN
          DO i=is-3,ie+2
            dq(i) = q(i+1, j) - q(i, j)
          END DO
          DO i=is-2,ie+2
            xt = 0.25*(q(i+1, j)-q(i-1, j))
            IF (xt .GE. 0.) THEN
              x14 = xt
            ELSE
              x14 = -xt
            END IF
            IF (q(i-1, j) .LT. q(i, j)) THEN
              IF (q(i, j) .LT. q(i+1, j)) THEN
                max7 = q(i+1, j)
              ELSE
                max7 = q(i, j)
              END IF
            ELSE IF (q(i-1, j) .LT. q(i+1, j)) THEN
              max7 = q(i+1, j)
            ELSE
              max7 = q(i-1, j)
            END IF
            y13 = max7 - q(i, j)
            IF (q(i-1, j) .GT. q(i, j)) THEN
              IF (q(i, j) .GT. q(i+1, j)) THEN
                min26 = q(i+1, j)
              ELSE
                min26 = q(i, j)
              END IF
            ELSE IF (q(i-1, j) .GT. q(i+1, j)) THEN
              min26 = q(i+1, j)
            ELSE
              min26 = q(i-1, j)
            END IF
            z7 = q(i, j) - min26
            IF (x14 .GT. y13) THEN
              IF (y13 .GT. z7) THEN
                min11 = z7
              ELSE
                min11 = y13
              END IF
            ELSE IF (x14 .GT. z7) THEN
              min11 = z7
            ELSE
              min11 = x14
            END IF
            dm1(i) = SIGN(min11, xt)
          END DO
!        do i=is3,min(npx-2,ie+2)
          DO i=is3,ie3+1
            al(i) = 0.5*(q(i-1, j)+q(i, j)) + r3*(dm1(i-1)-dm1(i))
          END DO
          IF (iord .EQ. 8) THEN
            DO i=is3,ie3
              xt = 2.*dm1(i)
              IF (xt .GE. 0.) THEN
                x15 = xt
              ELSE
                x15 = -xt
              END IF
              IF (al(i) - q(i, j) .GE. 0.) THEN
                y14 = al(i) - q(i, j)
              ELSE
                y14 = -(al(i)-q(i, j))
              END IF
              IF (x15 .GT. y14) THEN
                min12 = y14
              ELSE
                min12 = x15
              END IF
              bl(i) = -SIGN(min12, xt)
              IF (xt .GE. 0.) THEN
                x16 = xt
              ELSE
                x16 = -xt
              END IF
              IF (al(i+1) - q(i, j) .GE. 0.) THEN
                y15 = al(i+1) - q(i, j)
              ELSE
                y15 = -(al(i+1)-q(i, j))
              END IF
              IF (x16 .GT. y15) THEN
                min13 = y15
              ELSE
                min13 = x16
              END IF
              br(i) = SIGN(min13, xt)
            END DO
          ELSE IF (iord .EQ. 9) THEN
            DO i=is3,ie3
              pmp_1 = -(2.*dq(i))
              lac_1 = pmp_1 + 1.5*dq(i+1)
              IF (0. .LT. pmp_1) THEN
                IF (pmp_1 .LT. lac_1) THEN
                  x17 = lac_1
                ELSE
                  x17 = pmp_1
                END IF
              ELSE IF (0. .LT. lac_1) THEN
                x17 = lac_1
              ELSE
                x17 = 0.
              END IF
              IF (0. .GT. pmp_1) THEN
                IF (pmp_1 .GT. lac_1) THEN
                  y36 = lac_1
                ELSE
                  y36 = pmp_1
                END IF
              ELSE IF (0. .GT. lac_1) THEN
                y36 = lac_1
              ELSE
                y36 = 0.
              END IF
              IF (al(i) - q(i, j) .LT. y36) THEN
                y16 = y36
              ELSE
                y16 = al(i) - q(i, j)
              END IF
              IF (x17 .GT. y16) THEN
                bl(i) = y16
              ELSE
                bl(i) = x17
              END IF
              pmp_2 = 2.*dq(i-1)
              lac_2 = pmp_2 - 1.5*dq(i-2)
              IF (0. .LT. pmp_2) THEN
                IF (pmp_2 .LT. lac_2) THEN
                  x18 = lac_2
                ELSE
                  x18 = pmp_2
                END IF
              ELSE IF (0. .LT. lac_2) THEN
                x18 = lac_2
              ELSE
                x18 = 0.
              END IF
              IF (0. .GT. pmp_2) THEN
                IF (pmp_2 .GT. lac_2) THEN
                  y37 = lac_2
                ELSE
                  y37 = pmp_2
                END IF
              ELSE IF (0. .GT. lac_2) THEN
                y37 = lac_2
              ELSE
                y37 = 0.
              END IF
              IF (al(i+1) - q(i, j) .LT. y37) THEN
                y17 = y37
              ELSE
                y17 = al(i+1) - q(i, j)
              END IF
              IF (x18 .GT. y17) THEN
                br(i) = y17
              ELSE
                br(i) = x18
              END IF
            END DO
          ELSE
! iord=10
            DO i=is3,ie3
              bl(i) = al(i) - q(i, j)
              br(i) = al(i+1) - q(i, j)
              IF (dm1(i-1) .GE. 0.) THEN
                abs0 = dm1(i-1)
              ELSE
                abs0 = -dm1(i-1)
              END IF
              IF (dm1(i) .GE. 0.) THEN
                abs4 = dm1(i)
              ELSE
                abs4 = -dm1(i)
              END IF
              IF (dm1(i+1) .GE. 0.) THEN
                abs8 = dm1(i+1)
              ELSE
                abs8 = -dm1(i+1)
              END IF
              IF (abs0 + abs4 + abs8 .LT. near_zero) THEN
                bl(i) = 0.
                br(i) = 0.
              ELSE
                IF (3.*(bl(i)+br(i)) .GE. 0.) THEN
                  abs1 = 3.*(bl(i)+br(i))
                ELSE
                  abs1 = -(3.*(bl(i)+br(i)))
                END IF
                IF (bl(i) - br(i) .GE. 0.) THEN
                  abs5 = bl(i) - br(i)
                ELSE
                  abs5 = -(bl(i)-br(i))
                END IF
                IF (abs1 .GT. abs5) THEN
                  pmp_1 = -(dq(i)+dq(i))
                  lac_1 = pmp_1 + 1.5*dq(i+1)
                  IF (0. .LT. pmp_1) THEN
                    IF (pmp_1 .LT. lac_1) THEN
                      x19 = lac_1
                    ELSE
                      x19 = pmp_1
                    END IF
                  ELSE IF (0. .LT. lac_1) THEN
                    x19 = lac_1
                  ELSE
                    x19 = 0.
                  END IF
                  IF (0. .GT. pmp_1) THEN
                    IF (pmp_1 .GT. lac_1) THEN
                      y38 = lac_1
                    ELSE
                      y38 = pmp_1
                    END IF
                  ELSE IF (0. .GT. lac_1) THEN
                    y38 = lac_1
                  ELSE
                    y38 = 0.
                  END IF
                  IF (bl(i) .LT. y38) THEN
                    y18 = y38
                  ELSE
                    y18 = bl(i)
                  END IF
                  IF (x19 .GT. y18) THEN
                    bl(i) = y18
                  ELSE
                    bl(i) = x19
                  END IF
                  pmp_2 = dq(i-1) + dq(i-1)
                  lac_2 = pmp_2 - 1.5*dq(i-2)
                  IF (0. .LT. pmp_2) THEN
                    IF (pmp_2 .LT. lac_2) THEN
                      x20 = lac_2
                    ELSE
                      x20 = pmp_2
                    END IF
                  ELSE IF (0. .LT. lac_2) THEN
                    x20 = lac_2
                  ELSE
                    x20 = 0.
                  END IF
                  IF (0. .GT. pmp_2) THEN
                    IF (pmp_2 .GT. lac_2) THEN
                      y39 = lac_2
                    ELSE
                      y39 = pmp_2
                    END IF
                  ELSE IF (0. .GT. lac_2) THEN
                    y39 = lac_2
                  ELSE
                    y39 = 0.
                  END IF
                  IF (br(i) .LT. y39) THEN
                    y19 = y39
                  ELSE
                    y19 = br(i)
                  END IF
                  IF (x20 .GT. y19) THEN
                    br(i) = y19
                  ELSE
                    br(i) = x20
                  END IF
                END IF
              END IF
            END DO
          END IF
!--------------
! fix the edges
!--------------
          IF (.NOT.nested) THEN
            IF (is .EQ. 1) THEN
              x0l = 0.5*((2.*dxa(0, j)+dxa(-1, j))*q(0, j)-dxa(0, j)*q(-&
&               1, j))/(dxa(0, j)+dxa(-1, j))
              x0r = 0.5*((2.*dxa(1, j)+dxa(2, j))*q(1, j)-dxa(1, j)*q(2&
&               , j))/(dxa(1, j)+dxa(2, j))
              br(2) = al(3) - q(2, j)
              xt = x0l + x0r
!lmh              xt = 0.5*((2.*dxa(1,j)+dxa(2,j))*(q(0,j)+q(1,j))   &
!lmh                 - dxa(1,j)*(q(-1,j)+q(2,j)))/ ( dxa(1,j)+dxa(2,j))
              bl(1) = xt - q(1, j)
              br(0) = xt - q(0, j)
              xt = s14*dm1(-1) - s11*dq(-1) + q(0, j)
!             xt = max( xt, min(q(-1,j),q(0,j)) )
!             xt = min( xt, max(q(-1,j),q(0,j)) )
              bl(0) = xt - q(0, j)
              xt = s15*q(1, j) + s11*q(2, j) - s14*dm1(2)
!             xt = max( xt, min(q(1,j),q(2,j)) )
!             xt = min( xt, max(q(1,j),q(2,j)) )
              br(1) = xt - q(1, j)
              bl(2) = xt - q(2, j)
              CALL PERT_PPM(3, q(0, j), bl(0), br(0), 1)
            END IF
            IF (ie + 1 .EQ. npx) THEN
              bl(npx-2) = al(npx-2) - q(npx-2, j)
              x0l = 0.5*((2.*dxa(npx-1, j)+dxa(npx-2, j))*q(npx-1, j)-&
&               dxa(npx-1, j)*q(npx-2, j))/(dxa(npx-1, j)+dxa(npx-2, j))
              x0r = 0.5*((2.*dxa(npx, j)+dxa(npx+1, j))*q(npx, j)-dxa(&
&               npx, j)*q(npx+1, j))/(dxa(npx, j)+dxa(npx+1, j))
              xt = x0l + x0r
!lmh              xt = 0.5*( (2.*dxa(npx-1,j)+dxa(npx-2,j))*(q(npx-1,j)+q(npx,j))   &
!lmh                 - dxa(npx-1,j)*(q(npx-2,j)+q(npx+1,j)))/( dxa(npx-1,j)+dxa(npx-2,j))
              br(npx-1) = xt - q(npx-1, j)
              bl(npx) = xt - q(npx, j)
              xt = s11*dq(npx) - s14*dm1(npx+1) + q(npx, j)
!             xt = min( xt, max(q(npx,j), q(npx+1,j)) )
!             xt = max( xt, min(q(npx,j), q(npx+1,j)) )
              br(npx) = xt - q(npx, j)
              xt = s15*q(npx-1, j) + s11*q(npx-2, j) + s14*dm1(npx-2)
!             xt = min( xt, max(q(npx-2,j), q(npx-1,j)) )
!             xt = max( xt, min(q(npx-2,j), q(npx-1,j)) )
              br(npx-2) = xt - q(npx-2, j)
              bl(npx-1) = xt - q(npx-1, j)
              CALL PERT_PPM(3, q(npx-2, j), bl(npx-2), br(npx-2), 1)
            END IF
          END IF
        ELSE
!---------------
! grid_type == 4
!---------------
          DO i=ifirst-2,ilast+2
            xt = 0.25*(q(i+1, j)-q(i-1, j))
            IF (xt .GE. 0.) THEN
              x21 = xt
            ELSE
              x21 = -xt
            END IF
            IF (q(i-1, j) .LT. q(i, j)) THEN
              IF (q(i, j) .LT. q(i+1, j)) THEN
                max8 = q(i+1, j)
              ELSE
                max8 = q(i, j)
              END IF
            ELSE IF (q(i-1, j) .LT. q(i+1, j)) THEN
              max8 = q(i+1, j)
            ELSE
              max8 = q(i-1, j)
            END IF
            y20 = max8 - q(i, j)
            IF (q(i-1, j) .GT. q(i, j)) THEN
              IF (q(i, j) .GT. q(i+1, j)) THEN
                min27 = q(i+1, j)
              ELSE
                min27 = q(i, j)
              END IF
            ELSE IF (q(i-1, j) .GT. q(i+1, j)) THEN
              min27 = q(i+1, j)
            ELSE
              min27 = q(i-1, j)
            END IF
            z8 = q(i, j) - min27
            IF (x21 .GT. y20) THEN
              IF (y20 .GT. z8) THEN
                min14 = z8
              ELSE
                min14 = y20
              END IF
            ELSE IF (x21 .GT. z8) THEN
              min14 = z8
            ELSE
              min14 = x21
            END IF
            dm1(i) = SIGN(min14, xt)
          END DO
          DO i=ifirst-1,ilast+2
            al(i) = 0.5*(q(i-1, j)+q(i, j)) + r3*(dm1(i-1)-dm1(i))
          END DO
          DO i=ifirst-3,ilast+2
            dq(i) = q(i+1, j) - q(i, j)
          END DO
          DO i=ifirst-1,ilast+1
            pmp = -(2.*dq(i))
            lac = pmp + 1.5*dq(i+1)
            IF (0. .LT. pmp) THEN
              IF (pmp .LT. lac) THEN
                x22 = lac
              ELSE
                x22 = pmp
              END IF
            ELSE IF (0. .LT. lac) THEN
              x22 = lac
            ELSE
              x22 = 0.
            END IF
            IF (0. .GT. pmp) THEN
              IF (pmp .GT. lac) THEN
                y40 = lac
              ELSE
                y40 = pmp
              END IF
            ELSE IF (0. .GT. lac) THEN
              y40 = lac
            ELSE
              y40 = 0.
            END IF
            IF (al(i) - q(i, j) .LT. y40) THEN
              y21 = y40
            ELSE
              y21 = al(i) - q(i, j)
            END IF
            IF (x22 .GT. y21) THEN
              bl(i) = y21
            ELSE
              bl(i) = x22
            END IF
            pmp = 2.*dq(i-1)
            lac = pmp - 1.5*dq(i-2)
            IF (0. .LT. pmp) THEN
              IF (pmp .LT. lac) THEN
                x23 = lac
              ELSE
                x23 = pmp
              END IF
            ELSE IF (0. .LT. lac) THEN
              x23 = lac
            ELSE
              x23 = 0.
            END IF
            IF (0. .GT. pmp) THEN
              IF (pmp .GT. lac) THEN
                y41 = lac
              ELSE
                y41 = pmp
              END IF
            ELSE IF (0. .GT. lac) THEN
              y41 = lac
            ELSE
              y41 = 0.
            END IF
            IF (al(i+1) - q(i, j) .LT. y41) THEN
              y22 = y41
            ELSE
              y22 = al(i+1) - q(i, j)
            END IF
            IF (x23 .GT. y22) THEN
              br(i) = y22
            ELSE
              br(i) = x23
            END IF
          END DO
        END IF
        DO i=ifirst,ilast+1
          IF (c(i, j) .GT. 0.) THEN
            flux(i, j) = q(i-1, j) + (1.-c(i, j))*(br(i-1)-c(i, j)*(bl(i&
&             -1)+br(i-1)))
          ELSE
            flux(i, j) = q(i, j) + (1.+c(i, j))*(bl(i)+c(i, j)*(bl(i)+br&
&             (i)))
          END IF
        END DO
      END DO
    ELSE
!------------------------------
! For positive definite tracers:
!------------------------------
! iord=11: PPM mono constraint (Lin 2004)
! iord=12: Huynh 2nd constraint (Lin 2004) + positive definite (Lin & Rood 1996)
! iord>12: positive definite
      DO j=jfirst,jlast
        DO i=is-2,ie+2
          xt = 0.25*(q(i+1, j)-q(i-1, j))
          IF (xt .GE. 0.) THEN
            x24 = xt
          ELSE
            x24 = -xt
          END IF
          IF (q(i-1, j) .LT. q(i, j)) THEN
            IF (q(i, j) .LT. q(i+1, j)) THEN
              max9 = q(i+1, j)
            ELSE
              max9 = q(i, j)
            END IF
          ELSE IF (q(i-1, j) .LT. q(i+1, j)) THEN
            max9 = q(i+1, j)
          ELSE
            max9 = q(i-1, j)
          END IF
          y23 = max9 - q(i, j)
          IF (q(i-1, j) .GT. q(i, j)) THEN
            IF (q(i, j) .GT. q(i+1, j)) THEN
              min28 = q(i+1, j)
            ELSE
              min28 = q(i, j)
            END IF
          ELSE IF (q(i-1, j) .GT. q(i+1, j)) THEN
            min28 = q(i+1, j)
          ELSE
            min28 = q(i-1, j)
          END IF
          z9 = q(i, j) - min28
          IF (x24 .GT. y23) THEN
            IF (y23 .GT. z9) THEN
              min15 = z9
            ELSE
              min15 = y23
            END IF
          ELSE IF (x24 .GT. z9) THEN
            min15 = z9
          ELSE
            min15 = x24
          END IF
          dm1(i) = SIGN(min15, xt)
        END DO
        IF (grid_type .LT. 3) THEN
          IF (nested .AND. iord .NE. 14) THEN
            is3 = is - 1
            ie3 = ie + 1
          ELSE
            IF (3 .LT. is - 1) THEN
              is3 = is - 1
            ELSE
              is3 = 3
            END IF
            IF (npx - 3 .GT. ie + 1) THEN
              ie3 = ie + 1
            ELSE
              ie3 = npx - 3
            END IF
          END IF
!             do i=is3,min(npx-2,ie+2)
          DO i=is3,ie3+1
            al(i) = 0.5*(q(i-1, j)+q(i, j)) + r3*(dm1(i-1)-dm1(i))
          END DO
          IF (iord .EQ. 11) THEN
            DO i=is3,ie3
              xt = 2.*dm1(i)
              IF (xt .GE. 0.) THEN
                x25 = xt
              ELSE
                x25 = -xt
              END IF
              IF (al(i) - q(i, j) .GE. 0.) THEN
                y24 = al(i) - q(i, j)
              ELSE
                y24 = -(al(i)-q(i, j))
              END IF
              IF (x25 .GT. y24) THEN
                min16 = y24
              ELSE
                min16 = x25
              END IF
              bl(i) = -SIGN(min16, xt)
              IF (xt .GE. 0.) THEN
                x26 = xt
              ELSE
                x26 = -xt
              END IF
              IF (al(i+1) - q(i, j) .GE. 0.) THEN
                y25 = al(i+1) - q(i, j)
              ELSE
                y25 = -(al(i+1)-q(i, j))
              END IF
              IF (x26 .GT. y25) THEN
                min17 = y25
              ELSE
                min17 = x26
              END IF
              br(i) = SIGN(min17, xt)
            END DO
          ELSE IF (iord .EQ. 12) THEN
            DO i=is-3,ie+2
              dq(i) = q(i+1, j) - q(i, j)
            END DO
            DO i=is3,ie3
              pmp = -(2.*dq(i))
              lac = pmp + 1.5*dq(i+1)
              IF (0. .LT. pmp) THEN
                IF (pmp .LT. lac) THEN
                  x27 = lac
                ELSE
                  x27 = pmp
                END IF
              ELSE IF (0. .LT. lac) THEN
                x27 = lac
              ELSE
                x27 = 0.
              END IF
              IF (0. .GT. pmp) THEN
                IF (pmp .GT. lac) THEN
                  y42 = lac
                ELSE
                  y42 = pmp
                END IF
              ELSE IF (0. .GT. lac) THEN
                y42 = lac
              ELSE
                y42 = 0.
              END IF
              IF (al(i) - q(i, j) .LT. y42) THEN
                y26 = y42
              ELSE
                y26 = al(i) - q(i, j)
              END IF
              IF (x27 .GT. y26) THEN
                bl(i) = y26
              ELSE
                bl(i) = x27
              END IF
              pmp = 2.*dq(i-1)
              lac = pmp - 1.5*dq(i-2)
              IF (0. .LT. pmp) THEN
                IF (pmp .LT. lac) THEN
                  x28 = lac
                ELSE
                  x28 = pmp
                END IF
              ELSE IF (0. .LT. lac) THEN
                x28 = lac
              ELSE
                x28 = 0.
              END IF
              IF (0. .GT. pmp) THEN
                IF (pmp .GT. lac) THEN
                  y43 = lac
                ELSE
                  y43 = pmp
                END IF
              ELSE IF (0. .GT. lac) THEN
                y43 = lac
              ELSE
                y43 = 0.
              END IF
              IF (al(i+1) - q(i, j) .LT. y43) THEN
                y27 = y43
              ELSE
                y27 = al(i+1) - q(i, j)
              END IF
              IF (x28 .GT. y27) THEN
                br(i) = y27
              ELSE
                br(i) = x28
              END IF
            END DO
          ELSE
            DO i=is-3,ie+2
              dq(i) = q(i+1, j) - q(i, j)
            END DO
            DO i=is3,ie3
              IF (dm1(i-1) .GE. 0.) THEN
                abs2 = dm1(i-1)
              ELSE
                abs2 = -dm1(i-1)
              END IF
              IF (dm1(i) .GE. 0.) THEN
                abs6 = dm1(i)
              ELSE
                abs6 = -dm1(i)
              END IF
              IF (dm1(i+1) .GE. 0.) THEN
                abs9 = dm1(i+1)
              ELSE
                abs9 = -dm1(i+1)
              END IF
              IF (abs2 + abs6 + abs9 .LT. near_zero) THEN
                bl(i) = 0.
                br(i) = 0.
              ELSE
                bl(i) = al(i) - q(i, j)
                br(i) = al(i+1) - q(i, j)
                IF (3.*(bl(i)+br(i)) .GE. 0.) THEN
                  abs3 = 3.*(bl(i)+br(i))
                ELSE
                  abs3 = -(3.*(bl(i)+br(i)))
                END IF
                IF (bl(i) - br(i) .GE. 0.) THEN
                  abs7 = bl(i) - br(i)
                ELSE
                  abs7 = -(bl(i)-br(i))
                END IF
                IF (abs3 .GT. abs7) THEN
                  pmp_1 = -(dq(i)+dq(i))
                  lac_1 = pmp_1 + 1.5*dq(i+1)
                  IF (0. .LT. pmp_1) THEN
                    IF (pmp_1 .LT. lac_1) THEN
                      x29 = lac_1
                    ELSE
                      x29 = pmp_1
                    END IF
                  ELSE IF (0. .LT. lac_1) THEN
                    x29 = lac_1
                  ELSE
                    x29 = 0.
                  END IF
                  IF (0. .GT. pmp_1) THEN
                    IF (pmp_1 .GT. lac_1) THEN
                      y44 = lac_1
                    ELSE
                      y44 = pmp_1
                    END IF
                  ELSE IF (0. .GT. lac_1) THEN
                    y44 = lac_1
                  ELSE
                    y44 = 0.
                  END IF
                  IF (bl(i) .LT. y44) THEN
                    y28 = y44
                  ELSE
                    y28 = bl(i)
                  END IF
                  IF (x29 .GT. y28) THEN
                    bl(i) = y28
                  ELSE
                    bl(i) = x29
                  END IF
                  pmp_2 = dq(i-1) + dq(i-1)
                  lac_2 = pmp_2 - 1.5*dq(i-2)
                  IF (0. .LT. pmp_2) THEN
                    IF (pmp_2 .LT. lac_2) THEN
                      x30 = lac_2
                    ELSE
                      x30 = pmp_2
                    END IF
                  ELSE IF (0. .LT. lac_2) THEN
                    x30 = lac_2
                  ELSE
                    x30 = 0.
                  END IF
                  IF (0. .GT. pmp_2) THEN
                    IF (pmp_2 .GT. lac_2) THEN
                      y45 = lac_2
                    ELSE
                      y45 = pmp_2
                    END IF
                  ELSE IF (0. .GT. lac_2) THEN
                    y45 = lac_2
                  ELSE
                    y45 = 0.
                  END IF
                  IF (br(i) .LT. y45) THEN
                    y29 = y45
                  ELSE
                    y29 = br(i)
                  END IF
                  IF (x30 .GT. y29) THEN
                    br(i) = y29
                  ELSE
                    br(i) = x30
                  END IF
                END IF
              END IF
            END DO
          END IF
! Positive definite constraint:
          IF (iord .NE. 11) THEN
            arg1 = ie3 - is3 + 1
            CALL PERT_PPM(arg1, q(is3, j), bl(is3), br(is3), 0)
          END IF
!--------------
! fix the edges
!--------------
          IF (.NOT.nested) THEN
            IF (is .EQ. 1) THEN
              x0l = 0.5*((2.*dxa(0, j)+dxa(-1, j))*q(0, j)-dxa(0, j)*q(-&
&               1, j))/(dxa(0, j)+dxa(-1, j))
              x0r = 0.5*((2.*dxa(1, j)+dxa(2, j))*q(1, j)-dxa(1, j)*q(2&
&               , j))/(dxa(1, j)+dxa(2, j))
              br(2) = al(3) - q(2, j)
!               xt = t11*(q(0,j)+q(1,j)) + t12*(q(-1,j)+q(2,j)) + t13*(dm1(2)-dm1(-1))
!!!             xt = 0.75*(q(0,j)+q(1,j)) - 0.25*(q(-1,j)+q(2,j))
              xt = x0l + x0r
              IF (0. .LT. xt) THEN
                xt = xt
              ELSE
                xt = 0.
              END IF
              bl(1) = xt - q(1, j)
              br(0) = xt - q(0, j)
              xt = 4./7.*dm1(-1) + 11./14.*q(-1, j) + 3./14.*q(0, j)
              IF (0. .LT. xt) THEN
                xt = xt
              ELSE
                xt = 0.
              END IF
              bl(0) = xt - q(0, j)
              xt = 3./14.*q(1, j) + 11./14.*q(2, j) - 4./7.*dm1(2)
              IF (0. .LT. xt) THEN
                xt = xt
              ELSE
                xt = 0.
              END IF
              br(1) = xt - q(1, j)
              bl(2) = xt - q(2, j)
              CALL PERT_PPM(3, q(0, j), bl(0), br(0), 1)
            END IF
            IF (ie + 1 .EQ. npx) THEN
              x0l = 0.5*((2.*dxa(npx-1, j)+dxa(npx-2, j))*q(npx-1, j)-&
&               dxa(npx-1, j)*q(npx-2, j))/(dxa(npx-1, j)+dxa(npx-2, j))
              x0r = 0.5*((2.*dxa(npx, j)+dxa(npx+1, j))*q(npx, j)-dxa(&
&               npx, j)*q(npx+1, j))/(dxa(npx, j)+dxa(npx+1, j))
              bl(npx-2) = al(npx-2) - q(npx-2, j)
!               xt = t11*(q(npx-1,j)+q(npx,j)) + t12*(q(npx-2,j)+q(npx+1,j))   &
!                  + t13*(dm1(npx+1)-dm1(npx-2))
!!!             xt = 0.75*(q(npx-1,j)+q(npx,j)) - 0.25*(q(npx-2,j)+q(npx+1,j))
              xt = x0l + x0r
              IF (0. .LT. xt) THEN
                xt = xt
              ELSE
                xt = 0.
              END IF
              br(npx-1) = xt - q(npx-1, j)
              bl(npx) = xt - q(npx, j)
!               br(npx) = 11./14.*q(npx+1,j) + 3./14.*q(npx,j) - 4./7.*dm1(npx+1)
              xt = 11./14.*q(npx+1, j) + 3./14.*q(npx, j) - 4./7.*dm1(&
&               npx+1)
              IF (0. .LT. xt) THEN
                xt = xt
              ELSE
                xt = 0.
              END IF
              br(npx) = xt - q(npx, j)
              xt = 3./14.*q(npx-1, j) + 11./14.*q(npx-2, j) + 4./7.*dm1(&
&               npx-2)
              IF (0. .LT. xt) THEN
                xt = xt
              ELSE
                xt = 0.
              END IF
              br(npx-2) = xt - q(npx-2, j)
              bl(npx-1) = xt - q(npx-1, j)
              CALL PERT_PPM(3, q(npx-2, j), bl(npx-2), br(npx-2), 1)
            END IF
          END IF
        ELSE
!--------------
! grid_type >=4
!--------------
          DO i=ifirst-1,ilast+2
            al(i) = 0.5*(q(i-1, j)+q(i, j)) + r3*(dm1(i-1)-dm1(i))
          END DO
          IF (iord .EQ. 11) THEN
            DO i=ifirst-1,ilast+1
              xt = 2.*dm1(i)
              IF (xt .GE. 0.) THEN
                x31 = xt
              ELSE
                x31 = -xt
              END IF
              IF (al(i) - q(i, j) .GE. 0.) THEN
                y30 = al(i) - q(i, j)
              ELSE
                y30 = -(al(i)-q(i, j))
              END IF
              IF (x31 .GT. y30) THEN
                min18 = y30
              ELSE
                min18 = x31
              END IF
              bl(i) = -SIGN(min18, xt)
              IF (xt .GE. 0.) THEN
                x32 = xt
              ELSE
                x32 = -xt
              END IF
              IF (al(i+1) - q(i, j) .GE. 0.) THEN
                y31 = al(i+1) - q(i, j)
              ELSE
                y31 = -(al(i+1)-q(i, j))
              END IF
              IF (x32 .GT. y31) THEN
                min19 = y31
              ELSE
                min19 = x32
              END IF
              br(i) = SIGN(min19, xt)
            END DO
          ELSE IF (iord .EQ. 12) THEN
            DO i=ifirst-3,ilast+2
              dq(i) = q(i+1, j) - q(i, j)
            END DO
            DO i=ifirst-1,ilast+1
              pmp = -(2.*dq(i))
              lac = pmp + 1.5*dq(i+1)
              IF (0. .LT. pmp) THEN
                IF (pmp .LT. lac) THEN
                  x33 = lac
                ELSE
                  x33 = pmp
                END IF
              ELSE IF (0. .LT. lac) THEN
                x33 = lac
              ELSE
                x33 = 0.
              END IF
              IF (0. .GT. pmp) THEN
                IF (pmp .GT. lac) THEN
                  y46 = lac
                ELSE
                  y46 = pmp
                END IF
              ELSE IF (0. .GT. lac) THEN
                y46 = lac
              ELSE
                y46 = 0.
              END IF
              IF (al(i) - q(i, j) .LT. y46) THEN
                y32 = y46
              ELSE
                y32 = al(i) - q(i, j)
              END IF
              IF (x33 .GT. y32) THEN
                bl(i) = y32
              ELSE
                bl(i) = x33
              END IF
              pmp = 2.*dq(i-1)
              lac = pmp - 1.5*dq(i-2)
              IF (0. .LT. pmp) THEN
                IF (pmp .LT. lac) THEN
                  x34 = lac
                ELSE
                  x34 = pmp
                END IF
              ELSE IF (0. .LT. lac) THEN
                x34 = lac
              ELSE
                x34 = 0.
              END IF
              IF (0. .GT. pmp) THEN
                IF (pmp .GT. lac) THEN
                  y47 = lac
                ELSE
                  y47 = pmp
                END IF
              ELSE IF (0. .GT. lac) THEN
                y47 = lac
              ELSE
                y47 = 0.
              END IF
              IF (al(i+1) - q(i, j) .LT. y47) THEN
                y33 = y47
              ELSE
                y33 = al(i+1) - q(i, j)
              END IF
              IF (x34 .GT. y33) THEN
                br(i) = y33
              ELSE
                br(i) = x34
              END IF
            END DO
          ELSE
            DO i=is-1,ie+1
              bl(i) = al(i) - q(i, j)
              br(i) = al(i+1) - q(i, j)
            END DO
          END IF
! Positive definite constraint:
          IF (iord .NE. 11) THEN
            arg1 = ilast - ifirst + 3
            CALL PERT_PPM(arg1, q(ifirst-1, j), bl(ifirst-1), br(ifirst-&
&                   1), 0)
          END IF
        END IF
        DO i=ifirst,ilast+1
          IF (c(i, j) .GT. 0.) THEN
            flux(i, j) = q(i-1, j) + (1.-c(i, j))*(br(i-1)-c(i, j)*(bl(i&
&             -1)+br(i-1)))
          ELSE
            flux(i, j) = q(i, j) + (1.+c(i, j))*(bl(i)+c(i, j)*(bl(i)+br&
&             (i)))
          END IF
        END DO
      END DO
    END IF
  END SUBROUTINE FXPPM
!  Differentiation of fyppm in reverse (adjoint) mode (with options r8 split(a2b_edge_mod.a2b_ord2 a2b_edge_mod.a2b_ord4 a2b_e
!dge_mod.extrap_corner  dyn_core_mod.dyn_core dyn_core_mod.pk3_halo dyn_core_mod.pln_halo dyn_core_mod.pe_halo dyn_core_mod.ad
!v_pe dyn_core_mod.p_grad_c dyn_core_mod.nh_p_grad dyn_core_mod.split_p_grad dyn_core_mod.one_grad_p dyn_core_mod.grad1_p_update 
!dyn_core_mod.mix_dp dyn_core_mod.geopk dyn_core_mod.del2_cubed fv_dynamics_mod.fv_dynamics fv_dynamics_mod.rayleigh_super fv_dyn
!amics_mod.rayleigh_friction fv_dynamics_mod.compute_aam fv_dynamics_mod.geos_to_fv3 fv_grid_utils_mod.cubed_to_latlon fv_grid_ut
!ils_mod.c2l_ord4 fv_grid_utils_mod.c2l_ord2 fv_mapz_mod.lagrangian_to_eulerian fv_mapz_mod.compute_total_energy fv_mapz_mod.pkez
! fv_mapz_mod.remap_z fv_mapz_mod.map_scalar fv_mapz_mod.map1_ppm fv_mapz_mod.mapn_tracer fv_mapz_mod.map1_q2 fv_m
!apz_mod.map1_cubic fv_mapz_mod.scalar_profile_linear fv_mapz_mod.cs_profile_linear fv_mapz_mod.steepz fv_tracer2d_mod.trac
!er_2d fv_tracer2d_mod.tracer_2d_nested nh_core_mod.update_dz_c nh_core_mod.update_dz_d nh_core_mod.riem_solver_c nh_core_mod.rie
!m_solver3 nh_core_mod.rim_2d nh_core_mod.sim3_solver nh_core_mod.sim3p0_solver nh_core_mod.sim1_solver nh_core_mod.sim_solver nh
!_core_mod.edge_profile sw_core_mod.c_sw sw_core_mod.d_sw sw_core_mod.divergence_corner sw_core_mod.divergence_corner_nest sw_cor
!e_mod.d2a2c_vect sw_core_mod.edge_interpolate4 sw_core_mod.fill2_4corners sw_core_mod.fill_4corners sw_core_mod.compute_div_damp
!ing_fb sw_core_mod.smag_corner sw_core_mod.ytp_v sw_core_mod.xtp_u tp_core_mod.fv_tp_2d tp_core_mod.copy_corners 
!tp_core_mod.xtp tp_core_mod.ytp tp_core_mod.xppm0 tp_core_mod.yppm0 tp_core_mod.fxppm tp_core_mod.fyppm tp_cor
!e_mod.deln_flux)):
!   gradient     of useful results: q flux c
!   with respect to varying inputs: q flux c
  SUBROUTINE FYPPM_ADM(c, c_ad, q, q_ad, flux, flux_ad, jord, ifirst, &
&   ilast, jfirst, jlast, npx, npy, dm, dm_ad, bd, dya, nested, &
&   grid_type)
    IMPLICIT NONE
    TYPE(FV_GRID_BOUNDS_TYPE), INTENT(IN) :: bd
!  X-Dir strip
    INTEGER, INTENT(IN) :: ifirst, ilast
!  Y-Dir strip
    INTEGER, INTENT(IN) :: jfirst, jlast
    INTEGER, INTENT(IN) :: jord
    INTEGER, INTENT(IN) :: npx, npy
    REAL(fvprc), INTENT(IN) :: q(ifirst:ilast, jfirst-ng:jlast+ng)
    REAL(fvprc) :: q_ad(ifirst:ilast, jfirst-ng:jlast+ng)
! Courant number
    REAL(fvprc), INTENT(IN) :: c(bd%isd:bd%ied, bd%js:bd%je+1)
    REAL(fvprc) :: c_ad(bd%isd:bd%ied, bd%js:bd%je+1)
!  Flux
    REAL(fvprc) :: flux(ifirst:ilast, jfirst:jlast+1)
    REAL(fvprc) :: flux_ad(ifirst:ilast, jfirst:jlast+1)
    REAL(fvprc) :: dm(ifirst:ilast, jfirst-2:jlast+2)
    REAL(fvprc) :: dm_ad(ifirst:ilast, jfirst-2:jlast+2)
    REAL(fvprc), INTENT(IN) :: dya(bd%isd:bd%ied, bd%jsd:bd%jed)
    LOGICAL, INTENT(IN) :: nested
    INTEGER, INTENT(IN) :: grid_type
! Local:
    LOGICAL :: extm(ifirst:ilast, jfirst-2:jlast+2)
    REAL(fvprc) :: al(ifirst:ilast, jfirst-1:jlast+2)
    REAL(fvprc) :: al_ad(ifirst:ilast, jfirst-1:jlast+2)
    REAL(fvprc) :: bl(ifirst:ilast, jfirst-1:jlast+1)
    REAL(fvprc) :: bl_ad(ifirst:ilast, jfirst-1:jlast+1)
    REAL(fvprc) :: br(ifirst:ilast, jfirst-1:jlast+1)
    REAL(fvprc) :: br_ad(ifirst:ilast, jfirst-1:jlast+1)
    REAL(fvprc) :: dq(ifirst:ilast, jfirst-3:jlast+2)
    REAL(fvprc) :: dq_ad(ifirst:ilast, jfirst-3:jlast+2)
    REAL(fvprc) :: dl, dr, pmp, lac, ct, qe
    REAL(fvprc) :: dl_ad, dr_ad, pmp_ad, lac_ad
    REAL(fvprc) :: pmp_1, lac_1, pmp_2, lac_2
    REAL(fvprc) :: pmp_1_ad, lac_1_ad, pmp_2_ad, lac_2_ad
    REAL(fvprc) :: xt, x0, x1, x0l, x0r
    REAL(fvprc) :: xt_ad, x0_ad, x1_ad, x0l_ad, x0r_ad
    INTEGER :: i, j, js3, je3, jt
    INTEGER :: is, ie, js, je, isd, ied, jsd, jed
    INTRINSIC MAX
    INTRINSIC MIN
    INTRINSIC ABS
    INTRINSIC SIGN
    REAL(fvprc) :: min1
    REAL(fvprc) :: min1_ad
    INTEGER :: max1
    REAL(fvprc) :: min2
    REAL(fvprc) :: min2_ad
    REAL(fvprc) :: min3
    REAL(fvprc) :: min3_ad
    REAL(fvprc) :: min4
    REAL(fvprc) :: min4_ad
    REAL(fvprc) :: min5
    REAL(fvprc) :: min5_ad
    REAL(fvprc) :: min6
    REAL(fvprc) :: min6_ad
    REAL(fvprc) :: min7
    REAL(fvprc) :: min7_ad
    REAL(fvprc) :: min8
    REAL(fvprc) :: min8_ad
    REAL(fvprc) :: min9
    REAL(fvprc) :: min9_ad
    REAL(fvprc) :: min10
    REAL(fvprc) :: min10_ad
    INTEGER :: max2
    REAL(fvprc) :: min11
    REAL(fvprc) :: min11_ad
    REAL(fvprc) :: min12
    REAL(fvprc) :: min12_ad
    REAL(fvprc) :: min13
    REAL(fvprc) :: min13_ad
    REAL(fvprc) :: abs0
    REAL(fvprc) :: abs1
    REAL(fvprc) :: min14
    REAL(fvprc) :: min14_ad
    REAL(fvprc) :: min15
    REAL(fvprc) :: min15_ad
    REAL(fvprc) :: min16
    REAL(fvprc) :: min16_ad
    REAL(fvprc) :: abs2
    REAL(fvprc) :: abs3
    REAL(fvprc) :: min17
    REAL(fvprc) :: min17_ad
    REAL(fvprc) :: min18
    REAL(fvprc) :: min18_ad
    REAL(fvprc) :: max3
    REAL(fvprc) :: max3_ad
    REAL(fvprc) :: min19
    REAL(fvprc) :: min19_ad
    INTEGER :: min20
    REAL(fvprc) :: max4
    REAL(fvprc) :: max4_ad
    REAL(fvprc) :: min21
    REAL(fvprc) :: min21_ad
    REAL(fvprc) :: max5
    REAL(fvprc) :: max5_ad
    REAL(fvprc) :: min22
    REAL(fvprc) :: min22_ad
    REAL(fvprc) :: max6
    REAL(fvprc) :: max6_ad
    REAL(fvprc) :: min23
    REAL(fvprc) :: min23_ad
    REAL(fvprc) :: max7
    REAL(fvprc) :: max7_ad
    REAL(fvprc) :: min24
    REAL(fvprc) :: min24_ad
    REAL(fvprc) :: max8
    REAL(fvprc) :: max8_ad
    REAL(fvprc) :: min25
    REAL(fvprc) :: min25_ad
    INTEGER :: min26
    REAL(fvprc) :: max9
    REAL(fvprc) :: max9_ad
    REAL(fvprc) :: min27
    REAL(fvprc) :: min27_ad
    REAL(fvprc) :: abs4
    REAL(fvprc) :: abs5
    REAL(fvprc) :: max10
    REAL(fvprc) :: max10_ad
    REAL(fvprc) :: min28
    REAL(fvprc) :: min28_ad
    REAL(fvprc) :: abs6
    REAL(fvprc) :: abs7
    REAL(fvprc) :: abs8
    REAL(fvprc) :: abs9
    INTEGER :: arg1
    REAL(fvprc) :: x2_ad
    REAL(fvprc) :: y1_ad
    REAL(fvprc) :: z1_ad
    REAL(fvprc) :: temp_ad
    REAL(fvprc) :: temp_ad0
    REAL(fvprc) :: x3_ad
    REAL(fvprc) :: y2_ad
    REAL(fvprc) :: z2_ad
    REAL(fvprc) :: x4_ad
    REAL(fvprc) :: y3_ad
    REAL(fvprc) :: z3_ad
    REAL(fvprc) :: temp_ad1
    REAL(fvprc) :: temp_ad2
    REAL(fvprc) :: x5_ad
    REAL(fvprc) :: y4_ad
    REAL(fvprc) :: z4_ad
    REAL(fvprc) :: x6_ad
    REAL(fvprc) :: y5_ad
    REAL(fvprc) :: z5_ad
    REAL(fvprc) :: temp
    REAL(fvprc) :: temp_ad3
    REAL(fvprc) :: temp_ad4
    REAL(fvprc) :: temp0
    REAL(fvprc) :: temp_ad5
    REAL(fvprc) :: temp_ad6
    REAL(fvprc) :: x7_ad
    REAL(fvprc) :: y6_ad
    REAL(fvprc) :: x8_ad
    REAL(fvprc) :: y7_ad
    REAL(fvprc) :: temp_ad7
    REAL(fvprc) :: temp_ad8
    REAL(fvprc) :: x9_ad
    REAL(fvprc) :: y8_ad
    REAL(fvprc) :: x10_ad
    REAL(fvprc) :: y9_ad
    REAL(fvprc) :: temp_ad9
    REAL(fvprc) :: temp_ad10
    REAL(fvprc) :: x11_ad
    REAL(fvprc) :: y10_ad
    REAL(fvprc) :: z6_ad
    REAL(fvprc) :: x12_ad
    REAL(fvprc) :: y33_ad
    REAL(fvprc) :: y11_ad
    REAL(fvprc) :: x13_ad
    REAL(fvprc) :: y34_ad
    REAL(fvprc) :: y12_ad
    REAL(fvprc) :: temp1
    REAL(fvprc) :: temp_ad11
    REAL(fvprc) :: temp_ad12
    REAL(fvprc) :: temp2
    REAL(fvprc) :: temp_ad13
    REAL(fvprc) :: temp_ad14
    REAL(fvprc) :: temp_ad15
    REAL(fvprc) :: temp_ad16
    REAL(fvprc) :: temp_ad17
    REAL(fvprc) :: temp_ad18
    REAL(fvprc) :: temp3
    REAL(fvprc) :: temp_ad19
    REAL(fvprc) :: temp_ad20
    REAL(fvprc) :: temp4
    REAL(fvprc) :: temp_ad21
    REAL(fvprc) :: temp_ad22
    REAL(fvprc) :: x14_ad
    REAL(fvprc) :: y13_ad
    REAL(fvprc) :: z7_ad
    REAL(fvprc) :: x15_ad
    REAL(fvprc) :: y14_ad
    REAL(fvprc) :: x16_ad
    REAL(fvprc) :: y15_ad
    REAL(fvprc) :: x17_ad
    REAL(fvprc) :: y35_ad
    REAL(fvprc) :: y16_ad
    REAL(fvprc) :: x18_ad
    REAL(fvprc) :: y36_ad
    REAL(fvprc) :: y17_ad
    REAL(fvprc) :: x19_ad
    REAL(fvprc) :: y37_ad
    REAL(fvprc) :: y18_ad
    REAL(fvprc) :: x20_ad
    REAL(fvprc) :: y38_ad
    REAL(fvprc) :: y19_ad
    REAL(fvprc) :: temp_ad23
    REAL(fvprc) :: temp_ad24
    REAL(fvprc) :: temp_ad25
    REAL(fvprc) :: temp_ad26
    REAL(fvprc) :: x21_ad
    REAL(fvprc) :: y39_ad
    REAL(fvprc) :: y20_ad
    REAL(fvprc) :: x22_ad
    REAL(fvprc) :: y40_ad
    REAL(fvprc) :: y21_ad
    REAL(fvprc) :: temp5
    REAL(fvprc) :: temp_ad27
    REAL(fvprc) :: temp_ad28
    REAL(fvprc) :: temp6
    REAL(fvprc) :: temp_ad29
    REAL(fvprc) :: temp_ad30
    REAL(fvprc) :: x23_ad
    REAL(fvprc) :: y22_ad
    REAL(fvprc) :: z8_ad
    REAL(fvprc) :: x24_ad
    REAL(fvprc) :: y23_ad
    REAL(fvprc) :: x25_ad
    REAL(fvprc) :: y24_ad
    REAL(fvprc) :: x26_ad
    REAL(fvprc) :: y41_ad
    REAL(fvprc) :: y25_ad
    REAL(fvprc) :: x27_ad
    REAL(fvprc) :: y42_ad
    REAL(fvprc) :: y26_ad
    REAL(fvprc) :: x28_ad
    REAL(fvprc) :: y43_ad
    REAL(fvprc) :: y27_ad
    REAL(fvprc) :: x29_ad
    REAL(fvprc) :: y44_ad
    REAL(fvprc) :: y28_ad
    REAL(fvprc) :: temp_ad31
    REAL(fvprc) :: temp_ad32
    REAL(fvprc) :: temp_ad33
    REAL(fvprc) :: temp_ad34
    REAL(fvprc) :: x30_ad
    REAL(fvprc) :: y29_ad
    REAL(fvprc) :: x31_ad
    REAL(fvprc) :: y30_ad
    REAL(fvprc) :: x32_ad
    REAL(fvprc) :: y45_ad
    REAL(fvprc) :: y31_ad
    REAL(fvprc) :: x33_ad
    REAL(fvprc) :: y46_ad
    REAL(fvprc) :: y32_ad
    REAL(fvprc) :: temp7
    REAL(fvprc) :: temp_ad35
    REAL(fvprc) :: temp_ad36
    REAL(fvprc) :: temp8
    REAL(fvprc) :: temp_ad37
    REAL(fvprc) :: temp_ad38
    INTEGER :: branch
    REAL(fvprc) :: x19
    REAL(fvprc) :: x18
    REAL(fvprc) :: x17
    REAL(fvprc) :: x16
    REAL(fvprc) :: x15
    REAL(fvprc) :: x14
    REAL(fvprc) :: x13
    REAL(fvprc) :: x12
    REAL(fvprc) :: x11
    REAL(fvprc) :: y29
    REAL(fvprc) :: x10
    REAL(fvprc) :: y28
    REAL(fvprc) :: y27
    REAL(fvprc) :: y26
    REAL(fvprc) :: y25
    REAL(fvprc) :: y24
    REAL(fvprc) :: y23
    REAL(fvprc) :: y22
    REAL(fvprc) :: y21
    REAL(fvprc) :: y20
    REAL(fvprc) :: x9
    REAL(fvprc) :: x8
    REAL(fvprc) :: x7
    REAL(fvprc) :: x6
    REAL(fvprc) :: x5
    REAL(fvprc) :: x4
    REAL(fvprc) :: x3
    REAL(fvprc) :: x2
    REAL(fvprc) :: y19
    REAL(fvprc) :: y18
    REAL(fvprc) :: y17
    REAL(fvprc) :: y16
    REAL(fvprc) :: y15
    REAL(fvprc) :: y14
    REAL(fvprc) :: x33
    REAL(fvprc) :: y13
    REAL(fvprc) :: x32
    REAL(fvprc) :: y12
    REAL(fvprc) :: x31
    REAL(fvprc) :: y11
    REAL(fvprc) :: x30
    REAL(fvprc) :: y10
    REAL(fvprc) :: y46
    REAL(fvprc) :: y45
    REAL(fvprc) :: y44
    REAL(fvprc) :: y43
    REAL(fvprc) :: y42
    REAL(fvprc) :: y41
    REAL(fvprc) :: y40
    REAL(fvprc) :: z8
    REAL(fvprc) :: z7
    REAL(fvprc) :: z6
    REAL(fvprc) :: z5
    REAL(fvprc) :: z4
    REAL(fvprc) :: z3
    REAL(fvprc) :: z2
    REAL(fvprc) :: z1
    REAL(fvprc) :: x29
    REAL(fvprc) :: x28
    REAL(fvprc) :: x27
    REAL(fvprc) :: x26
    REAL(fvprc) :: x25
    REAL(fvprc) :: x24
    REAL(fvprc) :: x23
    REAL(fvprc) :: x22
    REAL(fvprc) :: x21
    REAL(fvprc) :: y39
    REAL(fvprc) :: x20
    REAL(fvprc) :: y38
    REAL(fvprc) :: y37
    REAL(fvprc) :: y36
    REAL(fvprc) :: y35
    REAL(fvprc) :: y34
    REAL(fvprc) :: y33
    REAL(fvprc) :: y32
    REAL(fvprc) :: y31
    REAL(fvprc) :: y30
    REAL(fvprc) :: y9
    REAL(fvprc) :: y8
    REAL(fvprc) :: y7
    REAL(fvprc) :: y6
    REAL(fvprc) :: y5
    REAL(fvprc) :: y4
    REAL(fvprc) :: y3
    REAL(fvprc) :: y2
    REAL(fvprc) :: y1
    js = bd%js
    je = bd%je
    IF (nested) THEN
      CALL PUSHCONTROL1B(0)
      js3 = js - 1
      je3 = je + 1
    ELSE
      IF (3 .LT. js - 1) THEN
        js3 = js - 1
      ELSE
        js3 = 3
      END IF
      IF (npy - 3 .GT. je + 1) THEN
        CALL PUSHCONTROL1B(1)
        je3 = je + 1
      ELSE
        CALL PUSHCONTROL1B(1)
        je3 = npy - 3
      END IF
    END IF
    IF (jord .LE. 4) THEN
      DO j=js-2,je+2
        DO i=ifirst,ilast
          xt = 0.25*(q(i, j+1)-q(i, j-1))
          IF (xt .GE. 0.) THEN
            x2 = xt
            CALL PUSHCONTROL1B(0)
          ELSE
            x2 = -xt
            CALL PUSHCONTROL1B(1)
          END IF
          IF (q(i, j-1) .LT. q(i, j)) THEN
            IF (q(i, j) .LT. q(i, j+1)) THEN
              max3 = q(i, j+1)
              CALL PUSHCONTROL2B(0)
            ELSE
              max3 = q(i, j)
              CALL PUSHCONTROL2B(1)
            END IF
          ELSE IF (q(i, j-1) .LT. q(i, j+1)) THEN
            max3 = q(i, j+1)
            CALL PUSHCONTROL2B(2)
          ELSE
            max3 = q(i, j-1)
            CALL PUSHCONTROL2B(3)
          END IF
          y1 = max3 - q(i, j)
          IF (q(i, j-1) .GT. q(i, j)) THEN
            IF (q(i, j) .GT. q(i, j+1)) THEN
              min19 = q(i, j+1)
              CALL PUSHCONTROL2B(0)
            ELSE
              min19 = q(i, j)
              CALL PUSHCONTROL2B(1)
            END IF
          ELSE IF (q(i, j-1) .GT. q(i, j+1)) THEN
            min19 = q(i, j+1)
            CALL PUSHCONTROL2B(2)
          ELSE
            min19 = q(i, j-1)
            CALL PUSHCONTROL2B(3)
          END IF
          z1 = q(i, j) - min19
          IF (x2 .GT. y1) THEN
            IF (y1 .GT. z1) THEN
              CALL PUSHREALARRAY_ADM(min1)
              min1 = z1
              CALL PUSHCONTROL2B(0)
            ELSE
              CALL PUSHREALARRAY_ADM(min1)
              min1 = y1
              CALL PUSHCONTROL2B(1)
            END IF
          ELSE IF (x2 .GT. z1) THEN
            CALL PUSHREALARRAY_ADM(min1)
            min1 = z1
            CALL PUSHCONTROL2B(2)
          ELSE
            CALL PUSHREALARRAY_ADM(min1)
            min1 = x2
            CALL PUSHCONTROL2B(3)
          END IF
          dm(i, j) = SIGN(min1, xt)
        END DO
      END DO
      IF (grid_type .LT. 3) THEN
        IF (3 .LT. js - 1) THEN
          max1 = js - 1
        ELSE
          max1 = 3
        END IF
        IF (npy - 2 .GT. je + 2) THEN
          min20 = je + 2
        ELSE
          min20 = npy - 2
        END IF
        DO j=max1,min20
          DO i=ifirst,ilast
            al(i, j) = 0.5*(q(i, j-1)+q(i, j)) + r3*(dm(i, j-1)-dm(i, j)&
&             )
          END DO
        END DO
!--------------
! Fix the edges:
!--------------
        IF (.NOT.nested) THEN
          IF (js .EQ. 1) THEN
            DO i=ifirst,ilast
              x0l = 0.5*((2.*dya(i, 0)+dya(i, -1))*q(i, 0)-dya(i, 0)*q(i&
&               , -1))/(dya(i, 0)+dya(i, -1))
              x0r = 0.5*((2.*dya(i, 1)+dya(i, 2))*q(i, 1)-dya(i, 1)*q(i&
&               , 2))/(dya(i, 1)+dya(i, 2))
              x0 = x0l + x0r
              al(i, 1) = x0
              x1 = s15*q(i, 0) + s11*q(i, -1) + s14*dm(i, -1)
              dm(i, 0) = 0.5*(x0-x1)
              IF (dm(i, 0) .GE. 0.) THEN
                x3 = dm(i, 0)
                CALL PUSHCONTROL1B(0)
              ELSE
                x3 = -dm(i, 0)
                CALL PUSHCONTROL1B(1)
              END IF
              IF (q(i, 0) .LT. x0) THEN
                IF (x0 .LT. x1) THEN
                  max4 = x1
                  CALL PUSHCONTROL2B(0)
                ELSE
                  max4 = x0
                  CALL PUSHCONTROL2B(1)
                END IF
              ELSE IF (q(i, 0) .LT. x1) THEN
                max4 = x1
                CALL PUSHCONTROL2B(2)
              ELSE
                max4 = q(i, 0)
                CALL PUSHCONTROL2B(3)
              END IF
              y2 = max4 - q(i, 0)
              IF (q(i, 0) .GT. x0) THEN
                IF (x0 .GT. x1) THEN
                  min21 = x1
                  CALL PUSHCONTROL2B(0)
                ELSE
                  min21 = x0
                  CALL PUSHCONTROL2B(1)
                END IF
              ELSE IF (q(i, 0) .GT. x1) THEN
                min21 = x1
                CALL PUSHCONTROL2B(2)
              ELSE
                min21 = q(i, 0)
                CALL PUSHCONTROL2B(3)
              END IF
              z2 = q(i, 0) - min21
              IF (x3 .GT. y2) THEN
                IF (y2 .GT. z2) THEN
                  CALL PUSHREALARRAY_ADM(min2)
                  min2 = z2
                  CALL PUSHCONTROL2B(0)
                ELSE
                  CALL PUSHREALARRAY_ADM(min2)
                  min2 = y2
                  CALL PUSHCONTROL2B(1)
                END IF
              ELSE IF (x3 .GT. z2) THEN
                CALL PUSHREALARRAY_ADM(min2)
                min2 = z2
                CALL PUSHCONTROL2B(2)
              ELSE
                CALL PUSHREALARRAY_ADM(min2)
                min2 = x3
                CALL PUSHCONTROL2B(3)
              END IF
              CALL PUSHREALARRAY_ADM(dm(i, 0))
              dm(i, 0) = SIGN(min2, dm(i, 0))
              al(i, 0) = 0.5*(q(i, -1)+q(i, 0)) + r3*(dm(i, -1)-dm(i, 0)&
&               )
!
              x1 = s15*q(i, 1) + s11*q(i, 2) - s14*dm(i, 2)
              CALL PUSHREALARRAY_ADM(dm(i, 1))
              dm(i, 1) = 0.5*(x1-x0)
              IF (dm(i, 1) .GE. 0.) THEN
                x4 = dm(i, 1)
                CALL PUSHCONTROL1B(0)
              ELSE
                x4 = -dm(i, 1)
                CALL PUSHCONTROL1B(1)
              END IF
              IF (q(i, 1) .LT. x0) THEN
                IF (x0 .LT. x1) THEN
                  max5 = x1
                  CALL PUSHCONTROL2B(0)
                ELSE
                  max5 = x0
                  CALL PUSHCONTROL2B(1)
                END IF
              ELSE IF (q(i, 1) .LT. x1) THEN
                max5 = x1
                CALL PUSHCONTROL2B(2)
              ELSE
                max5 = q(i, 1)
                CALL PUSHCONTROL2B(3)
              END IF
              y3 = max5 - q(i, 1)
              IF (q(i, 1) .GT. x0) THEN
                IF (x0 .GT. x1) THEN
                  min22 = x1
                  CALL PUSHCONTROL2B(0)
                ELSE
                  min22 = x0
                  CALL PUSHCONTROL2B(1)
                END IF
              ELSE IF (q(i, 1) .GT. x1) THEN
                min22 = x1
                CALL PUSHCONTROL2B(2)
              ELSE
                min22 = q(i, 1)
                CALL PUSHCONTROL2B(3)
              END IF
              z3 = q(i, 1) - min22
              IF (x4 .GT. y3) THEN
                IF (y3 .GT. z3) THEN
                  CALL PUSHREALARRAY_ADM(min3)
                  min3 = z3
                  CALL PUSHCONTROL2B(0)
                ELSE
                  CALL PUSHREALARRAY_ADM(min3)
                  min3 = y3
                  CALL PUSHCONTROL2B(1)
                END IF
              ELSE IF (x4 .GT. z3) THEN
                CALL PUSHREALARRAY_ADM(min3)
                min3 = z3
                CALL PUSHCONTROL2B(2)
              ELSE
                CALL PUSHREALARRAY_ADM(min3)
                min3 = x4
                CALL PUSHCONTROL2B(3)
              END IF
              CALL PUSHREALARRAY_ADM(dm(i, 1))
              dm(i, 1) = SIGN(min3, dm(i, 1))
              al(i, 2) = 0.5*(q(i, 1)+q(i, 2)) + r3*(dm(i, 1)-dm(i, 2))
            END DO
            CALL PUSHCONTROL1B(0)
          ELSE
            CALL PUSHCONTROL1B(1)
          END IF
          IF (je + 1 .EQ. npy) THEN
            DO i=ifirst,ilast
              x0l = 0.5*((2.*dya(i, npy-1)+dya(i, npy-2))*q(i, npy-1)-&
&               dya(i, npy-1)*q(i, npy-2))/(dya(i, npy-1)+dya(i, npy-2))
              x0r = 0.5*((2.*dya(i, npy)+dya(i, npy+1))*q(i, npy)-dya(i&
&               , npy)*q(i, npy+1))/(dya(i, npy)+dya(i, npy+1))
              x0 = x0l + x0r
              al(i, npy) = x0
              x1 = s15*q(i, npy-1) + s11*q(i, npy-2) + s14*dm(i, npy-2)
              CALL PUSHREALARRAY_ADM(dm(i, npy-1))
              dm(i, npy-1) = 0.5*(x0-x1)
              IF (dm(i, npy-1) .GE. 0.) THEN
                x5 = dm(i, npy-1)
                CALL PUSHCONTROL1B(0)
              ELSE
                x5 = -dm(i, npy-1)
                CALL PUSHCONTROL1B(1)
              END IF
              IF (q(i, npy-1) .LT. x0) THEN
                IF (x0 .LT. x1) THEN
                  max6 = x1
                  CALL PUSHCONTROL2B(0)
                ELSE
                  max6 = x0
                  CALL PUSHCONTROL2B(1)
                END IF
              ELSE IF (q(i, npy-1) .LT. x1) THEN
                max6 = x1
                CALL PUSHCONTROL2B(2)
              ELSE
                max6 = q(i, npy-1)
                CALL PUSHCONTROL2B(3)
              END IF
              y4 = max6 - q(i, npy-1)
              IF (q(i, npy-1) .GT. x0) THEN
                IF (x0 .GT. x1) THEN
                  min23 = x1
                  CALL PUSHCONTROL2B(0)
                ELSE
                  min23 = x0
                  CALL PUSHCONTROL2B(1)
                END IF
              ELSE IF (q(i, npy-1) .GT. x1) THEN
                min23 = x1
                CALL PUSHCONTROL2B(2)
              ELSE
                min23 = q(i, npy-1)
                CALL PUSHCONTROL2B(3)
              END IF
              z4 = q(i, npy-1) - min23
              IF (x5 .GT. y4) THEN
                IF (y4 .GT. z4) THEN
                  CALL PUSHREALARRAY_ADM(min4)
                  min4 = z4
                  CALL PUSHCONTROL2B(0)
                ELSE
                  CALL PUSHREALARRAY_ADM(min4)
                  min4 = y4
                  CALL PUSHCONTROL2B(1)
                END IF
              ELSE IF (x5 .GT. z4) THEN
                CALL PUSHREALARRAY_ADM(min4)
                min4 = z4
                CALL PUSHCONTROL2B(2)
              ELSE
                CALL PUSHREALARRAY_ADM(min4)
                min4 = x5
                CALL PUSHCONTROL2B(3)
              END IF
              CALL PUSHREALARRAY_ADM(dm(i, npy-1))
              dm(i, npy-1) = SIGN(min4, dm(i, npy-1))
              al(i, npy-1) = 0.5*(q(i, npy-2)+q(i, npy-1)) + r3*(dm(i, &
&               npy-2)-dm(i, npy-1))
!
              x1 = s15*q(i, npy) + s11*q(i, npy+1) - s14*dm(i, npy+1)
              CALL PUSHREALARRAY_ADM(dm(i, npy))
              dm(i, npy) = 0.5*(x1-x0)
              IF (dm(i, npy) .GE. 0.) THEN
                x6 = dm(i, npy)
                CALL PUSHCONTROL1B(0)
              ELSE
                x6 = -dm(i, npy)
                CALL PUSHCONTROL1B(1)
              END IF
              IF (q(i, npy) .LT. x0) THEN
                IF (x0 .LT. x1) THEN
                  max7 = x1
                  CALL PUSHCONTROL2B(0)
                ELSE
                  max7 = x0
                  CALL PUSHCONTROL2B(1)
                END IF
              ELSE IF (q(i, npy) .LT. x1) THEN
                max7 = x1
                CALL PUSHCONTROL2B(2)
              ELSE
                max7 = q(i, npy)
                CALL PUSHCONTROL2B(3)
              END IF
              y5 = max7 - q(i, npy)
              IF (q(i, npy) .GT. x0) THEN
                IF (x0 .GT. x1) THEN
                  min24 = x1
                  CALL PUSHCONTROL2B(0)
                ELSE
                  min24 = x0
                  CALL PUSHCONTROL2B(1)
                END IF
              ELSE IF (q(i, npy) .GT. x1) THEN
                min24 = x1
                CALL PUSHCONTROL2B(2)
              ELSE
                min24 = q(i, npy)
                CALL PUSHCONTROL2B(3)
              END IF
              z5 = q(i, npy) - min24
              IF (x6 .GT. y5) THEN
                IF (y5 .GT. z5) THEN
                  CALL PUSHREALARRAY_ADM(min5)
                  min5 = z5
                  CALL PUSHCONTROL2B(0)
                ELSE
                  CALL PUSHREALARRAY_ADM(min5)
                  min5 = y5
                  CALL PUSHCONTROL2B(1)
                END IF
              ELSE IF (x6 .GT. z5) THEN
                CALL PUSHREALARRAY_ADM(min5)
                min5 = z5
                CALL PUSHCONTROL2B(2)
              ELSE
                CALL PUSHREALARRAY_ADM(min5)
                min5 = x6
                CALL PUSHCONTROL2B(3)
              END IF
              CALL PUSHREALARRAY_ADM(dm(i, npy))
              dm(i, npy) = SIGN(min5, dm(i, npy))
              al(i, npy+1) = 0.5*(q(i, npy)+q(i, npy+1)) + r3*(dm(i, npy&
&               )-dm(i, npy+1))
            END DO
            CALL PUSHCONTROL2B(0)
          ELSE
            CALL PUSHCONTROL2B(1)
          END IF
        ELSE
          CALL PUSHCONTROL2B(2)
        END IF
      ELSE
! Doubly periodic BC:
        DO j=js-1,je+2
          DO i=ifirst,ilast
            al(i, j) = 0.5*(q(i, j-1)+q(i, j)) + r3*(dm(i, j-1)-dm(i, j)&
&             )
          END DO
        END DO
        CALL PUSHCONTROL2B(3)
      END IF
      IF (jord .EQ. 3) THEN
        DO j=js-1,je+1
          DO i=ifirst,ilast
            bl(i, j) = al(i, j) - q(i, j)
            br(i, j) = al(i, j+1) - q(i, j)
          END DO
          arg1 = ilast - ifirst + 1
          CALL PUSHREALARRAY_ADM(br(ifirst, j), 8*(ilast-ifirst+1)/8)
          CALL PUSHREALARRAY_ADM(bl(ifirst, j), 8*(ilast-ifirst+1)/8)
          CALL PERT_PPM(arg1, q(ifirst, j), bl(ifirst, j), br(ifirst, j)&
&                 , 1)
        END DO
        DO j=js,je+1
          DO i=ifirst,ilast
            IF (c(i, j) .GT. 0.) THEN
              CALL PUSHCONTROL1B(1)
            ELSE
              CALL PUSHCONTROL1B(0)
            END IF
          END DO
        END DO
        bl_ad = 0.0_FVPRC
        br_ad = 0.0_FVPRC
        DO j=je+1,js,-1
          DO i=ilast,ifirst,-1
            CALL POPCONTROL1B(branch)
            IF (branch .EQ. 0) THEN
              temp0 = bl(i, j) + br(i, j)
              temp_ad5 = (c(i, j)+1.)*flux_ad(i, j)
              temp_ad6 = c(i, j)*temp_ad5
              q_ad(i, j) = q_ad(i, j) + flux_ad(i, j)
              c_ad(i, j) = c_ad(i, j) + temp0*temp_ad5 + (bl(i, j)+c(i, &
&               j)*temp0)*flux_ad(i, j)
              bl_ad(i, j) = bl_ad(i, j) + temp_ad6 + temp_ad5
              br_ad(i, j) = br_ad(i, j) + temp_ad6
              flux_ad(i, j) = 0.0_FVPRC
            ELSE
              temp = bl(i, j-1) + br(i, j-1)
              temp_ad3 = (1.-c(i, j))*flux_ad(i, j)
              temp_ad4 = -(c(i, j)*temp_ad3)
              q_ad(i, j-1) = q_ad(i, j-1) + flux_ad(i, j)
              c_ad(i, j) = c_ad(i, j) - temp*temp_ad3 - (br(i, j-1)-c(i&
&               , j)*temp)*flux_ad(i, j)
              br_ad(i, j-1) = br_ad(i, j-1) + temp_ad4 + temp_ad3
              bl_ad(i, j-1) = bl_ad(i, j-1) + temp_ad4
              flux_ad(i, j) = 0.0_FVPRC
            END IF
          END DO
        END DO
        al_ad = 0.0_FVPRC
        DO j=je+1,js-1,-1
          arg1 = ilast - ifirst + 1
          CALL POPREALARRAY_ADM(bl(ifirst, j), 8*(ilast-ifirst+1)/8)
          CALL POPREALARRAY_ADM(br(ifirst, j), 8*(ilast-ifirst+1)/8)
          CALL PERT_PPM_ADM(arg1, q(ifirst, j), bl(ifirst:, j), bl_ad(&
&                     ifirst:, j), br(ifirst:, j), br_ad(ifirst:, j), 1)
          DO i=ilast,ifirst,-1
            al_ad(i, j+1) = al_ad(i, j+1) + br_ad(i, j)
            q_ad(i, j) = q_ad(i, j) - bl_ad(i, j) - br_ad(i, j)
            br_ad(i, j) = 0.0_FVPRC
            al_ad(i, j) = al_ad(i, j) + bl_ad(i, j)
            bl_ad(i, j) = 0.0_FVPRC
          END DO
        END DO
        dm_ad = 0.0_FVPRC
      ELSE
! Inlined limiter
        DO j=js,je+1
          DO i=ifirst,ilast
            IF (c(i, j) .GT. 0.) THEN
              xt = ppm_limiter*dm(i, j-1)
              IF (xt .GE. 0.) THEN
                x7 = xt
                CALL PUSHCONTROL1B(0)
              ELSE
                x7 = -xt
                CALL PUSHCONTROL1B(1)
              END IF
              IF (al(i, j-1) - q(i, j-1) .GE. 0.) THEN
                y6 = al(i, j-1) - q(i, j-1)
                CALL PUSHCONTROL1B(0)
              ELSE
                y6 = -(al(i, j-1)-q(i, j-1))
                CALL PUSHCONTROL1B(1)
              END IF
              IF (x7 .GT. y6) THEN
                CALL PUSHREALARRAY_ADM(min6)
                min6 = y6
                CALL PUSHCONTROL1B(0)
              ELSE
                CALL PUSHREALARRAY_ADM(min6)
                min6 = x7
                CALL PUSHCONTROL1B(1)
              END IF
              CALL PUSHREALARRAY_ADM(dl)
              dl = SIGN(min6, xt)
              IF (xt .GE. 0.) THEN
                x8 = xt
                CALL PUSHCONTROL1B(0)
              ELSE
                x8 = -xt
                CALL PUSHCONTROL1B(1)
              END IF
              IF (al(i, j) - q(i, j-1) .GE. 0.) THEN
                y7 = al(i, j) - q(i, j-1)
                CALL PUSHCONTROL1B(0)
              ELSE
                y7 = -(al(i, j)-q(i, j-1))
                CALL PUSHCONTROL1B(1)
              END IF
              IF (x8 .GT. y7) THEN
                CALL PUSHREALARRAY_ADM(min7)
                min7 = y7
                CALL PUSHCONTROL1B(0)
              ELSE
                CALL PUSHREALARRAY_ADM(min7)
                min7 = x8
                CALL PUSHCONTROL1B(1)
              END IF
              CALL PUSHREALARRAY_ADM(dr)
              dr = SIGN(min7, xt)
              CALL PUSHCONTROL1B(1)
            ELSE
              xt = ppm_limiter*dm(i, j)
              IF (xt .GE. 0.) THEN
                x9 = xt
                CALL PUSHCONTROL1B(0)
              ELSE
                x9 = -xt
                CALL PUSHCONTROL1B(1)
              END IF
              IF (al(i, j) - q(i, j) .GE. 0.) THEN
                y8 = al(i, j) - q(i, j)
                CALL PUSHCONTROL1B(0)
              ELSE
                y8 = -(al(i, j)-q(i, j))
                CALL PUSHCONTROL1B(1)
              END IF
              IF (x9 .GT. y8) THEN
                CALL PUSHREALARRAY_ADM(min8)
                min8 = y8
                CALL PUSHCONTROL1B(0)
              ELSE
                CALL PUSHREALARRAY_ADM(min8)
                min8 = x9
                CALL PUSHCONTROL1B(1)
              END IF
              CALL PUSHREALARRAY_ADM(dl)
              dl = SIGN(min8, xt)
              IF (xt .GE. 0.) THEN
                x10 = xt
                CALL PUSHCONTROL1B(0)
              ELSE
                x10 = -xt
                CALL PUSHCONTROL1B(1)
              END IF
              IF (al(i, j+1) - q(i, j) .GE. 0.) THEN
                y9 = al(i, j+1) - q(i, j)
                CALL PUSHCONTROL1B(0)
              ELSE
                y9 = -(al(i, j+1)-q(i, j))
                CALL PUSHCONTROL1B(1)
              END IF
              IF (x10 .GT. y9) THEN
                CALL PUSHREALARRAY_ADM(min9)
                min9 = y9
                CALL PUSHCONTROL1B(0)
              ELSE
                CALL PUSHREALARRAY_ADM(min9)
                min9 = x10
                CALL PUSHCONTROL1B(1)
              END IF
              CALL PUSHREALARRAY_ADM(dr)
              dr = SIGN(min9, xt)
              CALL PUSHCONTROL1B(0)
            END IF
          END DO
        END DO
        dm_ad = 0.0_FVPRC
        al_ad = 0.0_FVPRC
        DO j=je+1,js,-1
          DO i=ilast,ifirst,-1
            CALL POPCONTROL1B(branch)
            IF (branch .EQ. 0) THEN
              temp_ad9 = -((c(i, j)+1.)*flux_ad(i, j))
              temp_ad10 = c(i, j)*temp_ad9
              q_ad(i, j) = q_ad(i, j) + flux_ad(i, j)
              c_ad(i, j) = c_ad(i, j) + (dl-dr)*temp_ad9 - (c(i, j)*(dl-&
&               dr)+dl)*flux_ad(i, j)
              dl_ad = temp_ad9 + temp_ad10
              dr_ad = -temp_ad10
              flux_ad(i, j) = 0.0_FVPRC
              xt = ppm_limiter*dm(i, j)
              CALL POPREALARRAY_ADM(dr)
              min9_ad = SIGN(1.d0, min9*xt)*dr_ad
              CALL POPCONTROL1B(branch)
              IF (branch .EQ. 0) THEN
                CALL POPREALARRAY_ADM(min9)
                y9_ad = min9_ad
                x10_ad = 0.0_FVPRC
              ELSE
                CALL POPREALARRAY_ADM(min9)
                x10_ad = min9_ad
                y9_ad = 0.0_FVPRC
              END IF
              CALL POPCONTROL1B(branch)
              IF (branch .EQ. 0) THEN
                al_ad(i, j+1) = al_ad(i, j+1) + y9_ad
                q_ad(i, j) = q_ad(i, j) - y9_ad
              ELSE
                q_ad(i, j) = q_ad(i, j) + y9_ad
                al_ad(i, j+1) = al_ad(i, j+1) - y9_ad
              END IF
              CALL POPCONTROL1B(branch)
              IF (branch .EQ. 0) THEN
                xt_ad = x10_ad
              ELSE
                xt_ad = -x10_ad
              END IF
              CALL POPREALARRAY_ADM(dl)
              min8_ad = SIGN(1.d0, min8*xt)*dl_ad
              CALL POPCONTROL1B(branch)
              IF (branch .EQ. 0) THEN
                CALL POPREALARRAY_ADM(min8)
                y8_ad = min8_ad
                x9_ad = 0.0_FVPRC
              ELSE
                CALL POPREALARRAY_ADM(min8)
                x9_ad = min8_ad
                y8_ad = 0.0_FVPRC
              END IF
              CALL POPCONTROL1B(branch)
              IF (branch .EQ. 0) THEN
                al_ad(i, j) = al_ad(i, j) + y8_ad
                q_ad(i, j) = q_ad(i, j) - y8_ad
              ELSE
                q_ad(i, j) = q_ad(i, j) + y8_ad
                al_ad(i, j) = al_ad(i, j) - y8_ad
              END IF
              CALL POPCONTROL1B(branch)
              IF (branch .EQ. 0) THEN
                xt_ad = xt_ad + x9_ad
              ELSE
                xt_ad = xt_ad - x9_ad
              END IF
              dm_ad(i, j) = dm_ad(i, j) + ppm_limiter*xt_ad
            ELSE
              temp_ad7 = (1.-c(i, j))*flux_ad(i, j)
              temp_ad8 = c(i, j)*temp_ad7
              q_ad(i, j-1) = q_ad(i, j-1) + flux_ad(i, j)
              c_ad(i, j) = c_ad(i, j) + (dl-dr)*temp_ad7 - (c(i, j)*(dl-&
&               dr)+dr)*flux_ad(i, j)
              dl_ad = temp_ad8
              dr_ad = temp_ad7 - temp_ad8
              flux_ad(i, j) = 0.0_FVPRC
              xt = ppm_limiter*dm(i, j-1)
              CALL POPREALARRAY_ADM(dr)
              min7_ad = SIGN(1.d0, min7*xt)*dr_ad
              CALL POPCONTROL1B(branch)
              IF (branch .EQ. 0) THEN
                CALL POPREALARRAY_ADM(min7)
                y7_ad = min7_ad
                x8_ad = 0.0_FVPRC
              ELSE
                CALL POPREALARRAY_ADM(min7)
                x8_ad = min7_ad
                y7_ad = 0.0_FVPRC
              END IF
              CALL POPCONTROL1B(branch)
              IF (branch .EQ. 0) THEN
                al_ad(i, j) = al_ad(i, j) + y7_ad
                q_ad(i, j-1) = q_ad(i, j-1) - y7_ad
              ELSE
                q_ad(i, j-1) = q_ad(i, j-1) + y7_ad
                al_ad(i, j) = al_ad(i, j) - y7_ad
              END IF
              CALL POPCONTROL1B(branch)
              IF (branch .EQ. 0) THEN
                xt_ad = x8_ad
              ELSE
                xt_ad = -x8_ad
              END IF
              CALL POPREALARRAY_ADM(dl)
              min6_ad = SIGN(1.d0, min6*xt)*dl_ad
              CALL POPCONTROL1B(branch)
              IF (branch .EQ. 0) THEN
                CALL POPREALARRAY_ADM(min6)
                y6_ad = min6_ad
                x7_ad = 0.0_FVPRC
              ELSE
                CALL POPREALARRAY_ADM(min6)
                x7_ad = min6_ad
                y6_ad = 0.0_FVPRC
              END IF
              CALL POPCONTROL1B(branch)
              IF (branch .EQ. 0) THEN
                al_ad(i, j-1) = al_ad(i, j-1) + y6_ad
                q_ad(i, j-1) = q_ad(i, j-1) - y6_ad
              ELSE
                q_ad(i, j-1) = q_ad(i, j-1) + y6_ad
                al_ad(i, j-1) = al_ad(i, j-1) - y6_ad
              END IF
              CALL POPCONTROL1B(branch)
              IF (branch .EQ. 0) THEN
                xt_ad = xt_ad + x7_ad
              ELSE
                xt_ad = xt_ad - x7_ad
              END IF
              dm_ad(i, j-1) = dm_ad(i, j-1) + ppm_limiter*xt_ad
            END IF
          END DO
        END DO
      END IF
      CALL POPCONTROL2B(branch)
      IF (branch .LT. 2) THEN
        IF (branch .EQ. 0) THEN
          DO i=ilast,ifirst,-1
            q_ad(i, npy) = q_ad(i, npy) + 0.5*al_ad(i, npy+1)
            q_ad(i, npy+1) = q_ad(i, npy+1) + 0.5*al_ad(i, npy+1)
            dm_ad(i, npy) = dm_ad(i, npy) + r3*al_ad(i, npy+1)
            dm_ad(i, npy+1) = dm_ad(i, npy+1) - r3*al_ad(i, npy+1)
            al_ad(i, npy+1) = 0.0_FVPRC
            CALL POPREALARRAY_ADM(dm(i, npy))
            min5_ad = SIGN(1.d0, min5*dm(i, npy))*dm_ad(i, npy)
            dm_ad(i, npy) = 0.0_FVPRC
            CALL POPCONTROL2B(branch)
            IF (branch .LT. 2) THEN
              IF (branch .EQ. 0) THEN
                CALL POPREALARRAY_ADM(min5)
                z5_ad = min5_ad
                y5_ad = 0.0_FVPRC
              ELSE
                CALL POPREALARRAY_ADM(min5)
                y5_ad = min5_ad
                z5_ad = 0.0_FVPRC
              END IF
              x6_ad = 0.0_FVPRC
            ELSE
              IF (branch .EQ. 2) THEN
                CALL POPREALARRAY_ADM(min5)
                z5_ad = min5_ad
                x6_ad = 0.0_FVPRC
              ELSE
                CALL POPREALARRAY_ADM(min5)
                x6_ad = min5_ad
                z5_ad = 0.0_FVPRC
              END IF
              y5_ad = 0.0_FVPRC
            END IF
            q_ad(i, npy) = q_ad(i, npy) + z5_ad
            min24_ad = -z5_ad
            CALL POPCONTROL2B(branch)
            IF (branch .LT. 2) THEN
              IF (branch .EQ. 0) THEN
                x1_ad = min24_ad
                x0_ad = 0.0_FVPRC
              ELSE
                x0_ad = min24_ad
                x1_ad = 0.0_FVPRC
              END IF
            ELSE
              IF (branch .EQ. 2) THEN
                x1_ad = min24_ad
              ELSE
                q_ad(i, npy) = q_ad(i, npy) + min24_ad
                x1_ad = 0.0_FVPRC
              END IF
              x0_ad = 0.0_FVPRC
            END IF
            max7_ad = y5_ad
            q_ad(i, npy) = q_ad(i, npy) - y5_ad
            CALL POPCONTROL2B(branch)
            IF (branch .LT. 2) THEN
              IF (branch .EQ. 0) THEN
                x1_ad = x1_ad + max7_ad
              ELSE
                x0_ad = x0_ad + max7_ad
              END IF
            ELSE IF (branch .EQ. 2) THEN
              x1_ad = x1_ad + max7_ad
            ELSE
              q_ad(i, npy) = q_ad(i, npy) + max7_ad
            END IF
            CALL POPCONTROL1B(branch)
            IF (branch .EQ. 0) THEN
              dm_ad(i, npy) = dm_ad(i, npy) + x6_ad
            ELSE
              dm_ad(i, npy) = dm_ad(i, npy) - x6_ad
            END IF
            CALL POPREALARRAY_ADM(dm(i, npy))
            x1_ad = x1_ad + 0.5*dm_ad(i, npy)
            x0_ad = x0_ad - 0.5*dm_ad(i, npy)
            dm_ad(i, npy) = 0.0_FVPRC
            q_ad(i, npy) = q_ad(i, npy) + s15*x1_ad
            q_ad(i, npy+1) = q_ad(i, npy+1) + s11*x1_ad
            dm_ad(i, npy+1) = dm_ad(i, npy+1) - s14*x1_ad
            q_ad(i, npy-2) = q_ad(i, npy-2) + 0.5*al_ad(i, npy-1)
            q_ad(i, npy-1) = q_ad(i, npy-1) + 0.5*al_ad(i, npy-1)
            dm_ad(i, npy-2) = dm_ad(i, npy-2) + r3*al_ad(i, npy-1)
            dm_ad(i, npy-1) = dm_ad(i, npy-1) - r3*al_ad(i, npy-1)
            al_ad(i, npy-1) = 0.0_FVPRC
            CALL POPREALARRAY_ADM(dm(i, npy-1))
            min4_ad = SIGN(1.d0, min4*dm(i, npy-1))*dm_ad(i, npy-1)
            dm_ad(i, npy-1) = 0.0_FVPRC
            CALL POPCONTROL2B(branch)
            IF (branch .LT. 2) THEN
              IF (branch .EQ. 0) THEN
                CALL POPREALARRAY_ADM(min4)
                z4_ad = min4_ad
                y4_ad = 0.0_FVPRC
              ELSE
                CALL POPREALARRAY_ADM(min4)
                y4_ad = min4_ad
                z4_ad = 0.0_FVPRC
              END IF
              x5_ad = 0.0_FVPRC
            ELSE
              IF (branch .EQ. 2) THEN
                CALL POPREALARRAY_ADM(min4)
                z4_ad = min4_ad
                x5_ad = 0.0_FVPRC
              ELSE
                CALL POPREALARRAY_ADM(min4)
                x5_ad = min4_ad
                z4_ad = 0.0_FVPRC
              END IF
              y4_ad = 0.0_FVPRC
            END IF
            q_ad(i, npy-1) = q_ad(i, npy-1) + z4_ad
            min23_ad = -z4_ad
            CALL POPCONTROL2B(branch)
            IF (branch .LT. 2) THEN
              IF (branch .EQ. 0) THEN
                x1_ad = min23_ad
              ELSE
                x0_ad = x0_ad + min23_ad
                x1_ad = 0.0_FVPRC
              END IF
            ELSE IF (branch .EQ. 2) THEN
              x1_ad = min23_ad
            ELSE
              q_ad(i, npy-1) = q_ad(i, npy-1) + min23_ad
              x1_ad = 0.0_FVPRC
            END IF
            max6_ad = y4_ad
            q_ad(i, npy-1) = q_ad(i, npy-1) - y4_ad
            CALL POPCONTROL2B(branch)
            IF (branch .LT. 2) THEN
              IF (branch .EQ. 0) THEN
                x1_ad = x1_ad + max6_ad
              ELSE
                x0_ad = x0_ad + max6_ad
              END IF
            ELSE IF (branch .EQ. 2) THEN
              x1_ad = x1_ad + max6_ad
            ELSE
              q_ad(i, npy-1) = q_ad(i, npy-1) + max6_ad
            END IF
            CALL POPCONTROL1B(branch)
            IF (branch .EQ. 0) THEN
              dm_ad(i, npy-1) = dm_ad(i, npy-1) + x5_ad
            ELSE
              dm_ad(i, npy-1) = dm_ad(i, npy-1) - x5_ad
            END IF
            CALL POPREALARRAY_ADM(dm(i, npy-1))
            x0_ad = x0_ad + al_ad(i, npy) + 0.5*dm_ad(i, npy-1)
            x1_ad = x1_ad - 0.5*dm_ad(i, npy-1)
            dm_ad(i, npy-1) = 0.0_FVPRC
            q_ad(i, npy-1) = q_ad(i, npy-1) + s15*x1_ad
            q_ad(i, npy-2) = q_ad(i, npy-2) + s11*x1_ad
            dm_ad(i, npy-2) = dm_ad(i, npy-2) + s14*x1_ad
            al_ad(i, npy) = 0.0_FVPRC
            x0l_ad = x0_ad
            x0r_ad = x0_ad
            temp_ad1 = 0.5*x0r_ad/(dya(i, npy)+dya(i, npy+1))
            q_ad(i, npy) = q_ad(i, npy) + (dya(i, npy)*2.+dya(i, npy+1))&
&             *temp_ad1
            q_ad(i, npy+1) = q_ad(i, npy+1) - dya(i, npy)*temp_ad1
            temp_ad2 = 0.5*x0l_ad/(dya(i, npy-1)+dya(i, npy-2))
            q_ad(i, npy-1) = q_ad(i, npy-1) + (dya(i, npy-1)*2.+dya(i, &
&             npy-2))*temp_ad2
            q_ad(i, npy-2) = q_ad(i, npy-2) - dya(i, npy-1)*temp_ad2
          END DO
        END IF
        CALL POPCONTROL1B(branch)
        IF (branch .EQ. 0) THEN
          DO i=ilast,ifirst,-1
            q_ad(i, 1) = q_ad(i, 1) + 0.5*al_ad(i, 2)
            q_ad(i, 2) = q_ad(i, 2) + 0.5*al_ad(i, 2)
            dm_ad(i, 1) = dm_ad(i, 1) + r3*al_ad(i, 2)
            dm_ad(i, 2) = dm_ad(i, 2) - r3*al_ad(i, 2)
            al_ad(i, 2) = 0.0_FVPRC
            CALL POPREALARRAY_ADM(dm(i, 1))
            min3_ad = SIGN(1.d0, min3*dm(i, 1))*dm_ad(i, 1)
            dm_ad(i, 1) = 0.0_FVPRC
            CALL POPCONTROL2B(branch)
            IF (branch .LT. 2) THEN
              IF (branch .EQ. 0) THEN
                CALL POPREALARRAY_ADM(min3)
                z3_ad = min3_ad
                y3_ad = 0.0_FVPRC
              ELSE
                CALL POPREALARRAY_ADM(min3)
                y3_ad = min3_ad
                z3_ad = 0.0_FVPRC
              END IF
              x4_ad = 0.0_FVPRC
            ELSE
              IF (branch .EQ. 2) THEN
                CALL POPREALARRAY_ADM(min3)
                z3_ad = min3_ad
                x4_ad = 0.0_FVPRC
              ELSE
                CALL POPREALARRAY_ADM(min3)
                x4_ad = min3_ad
                z3_ad = 0.0_FVPRC
              END IF
              y3_ad = 0.0_FVPRC
            END IF
            q_ad(i, 1) = q_ad(i, 1) + z3_ad
            min22_ad = -z3_ad
            CALL POPCONTROL2B(branch)
            IF (branch .LT. 2) THEN
              IF (branch .EQ. 0) THEN
                x1_ad = min22_ad
                x0_ad = 0.0_FVPRC
              ELSE
                x0_ad = min22_ad
                x1_ad = 0.0_FVPRC
              END IF
            ELSE
              IF (branch .EQ. 2) THEN
                x1_ad = min22_ad
              ELSE
                q_ad(i, 1) = q_ad(i, 1) + min22_ad
                x1_ad = 0.0_FVPRC
              END IF
              x0_ad = 0.0_FVPRC
            END IF
            max5_ad = y3_ad
            q_ad(i, 1) = q_ad(i, 1) - y3_ad
            CALL POPCONTROL2B(branch)
            IF (branch .LT. 2) THEN
              IF (branch .EQ. 0) THEN
                x1_ad = x1_ad + max5_ad
              ELSE
                x0_ad = x0_ad + max5_ad
              END IF
            ELSE IF (branch .EQ. 2) THEN
              x1_ad = x1_ad + max5_ad
            ELSE
              q_ad(i, 1) = q_ad(i, 1) + max5_ad
            END IF
            CALL POPCONTROL1B(branch)
            IF (branch .EQ. 0) THEN
              dm_ad(i, 1) = dm_ad(i, 1) + x4_ad
            ELSE
              dm_ad(i, 1) = dm_ad(i, 1) - x4_ad
            END IF
            CALL POPREALARRAY_ADM(dm(i, 1))
            x1_ad = x1_ad + 0.5*dm_ad(i, 1)
            x0_ad = x0_ad - 0.5*dm_ad(i, 1)
            dm_ad(i, 1) = 0.0_FVPRC
            q_ad(i, 1) = q_ad(i, 1) + s15*x1_ad
            q_ad(i, 2) = q_ad(i, 2) + s11*x1_ad
            dm_ad(i, 2) = dm_ad(i, 2) - s14*x1_ad
            q_ad(i, -1) = q_ad(i, -1) + 0.5*al_ad(i, 0)
            q_ad(i, 0) = q_ad(i, 0) + 0.5*al_ad(i, 0)
            dm_ad(i, -1) = dm_ad(i, -1) + r3*al_ad(i, 0)
            dm_ad(i, 0) = dm_ad(i, 0) - r3*al_ad(i, 0)
            al_ad(i, 0) = 0.0_FVPRC
            CALL POPREALARRAY_ADM(dm(i, 0))
            min2_ad = SIGN(1.d0, min2*dm(i, 0))*dm_ad(i, 0)
            dm_ad(i, 0) = 0.0_FVPRC
            CALL POPCONTROL2B(branch)
            IF (branch .LT. 2) THEN
              IF (branch .EQ. 0) THEN
                CALL POPREALARRAY_ADM(min2)
                z2_ad = min2_ad
                y2_ad = 0.0_FVPRC
              ELSE
                CALL POPREALARRAY_ADM(min2)
                y2_ad = min2_ad
                z2_ad = 0.0_FVPRC
              END IF
              x3_ad = 0.0_FVPRC
            ELSE
              IF (branch .EQ. 2) THEN
                CALL POPREALARRAY_ADM(min2)
                z2_ad = min2_ad
                x3_ad = 0.0_FVPRC
              ELSE
                CALL POPREALARRAY_ADM(min2)
                x3_ad = min2_ad
                z2_ad = 0.0_FVPRC
              END IF
              y2_ad = 0.0_FVPRC
            END IF
            q_ad(i, 0) = q_ad(i, 0) + z2_ad
            min21_ad = -z2_ad
            CALL POPCONTROL2B(branch)
            IF (branch .LT. 2) THEN
              IF (branch .EQ. 0) THEN
                x1_ad = min21_ad
              ELSE
                x0_ad = x0_ad + min21_ad
                x1_ad = 0.0_FVPRC
              END IF
            ELSE IF (branch .EQ. 2) THEN
              x1_ad = min21_ad
            ELSE
              q_ad(i, 0) = q_ad(i, 0) + min21_ad
              x1_ad = 0.0_FVPRC
            END IF
            max4_ad = y2_ad
            q_ad(i, 0) = q_ad(i, 0) - y2_ad
            CALL POPCONTROL2B(branch)
            IF (branch .LT. 2) THEN
              IF (branch .EQ. 0) THEN
                x1_ad = x1_ad + max4_ad
              ELSE
                x0_ad = x0_ad + max4_ad
              END IF
            ELSE IF (branch .EQ. 2) THEN
              x1_ad = x1_ad + max4_ad
            ELSE
              q_ad(i, 0) = q_ad(i, 0) + max4_ad
            END IF
            CALL POPCONTROL1B(branch)
            IF (branch .EQ. 0) THEN
              dm_ad(i, 0) = dm_ad(i, 0) + x3_ad
            ELSE
              dm_ad(i, 0) = dm_ad(i, 0) - x3_ad
            END IF
            x0_ad = x0_ad + al_ad(i, 1) + 0.5*dm_ad(i, 0)
            x1_ad = x1_ad - 0.5*dm_ad(i, 0)
            dm_ad(i, 0) = 0.0_FVPRC
            q_ad(i, 0) = q_ad(i, 0) + s15*x1_ad
            q_ad(i, -1) = q_ad(i, -1) + s11*x1_ad
            dm_ad(i, -1) = dm_ad(i, -1) + s14*x1_ad
            al_ad(i, 1) = 0.0_FVPRC
            x0l_ad = x0_ad
            x0r_ad = x0_ad
            temp_ad = 0.5*x0r_ad/(dya(i, 1)+dya(i, 2))
            q_ad(i, 1) = q_ad(i, 1) + (dya(i, 1)*2.+dya(i, 2))*temp_ad
            q_ad(i, 2) = q_ad(i, 2) - dya(i, 1)*temp_ad
            temp_ad0 = 0.5*x0l_ad/(dya(i, 0)+dya(i, -1))
            q_ad(i, 0) = q_ad(i, 0) + (dya(i, 0)*2.+dya(i, -1))*temp_ad0
            q_ad(i, -1) = q_ad(i, -1) - dya(i, 0)*temp_ad0
          END DO
        END IF
      ELSE IF (branch .NE. 2) THEN
        DO j=je+2,js-1,-1
          DO i=ilast,ifirst,-1
            q_ad(i, j-1) = q_ad(i, j-1) + 0.5*al_ad(i, j)
            q_ad(i, j) = q_ad(i, j) + 0.5*al_ad(i, j)
            dm_ad(i, j-1) = dm_ad(i, j-1) + r3*al_ad(i, j)
            dm_ad(i, j) = dm_ad(i, j) - r3*al_ad(i, j)
            al_ad(i, j) = 0.0_FVPRC
          END DO
        END DO
        GOTO 100
      END IF
      DO j=min20,max1,-1
        DO i=ilast,ifirst,-1
          q_ad(i, j-1) = q_ad(i, j-1) + 0.5*al_ad(i, j)
          q_ad(i, j) = q_ad(i, j) + 0.5*al_ad(i, j)
          dm_ad(i, j-1) = dm_ad(i, j-1) + r3*al_ad(i, j)
          dm_ad(i, j) = dm_ad(i, j) - r3*al_ad(i, j)
          al_ad(i, j) = 0.0_FVPRC
        END DO
      END DO
 100  DO j=je+2,js-2,-1
        DO i=ilast,ifirst,-1
          xt = 0.25*(q(i, j+1)-q(i, j-1))
          min1_ad = SIGN(1.d0, min1*xt)*dm_ad(i, j)
          dm_ad(i, j) = 0.0_FVPRC
          CALL POPCONTROL2B(branch)
          IF (branch .LT. 2) THEN
            IF (branch .EQ. 0) THEN
              CALL POPREALARRAY_ADM(min1)
              z1_ad = min1_ad
              y1_ad = 0.0_FVPRC
            ELSE
              CALL POPREALARRAY_ADM(min1)
              y1_ad = min1_ad
              z1_ad = 0.0_FVPRC
            END IF
            x2_ad = 0.0_FVPRC
          ELSE
            IF (branch .EQ. 2) THEN
              CALL POPREALARRAY_ADM(min1)
              z1_ad = min1_ad
              x2_ad = 0.0_FVPRC
            ELSE
              CALL POPREALARRAY_ADM(min1)
              x2_ad = min1_ad
              z1_ad = 0.0_FVPRC
            END IF
            y1_ad = 0.0_FVPRC
          END IF
          q_ad(i, j) = q_ad(i, j) + z1_ad
          min19_ad = -z1_ad
          CALL POPCONTROL2B(branch)
          IF (branch .LT. 2) THEN
            IF (branch .EQ. 0) THEN
              q_ad(i, j+1) = q_ad(i, j+1) + min19_ad
            ELSE
              q_ad(i, j) = q_ad(i, j) + min19_ad
            END IF
          ELSE IF (branch .EQ. 2) THEN
            q_ad(i, j+1) = q_ad(i, j+1) + min19_ad
          ELSE
            q_ad(i, j-1) = q_ad(i, j-1) + min19_ad
          END IF
          max3_ad = y1_ad
          q_ad(i, j) = q_ad(i, j) - y1_ad
          CALL POPCONTROL2B(branch)
          IF (branch .LT. 2) THEN
            IF (branch .EQ. 0) THEN
              q_ad(i, j+1) = q_ad(i, j+1) + max3_ad
            ELSE
              q_ad(i, j) = q_ad(i, j) + max3_ad
            END IF
          ELSE IF (branch .EQ. 2) THEN
            q_ad(i, j+1) = q_ad(i, j+1) + max3_ad
          ELSE
            q_ad(i, j-1) = q_ad(i, j-1) + max3_ad
          END IF
          CALL POPCONTROL1B(branch)
          IF (branch .EQ. 0) THEN
            xt_ad = x2_ad
          ELSE
            xt_ad = -x2_ad
          END IF
          q_ad(i, j+1) = q_ad(i, j+1) + 0.25*xt_ad
          q_ad(i, j-1) = q_ad(i, j-1) - 0.25*xt_ad
        END DO
      END DO
    ELSE IF (jord .EQ. 5) THEN
! PPM with Hunyh's 2nd constraint
      DO j=jfirst-3,jlast+2
        DO i=ifirst,ilast
          dq(i, j) = q(i, j+1) - q(i, j)
        END DO
      END DO
      DO j=jfirst-2,jlast+2
        DO i=ifirst,ilast
          xt = 0.25*(q(i, j+1)-q(i, j-1))
          IF (xt .GE. 0.) THEN
            x11 = xt
            CALL PUSHCONTROL1B(0)
          ELSE
            x11 = -xt
            CALL PUSHCONTROL1B(1)
          END IF
          IF (q(i, j-1) .LT. q(i, j)) THEN
            IF (q(i, j) .LT. q(i, j+1)) THEN
              max8 = q(i, j+1)
              CALL PUSHCONTROL2B(0)
            ELSE
              max8 = q(i, j)
              CALL PUSHCONTROL2B(1)
            END IF
          ELSE IF (q(i, j-1) .LT. q(i, j+1)) THEN
            max8 = q(i, j+1)
            CALL PUSHCONTROL2B(2)
          ELSE
            max8 = q(i, j-1)
            CALL PUSHCONTROL2B(3)
          END IF
          y10 = max8 - q(i, j)
          IF (q(i, j-1) .GT. q(i, j)) THEN
            IF (q(i, j) .GT. q(i, j+1)) THEN
              min25 = q(i, j+1)
              CALL PUSHCONTROL2B(0)
            ELSE
              min25 = q(i, j)
              CALL PUSHCONTROL2B(1)
            END IF
          ELSE IF (q(i, j-1) .GT. q(i, j+1)) THEN
            min25 = q(i, j+1)
            CALL PUSHCONTROL2B(2)
          ELSE
            min25 = q(i, j-1)
            CALL PUSHCONTROL2B(3)
          END IF
          z6 = q(i, j) - min25
          IF (x11 .GT. y10) THEN
            IF (y10 .GT. z6) THEN
              CALL PUSHREALARRAY_ADM(min10)
              min10 = z6
              CALL PUSHCONTROL2B(0)
            ELSE
              CALL PUSHREALARRAY_ADM(min10)
              min10 = y10
              CALL PUSHCONTROL2B(1)
            END IF
          ELSE IF (x11 .GT. z6) THEN
            CALL PUSHREALARRAY_ADM(min10)
            min10 = z6
            CALL PUSHCONTROL2B(2)
          ELSE
            CALL PUSHREALARRAY_ADM(min10)
            min10 = x11
            CALL PUSHCONTROL2B(3)
          END IF
          dm(i, j) = SIGN(min10, xt)
        END DO
      END DO
      DO j=jfirst-1,jlast+2
        DO i=ifirst,ilast
          al(i, j) = 0.5*(q(i, j-1)+q(i, j)) + r3*(dm(i, j-1)-dm(i, j))
        END DO
      END DO
      DO j=jfirst-1,jlast+1
        DO i=ifirst,ilast
          pmp = -(2.*dq(i, j))
          lac = pmp + 1.5*dq(i, j+1)
          IF (0. .LT. pmp) THEN
            IF (pmp .LT. lac) THEN
              x12 = lac
              CALL PUSHCONTROL2B(0)
            ELSE
              x12 = pmp
              CALL PUSHCONTROL2B(1)
            END IF
          ELSE IF (0. .LT. lac) THEN
            x12 = lac
            CALL PUSHCONTROL2B(2)
          ELSE
            CALL PUSHCONTROL2B(3)
            x12 = 0.
          END IF
          IF (0. .GT. pmp) THEN
            IF (pmp .GT. lac) THEN
              y33 = lac
              CALL PUSHCONTROL2B(0)
            ELSE
              y33 = pmp
              CALL PUSHCONTROL2B(1)
            END IF
          ELSE IF (0. .GT. lac) THEN
            y33 = lac
            CALL PUSHCONTROL2B(2)
          ELSE
            y33 = 0.
            CALL PUSHCONTROL2B(3)
          END IF
          IF (al(i, j) - q(i, j) .LT. y33) THEN
            y11 = y33
            CALL PUSHCONTROL1B(0)
          ELSE
            y11 = al(i, j) - q(i, j)
            CALL PUSHCONTROL1B(1)
          END IF
          IF (x12 .GT. y11) THEN
            bl(i, j) = y11
            CALL PUSHCONTROL1B(0)
          ELSE
            bl(i, j) = x12
            CALL PUSHCONTROL1B(1)
          END IF
          pmp = 2.*dq(i, j-1)
          lac = pmp - 1.5*dq(i, j-2)
          IF (0. .LT. pmp) THEN
            IF (pmp .LT. lac) THEN
              x13 = lac
              CALL PUSHCONTROL2B(0)
            ELSE
              x13 = pmp
              CALL PUSHCONTROL2B(1)
            END IF
          ELSE IF (0. .LT. lac) THEN
            x13 = lac
            CALL PUSHCONTROL2B(2)
          ELSE
            CALL PUSHCONTROL2B(3)
            x13 = 0.
          END IF
          IF (0. .GT. pmp) THEN
            IF (pmp .GT. lac) THEN
              y34 = lac
              CALL PUSHCONTROL2B(0)
            ELSE
              y34 = pmp
              CALL PUSHCONTROL2B(1)
            END IF
          ELSE IF (0. .GT. lac) THEN
            y34 = lac
            CALL PUSHCONTROL2B(2)
          ELSE
            y34 = 0.
            CALL PUSHCONTROL2B(3)
          END IF
          IF (al(i, j+1) - q(i, j) .LT. y34) THEN
            y12 = y34
            CALL PUSHCONTROL1B(0)
          ELSE
            y12 = al(i, j+1) - q(i, j)
            CALL PUSHCONTROL1B(1)
          END IF
          IF (x13 .GT. y12) THEN
            br(i, j) = y12
            CALL PUSHCONTROL1B(0)
          ELSE
            br(i, j) = x13
            CALL PUSHCONTROL1B(1)
          END IF
        END DO
      END DO
      DO j=jfirst,jlast+1
        DO i=ifirst,ilast
          IF (c(i, j) .GT. 0.) THEN
            CALL PUSHCONTROL1B(1)
          ELSE
            CALL PUSHCONTROL1B(0)
          END IF
        END DO
      END DO
      bl_ad = 0.0_FVPRC
      br_ad = 0.0_FVPRC
      DO j=jlast+1,jfirst,-1
        DO i=ilast,ifirst,-1
          CALL POPCONTROL1B(branch)
          IF (branch .EQ. 0) THEN
            temp2 = bl(i, j) + br(i, j)
            temp_ad13 = (c(i, j)+1.)*flux_ad(i, j)
            temp_ad14 = c(i, j)*temp_ad13
            q_ad(i, j) = q_ad(i, j) + flux_ad(i, j)
            c_ad(i, j) = c_ad(i, j) + temp2*temp_ad13 + (bl(i, j)+c(i, j&
&             )*temp2)*flux_ad(i, j)
            bl_ad(i, j) = bl_ad(i, j) + temp_ad14 + temp_ad13
            br_ad(i, j) = br_ad(i, j) + temp_ad14
            flux_ad(i, j) = 0.0_FVPRC
          ELSE
            temp1 = bl(i, j-1) + br(i, j-1)
            temp_ad11 = (1.-c(i, j))*flux_ad(i, j)
            temp_ad12 = -(c(i, j)*temp_ad11)
            q_ad(i, j-1) = q_ad(i, j-1) + flux_ad(i, j)
            c_ad(i, j) = c_ad(i, j) - temp1*temp_ad11 - (br(i, j-1)-c(i&
&             , j)*temp1)*flux_ad(i, j)
            br_ad(i, j-1) = br_ad(i, j-1) + temp_ad12 + temp_ad11
            bl_ad(i, j-1) = bl_ad(i, j-1) + temp_ad12
            flux_ad(i, j) = 0.0_FVPRC
          END IF
        END DO
      END DO
      dq_ad = 0.0_FVPRC
      al_ad = 0.0_FVPRC
      DO j=jlast+1,jfirst-1,-1
        DO i=ilast,ifirst,-1
          CALL POPCONTROL1B(branch)
          IF (branch .EQ. 0) THEN
            y12_ad = br_ad(i, j)
            br_ad(i, j) = 0.0_FVPRC
            x13_ad = 0.0_FVPRC
          ELSE
            x13_ad = br_ad(i, j)
            br_ad(i, j) = 0.0_FVPRC
            y12_ad = 0.0_FVPRC
          END IF
          CALL POPCONTROL1B(branch)
          IF (branch .EQ. 0) THEN
            y34_ad = y12_ad
          ELSE
            al_ad(i, j+1) = al_ad(i, j+1) + y12_ad
            q_ad(i, j) = q_ad(i, j) - y12_ad
            y34_ad = 0.0_FVPRC
          END IF
          CALL POPCONTROL2B(branch)
          IF (branch .LT. 2) THEN
            IF (branch .EQ. 0) THEN
              lac_ad = y34_ad
              pmp_ad = 0.0_FVPRC
            ELSE
              pmp_ad = y34_ad
              lac_ad = 0.0_FVPRC
            END IF
          ELSE
            IF (branch .EQ. 2) THEN
              lac_ad = y34_ad
            ELSE
              lac_ad = 0.0_FVPRC
            END IF
            pmp_ad = 0.0_FVPRC
          END IF
          CALL POPCONTROL2B(branch)
          IF (branch .LT. 2) THEN
            IF (branch .EQ. 0) THEN
              lac_ad = lac_ad + x13_ad
            ELSE
              pmp_ad = pmp_ad + x13_ad
            END IF
          ELSE IF (branch .EQ. 2) THEN
            lac_ad = lac_ad + x13_ad
          END IF
          pmp_ad = pmp_ad + lac_ad
          dq_ad(i, j-2) = dq_ad(i, j-2) - 1.5*lac_ad
          dq_ad(i, j-1) = dq_ad(i, j-1) + 2.*pmp_ad
          CALL POPCONTROL1B(branch)
          IF (branch .EQ. 0) THEN
            y11_ad = bl_ad(i, j)
            bl_ad(i, j) = 0.0_FVPRC
            x12_ad = 0.0_FVPRC
          ELSE
            x12_ad = bl_ad(i, j)
            bl_ad(i, j) = 0.0_FVPRC
            y11_ad = 0.0_FVPRC
          END IF
          CALL POPCONTROL1B(branch)
          IF (branch .EQ. 0) THEN
            y33_ad = y11_ad
          ELSE
            al_ad(i, j) = al_ad(i, j) + y11_ad
            q_ad(i, j) = q_ad(i, j) - y11_ad
            y33_ad = 0.0_FVPRC
          END IF
          CALL POPCONTROL2B(branch)
          IF (branch .LT. 2) THEN
            IF (branch .EQ. 0) THEN
              lac_ad = y33_ad
              pmp_ad = 0.0_FVPRC
            ELSE
              pmp_ad = y33_ad
              lac_ad = 0.0_FVPRC
            END IF
          ELSE
            IF (branch .EQ. 2) THEN
              lac_ad = y33_ad
            ELSE
              lac_ad = 0.0_FVPRC
            END IF
            pmp_ad = 0.0_FVPRC
          END IF
          CALL POPCONTROL2B(branch)
          IF (branch .LT. 2) THEN
            IF (branch .EQ. 0) THEN
              lac_ad = lac_ad + x12_ad
            ELSE
              pmp_ad = pmp_ad + x12_ad
            END IF
          ELSE IF (branch .EQ. 2) THEN
            lac_ad = lac_ad + x12_ad
          END IF
          pmp_ad = pmp_ad + lac_ad
          dq_ad(i, j+1) = dq_ad(i, j+1) + 1.5*lac_ad
          dq_ad(i, j) = dq_ad(i, j) - 2.*pmp_ad
        END DO
      END DO
      dm_ad = 0.0_FVPRC
      DO j=jlast+2,jfirst-1,-1
        DO i=ilast,ifirst,-1
          q_ad(i, j-1) = q_ad(i, j-1) + 0.5*al_ad(i, j)
          q_ad(i, j) = q_ad(i, j) + 0.5*al_ad(i, j)
          dm_ad(i, j-1) = dm_ad(i, j-1) + r3*al_ad(i, j)
          dm_ad(i, j) = dm_ad(i, j) - r3*al_ad(i, j)
          al_ad(i, j) = 0.0_FVPRC
        END DO
      END DO
      DO j=jlast+2,jfirst-2,-1
        DO i=ilast,ifirst,-1
          xt = 0.25*(q(i, j+1)-q(i, j-1))
          min10_ad = SIGN(1.d0, min10*xt)*dm_ad(i, j)
          dm_ad(i, j) = 0.0_FVPRC
          CALL POPCONTROL2B(branch)
          IF (branch .LT. 2) THEN
            IF (branch .EQ. 0) THEN
              CALL POPREALARRAY_ADM(min10)
              z6_ad = min10_ad
              y10_ad = 0.0_FVPRC
            ELSE
              CALL POPREALARRAY_ADM(min10)
              y10_ad = min10_ad
              z6_ad = 0.0_FVPRC
            END IF
            x11_ad = 0.0_FVPRC
          ELSE
            IF (branch .EQ. 2) THEN
              CALL POPREALARRAY_ADM(min10)
              z6_ad = min10_ad
              x11_ad = 0.0_FVPRC
            ELSE
              CALL POPREALARRAY_ADM(min10)
              x11_ad = min10_ad
              z6_ad = 0.0_FVPRC
            END IF
            y10_ad = 0.0_FVPRC
          END IF
          q_ad(i, j) = q_ad(i, j) + z6_ad
          min25_ad = -z6_ad
          CALL POPCONTROL2B(branch)
          IF (branch .LT. 2) THEN
            IF (branch .EQ. 0) THEN
              q_ad(i, j+1) = q_ad(i, j+1) + min25_ad
            ELSE
              q_ad(i, j) = q_ad(i, j) + min25_ad
            END IF
          ELSE IF (branch .EQ. 2) THEN
            q_ad(i, j+1) = q_ad(i, j+1) + min25_ad
          ELSE
            q_ad(i, j-1) = q_ad(i, j-1) + min25_ad
          END IF
          max8_ad = y10_ad
          q_ad(i, j) = q_ad(i, j) - y10_ad
          CALL POPCONTROL2B(branch)
          IF (branch .LT. 2) THEN
            IF (branch .EQ. 0) THEN
              q_ad(i, j+1) = q_ad(i, j+1) + max8_ad
            ELSE
              q_ad(i, j) = q_ad(i, j) + max8_ad
            END IF
          ELSE IF (branch .EQ. 2) THEN
            q_ad(i, j+1) = q_ad(i, j+1) + max8_ad
          ELSE
            q_ad(i, j-1) = q_ad(i, j-1) + max8_ad
          END IF
          CALL POPCONTROL1B(branch)
          IF (branch .EQ. 0) THEN
            xt_ad = x11_ad
          ELSE
            xt_ad = -x11_ad
          END IF
          q_ad(i, j+1) = q_ad(i, j+1) + 0.25*xt_ad
          q_ad(i, j-1) = q_ad(i, j-1) - 0.25*xt_ad
        END DO
      END DO
      DO j=jlast+2,jfirst-3,-1
        DO i=ilast,ifirst,-1
          q_ad(i, j+1) = q_ad(i, j+1) + dq_ad(i, j)
          q_ad(i, j) = q_ad(i, j) - dq_ad(i, j)
          dq_ad(i, j) = 0.0_FVPRC
        END DO
      END DO
    ELSE IF (jord .EQ. 6 .OR. jord .EQ. 7) THEN
      IF (jord .EQ. 6) THEN
        IF (3 .LT. js - 1) THEN
          max2 = js - 1
        ELSE
          max2 = 3
        END IF
        IF (npy - 3 .GT. je + 1) THEN
          min26 = je + 1
        ELSE
          min26 = npy - 3
        END IF
!#ifdef UN_PPM
!   do j=jfirst-1,jlast+2
!      do i=ifirst,ilast
!         al(i,j) = p1*(q(i,j-1)+q(i,j)) + p2*(q(i,j-2)+q(i,j+1))
!      enddo
!   enddo
!   do j=max(3,js-1),min(npy-3,je+1)
!      do i=ifirst,ilast
!         bl(i,j) = al(i,j  ) - q(i,j)
!         br(i,j) = al(i,j+1) - q(i,j)
!      enddo
!   enddo
!#else
        DO j=max2,min26
          DO i=ifirst,ilast
            bl(i, j) = b5*q(i, j-2) + b4*q(i, j-1) + b3*q(i, j) + b2*q(i&
&             , j+1) + b1*q(i, j+2)
            br(i, j) = b1*q(i, j-2) + b2*q(i, j-1) + b3*q(i, j) + b4*q(i&
&             , j+1) + b5*q(i, j+2)
          END DO
        END DO
        CALL PUSHCONTROL1B(0)
      ELSE
!#endif
        DO j=js-3,je+2
          DO i=ifirst,ilast
            dq(i, j) = q(i, j+1) - q(i, j)
          END DO
        END DO
        DO j=js-2,je+2
          DO i=ifirst,ilast
            IF (dq(i, j-1)*dq(i, j) .GT. 0.) THEN
              CALL PUSHCONTROL1B(1)
              extm(i, j) = .false.
            ELSE
              CALL PUSHCONTROL1B(0)
              extm(i, j) = .true.
            END IF
          END DO
        END DO
        DO j=js3,je3
!do j=max(3,js-1),min(npy-3,je+1)
          DO i=ifirst,ilast
            IF (extm(i, j-1) .AND. extm(i, j) .AND. extm(i, j+1)) THEN
! 2-delta-wave filter
              bl(i, j) = 0.
              br(i, j) = 0.
              CALL PUSHCONTROL1B(1)
            ELSE
              bl(i, j) = b5*q(i, j-2) + b4*q(i, j-1) + b3*q(i, j) + b2*q&
&               (i, j+1) + b1*q(i, j+2)
              br(i, j) = b1*q(i, j-2) + b2*q(i, j-1) + b3*q(i, j) + b4*q&
&               (i, j+1) + b5*q(i, j+2)
              CALL PUSHCONTROL1B(0)
            END IF
          END DO
        END DO
        CALL PUSHCONTROL1B(1)
      END IF
      IF (js .EQ. 1 .AND. (.NOT.nested)) THEN
        DO i=ifirst,ilast
!           br(i,2) = al(i,3) - q(i,2)
          br(i, 2) = p1*(q(i, 2)+q(i, 3)) + p2*(q(i, 1)+q(i, 4)) - q(i, &
&           2)
          x0l = 0.5*((2.*dya(i, 0)+dya(i, -1))*q(i, 0)-dya(i, 0)*q(i, -1&
&           ))/(dya(i, 0)+dya(i, -1))
          x0r = 0.5*((2.*dya(i, 1)+dya(i, 2))*q(i, 1)-dya(i, 1)*q(i, 2))&
&           /(dya(i, 1)+dya(i, 2))
          xt = x0l + x0r
!            xt = ( x0L*gridstruct%sin_sg(i,0,4) + x0R*gridstruct%sin_sg(i,1,2) ) 
!            xt = 2.*xt / ( gridstruct%sin_sg(i,0,4) + gridstruct%sin_sg(i,1,2) )
          bl(i, 1) = xt - q(i, 1)
          br(i, 0) = xt - q(i, 0)
!           xt = s14*0.25*(q(i,0)-q(i,-2)) - s11*(q(i,0)-q(i,-1)) + q(i,0)
          xt = c1*q(i, -2) + c2*q(i, -1) + c3*q(i, 0)
!#ifdef DO_MONO_EDGE
!            xt = min( xt, max(q(i,-1), q(i,0)) )
!            xt = max( xt, min(q(i,-1), q(i,0)) )
!#endif
          bl(i, 0) = xt - q(i, 0)
!           xt = s15*q(i,1) + s11*q(i,2) - s14*0.25*(q(i,3)-q(i,1))
          xt = c3*q(i, 1) + c2*q(i, 2) + c1*q(i, 3)
!#ifdef DO_MONO_EDGE
!            xt = min( xt, max(q(i,1), q(i,2)) )
!            xt = max( xt, min(q(i,1), q(i,2)) )
!#endif
          br(i, 1) = xt - q(i, 1)
          bl(i, 2) = xt - q(i, 2)
        END DO
        CALL PUSHCONTROL1B(0)
      ELSE
        CALL PUSHCONTROL1B(1)
      END IF
      IF (je + 1 .EQ. npy .AND. (.NOT.nested)) THEN
        DO i=ifirst,ilast
!           bl(i,npy-2) = al(i,npy-2) - q(i,npy-2)
          bl(i, npy-2) = p1*(q(i, npy-3)+q(i, npy-2)) + p2*(q(i, npy-4)+&
&           q(i, npy-1)) - q(i, npy-2)
          x0l = 0.5*((2.*dya(i, npy-1)+dya(i, npy-2))*q(i, npy-1)-dya(i&
&           , npy-1)*q(i, npy-2))/(dya(i, npy-1)+dya(i, npy-2))
          x0r = 0.5*((2.*dya(i, npy)+dya(i, npy+1))*q(i, npy)-dya(i, npy&
&           )*q(i, npy+1))/(dya(i, npy)+dya(i, npy+1))
          xt = x0l + x0r
!            xt = x0L*gridstruct%sin_sg(i,npy-1,4) + x0R*gridstruct%sin_sg(i,npy,2)
!            xt = 2.*xt /( gridstruct%sin_sg(i,npy-1,4) + gridstruct%sin_sg(i,npy,2) )
          br(i, npy-1) = xt - q(i, npy-1)
          bl(i, npy) = xt - q(i, npy)
!           xt = s11*(q(i,npy+1)-q(i,npy)) - s14*0.25*(q(i,npy+2)-q(i,npy)) + q(i,npy)
          xt = c3*q(i, npy) + c2*q(i, npy+1) + c1*q(i, npy+2)
!#ifdef DO_MONO_EDGE
!            xt = min( xt, max(q(i,npy), q(i,npy+1)) )
!            xt = max( xt, min(q(i,npy), q(i,npy+1)) )
!#endif
          br(i, npy) = xt - q(i, npy)
!           xt = s15*q(i,npy-1) + s11*q(i,npy-2) + s14*0.25*(q(i,npy-1)-q(i,npy-3))
          xt = c1*q(i, npy-3) + c2*q(i, npy-2) + c3*q(i, npy-1)
!#ifdef DO_MONO_EDGE
!            xt = min( xt, max(q(i,npy-2), q(i,npy-1)) )
!            xt = max( xt, min(q(i,npy-2), q(i,npy-1)) )
!#endif
          br(i, npy-2) = xt - q(i, npy-2)
          bl(i, npy-1) = xt - q(i, npy-1)
        END DO
        CALL PUSHCONTROL1B(0)
      ELSE
        CALL PUSHCONTROL1B(1)
      END IF
! Positive definite constraint:
      IF (jord .EQ. 7) THEN
        DO j=jfirst-1,jlast+1
          arg1 = ilast - ifirst + 1
          CALL PUSHREALARRAY_ADM(br(ifirst, j), 8*(ilast-ifirst+1)/8)
          CALL PUSHREALARRAY_ADM(bl(ifirst, j), 8*(ilast-ifirst+1)/8)
          CALL PERT_PPM(arg1, q(ifirst, j), bl(ifirst, j), br(ifirst, j)&
&                 , 0)
        END DO
        CALL PUSHCONTROL1B(1)
      ELSE
        CALL PUSHCONTROL1B(0)
      END IF
      DO j=jfirst,jlast+1
        DO i=ifirst,ilast
          IF (c(i, j) .GT. 0.) THEN
            CALL PUSHCONTROL1B(1)
          ELSE
            CALL PUSHCONTROL1B(0)
          END IF
        END DO
      END DO
      bl_ad = 0.0_FVPRC
      br_ad = 0.0_FVPRC
      DO j=jlast+1,jfirst,-1
        DO i=ilast,ifirst,-1
          CALL POPCONTROL1B(branch)
          IF (branch .EQ. 0) THEN
            temp4 = bl(i, j) + br(i, j)
            temp_ad21 = (c(i, j)+1.)*flux_ad(i, j)
            temp_ad22 = c(i, j)*temp_ad21
            q_ad(i, j) = q_ad(i, j) + flux_ad(i, j)
            c_ad(i, j) = c_ad(i, j) + temp4*temp_ad21 + (bl(i, j)+c(i, j&
&             )*temp4)*flux_ad(i, j)
            bl_ad(i, j) = bl_ad(i, j) + temp_ad22 + temp_ad21
            br_ad(i, j) = br_ad(i, j) + temp_ad22
            flux_ad(i, j) = 0.0_FVPRC
          ELSE
            temp3 = bl(i, j-1) + br(i, j-1)
            temp_ad19 = (1.-c(i, j))*flux_ad(i, j)
            temp_ad20 = -(c(i, j)*temp_ad19)
            q_ad(i, j-1) = q_ad(i, j-1) + flux_ad(i, j)
            c_ad(i, j) = c_ad(i, j) - temp3*temp_ad19 - (br(i, j-1)-c(i&
&             , j)*temp3)*flux_ad(i, j)
            br_ad(i, j-1) = br_ad(i, j-1) + temp_ad20 + temp_ad19
            bl_ad(i, j-1) = bl_ad(i, j-1) + temp_ad20
            flux_ad(i, j) = 0.0_FVPRC
          END IF
        END DO
      END DO
      CALL POPCONTROL1B(branch)
      IF (branch .NE. 0) THEN
        DO j=jlast+1,jfirst-1,-1
          arg1 = ilast - ifirst + 1
          CALL POPREALARRAY_ADM(bl(ifirst, j), 8*(ilast-ifirst+1)/8)
          CALL POPREALARRAY_ADM(br(ifirst, j), 8*(ilast-ifirst+1)/8)
          CALL PERT_PPM_ADM(arg1, q(ifirst, j), bl(ifirst:, j), bl_ad(&
&                     ifirst:, j), br(ifirst:, j), br_ad(ifirst:, j), 0)
        END DO
      END IF
      CALL POPCONTROL1B(branch)
      IF (branch .EQ. 0) THEN
        DO i=ilast,ifirst,-1
          xt_ad = br_ad(i, npy-2) + bl_ad(i, npy-1)
          q_ad(i, npy-1) = q_ad(i, npy-1) - bl_ad(i, npy-1)
          bl_ad(i, npy-1) = 0.0_FVPRC
          q_ad(i, npy-2) = q_ad(i, npy-2) - br_ad(i, npy-2)
          br_ad(i, npy-2) = 0.0_FVPRC
          q_ad(i, npy-3) = q_ad(i, npy-3) + c1*xt_ad
          q_ad(i, npy-2) = q_ad(i, npy-2) + c2*xt_ad
          q_ad(i, npy-1) = q_ad(i, npy-1) + c3*xt_ad
          xt_ad = br_ad(i, npy)
          q_ad(i, npy) = q_ad(i, npy) + c3*xt_ad - br_ad(i, npy)
          br_ad(i, npy) = 0.0_FVPRC
          q_ad(i, npy+1) = q_ad(i, npy+1) + c2*xt_ad
          q_ad(i, npy+2) = q_ad(i, npy+2) + c1*xt_ad
          xt_ad = br_ad(i, npy-1) + bl_ad(i, npy)
          q_ad(i, npy) = q_ad(i, npy) - bl_ad(i, npy)
          bl_ad(i, npy) = 0.0_FVPRC
          q_ad(i, npy-1) = q_ad(i, npy-1) - br_ad(i, npy-1)
          br_ad(i, npy-1) = 0.0_FVPRC
          x0l_ad = xt_ad
          x0r_ad = xt_ad
          temp_ad17 = 0.5*x0r_ad/(dya(i, npy)+dya(i, npy+1))
          q_ad(i, npy) = q_ad(i, npy) + (dya(i, npy)*2.+dya(i, npy+1))*&
&           temp_ad17
          q_ad(i, npy+1) = q_ad(i, npy+1) - dya(i, npy)*temp_ad17
          temp_ad18 = 0.5*x0l_ad/(dya(i, npy-1)+dya(i, npy-2))
          q_ad(i, npy-1) = q_ad(i, npy-1) + (dya(i, npy-1)*2.+dya(i, npy&
&           -2))*temp_ad18
          q_ad(i, npy-2) = q_ad(i, npy-2) - dya(i, npy-1)*temp_ad18
          q_ad(i, npy-3) = q_ad(i, npy-3) + p1*bl_ad(i, npy-2)
          q_ad(i, npy-2) = q_ad(i, npy-2) + (p1-1.0)*bl_ad(i, npy-2)
          q_ad(i, npy-4) = q_ad(i, npy-4) + p2*bl_ad(i, npy-2)
          q_ad(i, npy-1) = q_ad(i, npy-1) + p2*bl_ad(i, npy-2)
          bl_ad(i, npy-2) = 0.0_FVPRC
        END DO
      END IF
      CALL POPCONTROL1B(branch)
      IF (branch .EQ. 0) THEN
        DO i=ilast,ifirst,-1
          xt_ad = br_ad(i, 1) + bl_ad(i, 2)
          q_ad(i, 2) = q_ad(i, 2) - bl_ad(i, 2)
          bl_ad(i, 2) = 0.0_FVPRC
          q_ad(i, 1) = q_ad(i, 1) + c3*xt_ad - br_ad(i, 1)
          br_ad(i, 1) = 0.0_FVPRC
          q_ad(i, 2) = q_ad(i, 2) + c2*xt_ad
          q_ad(i, 3) = q_ad(i, 3) + c1*xt_ad
          xt_ad = bl_ad(i, 0)
          q_ad(i, 0) = q_ad(i, 0) - bl_ad(i, 0)
          bl_ad(i, 0) = 0.0_FVPRC
          q_ad(i, -2) = q_ad(i, -2) + c1*xt_ad
          q_ad(i, -1) = q_ad(i, -1) + c2*xt_ad
          q_ad(i, 0) = q_ad(i, 0) + c3*xt_ad - br_ad(i, 0)
          xt_ad = bl_ad(i, 1) + br_ad(i, 0)
          br_ad(i, 0) = 0.0_FVPRC
          x0l_ad = xt_ad
          x0r_ad = xt_ad
          temp_ad15 = 0.5*x0r_ad/(dya(i, 1)+dya(i, 2))
          q_ad(i, 1) = q_ad(i, 1) + (dya(i, 1)*2.+dya(i, 2))*temp_ad15 -&
&           bl_ad(i, 1)
          bl_ad(i, 1) = 0.0_FVPRC
          q_ad(i, 2) = q_ad(i, 2) - dya(i, 1)*temp_ad15
          temp_ad16 = 0.5*x0l_ad/(dya(i, 0)+dya(i, -1))
          q_ad(i, 0) = q_ad(i, 0) + (dya(i, 0)*2.+dya(i, -1))*temp_ad16
          q_ad(i, -1) = q_ad(i, -1) - dya(i, 0)*temp_ad16
          q_ad(i, 2) = q_ad(i, 2) + (p1-1.0)*br_ad(i, 2)
          q_ad(i, 3) = q_ad(i, 3) + p1*br_ad(i, 2)
          q_ad(i, 1) = q_ad(i, 1) + p2*br_ad(i, 2)
          q_ad(i, 4) = q_ad(i, 4) + p2*br_ad(i, 2)
          br_ad(i, 2) = 0.0_FVPRC
        END DO
      END IF
      CALL POPCONTROL1B(branch)
      IF (branch .EQ. 0) THEN
        DO j=min26,max2,-1
          DO i=ilast,ifirst,-1
            q_ad(i, j-2) = q_ad(i, j-2) + b1*br_ad(i, j)
            q_ad(i, j-1) = q_ad(i, j-1) + b2*br_ad(i, j)
            q_ad(i, j) = q_ad(i, j) + b3*br_ad(i, j)
            q_ad(i, j+1) = q_ad(i, j+1) + b4*br_ad(i, j)
            q_ad(i, j+2) = q_ad(i, j+2) + b5*br_ad(i, j)
            br_ad(i, j) = 0.0_FVPRC
            q_ad(i, j-2) = q_ad(i, j-2) + b5*bl_ad(i, j)
            q_ad(i, j-1) = q_ad(i, j-1) + b4*bl_ad(i, j)
            q_ad(i, j) = q_ad(i, j) + b3*bl_ad(i, j)
            q_ad(i, j+1) = q_ad(i, j+1) + b2*bl_ad(i, j)
            q_ad(i, j+2) = q_ad(i, j+2) + b1*bl_ad(i, j)
            bl_ad(i, j) = 0.0_FVPRC
          END DO
        END DO
      ELSE
        DO j=je3,js3,-1
          DO i=ilast,ifirst,-1
            CALL POPCONTROL1B(branch)
            IF (branch .EQ. 0) THEN
              q_ad(i, j-2) = q_ad(i, j-2) + b1*br_ad(i, j)
              q_ad(i, j-1) = q_ad(i, j-1) + b2*br_ad(i, j)
              q_ad(i, j) = q_ad(i, j) + b3*br_ad(i, j)
              q_ad(i, j+1) = q_ad(i, j+1) + b4*br_ad(i, j)
              q_ad(i, j+2) = q_ad(i, j+2) + b5*br_ad(i, j)
              br_ad(i, j) = 0.0_FVPRC
              q_ad(i, j-2) = q_ad(i, j-2) + b5*bl_ad(i, j)
              q_ad(i, j-1) = q_ad(i, j-1) + b4*bl_ad(i, j)
              q_ad(i, j) = q_ad(i, j) + b3*bl_ad(i, j)
              q_ad(i, j+1) = q_ad(i, j+1) + b2*bl_ad(i, j)
              q_ad(i, j+2) = q_ad(i, j+2) + b1*bl_ad(i, j)
              bl_ad(i, j) = 0.0_FVPRC
            ELSE
              br_ad(i, j) = 0.0_FVPRC
              bl_ad(i, j) = 0.0_FVPRC
            END IF
          END DO
        END DO
        DO j=je+2,js-2,-1
          DO i=ilast,ifirst,-1
            CALL POPCONTROL1B(branch)
          END DO
        END DO
      END IF
    ELSE IF (jord .LE. 10) THEN
! jord=8, 9, 10
      DO j=js-2,je+2
        DO i=ifirst,ilast
          xt = 0.25*(q(i, j+1)-q(i, j-1))
          IF (xt .GE. 0.) THEN
            x14 = xt
            CALL PUSHCONTROL1B(0)
          ELSE
            x14 = -xt
            CALL PUSHCONTROL1B(1)
          END IF
          IF (q(i, j-1) .LT. q(i, j)) THEN
            IF (q(i, j) .LT. q(i, j+1)) THEN
              max9 = q(i, j+1)
              CALL PUSHCONTROL2B(0)
            ELSE
              max9 = q(i, j)
              CALL PUSHCONTROL2B(1)
            END IF
          ELSE IF (q(i, j-1) .LT. q(i, j+1)) THEN
            max9 = q(i, j+1)
            CALL PUSHCONTROL2B(2)
          ELSE
            max9 = q(i, j-1)
            CALL PUSHCONTROL2B(3)
          END IF
          y13 = max9 - q(i, j)
          IF (q(i, j-1) .GT. q(i, j)) THEN
            IF (q(i, j) .GT. q(i, j+1)) THEN
              min27 = q(i, j+1)
              CALL PUSHCONTROL2B(0)
            ELSE
              min27 = q(i, j)
              CALL PUSHCONTROL2B(1)
            END IF
          ELSE IF (q(i, j-1) .GT. q(i, j+1)) THEN
            min27 = q(i, j+1)
            CALL PUSHCONTROL2B(2)
          ELSE
            min27 = q(i, j-1)
            CALL PUSHCONTROL2B(3)
          END IF
          z7 = q(i, j) - min27
          IF (x14 .GT. y13) THEN
            IF (y13 .GT. z7) THEN
              CALL PUSHREALARRAY_ADM(min11)
              min11 = z7
              CALL PUSHCONTROL2B(0)
            ELSE
              CALL PUSHREALARRAY_ADM(min11)
              min11 = y13
              CALL PUSHCONTROL2B(1)
            END IF
          ELSE IF (x14 .GT. z7) THEN
            CALL PUSHREALARRAY_ADM(min11)
            min11 = z7
            CALL PUSHCONTROL2B(2)
          ELSE
            CALL PUSHREALARRAY_ADM(min11)
            min11 = x14
            CALL PUSHCONTROL2B(3)
          END IF
          dm(i, j) = SIGN(min11, xt)
        END DO
      END DO
      IF (grid_type .LT. 3) THEN
!      do j=max(3,js-1),min(npy-2,je+2)
        DO j=js3,je3+1
          DO i=ifirst,ilast
            al(i, j) = 0.5*(q(i, j-1)+q(i, j)) + r3*(dm(i, j-1)-dm(i, j)&
&             )
          END DO
        END DO
        DO j=js-3,je+2
          DO i=ifirst,ilast
            dq(i, j) = q(i, j+1) - q(i, j)
          END DO
        END DO
        IF (jord .EQ. 8) THEN
!         do j=max(3,js-1),min(npy-3,je+1) 
          DO j=js3,je3
            DO i=ifirst,ilast
              xt = 2.*dm(i, j)
              IF (xt .GE. 0.) THEN
                x15 = xt
                CALL PUSHCONTROL1B(0)
              ELSE
                x15 = -xt
                CALL PUSHCONTROL1B(1)
              END IF
              IF (al(i, j) - q(i, j) .GE. 0.) THEN
                y14 = al(i, j) - q(i, j)
                CALL PUSHCONTROL1B(0)
              ELSE
                y14 = -(al(i, j)-q(i, j))
                CALL PUSHCONTROL1B(1)
              END IF
              IF (x15 .GT. y14) THEN
                CALL PUSHREALARRAY_ADM(min12)
                min12 = y14
                CALL PUSHCONTROL1B(0)
              ELSE
                CALL PUSHREALARRAY_ADM(min12)
                min12 = x15
                CALL PUSHCONTROL1B(1)
              END IF
              bl(i, j) = -SIGN(min12, xt)
              IF (xt .GE. 0.) THEN
                x16 = xt
                CALL PUSHCONTROL1B(0)
              ELSE
                x16 = -xt
                CALL PUSHCONTROL1B(1)
              END IF
              IF (al(i, j+1) - q(i, j) .GE. 0.) THEN
                y15 = al(i, j+1) - q(i, j)
                CALL PUSHCONTROL1B(0)
              ELSE
                y15 = -(al(i, j+1)-q(i, j))
                CALL PUSHCONTROL1B(1)
              END IF
              IF (x16 .GT. y15) THEN
                CALL PUSHREALARRAY_ADM(min13)
                min13 = y15
                CALL PUSHCONTROL1B(0)
              ELSE
                CALL PUSHREALARRAY_ADM(min13)
                min13 = x16
                CALL PUSHCONTROL1B(1)
              END IF
              br(i, j) = SIGN(min13, xt)
            END DO
          END DO
          CALL PUSHCONTROL2B(0)
        ELSE IF (jord .EQ. 9) THEN
!         do j=max(3,js-1),min(npy-3,je+1) 
          DO j=js3,je3
            DO i=ifirst,ilast
              pmp_1 = -(2.*dq(i, j))
              lac_1 = pmp_1 + 1.5*dq(i, j+1)
              IF (0. .LT. pmp_1) THEN
                IF (pmp_1 .LT. lac_1) THEN
                  x17 = lac_1
                  CALL PUSHCONTROL2B(0)
                ELSE
                  x17 = pmp_1
                  CALL PUSHCONTROL2B(1)
                END IF
              ELSE IF (0. .LT. lac_1) THEN
                x17 = lac_1
                CALL PUSHCONTROL2B(2)
              ELSE
                CALL PUSHCONTROL2B(3)
                x17 = 0.
              END IF
              IF (0. .GT. pmp_1) THEN
                IF (pmp_1 .GT. lac_1) THEN
                  y35 = lac_1
                  CALL PUSHCONTROL2B(0)
                ELSE
                  y35 = pmp_1
                  CALL PUSHCONTROL2B(1)
                END IF
              ELSE IF (0. .GT. lac_1) THEN
                y35 = lac_1
                CALL PUSHCONTROL2B(2)
              ELSE
                y35 = 0.
                CALL PUSHCONTROL2B(3)
              END IF
              IF (al(i, j) - q(i, j) .LT. y35) THEN
                y16 = y35
                CALL PUSHCONTROL1B(0)
              ELSE
                y16 = al(i, j) - q(i, j)
                CALL PUSHCONTROL1B(1)
              END IF
              IF (x17 .GT. y16) THEN
                bl(i, j) = y16
                CALL PUSHCONTROL1B(0)
              ELSE
                bl(i, j) = x17
                CALL PUSHCONTROL1B(1)
              END IF
              pmp_2 = 2.*dq(i, j-1)
              lac_2 = pmp_2 - 1.5*dq(i, j-2)
              IF (0. .LT. pmp_2) THEN
                IF (pmp_2 .LT. lac_2) THEN
                  x18 = lac_2
                  CALL PUSHCONTROL2B(0)
                ELSE
                  x18 = pmp_2
                  CALL PUSHCONTROL2B(1)
                END IF
              ELSE IF (0. .LT. lac_2) THEN
                x18 = lac_2
                CALL PUSHCONTROL2B(2)
              ELSE
                CALL PUSHCONTROL2B(3)
                x18 = 0.
              END IF
              IF (0. .GT. pmp_2) THEN
                IF (pmp_2 .GT. lac_2) THEN
                  y36 = lac_2
                  CALL PUSHCONTROL2B(0)
                ELSE
                  y36 = pmp_2
                  CALL PUSHCONTROL2B(1)
                END IF
              ELSE IF (0. .GT. lac_2) THEN
                y36 = lac_2
                CALL PUSHCONTROL2B(2)
              ELSE
                y36 = 0.
                CALL PUSHCONTROL2B(3)
              END IF
              IF (al(i, j+1) - q(i, j) .LT. y36) THEN
                y17 = y36
                CALL PUSHCONTROL1B(0)
              ELSE
                y17 = al(i, j+1) - q(i, j)
                CALL PUSHCONTROL1B(1)
              END IF
              IF (x18 .GT. y17) THEN
                br(i, j) = y17
                CALL PUSHCONTROL1B(0)
              ELSE
                br(i, j) = x18
                CALL PUSHCONTROL1B(1)
              END IF
            END DO
          END DO
          CALL PUSHCONTROL2B(1)
        ELSE
! jord=10
!         do j=max(3,js-1),min(npy-3,je+1) 
          DO j=js3,je3
            DO i=ifirst,ilast
              bl(i, j) = al(i, j) - q(i, j)
              br(i, j) = al(i, j+1) - q(i, j)
              IF (dm(i, j-1) .GE. 0.) THEN
                abs0 = dm(i, j-1)
              ELSE
                abs0 = -dm(i, j-1)
              END IF
              IF (dm(i, j) .GE. 0.) THEN
                abs4 = dm(i, j)
              ELSE
                abs4 = -dm(i, j)
              END IF
              IF (dm(i, j+1) .GE. 0.) THEN
                abs8 = dm(i, j+1)
              ELSE
                abs8 = -dm(i, j+1)
              END IF
              IF (abs0 + abs4 + abs8 .LT. near_zero) THEN
                bl(i, j) = 0.
                br(i, j) = 0.
                CALL PUSHCONTROL2B(3)
              ELSE
                IF (3.*(bl(i, j)+br(i, j)) .GE. 0.) THEN
                  abs1 = 3.*(bl(i, j)+br(i, j))
                ELSE
                  abs1 = -(3.*(bl(i, j)+br(i, j)))
                END IF
                IF (bl(i, j) - br(i, j) .GE. 0.) THEN
                  abs5 = bl(i, j) - br(i, j)
                ELSE
                  abs5 = -(bl(i, j)-br(i, j))
                END IF
                IF (abs1 .GT. abs5) THEN
                  pmp_1 = -(2.*dq(i, j))
                  lac_1 = pmp_1 + 1.5*dq(i, j+1)
                  IF (0. .LT. pmp_1) THEN
                    IF (pmp_1 .LT. lac_1) THEN
                      x19 = lac_1
                      CALL PUSHCONTROL2B(0)
                    ELSE
                      x19 = pmp_1
                      CALL PUSHCONTROL2B(1)
                    END IF
                  ELSE IF (0. .LT. lac_1) THEN
                    x19 = lac_1
                    CALL PUSHCONTROL2B(2)
                  ELSE
                    CALL PUSHCONTROL2B(3)
                    x19 = 0.
                  END IF
                  IF (0. .GT. pmp_1) THEN
                    IF (pmp_1 .GT. lac_1) THEN
                      y37 = lac_1
                      CALL PUSHCONTROL2B(0)
                    ELSE
                      y37 = pmp_1
                      CALL PUSHCONTROL2B(1)
                    END IF
                  ELSE IF (0. .GT. lac_1) THEN
                    y37 = lac_1
                    CALL PUSHCONTROL2B(2)
                  ELSE
                    y37 = 0.
                    CALL PUSHCONTROL2B(3)
                  END IF
                  IF (bl(i, j) .LT. y37) THEN
                    y18 = y37
                    CALL PUSHCONTROL1B(0)
                  ELSE
                    y18 = bl(i, j)
                    CALL PUSHCONTROL1B(1)
                  END IF
                  IF (x19 .GT. y18) THEN
                    bl(i, j) = y18
                    CALL PUSHCONTROL1B(0)
                  ELSE
                    bl(i, j) = x19
                    CALL PUSHCONTROL1B(1)
                  END IF
                  pmp_2 = 2.*dq(i, j-1)
                  lac_2 = pmp_2 - 1.5*dq(i, j-2)
                  IF (0. .LT. pmp_2) THEN
                    IF (pmp_2 .LT. lac_2) THEN
                      x20 = lac_2
                      CALL PUSHCONTROL2B(0)
                    ELSE
                      x20 = pmp_2
                      CALL PUSHCONTROL2B(1)
                    END IF
                  ELSE IF (0. .LT. lac_2) THEN
                    x20 = lac_2
                    CALL PUSHCONTROL2B(2)
                  ELSE
                    CALL PUSHCONTROL2B(3)
                    x20 = 0.
                  END IF
                  IF (0. .GT. pmp_2) THEN
                    IF (pmp_2 .GT. lac_2) THEN
                      y38 = lac_2
                      CALL PUSHCONTROL2B(0)
                    ELSE
                      y38 = pmp_2
                      CALL PUSHCONTROL2B(1)
                    END IF
                  ELSE IF (0. .GT. lac_2) THEN
                    y38 = lac_2
                    CALL PUSHCONTROL2B(2)
                  ELSE
                    y38 = 0.
                    CALL PUSHCONTROL2B(3)
                  END IF
                  IF (br(i, j) .LT. y38) THEN
                    y19 = y38
                    CALL PUSHCONTROL1B(0)
                  ELSE
                    y19 = br(i, j)
                    CALL PUSHCONTROL1B(1)
                  END IF
                  IF (x20 .GT. y19) THEN
                    br(i, j) = y19
                    CALL PUSHCONTROL2B(1)
                  ELSE
                    br(i, j) = x20
                    CALL PUSHCONTROL2B(2)
                  END IF
                ELSE
                  CALL PUSHCONTROL2B(0)
                END IF
              END IF
            END DO
          END DO
          CALL PUSHCONTROL2B(2)
        END IF
!--------------
! Fix the edges:
!--------------
        IF (.NOT.nested) THEN
          IF (js .EQ. 1) THEN
            DO i=ifirst,ilast
              br(i, 2) = al(i, 3) - q(i, 2)
              x0l = 0.5*((2.*dya(i, 0)+dya(i, -1))*q(i, 0)-dya(i, 0)*q(i&
&               , -1))/(dya(i, 0)+dya(i, -1))
              x0r = 0.5*((2.*dya(i, 1)+dya(i, 2))*q(i, 1)-dya(i, 1)*q(i&
&               , 2))/(dya(i, 1)+dya(i, 2))
              xt = x0l + x0r
!lmh            xt = 0.5*((2.*dya(i,1)+dya(i,2))*(q(i,0)+q(i,1))   &
!lmh               -dya(i,1)*(q(i,-1)+q(i,2))) / ( dya(i,1)+dya(i,2) )
              bl(i, 1) = xt - q(i, 1)
              br(i, 0) = xt - q(i, 0)
              xt = s14*dm(i, -1) - s11*dq(i, -1) + q(i, 0)
!           xt = min( xt, max(q(i,-1), q(i,0)) )
!           xt = max( xt, min(q(i,-1), q(i,0)) )
              bl(i, 0) = xt - q(i, 0)
              xt = s15*q(i, 1) + s11*q(i, 2) - s14*dm(i, 2)
!           xt = min( xt, max(q(i,1), q(i,2)) )
!           xt = max( xt, min(q(i,1), q(i,2)) )
              br(i, 1) = xt - q(i, 1)
              bl(i, 2) = xt - q(i, 2)
            END DO
!         if ( jord<=9 ) then
            DO j=0,2
              arg1 = ilast - ifirst + 1
              CALL PUSHREALARRAY_ADM(br(ifirst, j), 8*(ilast-ifirst+1)/&
&                           8)
              CALL PUSHREALARRAY_ADM(bl(ifirst, j), 8*(ilast-ifirst+1)/&
&                           8)
              CALL PERT_PPM(arg1, q(ifirst, j), bl(ifirst, j), br(ifirst&
&                     , j), 1)
            END DO
            CALL PUSHCONTROL1B(0)
          ELSE
            CALL PUSHCONTROL1B(1)
          END IF
!         endif
          IF (je + 1 .EQ. npy) THEN
            DO i=ifirst,ilast
              bl(i, npy-2) = al(i, npy-2) - q(i, npy-2)
              x0l = 0.5*((2.*dya(i, npy-1)+dya(i, npy-2))*q(i, npy-1)-&
&               dya(i, npy-1)*q(i, npy-2))/(dya(i, npy-1)+dya(i, npy-2))
              x0r = 0.5*((2.*dya(i, npy)+dya(i, npy+1))*q(i, npy)-dya(i&
&               , npy)*q(i, npy+1))/(dya(i, npy)+dya(i, npy+1))
              xt = x0l + x0r
!lmh            xt = 0.5*((2.*dya(i,npy-1)+dya(i,npy-2))*(q(i,npy-1)+q(i,npy))  &
!lmh               -dya(i,npy-1)*(q(i,npy-2)+q(i,npy+1)))/(dya(i,npy-1)+dya(i,npy-2))
              br(i, npy-1) = xt - q(i, npy-1)
              bl(i, npy) = xt - q(i, npy)
              xt = s11*dq(i, npy) - s14*dm(i, npy+1) + q(i, npy)
!           xt = min( xt, max( q(i,npy), q(i,npy+1)) )
!           xt = max( xt, min( q(i,npy), q(i,npy+1)) )
              br(i, npy) = xt - q(i, npy)
              xt = s15*q(i, npy-1) + s11*q(i, npy-2) + s14*dm(i, npy-2)
!           xt = min( xt, max( q(i,npy-2), q(i,npy-1)) )
!           xt = max( xt, min( q(i,npy-2), q(i,npy-1)) )
              br(i, npy-2) = xt - q(i, npy-2)
              bl(i, npy-1) = xt - q(i, npy-1)
            END DO
!         if ( jord<=9 ) then
            DO j=npy-2,npy
              arg1 = ilast - ifirst + 1
              CALL PUSHREALARRAY_ADM(br(ifirst, j), 8*(ilast-ifirst+1)/&
&                           8)
              CALL PUSHREALARRAY_ADM(bl(ifirst, j), 8*(ilast-ifirst+1)/&
&                           8)
              CALL PERT_PPM(arg1, q(ifirst, j), bl(ifirst, j), br(ifirst&
&                     , j), 1)
            END DO
            CALL PUSHCONTROL2B(3)
          ELSE
            CALL PUSHCONTROL2B(2)
          END IF
        ELSE
          CALL PUSHCONTROL2B(1)
        END IF
      ELSE
!         endif
!---------------
! grid_type == 4
!---------------
        DO j=jfirst-1,jlast+2
          DO i=ifirst,ilast
            al(i, j) = 0.5*(q(i, j-1)+q(i, j)) + r3*(dm(i, j-1)-dm(i, j)&
&             )
          END DO
        END DO
        DO j=jfirst-3,jlast+2
          DO i=ifirst,ilast
            dq(i, j) = q(i, j+1) - q(i, j)
          END DO
        END DO
        DO j=jfirst-1,jlast+1
          DO i=ifirst,ilast
            pmp = -(2.*dq(i, j))
            lac = pmp + 1.5*dq(i, j+1)
            IF (0. .LT. pmp) THEN
              IF (pmp .LT. lac) THEN
                x21 = lac
                CALL PUSHCONTROL2B(0)
              ELSE
                x21 = pmp
                CALL PUSHCONTROL2B(1)
              END IF
            ELSE IF (0. .LT. lac) THEN
              x21 = lac
              CALL PUSHCONTROL2B(2)
            ELSE
              CALL PUSHCONTROL2B(3)
              x21 = 0.
            END IF
            IF (0. .GT. pmp) THEN
              IF (pmp .GT. lac) THEN
                y39 = lac
                CALL PUSHCONTROL2B(0)
              ELSE
                y39 = pmp
                CALL PUSHCONTROL2B(1)
              END IF
            ELSE IF (0. .GT. lac) THEN
              y39 = lac
              CALL PUSHCONTROL2B(2)
            ELSE
              y39 = 0.
              CALL PUSHCONTROL2B(3)
            END IF
            IF (al(i, j) - q(i, j) .LT. y39) THEN
              y20 = y39
              CALL PUSHCONTROL1B(0)
            ELSE
              y20 = al(i, j) - q(i, j)
              CALL PUSHCONTROL1B(1)
            END IF
            IF (x21 .GT. y20) THEN
              bl(i, j) = y20
              CALL PUSHCONTROL1B(0)
            ELSE
              bl(i, j) = x21
              CALL PUSHCONTROL1B(1)
            END IF
            pmp = 2.*dq(i, j-1)
            lac = pmp - 1.5*dq(i, j-2)
            IF (0. .LT. pmp) THEN
              IF (pmp .LT. lac) THEN
                x22 = lac
                CALL PUSHCONTROL2B(0)
              ELSE
                x22 = pmp
                CALL PUSHCONTROL2B(1)
              END IF
            ELSE IF (0. .LT. lac) THEN
              x22 = lac
              CALL PUSHCONTROL2B(2)
            ELSE
              CALL PUSHCONTROL2B(3)
              x22 = 0.
            END IF
            IF (0. .GT. pmp) THEN
              IF (pmp .GT. lac) THEN
                y40 = lac
                CALL PUSHCONTROL2B(0)
              ELSE
                y40 = pmp
                CALL PUSHCONTROL2B(1)
              END IF
            ELSE IF (0. .GT. lac) THEN
              y40 = lac
              CALL PUSHCONTROL2B(2)
            ELSE
              y40 = 0.
              CALL PUSHCONTROL2B(3)
            END IF
            IF (al(i, j+1) - q(i, j) .LT. y40) THEN
              y21 = y40
              CALL PUSHCONTROL1B(0)
            ELSE
              y21 = al(i, j+1) - q(i, j)
              CALL PUSHCONTROL1B(1)
            END IF
            IF (x22 .GT. y21) THEN
              br(i, j) = y21
              CALL PUSHCONTROL1B(0)
            ELSE
              br(i, j) = x22
              CALL PUSHCONTROL1B(1)
            END IF
          END DO
        END DO
        CALL PUSHCONTROL2B(0)
      END IF
      DO j=jfirst,jlast+1
        DO i=ifirst,ilast
          IF (c(i, j) .GT. 0.) THEN
            CALL PUSHCONTROL1B(1)
          ELSE
            CALL PUSHCONTROL1B(0)
          END IF
        END DO
      END DO
      bl_ad = 0.0_FVPRC
      br_ad = 0.0_FVPRC
      DO j=jlast+1,jfirst,-1
        DO i=ilast,ifirst,-1
          CALL POPCONTROL1B(branch)
          IF (branch .EQ. 0) THEN
            temp6 = bl(i, j) + br(i, j)
            temp_ad29 = (c(i, j)+1.)*flux_ad(i, j)
            temp_ad30 = c(i, j)*temp_ad29
            q_ad(i, j) = q_ad(i, j) + flux_ad(i, j)
            c_ad(i, j) = c_ad(i, j) + temp6*temp_ad29 + (bl(i, j)+c(i, j&
&             )*temp6)*flux_ad(i, j)
            bl_ad(i, j) = bl_ad(i, j) + temp_ad30 + temp_ad29
            br_ad(i, j) = br_ad(i, j) + temp_ad30
            flux_ad(i, j) = 0.0_FVPRC
          ELSE
            temp5 = bl(i, j-1) + br(i, j-1)
            temp_ad27 = (1.-c(i, j))*flux_ad(i, j)
            temp_ad28 = -(c(i, j)*temp_ad27)
            q_ad(i, j-1) = q_ad(i, j-1) + flux_ad(i, j)
            c_ad(i, j) = c_ad(i, j) - temp5*temp_ad27 - (br(i, j-1)-c(i&
&             , j)*temp5)*flux_ad(i, j)
            br_ad(i, j-1) = br_ad(i, j-1) + temp_ad28 + temp_ad27
            bl_ad(i, j-1) = bl_ad(i, j-1) + temp_ad28
            flux_ad(i, j) = 0.0_FVPRC
          END IF
        END DO
      END DO
      CALL POPCONTROL2B(branch)
      IF (branch .LT. 2) THEN
        IF (branch .EQ. 0) THEN
          dq_ad = 0.0_FVPRC
          al_ad = 0.0_FVPRC
          DO j=jlast+1,jfirst-1,-1
            DO i=ilast,ifirst,-1
              CALL POPCONTROL1B(branch)
              IF (branch .EQ. 0) THEN
                y21_ad = br_ad(i, j)
                br_ad(i, j) = 0.0_FVPRC
                x22_ad = 0.0_FVPRC
              ELSE
                x22_ad = br_ad(i, j)
                br_ad(i, j) = 0.0_FVPRC
                y21_ad = 0.0_FVPRC
              END IF
              CALL POPCONTROL1B(branch)
              IF (branch .EQ. 0) THEN
                y40_ad = y21_ad
              ELSE
                al_ad(i, j+1) = al_ad(i, j+1) + y21_ad
                q_ad(i, j) = q_ad(i, j) - y21_ad
                y40_ad = 0.0_FVPRC
              END IF
              CALL POPCONTROL2B(branch)
              IF (branch .LT. 2) THEN
                IF (branch .EQ. 0) THEN
                  lac_ad = y40_ad
                  pmp_ad = 0.0_FVPRC
                ELSE
                  pmp_ad = y40_ad
                  lac_ad = 0.0_FVPRC
                END IF
              ELSE
                IF (branch .EQ. 2) THEN
                  lac_ad = y40_ad
                ELSE
                  lac_ad = 0.0_FVPRC
                END IF
                pmp_ad = 0.0_FVPRC
              END IF
              CALL POPCONTROL2B(branch)
              IF (branch .LT. 2) THEN
                IF (branch .EQ. 0) THEN
                  lac_ad = lac_ad + x22_ad
                ELSE
                  pmp_ad = pmp_ad + x22_ad
                END IF
              ELSE IF (branch .EQ. 2) THEN
                lac_ad = lac_ad + x22_ad
              END IF
              pmp_ad = pmp_ad + lac_ad
              dq_ad(i, j-2) = dq_ad(i, j-2) - 1.5*lac_ad
              dq_ad(i, j-1) = dq_ad(i, j-1) + 2.*pmp_ad
              CALL POPCONTROL1B(branch)
              IF (branch .EQ. 0) THEN
                y20_ad = bl_ad(i, j)
                bl_ad(i, j) = 0.0_FVPRC
                x21_ad = 0.0_FVPRC
              ELSE
                x21_ad = bl_ad(i, j)
                bl_ad(i, j) = 0.0_FVPRC
                y20_ad = 0.0_FVPRC
              END IF
              CALL POPCONTROL1B(branch)
              IF (branch .EQ. 0) THEN
                y39_ad = y20_ad
              ELSE
                al_ad(i, j) = al_ad(i, j) + y20_ad
                q_ad(i, j) = q_ad(i, j) - y20_ad
                y39_ad = 0.0_FVPRC
              END IF
              CALL POPCONTROL2B(branch)
              IF (branch .LT. 2) THEN
                IF (branch .EQ. 0) THEN
                  lac_ad = y39_ad
                  pmp_ad = 0.0_FVPRC
                ELSE
                  pmp_ad = y39_ad
                  lac_ad = 0.0_FVPRC
                END IF
              ELSE
                IF (branch .EQ. 2) THEN
                  lac_ad = y39_ad
                ELSE
                  lac_ad = 0.0_FVPRC
                END IF
                pmp_ad = 0.0_FVPRC
              END IF
              CALL POPCONTROL2B(branch)
              IF (branch .LT. 2) THEN
                IF (branch .EQ. 0) THEN
                  lac_ad = lac_ad + x21_ad
                ELSE
                  pmp_ad = pmp_ad + x21_ad
                END IF
              ELSE IF (branch .EQ. 2) THEN
                lac_ad = lac_ad + x21_ad
              END IF
              pmp_ad = pmp_ad + lac_ad
              dq_ad(i, j+1) = dq_ad(i, j+1) + 1.5*lac_ad
              dq_ad(i, j) = dq_ad(i, j) - 2.*pmp_ad
            END DO
          END DO
          DO j=jlast+2,jfirst-3,-1
            DO i=ilast,ifirst,-1
              q_ad(i, j+1) = q_ad(i, j+1) + dq_ad(i, j)
              q_ad(i, j) = q_ad(i, j) - dq_ad(i, j)
              dq_ad(i, j) = 0.0_FVPRC
            END DO
          END DO
          dm_ad = 0.0_FVPRC
          DO j=jlast+2,jfirst-1,-1
            DO i=ilast,ifirst,-1
              q_ad(i, j-1) = q_ad(i, j-1) + 0.5*al_ad(i, j)
              q_ad(i, j) = q_ad(i, j) + 0.5*al_ad(i, j)
              dm_ad(i, j-1) = dm_ad(i, j-1) + r3*al_ad(i, j)
              dm_ad(i, j) = dm_ad(i, j) - r3*al_ad(i, j)
              al_ad(i, j) = 0.0_FVPRC
            END DO
          END DO
          GOTO 120
        ELSE
          dm_ad = 0.0_FVPRC
          dq_ad = 0.0_FVPRC
          al_ad = 0.0_FVPRC
        END IF
      ELSE
        IF (branch .EQ. 2) THEN
          dm_ad = 0.0_FVPRC
          dq_ad = 0.0_FVPRC
          al_ad = 0.0_FVPRC
        ELSE
          DO j=npy,npy-2,-1
            arg1 = ilast - ifirst + 1
            CALL POPREALARRAY_ADM(bl(ifirst, j), 8*(ilast-ifirst+1)/8)
            CALL POPREALARRAY_ADM(br(ifirst, j), 8*(ilast-ifirst+1)/8)
            CALL PERT_PPM_ADM(arg1, q(ifirst, j), bl(ifirst:, j), bl_ad(&
&                       ifirst:, j), br(ifirst:, j), br_ad(ifirst:, j), &
&                       1)
          END DO
          dm_ad = 0.0_FVPRC
          dq_ad = 0.0_FVPRC
          al_ad = 0.0_FVPRC
          DO i=ilast,ifirst,-1
            xt_ad = br_ad(i, npy-2) + bl_ad(i, npy-1)
            q_ad(i, npy-1) = q_ad(i, npy-1) - bl_ad(i, npy-1)
            bl_ad(i, npy-1) = 0.0_FVPRC
            q_ad(i, npy-2) = q_ad(i, npy-2) - br_ad(i, npy-2)
            br_ad(i, npy-2) = 0.0_FVPRC
            q_ad(i, npy-1) = q_ad(i, npy-1) + s15*xt_ad
            q_ad(i, npy-2) = q_ad(i, npy-2) + s11*xt_ad
            dm_ad(i, npy-2) = dm_ad(i, npy-2) + s14*xt_ad
            xt_ad = br_ad(i, npy)
            q_ad(i, npy) = q_ad(i, npy) + xt_ad - bl_ad(i, npy) - br_ad(&
&             i, npy)
            br_ad(i, npy) = 0.0_FVPRC
            dq_ad(i, npy) = dq_ad(i, npy) + s11*xt_ad
            dm_ad(i, npy+1) = dm_ad(i, npy+1) - s14*xt_ad
            xt_ad = br_ad(i, npy-1) + bl_ad(i, npy)
            bl_ad(i, npy) = 0.0_FVPRC
            q_ad(i, npy-1) = q_ad(i, npy-1) - br_ad(i, npy-1)
            br_ad(i, npy-1) = 0.0_FVPRC
            x0l_ad = xt_ad
            x0r_ad = xt_ad
            temp_ad25 = 0.5*x0r_ad/(dya(i, npy)+dya(i, npy+1))
            q_ad(i, npy) = q_ad(i, npy) + (dya(i, npy)*2.+dya(i, npy+1))&
&             *temp_ad25
            q_ad(i, npy+1) = q_ad(i, npy+1) - dya(i, npy)*temp_ad25
            temp_ad26 = 0.5*x0l_ad/(dya(i, npy-1)+dya(i, npy-2))
            q_ad(i, npy-1) = q_ad(i, npy-1) + (dya(i, npy-1)*2.+dya(i, &
&             npy-2))*temp_ad26
            q_ad(i, npy-2) = q_ad(i, npy-2) - bl_ad(i, npy-2) - dya(i, &
&             npy-1)*temp_ad26
            al_ad(i, npy-2) = al_ad(i, npy-2) + bl_ad(i, npy-2)
            bl_ad(i, npy-2) = 0.0_FVPRC
          END DO
        END IF
        CALL POPCONTROL1B(branch)
        IF (branch .EQ. 0) THEN
          DO j=2,0,-1
            arg1 = ilast - ifirst + 1
            CALL POPREALARRAY_ADM(bl(ifirst, j), 8*(ilast-ifirst+1)/8)
            CALL POPREALARRAY_ADM(br(ifirst, j), 8*(ilast-ifirst+1)/8)
            CALL PERT_PPM_ADM(arg1, q(ifirst, j), bl(ifirst:, j), bl_ad(&
&                       ifirst:, j), br(ifirst:, j), br_ad(ifirst:, j), &
&                       1)
          END DO
          DO i=ilast,ifirst,-1
            xt_ad = br_ad(i, 1) + bl_ad(i, 2)
            q_ad(i, 2) = q_ad(i, 2) - bl_ad(i, 2)
            bl_ad(i, 2) = 0.0_FVPRC
            q_ad(i, 1) = q_ad(i, 1) + s15*xt_ad - br_ad(i, 1)
            br_ad(i, 1) = 0.0_FVPRC
            q_ad(i, 2) = q_ad(i, 2) + s11*xt_ad
            dm_ad(i, 2) = dm_ad(i, 2) - s14*xt_ad
            xt_ad = bl_ad(i, 0)
            q_ad(i, 0) = q_ad(i, 0) + xt_ad - br_ad(i, 0) - bl_ad(i, 0)
            bl_ad(i, 0) = 0.0_FVPRC
            dm_ad(i, -1) = dm_ad(i, -1) + s14*xt_ad
            dq_ad(i, -1) = dq_ad(i, -1) - s11*xt_ad
            xt_ad = bl_ad(i, 1) + br_ad(i, 0)
            br_ad(i, 0) = 0.0_FVPRC
            x0l_ad = xt_ad
            x0r_ad = xt_ad
            temp_ad23 = 0.5*x0r_ad/(dya(i, 1)+dya(i, 2))
            q_ad(i, 1) = q_ad(i, 1) + (dya(i, 1)*2.+dya(i, 2))*temp_ad23&
&             - bl_ad(i, 1)
            bl_ad(i, 1) = 0.0_FVPRC
            q_ad(i, 2) = q_ad(i, 2) - dya(i, 1)*temp_ad23
            temp_ad24 = 0.5*x0l_ad/(dya(i, 0)+dya(i, -1))
            q_ad(i, 0) = q_ad(i, 0) + (dya(i, 0)*2.+dya(i, -1))*&
&             temp_ad24
            q_ad(i, -1) = q_ad(i, -1) - dya(i, 0)*temp_ad24
            al_ad(i, 3) = al_ad(i, 3) + br_ad(i, 2)
            q_ad(i, 2) = q_ad(i, 2) - br_ad(i, 2)
            br_ad(i, 2) = 0.0_FVPRC
          END DO
        END IF
      END IF
      CALL POPCONTROL2B(branch)
      IF (branch .EQ. 0) THEN
        DO j=je3,js3,-1
          DO i=ilast,ifirst,-1
            xt = 2.*dm(i, j)
            min13_ad = SIGN(1.d0, min13*xt)*br_ad(i, j)
            br_ad(i, j) = 0.0_FVPRC
            CALL POPCONTROL1B(branch)
            IF (branch .EQ. 0) THEN
              CALL POPREALARRAY_ADM(min13)
              y15_ad = min13_ad
              x16_ad = 0.0_FVPRC
            ELSE
              CALL POPREALARRAY_ADM(min13)
              x16_ad = min13_ad
              y15_ad = 0.0_FVPRC
            END IF
            CALL POPCONTROL1B(branch)
            IF (branch .EQ. 0) THEN
              al_ad(i, j+1) = al_ad(i, j+1) + y15_ad
              q_ad(i, j) = q_ad(i, j) - y15_ad
            ELSE
              q_ad(i, j) = q_ad(i, j) + y15_ad
              al_ad(i, j+1) = al_ad(i, j+1) - y15_ad
            END IF
            CALL POPCONTROL1B(branch)
            IF (branch .EQ. 0) THEN
              xt_ad = x16_ad
            ELSE
              xt_ad = -x16_ad
            END IF
            min12_ad = -(SIGN(1.d0, min12*xt)*bl_ad(i, j))
            bl_ad(i, j) = 0.0_FVPRC
            CALL POPCONTROL1B(branch)
            IF (branch .EQ. 0) THEN
              CALL POPREALARRAY_ADM(min12)
              y14_ad = min12_ad
              x15_ad = 0.0_FVPRC
            ELSE
              CALL POPREALARRAY_ADM(min12)
              x15_ad = min12_ad
              y14_ad = 0.0_FVPRC
            END IF
            CALL POPCONTROL1B(branch)
            IF (branch .EQ. 0) THEN
              al_ad(i, j) = al_ad(i, j) + y14_ad
              q_ad(i, j) = q_ad(i, j) - y14_ad
            ELSE
              q_ad(i, j) = q_ad(i, j) + y14_ad
              al_ad(i, j) = al_ad(i, j) - y14_ad
            END IF
            CALL POPCONTROL1B(branch)
            IF (branch .EQ. 0) THEN
              xt_ad = xt_ad + x15_ad
            ELSE
              xt_ad = xt_ad - x15_ad
            END IF
            dm_ad(i, j) = dm_ad(i, j) + 2.*xt_ad
          END DO
        END DO
      ELSE IF (branch .EQ. 1) THEN
        DO j=je3,js3,-1
          DO i=ilast,ifirst,-1
            CALL POPCONTROL1B(branch)
            IF (branch .EQ. 0) THEN
              y17_ad = br_ad(i, j)
              br_ad(i, j) = 0.0_FVPRC
              x18_ad = 0.0_FVPRC
            ELSE
              x18_ad = br_ad(i, j)
              br_ad(i, j) = 0.0_FVPRC
              y17_ad = 0.0_FVPRC
            END IF
            CALL POPCONTROL1B(branch)
            IF (branch .EQ. 0) THEN
              y36_ad = y17_ad
            ELSE
              al_ad(i, j+1) = al_ad(i, j+1) + y17_ad
              q_ad(i, j) = q_ad(i, j) - y17_ad
              y36_ad = 0.0_FVPRC
            END IF
            CALL POPCONTROL2B(branch)
            IF (branch .LT. 2) THEN
              IF (branch .EQ. 0) THEN
                lac_2_ad = y36_ad
                pmp_2_ad = 0.0_FVPRC
              ELSE
                pmp_2_ad = y36_ad
                lac_2_ad = 0.0_FVPRC
              END IF
            ELSE
              IF (branch .EQ. 2) THEN
                lac_2_ad = y36_ad
              ELSE
                lac_2_ad = 0.0_FVPRC
              END IF
              pmp_2_ad = 0.0_FVPRC
            END IF
            CALL POPCONTROL2B(branch)
            IF (branch .LT. 2) THEN
              IF (branch .EQ. 0) THEN
                lac_2_ad = lac_2_ad + x18_ad
              ELSE
                pmp_2_ad = pmp_2_ad + x18_ad
              END IF
            ELSE IF (branch .EQ. 2) THEN
              lac_2_ad = lac_2_ad + x18_ad
            END IF
            pmp_2_ad = pmp_2_ad + lac_2_ad
            dq_ad(i, j-2) = dq_ad(i, j-2) - 1.5*lac_2_ad
            dq_ad(i, j-1) = dq_ad(i, j-1) + 2.*pmp_2_ad
            CALL POPCONTROL1B(branch)
            IF (branch .EQ. 0) THEN
              y16_ad = bl_ad(i, j)
              bl_ad(i, j) = 0.0_FVPRC
              x17_ad = 0.0_FVPRC
            ELSE
              x17_ad = bl_ad(i, j)
              bl_ad(i, j) = 0.0_FVPRC
              y16_ad = 0.0_FVPRC
            END IF
            CALL POPCONTROL1B(branch)
            IF (branch .EQ. 0) THEN
              y35_ad = y16_ad
            ELSE
              al_ad(i, j) = al_ad(i, j) + y16_ad
              q_ad(i, j) = q_ad(i, j) - y16_ad
              y35_ad = 0.0_FVPRC
            END IF
            CALL POPCONTROL2B(branch)
            IF (branch .LT. 2) THEN
              IF (branch .EQ. 0) THEN
                lac_1_ad = y35_ad
                pmp_1_ad = 0.0_FVPRC
              ELSE
                pmp_1_ad = y35_ad
                lac_1_ad = 0.0_FVPRC
              END IF
            ELSE
              IF (branch .EQ. 2) THEN
                lac_1_ad = y35_ad
              ELSE
                lac_1_ad = 0.0_FVPRC
              END IF
              pmp_1_ad = 0.0_FVPRC
            END IF
            CALL POPCONTROL2B(branch)
            IF (branch .LT. 2) THEN
              IF (branch .EQ. 0) THEN
                lac_1_ad = lac_1_ad + x17_ad
              ELSE
                pmp_1_ad = pmp_1_ad + x17_ad
              END IF
            ELSE IF (branch .EQ. 2) THEN
              lac_1_ad = lac_1_ad + x17_ad
            END IF
            pmp_1_ad = pmp_1_ad + lac_1_ad
            dq_ad(i, j+1) = dq_ad(i, j+1) + 1.5*lac_1_ad
            dq_ad(i, j) = dq_ad(i, j) - 2.*pmp_1_ad
          END DO
        END DO
      ELSE
        DO j=je3,js3,-1
          DO i=ilast,ifirst,-1
            CALL POPCONTROL2B(branch)
            IF (branch .LT. 2) THEN
              IF (branch .EQ. 0) THEN
                GOTO 110
              ELSE
                y19_ad = br_ad(i, j)
                br_ad(i, j) = 0.0_FVPRC
                x20_ad = 0.0_FVPRC
              END IF
            ELSE IF (branch .EQ. 2) THEN
              x20_ad = br_ad(i, j)
              br_ad(i, j) = 0.0_FVPRC
              y19_ad = 0.0_FVPRC
            ELSE
              br_ad(i, j) = 0.0_FVPRC
              bl_ad(i, j) = 0.0_FVPRC
              GOTO 110
            END IF
            CALL POPCONTROL1B(branch)
            IF (branch .EQ. 0) THEN
              y38_ad = y19_ad
            ELSE
              br_ad(i, j) = br_ad(i, j) + y19_ad
              y38_ad = 0.0_FVPRC
            END IF
            CALL POPCONTROL2B(branch)
            IF (branch .LT. 2) THEN
              IF (branch .EQ. 0) THEN
                lac_2_ad = y38_ad
                pmp_2_ad = 0.0_FVPRC
              ELSE
                pmp_2_ad = y38_ad
                lac_2_ad = 0.0_FVPRC
              END IF
            ELSE
              IF (branch .EQ. 2) THEN
                lac_2_ad = y38_ad
              ELSE
                lac_2_ad = 0.0_FVPRC
              END IF
              pmp_2_ad = 0.0_FVPRC
            END IF
            CALL POPCONTROL2B(branch)
            IF (branch .LT. 2) THEN
              IF (branch .EQ. 0) THEN
                lac_2_ad = lac_2_ad + x20_ad
              ELSE
                pmp_2_ad = pmp_2_ad + x20_ad
              END IF
            ELSE IF (branch .EQ. 2) THEN
              lac_2_ad = lac_2_ad + x20_ad
            END IF
            pmp_2_ad = pmp_2_ad + lac_2_ad
            dq_ad(i, j-2) = dq_ad(i, j-2) - 1.5*lac_2_ad
            dq_ad(i, j-1) = dq_ad(i, j-1) + 2.*pmp_2_ad
            CALL POPCONTROL1B(branch)
            IF (branch .EQ. 0) THEN
              y18_ad = bl_ad(i, j)
              bl_ad(i, j) = 0.0_FVPRC
              x19_ad = 0.0_FVPRC
            ELSE
              x19_ad = bl_ad(i, j)
              bl_ad(i, j) = 0.0_FVPRC
              y18_ad = 0.0_FVPRC
            END IF
            CALL POPCONTROL1B(branch)
            IF (branch .EQ. 0) THEN
              y37_ad = y18_ad
            ELSE
              bl_ad(i, j) = bl_ad(i, j) + y18_ad
              y37_ad = 0.0_FVPRC
            END IF
            CALL POPCONTROL2B(branch)
            IF (branch .LT. 2) THEN
              IF (branch .EQ. 0) THEN
                lac_1_ad = y37_ad
                pmp_1_ad = 0.0_FVPRC
              ELSE
                pmp_1_ad = y37_ad
                lac_1_ad = 0.0_FVPRC
              END IF
            ELSE
              IF (branch .EQ. 2) THEN
                lac_1_ad = y37_ad
              ELSE
                lac_1_ad = 0.0_FVPRC
              END IF
              pmp_1_ad = 0.0_FVPRC
            END IF
            CALL POPCONTROL2B(branch)
            IF (branch .LT. 2) THEN
              IF (branch .EQ. 0) THEN
                lac_1_ad = lac_1_ad + x19_ad
              ELSE
                pmp_1_ad = pmp_1_ad + x19_ad
              END IF
            ELSE IF (branch .EQ. 2) THEN
              lac_1_ad = lac_1_ad + x19_ad
            END IF
            pmp_1_ad = pmp_1_ad + lac_1_ad
            dq_ad(i, j+1) = dq_ad(i, j+1) + 1.5*lac_1_ad
            dq_ad(i, j) = dq_ad(i, j) - 2.*pmp_1_ad
 110        al_ad(i, j+1) = al_ad(i, j+1) + br_ad(i, j)
            q_ad(i, j) = q_ad(i, j) - bl_ad(i, j) - br_ad(i, j)
            br_ad(i, j) = 0.0_FVPRC
            al_ad(i, j) = al_ad(i, j) + bl_ad(i, j)
            bl_ad(i, j) = 0.0_FVPRC
          END DO
        END DO
      END IF
      DO j=je+2,js-3,-1
        DO i=ilast,ifirst,-1
          q_ad(i, j+1) = q_ad(i, j+1) + dq_ad(i, j)
          q_ad(i, j) = q_ad(i, j) - dq_ad(i, j)
          dq_ad(i, j) = 0.0_FVPRC
        END DO
      END DO
      DO j=je3+1,js3,-1
        DO i=ilast,ifirst,-1
          q_ad(i, j-1) = q_ad(i, j-1) + 0.5*al_ad(i, j)
          q_ad(i, j) = q_ad(i, j) + 0.5*al_ad(i, j)
          dm_ad(i, j-1) = dm_ad(i, j-1) + r3*al_ad(i, j)
          dm_ad(i, j) = dm_ad(i, j) - r3*al_ad(i, j)
          al_ad(i, j) = 0.0_FVPRC
        END DO
      END DO
 120  DO j=je+2,js-2,-1
        DO i=ilast,ifirst,-1
          xt = 0.25*(q(i, j+1)-q(i, j-1))
          min11_ad = SIGN(1.d0, min11*xt)*dm_ad(i, j)
          dm_ad(i, j) = 0.0_FVPRC
          CALL POPCONTROL2B(branch)
          IF (branch .LT. 2) THEN
            IF (branch .EQ. 0) THEN
              CALL POPREALARRAY_ADM(min11)
              z7_ad = min11_ad
              y13_ad = 0.0_FVPRC
            ELSE
              CALL POPREALARRAY_ADM(min11)
              y13_ad = min11_ad
              z7_ad = 0.0_FVPRC
            END IF
            x14_ad = 0.0_FVPRC
          ELSE
            IF (branch .EQ. 2) THEN
              CALL POPREALARRAY_ADM(min11)
              z7_ad = min11_ad
              x14_ad = 0.0_FVPRC
            ELSE
              CALL POPREALARRAY_ADM(min11)
              x14_ad = min11_ad
              z7_ad = 0.0_FVPRC
            END IF
            y13_ad = 0.0_FVPRC
          END IF
          q_ad(i, j) = q_ad(i, j) + z7_ad
          min27_ad = -z7_ad
          CALL POPCONTROL2B(branch)
          IF (branch .LT. 2) THEN
            IF (branch .EQ. 0) THEN
              q_ad(i, j+1) = q_ad(i, j+1) + min27_ad
            ELSE
              q_ad(i, j) = q_ad(i, j) + min27_ad
            END IF
          ELSE IF (branch .EQ. 2) THEN
            q_ad(i, j+1) = q_ad(i, j+1) + min27_ad
          ELSE
            q_ad(i, j-1) = q_ad(i, j-1) + min27_ad
          END IF
          max9_ad = y13_ad
          q_ad(i, j) = q_ad(i, j) - y13_ad
          CALL POPCONTROL2B(branch)
          IF (branch .LT. 2) THEN
            IF (branch .EQ. 0) THEN
              q_ad(i, j+1) = q_ad(i, j+1) + max9_ad
            ELSE
              q_ad(i, j) = q_ad(i, j) + max9_ad
            END IF
          ELSE IF (branch .EQ. 2) THEN
            q_ad(i, j+1) = q_ad(i, j+1) + max9_ad
          ELSE
            q_ad(i, j-1) = q_ad(i, j-1) + max9_ad
          END IF
          CALL POPCONTROL1B(branch)
          IF (branch .EQ. 0) THEN
            xt_ad = x14_ad
          ELSE
            xt_ad = -x14_ad
          END IF
          q_ad(i, j+1) = q_ad(i, j+1) + 0.25*xt_ad
          q_ad(i, j-1) = q_ad(i, j-1) - 0.25*xt_ad
        END DO
      END DO
    ELSE
!-------------------------------
! For positive definite tracers:
!-------------------------------
! jord=11: PPM mono constraint (Lin 2004)
! jord=12: Huynh 2nd constraint (Lin 2004) + positive definite (Lin & Rood 1996)
! jord>12: positive definite only (Lin & Rood 1996)
      DO j=js-2,je+2
        DO i=ifirst,ilast
          xt = 0.25*(q(i, j+1)-q(i, j-1))
          IF (xt .GE. 0.) THEN
            x23 = xt
            CALL PUSHCONTROL1B(0)
          ELSE
            x23 = -xt
            CALL PUSHCONTROL1B(1)
          END IF
          IF (q(i, j-1) .LT. q(i, j)) THEN
            IF (q(i, j) .LT. q(i, j+1)) THEN
              max10 = q(i, j+1)
              CALL PUSHCONTROL2B(0)
            ELSE
              max10 = q(i, j)
              CALL PUSHCONTROL2B(1)
            END IF
          ELSE IF (q(i, j-1) .LT. q(i, j+1)) THEN
            max10 = q(i, j+1)
            CALL PUSHCONTROL2B(2)
          ELSE
            max10 = q(i, j-1)
            CALL PUSHCONTROL2B(3)
          END IF
          y22 = max10 - q(i, j)
          IF (q(i, j-1) .GT. q(i, j)) THEN
            IF (q(i, j) .GT. q(i, j+1)) THEN
              min28 = q(i, j+1)
              CALL PUSHCONTROL2B(0)
            ELSE
              min28 = q(i, j)
              CALL PUSHCONTROL2B(1)
            END IF
          ELSE IF (q(i, j-1) .GT. q(i, j+1)) THEN
            min28 = q(i, j+1)
            CALL PUSHCONTROL2B(2)
          ELSE
            min28 = q(i, j-1)
            CALL PUSHCONTROL2B(3)
          END IF
          z8 = q(i, j) - min28
          IF (x23 .GT. y22) THEN
            IF (y22 .GT. z8) THEN
              CALL PUSHREALARRAY_ADM(min14)
              min14 = z8
              CALL PUSHCONTROL2B(0)
            ELSE
              CALL PUSHREALARRAY_ADM(min14)
              min14 = y22
              CALL PUSHCONTROL2B(1)
            END IF
          ELSE IF (x23 .GT. z8) THEN
            CALL PUSHREALARRAY_ADM(min14)
            min14 = z8
            CALL PUSHCONTROL2B(2)
          ELSE
            CALL PUSHREALARRAY_ADM(min14)
            min14 = x23
            CALL PUSHCONTROL2B(3)
          END IF
          dm(i, j) = SIGN(min14, xt)
        END DO
      END DO
      IF (grid_type .LT. 3) THEN
        IF (nested) THEN
          CALL PUSHCONTROL1B(1)
          js3 = js - 1
          je3 = je + 1
        ELSE
          IF (3 .LT. js - 1) THEN
            js3 = js - 1
          ELSE
            js3 = 3
          END IF
          IF (npy - 3 .GT. je + 1) THEN
            CALL PUSHCONTROL1B(0)
            je3 = je + 1
          ELSE
            CALL PUSHCONTROL1B(0)
            je3 = npy - 3
          END IF
        END IF
!      do j=js3,min(npy-2,je+2)
        DO j=js3,je3+1
          DO i=ifirst,ilast
            al(i, j) = 0.5*(q(i, j-1)+q(i, j)) + r3*(dm(i, j-1)-dm(i, j)&
&             )
          END DO
        END DO
        IF (jord .EQ. 11) THEN
          DO j=js3,je3
            DO i=ifirst,ilast
              xt = 2.*dm(i, j)
              IF (xt .GE. 0.) THEN
                x24 = xt
                CALL PUSHCONTROL1B(0)
              ELSE
                x24 = -xt
                CALL PUSHCONTROL1B(1)
              END IF
              IF (al(i, j) - q(i, j) .GE. 0.) THEN
                y23 = al(i, j) - q(i, j)
                CALL PUSHCONTROL1B(0)
              ELSE
                y23 = -(al(i, j)-q(i, j))
                CALL PUSHCONTROL1B(1)
              END IF
              IF (x24 .GT. y23) THEN
                CALL PUSHREALARRAY_ADM(min15)
                min15 = y23
                CALL PUSHCONTROL1B(0)
              ELSE
                CALL PUSHREALARRAY_ADM(min15)
                min15 = x24
                CALL PUSHCONTROL1B(1)
              END IF
              bl(i, j) = -SIGN(min15, xt)
              IF (xt .GE. 0.) THEN
                x25 = xt
                CALL PUSHCONTROL1B(0)
              ELSE
                x25 = -xt
                CALL PUSHCONTROL1B(1)
              END IF
              IF (al(i, j+1) - q(i, j) .GE. 0.) THEN
                y24 = al(i, j+1) - q(i, j)
                CALL PUSHCONTROL1B(0)
              ELSE
                y24 = -(al(i, j+1)-q(i, j))
                CALL PUSHCONTROL1B(1)
              END IF
              IF (x25 .GT. y24) THEN
                CALL PUSHREALARRAY_ADM(min16)
                min16 = y24
                CALL PUSHCONTROL1B(0)
              ELSE
                CALL PUSHREALARRAY_ADM(min16)
                min16 = x25
                CALL PUSHCONTROL1B(1)
              END IF
              br(i, j) = SIGN(min16, xt)
            END DO
          END DO
          CALL PUSHCONTROL2B(0)
        ELSE IF (jord .EQ. 12) THEN
          DO j=js-3,je+2
            DO i=ifirst,ilast
              dq(i, j) = q(i, j+1) - q(i, j)
            END DO
          END DO
          DO j=js3,je3
            DO i=ifirst,ilast
              pmp = -(2.*dq(i, j))
              lac = pmp + 1.5*dq(i, j+1)
              IF (0. .LT. pmp) THEN
                IF (pmp .LT. lac) THEN
                  x26 = lac
                  CALL PUSHCONTROL2B(0)
                ELSE
                  x26 = pmp
                  CALL PUSHCONTROL2B(1)
                END IF
              ELSE IF (0. .LT. lac) THEN
                x26 = lac
                CALL PUSHCONTROL2B(2)
              ELSE
                CALL PUSHCONTROL2B(3)
                x26 = 0.
              END IF
              IF (0. .GT. pmp) THEN
                IF (pmp .GT. lac) THEN
                  y41 = lac
                  CALL PUSHCONTROL2B(0)
                ELSE
                  y41 = pmp
                  CALL PUSHCONTROL2B(1)
                END IF
              ELSE IF (0. .GT. lac) THEN
                y41 = lac
                CALL PUSHCONTROL2B(2)
              ELSE
                y41 = 0.
                CALL PUSHCONTROL2B(3)
              END IF
              IF (al(i, j) - q(i, j) .LT. y41) THEN
                y25 = y41
                CALL PUSHCONTROL1B(0)
              ELSE
                y25 = al(i, j) - q(i, j)
                CALL PUSHCONTROL1B(1)
              END IF
              IF (x26 .GT. y25) THEN
                bl(i, j) = y25
                CALL PUSHCONTROL1B(0)
              ELSE
                bl(i, j) = x26
                CALL PUSHCONTROL1B(1)
              END IF
              pmp = 2.*dq(i, j-1)
              lac = pmp - 1.5*dq(i, j-2)
              IF (0. .LT. pmp) THEN
                IF (pmp .LT. lac) THEN
                  x27 = lac
                  CALL PUSHCONTROL2B(0)
                ELSE
                  x27 = pmp
                  CALL PUSHCONTROL2B(1)
                END IF
              ELSE IF (0. .LT. lac) THEN
                x27 = lac
                CALL PUSHCONTROL2B(2)
              ELSE
                CALL PUSHCONTROL2B(3)
                x27 = 0.
              END IF
              IF (0. .GT. pmp) THEN
                IF (pmp .GT. lac) THEN
                  y42 = lac
                  CALL PUSHCONTROL2B(0)
                ELSE
                  y42 = pmp
                  CALL PUSHCONTROL2B(1)
                END IF
              ELSE IF (0. .GT. lac) THEN
                y42 = lac
                CALL PUSHCONTROL2B(2)
              ELSE
                y42 = 0.
                CALL PUSHCONTROL2B(3)
              END IF
              IF (al(i, j+1) - q(i, j) .LT. y42) THEN
                y26 = y42
                CALL PUSHCONTROL1B(0)
              ELSE
                y26 = al(i, j+1) - q(i, j)
                CALL PUSHCONTROL1B(1)
              END IF
              IF (x27 .GT. y26) THEN
                br(i, j) = y26
                CALL PUSHCONTROL1B(0)
              ELSE
                br(i, j) = x27
                CALL PUSHCONTROL1B(1)
              END IF
            END DO
          END DO
          CALL PUSHCONTROL2B(1)
        ELSE
! jord=13
          DO j=js-3,je+2
            DO i=ifirst,ilast
              dq(i, j) = q(i, j+1) - q(i, j)
            END DO
          END DO
          DO j=js3,je3
            DO i=ifirst,ilast
              IF (dm(i, j-1) .GE. 0.) THEN
                abs2 = dm(i, j-1)
              ELSE
                abs2 = -dm(i, j-1)
              END IF
              IF (dm(i, j) .GE. 0.) THEN
                abs6 = dm(i, j)
              ELSE
                abs6 = -dm(i, j)
              END IF
              IF (dm(i, j+1) .GE. 0.) THEN
                abs9 = dm(i, j+1)
              ELSE
                abs9 = -dm(i, j+1)
              END IF
              IF (abs2 + abs6 + abs9 .LT. near_zero) THEN
                bl(i, j) = 0.
                br(i, j) = 0.
                CALL PUSHCONTROL2B(3)
              ELSE
                bl(i, j) = al(i, j) - q(i, j)
                br(i, j) = al(i, j+1) - q(i, j)
                IF (3.*(bl(i, j)+br(i, j)) .GE. 0.) THEN
                  abs3 = 3.*(bl(i, j)+br(i, j))
                ELSE
                  abs3 = -(3.*(bl(i, j)+br(i, j)))
                END IF
                IF (bl(i, j) - br(i, j) .GE. 0.) THEN
                  abs7 = bl(i, j) - br(i, j)
                ELSE
                  abs7 = -(bl(i, j)-br(i, j))
                END IF
                IF (abs3 .GT. abs7) THEN
                  pmp_1 = -(2.*dq(i, j))
                  lac_1 = pmp_1 + 1.5*dq(i, j+1)
                  IF (0. .LT. pmp_1) THEN
                    IF (pmp_1 .LT. lac_1) THEN
                      x28 = lac_1
                      CALL PUSHCONTROL2B(0)
                    ELSE
                      x28 = pmp_1
                      CALL PUSHCONTROL2B(1)
                    END IF
                  ELSE IF (0. .LT. lac_1) THEN
                    x28 = lac_1
                    CALL PUSHCONTROL2B(2)
                  ELSE
                    CALL PUSHCONTROL2B(3)
                    x28 = 0.
                  END IF
                  IF (0. .GT. pmp_1) THEN
                    IF (pmp_1 .GT. lac_1) THEN
                      y43 = lac_1
                      CALL PUSHCONTROL2B(0)
                    ELSE
                      y43 = pmp_1
                      CALL PUSHCONTROL2B(1)
                    END IF
                  ELSE IF (0. .GT. lac_1) THEN
                    y43 = lac_1
                    CALL PUSHCONTROL2B(2)
                  ELSE
                    y43 = 0.
                    CALL PUSHCONTROL2B(3)
                  END IF
                  IF (bl(i, j) .LT. y43) THEN
                    y27 = y43
                    CALL PUSHCONTROL1B(0)
                  ELSE
                    y27 = bl(i, j)
                    CALL PUSHCONTROL1B(1)
                  END IF
                  IF (x28 .GT. y27) THEN
                    bl(i, j) = y27
                    CALL PUSHCONTROL1B(0)
                  ELSE
                    bl(i, j) = x28
                    CALL PUSHCONTROL1B(1)
                  END IF
                  pmp_2 = 2.*dq(i, j-1)
                  lac_2 = pmp_2 - 1.5*dq(i, j-2)
                  IF (0. .LT. pmp_2) THEN
                    IF (pmp_2 .LT. lac_2) THEN
                      x29 = lac_2
                      CALL PUSHCONTROL2B(0)
                    ELSE
                      x29 = pmp_2
                      CALL PUSHCONTROL2B(1)
                    END IF
                  ELSE IF (0. .LT. lac_2) THEN
                    x29 = lac_2
                    CALL PUSHCONTROL2B(2)
                  ELSE
                    CALL PUSHCONTROL2B(3)
                    x29 = 0.
                  END IF
                  IF (0. .GT. pmp_2) THEN
                    IF (pmp_2 .GT. lac_2) THEN
                      y44 = lac_2
                      CALL PUSHCONTROL2B(0)
                    ELSE
                      y44 = pmp_2
                      CALL PUSHCONTROL2B(1)
                    END IF
                  ELSE IF (0. .GT. lac_2) THEN
                    y44 = lac_2
                    CALL PUSHCONTROL2B(2)
                  ELSE
                    y44 = 0.
                    CALL PUSHCONTROL2B(3)
                  END IF
                  IF (br(i, j) .LT. y44) THEN
                    y28 = y44
                    CALL PUSHCONTROL1B(0)
                  ELSE
                    y28 = br(i, j)
                    CALL PUSHCONTROL1B(1)
                  END IF
                  IF (x29 .GT. y28) THEN
                    br(i, j) = y28
                    CALL PUSHCONTROL2B(1)
                  ELSE
                    br(i, j) = x29
                    CALL PUSHCONTROL2B(2)
                  END IF
                ELSE
                  CALL PUSHCONTROL2B(0)
                END IF
              END IF
            END DO
          END DO
          CALL PUSHCONTROL2B(2)
        END IF
        IF (jord .NE. 11) THEN
! Positive definite constraint:
          DO j=js3,je3
            arg1 = ilast - ifirst + 1
            CALL PUSHREALARRAY_ADM(br(ifirst, j), 8*(ilast-ifirst+1)/8)
            CALL PUSHREALARRAY_ADM(bl(ifirst, j), 8*(ilast-ifirst+1)/8)
            CALL PERT_PPM(arg1, q(ifirst, j), bl(ifirst, j), br(ifirst, &
&                   j), 0)
          END DO
          CALL PUSHCONTROL1B(0)
        ELSE
          CALL PUSHCONTROL1B(1)
        END IF
!--------------
! Fix the edges:
!--------------
        IF (.NOT.nested) THEN
          IF (js .EQ. 1) THEN
            DO i=ifirst,ilast
              br(i, 2) = al(i, 3) - q(i, 2)
!           xt = t11*(q(i,0)+q(i,1)) + t12*(q(i,-1)+q(i,2))   &
!              + t13*(dm(i,2)-dm(i,-1))
!!!         xt = 0.75*(q(i,0)+q(i,1)) - 0.25*(q(i,-1)+q(i,2))
              x0l = 0.5*((2.*dya(i, 0)+dya(i, -1))*q(i, 0)-dya(i, 0)*q(i&
&               , -1))/(dya(i, 0)+dya(i, -1))
              x0r = 0.5*((2.*dya(i, 1)+dya(i, 2))*q(i, 1)-dya(i, 1)*q(i&
&               , 2))/(dya(i, 1)+dya(i, 2))
              xt = x0l + x0r
              IF (0. .LT. xt) THEN
                CALL PUSHCONTROL1B(0)
                xt = xt
              ELSE
                xt = 0.
                CALL PUSHCONTROL1B(1)
              END IF
              bl(i, 1) = xt - q(i, 1)
              br(i, 0) = xt - q(i, 0)
              xt = 4./7.*dm(i, -1) + 11./14.*q(i, -1) + 3./14.*q(i, 0)
              IF (0. .LT. xt) THEN
                CALL PUSHCONTROL1B(0)
                xt = xt
              ELSE
                xt = 0.
                CALL PUSHCONTROL1B(1)
              END IF
              bl(i, 0) = xt - q(i, 0)
              xt = 3./14.*q(i, 1) + 11./14.*q(i, 2) - 4./7.*dm(i, 2)
              IF (0. .LT. xt) THEN
                CALL PUSHCONTROL1B(0)
                xt = xt
              ELSE
                xt = 0.
                CALL PUSHCONTROL1B(1)
              END IF
              br(i, 1) = xt - q(i, 1)
              bl(i, 2) = xt - q(i, 2)
            END DO
            DO j=0,2
              arg1 = ilast - ifirst + 1
              CALL PUSHREALARRAY_ADM(br(ifirst, j), 8*(ilast-ifirst+1)/&
&                           8)
              CALL PUSHREALARRAY_ADM(bl(ifirst, j), 8*(ilast-ifirst+1)/&
&                           8)
              CALL PERT_PPM(arg1, q(ifirst, j), bl(ifirst, j), br(ifirst&
&                     , j), 1)
            END DO
            CALL PUSHCONTROL1B(0)
          ELSE
            CALL PUSHCONTROL1B(1)
          END IF
          IF (je + 1 .EQ. npy) THEN
            DO i=ifirst,ilast
              bl(i, npy-2) = al(i, npy-2) - q(i, npy-2)
!           xt = t11*(q(i,npy-1)+q(i,npy)) + t12*(q(i,npy-2)+q(i,npy+1))   &
!               + t13*(dm(i,npy+1)-dm(i,npy-2))
!!!         xt = 0.75*(q(i,npy-1)+q(i,npy)) - 0.25*(q(i,npy-2)+q(i,npy+1))
              x0l = 0.5*((2.*dya(i, npy-1)+dya(i, npy-2))*q(i, npy-1)-&
&               dya(i, npy-1)*q(i, npy-2))/(dya(i, npy-1)+dya(i, npy-2))
              x0r = 0.5*((2.*dya(i, npy)+dya(i, npy+1))*q(i, npy)-dya(i&
&               , npy)*q(i, npy+1))/(dya(i, npy)+dya(i, npy+1))
              xt = x0l + x0r
              IF (0. .LT. xt) THEN
                CALL PUSHCONTROL1B(0)
                xt = xt
              ELSE
                xt = 0.
                CALL PUSHCONTROL1B(1)
              END IF
              br(i, npy-1) = xt - q(i, npy-1)
              bl(i, npy) = xt - q(i, npy)
              xt = 3./14.*q(i, npy) + 11./14.*q(i, npy+1) - 4./7.*dm(i, &
&               npy+1)
              IF (0. .LT. xt) THEN
                CALL PUSHCONTROL1B(0)
                xt = xt
              ELSE
                xt = 0.
                CALL PUSHCONTROL1B(1)
              END IF
              br(i, npy) = xt - q(i, npy)
              xt = 3./14.*q(i, npy-1) + 11./14.*q(i, npy-2) + 4./7.*dm(i&
&               , npy-2)
              IF (0. .LT. xt) THEN
                CALL PUSHCONTROL1B(0)
                xt = xt
              ELSE
                xt = 0.
                CALL PUSHCONTROL1B(1)
              END IF
              br(i, npy-2) = xt - q(i, npy-2)
              bl(i, npy-1) = xt - q(i, npy-1)
            END DO
            DO j=npy-2,npy
              arg1 = ilast - ifirst + 1
              CALL PUSHREALARRAY_ADM(br(ifirst, j), 8*(ilast-ifirst+1)/&
&                           8)
              CALL PUSHREALARRAY_ADM(bl(ifirst, j), 8*(ilast-ifirst+1)/&
&                           8)
              CALL PERT_PPM(arg1, q(ifirst, j), bl(ifirst, j), br(ifirst&
&                     , j), 1)
            END DO
            CALL PUSHCONTROL3B(4)
          ELSE
            CALL PUSHCONTROL3B(3)
          END IF
        ELSE
          CALL PUSHCONTROL3B(2)
        END IF
      ELSE
        DO j=js-1,je+2
          DO i=ifirst,ilast
            al(i, j) = 0.5*(q(i, j-1)+q(i, j)) + r3*(dm(i, j-1)-dm(i, j)&
&             )
          END DO
        END DO
        IF (jord .EQ. 11) THEN
          DO j=js-1,je+1
            DO i=ifirst,ilast
              xt = 2.*dm(i, j)
              IF (xt .GE. 0.) THEN
                x30 = xt
                CALL PUSHCONTROL1B(0)
              ELSE
                x30 = -xt
                CALL PUSHCONTROL1B(1)
              END IF
              IF (al(i, j) - q(i, j) .GE. 0.) THEN
                y29 = al(i, j) - q(i, j)
                CALL PUSHCONTROL1B(0)
              ELSE
                y29 = -(al(i, j)-q(i, j))
                CALL PUSHCONTROL1B(1)
              END IF
              IF (x30 .GT. y29) THEN
                CALL PUSHREALARRAY_ADM(min17)
                min17 = y29
                CALL PUSHCONTROL1B(0)
              ELSE
                CALL PUSHREALARRAY_ADM(min17)
                min17 = x30
                CALL PUSHCONTROL1B(1)
              END IF
              bl(i, j) = -SIGN(min17, xt)
              IF (xt .GE. 0.) THEN
                x31 = xt
                CALL PUSHCONTROL1B(0)
              ELSE
                x31 = -xt
                CALL PUSHCONTROL1B(1)
              END IF
              IF (al(i, j+1) - q(i, j) .GE. 0.) THEN
                y30 = al(i, j+1) - q(i, j)
                CALL PUSHCONTROL1B(0)
              ELSE
                y30 = -(al(i, j+1)-q(i, j))
                CALL PUSHCONTROL1B(1)
              END IF
              IF (x31 .GT. y30) THEN
                CALL PUSHREALARRAY_ADM(min18)
                min18 = y30
                CALL PUSHCONTROL1B(0)
              ELSE
                CALL PUSHREALARRAY_ADM(min18)
                min18 = x31
                CALL PUSHCONTROL1B(1)
              END IF
              br(i, j) = SIGN(min18, xt)
            END DO
          END DO
          CALL PUSHCONTROL2B(0)
        ELSE IF (jord .EQ. 12) THEN
          DO j=js-3,je+2
            DO i=ifirst,ilast
              dq(i, j) = q(i, j+1) - q(i, j)
            END DO
          END DO
          DO j=js-1,je+1
            DO i=ifirst,ilast
              pmp = -(2.*dq(i, j))
              lac = pmp + 1.5*dq(i, j+1)
              IF (0. .LT. pmp) THEN
                IF (pmp .LT. lac) THEN
                  x32 = lac
                  CALL PUSHCONTROL2B(0)
                ELSE
                  x32 = pmp
                  CALL PUSHCONTROL2B(1)
                END IF
              ELSE IF (0. .LT. lac) THEN
                x32 = lac
                CALL PUSHCONTROL2B(2)
              ELSE
                CALL PUSHCONTROL2B(3)
                x32 = 0.
              END IF
              IF (0. .GT. pmp) THEN
                IF (pmp .GT. lac) THEN
                  y45 = lac
                  CALL PUSHCONTROL2B(0)
                ELSE
                  y45 = pmp
                  CALL PUSHCONTROL2B(1)
                END IF
              ELSE IF (0. .GT. lac) THEN
                y45 = lac
                CALL PUSHCONTROL2B(2)
              ELSE
                y45 = 0.
                CALL PUSHCONTROL2B(3)
              END IF
              IF (al(i, j) - q(i, j) .LT. y45) THEN
                y31 = y45
                CALL PUSHCONTROL1B(0)
              ELSE
                y31 = al(i, j) - q(i, j)
                CALL PUSHCONTROL1B(1)
              END IF
              IF (x32 .GT. y31) THEN
                bl(i, j) = y31
                CALL PUSHCONTROL1B(0)
              ELSE
                bl(i, j) = x32
                CALL PUSHCONTROL1B(1)
              END IF
              pmp = 2.*dq(i, j-1)
              lac = pmp - 1.5*dq(i, j-2)
              IF (0. .LT. pmp) THEN
                IF (pmp .LT. lac) THEN
                  x33 = lac
                  CALL PUSHCONTROL2B(0)
                ELSE
                  x33 = pmp
                  CALL PUSHCONTROL2B(1)
                END IF
              ELSE IF (0. .LT. lac) THEN
                x33 = lac
                CALL PUSHCONTROL2B(2)
              ELSE
                CALL PUSHCONTROL2B(3)
                x33 = 0.
              END IF
              IF (0. .GT. pmp) THEN
                IF (pmp .GT. lac) THEN
                  y46 = lac
                  CALL PUSHCONTROL2B(0)
                ELSE
                  y46 = pmp
                  CALL PUSHCONTROL2B(1)
                END IF
              ELSE IF (0. .GT. lac) THEN
                y46 = lac
                CALL PUSHCONTROL2B(2)
              ELSE
                y46 = 0.
                CALL PUSHCONTROL2B(3)
              END IF
              IF (al(i, j+1) - q(i, j) .LT. y46) THEN
                y32 = y46
                CALL PUSHCONTROL1B(0)
              ELSE
                y32 = al(i, j+1) - q(i, j)
                CALL PUSHCONTROL1B(1)
              END IF
              IF (x33 .GT. y32) THEN
                br(i, j) = y32
                CALL PUSHCONTROL1B(0)
              ELSE
                br(i, j) = x33
                CALL PUSHCONTROL1B(1)
              END IF
            END DO
          END DO
          CALL PUSHCONTROL2B(1)
        ELSE
          DO j=js-1,je+1
            DO i=ifirst,ilast
              bl(i, j) = al(i, j) - q(i, j)
              br(i, j) = al(i, j+1) - q(i, j)
            END DO
          END DO
          CALL PUSHCONTROL2B(2)
        END IF
        IF (jord .NE. 11) THEN
! Positive definite constraint:
          DO j=js-1,je+1
            arg1 = ilast - ifirst + 1
            CALL PUSHREALARRAY_ADM(br(ifirst, j), 8*(ilast-ifirst+1)/8)
            CALL PUSHREALARRAY_ADM(bl(ifirst, j), 8*(ilast-ifirst+1)/8)
            CALL PERT_PPM(arg1, q(ifirst, j), bl(ifirst, j), br(ifirst, &
&                   j), 0)
          END DO
          CALL PUSHCONTROL3B(1)
        ELSE
          CALL PUSHCONTROL3B(0)
        END IF
      END IF
      DO j=js,je+1
        DO i=ifirst,ilast
          IF (c(i, j) .GT. 0.) THEN
            CALL PUSHCONTROL1B(1)
          ELSE
            CALL PUSHCONTROL1B(0)
          END IF
        END DO
      END DO
      bl_ad = 0.0_FVPRC
      br_ad = 0.0_FVPRC
      DO j=je+1,js,-1
        DO i=ilast,ifirst,-1
          CALL POPCONTROL1B(branch)
          IF (branch .EQ. 0) THEN
            temp8 = bl(i, j) + br(i, j)
            temp_ad37 = (c(i, j)+1.)*flux_ad(i, j)
            temp_ad38 = c(i, j)*temp_ad37
            q_ad(i, j) = q_ad(i, j) + flux_ad(i, j)
            c_ad(i, j) = c_ad(i, j) + temp8*temp_ad37 + (bl(i, j)+c(i, j&
&             )*temp8)*flux_ad(i, j)
            bl_ad(i, j) = bl_ad(i, j) + temp_ad38 + temp_ad37
            br_ad(i, j) = br_ad(i, j) + temp_ad38
            flux_ad(i, j) = 0.0_FVPRC
          ELSE
            temp7 = bl(i, j-1) + br(i, j-1)
            temp_ad35 = (1.-c(i, j))*flux_ad(i, j)
            temp_ad36 = -(c(i, j)*temp_ad35)
            q_ad(i, j-1) = q_ad(i, j-1) + flux_ad(i, j)
            c_ad(i, j) = c_ad(i, j) - temp7*temp_ad35 - (br(i, j-1)-c(i&
&             , j)*temp7)*flux_ad(i, j)
            br_ad(i, j-1) = br_ad(i, j-1) + temp_ad36 + temp_ad35
            bl_ad(i, j-1) = bl_ad(i, j-1) + temp_ad36
            flux_ad(i, j) = 0.0_FVPRC
          END IF
        END DO
      END DO
      CALL POPCONTROL3B(branch)
      IF (branch .LT. 2) THEN
        IF (branch .NE. 0) THEN
          DO j=je+1,js-1,-1
            arg1 = ilast - ifirst + 1
            CALL POPREALARRAY_ADM(bl(ifirst, j), 8*(ilast-ifirst+1)/8)
            CALL POPREALARRAY_ADM(br(ifirst, j), 8*(ilast-ifirst+1)/8)
            CALL PERT_PPM_ADM(arg1, q(ifirst, j), bl(ifirst:, j), bl_ad(&
&                       ifirst:, j), br(ifirst:, j), br_ad(ifirst:, j), &
&                       0)
          END DO
        END IF
        CALL POPCONTROL2B(branch)
        IF (branch .EQ. 0) THEN
          dm_ad = 0.0_FVPRC
          al_ad = 0.0_FVPRC
          DO j=je+1,js-1,-1
            DO i=ilast,ifirst,-1
              xt = 2.*dm(i, j)
              min18_ad = SIGN(1.d0, min18*xt)*br_ad(i, j)
              br_ad(i, j) = 0.0_FVPRC
              CALL POPCONTROL1B(branch)
              IF (branch .EQ. 0) THEN
                CALL POPREALARRAY_ADM(min18)
                y30_ad = min18_ad
                x31_ad = 0.0_FVPRC
              ELSE
                CALL POPREALARRAY_ADM(min18)
                x31_ad = min18_ad
                y30_ad = 0.0_FVPRC
              END IF
              CALL POPCONTROL1B(branch)
              IF (branch .EQ. 0) THEN
                al_ad(i, j+1) = al_ad(i, j+1) + y30_ad
                q_ad(i, j) = q_ad(i, j) - y30_ad
              ELSE
                q_ad(i, j) = q_ad(i, j) + y30_ad
                al_ad(i, j+1) = al_ad(i, j+1) - y30_ad
              END IF
              CALL POPCONTROL1B(branch)
              IF (branch .EQ. 0) THEN
                xt_ad = x31_ad
              ELSE
                xt_ad = -x31_ad
              END IF
              min17_ad = -(SIGN(1.d0, min17*xt)*bl_ad(i, j))
              bl_ad(i, j) = 0.0_FVPRC
              CALL POPCONTROL1B(branch)
              IF (branch .EQ. 0) THEN
                CALL POPREALARRAY_ADM(min17)
                y29_ad = min17_ad
                x30_ad = 0.0_FVPRC
              ELSE
                CALL POPREALARRAY_ADM(min17)
                x30_ad = min17_ad
                y29_ad = 0.0_FVPRC
              END IF
              CALL POPCONTROL1B(branch)
              IF (branch .EQ. 0) THEN
                al_ad(i, j) = al_ad(i, j) + y29_ad
                q_ad(i, j) = q_ad(i, j) - y29_ad
              ELSE
                q_ad(i, j) = q_ad(i, j) + y29_ad
                al_ad(i, j) = al_ad(i, j) - y29_ad
              END IF
              CALL POPCONTROL1B(branch)
              IF (branch .EQ. 0) THEN
                xt_ad = xt_ad + x30_ad
              ELSE
                xt_ad = xt_ad - x30_ad
              END IF
              dm_ad(i, j) = dm_ad(i, j) + 2.*xt_ad
            END DO
          END DO
        ELSE
          IF (branch .EQ. 1) THEN
            dq_ad = 0.0_FVPRC
            al_ad = 0.0_FVPRC
            DO j=je+1,js-1,-1
              DO i=ilast,ifirst,-1
                CALL POPCONTROL1B(branch)
                IF (branch .EQ. 0) THEN
                  y32_ad = br_ad(i, j)
                  br_ad(i, j) = 0.0_FVPRC
                  x33_ad = 0.0_FVPRC
                ELSE
                  x33_ad = br_ad(i, j)
                  br_ad(i, j) = 0.0_FVPRC
                  y32_ad = 0.0_FVPRC
                END IF
                CALL POPCONTROL1B(branch)
                IF (branch .EQ. 0) THEN
                  y46_ad = y32_ad
                ELSE
                  al_ad(i, j+1) = al_ad(i, j+1) + y32_ad
                  q_ad(i, j) = q_ad(i, j) - y32_ad
                  y46_ad = 0.0_FVPRC
                END IF
                CALL POPCONTROL2B(branch)
                IF (branch .LT. 2) THEN
                  IF (branch .EQ. 0) THEN
                    lac_ad = y46_ad
                    pmp_ad = 0.0_FVPRC
                  ELSE
                    pmp_ad = y46_ad
                    lac_ad = 0.0_FVPRC
                  END IF
                ELSE
                  IF (branch .EQ. 2) THEN
                    lac_ad = y46_ad
                  ELSE
                    lac_ad = 0.0_FVPRC
                  END IF
                  pmp_ad = 0.0_FVPRC
                END IF
                CALL POPCONTROL2B(branch)
                IF (branch .LT. 2) THEN
                  IF (branch .EQ. 0) THEN
                    lac_ad = lac_ad + x33_ad
                  ELSE
                    pmp_ad = pmp_ad + x33_ad
                  END IF
                ELSE IF (branch .EQ. 2) THEN
                  lac_ad = lac_ad + x33_ad
                END IF
                pmp_ad = pmp_ad + lac_ad
                dq_ad(i, j-2) = dq_ad(i, j-2) - 1.5*lac_ad
                dq_ad(i, j-1) = dq_ad(i, j-1) + 2.*pmp_ad
                CALL POPCONTROL1B(branch)
                IF (branch .EQ. 0) THEN
                  y31_ad = bl_ad(i, j)
                  bl_ad(i, j) = 0.0_FVPRC
                  x32_ad = 0.0_FVPRC
                ELSE
                  x32_ad = bl_ad(i, j)
                  bl_ad(i, j) = 0.0_FVPRC
                  y31_ad = 0.0_FVPRC
                END IF
                CALL POPCONTROL1B(branch)
                IF (branch .EQ. 0) THEN
                  y45_ad = y31_ad
                ELSE
                  al_ad(i, j) = al_ad(i, j) + y31_ad
                  q_ad(i, j) = q_ad(i, j) - y31_ad
                  y45_ad = 0.0_FVPRC
                END IF
                CALL POPCONTROL2B(branch)
                IF (branch .LT. 2) THEN
                  IF (branch .EQ. 0) THEN
                    lac_ad = y45_ad
                    pmp_ad = 0.0_FVPRC
                  ELSE
                    pmp_ad = y45_ad
                    lac_ad = 0.0_FVPRC
                  END IF
                ELSE
                  IF (branch .EQ. 2) THEN
                    lac_ad = y45_ad
                  ELSE
                    lac_ad = 0.0_FVPRC
                  END IF
                  pmp_ad = 0.0_FVPRC
                END IF
                CALL POPCONTROL2B(branch)
                IF (branch .LT. 2) THEN
                  IF (branch .EQ. 0) THEN
                    lac_ad = lac_ad + x32_ad
                  ELSE
                    pmp_ad = pmp_ad + x32_ad
                  END IF
                ELSE IF (branch .EQ. 2) THEN
                  lac_ad = lac_ad + x32_ad
                END IF
                pmp_ad = pmp_ad + lac_ad
                dq_ad(i, j+1) = dq_ad(i, j+1) + 1.5*lac_ad
                dq_ad(i, j) = dq_ad(i, j) - 2.*pmp_ad
              END DO
            END DO
            DO j=je+2,js-3,-1
              DO i=ilast,ifirst,-1
                q_ad(i, j+1) = q_ad(i, j+1) + dq_ad(i, j)
                q_ad(i, j) = q_ad(i, j) - dq_ad(i, j)
                dq_ad(i, j) = 0.0_FVPRC
              END DO
            END DO
          ELSE
            al_ad = 0.0_FVPRC
            DO j=je+1,js-1,-1
              DO i=ilast,ifirst,-1
                al_ad(i, j+1) = al_ad(i, j+1) + br_ad(i, j)
                q_ad(i, j) = q_ad(i, j) - bl_ad(i, j) - br_ad(i, j)
                br_ad(i, j) = 0.0_FVPRC
                al_ad(i, j) = al_ad(i, j) + bl_ad(i, j)
                bl_ad(i, j) = 0.0_FVPRC
              END DO
            END DO
          END IF
          dm_ad = 0.0_FVPRC
        END IF
        DO j=je+2,js-1,-1
          DO i=ilast,ifirst,-1
            q_ad(i, j-1) = q_ad(i, j-1) + 0.5*al_ad(i, j)
            q_ad(i, j) = q_ad(i, j) + 0.5*al_ad(i, j)
            dm_ad(i, j-1) = dm_ad(i, j-1) + r3*al_ad(i, j)
            dm_ad(i, j) = dm_ad(i, j) - r3*al_ad(i, j)
            al_ad(i, j) = 0.0_FVPRC
          END DO
        END DO
      ELSE
        IF (branch .EQ. 2) THEN
          dm_ad = 0.0_FVPRC
          al_ad = 0.0_FVPRC
        ELSE
          IF (branch .EQ. 3) THEN
            dm_ad = 0.0_FVPRC
            al_ad = 0.0_FVPRC
          ELSE
            DO j=npy,npy-2,-1
              arg1 = ilast - ifirst + 1
              CALL POPREALARRAY_ADM(bl(ifirst, j), 8*(ilast-ifirst+1)/8&
&                         )
              CALL POPREALARRAY_ADM(br(ifirst, j), 8*(ilast-ifirst+1)/8&
&                         )
              CALL PERT_PPM_ADM(arg1, q(ifirst, j), bl(ifirst:, j), &
&                         bl_ad(ifirst:, j), br(ifirst:, j), br_ad(&
&                         ifirst:, j), 1)
            END DO
            dm_ad = 0.0_FVPRC
            al_ad = 0.0_FVPRC
            DO i=ilast,ifirst,-1
              xt_ad = br_ad(i, npy-2) + bl_ad(i, npy-1)
              q_ad(i, npy-1) = q_ad(i, npy-1) - bl_ad(i, npy-1)
              bl_ad(i, npy-1) = 0.0_FVPRC
              q_ad(i, npy-2) = q_ad(i, npy-2) - br_ad(i, npy-2)
              br_ad(i, npy-2) = 0.0_FVPRC
              CALL POPCONTROL1B(branch)
              IF (branch .NE. 0) xt_ad = 0.0_FVPRC
              q_ad(i, npy-1) = q_ad(i, npy-1) + 3.*xt_ad/14.
              q_ad(i, npy-2) = q_ad(i, npy-2) + 11.*xt_ad/14.
              dm_ad(i, npy-2) = dm_ad(i, npy-2) + 4.*xt_ad/7.
              xt_ad = br_ad(i, npy)
              q_ad(i, npy) = q_ad(i, npy) - br_ad(i, npy)
              br_ad(i, npy) = 0.0_FVPRC
              CALL POPCONTROL1B(branch)
              IF (branch .NE. 0) xt_ad = 0.0_FVPRC
              q_ad(i, npy) = q_ad(i, npy) + 3.*xt_ad/14.
              q_ad(i, npy+1) = q_ad(i, npy+1) + 11.*xt_ad/14.
              dm_ad(i, npy+1) = dm_ad(i, npy+1) - 4.*xt_ad/7.
              xt_ad = br_ad(i, npy-1) + bl_ad(i, npy)
              q_ad(i, npy) = q_ad(i, npy) - bl_ad(i, npy)
              bl_ad(i, npy) = 0.0_FVPRC
              q_ad(i, npy-1) = q_ad(i, npy-1) - br_ad(i, npy-1)
              br_ad(i, npy-1) = 0.0_FVPRC
              CALL POPCONTROL1B(branch)
              IF (branch .NE. 0) xt_ad = 0.0_FVPRC
              x0l_ad = xt_ad
              x0r_ad = xt_ad
              temp_ad33 = 0.5*x0r_ad/(dya(i, npy)+dya(i, npy+1))
              q_ad(i, npy) = q_ad(i, npy) + (dya(i, npy)*2.+dya(i, npy+1&
&               ))*temp_ad33
              q_ad(i, npy+1) = q_ad(i, npy+1) - dya(i, npy)*temp_ad33
              temp_ad34 = 0.5*x0l_ad/(dya(i, npy-1)+dya(i, npy-2))
              q_ad(i, npy-1) = q_ad(i, npy-1) + (dya(i, npy-1)*2.+dya(i&
&               , npy-2))*temp_ad34
              q_ad(i, npy-2) = q_ad(i, npy-2) - bl_ad(i, npy-2) - dya(i&
&               , npy-1)*temp_ad34
              al_ad(i, npy-2) = al_ad(i, npy-2) + bl_ad(i, npy-2)
              bl_ad(i, npy-2) = 0.0_FVPRC
            END DO
          END IF
          CALL POPCONTROL1B(branch)
          IF (branch .EQ. 0) THEN
            DO j=2,0,-1
              arg1 = ilast - ifirst + 1
              CALL POPREALARRAY_ADM(bl(ifirst, j), 8*(ilast-ifirst+1)/8&
&                         )
              CALL POPREALARRAY_ADM(br(ifirst, j), 8*(ilast-ifirst+1)/8&
&                         )
              CALL PERT_PPM_ADM(arg1, q(ifirst, j), bl(ifirst:, j), &
&                         bl_ad(ifirst:, j), br(ifirst:, j), br_ad(&
&                         ifirst:, j), 1)
            END DO
            DO i=ilast,ifirst,-1
              xt_ad = br_ad(i, 1) + bl_ad(i, 2)
              q_ad(i, 2) = q_ad(i, 2) - bl_ad(i, 2)
              bl_ad(i, 2) = 0.0_FVPRC
              q_ad(i, 1) = q_ad(i, 1) - br_ad(i, 1)
              br_ad(i, 1) = 0.0_FVPRC
              CALL POPCONTROL1B(branch)
              IF (branch .NE. 0) xt_ad = 0.0_FVPRC
              q_ad(i, 1) = q_ad(i, 1) + 3.*xt_ad/14.
              q_ad(i, 2) = q_ad(i, 2) + 11.*xt_ad/14.
              dm_ad(i, 2) = dm_ad(i, 2) - 4.*xt_ad/7.
              xt_ad = bl_ad(i, 0)
              q_ad(i, 0) = q_ad(i, 0) - bl_ad(i, 0)
              bl_ad(i, 0) = 0.0_FVPRC
              CALL POPCONTROL1B(branch)
              IF (branch .NE. 0) xt_ad = 0.0_FVPRC
              dm_ad(i, -1) = dm_ad(i, -1) + 4.*xt_ad/7.
              q_ad(i, -1) = q_ad(i, -1) + 11.*xt_ad/14.
              q_ad(i, 0) = q_ad(i, 0) + 3.*xt_ad/14. - br_ad(i, 0)
              xt_ad = bl_ad(i, 1) + br_ad(i, 0)
              br_ad(i, 0) = 0.0_FVPRC
              q_ad(i, 1) = q_ad(i, 1) - bl_ad(i, 1)
              bl_ad(i, 1) = 0.0_FVPRC
              CALL POPCONTROL1B(branch)
              IF (branch .NE. 0) xt_ad = 0.0_FVPRC
              x0l_ad = xt_ad
              x0r_ad = xt_ad
              temp_ad31 = 0.5*x0r_ad/(dya(i, 1)+dya(i, 2))
              q_ad(i, 1) = q_ad(i, 1) + (dya(i, 1)*2.+dya(i, 2))*&
&               temp_ad31
              q_ad(i, 2) = q_ad(i, 2) - dya(i, 1)*temp_ad31
              temp_ad32 = 0.5*x0l_ad/(dya(i, 0)+dya(i, -1))
              q_ad(i, 0) = q_ad(i, 0) + (dya(i, 0)*2.+dya(i, -1))*&
&               temp_ad32
              q_ad(i, -1) = q_ad(i, -1) - dya(i, 0)*temp_ad32
              al_ad(i, 3) = al_ad(i, 3) + br_ad(i, 2)
              q_ad(i, 2) = q_ad(i, 2) - br_ad(i, 2)
              br_ad(i, 2) = 0.0_FVPRC
            END DO
          END IF
        END IF
        CALL POPCONTROL1B(branch)
        IF (branch .EQ. 0) THEN
          DO j=je3,js3,-1
            arg1 = ilast - ifirst + 1
            CALL POPREALARRAY_ADM(bl(ifirst, j), 8*(ilast-ifirst+1)/8)
            CALL POPREALARRAY_ADM(br(ifirst, j), 8*(ilast-ifirst+1)/8)
            CALL PERT_PPM_ADM(arg1, q(ifirst, j), bl(ifirst:, j), bl_ad(&
&                       ifirst:, j), br(ifirst:, j), br_ad(ifirst:, j), &
&                       0)
          END DO
        END IF
        CALL POPCONTROL2B(branch)
        IF (branch .EQ. 0) THEN
          DO j=je3,js3,-1
            DO i=ilast,ifirst,-1
              xt = 2.*dm(i, j)
              min16_ad = SIGN(1.d0, min16*xt)*br_ad(i, j)
              br_ad(i, j) = 0.0_FVPRC
              CALL POPCONTROL1B(branch)
              IF (branch .EQ. 0) THEN
                CALL POPREALARRAY_ADM(min16)
                y24_ad = min16_ad
                x25_ad = 0.0_FVPRC
              ELSE
                CALL POPREALARRAY_ADM(min16)
                x25_ad = min16_ad
                y24_ad = 0.0_FVPRC
              END IF
              CALL POPCONTROL1B(branch)
              IF (branch .EQ. 0) THEN
                al_ad(i, j+1) = al_ad(i, j+1) + y24_ad
                q_ad(i, j) = q_ad(i, j) - y24_ad
              ELSE
                q_ad(i, j) = q_ad(i, j) + y24_ad
                al_ad(i, j+1) = al_ad(i, j+1) - y24_ad
              END IF
              CALL POPCONTROL1B(branch)
              IF (branch .EQ. 0) THEN
                xt_ad = x25_ad
              ELSE
                xt_ad = -x25_ad
              END IF
              min15_ad = -(SIGN(1.d0, min15*xt)*bl_ad(i, j))
              bl_ad(i, j) = 0.0_FVPRC
              CALL POPCONTROL1B(branch)
              IF (branch .EQ. 0) THEN
                CALL POPREALARRAY_ADM(min15)
                y23_ad = min15_ad
                x24_ad = 0.0_FVPRC
              ELSE
                CALL POPREALARRAY_ADM(min15)
                x24_ad = min15_ad
                y23_ad = 0.0_FVPRC
              END IF
              CALL POPCONTROL1B(branch)
              IF (branch .EQ. 0) THEN
                al_ad(i, j) = al_ad(i, j) + y23_ad
                q_ad(i, j) = q_ad(i, j) - y23_ad
              ELSE
                q_ad(i, j) = q_ad(i, j) + y23_ad
                al_ad(i, j) = al_ad(i, j) - y23_ad
              END IF
              CALL POPCONTROL1B(branch)
              IF (branch .EQ. 0) THEN
                xt_ad = xt_ad + x24_ad
              ELSE
                xt_ad = xt_ad - x24_ad
              END IF
              dm_ad(i, j) = dm_ad(i, j) + 2.*xt_ad
            END DO
          END DO
        ELSE IF (branch .EQ. 1) THEN
          dq_ad = 0.0_FVPRC
          DO j=je3,js3,-1
            DO i=ilast,ifirst,-1
              CALL POPCONTROL1B(branch)
              IF (branch .EQ. 0) THEN
                y26_ad = br_ad(i, j)
                br_ad(i, j) = 0.0_FVPRC
                x27_ad = 0.0_FVPRC
              ELSE
                x27_ad = br_ad(i, j)
                br_ad(i, j) = 0.0_FVPRC
                y26_ad = 0.0_FVPRC
              END IF
              CALL POPCONTROL1B(branch)
              IF (branch .EQ. 0) THEN
                y42_ad = y26_ad
              ELSE
                al_ad(i, j+1) = al_ad(i, j+1) + y26_ad
                q_ad(i, j) = q_ad(i, j) - y26_ad
                y42_ad = 0.0_FVPRC
              END IF
              CALL POPCONTROL2B(branch)
              IF (branch .LT. 2) THEN
                IF (branch .EQ. 0) THEN
                  lac_ad = y42_ad
                  pmp_ad = 0.0_FVPRC
                ELSE
                  pmp_ad = y42_ad
                  lac_ad = 0.0_FVPRC
                END IF
              ELSE
                IF (branch .EQ. 2) THEN
                  lac_ad = y42_ad
                ELSE
                  lac_ad = 0.0_FVPRC
                END IF
                pmp_ad = 0.0_FVPRC
              END IF
              CALL POPCONTROL2B(branch)
              IF (branch .LT. 2) THEN
                IF (branch .EQ. 0) THEN
                  lac_ad = lac_ad + x27_ad
                ELSE
                  pmp_ad = pmp_ad + x27_ad
                END IF
              ELSE IF (branch .EQ. 2) THEN
                lac_ad = lac_ad + x27_ad
              END IF
              pmp_ad = pmp_ad + lac_ad
              dq_ad(i, j-2) = dq_ad(i, j-2) - 1.5*lac_ad
              dq_ad(i, j-1) = dq_ad(i, j-1) + 2.*pmp_ad
              CALL POPCONTROL1B(branch)
              IF (branch .EQ. 0) THEN
                y25_ad = bl_ad(i, j)
                bl_ad(i, j) = 0.0_FVPRC
                x26_ad = 0.0_FVPRC
              ELSE
                x26_ad = bl_ad(i, j)
                bl_ad(i, j) = 0.0_FVPRC
                y25_ad = 0.0_FVPRC
              END IF
              CALL POPCONTROL1B(branch)
              IF (branch .EQ. 0) THEN
                y41_ad = y25_ad
              ELSE
                al_ad(i, j) = al_ad(i, j) + y25_ad
                q_ad(i, j) = q_ad(i, j) - y25_ad
                y41_ad = 0.0_FVPRC
              END IF
              CALL POPCONTROL2B(branch)
              IF (branch .LT. 2) THEN
                IF (branch .EQ. 0) THEN
                  lac_ad = y41_ad
                  pmp_ad = 0.0_FVPRC
                ELSE
                  pmp_ad = y41_ad
                  lac_ad = 0.0_FVPRC
                END IF
              ELSE
                IF (branch .EQ. 2) THEN
                  lac_ad = y41_ad
                ELSE
                  lac_ad = 0.0_FVPRC
                END IF
                pmp_ad = 0.0_FVPRC
              END IF
              CALL POPCONTROL2B(branch)
              IF (branch .LT. 2) THEN
                IF (branch .EQ. 0) THEN
                  lac_ad = lac_ad + x26_ad
                ELSE
                  pmp_ad = pmp_ad + x26_ad
                END IF
              ELSE IF (branch .EQ. 2) THEN
                lac_ad = lac_ad + x26_ad
              END IF
              pmp_ad = pmp_ad + lac_ad
              dq_ad(i, j+1) = dq_ad(i, j+1) + 1.5*lac_ad
              dq_ad(i, j) = dq_ad(i, j) - 2.*pmp_ad
            END DO
          END DO
          DO j=je+2,js-3,-1
            DO i=ilast,ifirst,-1
              q_ad(i, j+1) = q_ad(i, j+1) + dq_ad(i, j)
              q_ad(i, j) = q_ad(i, j) - dq_ad(i, j)
              dq_ad(i, j) = 0.0_FVPRC
            END DO
          END DO
        ELSE
          dq_ad = 0.0_FVPRC
          DO j=je3,js3,-1
            DO 140 i=ilast,ifirst,-1
              CALL POPCONTROL2B(branch)
              IF (branch .LT. 2) THEN
                IF (branch .EQ. 0) THEN
                  GOTO 130
                ELSE
                  y28_ad = br_ad(i, j)
                  br_ad(i, j) = 0.0_FVPRC
                  x29_ad = 0.0_FVPRC
                END IF
              ELSE IF (branch .EQ. 2) THEN
                x29_ad = br_ad(i, j)
                br_ad(i, j) = 0.0_FVPRC
                y28_ad = 0.0_FVPRC
              ELSE
                br_ad(i, j) = 0.0_FVPRC
                bl_ad(i, j) = 0.0_FVPRC
                GOTO 140
              END IF
              CALL POPCONTROL1B(branch)
              IF (branch .EQ. 0) THEN
                y44_ad = y28_ad
              ELSE
                br_ad(i, j) = br_ad(i, j) + y28_ad
                y44_ad = 0.0_FVPRC
              END IF
              CALL POPCONTROL2B(branch)
              IF (branch .LT. 2) THEN
                IF (branch .EQ. 0) THEN
                  lac_2_ad = y44_ad
                  pmp_2_ad = 0.0_FVPRC
                ELSE
                  pmp_2_ad = y44_ad
                  lac_2_ad = 0.0_FVPRC
                END IF
              ELSE
                IF (branch .EQ. 2) THEN
                  lac_2_ad = y44_ad
                ELSE
                  lac_2_ad = 0.0_FVPRC
                END IF
                pmp_2_ad = 0.0_FVPRC
              END IF
              CALL POPCONTROL2B(branch)
              IF (branch .LT. 2) THEN
                IF (branch .EQ. 0) THEN
                  lac_2_ad = lac_2_ad + x29_ad
                ELSE
                  pmp_2_ad = pmp_2_ad + x29_ad
                END IF
              ELSE IF (branch .EQ. 2) THEN
                lac_2_ad = lac_2_ad + x29_ad
              END IF
              pmp_2_ad = pmp_2_ad + lac_2_ad
              dq_ad(i, j-2) = dq_ad(i, j-2) - 1.5*lac_2_ad
              dq_ad(i, j-1) = dq_ad(i, j-1) + 2.*pmp_2_ad
              CALL POPCONTROL1B(branch)
              IF (branch .EQ. 0) THEN
                y27_ad = bl_ad(i, j)
                bl_ad(i, j) = 0.0_FVPRC
                x28_ad = 0.0_FVPRC
              ELSE
                x28_ad = bl_ad(i, j)
                bl_ad(i, j) = 0.0_FVPRC
                y27_ad = 0.0_FVPRC
              END IF
              CALL POPCONTROL1B(branch)
              IF (branch .EQ. 0) THEN
                y43_ad = y27_ad
              ELSE
                bl_ad(i, j) = bl_ad(i, j) + y27_ad
                y43_ad = 0.0_FVPRC
              END IF
              CALL POPCONTROL2B(branch)
              IF (branch .LT. 2) THEN
                IF (branch .EQ. 0) THEN
                  lac_1_ad = y43_ad
                  pmp_1_ad = 0.0_FVPRC
                ELSE
                  pmp_1_ad = y43_ad
                  lac_1_ad = 0.0_FVPRC
                END IF
              ELSE
                IF (branch .EQ. 2) THEN
                  lac_1_ad = y43_ad
                ELSE
                  lac_1_ad = 0.0_FVPRC
                END IF
                pmp_1_ad = 0.0_FVPRC
              END IF
              CALL POPCONTROL2B(branch)
              IF (branch .LT. 2) THEN
                IF (branch .EQ. 0) THEN
                  lac_1_ad = lac_1_ad + x28_ad
                ELSE
                  pmp_1_ad = pmp_1_ad + x28_ad
                END IF
              ELSE IF (branch .EQ. 2) THEN
                lac_1_ad = lac_1_ad + x28_ad
              END IF
              pmp_1_ad = pmp_1_ad + lac_1_ad
              dq_ad(i, j+1) = dq_ad(i, j+1) + 1.5*lac_1_ad
              dq_ad(i, j) = dq_ad(i, j) - 2.*pmp_1_ad
 130          al_ad(i, j+1) = al_ad(i, j+1) + br_ad(i, j)
              q_ad(i, j) = q_ad(i, j) - bl_ad(i, j) - br_ad(i, j)
              br_ad(i, j) = 0.0_FVPRC
              al_ad(i, j) = al_ad(i, j) + bl_ad(i, j)
              bl_ad(i, j) = 0.0_FVPRC
 140        CONTINUE
          END DO
          DO j=je+2,js-3,-1
            DO i=ilast,ifirst,-1
              q_ad(i, j+1) = q_ad(i, j+1) + dq_ad(i, j)
              q_ad(i, j) = q_ad(i, j) - dq_ad(i, j)
              dq_ad(i, j) = 0.0_FVPRC
            END DO
          END DO
        END IF
        DO j=je3+1,js3,-1
          DO i=ilast,ifirst,-1
            q_ad(i, j-1) = q_ad(i, j-1) + 0.5*al_ad(i, j)
            q_ad(i, j) = q_ad(i, j) + 0.5*al_ad(i, j)
            dm_ad(i, j-1) = dm_ad(i, j-1) + r3*al_ad(i, j)
            dm_ad(i, j) = dm_ad(i, j) - r3*al_ad(i, j)
            al_ad(i, j) = 0.0_FVPRC
          END DO
        END DO
        CALL POPCONTROL1B(branch)
      END IF
      DO j=je+2,js-2,-1
        DO i=ilast,ifirst,-1
          xt = 0.25*(q(i, j+1)-q(i, j-1))
          min14_ad = SIGN(1.d0, min14*xt)*dm_ad(i, j)
          dm_ad(i, j) = 0.0_FVPRC
          CALL POPCONTROL2B(branch)
          IF (branch .LT. 2) THEN
            IF (branch .EQ. 0) THEN
              CALL POPREALARRAY_ADM(min14)
              z8_ad = min14_ad
              y22_ad = 0.0_FVPRC
            ELSE
              CALL POPREALARRAY_ADM(min14)
              y22_ad = min14_ad
              z8_ad = 0.0_FVPRC
            END IF
            x23_ad = 0.0_FVPRC
          ELSE
            IF (branch .EQ. 2) THEN
              CALL POPREALARRAY_ADM(min14)
              z8_ad = min14_ad
              x23_ad = 0.0_FVPRC
            ELSE
              CALL POPREALARRAY_ADM(min14)
              x23_ad = min14_ad
              z8_ad = 0.0_FVPRC
            END IF
            y22_ad = 0.0_FVPRC
          END IF
          q_ad(i, j) = q_ad(i, j) + z8_ad
          min28_ad = -z8_ad
          CALL POPCONTROL2B(branch)
          IF (branch .LT. 2) THEN
            IF (branch .EQ. 0) THEN
              q_ad(i, j+1) = q_ad(i, j+1) + min28_ad
            ELSE
              q_ad(i, j) = q_ad(i, j) + min28_ad
            END IF
          ELSE IF (branch .EQ. 2) THEN
            q_ad(i, j+1) = q_ad(i, j+1) + min28_ad
          ELSE
            q_ad(i, j-1) = q_ad(i, j-1) + min28_ad
          END IF
          max10_ad = y22_ad
          q_ad(i, j) = q_ad(i, j) - y22_ad
          CALL POPCONTROL2B(branch)
          IF (branch .LT. 2) THEN
            IF (branch .EQ. 0) THEN
              q_ad(i, j+1) = q_ad(i, j+1) + max10_ad
            ELSE
              q_ad(i, j) = q_ad(i, j) + max10_ad
            END IF
          ELSE IF (branch .EQ. 2) THEN
            q_ad(i, j+1) = q_ad(i, j+1) + max10_ad
          ELSE
            q_ad(i, j-1) = q_ad(i, j-1) + max10_ad
          END IF
          CALL POPCONTROL1B(branch)
          IF (branch .EQ. 0) THEN
            xt_ad = x23_ad
          ELSE
            xt_ad = -x23_ad
          END IF
          q_ad(i, j+1) = q_ad(i, j+1) + 0.25*xt_ad
          q_ad(i, j-1) = q_ad(i, j-1) - 0.25*xt_ad
        END DO
      END DO
    END IF
    CALL POPCONTROL1B(branch)
  END SUBROUTINE FYPPM_ADM
  SUBROUTINE FYPPM(c, q, flux, jord, ifirst, ilast, jfirst, jlast, npx, &
&   npy, dm, bd, dya, nested, grid_type)
    IMPLICIT NONE
    TYPE(FV_GRID_BOUNDS_TYPE), INTENT(IN) :: bd
!  X-Dir strip
    INTEGER, INTENT(IN) :: ifirst, ilast
!  Y-Dir strip
    INTEGER, INTENT(IN) :: jfirst, jlast
    INTEGER, INTENT(IN) :: jord
    INTEGER, INTENT(IN) :: npx, npy
    REAL(fvprc), INTENT(IN) :: q(ifirst:ilast, jfirst-ng:jlast+ng)
! Courant number
    REAL(fvprc), INTENT(IN) :: c(bd%isd:bd%ied, bd%js:bd%je+1)
!  Flux
    REAL(fvprc), INTENT(OUT) :: flux(ifirst:ilast, jfirst:jlast+1)
    REAL(fvprc), INTENT(OUT) :: dm(ifirst:ilast, jfirst-2:jlast+2)
    REAL(fvprc), INTENT(IN) :: dya(bd%isd:bd%ied, bd%jsd:bd%jed)
    LOGICAL, INTENT(IN) :: nested
    INTEGER, INTENT(IN) :: grid_type
! Local:
    LOGICAL :: extm(ifirst:ilast, jfirst-2:jlast+2)
    REAL(fvprc) :: al(ifirst:ilast, jfirst-1:jlast+2)
    REAL(fvprc) :: bl(ifirst:ilast, jfirst-1:jlast+1)
    REAL(fvprc) :: br(ifirst:ilast, jfirst-1:jlast+1)
    REAL(fvprc) :: dq(ifirst:ilast, jfirst-3:jlast+2)
    REAL(fvprc) :: dl, dr, pmp, lac, ct, qe
    REAL(fvprc) :: pmp_1, lac_1, pmp_2, lac_2
    REAL(fvprc) :: xt, x0, x1, x0l, x0r
    INTEGER :: i, j, js3, je3, jt
    INTEGER :: is, ie, js, je, isd, ied, jsd, jed
    INTRINSIC MAX
    INTRINSIC MIN
    INTRINSIC ABS
    INTRINSIC SIGN
    REAL(fvprc) :: min1
    INTEGER :: max1
    REAL(fvprc) :: min2
    REAL(fvprc) :: min3
    REAL(fvprc) :: min4
    REAL(fvprc) :: min5
    REAL(fvprc) :: min6
    REAL(fvprc) :: min7
    REAL(fvprc) :: min8
    REAL(fvprc) :: min9
    REAL(fvprc) :: min10
    INTEGER :: max2
    REAL(fvprc) :: min11
    REAL(fvprc) :: min12
    REAL(fvprc) :: min13
    REAL(fvprc) :: abs0
    REAL(fvprc) :: abs1
    REAL(fvprc) :: min14
    REAL(fvprc) :: min15
    REAL(fvprc) :: min16
    REAL(fvprc) :: abs2
    REAL(fvprc) :: abs3
    REAL(fvprc) :: min17
    REAL(fvprc) :: min18
    REAL(fvprc) :: max3
    REAL(fvprc) :: min19
    INTEGER :: min20
    REAL(fvprc) :: max4
    REAL(fvprc) :: min21
    REAL(fvprc) :: max5
    REAL(fvprc) :: min22
    REAL(fvprc) :: max6
    REAL(fvprc) :: min23
    REAL(fvprc) :: max7
    REAL(fvprc) :: min24
    REAL(fvprc) :: max8
    REAL(fvprc) :: min25
    INTEGER :: min26
    REAL(fvprc) :: max9
    REAL(fvprc) :: min27
    REAL(fvprc) :: abs4
    REAL(fvprc) :: abs5
    REAL(fvprc) :: max10
    REAL(fvprc) :: min28
    REAL(fvprc) :: abs6
    REAL(fvprc) :: abs7
    REAL(fvprc) :: abs8
    REAL(fvprc) :: abs9
    INTEGER :: arg1
    REAL(fvprc) :: x19
    REAL(fvprc) :: x18
    REAL(fvprc) :: x17
    REAL(fvprc) :: x16
    REAL(fvprc) :: x15
    REAL(fvprc) :: x14
    REAL(fvprc) :: x13
    REAL(fvprc) :: x12
    REAL(fvprc) :: x11
    REAL(fvprc) :: y29
    REAL(fvprc) :: x10
    REAL(fvprc) :: y28
    REAL(fvprc) :: y27
    REAL(fvprc) :: y26
    REAL(fvprc) :: y25
    REAL(fvprc) :: y24
    REAL(fvprc) :: y23
    REAL(fvprc) :: y22
    REAL(fvprc) :: y21
    REAL(fvprc) :: y20
    REAL(fvprc) :: x9
    REAL(fvprc) :: x8
    REAL(fvprc) :: x7
    REAL(fvprc) :: x6
    REAL(fvprc) :: x5
    REAL(fvprc) :: x4
    REAL(fvprc) :: x3
    REAL(fvprc) :: x2
    REAL(fvprc) :: y19
    REAL(fvprc) :: y18
    REAL(fvprc) :: y17
    REAL(fvprc) :: y16
    REAL(fvprc) :: y15
    REAL(fvprc) :: y14
    REAL(fvprc) :: x33
    REAL(fvprc) :: y13
    REAL(fvprc) :: x32
    REAL(fvprc) :: y12
    REAL(fvprc) :: x31
    REAL(fvprc) :: y11
    REAL(fvprc) :: x30
    REAL(fvprc) :: y10
    REAL(fvprc) :: y46
    REAL(fvprc) :: y45
    REAL(fvprc) :: y44
    REAL(fvprc) :: y43
    REAL(fvprc) :: y42
    REAL(fvprc) :: y41
    REAL(fvprc) :: y40
    REAL(fvprc) :: z8
    REAL(fvprc) :: z7
    REAL(fvprc) :: z6
    REAL(fvprc) :: z5
    REAL(fvprc) :: z4
    REAL(fvprc) :: z3
    REAL(fvprc) :: z2
    REAL(fvprc) :: z1
    REAL(fvprc) :: x29
    REAL(fvprc) :: x28
    REAL(fvprc) :: x27
    REAL(fvprc) :: x26
    REAL(fvprc) :: x25
    REAL(fvprc) :: x24
    REAL(fvprc) :: x23
    REAL(fvprc) :: x22
    REAL(fvprc) :: x21
    REAL(fvprc) :: y39
    REAL(fvprc) :: x20
    REAL(fvprc) :: y38
    REAL(fvprc) :: y37
    REAL(fvprc) :: y36
    REAL(fvprc) :: y35
    REAL(fvprc) :: y34
    REAL(fvprc) :: y33
    REAL(fvprc) :: y32
    REAL(fvprc) :: y31
    REAL(fvprc) :: y30
    REAL(fvprc) :: y9
    REAL(fvprc) :: y8
    REAL(fvprc) :: y7
    REAL(fvprc) :: y6
    REAL(fvprc) :: y5
    REAL(fvprc) :: y4
    REAL(fvprc) :: y3
    REAL(fvprc) :: y2
    REAL(fvprc) :: y1
    is = bd%is
    ie = bd%ie
    js = bd%js
    je = bd%je
    isd = bd%isd
    ied = bd%ied
    jsd = bd%jsd
    jed = bd%jed
    IF (nested) THEN
      js3 = js - 1
      je3 = je + 1
    ELSE
      IF (3 .LT. js - 1) THEN
        js3 = js - 1
      ELSE
        js3 = 3
      END IF
      IF (npy - 3 .GT. je + 1) THEN
        je3 = je + 1
      ELSE
        je3 = npy - 3
      END IF
    END IF
    IF (jord .LE. 4) THEN
      DO j=js-2,je+2
        DO i=ifirst,ilast
          xt = 0.25*(q(i, j+1)-q(i, j-1))
          IF (xt .GE. 0.) THEN
            x2 = xt
          ELSE
            x2 = -xt
          END IF
          IF (q(i, j-1) .LT. q(i, j)) THEN
            IF (q(i, j) .LT. q(i, j+1)) THEN
              max3 = q(i, j+1)
            ELSE
              max3 = q(i, j)
            END IF
          ELSE IF (q(i, j-1) .LT. q(i, j+1)) THEN
            max3 = q(i, j+1)
          ELSE
            max3 = q(i, j-1)
          END IF
          y1 = max3 - q(i, j)
          IF (q(i, j-1) .GT. q(i, j)) THEN
            IF (q(i, j) .GT. q(i, j+1)) THEN
              min19 = q(i, j+1)
            ELSE
              min19 = q(i, j)
            END IF
          ELSE IF (q(i, j-1) .GT. q(i, j+1)) THEN
            min19 = q(i, j+1)
          ELSE
            min19 = q(i, j-1)
          END IF
          z1 = q(i, j) - min19
          IF (x2 .GT. y1) THEN
            IF (y1 .GT. z1) THEN
              min1 = z1
            ELSE
              min1 = y1
            END IF
          ELSE IF (x2 .GT. z1) THEN
            min1 = z1
          ELSE
            min1 = x2
          END IF
          dm(i, j) = SIGN(min1, xt)
        END DO
      END DO
      IF (grid_type .LT. 3) THEN
        IF (3 .LT. js - 1) THEN
          max1 = js - 1
        ELSE
          max1 = 3
        END IF
        IF (npy - 2 .GT. je + 2) THEN
          min20 = je + 2
        ELSE
          min20 = npy - 2
        END IF
        DO j=max1,min20
          DO i=ifirst,ilast
            al(i, j) = 0.5*(q(i, j-1)+q(i, j)) + r3*(dm(i, j-1)-dm(i, j)&
&             )
          END DO
        END DO
!--------------
! Fix the edges:
!--------------
        IF (.NOT.nested) THEN
          IF (js .EQ. 1) THEN
            DO i=ifirst,ilast
              x0l = 0.5*((2.*dya(i, 0)+dya(i, -1))*q(i, 0)-dya(i, 0)*q(i&
&               , -1))/(dya(i, 0)+dya(i, -1))
              x0r = 0.5*((2.*dya(i, 1)+dya(i, 2))*q(i, 1)-dya(i, 1)*q(i&
&               , 2))/(dya(i, 1)+dya(i, 2))
              x0 = x0l + x0r
              al(i, 1) = x0
              x1 = s15*q(i, 0) + s11*q(i, -1) + s14*dm(i, -1)
              dm(i, 0) = 0.5*(x0-x1)
              IF (dm(i, 0) .GE. 0.) THEN
                x3 = dm(i, 0)
              ELSE
                x3 = -dm(i, 0)
              END IF
              IF (q(i, 0) .LT. x0) THEN
                IF (x0 .LT. x1) THEN
                  max4 = x1
                ELSE
                  max4 = x0
                END IF
              ELSE IF (q(i, 0) .LT. x1) THEN
                max4 = x1
              ELSE
                max4 = q(i, 0)
              END IF
              y2 = max4 - q(i, 0)
              IF (q(i, 0) .GT. x0) THEN
                IF (x0 .GT. x1) THEN
                  min21 = x1
                ELSE
                  min21 = x0
                END IF
              ELSE IF (q(i, 0) .GT. x1) THEN
                min21 = x1
              ELSE
                min21 = q(i, 0)
              END IF
              z2 = q(i, 0) - min21
              IF (x3 .GT. y2) THEN
                IF (y2 .GT. z2) THEN
                  min2 = z2
                ELSE
                  min2 = y2
                END IF
              ELSE IF (x3 .GT. z2) THEN
                min2 = z2
              ELSE
                min2 = x3
              END IF
              dm(i, 0) = SIGN(min2, dm(i, 0))
              al(i, 0) = 0.5*(q(i, -1)+q(i, 0)) + r3*(dm(i, -1)-dm(i, 0)&
&               )
!
              x1 = s15*q(i, 1) + s11*q(i, 2) - s14*dm(i, 2)
              dm(i, 1) = 0.5*(x1-x0)
              IF (dm(i, 1) .GE. 0.) THEN
                x4 = dm(i, 1)
              ELSE
                x4 = -dm(i, 1)
              END IF
              IF (q(i, 1) .LT. x0) THEN
                IF (x0 .LT. x1) THEN
                  max5 = x1
                ELSE
                  max5 = x0
                END IF
              ELSE IF (q(i, 1) .LT. x1) THEN
                max5 = x1
              ELSE
                max5 = q(i, 1)
              END IF
              y3 = max5 - q(i, 1)
              IF (q(i, 1) .GT. x0) THEN
                IF (x0 .GT. x1) THEN
                  min22 = x1
                ELSE
                  min22 = x0
                END IF
              ELSE IF (q(i, 1) .GT. x1) THEN
                min22 = x1
              ELSE
                min22 = q(i, 1)
              END IF
              z3 = q(i, 1) - min22
              IF (x4 .GT. y3) THEN
                IF (y3 .GT. z3) THEN
                  min3 = z3
                ELSE
                  min3 = y3
                END IF
              ELSE IF (x4 .GT. z3) THEN
                min3 = z3
              ELSE
                min3 = x4
              END IF
              dm(i, 1) = SIGN(min3, dm(i, 1))
              al(i, 2) = 0.5*(q(i, 1)+q(i, 2)) + r3*(dm(i, 1)-dm(i, 2))
            END DO
          END IF
          IF (je + 1 .EQ. npy) THEN
            DO i=ifirst,ilast
              x0l = 0.5*((2.*dya(i, npy-1)+dya(i, npy-2))*q(i, npy-1)-&
&               dya(i, npy-1)*q(i, npy-2))/(dya(i, npy-1)+dya(i, npy-2))
              x0r = 0.5*((2.*dya(i, npy)+dya(i, npy+1))*q(i, npy)-dya(i&
&               , npy)*q(i, npy+1))/(dya(i, npy)+dya(i, npy+1))
              x0 = x0l + x0r
              al(i, npy) = x0
              x1 = s15*q(i, npy-1) + s11*q(i, npy-2) + s14*dm(i, npy-2)
              dm(i, npy-1) = 0.5*(x0-x1)
              IF (dm(i, npy-1) .GE. 0.) THEN
                x5 = dm(i, npy-1)
              ELSE
                x5 = -dm(i, npy-1)
              END IF
              IF (q(i, npy-1) .LT. x0) THEN
                IF (x0 .LT. x1) THEN
                  max6 = x1
                ELSE
                  max6 = x0
                END IF
              ELSE IF (q(i, npy-1) .LT. x1) THEN
                max6 = x1
              ELSE
                max6 = q(i, npy-1)
              END IF
              y4 = max6 - q(i, npy-1)
              IF (q(i, npy-1) .GT. x0) THEN
                IF (x0 .GT. x1) THEN
                  min23 = x1
                ELSE
                  min23 = x0
                END IF
              ELSE IF (q(i, npy-1) .GT. x1) THEN
                min23 = x1
              ELSE
                min23 = q(i, npy-1)
              END IF
              z4 = q(i, npy-1) - min23
              IF (x5 .GT. y4) THEN
                IF (y4 .GT. z4) THEN
                  min4 = z4
                ELSE
                  min4 = y4
                END IF
              ELSE IF (x5 .GT. z4) THEN
                min4 = z4
              ELSE
                min4 = x5
              END IF
              dm(i, npy-1) = SIGN(min4, dm(i, npy-1))
              al(i, npy-1) = 0.5*(q(i, npy-2)+q(i, npy-1)) + r3*(dm(i, &
&               npy-2)-dm(i, npy-1))
!
              x1 = s15*q(i, npy) + s11*q(i, npy+1) - s14*dm(i, npy+1)
              dm(i, npy) = 0.5*(x1-x0)
              IF (dm(i, npy) .GE. 0.) THEN
                x6 = dm(i, npy)
              ELSE
                x6 = -dm(i, npy)
              END IF
              IF (q(i, npy) .LT. x0) THEN
                IF (x0 .LT. x1) THEN
                  max7 = x1
                ELSE
                  max7 = x0
                END IF
              ELSE IF (q(i, npy) .LT. x1) THEN
                max7 = x1
              ELSE
                max7 = q(i, npy)
              END IF
              y5 = max7 - q(i, npy)
              IF (q(i, npy) .GT. x0) THEN
                IF (x0 .GT. x1) THEN
                  min24 = x1
                ELSE
                  min24 = x0
                END IF
              ELSE IF (q(i, npy) .GT. x1) THEN
                min24 = x1
              ELSE
                min24 = q(i, npy)
              END IF
              z5 = q(i, npy) - min24
              IF (x6 .GT. y5) THEN
                IF (y5 .GT. z5) THEN
                  min5 = z5
                ELSE
                  min5 = y5
                END IF
              ELSE IF (x6 .GT. z5) THEN
                min5 = z5
              ELSE
                min5 = x6
              END IF
              dm(i, npy) = SIGN(min5, dm(i, npy))
              al(i, npy+1) = 0.5*(q(i, npy)+q(i, npy+1)) + r3*(dm(i, npy&
&               )-dm(i, npy+1))
            END DO
          END IF
        END IF
      ELSE
! Doubly periodic BC:
        DO j=js-1,je+2
          DO i=ifirst,ilast
            al(i, j) = 0.5*(q(i, j-1)+q(i, j)) + r3*(dm(i, j-1)-dm(i, j)&
&             )
          END DO
        END DO
      END IF
      IF (jord .EQ. 3) THEN
        DO j=js-1,je+1
          DO i=ifirst,ilast
            bl(i, j) = al(i, j) - q(i, j)
            br(i, j) = al(i, j+1) - q(i, j)
          END DO
          arg1 = ilast - ifirst + 1
          CALL PERT_PPM(arg1, q(ifirst, j), bl(ifirst, j), br(ifirst, j)&
&                 , 1)
        END DO
        DO j=js,je+1
          DO i=ifirst,ilast
            IF (c(i, j) .GT. 0.) THEN
              flux(i, j) = q(i, j-1) + (1.-c(i, j))*(br(i, j-1)-c(i, j)*&
&               (bl(i, j-1)+br(i, j-1)))
            ELSE
              flux(i, j) = q(i, j) + (1.+c(i, j))*(bl(i, j)+c(i, j)*(bl(&
&               i, j)+br(i, j)))
            END IF
          END DO
        END DO
      ELSE
! Inlined limiter
        DO j=js,je+1
          DO i=ifirst,ilast
            IF (c(i, j) .GT. 0.) THEN
              xt = ppm_limiter*dm(i, j-1)
              IF (xt .GE. 0.) THEN
                x7 = xt
              ELSE
                x7 = -xt
              END IF
              IF (al(i, j-1) - q(i, j-1) .GE. 0.) THEN
                y6 = al(i, j-1) - q(i, j-1)
              ELSE
                y6 = -(al(i, j-1)-q(i, j-1))
              END IF
              IF (x7 .GT. y6) THEN
                min6 = y6
              ELSE
                min6 = x7
              END IF
              dl = SIGN(min6, xt)
              IF (xt .GE. 0.) THEN
                x8 = xt
              ELSE
                x8 = -xt
              END IF
              IF (al(i, j) - q(i, j-1) .GE. 0.) THEN
                y7 = al(i, j) - q(i, j-1)
              ELSE
                y7 = -(al(i, j)-q(i, j-1))
              END IF
              IF (x8 .GT. y7) THEN
                min7 = y7
              ELSE
                min7 = x8
              END IF
              dr = SIGN(min7, xt)
              flux(i, j) = q(i, j-1) + (1.-c(i, j))*(c(i, j)*(dl-dr)+dr)
            ELSE
              xt = ppm_limiter*dm(i, j)
              IF (xt .GE. 0.) THEN
                x9 = xt
              ELSE
                x9 = -xt
              END IF
              IF (al(i, j) - q(i, j) .GE. 0.) THEN
                y8 = al(i, j) - q(i, j)
              ELSE
                y8 = -(al(i, j)-q(i, j))
              END IF
              IF (x9 .GT. y8) THEN
                min8 = y8
              ELSE
                min8 = x9
              END IF
              dl = SIGN(min8, xt)
              IF (xt .GE. 0.) THEN
                x10 = xt
              ELSE
                x10 = -xt
              END IF
              IF (al(i, j+1) - q(i, j) .GE. 0.) THEN
                y9 = al(i, j+1) - q(i, j)
              ELSE
                y9 = -(al(i, j+1)-q(i, j))
              END IF
              IF (x10 .GT. y9) THEN
                min9 = y9
              ELSE
                min9 = x10
              END IF
              dr = SIGN(min9, xt)
              flux(i, j) = q(i, j) - (1.+c(i, j))*(c(i, j)*(dl-dr)+dl)
            END IF
          END DO
        END DO
      END IF
    ELSE IF (jord .EQ. 5) THEN
! PPM with Hunyh's 2nd constraint
      DO j=jfirst-3,jlast+2
        DO i=ifirst,ilast
          dq(i, j) = q(i, j+1) - q(i, j)
        END DO
      END DO
      DO j=jfirst-2,jlast+2
        DO i=ifirst,ilast
          xt = 0.25*(q(i, j+1)-q(i, j-1))
          IF (xt .GE. 0.) THEN
            x11 = xt
          ELSE
            x11 = -xt
          END IF
          IF (q(i, j-1) .LT. q(i, j)) THEN
            IF (q(i, j) .LT. q(i, j+1)) THEN
              max8 = q(i, j+1)
            ELSE
              max8 = q(i, j)
            END IF
          ELSE IF (q(i, j-1) .LT. q(i, j+1)) THEN
            max8 = q(i, j+1)
          ELSE
            max8 = q(i, j-1)
          END IF
          y10 = max8 - q(i, j)
          IF (q(i, j-1) .GT. q(i, j)) THEN
            IF (q(i, j) .GT. q(i, j+1)) THEN
              min25 = q(i, j+1)
            ELSE
              min25 = q(i, j)
            END IF
          ELSE IF (q(i, j-1) .GT. q(i, j+1)) THEN
            min25 = q(i, j+1)
          ELSE
            min25 = q(i, j-1)
          END IF
          z6 = q(i, j) - min25
          IF (x11 .GT. y10) THEN
            IF (y10 .GT. z6) THEN
              min10 = z6
            ELSE
              min10 = y10
            END IF
          ELSE IF (x11 .GT. z6) THEN
            min10 = z6
          ELSE
            min10 = x11
          END IF
          dm(i, j) = SIGN(min10, xt)
        END DO
      END DO
      DO j=jfirst-1,jlast+2
        DO i=ifirst,ilast
          al(i, j) = 0.5*(q(i, j-1)+q(i, j)) + r3*(dm(i, j-1)-dm(i, j))
        END DO
      END DO
      DO j=jfirst-1,jlast+1
        DO i=ifirst,ilast
          pmp = -(2.*dq(i, j))
          lac = pmp + 1.5*dq(i, j+1)
          IF (0. .LT. pmp) THEN
            IF (pmp .LT. lac) THEN
              x12 = lac
            ELSE
              x12 = pmp
            END IF
          ELSE IF (0. .LT. lac) THEN
            x12 = lac
          ELSE
            x12 = 0.
          END IF
          IF (0. .GT. pmp) THEN
            IF (pmp .GT. lac) THEN
              y33 = lac
            ELSE
              y33 = pmp
            END IF
          ELSE IF (0. .GT. lac) THEN
            y33 = lac
          ELSE
            y33 = 0.
          END IF
          IF (al(i, j) - q(i, j) .LT. y33) THEN
            y11 = y33
          ELSE
            y11 = al(i, j) - q(i, j)
          END IF
          IF (x12 .GT. y11) THEN
            bl(i, j) = y11
          ELSE
            bl(i, j) = x12
          END IF
          pmp = 2.*dq(i, j-1)
          lac = pmp - 1.5*dq(i, j-2)
          IF (0. .LT. pmp) THEN
            IF (pmp .LT. lac) THEN
              x13 = lac
            ELSE
              x13 = pmp
            END IF
          ELSE IF (0. .LT. lac) THEN
            x13 = lac
          ELSE
            x13 = 0.
          END IF
          IF (0. .GT. pmp) THEN
            IF (pmp .GT. lac) THEN
              y34 = lac
            ELSE
              y34 = pmp
            END IF
          ELSE IF (0. .GT. lac) THEN
            y34 = lac
          ELSE
            y34 = 0.
          END IF
          IF (al(i, j+1) - q(i, j) .LT. y34) THEN
            y12 = y34
          ELSE
            y12 = al(i, j+1) - q(i, j)
          END IF
          IF (x13 .GT. y12) THEN
            br(i, j) = y12
          ELSE
            br(i, j) = x13
          END IF
        END DO
      END DO
      DO j=jfirst,jlast+1
        DO i=ifirst,ilast
          IF (c(i, j) .GT. 0.) THEN
            flux(i, j) = q(i, j-1) + (1.-c(i, j))*(br(i, j-1)-c(i, j)*(&
&             bl(i, j-1)+br(i, j-1)))
          ELSE
            flux(i, j) = q(i, j) + (1.+c(i, j))*(bl(i, j)+c(i, j)*(bl(i&
&             , j)+br(i, j)))
          END IF
        END DO
      END DO
    ELSE IF (jord .EQ. 6 .OR. jord .EQ. 7) THEN
      IF (jord .EQ. 6) THEN
        IF (3 .LT. js - 1) THEN
          max2 = js - 1
        ELSE
          max2 = 3
        END IF
        IF (npy - 3 .GT. je + 1) THEN
          min26 = je + 1
        ELSE
          min26 = npy - 3
        END IF
!#ifdef UN_PPM
!   do j=jfirst-1,jlast+2
!      do i=ifirst,ilast
!         al(i,j) = p1*(q(i,j-1)+q(i,j)) + p2*(q(i,j-2)+q(i,j+1))
!      enddo
!   enddo
!   do j=max(3,js-1),min(npy-3,je+1)
!      do i=ifirst,ilast
!         bl(i,j) = al(i,j  ) - q(i,j)
!         br(i,j) = al(i,j+1) - q(i,j)
!      enddo
!   enddo
!#else
        DO j=max2,min26
          DO i=ifirst,ilast
            bl(i, j) = b5*q(i, j-2) + b4*q(i, j-1) + b3*q(i, j) + b2*q(i&
&             , j+1) + b1*q(i, j+2)
            br(i, j) = b1*q(i, j-2) + b2*q(i, j-1) + b3*q(i, j) + b4*q(i&
&             , j+1) + b5*q(i, j+2)
          END DO
        END DO
      ELSE
!#endif
        DO j=js-3,je+2
          DO i=ifirst,ilast
            dq(i, j) = q(i, j+1) - q(i, j)
          END DO
        END DO
        DO j=js-2,je+2
          DO i=ifirst,ilast
            IF (dq(i, j-1)*dq(i, j) .GT. 0.) THEN
              extm(i, j) = .false.
            ELSE
              extm(i, j) = .true.
            END IF
          END DO
        END DO
        DO j=js3,je3
!do j=max(3,js-1),min(npy-3,je+1)
          DO i=ifirst,ilast
            IF (extm(i, j-1) .AND. extm(i, j) .AND. extm(i, j+1)) THEN
! 2-delta-wave filter
              bl(i, j) = 0.
              br(i, j) = 0.
            ELSE
              bl(i, j) = b5*q(i, j-2) + b4*q(i, j-1) + b3*q(i, j) + b2*q&
&               (i, j+1) + b1*q(i, j+2)
              br(i, j) = b1*q(i, j-2) + b2*q(i, j-1) + b3*q(i, j) + b4*q&
&               (i, j+1) + b5*q(i, j+2)
            END IF
          END DO
        END DO
      END IF
      IF (js .EQ. 1 .AND. (.NOT.nested)) THEN
        DO i=ifirst,ilast
!           br(i,2) = al(i,3) - q(i,2)
          br(i, 2) = p1*(q(i, 2)+q(i, 3)) + p2*(q(i, 1)+q(i, 4)) - q(i, &
&           2)
          x0l = 0.5*((2.*dya(i, 0)+dya(i, -1))*q(i, 0)-dya(i, 0)*q(i, -1&
&           ))/(dya(i, 0)+dya(i, -1))
          x0r = 0.5*((2.*dya(i, 1)+dya(i, 2))*q(i, 1)-dya(i, 1)*q(i, 2))&
&           /(dya(i, 1)+dya(i, 2))
          xt = x0l + x0r
!            xt = ( x0L*gridstruct%sin_sg(i,0,4) + x0R*gridstruct%sin_sg(i,1,2) ) 
!            xt = 2.*xt / ( gridstruct%sin_sg(i,0,4) + gridstruct%sin_sg(i,1,2) )
          bl(i, 1) = xt - q(i, 1)
          br(i, 0) = xt - q(i, 0)
!           xt = s14*0.25*(q(i,0)-q(i,-2)) - s11*(q(i,0)-q(i,-1)) + q(i,0)
          xt = c1*q(i, -2) + c2*q(i, -1) + c3*q(i, 0)
!#ifdef DO_MONO_EDGE
!            xt = min( xt, max(q(i,-1), q(i,0)) )
!            xt = max( xt, min(q(i,-1), q(i,0)) )
!#endif
          bl(i, 0) = xt - q(i, 0)
!           xt = s15*q(i,1) + s11*q(i,2) - s14*0.25*(q(i,3)-q(i,1))
          xt = c3*q(i, 1) + c2*q(i, 2) + c1*q(i, 3)
!#ifdef DO_MONO_EDGE
!            xt = min( xt, max(q(i,1), q(i,2)) )
!            xt = max( xt, min(q(i,1), q(i,2)) )
!#endif
          br(i, 1) = xt - q(i, 1)
          bl(i, 2) = xt - q(i, 2)
        END DO
      END IF
      IF (je + 1 .EQ. npy .AND. (.NOT.nested)) THEN
        DO i=ifirst,ilast
!           bl(i,npy-2) = al(i,npy-2) - q(i,npy-2)
          bl(i, npy-2) = p1*(q(i, npy-3)+q(i, npy-2)) + p2*(q(i, npy-4)+&
&           q(i, npy-1)) - q(i, npy-2)
          x0l = 0.5*((2.*dya(i, npy-1)+dya(i, npy-2))*q(i, npy-1)-dya(i&
&           , npy-1)*q(i, npy-2))/(dya(i, npy-1)+dya(i, npy-2))
          x0r = 0.5*((2.*dya(i, npy)+dya(i, npy+1))*q(i, npy)-dya(i, npy&
&           )*q(i, npy+1))/(dya(i, npy)+dya(i, npy+1))
          xt = x0l + x0r
!            xt = x0L*gridstruct%sin_sg(i,npy-1,4) + x0R*gridstruct%sin_sg(i,npy,2)
!            xt = 2.*xt /( gridstruct%sin_sg(i,npy-1,4) + gridstruct%sin_sg(i,npy,2) )
          br(i, npy-1) = xt - q(i, npy-1)
          bl(i, npy) = xt - q(i, npy)
!           xt = s11*(q(i,npy+1)-q(i,npy)) - s14*0.25*(q(i,npy+2)-q(i,npy)) + q(i,npy)
          xt = c3*q(i, npy) + c2*q(i, npy+1) + c1*q(i, npy+2)
!#ifdef DO_MONO_EDGE
!            xt = min( xt, max(q(i,npy), q(i,npy+1)) )
!            xt = max( xt, min(q(i,npy), q(i,npy+1)) )
!#endif
          br(i, npy) = xt - q(i, npy)
!           xt = s15*q(i,npy-1) + s11*q(i,npy-2) + s14*0.25*(q(i,npy-1)-q(i,npy-3))
          xt = c1*q(i, npy-3) + c2*q(i, npy-2) + c3*q(i, npy-1)
!#ifdef DO_MONO_EDGE
!            xt = min( xt, max(q(i,npy-2), q(i,npy-1)) )
!            xt = max( xt, min(q(i,npy-2), q(i,npy-1)) )
!#endif
          br(i, npy-2) = xt - q(i, npy-2)
          bl(i, npy-1) = xt - q(i, npy-1)
        END DO
      END IF
! Positive definite constraint:
      IF (jord .EQ. 7) THEN
        DO j=jfirst-1,jlast+1
          arg1 = ilast - ifirst + 1
          CALL PERT_PPM(arg1, q(ifirst, j), bl(ifirst, j), br(ifirst, j)&
&                 , 0)
        END DO
      END IF
      DO j=jfirst,jlast+1
        DO i=ifirst,ilast
          IF (c(i, j) .GT. 0.) THEN
            flux(i, j) = q(i, j-1) + (1.-c(i, j))*(br(i, j-1)-c(i, j)*(&
&             bl(i, j-1)+br(i, j-1)))
          ELSE
            flux(i, j) = q(i, j) + (1.+c(i, j))*(bl(i, j)+c(i, j)*(bl(i&
&             , j)+br(i, j)))
          END IF
        END DO
      END DO
    ELSE IF (jord .LE. 10) THEN
! jord=8, 9, 10
      DO j=js-2,je+2
        DO i=ifirst,ilast
          xt = 0.25*(q(i, j+1)-q(i, j-1))
          IF (xt .GE. 0.) THEN
            x14 = xt
          ELSE
            x14 = -xt
          END IF
          IF (q(i, j-1) .LT. q(i, j)) THEN
            IF (q(i, j) .LT. q(i, j+1)) THEN
              max9 = q(i, j+1)
            ELSE
              max9 = q(i, j)
            END IF
          ELSE IF (q(i, j-1) .LT. q(i, j+1)) THEN
            max9 = q(i, j+1)
          ELSE
            max9 = q(i, j-1)
          END IF
          y13 = max9 - q(i, j)
          IF (q(i, j-1) .GT. q(i, j)) THEN
            IF (q(i, j) .GT. q(i, j+1)) THEN
              min27 = q(i, j+1)
            ELSE
              min27 = q(i, j)
            END IF
          ELSE IF (q(i, j-1) .GT. q(i, j+1)) THEN
            min27 = q(i, j+1)
          ELSE
            min27 = q(i, j-1)
          END IF
          z7 = q(i, j) - min27
          IF (x14 .GT. y13) THEN
            IF (y13 .GT. z7) THEN
              min11 = z7
            ELSE
              min11 = y13
            END IF
          ELSE IF (x14 .GT. z7) THEN
            min11 = z7
          ELSE
            min11 = x14
          END IF
          dm(i, j) = SIGN(min11, xt)
        END DO
      END DO
      IF (grid_type .LT. 3) THEN
!      do j=max(3,js-1),min(npy-2,je+2)
        DO j=js3,je3+1
          DO i=ifirst,ilast
            al(i, j) = 0.5*(q(i, j-1)+q(i, j)) + r3*(dm(i, j-1)-dm(i, j)&
&             )
          END DO
        END DO
        DO j=js-3,je+2
          DO i=ifirst,ilast
            dq(i, j) = q(i, j+1) - q(i, j)
          END DO
        END DO
        IF (jord .EQ. 8) THEN
!         do j=max(3,js-1),min(npy-3,je+1) 
          DO j=js3,je3
            DO i=ifirst,ilast
              xt = 2.*dm(i, j)
              IF (xt .GE. 0.) THEN
                x15 = xt
              ELSE
                x15 = -xt
              END IF
              IF (al(i, j) - q(i, j) .GE. 0.) THEN
                y14 = al(i, j) - q(i, j)
              ELSE
                y14 = -(al(i, j)-q(i, j))
              END IF
              IF (x15 .GT. y14) THEN
                min12 = y14
              ELSE
                min12 = x15
              END IF
              bl(i, j) = -SIGN(min12, xt)
              IF (xt .GE. 0.) THEN
                x16 = xt
              ELSE
                x16 = -xt
              END IF
              IF (al(i, j+1) - q(i, j) .GE. 0.) THEN
                y15 = al(i, j+1) - q(i, j)
              ELSE
                y15 = -(al(i, j+1)-q(i, j))
              END IF
              IF (x16 .GT. y15) THEN
                min13 = y15
              ELSE
                min13 = x16
              END IF
              br(i, j) = SIGN(min13, xt)
            END DO
          END DO
        ELSE IF (jord .EQ. 9) THEN
!         do j=max(3,js-1),min(npy-3,je+1) 
          DO j=js3,je3
            DO i=ifirst,ilast
              pmp_1 = -(2.*dq(i, j))
              lac_1 = pmp_1 + 1.5*dq(i, j+1)
              IF (0. .LT. pmp_1) THEN
                IF (pmp_1 .LT. lac_1) THEN
                  x17 = lac_1
                ELSE
                  x17 = pmp_1
                END IF
              ELSE IF (0. .LT. lac_1) THEN
                x17 = lac_1
              ELSE
                x17 = 0.
              END IF
              IF (0. .GT. pmp_1) THEN
                IF (pmp_1 .GT. lac_1) THEN
                  y35 = lac_1
                ELSE
                  y35 = pmp_1
                END IF
              ELSE IF (0. .GT. lac_1) THEN
                y35 = lac_1
              ELSE
                y35 = 0.
              END IF
              IF (al(i, j) - q(i, j) .LT. y35) THEN
                y16 = y35
              ELSE
                y16 = al(i, j) - q(i, j)
              END IF
              IF (x17 .GT. y16) THEN
                bl(i, j) = y16
              ELSE
                bl(i, j) = x17
              END IF
              pmp_2 = 2.*dq(i, j-1)
              lac_2 = pmp_2 - 1.5*dq(i, j-2)
              IF (0. .LT. pmp_2) THEN
                IF (pmp_2 .LT. lac_2) THEN
                  x18 = lac_2
                ELSE
                  x18 = pmp_2
                END IF
              ELSE IF (0. .LT. lac_2) THEN
                x18 = lac_2
              ELSE
                x18 = 0.
              END IF
              IF (0. .GT. pmp_2) THEN
                IF (pmp_2 .GT. lac_2) THEN
                  y36 = lac_2
                ELSE
                  y36 = pmp_2
                END IF
              ELSE IF (0. .GT. lac_2) THEN
                y36 = lac_2
              ELSE
                y36 = 0.
              END IF
              IF (al(i, j+1) - q(i, j) .LT. y36) THEN
                y17 = y36
              ELSE
                y17 = al(i, j+1) - q(i, j)
              END IF
              IF (x18 .GT. y17) THEN
                br(i, j) = y17
              ELSE
                br(i, j) = x18
              END IF
            END DO
          END DO
        ELSE
! jord=10
!         do j=max(3,js-1),min(npy-3,je+1) 
          DO j=js3,je3
            DO i=ifirst,ilast
              bl(i, j) = al(i, j) - q(i, j)
              br(i, j) = al(i, j+1) - q(i, j)
              IF (dm(i, j-1) .GE. 0.) THEN
                abs0 = dm(i, j-1)
              ELSE
                abs0 = -dm(i, j-1)
              END IF
              IF (dm(i, j) .GE. 0.) THEN
                abs4 = dm(i, j)
              ELSE
                abs4 = -dm(i, j)
              END IF
              IF (dm(i, j+1) .GE. 0.) THEN
                abs8 = dm(i, j+1)
              ELSE
                abs8 = -dm(i, j+1)
              END IF
              IF (abs0 + abs4 + abs8 .LT. near_zero) THEN
                bl(i, j) = 0.
                br(i, j) = 0.
              ELSE
                IF (3.*(bl(i, j)+br(i, j)) .GE. 0.) THEN
                  abs1 = 3.*(bl(i, j)+br(i, j))
                ELSE
                  abs1 = -(3.*(bl(i, j)+br(i, j)))
                END IF
                IF (bl(i, j) - br(i, j) .GE. 0.) THEN
                  abs5 = bl(i, j) - br(i, j)
                ELSE
                  abs5 = -(bl(i, j)-br(i, j))
                END IF
                IF (abs1 .GT. abs5) THEN
                  pmp_1 = -(2.*dq(i, j))
                  lac_1 = pmp_1 + 1.5*dq(i, j+1)
                  IF (0. .LT. pmp_1) THEN
                    IF (pmp_1 .LT. lac_1) THEN
                      x19 = lac_1
                    ELSE
                      x19 = pmp_1
                    END IF
                  ELSE IF (0. .LT. lac_1) THEN
                    x19 = lac_1
                  ELSE
                    x19 = 0.
                  END IF
                  IF (0. .GT. pmp_1) THEN
                    IF (pmp_1 .GT. lac_1) THEN
                      y37 = lac_1
                    ELSE
                      y37 = pmp_1
                    END IF
                  ELSE IF (0. .GT. lac_1) THEN
                    y37 = lac_1
                  ELSE
                    y37 = 0.
                  END IF
                  IF (bl(i, j) .LT. y37) THEN
                    y18 = y37
                  ELSE
                    y18 = bl(i, j)
                  END IF
                  IF (x19 .GT. y18) THEN
                    bl(i, j) = y18
                  ELSE
                    bl(i, j) = x19
                  END IF
                  pmp_2 = 2.*dq(i, j-1)
                  lac_2 = pmp_2 - 1.5*dq(i, j-2)
                  IF (0. .LT. pmp_2) THEN
                    IF (pmp_2 .LT. lac_2) THEN
                      x20 = lac_2
                    ELSE
                      x20 = pmp_2
                    END IF
                  ELSE IF (0. .LT. lac_2) THEN
                    x20 = lac_2
                  ELSE
                    x20 = 0.
                  END IF
                  IF (0. .GT. pmp_2) THEN
                    IF (pmp_2 .GT. lac_2) THEN
                      y38 = lac_2
                    ELSE
                      y38 = pmp_2
                    END IF
                  ELSE IF (0. .GT. lac_2) THEN
                    y38 = lac_2
                  ELSE
                    y38 = 0.
                  END IF
                  IF (br(i, j) .LT. y38) THEN
                    y19 = y38
                  ELSE
                    y19 = br(i, j)
                  END IF
                  IF (x20 .GT. y19) THEN
                    br(i, j) = y19
                  ELSE
                    br(i, j) = x20
                  END IF
                END IF
              END IF
            END DO
          END DO
        END IF
!--------------
! Fix the edges:
!--------------
        IF (.NOT.nested) THEN
          IF (js .EQ. 1) THEN
            DO i=ifirst,ilast
              br(i, 2) = al(i, 3) - q(i, 2)
              x0l = 0.5*((2.*dya(i, 0)+dya(i, -1))*q(i, 0)-dya(i, 0)*q(i&
&               , -1))/(dya(i, 0)+dya(i, -1))
              x0r = 0.5*((2.*dya(i, 1)+dya(i, 2))*q(i, 1)-dya(i, 1)*q(i&
&               , 2))/(dya(i, 1)+dya(i, 2))
              xt = x0l + x0r
!lmh            xt = 0.5*((2.*dya(i,1)+dya(i,2))*(q(i,0)+q(i,1))   &
!lmh               -dya(i,1)*(q(i,-1)+q(i,2))) / ( dya(i,1)+dya(i,2) )
              bl(i, 1) = xt - q(i, 1)
              br(i, 0) = xt - q(i, 0)
              xt = s14*dm(i, -1) - s11*dq(i, -1) + q(i, 0)
!           xt = min( xt, max(q(i,-1), q(i,0)) )
!           xt = max( xt, min(q(i,-1), q(i,0)) )
              bl(i, 0) = xt - q(i, 0)
              xt = s15*q(i, 1) + s11*q(i, 2) - s14*dm(i, 2)
!           xt = min( xt, max(q(i,1), q(i,2)) )
!           xt = max( xt, min(q(i,1), q(i,2)) )
              br(i, 1) = xt - q(i, 1)
              bl(i, 2) = xt - q(i, 2)
            END DO
!         if ( jord<=9 ) then
            DO j=0,2
              arg1 = ilast - ifirst + 1
              CALL PERT_PPM(arg1, q(ifirst, j), bl(ifirst, j), br(ifirst&
&                     , j), 1)
            END DO
          END IF
!         endif
          IF (je + 1 .EQ. npy) THEN
            DO i=ifirst,ilast
              bl(i, npy-2) = al(i, npy-2) - q(i, npy-2)
              x0l = 0.5*((2.*dya(i, npy-1)+dya(i, npy-2))*q(i, npy-1)-&
&               dya(i, npy-1)*q(i, npy-2))/(dya(i, npy-1)+dya(i, npy-2))
              x0r = 0.5*((2.*dya(i, npy)+dya(i, npy+1))*q(i, npy)-dya(i&
&               , npy)*q(i, npy+1))/(dya(i, npy)+dya(i, npy+1))
              xt = x0l + x0r
!lmh            xt = 0.5*((2.*dya(i,npy-1)+dya(i,npy-2))*(q(i,npy-1)+q(i,npy))  &
!lmh               -dya(i,npy-1)*(q(i,npy-2)+q(i,npy+1)))/(dya(i,npy-1)+dya(i,npy-2))
              br(i, npy-1) = xt - q(i, npy-1)
              bl(i, npy) = xt - q(i, npy)
              xt = s11*dq(i, npy) - s14*dm(i, npy+1) + q(i, npy)
!           xt = min( xt, max( q(i,npy), q(i,npy+1)) )
!           xt = max( xt, min( q(i,npy), q(i,npy+1)) )
              br(i, npy) = xt - q(i, npy)
              xt = s15*q(i, npy-1) + s11*q(i, npy-2) + s14*dm(i, npy-2)
!           xt = min( xt, max( q(i,npy-2), q(i,npy-1)) )
!           xt = max( xt, min( q(i,npy-2), q(i,npy-1)) )
              br(i, npy-2) = xt - q(i, npy-2)
              bl(i, npy-1) = xt - q(i, npy-1)
            END DO
!         if ( jord<=9 ) then
            DO j=npy-2,npy
              arg1 = ilast - ifirst + 1
              CALL PERT_PPM(arg1, q(ifirst, j), bl(ifirst, j), br(ifirst&
&                     , j), 1)
            END DO
          END IF
        END IF
      ELSE
!         endif
!---------------
! grid_type == 4
!---------------
        DO j=jfirst-1,jlast+2
          DO i=ifirst,ilast
            al(i, j) = 0.5*(q(i, j-1)+q(i, j)) + r3*(dm(i, j-1)-dm(i, j)&
&             )
          END DO
        END DO
        DO j=jfirst-3,jlast+2
          DO i=ifirst,ilast
            dq(i, j) = q(i, j+1) - q(i, j)
          END DO
        END DO
        DO j=jfirst-1,jlast+1
          DO i=ifirst,ilast
            pmp = -(2.*dq(i, j))
            lac = pmp + 1.5*dq(i, j+1)
            IF (0. .LT. pmp) THEN
              IF (pmp .LT. lac) THEN
                x21 = lac
              ELSE
                x21 = pmp
              END IF
            ELSE IF (0. .LT. lac) THEN
              x21 = lac
            ELSE
              x21 = 0.
            END IF
            IF (0. .GT. pmp) THEN
              IF (pmp .GT. lac) THEN
                y39 = lac
              ELSE
                y39 = pmp
              END IF
            ELSE IF (0. .GT. lac) THEN
              y39 = lac
            ELSE
              y39 = 0.
            END IF
            IF (al(i, j) - q(i, j) .LT. y39) THEN
              y20 = y39
            ELSE
              y20 = al(i, j) - q(i, j)
            END IF
            IF (x21 .GT. y20) THEN
              bl(i, j) = y20
            ELSE
              bl(i, j) = x21
            END IF
            pmp = 2.*dq(i, j-1)
            lac = pmp - 1.5*dq(i, j-2)
            IF (0. .LT. pmp) THEN
              IF (pmp .LT. lac) THEN
                x22 = lac
              ELSE
                x22 = pmp
              END IF
            ELSE IF (0. .LT. lac) THEN
              x22 = lac
            ELSE
              x22 = 0.
            END IF
            IF (0. .GT. pmp) THEN
              IF (pmp .GT. lac) THEN
                y40 = lac
              ELSE
                y40 = pmp
              END IF
            ELSE IF (0. .GT. lac) THEN
              y40 = lac
            ELSE
              y40 = 0.
            END IF
            IF (al(i, j+1) - q(i, j) .LT. y40) THEN
              y21 = y40
            ELSE
              y21 = al(i, j+1) - q(i, j)
            END IF
            IF (x22 .GT. y21) THEN
              br(i, j) = y21
            ELSE
              br(i, j) = x22
            END IF
          END DO
        END DO
      END IF
      DO j=jfirst,jlast+1
        DO i=ifirst,ilast
          IF (c(i, j) .GT. 0.) THEN
            flux(i, j) = q(i, j-1) + (1.-c(i, j))*(br(i, j-1)-c(i, j)*(&
&             bl(i, j-1)+br(i, j-1)))
          ELSE
            flux(i, j) = q(i, j) + (1.+c(i, j))*(bl(i, j)+c(i, j)*(bl(i&
&             , j)+br(i, j)))
          END IF
        END DO
      END DO
    ELSE
!-------------------------------
! For positive definite tracers:
!-------------------------------
! jord=11: PPM mono constraint (Lin 2004)
! jord=12: Huynh 2nd constraint (Lin 2004) + positive definite (Lin & Rood 1996)
! jord>12: positive definite only (Lin & Rood 1996)
      DO j=js-2,je+2
        DO i=ifirst,ilast
          xt = 0.25*(q(i, j+1)-q(i, j-1))
          IF (xt .GE. 0.) THEN
            x23 = xt
          ELSE
            x23 = -xt
          END IF
          IF (q(i, j-1) .LT. q(i, j)) THEN
            IF (q(i, j) .LT. q(i, j+1)) THEN
              max10 = q(i, j+1)
            ELSE
              max10 = q(i, j)
            END IF
          ELSE IF (q(i, j-1) .LT. q(i, j+1)) THEN
            max10 = q(i, j+1)
          ELSE
            max10 = q(i, j-1)
          END IF
          y22 = max10 - q(i, j)
          IF (q(i, j-1) .GT. q(i, j)) THEN
            IF (q(i, j) .GT. q(i, j+1)) THEN
              min28 = q(i, j+1)
            ELSE
              min28 = q(i, j)
            END IF
          ELSE IF (q(i, j-1) .GT. q(i, j+1)) THEN
            min28 = q(i, j+1)
          ELSE
            min28 = q(i, j-1)
          END IF
          z8 = q(i, j) - min28
          IF (x23 .GT. y22) THEN
            IF (y22 .GT. z8) THEN
              min14 = z8
            ELSE
              min14 = y22
            END IF
          ELSE IF (x23 .GT. z8) THEN
            min14 = z8
          ELSE
            min14 = x23
          END IF
          dm(i, j) = SIGN(min14, xt)
        END DO
      END DO
      IF (grid_type .LT. 3) THEN
        IF (nested) THEN
          js3 = js - 1
          je3 = je + 1
        ELSE
          IF (3 .LT. js - 1) THEN
            js3 = js - 1
          ELSE
            js3 = 3
          END IF
          IF (npy - 3 .GT. je + 1) THEN
            je3 = je + 1
          ELSE
            je3 = npy - 3
          END IF
        END IF
!      do j=js3,min(npy-2,je+2)
        DO j=js3,je3+1
          DO i=ifirst,ilast
            al(i, j) = 0.5*(q(i, j-1)+q(i, j)) + r3*(dm(i, j-1)-dm(i, j)&
&             )
          END DO
        END DO
        IF (jord .EQ. 11) THEN
          DO j=js3,je3
            DO i=ifirst,ilast
              xt = 2.*dm(i, j)
              IF (xt .GE. 0.) THEN
                x24 = xt
              ELSE
                x24 = -xt
              END IF
              IF (al(i, j) - q(i, j) .GE. 0.) THEN
                y23 = al(i, j) - q(i, j)
              ELSE
                y23 = -(al(i, j)-q(i, j))
              END IF
              IF (x24 .GT. y23) THEN
                min15 = y23
              ELSE
                min15 = x24
              END IF
              bl(i, j) = -SIGN(min15, xt)
              IF (xt .GE. 0.) THEN
                x25 = xt
              ELSE
                x25 = -xt
              END IF
              IF (al(i, j+1) - q(i, j) .GE. 0.) THEN
                y24 = al(i, j+1) - q(i, j)
              ELSE
                y24 = -(al(i, j+1)-q(i, j))
              END IF
              IF (x25 .GT. y24) THEN
                min16 = y24
              ELSE
                min16 = x25
              END IF
              br(i, j) = SIGN(min16, xt)
            END DO
          END DO
        ELSE IF (jord .EQ. 12) THEN
          DO j=js-3,je+2
            DO i=ifirst,ilast
              dq(i, j) = q(i, j+1) - q(i, j)
            END DO
          END DO
          DO j=js3,je3
            DO i=ifirst,ilast
              pmp = -(2.*dq(i, j))
              lac = pmp + 1.5*dq(i, j+1)
              IF (0. .LT. pmp) THEN
                IF (pmp .LT. lac) THEN
                  x26 = lac
                ELSE
                  x26 = pmp
                END IF
              ELSE IF (0. .LT. lac) THEN
                x26 = lac
              ELSE
                x26 = 0.
              END IF
              IF (0. .GT. pmp) THEN
                IF (pmp .GT. lac) THEN
                  y41 = lac
                ELSE
                  y41 = pmp
                END IF
              ELSE IF (0. .GT. lac) THEN
                y41 = lac
              ELSE
                y41 = 0.
              END IF
              IF (al(i, j) - q(i, j) .LT. y41) THEN
                y25 = y41
              ELSE
                y25 = al(i, j) - q(i, j)
              END IF
              IF (x26 .GT. y25) THEN
                bl(i, j) = y25
              ELSE
                bl(i, j) = x26
              END IF
              pmp = 2.*dq(i, j-1)
              lac = pmp - 1.5*dq(i, j-2)
              IF (0. .LT. pmp) THEN
                IF (pmp .LT. lac) THEN
                  x27 = lac
                ELSE
                  x27 = pmp
                END IF
              ELSE IF (0. .LT. lac) THEN
                x27 = lac
              ELSE
                x27 = 0.
              END IF
              IF (0. .GT. pmp) THEN
                IF (pmp .GT. lac) THEN
                  y42 = lac
                ELSE
                  y42 = pmp
                END IF
              ELSE IF (0. .GT. lac) THEN
                y42 = lac
              ELSE
                y42 = 0.
              END IF
              IF (al(i, j+1) - q(i, j) .LT. y42) THEN
                y26 = y42
              ELSE
                y26 = al(i, j+1) - q(i, j)
              END IF
              IF (x27 .GT. y26) THEN
                br(i, j) = y26
              ELSE
                br(i, j) = x27
              END IF
            END DO
          END DO
        ELSE
! jord=13
          DO j=js-3,je+2
            DO i=ifirst,ilast
              dq(i, j) = q(i, j+1) - q(i, j)
            END DO
          END DO
          DO j=js3,je3
            DO i=ifirst,ilast
              IF (dm(i, j-1) .GE. 0.) THEN
                abs2 = dm(i, j-1)
              ELSE
                abs2 = -dm(i, j-1)
              END IF
              IF (dm(i, j) .GE. 0.) THEN
                abs6 = dm(i, j)
              ELSE
                abs6 = -dm(i, j)
              END IF
              IF (dm(i, j+1) .GE. 0.) THEN
                abs9 = dm(i, j+1)
              ELSE
                abs9 = -dm(i, j+1)
              END IF
              IF (abs2 + abs6 + abs9 .LT. near_zero) THEN
                bl(i, j) = 0.
                br(i, j) = 0.
              ELSE
                bl(i, j) = al(i, j) - q(i, j)
                br(i, j) = al(i, j+1) - q(i, j)
                IF (3.*(bl(i, j)+br(i, j)) .GE. 0.) THEN
                  abs3 = 3.*(bl(i, j)+br(i, j))
                ELSE
                  abs3 = -(3.*(bl(i, j)+br(i, j)))
                END IF
                IF (bl(i, j) - br(i, j) .GE. 0.) THEN
                  abs7 = bl(i, j) - br(i, j)
                ELSE
                  abs7 = -(bl(i, j)-br(i, j))
                END IF
                IF (abs3 .GT. abs7) THEN
                  pmp_1 = -(2.*dq(i, j))
                  lac_1 = pmp_1 + 1.5*dq(i, j+1)
                  IF (0. .LT. pmp_1) THEN
                    IF (pmp_1 .LT. lac_1) THEN
                      x28 = lac_1
                    ELSE
                      x28 = pmp_1
                    END IF
                  ELSE IF (0. .LT. lac_1) THEN
                    x28 = lac_1
                  ELSE
                    x28 = 0.
                  END IF
                  IF (0. .GT. pmp_1) THEN
                    IF (pmp_1 .GT. lac_1) THEN
                      y43 = lac_1
                    ELSE
                      y43 = pmp_1
                    END IF
                  ELSE IF (0. .GT. lac_1) THEN
                    y43 = lac_1
                  ELSE
                    y43 = 0.
                  END IF
                  IF (bl(i, j) .LT. y43) THEN
                    y27 = y43
                  ELSE
                    y27 = bl(i, j)
                  END IF
                  IF (x28 .GT. y27) THEN
                    bl(i, j) = y27
                  ELSE
                    bl(i, j) = x28
                  END IF
                  pmp_2 = 2.*dq(i, j-1)
                  lac_2 = pmp_2 - 1.5*dq(i, j-2)
                  IF (0. .LT. pmp_2) THEN
                    IF (pmp_2 .LT. lac_2) THEN
                      x29 = lac_2
                    ELSE
                      x29 = pmp_2
                    END IF
                  ELSE IF (0. .LT. lac_2) THEN
                    x29 = lac_2
                  ELSE
                    x29 = 0.
                  END IF
                  IF (0. .GT. pmp_2) THEN
                    IF (pmp_2 .GT. lac_2) THEN
                      y44 = lac_2
                    ELSE
                      y44 = pmp_2
                    END IF
                  ELSE IF (0. .GT. lac_2) THEN
                    y44 = lac_2
                  ELSE
                    y44 = 0.
                  END IF
                  IF (br(i, j) .LT. y44) THEN
                    y28 = y44
                  ELSE
                    y28 = br(i, j)
                  END IF
                  IF (x29 .GT. y28) THEN
                    br(i, j) = y28
                  ELSE
                    br(i, j) = x29
                  END IF
                END IF
              END IF
            END DO
          END DO
        END IF
        IF (jord .NE. 11) THEN
! Positive definite constraint:
          DO j=js3,je3
            arg1 = ilast - ifirst + 1
            CALL PERT_PPM(arg1, q(ifirst, j), bl(ifirst, j), br(ifirst, &
&                   j), 0)
          END DO
        END IF
!--------------
! Fix the edges:
!--------------
        IF (.NOT.nested) THEN
          IF (js .EQ. 1) THEN
            DO i=ifirst,ilast
              br(i, 2) = al(i, 3) - q(i, 2)
!           xt = t11*(q(i,0)+q(i,1)) + t12*(q(i,-1)+q(i,2))   &
!              + t13*(dm(i,2)-dm(i,-1))
!!!         xt = 0.75*(q(i,0)+q(i,1)) - 0.25*(q(i,-1)+q(i,2))
              x0l = 0.5*((2.*dya(i, 0)+dya(i, -1))*q(i, 0)-dya(i, 0)*q(i&
&               , -1))/(dya(i, 0)+dya(i, -1))
              x0r = 0.5*((2.*dya(i, 1)+dya(i, 2))*q(i, 1)-dya(i, 1)*q(i&
&               , 2))/(dya(i, 1)+dya(i, 2))
              xt = x0l + x0r
              IF (0. .LT. xt) THEN
                xt = xt
              ELSE
                xt = 0.
              END IF
              bl(i, 1) = xt - q(i, 1)
              br(i, 0) = xt - q(i, 0)
              xt = 4./7.*dm(i, -1) + 11./14.*q(i, -1) + 3./14.*q(i, 0)
              IF (0. .LT. xt) THEN
                xt = xt
              ELSE
                xt = 0.
              END IF
              bl(i, 0) = xt - q(i, 0)
              xt = 3./14.*q(i, 1) + 11./14.*q(i, 2) - 4./7.*dm(i, 2)
              IF (0. .LT. xt) THEN
                xt = xt
              ELSE
                xt = 0.
              END IF
              br(i, 1) = xt - q(i, 1)
              bl(i, 2) = xt - q(i, 2)
            END DO
            DO j=0,2
              arg1 = ilast - ifirst + 1
              CALL PERT_PPM(arg1, q(ifirst, j), bl(ifirst, j), br(ifirst&
&                     , j), 1)
            END DO
          END IF
          IF (je + 1 .EQ. npy) THEN
            DO i=ifirst,ilast
              bl(i, npy-2) = al(i, npy-2) - q(i, npy-2)
!           xt = t11*(q(i,npy-1)+q(i,npy)) + t12*(q(i,npy-2)+q(i,npy+1))   &
!               + t13*(dm(i,npy+1)-dm(i,npy-2))
!!!         xt = 0.75*(q(i,npy-1)+q(i,npy)) - 0.25*(q(i,npy-2)+q(i,npy+1))
              x0l = 0.5*((2.*dya(i, npy-1)+dya(i, npy-2))*q(i, npy-1)-&
&               dya(i, npy-1)*q(i, npy-2))/(dya(i, npy-1)+dya(i, npy-2))
              x0r = 0.5*((2.*dya(i, npy)+dya(i, npy+1))*q(i, npy)-dya(i&
&               , npy)*q(i, npy+1))/(dya(i, npy)+dya(i, npy+1))
              xt = x0l + x0r
              IF (0. .LT. xt) THEN
                xt = xt
              ELSE
                xt = 0.
              END IF
              br(i, npy-1) = xt - q(i, npy-1)
              bl(i, npy) = xt - q(i, npy)
              xt = 3./14.*q(i, npy) + 11./14.*q(i, npy+1) - 4./7.*dm(i, &
&               npy+1)
              IF (0. .LT. xt) THEN
                xt = xt
              ELSE
                xt = 0.
              END IF
              br(i, npy) = xt - q(i, npy)
              xt = 3./14.*q(i, npy-1) + 11./14.*q(i, npy-2) + 4./7.*dm(i&
&               , npy-2)
              IF (0. .LT. xt) THEN
                xt = xt
              ELSE
                xt = 0.
              END IF
              br(i, npy-2) = xt - q(i, npy-2)
              bl(i, npy-1) = xt - q(i, npy-1)
            END DO
            DO j=npy-2,npy
              arg1 = ilast - ifirst + 1
              CALL PERT_PPM(arg1, q(ifirst, j), bl(ifirst, j), br(ifirst&
&                     , j), 1)
            END DO
          END IF
        END IF
      ELSE
        DO j=js-1,je+2
          DO i=ifirst,ilast
            al(i, j) = 0.5*(q(i, j-1)+q(i, j)) + r3*(dm(i, j-1)-dm(i, j)&
&             )
          END DO
        END DO
        IF (jord .EQ. 11) THEN
          DO j=js-1,je+1
            DO i=ifirst,ilast
              xt = 2.*dm(i, j)
              IF (xt .GE. 0.) THEN
                x30 = xt
              ELSE
                x30 = -xt
              END IF
              IF (al(i, j) - q(i, j) .GE. 0.) THEN
                y29 = al(i, j) - q(i, j)
              ELSE
                y29 = -(al(i, j)-q(i, j))
              END IF
              IF (x30 .GT. y29) THEN
                min17 = y29
              ELSE
                min17 = x30
              END IF
              bl(i, j) = -SIGN(min17, xt)
              IF (xt .GE. 0.) THEN
                x31 = xt
              ELSE
                x31 = -xt
              END IF
              IF (al(i, j+1) - q(i, j) .GE. 0.) THEN
                y30 = al(i, j+1) - q(i, j)
              ELSE
                y30 = -(al(i, j+1)-q(i, j))
              END IF
              IF (x31 .GT. y30) THEN
                min18 = y30
              ELSE
                min18 = x31
              END IF
              br(i, j) = SIGN(min18, xt)
            END DO
          END DO
        ELSE IF (jord .EQ. 12) THEN
          DO j=js-3,je+2
            DO i=ifirst,ilast
              dq(i, j) = q(i, j+1) - q(i, j)
            END DO
          END DO
          DO j=js-1,je+1
            DO i=ifirst,ilast
              pmp = -(2.*dq(i, j))
              lac = pmp + 1.5*dq(i, j+1)
              IF (0. .LT. pmp) THEN
                IF (pmp .LT. lac) THEN
                  x32 = lac
                ELSE
                  x32 = pmp
                END IF
              ELSE IF (0. .LT. lac) THEN
                x32 = lac
              ELSE
                x32 = 0.
              END IF
              IF (0. .GT. pmp) THEN
                IF (pmp .GT. lac) THEN
                  y45 = lac
                ELSE
                  y45 = pmp
                END IF
              ELSE IF (0. .GT. lac) THEN
                y45 = lac
              ELSE
                y45 = 0.
              END IF
              IF (al(i, j) - q(i, j) .LT. y45) THEN
                y31 = y45
              ELSE
                y31 = al(i, j) - q(i, j)
              END IF
              IF (x32 .GT. y31) THEN
                bl(i, j) = y31
              ELSE
                bl(i, j) = x32
              END IF
              pmp = 2.*dq(i, j-1)
              lac = pmp - 1.5*dq(i, j-2)
              IF (0. .LT. pmp) THEN
                IF (pmp .LT. lac) THEN
                  x33 = lac
                ELSE
                  x33 = pmp
                END IF
              ELSE IF (0. .LT. lac) THEN
                x33 = lac
              ELSE
                x33 = 0.
              END IF
              IF (0. .GT. pmp) THEN
                IF (pmp .GT. lac) THEN
                  y46 = lac
                ELSE
                  y46 = pmp
                END IF
              ELSE IF (0. .GT. lac) THEN
                y46 = lac
              ELSE
                y46 = 0.
              END IF
              IF (al(i, j+1) - q(i, j) .LT. y46) THEN
                y32 = y46
              ELSE
                y32 = al(i, j+1) - q(i, j)
              END IF
              IF (x33 .GT. y32) THEN
                br(i, j) = y32
              ELSE
                br(i, j) = x33
              END IF
            END DO
          END DO
        ELSE
          DO j=js-1,je+1
            DO i=ifirst,ilast
              bl(i, j) = al(i, j) - q(i, j)
              br(i, j) = al(i, j+1) - q(i, j)
            END DO
          END DO
        END IF
        IF (jord .NE. 11) THEN
! Positive definite constraint:
          DO j=js-1,je+1
            arg1 = ilast - ifirst + 1
            CALL PERT_PPM(arg1, q(ifirst, j), bl(ifirst, j), br(ifirst, &
&                   j), 0)
          END DO
        END IF
      END IF
      DO j=js,je+1
        DO i=ifirst,ilast
          IF (c(i, j) .GT. 0.) THEN
            flux(i, j) = q(i, j-1) + (1.-c(i, j))*(br(i, j-1)-c(i, j)*(&
&             bl(i, j-1)+br(i, j-1)))
          ELSE
            flux(i, j) = q(i, j) + (1.+c(i, j))*(bl(i, j)+c(i, j)*(bl(i&
&             , j)+br(i, j)))
          END IF
        END DO
      END DO
    END IF
  END SUBROUTINE FYPPM
  SUBROUTINE MP_GHOST_EW(im, jm, km, nq, ifirst, ilast, jfirst, jlast, &
&   kfirst, klast, ng_w, ng_e, ng_s, ng_n, q_ghst, q)
    IMPLICIT NONE
!
! !INPUT PARAMETERS:
    INTEGER, INTENT(IN) :: im, jm, km, nq
    INTEGER, INTENT(IN) :: ifirst, ilast
    INTEGER, INTENT(IN) :: jfirst, jlast
    INTEGER, INTENT(IN) :: kfirst, klast
! eastern  zones to ghost
    INTEGER, INTENT(IN) :: ng_e
! western  zones to ghost
    INTEGER, INTENT(IN) :: ng_w
! southern zones to ghost
    INTEGER, INTENT(IN) :: ng_s
! northern zones to ghost
    INTEGER, INTENT(IN) :: ng_n
    REAL(fvprc), INTENT(INOUT) :: q_ghst(ifirst-ng_w:ilast+ng_e, jfirst-&
&   ng_s:jlast+ng_n, kfirst:klast, nq)
    REAL(fvprc), OPTIONAL, INTENT(IN) :: q(ifirst:ilast, jfirst:jlast, &
&   kfirst:klast, nq)
!
! !DESCRIPTION:
!
!     Ghost 4d east/west 
!
! !REVISION HISTORY:
!    2005.08.22   Putman
!
!EOP
!------------------------------------------------------------------------------
!BOC
    INTEGER :: i, j, k, n
    INTRINSIC PRESENT
    IF (PRESENT(q)) q_ghst(ifirst:ilast, jfirst:jlast, kfirst:klast, 1:&
&     nq) = q(ifirst:ilast, jfirst:jlast, kfirst:klast, 1:nq)
!      Assume Periodicity in X-dir and not overlapping
    DO n=1,nq
      DO k=kfirst,klast
        DO j=jfirst-ng_s,jlast+ng_n
          DO i=1,ng_w
            q_ghst(ifirst-i, j, k, n) = q_ghst(ilast-i+1, j, k, n)
          END DO
          DO i=1,ng_e
            q_ghst(ilast+i, j, k, n) = q_ghst(ifirst+i-1, j, k, n)
          END DO
        END DO
      END DO
    END DO
  END SUBROUTINE MP_GHOST_EW
!  Differentiation of pert_ppm in reverse (adjoint) mode (with options r8 split(a2b_edge_mod.a2b_ord2 a2b_edge_mod.a2b_ord4 a2
!b_edge_mod.extrap_corner  dyn_core_mod.dyn_core dyn_core_mod.pk3_halo dyn_core_mod.pln_halo dyn_core_mod.pe_halo dyn_core_mod
!.adv_pe dyn_core_mod.p_grad_c dyn_core_mod.nh_p_grad dyn_core_mod.split_p_grad dyn_core_mod.one_grad_p dyn_core_mod.grad1_p_upda
!te dyn_core_mod.mix_dp dyn_core_mod.geopk dyn_core_mod.del2_cubed fv_dynamics_mod.fv_dynamics fv_dynamics_mod.rayleigh_super fv_
!dynamics_mod.rayleigh_friction fv_dynamics_mod.compute_aam fv_dynamics_mod.geos_to_fv3 fv_grid_utils_mod.cubed_to_latlon fv_grid
!_utils_mod.c2l_ord4 fv_grid_utils_mod.c2l_ord2 fv_mapz_mod.lagrangian_to_eulerian fv_mapz_mod.compute_total_energy fv_mapz_mod.p
!kez fv_mapz_mod.remap_z fv_mapz_mod.map_scalar fv_mapz_mod.map1_ppm fv_mapz_mod.mapn_tracer fv_mapz_mod.map1_q2 f
!v_mapz_mod.map1_cubic fv_mapz_mod.scalar_profile_linear fv_mapz_mod.cs_profile_linear fv_mapz_mod.steepz fv_tracer2d_mod.t
!racer_2d fv_tracer2d_mod.tracer_2d_nested nh_core_mod.update_dz_c nh_core_mod.update_dz_d nh_core_mod.riem_solver_c nh_core_mod.
!riem_solver3 nh_core_mod.rim_2d nh_core_mod.sim3_solver nh_core_mod.sim3p0_solver nh_core_mod.sim1_solver nh_core_mod.sim_solver
! nh_core_mod.edge_profile sw_core_mod.c_sw sw_core_mod.d_sw sw_core_mod.divergence_corner sw_core_mod.divergence_corner_nest sw_
!core_mod.d2a2c_vect sw_core_mod.edge_interpolate4 sw_core_mod.fill2_4corners sw_core_mod.fill_4corners sw_core_mod.compute_div_d
!amping_fb sw_core_mod.smag_corner sw_core_mod.ytp_v sw_core_mod.xtp_u tp_core_mod.fv_tp_2d tp_core_mod.copy_corners_
!fb tp_core_mod.xtp tp_core_mod.ytp tp_core_mod.xppm0 tp_core_mod.yppm0 tp_core_mod.fxppm tp_core_mod.fyppm tp_
!core_mod.deln_flux)):
!   gradient     of useful results: al ar
!   with respect to varying inputs: al ar
  SUBROUTINE PERT_PPM_ADM(im, a0, al, al_ad, ar, ar_ad, iv)
    IMPLICIT NONE
    INTEGER, INTENT(IN) :: im
    INTEGER, INTENT(IN) :: iv
    REAL(fvprc), INTENT(IN) :: a0(im)
    REAL(fvprc), INTENT(INOUT) :: al(im), ar(im)
    REAL(fvprc), INTENT(INOUT) :: al_ad(im), ar_ad(im)
! Local:
    REAL(fvprc) :: a4, da1, da2, a6da, fmin
    INTEGER :: i
    REAL(fvprc), PARAMETER :: r12=1./12.
    INTRINSIC ABS
    REAL(fvprc) :: abs0
    INTEGER :: branch
!-----------------------------------
! Optimized PPM in perturbation form:
!-----------------------------------
    IF (iv .EQ. 0) THEN
! Positive definite constraint
      DO i=1,im
        IF (a0(i) .LE. 0.) THEN
          CALL PUSHCONTROL3B(5)
        ELSE
          a4 = -(3.*(ar(i)+al(i)))
          da1 = ar(i) - al(i)
          IF (da1 .GE. 0.) THEN
            abs0 = da1
          ELSE
            abs0 = -da1
          END IF
          IF (abs0 .LT. -a4) THEN
            fmin = a0(i) + 0.25/a4*da1**2 + a4*r12
            IF (fmin .LT. 0.) THEN
              IF (ar(i) .GT. 0. .AND. al(i) .GT. 0.) THEN
                CALL PUSHCONTROL3B(4)
              ELSE IF (da1 .GT. 0.) THEN
                CALL PUSHCONTROL3B(3)
              ELSE
                CALL PUSHCONTROL3B(2)
              END IF
            ELSE
              CALL PUSHCONTROL3B(1)
            END IF
          ELSE
            CALL PUSHCONTROL3B(0)
          END IF
        END IF
      END DO
      DO i=im,1,-1
        CALL POPCONTROL3B(branch)
        IF (branch .LT. 3) THEN
          IF (branch .NE. 0) THEN
            IF (branch .NE. 1) THEN
              ar_ad(i) = ar_ad(i) - 2.*al_ad(i)
              al_ad(i) = 0.0_FVPRC
            END IF
          END IF
        ELSE IF (branch .EQ. 3) THEN
          al_ad(i) = al_ad(i) - 2.*ar_ad(i)
          ar_ad(i) = 0.0_FVPRC
        ELSE IF (branch .EQ. 4) THEN
          al_ad(i) = 0.0_FVPRC
          ar_ad(i) = 0.0_FVPRC
        ELSE
          ar_ad(i) = 0.0_FVPRC
          al_ad(i) = 0.0_FVPRC
        END IF
      END DO
    ELSE
! Standard PPM constraint
      DO i=1,im
        IF (al(i)*ar(i) .LT. 0.) THEN
          da1 = al(i) - ar(i)
          da2 = da1**2
          a6da = 3.*(al(i)+ar(i))*da1
          IF (a6da .LT. -da2) THEN
            CALL PUSHCONTROL2B(3)
          ELSE IF (a6da .GT. da2) THEN
            CALL PUSHCONTROL2B(2)
          ELSE
            CALL PUSHCONTROL2B(1)
          END IF
        ELSE
          CALL PUSHCONTROL2B(0)
        END IF
      END DO
      DO i=im,1,-1
        CALL POPCONTROL2B(branch)
        IF (branch .LT. 2) THEN
          IF (branch .EQ. 0) THEN
            ar_ad(i) = 0.0_FVPRC
            al_ad(i) = 0.0_FVPRC
          END IF
        ELSE IF (branch .EQ. 2) THEN
          ar_ad(i) = ar_ad(i) - 2.*al_ad(i)
          al_ad(i) = 0.0_FVPRC
        ELSE
          al_ad(i) = al_ad(i) - 2.*ar_ad(i)
          ar_ad(i) = 0.0_FVPRC
        END IF
      END DO
    END IF
  END SUBROUTINE PERT_PPM_ADM
  SUBROUTINE PERT_PPM(im, a0, al, ar, iv)
    IMPLICIT NONE
    INTEGER, INTENT(IN) :: im
    INTEGER, INTENT(IN) :: iv
    REAL(fvprc), INTENT(IN) :: a0(im)
    REAL(fvprc), INTENT(INOUT) :: al(im), ar(im)
! Local:
    REAL(fvprc) :: a4, da1, da2, a6da, fmin
    INTEGER :: i
    REAL(fvprc), PARAMETER :: r12=1./12.
    INTRINSIC ABS
    REAL(fvprc) :: abs0
!-----------------------------------
! Optimized PPM in perturbation form:
!-----------------------------------
    IF (iv .EQ. 0) THEN
! Positive definite constraint
      DO i=1,im
        IF (a0(i) .LE. 0.) THEN
          al(i) = 0.
          ar(i) = 0.
        ELSE
          a4 = -(3.*(ar(i)+al(i)))
          da1 = ar(i) - al(i)
          IF (da1 .GE. 0.) THEN
            abs0 = da1
          ELSE
            abs0 = -da1
          END IF
          IF (abs0 .LT. -a4) THEN
            fmin = a0(i) + 0.25/a4*da1**2 + a4*r12
            IF (fmin .LT. 0.) THEN
              IF (ar(i) .GT. 0. .AND. al(i) .GT. 0.) THEN
                ar(i) = 0.
                al(i) = 0.
              ELSE IF (da1 .GT. 0.) THEN
                ar(i) = -(2.*al(i))
              ELSE
                al(i) = -(2.*ar(i))
              END IF
            END IF
          END IF
        END IF
      END DO
    ELSE
! Standard PPM constraint
      DO i=1,im
        IF (al(i)*ar(i) .LT. 0.) THEN
          da1 = al(i) - ar(i)
          da2 = da1**2
          a6da = 3.*(al(i)+ar(i))*da1
          IF (a6da .LT. -da2) THEN
            ar(i) = -(2.*al(i))
          ELSE IF (a6da .GT. da2) THEN
            al(i) = -(2.*ar(i))
          END IF
        ELSE
! effect of dm=0 included here
          al(i) = 0.
          ar(i) = 0.
        END IF
      END DO
    END IF
  END SUBROUTINE PERT_PPM
!  Differentiation of deln_flux in reverse (adjoint) mode (with options r8 split(a2b_edge_mod.a2b_ord2 a2b_edge_mod.a2b_ord4 a
!2b_edge_mod.extrap_corner  dyn_core_mod.dyn_core dyn_core_mod.pk3_halo dyn_core_mod.pln_halo dyn_core_mod.pe_halo dyn_core_mo
!d.adv_pe dyn_core_mod.p_grad_c dyn_core_mod.nh_p_grad dyn_core_mod.split_p_grad dyn_core_mod.one_grad_p dyn_core_mod.grad1_p_upd
!ate dyn_core_mod.mix_dp dyn_core_mod.geopk dyn_core_mod.del2_cubed fv_dynamics_mod.fv_dynamics fv_dynamics_mod.rayleigh_super fv
!_dynamics_mod.rayleigh_friction fv_dynamics_mod.compute_aam fv_dynamics_mod.geos_to_fv3 fv_grid_utils_mod.cubed_to_latlon fv_gri
!d_utils_mod.c2l_ord4 fv_grid_utils_mod.c2l_ord2 fv_mapz_mod.lagrangian_to_eulerian fv_mapz_mod.compute_total_energy fv_mapz_mod.
!pkez fv_mapz_mod.remap_z fv_mapz_mod.map_scalar fv_mapz_mod.map1_ppm fv_mapz_mod.mapn_tracer fv_mapz_mod.map1_q2 
!fv_mapz_mod.map1_cubic fv_mapz_mod.scalar_profile_linear fv_mapz_mod.cs_profile_linear fv_mapz_mod.steepz fv_tracer2d_mod.
!tracer_2d fv_tracer2d_mod.tracer_2d_nested nh_core_mod.update_dz_c nh_core_mod.update_dz_d nh_core_mod.riem_solver_c nh_core_mod
!.riem_solver3 nh_core_mod.rim_2d nh_core_mod.sim3_solver nh_core_mod.sim3p0_solver nh_core_mod.sim1_solver nh_core_mod.sim_solve
!r nh_core_mod.edge_profile sw_core_mod.c_sw sw_core_mod.d_sw sw_core_mod.divergence_corner sw_core_mod.divergence_corner_nest sw
!_core_mod.d2a2c_vect sw_core_mod.edge_interpolate4 sw_core_mod.fill2_4corners sw_core_mod.fill_4corners sw_core_mod.compute_div_
!damping_fb sw_core_mod.smag_corner sw_core_mod.ytp_v sw_core_mod.xtp_u tp_core_mod.fv_tp_2d tp_core_mod.copy_corners
!_fb tp_core_mod.xtp tp_core_mod.ytp tp_core_mod.xppm0 tp_core_mod.yppm0 tp_core_mod.fxppm tp_core_mod.fyppm tp
!_core_mod.deln_flux)):
!   gradient     of useful results: q mass fx fy
!   with respect to varying inputs: q mass fx fy
  SUBROUTINE DELN_FLUX_ADM(nord, npx, npy, damp, q, q_ad, fx, fx_ad, fy&
&   , fy_ad, gridstruct, bd, mass, mass_ad)
    IMPLICIT NONE
! Del-n damping for the cell-mean values (A grid)
!------------------
! nord = 0:   del-2
! nord = 1:   del-4
! nord = 2:   del-6
! nord = 3:   del-8 --> requires more ghosting than current
!------------------
    TYPE(FV_GRID_BOUNDS_TYPE), INTENT(IN) :: bd
! del-n
    INTEGER, INTENT(IN) :: nord
    INTEGER, INTENT(IN) :: npx, npy
    REAL(fvprc), INTENT(IN) :: damp
! q ghosted on input
    REAL(fvprc), INTENT(IN) :: q(bd%is-ng:bd%ie+ng, bd%js-ng:bd%je+ng)
    REAL(fvprc) :: q_ad(bd%is-ng:bd%ie+ng, bd%js-ng:bd%je+ng)
    TYPE(FV_GRID_TYPE), INTENT(IN), TARGET :: gridstruct
! q ghosted on input
    REAL(fvprc), OPTIONAL, INTENT(IN) :: mass(bd%isd:bd%ied, bd%jsd:bd%&
&   jed)
    REAL(fvprc), OPTIONAL :: mass_ad(bd%isd:bd%ied, bd%jsd:bd%jed)
! diffusive fluxes:
    REAL(fvprc), INTENT(INOUT) :: fx(bd%is:bd%ie+1, bd%js:bd%je), fy(bd%&
&   is:bd%ie, bd%js:bd%je+1)
    REAL(fvprc), INTENT(INOUT) :: fx_ad(bd%is:bd%ie+1, bd%js:bd%je), &
&   fy_ad(bd%is:bd%ie, bd%js:bd%je+1)
! local:
    REAL(fvprc) :: fx2(bd%isd:bd%ied+1, bd%jsd:bd%jed), fy2(bd%isd:bd%&
&   ied, bd%jsd:bd%jed+1)
    REAL(fvprc) :: fx2_ad(bd%isd:bd%ied+1, bd%jsd:bd%jed), fy2_ad(bd%isd&
&   :bd%ied, bd%jsd:bd%jed+1)
    REAL(fvprc) :: d2(bd%isd:bd%ied, bd%jsd:bd%jed)
    REAL(fvprc) :: d2_ad(bd%isd:bd%ied, bd%jsd:bd%jed)
    REAL(fvprc) :: damp2
    INTEGER :: i, j, n, nt, i1, i2, j1, j2
    INTEGER :: is, ie, js, je, isd, ied, jsd, jed
    INTRINSIC PRESENT
    REAL(fvprc) :: temp_ad
    REAL(fvprc) :: temp_ad0
    REAL(fvprc) :: temp_ad1
    REAL(fvprc) :: temp_ad2
    REAL(fvprc) :: temp_ad3
    REAL(fvprc) :: temp_ad4
    REAL(fvprc) :: temp_ad5
    INTEGER :: ad_from
    INTEGER :: ad_to
    INTEGER :: ad_from0
    INTEGER :: ad_to0
    INTEGER :: ad_from1
    INTEGER :: ad_to1
    INTEGER :: ad_from2
    INTEGER :: ad_to2
    INTEGER :: ad_from3
    INTEGER :: ad_to3
    INTEGER :: ad_from4
    INTEGER :: ad_to4
    INTEGER :: branch
    is = bd%is
    ie = bd%ie
    js = bd%js
    je = bd%je
!   real(FVPRC), pointer, dimension(:,:)   :: rarea, dx, dy, rdxc, rdyc
!   real(FVPRC), pointer, dimension(:,:,:) :: sin_sg
!   rarea    => gridstruct%rarea  
!   dx       => gridstruct%dx     
!   dy       => gridstruct%dy     
!   rdxc     => gridstruct%rdxc   
!   rdyc     => gridstruct%rdyc   
!   sin_sg   => gridstruct%sin_sg 
    i1 = is - 1 - nord
    i2 = ie + 1 + nord
    j1 = js - 1 - nord
    j2 = je + 1 + nord
    IF (.NOT.PRESENT(mass)) THEN
      DO j=j1,j2
        DO i=i1,i2
          d2(i, j) = damp*q(i, j)
        END DO
      END DO
      CALL PUSHCONTROL1B(0)
    ELSE
      DO j=j1,j2
        DO i=i1,i2
          d2(i, j) = q(i, j)
        END DO
      END DO
      CALL PUSHCONTROL1B(1)
    END IF
    IF (nord .GT. 0) THEN
      CALL COPY_CORNERS(d2, npx, npy, 1, gridstruct%nested, bd, &
&                 gridstruct%sw_corner, gridstruct%se_corner, gridstruct&
&                 %nw_corner, gridstruct%ne_corner)
      CALL PUSHCONTROL1B(1)
    ELSE
      CALL PUSHCONTROL1B(0)
    END IF
    DO j=js-nord,je+nord
      DO i=is-nord,ie+nord+1
!        fx2(i,j) = gridstruct%dy(i,j)*sina_u(i,j)*(d2(i-1,j)-d2(i,j))*gridstruct%rdxc(i,j)
        fx2(i, j) = 0.5*(gridstruct%sin_sg(i-1, j, 3)+gridstruct%sin_sg(&
&         i, j, 1))*gridstruct%dy(i, j)*(d2(i-1, j)-d2(i, j))*gridstruct&
&         %rdxc(i, j)
      END DO
    END DO
    IF (nord .GT. 0) THEN
      CALL COPY_CORNERS(d2, npx, npy, 2, gridstruct%nested, bd, &
&                 gridstruct%sw_corner, gridstruct%se_corner, gridstruct&
&                 %nw_corner, gridstruct%ne_corner)
      CALL PUSHCONTROL1B(1)
    ELSE
      CALL PUSHCONTROL1B(0)
    END IF
    DO j=js-nord,je+nord+1
      DO i=is-nord,ie+nord
!           fy2(i,j) = gridstruct%dx(i,j)*sina_v(i,j)*(d2(i,j-1)-d2(i,j))*gridstruct%rdyc(i,j)
        fy2(i, j) = 0.5*(gridstruct%sin_sg(i, j-1, 4)+gridstruct%sin_sg(&
&         i, j, 2))*gridstruct%dx(i, j)*(d2(i, j-1)-d2(i, j))*gridstruct&
&         %rdyc(i, j)
      END DO
    END DO
    IF (nord .GT. 0) THEN
!----------
! high-order
!----------
      DO n=1,nord
        nt = nord - n
        ad_from0 = js - nt - 1
        DO j=ad_from0,je+nt+1
          ad_from = is - nt - 1
          DO i=ad_from,ie+nt+1
            d2(i, j) = (fx2(i, j)-fx2(i+1, j)+fy2(i, j)-fy2(i, j+1))*&
&             gridstruct%rarea(i, j)
          END DO
          CALL PUSHINTEGER4(i - 1)
          CALL PUSHINTEGER4(ad_from)
        END DO
        CALL PUSHINTEGER4(j - 1)
        CALL PUSHINTEGER4(ad_from0)
        CALL COPY_CORNERS(d2, npx, npy, 1, gridstruct%nested, bd, &
&                   gridstruct%sw_corner, gridstruct%se_corner, &
&                   gridstruct%nw_corner, gridstruct%ne_corner)
        ad_from2 = js - nt
        DO j=ad_from2,je+nt
          ad_from1 = is - nt
          DO i=ad_from1,ie+nt+1
            fx2(i, j) = 0.5*(gridstruct%sin_sg(i-1, j, 3)+gridstruct%&
&             sin_sg(i, j, 1))*gridstruct%dy(i, j)*(d2(i, j)-d2(i-1, j))&
&             *gridstruct%rdxc(i, j)
          END DO
          CALL PUSHINTEGER4(i - 1)
          CALL PUSHINTEGER4(ad_from1)
        END DO
        CALL PUSHINTEGER4(j - 1)
        CALL PUSHINTEGER4(ad_from2)
        CALL COPY_CORNERS(d2, npx, npy, 2, gridstruct%nested, bd, &
&                   gridstruct%sw_corner, gridstruct%se_corner, &
&                   gridstruct%nw_corner, gridstruct%ne_corner)
        ad_from4 = js - nt
        DO j=ad_from4,je+nt+1
          ad_from3 = is - nt
          DO i=ad_from3,ie+nt
            fy2(i, j) = gridstruct%dx(i, j)*(d2(i, j)-d2(i, j-1))*&
&             gridstruct%rdyc(i, j)*0.5*(gridstruct%sin_sg(i, j-1, 4)+&
&             gridstruct%sin_sg(i, j, 2))
          END DO
          CALL PUSHINTEGER4(i - 1)
          CALL PUSHINTEGER4(ad_from3)
        END DO
        CALL PUSHINTEGER4(j - 1)
        CALL PUSHINTEGER4(ad_from4)
      END DO
      CALL PUSHCONTROL1B(0)
    ELSE
      CALL PUSHCONTROL1B(1)
    END IF
!---------------------------------------------
! Add the diffusive fluxes to the flux arrays:
!---------------------------------------------
    IF (PRESENT(mass)) THEN
! Apply mass weighting to diffusive fluxes:
      damp2 = 0.5*damp
      fy2_ad = 0.0_FVPRC
      DO j=je+1,js,-1
        DO i=ie,is,-1
          temp_ad5 = damp2*fy2(i, j)*fy_ad(i, j)
          mass_ad(i, j-1) = mass_ad(i, j-1) + temp_ad5
          mass_ad(i, j) = mass_ad(i, j) + temp_ad5
          fy2_ad(i, j) = fy2_ad(i, j) + damp2*(mass(i, j-1)+mass(i, j))*&
&           fy_ad(i, j)
        END DO
      END DO
      fx2_ad = 0.0_FVPRC
      DO j=je,js,-1
        DO i=ie+1,is,-1
          temp_ad4 = damp2*fx2(i, j)*fx_ad(i, j)
          mass_ad(i-1, j) = mass_ad(i-1, j) + temp_ad4
          mass_ad(i, j) = mass_ad(i, j) + temp_ad4
          fx2_ad(i, j) = fx2_ad(i, j) + damp2*(mass(i-1, j)+mass(i, j))*&
&           fx_ad(i, j)
        END DO
      END DO
    ELSE
      fy2_ad = 0.0_FVPRC
      DO j=je+1,js,-1
        DO i=ie,is,-1
          fy2_ad(i, j) = fy2_ad(i, j) + fy_ad(i, j)
        END DO
      END DO
      fx2_ad = 0.0_FVPRC
      DO j=je,js,-1
        DO i=ie+1,is,-1
          fx2_ad(i, j) = fx2_ad(i, j) + fx_ad(i, j)
        END DO
      END DO
    END IF
    CALL POPCONTROL1B(branch)
    IF (branch .EQ. 0) THEN
      d2_ad = 0.0_FVPRC
      DO n=nord,1,-1
        CALL POPINTEGER4(ad_from4)
        CALL POPINTEGER4(ad_to4)
        DO j=ad_to4,ad_from4,-1
          CALL POPINTEGER4(ad_from3)
          CALL POPINTEGER4(ad_to3)
          DO i=ad_to3,ad_from3,-1
            temp_ad3 = gridstruct%dx(i, j)*0.5*gridstruct%rdyc(i, j)*(&
&             gridstruct%sin_sg(i, j-1, 4)+gridstruct%sin_sg(i, j, 2))*&
&             fy2_ad(i, j)
            d2_ad(i, j) = d2_ad(i, j) + temp_ad3
            d2_ad(i, j-1) = d2_ad(i, j-1) - temp_ad3
            fy2_ad(i, j) = 0.0_FVPRC
          END DO
        END DO
        CALL COPY_CORNERS_ADM(d2, d2_ad, npx, npy, 2, gridstruct%nested&
&                       , bd, gridstruct%sw_corner, gridstruct%se_corner&
&                       , gridstruct%nw_corner, gridstruct%ne_corner)
        CALL POPINTEGER4(ad_from2)
        CALL POPINTEGER4(ad_to2)
        DO j=ad_to2,ad_from2,-1
          CALL POPINTEGER4(ad_from1)
          CALL POPINTEGER4(ad_to1)
          DO i=ad_to1,ad_from1,-1
            temp_ad2 = gridstruct%dy(i, j)*0.5*gridstruct%rdxc(i, j)*(&
&             gridstruct%sin_sg(i-1, j, 3)+gridstruct%sin_sg(i, j, 1))*&
&             fx2_ad(i, j)
            d2_ad(i, j) = d2_ad(i, j) + temp_ad2
            d2_ad(i-1, j) = d2_ad(i-1, j) - temp_ad2
            fx2_ad(i, j) = 0.0_FVPRC
          END DO
        END DO
        CALL COPY_CORNERS_ADM(d2, d2_ad, npx, npy, 1, gridstruct%nested&
&                       , bd, gridstruct%sw_corner, gridstruct%se_corner&
&                       , gridstruct%nw_corner, gridstruct%ne_corner)
        CALL POPINTEGER4(ad_from0)
        CALL POPINTEGER4(ad_to0)
        DO j=ad_to0,ad_from0,-1
          CALL POPINTEGER4(ad_from)
          CALL POPINTEGER4(ad_to)
          DO i=ad_to,ad_from,-1
            temp_ad1 = gridstruct%rarea(i, j)*d2_ad(i, j)
            fx2_ad(i, j) = fx2_ad(i, j) + temp_ad1
            fx2_ad(i+1, j) = fx2_ad(i+1, j) - temp_ad1
            fy2_ad(i, j) = fy2_ad(i, j) + temp_ad1
            fy2_ad(i, j+1) = fy2_ad(i, j+1) - temp_ad1
            d2_ad(i, j) = 0.0_FVPRC
          END DO
        END DO
      END DO
    ELSE
      d2_ad = 0.0_FVPRC
    END IF
    DO j=je+nord+1,js-nord,-1
      DO i=ie+nord,is-nord,-1
        temp_ad0 = gridstruct%dx(i, j)*0.5*gridstruct%rdyc(i, j)*(&
&         gridstruct%sin_sg(i, j-1, 4)+gridstruct%sin_sg(i, j, 2))*&
&         fy2_ad(i, j)
        d2_ad(i, j-1) = d2_ad(i, j-1) + temp_ad0
        d2_ad(i, j) = d2_ad(i, j) - temp_ad0
        fy2_ad(i, j) = 0.0_FVPRC
      END DO
    END DO
    CALL POPCONTROL1B(branch)
    IF (branch .NE. 0) CALL COPY_CORNERS_ADM(d2, d2_ad, npx, npy, 2, &
&                                      gridstruct%nested, bd, gridstruct&
&                                      %sw_corner, gridstruct%se_corner&
&                                      , gridstruct%nw_corner, &
&                                      gridstruct%ne_corner)
    DO j=je+nord,js-nord,-1
      DO i=ie+nord+1,is-nord,-1
        temp_ad = gridstruct%dy(i, j)*0.5*gridstruct%rdxc(i, j)*(&
&         gridstruct%sin_sg(i-1, j, 3)+gridstruct%sin_sg(i, j, 1))*&
&         fx2_ad(i, j)
        d2_ad(i-1, j) = d2_ad(i-1, j) + temp_ad
        d2_ad(i, j) = d2_ad(i, j) - temp_ad
        fx2_ad(i, j) = 0.0_FVPRC
      END DO
    END DO
    CALL POPCONTROL1B(branch)
    IF (branch .NE. 0) CALL COPY_CORNERS_ADM(d2, d2_ad, npx, npy, 1, &
&                                      gridstruct%nested, bd, gridstruct&
&                                      %sw_corner, gridstruct%se_corner&
&                                      , gridstruct%nw_corner, &
&                                      gridstruct%ne_corner)
    CALL POPCONTROL1B(branch)
    IF (branch .EQ. 0) THEN
      DO j=j2,j1,-1
        DO i=i2,i1,-1
          q_ad(i, j) = q_ad(i, j) + damp*d2_ad(i, j)
          d2_ad(i, j) = 0.0_FVPRC
        END DO
      END DO
    ELSE
      DO j=j2,j1,-1
        DO i=i2,i1,-1
          q_ad(i, j) = q_ad(i, j) + d2_ad(i, j)
          d2_ad(i, j) = 0.0_FVPRC
        END DO
      END DO
    END IF
  END SUBROUTINE DELN_FLUX_ADM
!  Differentiation of copy_corners in reverse (adjoint) mode (with options r8 split(a2b_edge_mod.a2b_ord2 a2b_edge_mod.a2b_ord4_f
!b a2b_edge_mod.extrap_corner  dyn_core_mod.dyn_core dyn_core_mod.pk3_halo dyn_core_mod.pln_halo dyn_core_mod.pe_halo dyn_core
!_mod.adv_pe dyn_core_mod.p_grad_c dyn_core_mod.nh_p_grad dyn_core_mod.split_p_grad dyn_core_mod.one_grad_p dyn_core_mod.grad1_p_
!update dyn_core_mod.mix_dp dyn_core_mod.geopk dyn_core_mod.del2_cubed fv_dynamics_mod.fv_dynamics fv_dynamics_mod.rayleigh_super
! fv_dynamics_mod.rayleigh_friction fv_dynamics_mod.compute_aam fv_dynamics_mod.geos_to_fv3 fv_grid_utils_mod.cubed_to_latlon fv_
!grid_utils_mod.c2l_ord4 fv_grid_utils_mod.c2l_ord2 fv_mapz_mod.lagrangian_to_eulerian fv_mapz_mod.compute_total_energy fv_mapz_m
!od.pkez fv_mapz_mod.remap_z fv_mapz_mod.map_scalar fv_mapz_mod.map1_ppm fv_mapz_mod.mapn_tracer fv_mapz_mod.map1_q2_
!fb fv_mapz_mod.map1_cubic fv_mapz_mod.scalar_profile_linear fv_mapz_mod.cs_profile_linear fv_mapz_mod.steepz fv_tracer2d_m
!od.tracer_2d fv_tracer2d_mod.tracer_2d_nested nh_core_mod.update_dz_c nh_core_mod.update_dz_d nh_core_mod.riem_solver_c nh_core_
!mod.riem_solver3 nh_core_mod.rim_2d nh_core_mod.sim3_solver nh_core_mod.sim3p0_solver nh_core_mod.sim1_solver nh_core_mod.sim_so
!lver nh_core_mod.edge_profile sw_core_mod.c_sw sw_core_mod.d_sw sw_core_mod.divergence_corner sw_core_mod.divergence_corner_nest
! sw_core_mod.d2a2c_vect sw_core_mod.edge_interpolate4 sw_core_mod.fill2_4corners sw_core_mod.fill_4corners sw_core_mod.compute_d
!iv_damping_fb sw_core_mod.smag_corner sw_core_mod.ytp_v sw_core_mod.xtp_u tp_core_mod.fv_tp_2d tp_core_mod.copy_corn
!ers_fb tp_core_mod.xtp tp_core_mod.ytp tp_core_mod.xppm0 tp_core_mod.yppm0 tp_core_mod.fxppm tp_core_mod.fyppm
! tp_core_mod.deln_flux)):
!   gradient     of useful results: q
!   with respect to varying inputs: q
!Weird arguments are because this routine is called in a lot of
!places outside of tp_core, sometimes very deeply nested in the call tree.
  SUBROUTINE COPY_CORNERS_ADM(q, q_ad, npx, npy, dir, nested, bd, &
&   sw_corner, se_corner, nw_corner, ne_corner)
    IMPLICIT NONE
    TYPE(FV_GRID_BOUNDS_TYPE), INTENT(IN) :: bd
    INTEGER, INTENT(IN) :: npx, npy, dir
    REAL(fvprc), INTENT(INOUT) :: q(bd%isd:bd%ied, bd%jsd:bd%jed)
    REAL(fvprc), INTENT(INOUT) :: q_ad(bd%isd:bd%ied, bd%jsd:bd%jed)
    LOGICAL, INTENT(IN) :: nested, sw_corner, se_corner, nw_corner, &
&   ne_corner
    INTEGER :: i, j
    REAL(fvprc) :: tmp
    REAL(fvprc) :: tmp_ad
    REAL(fvprc) :: tmp0
    REAL(fvprc) :: tmp_ad0
    REAL(fvprc) :: tmp1
    REAL(fvprc) :: tmp_ad1
    REAL(fvprc) :: tmp2
    REAL(fvprc) :: tmp_ad2
    REAL(fvprc) :: tmp3
    REAL(fvprc) :: tmp_ad3
    REAL(fvprc) :: tmp4
    REAL(fvprc) :: tmp_ad4
    REAL(fvprc) :: tmp5
    REAL(fvprc) :: tmp_ad5
    REAL(fvprc) :: tmp6
    REAL(fvprc) :: tmp_ad6
    INTEGER :: branch
    IF (.NOT.nested) THEN
      IF (dir .EQ. 1) THEN
! XDir:
        IF (sw_corner) THEN
          CALL PUSHCONTROL1B(0)
        ELSE
          CALL PUSHCONTROL1B(1)
        END IF
        IF (se_corner) THEN
          CALL PUSHCONTROL1B(0)
        ELSE
          CALL PUSHCONTROL1B(1)
        END IF
        IF (ne_corner) THEN
          CALL PUSHCONTROL1B(0)
        ELSE
          CALL PUSHCONTROL1B(1)
        END IF
        IF (nw_corner) THEN
          DO j=npy+ng-1,npy,-1
            DO i=0,1-ng,-1
              tmp_ad2 = q_ad(i, j)
              q_ad(i, j) = 0.0_FVPRC
              q_ad(npy-j, i-1+npx) = q_ad(npy-j, i-1+npx) + tmp_ad2
            END DO
          END DO
        END IF
        CALL POPCONTROL1B(branch)
        IF (branch .EQ. 0) THEN
          DO j=npy+ng-1,npy,-1
            DO i=npx+ng-1,npx,-1
              tmp_ad1 = q_ad(i, j)
              q_ad(i, j) = 0.0_FVPRC
              q_ad(j, 2*npx-1-i) = q_ad(j, 2*npx-1-i) + tmp_ad1
            END DO
          END DO
        END IF
        CALL POPCONTROL1B(branch)
        IF (branch .EQ. 0) THEN
          DO j=0,1-ng,-1
            DO i=npx+ng-1,npx,-1
              tmp_ad0 = q_ad(i, j)
              q_ad(i, j) = 0.0_FVPRC
              q_ad(npy-j, i-npx+1) = q_ad(npy-j, i-npx+1) + tmp_ad0
            END DO
          END DO
        END IF
        CALL POPCONTROL1B(branch)
        IF (branch .EQ. 0) THEN
          DO j=0,1-ng,-1
            DO i=0,1-ng,-1
              tmp_ad = q_ad(i, j)
              q_ad(i, j) = 0.0_FVPRC
              q_ad(j, 1-i) = q_ad(j, 1-i) + tmp_ad
            END DO
          END DO
        END IF
      ELSE IF (dir .EQ. 2) THEN
! YDir:
        IF (sw_corner) THEN
          CALL PUSHCONTROL1B(0)
        ELSE
          CALL PUSHCONTROL1B(1)
        END IF
        IF (se_corner) THEN
          CALL PUSHCONTROL1B(0)
        ELSE
          CALL PUSHCONTROL1B(1)
        END IF
        IF (ne_corner) THEN
          CALL PUSHCONTROL1B(0)
        ELSE
          CALL PUSHCONTROL1B(1)
        END IF
        IF (nw_corner) THEN
          DO j=npy+ng-1,npy,-1
            DO i=0,1-ng,-1
              tmp_ad6 = q_ad(i, j)
              q_ad(i, j) = 0.0_FVPRC
              q_ad(j+1-npx, npy-i) = q_ad(j+1-npx, npy-i) + tmp_ad6
            END DO
          END DO
        END IF
        CALL POPCONTROL1B(branch)
        IF (branch .EQ. 0) THEN
          DO j=npy+ng-1,npy,-1
            DO i=npx+ng-1,npx,-1
              tmp_ad5 = q_ad(i, j)
              q_ad(i, j) = 0.0_FVPRC
              q_ad(2*npy-1-j, i) = q_ad(2*npy-1-j, i) + tmp_ad5
            END DO
          END DO
        END IF
        CALL POPCONTROL1B(branch)
        IF (branch .EQ. 0) THEN
          DO j=0,1-ng,-1
            DO i=npx+ng-1,npx,-1
              tmp_ad4 = q_ad(i, j)
              q_ad(i, j) = 0.0_FVPRC
              q_ad(npy+j-1, npx-i) = q_ad(npy+j-1, npx-i) + tmp_ad4
            END DO
          END DO
        END IF
        CALL POPCONTROL1B(branch)
        IF (branch .EQ. 0) THEN
          DO j=0,1-ng,-1
            DO i=0,1-ng,-1
              tmp_ad3 = q_ad(i, j)
              q_ad(i, j) = 0.0_FVPRC
              q_ad(1-j, i) = q_ad(1-j, i) + tmp_ad3
            END DO
          END DO
        END IF
      END IF
    END IF
  END SUBROUTINE COPY_CORNERS_ADM
  SUBROUTINE DELN_FLUX(nord, npx, npy, damp, q, fx, fy, gridstruct, bd, &
&   mass)
    IMPLICIT NONE
! Del-n damping for the cell-mean values (A grid)
!------------------
! nord = 0:   del-2
! nord = 1:   del-4
! nord = 2:   del-6
! nord = 3:   del-8 --> requires more ghosting than current
!------------------
    TYPE(FV_GRID_BOUNDS_TYPE), INTENT(IN) :: bd
! del-n
    INTEGER, INTENT(IN) :: nord
    INTEGER, INTENT(IN) :: npx, npy
    REAL(fvprc), INTENT(IN) :: damp
! q ghosted on input
    REAL(fvprc), INTENT(IN) :: q(bd%is-ng:bd%ie+ng, bd%js-ng:bd%je+ng)
    TYPE(FV_GRID_TYPE), INTENT(IN), TARGET :: gridstruct
! q ghosted on input
    REAL(fvprc), OPTIONAL, INTENT(IN) :: mass(bd%isd:bd%ied, bd%jsd:bd%&
&   jed)
! diffusive fluxes:
    REAL(fvprc), INTENT(INOUT) :: fx(bd%is:bd%ie+1, bd%js:bd%je), fy(bd%&
&   is:bd%ie, bd%js:bd%je+1)
! local:
    REAL(fvprc) :: fx2(bd%isd:bd%ied+1, bd%jsd:bd%jed), fy2(bd%isd:bd%&
&   ied, bd%jsd:bd%jed+1)
    REAL(fvprc) :: d2(bd%isd:bd%ied, bd%jsd:bd%jed)
    REAL(fvprc) :: damp2
    INTEGER :: i, j, n, nt, i1, i2, j1, j2
    INTEGER :: is, ie, js, je, isd, ied, jsd, jed
    INTRINSIC PRESENT
    is = bd%is
    ie = bd%ie
    js = bd%js
    je = bd%je
    isd = bd%isd
    ied = bd%ied
    jsd = bd%jsd
    jed = bd%jed
!   real(FVPRC), pointer, dimension(:,:)   :: rarea, dx, dy, rdxc, rdyc
!   real(FVPRC), pointer, dimension(:,:,:) :: sin_sg
!   rarea    => gridstruct%rarea  
!   dx       => gridstruct%dx     
!   dy       => gridstruct%dy     
!   rdxc     => gridstruct%rdxc   
!   rdyc     => gridstruct%rdyc   
!   sin_sg   => gridstruct%sin_sg 
    i1 = is - 1 - nord
    i2 = ie + 1 + nord
    j1 = js - 1 - nord
    j2 = je + 1 + nord
    IF (.NOT.PRESENT(mass)) THEN
      DO j=j1,j2
        DO i=i1,i2
          d2(i, j) = damp*q(i, j)
        END DO
      END DO
    ELSE
      DO j=j1,j2
        DO i=i1,i2
          d2(i, j) = q(i, j)
        END DO
      END DO
    END IF
    IF (nord .GT. 0) CALL COPY_CORNERS(d2, npx, npy, 1, gridstruct%&
&                                nested, bd, gridstruct%sw_corner, &
&                                gridstruct%se_corner, gridstruct%&
&                                nw_corner, gridstruct%ne_corner)
    DO j=js-nord,je+nord
      DO i=is-nord,ie+nord+1
!        fx2(i,j) = gridstruct%dy(i,j)*sina_u(i,j)*(d2(i-1,j)-d2(i,j))*gridstruct%rdxc(i,j)
        fx2(i, j) = 0.5*(gridstruct%sin_sg(i-1, j, 3)+gridstruct%sin_sg(&
&         i, j, 1))*gridstruct%dy(i, j)*(d2(i-1, j)-d2(i, j))*gridstruct&
&         %rdxc(i, j)
      END DO
    END DO
    IF (nord .GT. 0) CALL COPY_CORNERS(d2, npx, npy, 2, gridstruct%&
&                                nested, bd, gridstruct%sw_corner, &
&                                gridstruct%se_corner, gridstruct%&
&                                nw_corner, gridstruct%ne_corner)
    DO j=js-nord,je+nord+1
      DO i=is-nord,ie+nord
!           fy2(i,j) = gridstruct%dx(i,j)*sina_v(i,j)*(d2(i,j-1)-d2(i,j))*gridstruct%rdyc(i,j)
        fy2(i, j) = 0.5*(gridstruct%sin_sg(i, j-1, 4)+gridstruct%sin_sg(&
&         i, j, 2))*gridstruct%dx(i, j)*(d2(i, j-1)-d2(i, j))*gridstruct&
&         %rdyc(i, j)
      END DO
    END DO
    IF (nord .GT. 0) THEN
!----------
! high-order
!----------
      DO n=1,nord
        nt = nord - n
        DO j=js-nt-1,je+nt+1
          DO i=is-nt-1,ie+nt+1
            d2(i, j) = (fx2(i, j)-fx2(i+1, j)+fy2(i, j)-fy2(i, j+1))*&
&             gridstruct%rarea(i, j)
          END DO
        END DO
        CALL COPY_CORNERS(d2, npx, npy, 1, gridstruct%nested, bd, &
&                   gridstruct%sw_corner, gridstruct%se_corner, &
&                   gridstruct%nw_corner, gridstruct%ne_corner)
        DO j=js-nt,je+nt
          DO i=is-nt,ie+nt+1
            fx2(i, j) = 0.5*(gridstruct%sin_sg(i-1, j, 3)+gridstruct%&
&             sin_sg(i, j, 1))*gridstruct%dy(i, j)*(d2(i, j)-d2(i-1, j))&
&             *gridstruct%rdxc(i, j)
          END DO
        END DO
        CALL COPY_CORNERS(d2, npx, npy, 2, gridstruct%nested, bd, &
&                   gridstruct%sw_corner, gridstruct%se_corner, &
&                   gridstruct%nw_corner, gridstruct%ne_corner)
        DO j=js-nt,je+nt+1
          DO i=is-nt,ie+nt
            fy2(i, j) = gridstruct%dx(i, j)*(d2(i, j)-d2(i, j-1))*&
&             gridstruct%rdyc(i, j)*0.5*(gridstruct%sin_sg(i, j-1, 4)+&
&             gridstruct%sin_sg(i, j, 2))
          END DO
        END DO
      END DO
    END IF
!---------------------------------------------
! Add the diffusive fluxes to the flux arrays:
!---------------------------------------------
    IF (PRESENT(mass)) THEN
! Apply mass weighting to diffusive fluxes:
      damp2 = 0.5*damp
      DO j=js,je
        DO i=is,ie+1
          fx(i, j) = fx(i, j) + damp2*(mass(i-1, j)+mass(i, j))*fx2(i, j&
&           )
        END DO
      END DO
      DO j=js,je+1
        DO i=is,ie
          fy(i, j) = fy(i, j) + damp2*(mass(i, j-1)+mass(i, j))*fy2(i, j&
&           )
        END DO
      END DO
    ELSE
      DO j=js,je
        DO i=is,ie+1
          fx(i, j) = fx(i, j) + fx2(i, j)
        END DO
      END DO
      DO j=js,je+1
        DO i=is,ie
          fy(i, j) = fy(i, j) + fy2(i, j)
        END DO
      END DO
    END IF
  END SUBROUTINE DELN_FLUX
!Weird arguments are because this routine is called in a lot of
!places outside of tp_core, sometimes very deeply nested in the call tree.
  SUBROUTINE COPY_CORNERS(q, npx, npy, dir, nested, bd, sw_corner, &
&   se_corner, nw_corner, ne_corner)
    IMPLICIT NONE
    TYPE(FV_GRID_BOUNDS_TYPE), INTENT(IN) :: bd
    INTEGER, INTENT(IN) :: npx, npy, dir
    REAL(fvprc), INTENT(INOUT) :: q(bd%isd:bd%ied, bd%jsd:bd%jed)
    LOGICAL, INTENT(IN) :: nested, sw_corner, se_corner, nw_corner, &
&   ne_corner
    INTEGER :: i, j
    IF (nested) THEN
      RETURN
    ELSE IF (dir .EQ. 1) THEN
! XDir:
      IF (sw_corner) THEN
        DO j=1-ng,0
          DO i=1-ng,0
            q(i, j) = q(j, 1-i)
          END DO
        END DO
      END IF
      IF (se_corner) THEN
        DO j=1-ng,0
          DO i=npx,npx+ng-1
            q(i, j) = q(npy-j, i-npx+1)
          END DO
        END DO
      END IF
      IF (ne_corner) THEN
        DO j=npy,npy+ng-1
          DO i=npx,npx+ng-1
            q(i, j) = q(j, 2*npx-1-i)
          END DO
        END DO
      END IF
      IF (nw_corner) THEN
        DO j=npy,npy+ng-1
          DO i=1-ng,0
            q(i, j) = q(npy-j, i-1+npx)
          END DO
        END DO
      END IF
    ELSE IF (dir .EQ. 2) THEN
! YDir:
      IF (sw_corner) THEN
        DO j=1-ng,0
          DO i=1-ng,0
            q(i, j) = q(1-j, i)
          END DO
        END DO
      END IF
      IF (se_corner) THEN
        DO j=1-ng,0
          DO i=npx,npx+ng-1
            q(i, j) = q(npy+j-1, npx-i)
          END DO
        END DO
      END IF
      IF (ne_corner) THEN
        DO j=npy,npy+ng-1
          DO i=npx,npx+ng-1
            q(i, j) = q(2*npy-1-j, i)
          END DO
        END DO
      END IF
      IF (nw_corner) THEN
        DO j=npy,npy+ng-1
          DO i=1-ng,0
            q(i, j) = q(j+1-npx, npy-i)
          END DO
        END DO
      END IF
    END IF
  END SUBROUTINE COPY_CORNERS
!  Differentiation of fv_tp_2d in reverse (adjoint) mode, forward sweep (with options r8 split(a2b_edge_mod.a2b_ord2 a2b_edge_
!mod.a2b_ord4 a2b_edge_mod.extrap_corner  dyn_core_mod.dyn_core dyn_core_mod.pk3_halo dyn_core_mod.pln_halo dyn_core_mod.pe
!_halo dyn_core_mod.adv_pe dyn_core_mod.p_grad_c dyn_core_mod.nh_p_grad dyn_core_mod.split_p_grad dyn_core_mod.one_grad_p dyn_cor
!e_mod.grad1_p_update dyn_core_mod.mix_dp dyn_core_mod.geopk dyn_core_mod.del2_cubed fv_dynamics_mod.fv_dynamics fv_dynamics_mod.
!rayleigh_super fv_dynamics_mod.rayleigh_friction fv_dynamics_mod.compute_aam fv_dynamics_mod.geos_to_fv3 fv_grid_utils_mod.cubed
!_to_latlon fv_grid_utils_mod.c2l_ord4 fv_grid_utils_mod.c2l_ord2 fv_mapz_mod.lagrangian_to_eulerian fv_mapz_mod.compute_total_en
!ergy fv_mapz_mod.pkez fv_mapz_mod.remap_z fv_mapz_mod.map_scalar fv_mapz_mod.map1_ppm fv_mapz_mod.mapn_tracer fv_map
!z_mod.map1_q2 fv_mapz_mod.map1_cubic fv_mapz_mod.scalar_profile_linear fv_mapz_mod.cs_profile_linear fv_mapz_mod.steepz
! fv_tracer2d_mod.tracer_2d fv_tracer2d_mod.tracer_2d_nested nh_core_mod.update_dz_c nh_core_mod.update_dz_d nh_core_mod.riem_sol
!ver_c nh_core_mod.riem_solver3 nh_core_mod.rim_2d nh_core_mod.sim3_solver nh_core_mod.sim3p0_solver nh_core_mod.sim1_solver nh_c
!ore_mod.sim_solver nh_core_mod.edge_profile sw_core_mod.c_sw sw_core_mod.d_sw sw_core_mod.divergence_corner sw_core_mod.divergen
!ce_corner_nest sw_core_mod.d2a2c_vect sw_core_mod.edge_interpolate4 sw_core_mod.fill2_4corners sw_core_mod.fill_4corners sw_core
!_mod.compute_div_damping sw_core_mod.smag_corner sw_core_mod.ytp_v sw_core_mod.xtp_u tp_core_mod.fv_tp_2d tp_core
!_mod.copy_corners tp_core_mod.xtp tp_core_mod.ytp tp_core_mod.xppm0 tp_core_mod.yppm0 tp_core_mod.fxppm tp_cor
!e_mod.fyppm tp_core_mod.deln_flux)):
!   gradient     of useful results: xfx q mass mfx mfy ra_x ra_y
!                yfx fx fy crx cry
!   with respect to varying inputs: xfx q mass mfx mfy ra_x ra_y
!                yfx fx fy crx cry
  SUBROUTINE FV_TP_2D_FWD(q, crx, cry, npx, npy, hord, fx, fy, xfx, &
&   yfx, gridstruct, bd, ra_x, ra_y, mfx, mfy, mass, nord, damp_c)
    IMPLICIT NONE
    TYPE(FV_GRID_BOUNDS_TYPE), INTENT(IN) :: bd
    INTEGER, INTENT(IN) :: npx, npy
    INTEGER, INTENT(IN) :: hord
!
    REAL(fvprc), INTENT(IN) :: crx(bd%is:bd%ie+1, bd%jsd:bd%jed)
!
    REAL(fvprc), INTENT(IN) :: xfx(bd%is:bd%ie+1, bd%jsd:bd%jed)
!
    REAL(fvprc), INTENT(IN) :: cry(bd%isd:bd%ied, bd%js:bd%je+1)
!
    REAL(fvprc), INTENT(IN) :: yfx(bd%isd:bd%ied, bd%js:bd%je+1)
    REAL(fvprc), INTENT(IN) :: ra_x(bd%is:bd%ie, bd%jsd:bd%jed)
    REAL(fvprc), INTENT(IN) :: ra_y(bd%isd:bd%ied, bd%js:bd%je)
! transported scalar
    REAL(fvprc), INTENT(INOUT) :: q(bd%isd:bd%ied, bd%jsd:bd%jed)
! Flux in x ( E )
    REAL(fvprc) :: fx(bd%is:bd%ie+1, bd%js:bd%je)
! Flux in y ( N )
    REAL(fvprc) :: fy(bd%is:bd%ie, bd%js:bd%je+1)
    TYPE(FV_GRID_TYPE), INTENT(IN), TARGET :: gridstruct
! optional Arguments:
! Mass Flux X-Dir
    REAL(fvprc), OPTIONAL, INTENT(IN) :: mfx(bd%is:bd%ie+1, bd%js:bd%je)
! Mass Flux Y-Dir
    REAL(fvprc), OPTIONAL, INTENT(IN) :: mfy(bd%is:bd%ie, bd%js:bd%je+1)
    REAL(fvprc), OPTIONAL, INTENT(IN) :: mass(bd%isd:bd%ied, bd%jsd:bd%&
&   jed)
    REAL(fvprc), OPTIONAL, INTENT(IN) :: damp_c
    INTEGER, OPTIONAL, INTENT(IN) :: nord
! Local:
    INTEGER :: ord_ou, ord_in
    REAL(fvprc) :: q_i(bd%isd:bd%ied, bd%js:bd%je)
    REAL(fvprc) :: q_j(bd%is:bd%ie, bd%jsd:bd%jed)
    REAL(fvprc) :: fx2(bd%is:bd%ie+1, bd%jsd:bd%jed)
    REAL(fvprc) :: fy2(bd%isd:bd%ied, bd%js:bd%je+1)
    REAL(fvprc) :: fyy(bd%isd:bd%ied, bd%js:bd%je+1)
    REAL(fvprc) :: fx1(bd%is:bd%ie+1)
    REAL(fvprc) :: damp
    INTEGER :: i, j
    INTEGER :: is, ie, js, je, isd, ied, jsd, jed
    INTRINSIC PRESENT
!   real(FVPRC), pointer, dimension(:,:) :: area, rarea
!! Initalize pointers
!   area    => gridstruct%area  
!   rarea   => gridstruct%rarea 
    ord_in = hord
    ord_ou = hord
    IF (.NOT.gridstruct%nested) THEN
      CALL COPY_CORNERS_FWD(q, npx, npy, 2, gridstruct%nested, bd, &
&                        gridstruct%sw_corner, gridstruct%se_corner, &
&                        gridstruct%nw_corner, gridstruct%ne_corner)
      CALL PUSHCONTROL1B_FV(0)
    ELSE
      CALL PUSHCONTROL1B_FV(1)
    END IF
    IF (ord_in .LT. 0) THEN
      CALL YPPM0_FWD(fy2, q, cry, ord_in, bd%isd, bd%ied, bd%js, bd%&
&                 je, npx, npy, bd, gridstruct%dya, gridstruct%nested, &
&                 gridstruct%grid_type)
      CALL PUSHCONTROL1B_FV(1)
    ELSE
      CALL YTP_FWD(fy2, q, cry, ord_in, bd%isd, bd%ied, bd%js, bd%je&
&               , npx, npy, bd, gridstruct%dya, gridstruct%nested, &
&               gridstruct%grid_type)
      CALL PUSHCONTROL1B_FV(0)
    END IF
    DO j=bd%js,bd%je+1
      DO i=bd%isd,bd%ied
        fyy(i, j) = yfx(i, j)*fy2(i, j)
      END DO
    END DO
    DO j=bd%js,bd%je
      DO i=bd%isd,bd%ied
        q_i(i, j) = (q(i, j)*gridstruct%area(i, j)+fyy(i, j)-fyy(i, j+1)&
&         )/ra_y(i, j)
      END DO
    END DO
    IF (ord_ou .LT. 0) THEN
      CALL XPPM0_FWD(fx, q_i, crx(bd%is:bd%ie+1, bd%js:bd%je), ord_ou&
&                 , bd%is, bd%ie, bd%js, bd%je, npx, npy, bd, gridstruct&
&                 %dxa, gridstruct%nested, gridstruct%grid_type)
      CALL PUSHCONTROL1B_FV(0)
    ELSE
      CALL XTP_FWD(fx, q_i, crx(bd%is:bd%ie+1, bd%js:bd%je), ord_ou, &
&               bd%is, bd%ie, bd%js, bd%je, npx, npy, bd, gridstruct%dxa&
&               , gridstruct%nested, gridstruct%grid_type)
      CALL PUSHCONTROL1B_FV(1)
    END IF
    IF (.NOT.gridstruct%nested) THEN
      CALL COPY_CORNERS_FWD(q, npx, npy, 1, gridstruct%nested, bd, &
&                        gridstruct%sw_corner, gridstruct%se_corner, &
&                        gridstruct%nw_corner, gridstruct%ne_corner)
      CALL PUSHCONTROL1B_FV(0)
    ELSE
      CALL PUSHCONTROL1B_FV(1)
    END IF
    IF (ord_in .LT. 0) THEN
      CALL XPPM0_FWD(fx2, q, crx, ord_in, bd%is, bd%ie, bd%jsd, bd%&
&                 jed, npx, npy, bd, gridstruct%dxa, gridstruct%nested, &
&                 gridstruct%grid_type)
      CALL PUSHCONTROL1B_FV(1)
    ELSE
      CALL XTP_FWD(fx2, q, crx, ord_in, bd%is, bd%ie, bd%jsd, bd%jed&
&               , npx, npy, bd, gridstruct%dxa, gridstruct%nested, &
&               gridstruct%grid_type)
      CALL PUSHCONTROL1B_FV(0)
    END IF
    CALL PUSHREALARRAY(fx1, 8*(bd%ie-bd%is+2)/8)
    CALL PUSHREALARRAY(fx2, 8*(bd%ie-bd%is+2)*(bd%jed-bd%jsd+1)/8)
    DO j=bd%jsd,bd%jed
      DO i=bd%is,bd%ie+1
        fx1(i) = xfx(i, j)*fx2(i, j)
      END DO
      DO i=bd%is,bd%ie
        q_j(i, j) = (q(i, j)*gridstruct%area(i, j)+fx1(i)-fx1(i+1))/ra_x&
&         (i, j)
      END DO
    END DO
    IF (ord_ou .LT. 0) THEN
      CALL YPPM0_FWD(fy, q_j, cry, ord_ou, bd%is, bd%ie, bd%js, bd%je&
&                 , npx, npy, bd, gridstruct%dya, gridstruct%nested, &
&                 gridstruct%grid_type)
      CALL PUSHCONTROL1B_FV(0)
    ELSE
      CALL YTP_FWD(fy, q_j, cry, ord_ou, bd%is, bd%ie, bd%js, bd%je, &
&               npx, npy, bd, gridstruct%dya, gridstruct%nested, &
&               gridstruct%grid_type)
      CALL PUSHCONTROL1B_FV(1)
    END IF
!----------------
! Flux averaging:
!----------------
    IF (PRESENT(mfx) .AND. PRESENT(mfy)) THEN
      CALL PUSHREALARRAY(fx, 8*(bd%ie-bd%is+2)*(bd%je-bd%js+1)/8)
!---------------------------------
! For transport of pt and tracers
!---------------------------------
      DO j=bd%js,bd%je
        DO i=bd%is,bd%ie+1
          fx(i, j) = 0.5*(fx(i, j)+fx2(i, j))*mfx(i, j)
        END DO
      END DO
      CALL PUSHREALARRAY(fy, 8*(bd%ie-bd%is+1)*(bd%je-bd%js+2)/8)
      DO j=bd%js,bd%je+1
        DO i=bd%is,bd%ie
          fy(i, j) = 0.5*(fy(i, j)+fy2(i, j))*mfy(i, j)
        END DO
      END DO
      IF (PRESENT(nord) .AND. PRESENT(damp_c) .AND. PRESENT(mass)) THEN
        IF (damp_c .GT. 1.e-4) THEN
          damp = (damp_c*gridstruct%da_min)**(nord+1)
          CALL DELN_FLUX_FWD(nord, npx, npy, damp, q, fx, fy, &
&                         gridstruct, bd, mass)
          CALL PUSHREALARRAY(fy2, 8*(bd%ied-bd%isd+1)*(bd%je-bd%js+&
&                       2)/8)
          CALL PUSHREALARRAY(q_i, 8*(bd%ied-bd%isd+1)*(bd%je-bd%js+&
&                       1)/8)
          CALL PUSHREALARRAY(q_j, 8*(bd%ie-bd%is+1)*(bd%jed-bd%jsd+&
&                       1)/8)
          CALL PUSHREALARRAY(fx1, 8*(bd%ie-bd%is+2)/8)
          CALL PUSHREALARRAY(fx2, 8*(bd%ie-bd%is+2)*(bd%jed-bd%jsd+&
&                       1)/8)
          CALL PUSHREALARRAY(fyy, 8*(bd%ied-bd%isd+1)*(bd%je-bd%js+&
&                       2)/8)
          CALL PUSHCONTROL3B_FV(2)
        ELSE
          CALL PUSHREALARRAY(fy2, 8*(bd%ied-bd%isd+1)*(bd%je-bd%js+&
&                       2)/8)
          CALL PUSHREALARRAY(q_i, 8*(bd%ied-bd%isd+1)*(bd%je-bd%js+&
&                       1)/8)
          CALL PUSHREALARRAY(q_j, 8*(bd%ie-bd%is+1)*(bd%jed-bd%jsd+&
&                       1)/8)
          CALL PUSHREALARRAY(fx1, 8*(bd%ie-bd%is+2)/8)
          CALL PUSHREALARRAY(fx2, 8*(bd%ie-bd%is+2)*(bd%jed-bd%jsd+&
&                       1)/8)
          CALL PUSHREALARRAY(fyy, 8*(bd%ied-bd%isd+1)*(bd%je-bd%js+&
&                       2)/8)
          CALL PUSHCONTROL3B_FV(1)
        END IF
      ELSE
        CALL PUSHREALARRAY(fy2, 8*(bd%ied-bd%isd+1)*(bd%je-bd%js+2)&
&                     /8)
        CALL PUSHREALARRAY(q_i, 8*(bd%ied-bd%isd+1)*(bd%je-bd%js+1)&
&                     /8)
        CALL PUSHREALARRAY(q_j, 8*(bd%ie-bd%is+1)*(bd%jed-bd%jsd+1)&
&                     /8)
        CALL PUSHREALARRAY(fx1, 8*(bd%ie-bd%is+2)/8)
        CALL PUSHREALARRAY(fx2, 8*(bd%ie-bd%is+2)*(bd%jed-bd%jsd+1)&
&                     /8)
        CALL PUSHREALARRAY(fyy, 8*(bd%ied-bd%isd+1)*(bd%je-bd%js+2)&
&                     /8)
        CALL PUSHCONTROL3B_FV(0)
      END IF
    ELSE
      CALL PUSHREALARRAY(fx, 8*(bd%ie-bd%is+2)*(bd%je-bd%js+1)/8)
!---------------------------------
! For transport of delp, vorticity
!---------------------------------
      DO j=bd%js,bd%je
        DO i=bd%is,bd%ie+1
          fx(i, j) = 0.5*(fx(i, j)+fx2(i, j))*xfx(i, j)
        END DO
      END DO
      CALL PUSHREALARRAY(fy, 8*(bd%ie-bd%is+1)*(bd%je-bd%js+2)/8)
      DO j=bd%js,bd%je+1
        DO i=bd%is,bd%ie
          fy(i, j) = 0.5*(fy(i, j)+fy2(i, j))*yfx(i, j)
        END DO
      END DO
      IF (PRESENT(nord) .AND. PRESENT(damp_c)) THEN
        IF (damp_c .GT. 1.e-4) THEN
          damp = (damp_c*gridstruct%da_min)**(nord+1)
          CALL DELN_FLUX_FWD(nord, npx, npy, damp, q, fx, fy, &
&                         gridstruct, bd)
          CALL PUSHREALARRAY(fy2, 8*(bd%ied-bd%isd+1)*(bd%je-bd%js+&
&                       2)/8)
          CALL PUSHREALARRAY(q_i, 8*(bd%ied-bd%isd+1)*(bd%je-bd%js+&
&                       1)/8)
          CALL PUSHREALARRAY(q_j, 8*(bd%ie-bd%is+1)*(bd%jed-bd%jsd+&
&                       1)/8)
          CALL PUSHREALARRAY(fx1, 8*(bd%ie-bd%is+2)/8)
          CALL PUSHREALARRAY(fx2, 8*(bd%ie-bd%is+2)*(bd%jed-bd%jsd+&
&                       1)/8)
          CALL PUSHREALARRAY(fyy, 8*(bd%ied-bd%isd+1)*(bd%je-bd%js+&
&                       2)/8)
          CALL PUSHCONTROL3B_FV(5)
        ELSE
          CALL PUSHREALARRAY(fy2, 8*(bd%ied-bd%isd+1)*(bd%je-bd%js+&
&                       2)/8)
          CALL PUSHREALARRAY(q_i, 8*(bd%ied-bd%isd+1)*(bd%je-bd%js+&
&                       1)/8)
          CALL PUSHREALARRAY(q_j, 8*(bd%ie-bd%is+1)*(bd%jed-bd%jsd+&
&                       1)/8)
          CALL PUSHREALARRAY(fx1, 8*(bd%ie-bd%is+2)/8)
          CALL PUSHREALARRAY(fx2, 8*(bd%ie-bd%is+2)*(bd%jed-bd%jsd+&
&                       1)/8)
          CALL PUSHREALARRAY(fyy, 8*(bd%ied-bd%isd+1)*(bd%je-bd%js+&
&                       2)/8)
          CALL PUSHCONTROL3B_FV(4)
        END IF
      ELSE
        CALL PUSHREALARRAY(fy2, 8*(bd%ied-bd%isd+1)*(bd%je-bd%js+2)&
&                     /8)
        CALL PUSHREALARRAY(q_i, 8*(bd%ied-bd%isd+1)*(bd%je-bd%js+1)&
&                     /8)
        CALL PUSHREALARRAY(q_j, 8*(bd%ie-bd%is+1)*(bd%jed-bd%jsd+1)&
&                     /8)
        CALL PUSHREALARRAY(fx1, 8*(bd%ie-bd%is+2)/8)
        CALL PUSHREALARRAY(fx2, 8*(bd%ie-bd%is+2)*(bd%jed-bd%jsd+1)&
&                     /8)
        CALL PUSHREALARRAY(fyy, 8*(bd%ied-bd%isd+1)*(bd%je-bd%js+2)&
&                     /8)
        CALL PUSHCONTROL3B_FV(3)
      END IF
    END IF
  END SUBROUTINE FV_TP_2D_FWD
!  Differentiation of fv_tp_2d in reverse (adjoint) mode, backward sweep (with options r8 split(a2b_edge_mod.a2b_ord2 a2b_edge
!_mod.a2b_ord4 a2b_edge_mod.extrap_corner  dyn_core_mod.dyn_core dyn_core_mod.pk3_halo dyn_core_mod.pln_halo dyn_core_mod.p
!e_halo dyn_core_mod.adv_pe dyn_core_mod.p_grad_c dyn_core_mod.nh_p_grad dyn_core_mod.split_p_grad dyn_core_mod.one_grad_p dyn_co
!re_mod.grad1_p_update dyn_core_mod.mix_dp dyn_core_mod.geopk dyn_core_mod.del2_cubed fv_dynamics_mod.fv_dynamics fv_dynamics_mod
!.rayleigh_super fv_dynamics_mod.rayleigh_friction fv_dynamics_mod.compute_aam fv_dynamics_mod.geos_to_fv3 fv_grid_utils_mod.cube
!d_to_latlon fv_grid_utils_mod.c2l_ord4 fv_grid_utils_mod.c2l_ord2 fv_mapz_mod.lagrangian_to_eulerian fv_mapz_mod.compute_total_e
!nergy fv_mapz_mod.pkez fv_mapz_mod.remap_z fv_mapz_mod.map_scalar fv_mapz_mod.map1_ppm fv_mapz_mod.mapn_tracer fv_ma
!pz_mod.map1_q2 fv_mapz_mod.map1_cubic fv_mapz_mod.scalar_profile_linear fv_mapz_mod.cs_profile_linear fv_mapz_mod.steep
!z fv_tracer2d_mod.tracer_2d fv_tracer2d_mod.tracer_2d_nested nh_core_mod.update_dz_c nh_core_mod.update_dz_d nh_core_mod.riem_so
!lver_c nh_core_mod.riem_solver3 nh_core_mod.rim_2d nh_core_mod.sim3_solver nh_core_mod.sim3p0_solver nh_core_mod.sim1_solver nh_
!core_mod.sim_solver nh_core_mod.edge_profile sw_core_mod.c_sw sw_core_mod.d_sw sw_core_mod.divergence_corner sw_core_mod.diverge
!nce_corner_nest sw_core_mod.d2a2c_vect sw_core_mod.edge_interpolate4 sw_core_mod.fill2_4corners sw_core_mod.fill_4corners sw_cor
!e_mod.compute_div_damping sw_core_mod.smag_corner sw_core_mod.ytp_v sw_core_mod.xtp_u tp_core_mod.fv_tp_2d tp_cor
!e_mod.copy_corners tp_core_mod.xtp tp_core_mod.ytp tp_core_mod.xppm0 tp_core_mod.yppm0 tp_core_mod.fxppm tp_co
!re_mod.fyppm tp_core_mod.deln_flux)):
!   gradient     of useful results: xfx q mass mfx mfy ra_x ra_y
!                yfx fx fy crx cry
!   with respect to varying inputs: xfx q mass mfx mfy ra_x ra_y
!                yfx fx fy crx cry
  SUBROUTINE FV_TP_2D_BWD(q, q_ad, crx, crx_ad, cry, cry_ad, npx, npy&
&   , hord, fx, fx_ad, fy, fy_ad, xfx, xfx_ad, yfx, yfx_ad, gridstruct, &
&   bd, ra_x, ra_x_ad, ra_y, ra_y_ad, mfx, mfx_ad, mfy, mfy_ad, mass, &
&   mass_ad, nord, damp_c)
    IMPLICIT NONE
    TYPE(FV_GRID_BOUNDS_TYPE), INTENT(IN) :: bd
    INTEGER, INTENT(IN) :: npx, npy
    INTEGER, INTENT(IN) :: hord
    REAL(fvprc), INTENT(IN) :: crx(bd%is:bd%ie+1, bd%jsd:bd%jed)
    REAL(fvprc) :: crx_ad(bd%is:bd%ie+1, bd%jsd:bd%jed)
    REAL(fvprc), INTENT(IN) :: xfx(bd%is:bd%ie+1, bd%jsd:bd%jed)
    REAL(fvprc) :: xfx_ad(bd%is:bd%ie+1, bd%jsd:bd%jed)
    REAL(fvprc), INTENT(IN) :: cry(bd%isd:bd%ied, bd%js:bd%je+1)
    REAL(fvprc) :: cry_ad(bd%isd:bd%ied, bd%js:bd%je+1)
    REAL(fvprc), INTENT(IN) :: yfx(bd%isd:bd%ied, bd%js:bd%je+1)
    REAL(fvprc) :: yfx_ad(bd%isd:bd%ied, bd%js:bd%je+1)
    REAL(fvprc), INTENT(IN) :: ra_x(bd%is:bd%ie, bd%jsd:bd%jed)
    REAL(fvprc) :: ra_x_ad(bd%is:bd%ie, bd%jsd:bd%jed)
    REAL(fvprc), INTENT(IN) :: ra_y(bd%isd:bd%ied, bd%js:bd%je)
    REAL(fvprc) :: ra_y_ad(bd%isd:bd%ied, bd%js:bd%je)
    REAL(fvprc), INTENT(INOUT) :: q(bd%isd:bd%ied, bd%jsd:bd%jed)
    REAL(fvprc), INTENT(INOUT) :: q_ad(bd%isd:bd%ied, bd%jsd:bd%jed)
    REAL(fvprc) :: fx(bd%is:bd%ie+1, bd%js:bd%je)
    REAL(fvprc) :: fx_ad(bd%is:bd%ie+1, bd%js:bd%je)
    REAL(fvprc) :: fy(bd%is:bd%ie, bd%js:bd%je+1)
    REAL(fvprc) :: fy_ad(bd%is:bd%ie, bd%js:bd%je+1)
    TYPE(FV_GRID_TYPE), INTENT(IN), TARGET :: gridstruct
    REAL(fvprc), OPTIONAL, INTENT(IN) :: mfx(bd%is:bd%ie+1, bd%js:bd%je)
    REAL(fvprc), OPTIONAL :: mfx_ad(bd%is:bd%ie+1, bd%js:bd%je)
    REAL(fvprc), OPTIONAL, INTENT(IN) :: mfy(bd%is:bd%ie, bd%js:bd%je+1)
    REAL(fvprc), OPTIONAL :: mfy_ad(bd%is:bd%ie, bd%js:bd%je+1)
    REAL(fvprc), OPTIONAL, INTENT(IN) :: mass(bd%isd:bd%ied, bd%jsd:bd%&
&   jed)
    REAL(fvprc), OPTIONAL :: mass_ad(bd%isd:bd%ied, bd%jsd:bd%jed)
    REAL(fvprc), OPTIONAL, INTENT(IN) :: damp_c
    INTEGER, OPTIONAL, INTENT(IN) :: nord
    INTEGER :: ord_ou, ord_in
    REAL(fvprc) :: q_i(bd%isd:bd%ied, bd%js:bd%je)
    REAL(fvprc) :: q_i_ad(bd%isd:bd%ied, bd%js:bd%je)
    REAL(fvprc) :: q_j(bd%is:bd%ie, bd%jsd:bd%jed)
    REAL(fvprc) :: q_j_ad(bd%is:bd%ie, bd%jsd:bd%jed)
    REAL(fvprc) :: fx2(bd%is:bd%ie+1, bd%jsd:bd%jed)
    REAL(fvprc) :: fx2_ad(bd%is:bd%ie+1, bd%jsd:bd%jed)
    REAL(fvprc) :: fy2(bd%isd:bd%ied, bd%js:bd%je+1)
    REAL(fvprc) :: fy2_ad(bd%isd:bd%ied, bd%js:bd%je+1)
    REAL(fvprc) :: fyy(bd%isd:bd%ied, bd%js:bd%je+1)
    REAL(fvprc) :: fyy_ad(bd%isd:bd%ied, bd%js:bd%je+1)
    REAL(fvprc) :: fx1(bd%is:bd%ie+1)
    REAL(fvprc) :: fx1_ad(bd%is:bd%ie+1)
    REAL(fvprc) :: damp
    INTEGER :: i, j
    INTEGER :: is, ie, js, je, isd, ied, jsd, jed
    INTRINSIC PRESENT
    REAL(fvprc) :: temp_ad
    REAL(fvprc) :: temp_ad0
    REAL(fvprc) :: temp_ad1
    REAL(fvprc) :: temp_ad2
    REAL(fvprc) :: temp_ad3
    REAL(fvprc) :: temp_ad4
    INTEGER :: branch
    CALL POPCONTROL3B_FV(branch)
    IF (branch .LT. 3) THEN
      IF (branch .EQ. 0) THEN
        CALL POPREALARRAY(fyy, 8*(bd%ied-bd%isd+1)*(bd%je-bd%js+2)/&
&                    8)
        CALL POPREALARRAY(fx2, 8*(bd%ie-bd%is+2)*(bd%jed-bd%jsd+1)/&
&                    8)
        CALL POPREALARRAY(fx1, 8*(bd%ie-bd%is+2)/8)
        CALL POPREALARRAY(q_j, 8*(bd%ie-bd%is+1)*(bd%jed-bd%jsd+1)/&
&                    8)
        CALL POPREALARRAY(q_i, 8*(bd%ied-bd%isd+1)*(bd%je-bd%js+1)/&
&                    8)
        CALL POPREALARRAY(fy2, 8*(bd%ied-bd%isd+1)*(bd%je-bd%js+2)/&
&                    8)
      ELSE IF (branch .EQ. 1) THEN
        CALL POPREALARRAY(fyy, 8*(bd%ied-bd%isd+1)*(bd%je-bd%js+2)/&
&                    8)
        CALL POPREALARRAY(fx2, 8*(bd%ie-bd%is+2)*(bd%jed-bd%jsd+1)/&
&                    8)
        CALL POPREALARRAY(fx1, 8*(bd%ie-bd%is+2)/8)
        CALL POPREALARRAY(q_j, 8*(bd%ie-bd%is+1)*(bd%jed-bd%jsd+1)/&
&                    8)
        CALL POPREALARRAY(q_i, 8*(bd%ied-bd%isd+1)*(bd%je-bd%js+1)/&
&                    8)
        CALL POPREALARRAY(fy2, 8*(bd%ied-bd%isd+1)*(bd%je-bd%js+2)/&
&                    8)
      ELSE
        CALL POPREALARRAY(fyy, 8*(bd%ied-bd%isd+1)*(bd%je-bd%js+2)/&
&                    8)
        CALL POPREALARRAY(fx2, 8*(bd%ie-bd%is+2)*(bd%jed-bd%jsd+1)/&
&                    8)
        CALL POPREALARRAY(fx1, 8*(bd%ie-bd%is+2)/8)
        CALL POPREALARRAY(q_j, 8*(bd%ie-bd%is+1)*(bd%jed-bd%jsd+1)/&
&                    8)
        CALL POPREALARRAY(q_i, 8*(bd%ied-bd%isd+1)*(bd%je-bd%js+1)/&
&                    8)
        CALL POPREALARRAY(fy2, 8*(bd%ied-bd%isd+1)*(bd%je-bd%js+2)/&
&                    8)
        damp = (damp_c*gridstruct%da_min)**(nord+1)
        CALL DELN_FLUX_BWD(nord, npx, npy, damp, q, q_ad, fx, fx_ad, &
&                       fy, fy_ad, gridstruct, bd, mass, mass_ad)
      END IF
      fy2_ad = 0.0_FVPRC
      CALL POPREALARRAY(fy, 8*(bd%ie-bd%is+1)*(bd%je-bd%js+2)/8)
      DO j=bd%js,bd%je+1
        DO i=bd%ie,bd%is,-1
          temp_ad2 = 0.5*mfy(i, j)*fy_ad(i, j)
          fy2_ad(i, j) = fy2_ad(i, j) + temp_ad2
          mfy_ad(i, j) = mfy_ad(i, j) + 0.5*(fy(i, j)+fy2(i, j))*fy_ad(i&
&           , j)
          fy_ad(i, j) = temp_ad2
        END DO
      END DO
      fx2_ad = 0.0_FVPRC
      CALL POPREALARRAY(fx, 8*(bd%ie-bd%is+2)*(bd%je-bd%js+1)/8)
      DO j=bd%js,bd%je
        DO i=bd%ie+1,bd%is,-1
          temp_ad1 = 0.5*mfx(i, j)*fx_ad(i, j)
          fx2_ad(i, j) = fx2_ad(i, j) + temp_ad1
          mfx_ad(i, j) = mfx_ad(i, j) + 0.5*(fx(i, j)+fx2(i, j))*fx_ad(i&
&           , j)
          fx_ad(i, j) = temp_ad1
        END DO
      END DO
    ELSE
      IF (branch .EQ. 3) THEN
        CALL POPREALARRAY(fyy, 8*(bd%ied-bd%isd+1)*(bd%je-bd%js+2)/&
&                    8)
        CALL POPREALARRAY(fx2, 8*(bd%ie-bd%is+2)*(bd%jed-bd%jsd+1)/&
&                    8)
        CALL POPREALARRAY(fx1, 8*(bd%ie-bd%is+2)/8)
        CALL POPREALARRAY(q_j, 8*(bd%ie-bd%is+1)*(bd%jed-bd%jsd+1)/&
&                    8)
        CALL POPREALARRAY(q_i, 8*(bd%ied-bd%isd+1)*(bd%je-bd%js+1)/&
&                    8)
        CALL POPREALARRAY(fy2, 8*(bd%ied-bd%isd+1)*(bd%je-bd%js+2)/&
&                    8)
      ELSE IF (branch .EQ. 4) THEN
        CALL POPREALARRAY(fyy, 8*(bd%ied-bd%isd+1)*(bd%je-bd%js+2)/&
&                    8)
        CALL POPREALARRAY(fx2, 8*(bd%ie-bd%is+2)*(bd%jed-bd%jsd+1)/&
&                    8)
        CALL POPREALARRAY(fx1, 8*(bd%ie-bd%is+2)/8)
        CALL POPREALARRAY(q_j, 8*(bd%ie-bd%is+1)*(bd%jed-bd%jsd+1)/&
&                    8)
        CALL POPREALARRAY(q_i, 8*(bd%ied-bd%isd+1)*(bd%je-bd%js+1)/&
&                    8)
        CALL POPREALARRAY(fy2, 8*(bd%ied-bd%isd+1)*(bd%je-bd%js+2)/&
&                    8)
      ELSE
        CALL POPREALARRAY(fyy, 8*(bd%ied-bd%isd+1)*(bd%je-bd%js+2)/&
&                    8)
        CALL POPREALARRAY(fx2, 8*(bd%ie-bd%is+2)*(bd%jed-bd%jsd+1)/&
&                    8)
        CALL POPREALARRAY(fx1, 8*(bd%ie-bd%is+2)/8)
        CALL POPREALARRAY(q_j, 8*(bd%ie-bd%is+1)*(bd%jed-bd%jsd+1)/&
&                    8)
        CALL POPREALARRAY(q_i, 8*(bd%ied-bd%isd+1)*(bd%je-bd%js+1)/&
&                    8)
        CALL POPREALARRAY(fy2, 8*(bd%ied-bd%isd+1)*(bd%je-bd%js+2)/&
&                    8)
        damp = (damp_c*gridstruct%da_min)**(nord+1)
        CALL DELN_FLUX_BWD(nord, npx, npy, damp, q, q_ad, fx, fx_ad, &
&                       fy, fy_ad, gridstruct, bd)
      END IF
      fy2_ad = 0.0_FVPRC
      CALL POPREALARRAY(fy, 8*(bd%ie-bd%is+1)*(bd%je-bd%js+2)/8)
      DO j=bd%js,bd%je+1
        DO i=bd%ie,bd%is,-1
          temp_ad4 = 0.5*yfx(i, j)*fy_ad(i, j)
          fy2_ad(i, j) = fy2_ad(i, j) + temp_ad4
          yfx_ad(i, j) = yfx_ad(i, j) + 0.5*(fy(i, j)+fy2(i, j))*fy_ad(i&
&           , j)
          fy_ad(i, j) = temp_ad4
        END DO
      END DO
      fx2_ad = 0.0_FVPRC
      CALL POPREALARRAY(fx, 8*(bd%ie-bd%is+2)*(bd%je-bd%js+1)/8)
      DO j=bd%js,bd%je
        DO i=bd%ie+1,bd%is,-1
          temp_ad3 = 0.5*xfx(i, j)*fx_ad(i, j)
          fx2_ad(i, j) = fx2_ad(i, j) + temp_ad3
          xfx_ad(i, j) = xfx_ad(i, j) + 0.5*(fx(i, j)+fx2(i, j))*fx_ad(i&
&           , j)
          fx_ad(i, j) = temp_ad3
        END DO
      END DO
    END IF
    CALL POPCONTROL1B_FV(branch)
    IF (branch .EQ. 0) THEN
      q_j_ad = 0.0_FVPRC
      CALL YPPM0_BWD(fy, fy_ad, q_j, q_j_ad, cry, cry_ad, ord_ou, bd%&
&                 is, bd%ie, bd%js, bd%je, npx, npy, bd, gridstruct%dya&
&                 , gridstruct%nested, gridstruct%grid_type)
    ELSE
      q_j_ad = 0.0_FVPRC
      CALL YTP_BWD(fy, fy_ad, q_j, q_j_ad, cry, cry_ad, ord_ou, bd%is&
&               , bd%ie, bd%js, bd%je, npx, npy, bd, gridstruct%dya, &
&               gridstruct%nested, gridstruct%grid_type)
    END IF
    fx1_ad = 0.0_FVPRC
    CALL POPREALARRAY(fx2, 8*(bd%ie-bd%is+2)*(bd%jed-bd%jsd+1)/8)
    CALL POPREALARRAY(fx1, 8*(bd%ie-bd%is+2)/8)
    DO j=bd%jsd,bd%jed
      DO i=bd%is,bd%ie+1
        fx1(i) = xfx(i, j)*fx2(i, j)
      END DO
      DO i=bd%ie,bd%is,-1
        temp_ad0 = q_j_ad(i, j)/ra_x(i, j)
        q_ad(i, j) = q_ad(i, j) + gridstruct%area(i, j)*temp_ad0
        fx1_ad(i) = fx1_ad(i) + temp_ad0
        fx1_ad(i+1) = fx1_ad(i+1) - temp_ad0
        ra_x_ad(i, j) = ra_x_ad(i, j) - (gridstruct%area(i, j)*q(i, j)+&
&         fx1(i)-fx1(i+1))*temp_ad0/ra_x(i, j)
        q_j_ad(i, j) = 0.0_FVPRC
      END DO
      DO i=bd%ie+1,bd%is,-1
        xfx_ad(i, j) = xfx_ad(i, j) + fx2(i, j)*fx1_ad(i)
        fx2_ad(i, j) = fx2_ad(i, j) + xfx(i, j)*fx1_ad(i)
        fx1_ad(i) = 0.0_FVPRC
      END DO
    END DO
    CALL POPCONTROL1B_FV(branch)
    IF (branch .EQ. 0) THEN
      CALL XTP_BWD(fx2, fx2_ad, q, q_ad, crx, crx_ad, ord_in, bd%is, &
&               bd%ie, bd%jsd, bd%jed, npx, npy, bd, gridstruct%dxa, &
&               gridstruct%nested, gridstruct%grid_type)
    ELSE
      CALL XPPM0_BWD(fx2, fx2_ad, q, q_ad, crx, crx_ad, ord_in, bd%is&
&                 , bd%ie, bd%jsd, bd%jed, npx, npy, bd, gridstruct%dxa&
&                 , gridstruct%nested, gridstruct%grid_type)
    END IF
    CALL POPCONTROL1B_FV(branch)
    IF (branch .EQ. 0) CALL COPY_CORNERS_BWD(q, q_ad, npx, npy, 1, &
&                                         gridstruct%nested, bd, &
&                                         gridstruct%sw_corner, &
&                                         gridstruct%se_corner, &
&                                         gridstruct%nw_corner, &
&                                         gridstruct%ne_corner)
    CALL POPCONTROL1B_FV(branch)
    IF (branch .EQ. 0) THEN
      q_i_ad = 0.0_FVPRC
      CALL XPPM0_BWD(fx, fx_ad, q_i, q_i_ad, crx(bd%is:bd%ie+1, bd%js&
&                 :bd%je), crx_ad(bd%is:bd%ie+1, bd%js:bd%je), ord_ou, &
&                 bd%is, bd%ie, bd%js, bd%je, npx, npy, bd, gridstruct%&
&                 dxa, gridstruct%nested, gridstruct%grid_type)
    ELSE
      q_i_ad = 0.0_FVPRC
      CALL XTP_BWD(fx, fx_ad, q_i, q_i_ad, crx(bd%is:bd%ie+1, bd%js:&
&               bd%je), crx_ad(bd%is:bd%ie+1, bd%js:bd%je), ord_ou, bd%&
&               is, bd%ie, bd%js, bd%je, npx, npy, bd, gridstruct%dxa, &
&               gridstruct%nested, gridstruct%grid_type)
    END IF
    fyy_ad = 0.0_FVPRC
    DO j=bd%je,bd%js,-1
      DO i=bd%ied,bd%isd,-1
        temp_ad = q_i_ad(i, j)/ra_y(i, j)
        q_ad(i, j) = q_ad(i, j) + gridstruct%area(i, j)*temp_ad
        fyy_ad(i, j) = fyy_ad(i, j) + temp_ad
        fyy_ad(i, j+1) = fyy_ad(i, j+1) - temp_ad
        ra_y_ad(i, j) = ra_y_ad(i, j) - (gridstruct%area(i, j)*q(i, j)+&
&         fyy(i, j)-fyy(i, j+1))*temp_ad/ra_y(i, j)
        q_i_ad(i, j) = 0.0_FVPRC
      END DO
    END DO
    DO j=bd%je+1,bd%js,-1
      DO i=bd%ied,bd%isd,-1
        yfx_ad(i, j) = yfx_ad(i, j) + fy2(i, j)*fyy_ad(i, j)
        fy2_ad(i, j) = fy2_ad(i, j) + yfx(i, j)*fyy_ad(i, j)
        fyy_ad(i, j) = 0.0_FVPRC
      END DO
    END DO
    CALL POPCONTROL1B_FV(branch)
    IF (branch .EQ. 0) THEN
      CALL YTP_BWD(fy2, fy2_ad, q, q_ad, cry, cry_ad, ord_in, bd%isd&
&               , bd%ied, bd%js, bd%je, npx, npy, bd, gridstruct%dya, &
&               gridstruct%nested, gridstruct%grid_type)
    ELSE
      CALL YPPM0_BWD(fy2, fy2_ad, q, q_ad, cry, cry_ad, ord_in, bd%&
&                 isd, bd%ied, bd%js, bd%je, npx, npy, bd, gridstruct%&
&                 dya, gridstruct%nested, gridstruct%grid_type)
    END IF
    CALL POPCONTROL1B_FV(branch)
    IF (branch .EQ. 0) CALL COPY_CORNERS_BWD(q, q_ad, npx, npy, 2, &
&                                         gridstruct%nested, bd, &
&                                         gridstruct%sw_corner, &
&                                         gridstruct%se_corner, &
&                                         gridstruct%nw_corner, &
&                                         gridstruct%ne_corner)
  END SUBROUTINE FV_TP_2D_BWD
!  Differentiation of xtp in reverse (adjoint) mode, forward sweep (with options r8 split(a2b_edge_mod.a2b_ord2 a2b_edge_mod.a
!2b_ord4_fb a2b_edge_mod.extrap_corner  dyn_core_mod.dyn_core dyn_core_mod.pk3_halo dyn_core_mod.pln_halo dyn_core_mod.pe_halo
! dyn_core_mod.adv_pe dyn_core_mod.p_grad_c dyn_core_mod.nh_p_grad dyn_core_mod.split_p_grad dyn_core_mod.one_grad_p dyn_core_mod
!.grad1_p_update dyn_core_mod.mix_dp dyn_core_mod.geopk dyn_core_mod.del2_cubed fv_dynamics_mod.fv_dynamics fv_dynamics_mod.rayle
!igh_super fv_dynamics_mod.rayleigh_friction fv_dynamics_mod.compute_aam fv_dynamics_mod.geos_to_fv3 fv_grid_utils_mod.cubed_to_l
!atlon fv_grid_utils_mod.c2l_ord4 fv_grid_utils_mod.c2l_ord2 fv_mapz_mod.lagrangian_to_eulerian fv_mapz_mod.compute_total_energy 
!fv_mapz_mod.pkez fv_mapz_mod.remap_z fv_mapz_mod.map_scalar fv_mapz_mod.map1_ppm fv_mapz_mod.mapn_tracer fv_mapz_mod
!.map1_q2 fv_mapz_mod.map1_cubic fv_mapz_mod.scalar_profile_linear fv_mapz_mod.cs_profile_linear fv_mapz_mod.steepz fv_t
!racer2d_mod.tracer_2d fv_tracer2d_mod.tracer_2d_nested nh_core_mod.update_dz_c nh_core_mod.update_dz_d nh_core_mod.riem_solver_c
! nh_core_mod.riem_solver3 nh_core_mod.rim_2d nh_core_mod.sim3_solver nh_core_mod.sim3p0_solver nh_core_mod.sim1_solver nh_core_m
!od.sim_solver nh_core_mod.edge_profile sw_core_mod.c_sw sw_core_mod.d_sw sw_core_mod.divergence_corner sw_core_mod.divergence_co
!rner_nest sw_core_mod.d2a2c_vect sw_core_mod.edge_interpolate4 sw_core_mod.fill2_4corners sw_core_mod.fill_4corners sw_core_mod.
!compute_div_damping sw_core_mod.smag_corner sw_core_mod.ytp_v sw_core_mod.xtp_u tp_core_mod.fv_tp_2d tp_core_mod.
!copy_corners tp_core_mod.xtp tp_core_mod.ytp tp_core_mod.xppm0 tp_core_mod.yppm0 tp_core_mod.fxppm tp_core_mod
!.fyppm tp_core_mod.deln_flux)):
!   gradient     of useful results: q fx c
!   with respect to varying inputs: q fx c
  SUBROUTINE XTP_FWD(fx, q, c, iord, ifirst, ilast, jfirst, jlast, &
&   npx, npy, bd, dxa, nested, grid_type)
    IMPLICIT NONE
    TYPE(FV_GRID_BOUNDS_TYPE), INTENT(IN) :: bd
!  X-Dir strip
    INTEGER, INTENT(IN) :: ifirst, ilast
!  Y-Dir strip
    INTEGER, INTENT(IN) :: jfirst, jlast
    INTEGER, INTENT(IN) :: npx, npy
    INTEGER, INTENT(IN) :: iord
! Courant numbers
    REAL(fvprc), INTENT(IN) :: c(bd%is:bd%ie+1, jfirst:jlast)
    REAL(fvprc), INTENT(IN) :: q(bd%isd:bd%ied, jfirst:jlast)
    REAL(fvprc) :: fx(ifirst:ilast+1, jfirst:jlast)
    REAL(fvprc), INTENT(IN) :: dxa(bd%isd:bd%ied, bd%jsd:bd%jed)
    LOGICAL, INTENT(IN) :: nested
    INTEGER, INTENT(IN) :: grid_type
! Local:
    REAL(fvprc) :: dm(bd%is-2:bd%ie+2)
    REAL(fvprc) :: x0l, x0r, x1
    INTEGER :: i, j
    INTEGER :: is, ie, js, je, isd, ied, jsd, jed
    IF (iord .EQ. 1) THEN
      CALL PUSHREALARRAY(fx, 8*(ilast-ifirst+2)*(jlast-jfirst+1)/8)
      DO j=jfirst,jlast
        DO i=ifirst,ilast+1
          IF (c(i, j) .GT. 0.) THEN
            fx(i, j) = q(i-1, j)
          ELSE
            fx(i, j) = q(i, j)
          END IF
        END DO
      END DO
      CALL PUSHCONTROL2B_FV(0)
    ELSE IF (iord .EQ. 333) THEN
      CALL PUSHREALARRAY(fx, 8*(ilast-ifirst+2)*(jlast-jfirst+1)/8)
!Advection using third order scheme
      DO j=jfirst,jlast
        DO i=ifirst,ilast+1
          IF (c(i, j) .GT. 0.) THEN
            fx(i, j) = (2.0*q(i, j)+5.0*q(i-1, j)-q(i-2, j))/6.0 - 0.5*c&
&             (i, j)*(q(i, j)-q(i-1, j)) + c(i, j)*c(i, j)/6.0*(q(i, j)-&
&             2.0*q(i-1, j)+q(i-2, j))
          ELSE
            fx(i, j) = (2.0*q(i-1, j)+5.0*q(i, j)-q(i+1, j))/6.0 - 0.5*c&
&             (i, j)*(q(i, j)-q(i-1, j)) + c(i, j)*c(i, j)/6.0*(q(i+1, j&
&             )-2.0*q(i, j)+q(i-1, j))
          END IF
        END DO
      END DO
      CALL PUSHCONTROL2B_FV(1)
    ELSE IF (iord .EQ. 6) THEN
      CALL FXPPM_FWD(c, q, fx, iord, ifirst, ilast, jfirst, jlast, &
&                 npx, npy, bd, dxa, nested, grid_type)
      CALL PUSHCONTROL2B_FV(3)
    ELSE
      CALL PUSHCONTROL2B_FV(2)
    END IF
  END SUBROUTINE XTP_FWD
!  Differentiation of xtp in reverse (adjoint) mode, backward sweep (with options r8 split(a2b_edge_mod.a2b_ord2 a2b_edge_mod.
!a2b_ord4 a2b_edge_mod.extrap_corner  dyn_core_mod.dyn_core dyn_core_mod.pk3_halo dyn_core_mod.pln_halo dyn_core_mod.pe_hal
!o dyn_core_mod.adv_pe dyn_core_mod.p_grad_c dyn_core_mod.nh_p_grad dyn_core_mod.split_p_grad dyn_core_mod.one_grad_p dyn_core_mo
!d.grad1_p_update dyn_core_mod.mix_dp dyn_core_mod.geopk dyn_core_mod.del2_cubed fv_dynamics_mod.fv_dynamics fv_dynamics_mod.rayl
!eigh_super fv_dynamics_mod.rayleigh_friction fv_dynamics_mod.compute_aam fv_dynamics_mod.geos_to_fv3 fv_grid_utils_mod.cubed_to_
!latlon fv_grid_utils_mod.c2l_ord4 fv_grid_utils_mod.c2l_ord2 fv_mapz_mod.lagrangian_to_eulerian fv_mapz_mod.compute_total_energy
! fv_mapz_mod.pkez fv_mapz_mod.remap_z fv_mapz_mod.map_scalar fv_mapz_mod.map1_ppm fv_mapz_mod.mapn_tracer fv_mapz_mo
!d.map1_q2 fv_mapz_mod.map1_cubic fv_mapz_mod.scalar_profile_linear fv_mapz_mod.cs_profile_linear fv_mapz_mod.steepz fv_
!tracer2d_mod.tracer_2d fv_tracer2d_mod.tracer_2d_nested nh_core_mod.update_dz_c nh_core_mod.update_dz_d nh_core_mod.riem_solver_
!c nh_core_mod.riem_solver3 nh_core_mod.rim_2d nh_core_mod.sim3_solver nh_core_mod.sim3p0_solver nh_core_mod.sim1_solver nh_core_
!mod.sim_solver nh_core_mod.edge_profile sw_core_mod.c_sw sw_core_mod.d_sw sw_core_mod.divergence_corner sw_core_mod.divergence_c
!orner_nest sw_core_mod.d2a2c_vect sw_core_mod.edge_interpolate4 sw_core_mod.fill2_4corners sw_core_mod.fill_4corners sw_core_mod
!.compute_div_damping sw_core_mod.smag_corner sw_core_mod.ytp_v sw_core_mod.xtp_u tp_core_mod.fv_tp_2d tp_core_mod
!.copy_corners tp_core_mod.xtp tp_core_mod.ytp tp_core_mod.xppm0 tp_core_mod.yppm0 tp_core_mod.fxppm tp_core_mo
!d.fyppm tp_core_mod.deln_flux)):
!   gradient     of useful results: q fx c
!   with respect to varying inputs: q fx c
  SUBROUTINE XTP_BWD(fx, fx_ad, q, q_ad, c, c_ad, iord, ifirst, ilast&
&   , jfirst, jlast, npx, npy, bd, dxa, nested, grid_type)
    IMPLICIT NONE
    TYPE(FV_GRID_BOUNDS_TYPE), INTENT(IN) :: bd
    INTEGER, INTENT(IN) :: ifirst, ilast
    INTEGER, INTENT(IN) :: jfirst, jlast
    INTEGER, INTENT(IN) :: npx, npy
    INTEGER, INTENT(IN) :: iord
    REAL(fvprc), INTENT(IN) :: c(bd%is:bd%ie+1, jfirst:jlast)
    REAL(fvprc) :: c_ad(bd%is:bd%ie+1, jfirst:jlast)
    REAL(fvprc), INTENT(IN) :: q(bd%isd:bd%ied, jfirst:jlast)
    REAL(fvprc) :: q_ad(bd%isd:bd%ied, jfirst:jlast)
    REAL(fvprc) :: fx(ifirst:ilast+1, jfirst:jlast)
    REAL(fvprc) :: fx_ad(ifirst:ilast+1, jfirst:jlast)
    REAL(fvprc), INTENT(IN) :: dxa(bd%isd:bd%ied, bd%jsd:bd%jed)
    LOGICAL, INTENT(IN) :: nested
    INTEGER, INTENT(IN) :: grid_type
    REAL(fvprc) :: dm(bd%is-2:bd%ie+2)
    REAL(fvprc) :: x0l, x0r, x1
    INTEGER :: i, j
    INTEGER :: is, ie, js, je, isd, ied, jsd, jed
    INTEGER :: branch
    REAL(fvprc) :: temp_ad
    REAL(fvprc) :: temp_ad0
    REAL(fvprc) :: temp_ad1
    REAL(fvprc) :: temp_ad2
    REAL(fvprc) :: temp_ad3
    REAL(fvprc) :: temp_ad4
    CALL POPCONTROL2B_FV(branch)
    IF (branch .LT. 2) THEN
      IF (branch .EQ. 0) THEN
        CALL POPREALARRAY(fx, 8*(ilast-ifirst+2)*(jlast-jfirst+1)/8&
&                   )
        DO j=jfirst,jlast
          DO i=ifirst,ilast+1
            IF (c(i, j) .GT. 0.) THEN
              CALL PUSHCONTROL1B_FV(1)
            ELSE
              CALL PUSHCONTROL1B_FV(0)
            END IF
          END DO
          DO i=ilast+1,ifirst,-1
            CALL POPCONTROL1B_FV(branch)
            IF (branch .EQ. 0) THEN
              q_ad(i, j) = q_ad(i, j) + fx_ad(i, j)
              fx_ad(i, j) = 0.0_FVPRC
            ELSE
              q_ad(i-1, j) = q_ad(i-1, j) + fx_ad(i, j)
              fx_ad(i, j) = 0.0_FVPRC
            END IF
          END DO
        END DO
      ELSE
        CALL POPREALARRAY(fx, 8*(ilast-ifirst+2)*(jlast-jfirst+1)/8&
&                   )
        DO j=jfirst,jlast
          DO i=ifirst,ilast+1
            IF (c(i, j) .GT. 0.) THEN
              CALL PUSHCONTROL1B_FV(1)
            ELSE
              CALL PUSHCONTROL1B_FV(0)
            END IF
          END DO
          DO i=ilast+1,ifirst,-1
            CALL POPCONTROL1B_FV(branch)
            IF (branch .EQ. 0) THEN
              temp_ad2 = fx_ad(i, j)/6.0
              temp_ad3 = -(0.5*c(i, j)*fx_ad(i, j))
              temp_ad4 = c(i, j)**2*fx_ad(i, j)/6.0
              q_ad(i-1, j) = q_ad(i-1, j) + temp_ad4 - temp_ad3 + 2.0*&
&               temp_ad2
              q_ad(i, j) = q_ad(i, j) + temp_ad3 - 2.0*temp_ad4 + 5.0*&
&               temp_ad2
              q_ad(i+1, j) = q_ad(i+1, j) + temp_ad4 - temp_ad2
              c_ad(i, j) = c_ad(i, j) + ((q(i+1, j)-2.0*q(i, j)+q(i-1, j&
&               ))*2*c(i, j)/6.0-0.5*(q(i, j)-q(i-1, j)))*fx_ad(i, j)
              fx_ad(i, j) = 0.0_FVPRC
            ELSE
              temp_ad = fx_ad(i, j)/6.0
              temp_ad0 = -(0.5*c(i, j)*fx_ad(i, j))
              temp_ad1 = c(i, j)**2*fx_ad(i, j)/6.0
              q_ad(i, j) = q_ad(i, j) + temp_ad1 + temp_ad0 + 2.0*&
&               temp_ad
              q_ad(i-1, j) = q_ad(i-1, j) + 5.0*temp_ad - temp_ad0 - 2.0&
&               *temp_ad1
              q_ad(i-2, j) = q_ad(i-2, j) + temp_ad1 - temp_ad
              c_ad(i, j) = c_ad(i, j) + ((q(i, j)-2.0*q(i-1, j)+q(i-2, j&
&               ))*2*c(i, j)/6.0-0.5*(q(i, j)-q(i-1, j)))*fx_ad(i, j)
              fx_ad(i, j) = 0.0_FVPRC
            END IF
          END DO
        END DO
      END IF
    ELSE IF (branch .NE. 2) THEN
      CALL FXPPM_BWD(c, c_ad, q, q_ad, fx, fx_ad, iord, ifirst, ilast&
&                 , jfirst, jlast, npx, npy, bd, dxa, nested, grid_type)
    END IF
  END SUBROUTINE XTP_BWD
!  Differentiation of ytp in reverse (adjoint) mode, forward sweep (with options r8 split(a2b_edge_mod.a2b_ord2 a2b_edge_mod.a
!2b_ord4_fb a2b_edge_mod.extrap_corner  dyn_core_mod.dyn_core dyn_core_mod.pk3_halo dyn_core_mod.pln_halo dyn_core_mod.pe_halo
! dyn_core_mod.adv_pe dyn_core_mod.p_grad_c dyn_core_mod.nh_p_grad dyn_core_mod.split_p_grad dyn_core_mod.one_grad_p dyn_core_mod
!.grad1_p_update dyn_core_mod.mix_dp dyn_core_mod.geopk dyn_core_mod.del2_cubed fv_dynamics_mod.fv_dynamics fv_dynamics_mod.rayle
!igh_super fv_dynamics_mod.rayleigh_friction fv_dynamics_mod.compute_aam fv_dynamics_mod.geos_to_fv3 fv_grid_utils_mod.cubed_to_l
!atlon fv_grid_utils_mod.c2l_ord4 fv_grid_utils_mod.c2l_ord2 fv_mapz_mod.lagrangian_to_eulerian fv_mapz_mod.compute_total_energy 
!fv_mapz_mod.pkez fv_mapz_mod.remap_z fv_mapz_mod.map_scalar fv_mapz_mod.map1_ppm fv_mapz_mod.mapn_tracer fv_mapz_mod
!.map1_q2 fv_mapz_mod.map1_cubic fv_mapz_mod.scalar_profile_linear fv_mapz_mod.cs_profile_linear fv_mapz_mod.steepz fv_t
!racer2d_mod.tracer_2d fv_tracer2d_mod.tracer_2d_nested nh_core_mod.update_dz_c nh_core_mod.update_dz_d nh_core_mod.riem_solver_c
! nh_core_mod.riem_solver3 nh_core_mod.rim_2d nh_core_mod.sim3_solver nh_core_mod.sim3p0_solver nh_core_mod.sim1_solver nh_core_m
!od.sim_solver nh_core_mod.edge_profile sw_core_mod.c_sw sw_core_mod.d_sw sw_core_mod.divergence_corner sw_core_mod.divergence_co
!rner_nest sw_core_mod.d2a2c_vect sw_core_mod.edge_interpolate4 sw_core_mod.fill2_4corners sw_core_mod.fill_4corners sw_core_mod.
!compute_div_damping sw_core_mod.smag_corner sw_core_mod.ytp_v sw_core_mod.xtp_u tp_core_mod.fv_tp_2d tp_core_mod.
!copy_corners tp_core_mod.xtp tp_core_mod.ytp tp_core_mod.xppm0 tp_core_mod.yppm0 tp_core_mod.fxppm tp_core_mod
!.fyppm tp_core_mod.deln_flux)):
!   gradient     of useful results: q fy c
!   with respect to varying inputs: q fy c
  SUBROUTINE YTP_FWD(fy, q, c, jord, ifirst, ilast, jfirst, jlast, &
&   npx, npy, bd, dya, nested, grid_type)
    IMPLICIT NONE
    TYPE(FV_GRID_BOUNDS_TYPE), INTENT(IN) :: bd
    INTEGER, INTENT(IN) :: npx, npy
!  X-Dir strip
    INTEGER, INTENT(IN) :: ifirst, ilast
!  Y-Dir strip
    INTEGER, INTENT(IN) :: jfirst, jlast
    INTEGER, INTENT(IN) :: jord
    REAL(fvprc), INTENT(IN) :: q(ifirst:ilast, jfirst-ng:jlast+ng)
! Courant number
    REAL(fvprc), INTENT(IN) :: c(bd%isd:bd%ied, bd%js:bd%je+1)
!  Flux
    REAL(fvprc) :: fy(ifirst:ilast, jfirst:jlast+1)
    REAL(fvprc), INTENT(IN) :: dya(bd%isd:bd%ied, bd%jsd:bd%jed)
    LOGICAL, INTENT(IN) :: nested
    INTEGER, INTENT(IN) :: grid_type
! !LOCAL VARIABLES:
    REAL(fvprc) :: dm(ifirst:ilast, jfirst-2:jlast+2)
    REAL(fvprc) :: x0l, x0r, x1
    INTEGER :: i, j
    INTEGER :: is, ie, js, je, isd, ied, jsd, jed
    IF (jord .EQ. 1) THEN
      CALL PUSHREALARRAY(fy, 8*(ilast-ifirst+1)*(jlast-jfirst+2)/8)
      DO j=jfirst,jlast+1
        DO i=ifirst,ilast
          IF (c(i, j) .GT. 0.) THEN
            fy(i, j) = q(i, j-1)
          ELSE
            fy(i, j) = q(i, j)
          END IF
        END DO
      END DO
      CALL PUSHCONTROL2B_FV(0)
    ELSE IF (jord .EQ. 333) THEN
      CALL PUSHREALARRAY(fy, 8*(ilast-ifirst+1)*(jlast-jfirst+2)/8)
!Advected using third order scheme
      DO j=jfirst,jlast+1
        DO i=ifirst,ilast
          IF (c(i, j) .GT. 0.) THEN
            fy(i, j) = (2.0*q(i, j)+5.0*q(i, j-1)-q(i, j-2))/6.0 - 0.5*c&
&             (i, j)*(q(i, j)-q(i, j-1)) + c(i, j)*c(i, j)/6.0*(q(i, j)-&
&             2.0*q(i, j-1)+q(i, j-2))
          ELSE
            fy(i, j) = (2.0*q(i, j-1)+5.0*q(i, j)-q(i, j+1))/6.0 - 0.5*c&
&             (i, j)*(q(i, j)-q(i, j-1)) + c(i, j)*c(i, j)/6.0*(q(i, j+1&
&             )-2.0*q(i, j)+q(i, j-1))
          END IF
        END DO
      END DO
      CALL PUSHCONTROL2B_FV(1)
    ELSE IF (jord .EQ. 6) THEN
      CALL FYPPM_FWD(c, q, fy, jord, ifirst, ilast, jfirst, jlast, &
&                 npx, npy, dm, bd, dya, nested, grid_type)
      CALL PUSHCONTROL2B_FV(3)
    ELSE
      CALL PUSHCONTROL2B_FV(2)
    END IF
  END SUBROUTINE YTP_FWD
!  Differentiation of ytp in reverse (adjoint) mode, backward sweep (with options r8 split(a2b_edge_mod.a2b_ord2 a2b_edge_mod.
!a2b_ord4 a2b_edge_mod.extrap_corner  dyn_core_mod.dyn_core dyn_core_mod.pk3_halo dyn_core_mod.pln_halo dyn_core_mod.pe_hal
!o dyn_core_mod.adv_pe dyn_core_mod.p_grad_c dyn_core_mod.nh_p_grad dyn_core_mod.split_p_grad dyn_core_mod.one_grad_p dyn_core_mo
!d.grad1_p_update dyn_core_mod.mix_dp dyn_core_mod.geopk dyn_core_mod.del2_cubed fv_dynamics_mod.fv_dynamics fv_dynamics_mod.rayl
!eigh_super fv_dynamics_mod.rayleigh_friction fv_dynamics_mod.compute_aam fv_dynamics_mod.geos_to_fv3 fv_grid_utils_mod.cubed_to_
!latlon fv_grid_utils_mod.c2l_ord4 fv_grid_utils_mod.c2l_ord2 fv_mapz_mod.lagrangian_to_eulerian fv_mapz_mod.compute_total_energy
! fv_mapz_mod.pkez fv_mapz_mod.remap_z fv_mapz_mod.map_scalar fv_mapz_mod.map1_ppm fv_mapz_mod.mapn_tracer fv_mapz_mo
!d.map1_q2 fv_mapz_mod.map1_cubic fv_mapz_mod.scalar_profile_linear fv_mapz_mod.cs_profile_linear fv_mapz_mod.steepz fv_
!tracer2d_mod.tracer_2d fv_tracer2d_mod.tracer_2d_nested nh_core_mod.update_dz_c nh_core_mod.update_dz_d nh_core_mod.riem_solver_
!c nh_core_mod.riem_solver3 nh_core_mod.rim_2d nh_core_mod.sim3_solver nh_core_mod.sim3p0_solver nh_core_mod.sim1_solver nh_core_
!mod.sim_solver nh_core_mod.edge_profile sw_core_mod.c_sw sw_core_mod.d_sw sw_core_mod.divergence_corner sw_core_mod.divergence_c
!orner_nest sw_core_mod.d2a2c_vect sw_core_mod.edge_interpolate4 sw_core_mod.fill2_4corners sw_core_mod.fill_4corners sw_core_mod
!.compute_div_damping sw_core_mod.smag_corner sw_core_mod.ytp_v sw_core_mod.xtp_u tp_core_mod.fv_tp_2d tp_core_mod
!.copy_corners tp_core_mod.xtp tp_core_mod.ytp tp_core_mod.xppm0 tp_core_mod.yppm0 tp_core_mod.fxppm tp_core_mo
!d.fyppm tp_core_mod.deln_flux)):
!   gradient     of useful results: q fy c
!   with respect to varying inputs: q fy c
  SUBROUTINE YTP_BWD(fy, fy_ad, q, q_ad, c, c_ad, jord, ifirst, ilast&
&   , jfirst, jlast, npx, npy, bd, dya, nested, grid_type)
    IMPLICIT NONE
    TYPE(FV_GRID_BOUNDS_TYPE), INTENT(IN) :: bd
    INTEGER, INTENT(IN) :: npx, npy
    INTEGER, INTENT(IN) :: ifirst, ilast
    INTEGER, INTENT(IN) :: jfirst, jlast
    INTEGER, INTENT(IN) :: jord
    REAL(fvprc), INTENT(IN) :: q(ifirst:ilast, jfirst-ng:jlast+ng)
    REAL(fvprc) :: q_ad(ifirst:ilast, jfirst-ng:jlast+ng)
    REAL(fvprc), INTENT(IN) :: c(bd%isd:bd%ied, bd%js:bd%je+1)
    REAL(fvprc) :: c_ad(bd%isd:bd%ied, bd%js:bd%je+1)
    REAL(fvprc) :: fy(ifirst:ilast, jfirst:jlast+1)
    REAL(fvprc) :: fy_ad(ifirst:ilast, jfirst:jlast+1)
    REAL(fvprc), INTENT(IN) :: dya(bd%isd:bd%ied, bd%jsd:bd%jed)
    LOGICAL, INTENT(IN) :: nested
    INTEGER, INTENT(IN) :: grid_type
    REAL(fvprc) :: dm(ifirst:ilast, jfirst-2:jlast+2)
    REAL(fvprc) :: x0l, x0r, x1
    INTEGER :: i, j
    INTEGER :: is, ie, js, je, isd, ied, jsd, jed
    INTEGER :: branch
    REAL(fvprc) :: temp_ad
    REAL(fvprc) :: temp_ad0
    REAL(fvprc) :: temp_ad1
    REAL(fvprc) :: temp_ad2
    REAL(fvprc) :: temp_ad3
    REAL(fvprc) :: temp_ad4
    CALL POPCONTROL2B_FV(branch)
    IF (branch .LT. 2) THEN
      IF (branch .EQ. 0) THEN
        CALL POPREALARRAY(fy, 8*(ilast-ifirst+1)*(jlast-jfirst+2)/8&
&                   )
        DO j=jfirst,jlast+1
          DO i=ifirst,ilast
            IF (c(i, j) .GT. 0.) THEN
              CALL PUSHCONTROL1B_FV(1)
            ELSE
              CALL PUSHCONTROL1B_FV(0)
            END IF
          END DO
          DO i=ilast,ifirst,-1
            CALL POPCONTROL1B_FV(branch)
            IF (branch .EQ. 0) THEN
              q_ad(i, j) = q_ad(i, j) + fy_ad(i, j)
              fy_ad(i, j) = 0.0_FVPRC
            ELSE
              q_ad(i, j-1) = q_ad(i, j-1) + fy_ad(i, j)
              fy_ad(i, j) = 0.0_FVPRC
            END IF
          END DO
        END DO
      ELSE
        CALL POPREALARRAY(fy, 8*(ilast-ifirst+1)*(jlast-jfirst+2)/8&
&                   )
        DO j=jfirst,jlast+1
          DO i=ifirst,ilast
            IF (c(i, j) .GT. 0.) THEN
              CALL PUSHCONTROL1B_FV(1)
            ELSE
              CALL PUSHCONTROL1B_FV(0)
            END IF
          END DO
          DO i=ilast,ifirst,-1
            CALL POPCONTROL1B_FV(branch)
            IF (branch .EQ. 0) THEN
              temp_ad2 = fy_ad(i, j)/6.0
              temp_ad3 = -(0.5*c(i, j)*fy_ad(i, j))
              temp_ad4 = c(i, j)**2*fy_ad(i, j)/6.0
              q_ad(i, j-1) = q_ad(i, j-1) + temp_ad4 - temp_ad3 + 2.0*&
&               temp_ad2
              q_ad(i, j) = q_ad(i, j) + temp_ad3 - 2.0*temp_ad4 + 5.0*&
&               temp_ad2
              q_ad(i, j+1) = q_ad(i, j+1) + temp_ad4 - temp_ad2
              c_ad(i, j) = c_ad(i, j) + ((q(i, j+1)-2.0*q(i, j)+q(i, j-1&
&               ))*2*c(i, j)/6.0-0.5*(q(i, j)-q(i, j-1)))*fy_ad(i, j)
              fy_ad(i, j) = 0.0_FVPRC
            ELSE
              temp_ad = fy_ad(i, j)/6.0
              temp_ad0 = -(0.5*c(i, j)*fy_ad(i, j))
              temp_ad1 = c(i, j)**2*fy_ad(i, j)/6.0
              q_ad(i, j) = q_ad(i, j) + temp_ad1 + temp_ad0 + 2.0*&
&               temp_ad
              q_ad(i, j-1) = q_ad(i, j-1) + 5.0*temp_ad - temp_ad0 - 2.0&
&               *temp_ad1
              q_ad(i, j-2) = q_ad(i, j-2) + temp_ad1 - temp_ad
              c_ad(i, j) = c_ad(i, j) + ((q(i, j)-2.0*q(i, j-1)+q(i, j-2&
&               ))*2*c(i, j)/6.0-0.5*(q(i, j)-q(i, j-1)))*fy_ad(i, j)
              fy_ad(i, j) = 0.0_FVPRC
            END IF
          END DO
        END DO
      END IF
    ELSE IF (branch .NE. 2) THEN
      CALL FYPPM_BWD(c, c_ad, q, q_ad, fy, fy_ad, jord, ifirst, ilast&
&                 , jfirst, jlast, npx, npy, dm, bd, dya, nested, &
&                 grid_type)
    END IF
  END SUBROUTINE YTP_BWD
!  Differentiation of xppm0 in reverse (adjoint) mode, forward sweep (with options r8 split(a2b_edge_mod.a2b_ord2 a2b_edge_mod
!.a2b_ord4 a2b_edge_mod.extrap_corner  dyn_core_mod.dyn_core dyn_core_mod.pk3_halo dyn_core_mod.pln_halo dyn_core_mod.pe_ha
!lo dyn_core_mod.adv_pe dyn_core_mod.p_grad_c dyn_core_mod.nh_p_grad dyn_core_mod.split_p_grad dyn_core_mod.one_grad_p dyn_core_m
!od.grad1_p_update dyn_core_mod.mix_dp dyn_core_mod.geopk dyn_core_mod.del2_cubed fv_dynamics_mod.fv_dynamics fv_dynamics_mod.ray
!leigh_super fv_dynamics_mod.rayleigh_friction fv_dynamics_mod.compute_aam fv_dynamics_mod.geos_to_fv3 fv_grid_utils_mod.cubed_to
!_latlon fv_grid_utils_mod.c2l_ord4 fv_grid_utils_mod.c2l_ord2 fv_mapz_mod.lagrangian_to_eulerian fv_mapz_mod.compute_total_energ
!y fv_mapz_mod.pkez fv_mapz_mod.remap_z fv_mapz_mod.map_scalar fv_mapz_mod.map1_ppm fv_mapz_mod.mapn_tracer fv_mapz_m
!od.map1_q2 fv_mapz_mod.map1_cubic fv_mapz_mod.scalar_profile_linear fv_mapz_mod.cs_profile_linear fv_mapz_mod.steepz fv
!_tracer2d_mod.tracer_2d fv_tracer2d_mod.tracer_2d_nested nh_core_mod.update_dz_c nh_core_mod.update_dz_d nh_core_mod.riem_solver
!_c nh_core_mod.riem_solver3 nh_core_mod.rim_2d nh_core_mod.sim3_solver nh_core_mod.sim3p0_solver nh_core_mod.sim1_solver nh_core
!_mod.sim_solver nh_core_mod.edge_profile sw_core_mod.c_sw sw_core_mod.d_sw sw_core_mod.divergence_corner sw_core_mod.divergence_
!corner_nest sw_core_mod.d2a2c_vect sw_core_mod.edge_interpolate4 sw_core_mod.fill2_4corners sw_core_mod.fill_4corners sw_core_mo
!d.compute_div_damping sw_core_mod.smag_corner sw_core_mod.ytp_v sw_core_mod.xtp_u tp_core_mod.fv_tp_2d tp_core_mo
!d.copy_corners tp_core_mod.xtp tp_core_mod.ytp tp_core_mod.xppm0 tp_core_mod.yppm0 tp_core_mod.fxppm tp_core_m
!od.fyppm tp_core_mod.deln_flux)):
!   gradient     of useful results: q flux c
!   with respect to varying inputs: q flux c
  SUBROUTINE XPPM0_FWD(flux, q, c, iord, ifirst, ilast, jfirst, jlast&
&   , npx, npy, bd, dxa, nested, grid_type)
    IMPLICIT NONE
    TYPE(FV_GRID_BOUNDS_TYPE), INTENT(IN) :: bd
!  X-Dir strip
    INTEGER, INTENT(IN) :: ifirst, ilast
!  Y-Dir strip
    INTEGER, INTENT(IN) :: jfirst, jlast
    INTEGER, INTENT(IN) :: iord
    INTEGER, INTENT(IN) :: npx, npy
    REAL(fvprc), INTENT(IN) :: q(ifirst-ng:ilast+ng, jfirst:jlast)
! Courant   N (like FLUX)
    REAL(fvprc), INTENT(IN) :: c(ifirst:ilast+1, jfirst:jlast)
    REAL(fvprc), INTENT(IN) :: dxa(bd%isd:bd%ied, bd%jsd:bd%jed)
    LOGICAL, INTENT(IN) :: nested
    INTEGER, INTENT(IN) :: grid_type
! !OUTPUT PARAMETERS:
!  Flux
    REAL(fvprc) :: flux(ifirst:ilast+1, jfirst:jlast)
! Local
    REAL(fvprc), DIMENSION(ifirst-1:ilast+1, jfirst:jlast) :: bl, br
    REAL(fvprc) :: al(ifirst-1:ilast+2, jfirst:jlast)
    INTEGER :: i, j, ie3, is1, ie1
    REAL(fvprc) :: xt, pmp_1, lac_1, pmp_2, lac_2
    INTEGER :: is, ie, js, je, isd, ied, jsd, jed
    INTRINSIC MAX
    INTRINSIC MIN
    IF (.NOT.nested .AND. grid_type .LT. 3) THEN
      IF (3 .LT. bd%is - 1) THEN
        is1 = bd%is - 1
      ELSE
        is1 = 3
      END IF
      IF (npx - 2 .GT. bd%ie + 2) THEN
        CALL PUSHCONTROL1B_FV(1)
        ie3 = bd%ie + 2
      ELSE
        CALL PUSHCONTROL1B_FV(1)
        ie3 = npx - 2
      END IF
    ELSE
      CALL PUSHCONTROL1B_FV(0)
      is1 = bd%is - 1
      ie3 = bd%ie + 2
    END IF
! ord = -5: linear scheme based on PPM 4th order interpolation
    DO j=jfirst,jlast
      DO i=is1,ie3
        al(i, j) = p1*(q(i-1, j)+q(i, j)) + p2*(q(i-2, j)+q(i+1, j))
      END DO
    END DO
    DO j=jfirst,jlast
      IF (.NOT.nested .AND. grid_type .LT. 3) THEN
        IF (bd%is .EQ. 1) THEN
          al(0, j) = c1*q(-2, j) + c2*q(-1, j) + c3*q(0, j)
          al(1, j) = 0.5*(((2.*dxa(0, j)+dxa(-1, j))*q(0, j)-dxa(0, j)*q&
&           (-1, j))/(dxa(-1, j)+dxa(0, j))+((2.*dxa(1, j)+dxa(2, j))*q(&
&           1, j)-dxa(1, j)*q(2, j))/(dxa(1, j)+dxa(2, j)))
          al(2, j) = c3*q(1, j) + c2*q(2, j) + c1*q(3, j)
          CALL PUSHCONTROL1B_FV(0)
        ELSE
          CALL PUSHCONTROL1B_FV(1)
        END IF
        IF (bd%ie + 1 .EQ. npx) THEN
          al(npx-1, j) = c1*q(npx-3, j) + c2*q(npx-2, j) + c3*q(npx-1, j&
&           )
          al(npx, j) = 0.5*(((2.*dxa(npx-1, j)+dxa(npx-2, j))*q(npx-1, j&
&           )-dxa(npx-1, j)*q(npx-2, j))/(dxa(npx-2, j)+dxa(npx-1, j))+(&
&           (2.*dxa(npx, j)+dxa(npx+1, j))*q(npx, j)-dxa(npx, j)*q(npx+1&
&           , j))/(dxa(npx, j)+dxa(npx+1, j)))
          al(npx+1, j) = c3*q(npx, j) + c2*q(npx+1, j) + c1*q(npx+2, j)
          CALL PUSHCONTROL2B_FV(2)
        ELSE
          CALL PUSHCONTROL2B_FV(1)
        END IF
      ELSE
        CALL PUSHCONTROL2B_FV(0)
      END IF
    END DO
    DO j=jfirst,jlast
      DO i=ifirst-1,ilast+1
        bl(i, j) = al(i, j) - q(i, j)
        br(i, j) = al(i+1, j) - q(i, j)
      END DO
    END DO
    CALL PUSHREALARRAY(flux, 8*(ilast-ifirst+2)*(jlast-jfirst+1)/8)
    DO j=jfirst,jlast
      DO i=ifirst,ilast+1
        IF (c(i, j) .GT. 0.) THEN
          flux(i, j) = q(i-1, j) + (1.-c(i, j))*(br(i-1, j)-c(i, j)*(bl(&
&           i-1, j)+br(i-1, j)))
        ELSE
          flux(i, j) = q(i, j) + (1.+c(i, j))*(bl(i, j)+c(i, j)*(bl(i, j&
&           )+br(i, j)))
        END IF
      END DO
    END DO
    CALL PUSHINTEGER(is1)
    CALL PUSHREALARRAY(bl, 8*(ilast-ifirst+3)*(jlast-jfirst+1)/8)
    CALL PUSHREALARRAY(br, 8*(ilast-ifirst+3)*(jlast-jfirst+1)/8)
    CALL PUSHINTEGER(ie3)
  END SUBROUTINE XPPM0_FWD
!  Differentiation of xppm0 in reverse (adjoint) mode, backward sweep (with options r8 split(a2b_edge_mod.a2b_ord2 a2b_edge_mo
!d.a2b_ord4 a2b_edge_mod.extrap_corner  dyn_core_mod.dyn_core dyn_core_mod.pk3_halo dyn_core_mod.pln_halo dyn_core_mod.pe_h
!alo dyn_core_mod.adv_pe dyn_core_mod.p_grad_c dyn_core_mod.nh_p_grad dyn_core_mod.split_p_grad dyn_core_mod.one_grad_p dyn_core_
!mod.grad1_p_update dyn_core_mod.mix_dp dyn_core_mod.geopk dyn_core_mod.del2_cubed fv_dynamics_mod.fv_dynamics fv_dynamics_mod.ra
!yleigh_super fv_dynamics_mod.rayleigh_friction fv_dynamics_mod.compute_aam fv_dynamics_mod.geos_to_fv3 fv_grid_utils_mod.cubed_t
!o_latlon fv_grid_utils_mod.c2l_ord4 fv_grid_utils_mod.c2l_ord2 fv_mapz_mod.lagrangian_to_eulerian fv_mapz_mod.compute_total_ener
!gy fv_mapz_mod.pkez fv_mapz_mod.remap_z fv_mapz_mod.map_scalar fv_mapz_mod.map1_ppm fv_mapz_mod.mapn_tracer fv_mapz_
!mod.map1_q2 fv_mapz_mod.map1_cubic fv_mapz_mod.scalar_profile_linear fv_mapz_mod.cs_profile_linear fv_mapz_mod.steepz f
!v_tracer2d_mod.tracer_2d fv_tracer2d_mod.tracer_2d_nested nh_core_mod.update_dz_c nh_core_mod.update_dz_d nh_core_mod.riem_solve
!r_c nh_core_mod.riem_solver3 nh_core_mod.rim_2d nh_core_mod.sim3_solver nh_core_mod.sim3p0_solver nh_core_mod.sim1_solver nh_cor
!e_mod.sim_solver nh_core_mod.edge_profile sw_core_mod.c_sw sw_core_mod.d_sw sw_core_mod.divergence_corner sw_core_mod.divergence
!_corner_nest sw_core_mod.d2a2c_vect sw_core_mod.edge_interpolate4 sw_core_mod.fill2_4corners sw_core_mod.fill_4corners sw_core_m
!od.compute_div_damping sw_core_mod.smag_corner sw_core_mod.ytp_v sw_core_mod.xtp_u tp_core_mod.fv_tp_2d tp_core_m
!od.copy_corners tp_core_mod.xtp tp_core_mod.ytp tp_core_mod.xppm0 tp_core_mod.yppm0 tp_core_mod.fxppm tp_core_
!mod.fyppm tp_core_mod.deln_flux)):
!   gradient     of useful results: q flux c
!   with respect to varying inputs: q flux c
  SUBROUTINE XPPM0_BWD(flux, flux_ad, q, q_ad, c, c_ad, iord, ifirst&
&   , ilast, jfirst, jlast, npx, npy, bd, dxa, nested, grid_type)
    IMPLICIT NONE
    TYPE(FV_GRID_BOUNDS_TYPE), INTENT(IN) :: bd
    INTEGER, INTENT(IN) :: ifirst, ilast
    INTEGER, INTENT(IN) :: jfirst, jlast
    INTEGER, INTENT(IN) :: iord
    INTEGER, INTENT(IN) :: npx, npy
    REAL(fvprc), INTENT(IN) :: q(ifirst-ng:ilast+ng, jfirst:jlast)
    REAL(fvprc) :: q_ad(ifirst-ng:ilast+ng, jfirst:jlast)
    REAL(fvprc), INTENT(IN) :: c(ifirst:ilast+1, jfirst:jlast)
    REAL(fvprc) :: c_ad(ifirst:ilast+1, jfirst:jlast)
    REAL(fvprc), INTENT(IN) :: dxa(bd%isd:bd%ied, bd%jsd:bd%jed)
    LOGICAL, INTENT(IN) :: nested
    INTEGER, INTENT(IN) :: grid_type
    REAL(fvprc) :: flux(ifirst:ilast+1, jfirst:jlast)
    REAL(fvprc) :: flux_ad(ifirst:ilast+1, jfirst:jlast)
    REAL(fvprc), DIMENSION(ifirst-1:ilast+1, jfirst:jlast) :: bl, br
    REAL(fvprc), DIMENSION(ifirst-1:ilast+1, jfirst:jlast) :: bl_ad, &
&   br_ad
    REAL(fvprc) :: al(ifirst-1:ilast+2, jfirst:jlast)
    REAL(fvprc) :: al_ad(ifirst-1:ilast+2, jfirst:jlast)
    INTEGER :: i, j, ie3, is1, ie1
    REAL(fvprc) :: xt, pmp_1, lac_1, pmp_2, lac_2
    INTEGER :: is, ie, js, je, isd, ied, jsd, jed
    INTRINSIC MAX
    INTRINSIC MIN
    REAL(fvprc) :: temp_ad
    REAL(fvprc) :: temp_ad0
    REAL(fvprc) :: temp_ad1
    REAL(fvprc) :: temp_ad2
    INTEGER :: branch
    REAL(fvprc) :: temp
    REAL(fvprc) :: temp_ad3
    REAL(fvprc) :: temp_ad4
    REAL(fvprc) :: temp0
    REAL(fvprc) :: temp_ad5
    REAL(fvprc) :: temp_ad6
    CALL POPINTEGER(ie3)
    CALL POPREALARRAY(br, 8*(ilast-ifirst+3)*(jlast-jfirst+1)/8)
    CALL POPREALARRAY(bl, 8*(ilast-ifirst+3)*(jlast-jfirst+1)/8)
    CALL POPINTEGER(is1)
    bl_ad = 0.0_FVPRC
    br_ad = 0.0_FVPRC
    CALL POPREALARRAY(flux, 8*(ilast-ifirst+2)*(jlast-jfirst+1)/8)
    DO j=jfirst,jlast
      DO i=ifirst,ilast+1
        IF (c(i, j) .GT. 0.) THEN
          CALL PUSHCONTROL1B_FV(1)
        ELSE
          CALL PUSHCONTROL1B_FV(0)
        END IF
      END DO
      DO i=ilast+1,ifirst,-1
        CALL POPCONTROL1B_FV(branch)
        IF (branch .EQ. 0) THEN
          temp0 = bl(i, j) + br(i, j)
          temp_ad5 = (c(i, j)+1.)*flux_ad(i, j)
          temp_ad6 = c(i, j)*temp_ad5
          q_ad(i, j) = q_ad(i, j) + flux_ad(i, j)
          c_ad(i, j) = c_ad(i, j) + temp0*temp_ad5 + (bl(i, j)+c(i, j)*&
&           temp0)*flux_ad(i, j)
          bl_ad(i, j) = bl_ad(i, j) + temp_ad6 + temp_ad5
          br_ad(i, j) = br_ad(i, j) + temp_ad6
          flux_ad(i, j) = 0.0_FVPRC
        ELSE
          temp = bl(i-1, j) + br(i-1, j)
          temp_ad3 = (1.-c(i, j))*flux_ad(i, j)
          temp_ad4 = -(c(i, j)*temp_ad3)
          q_ad(i-1, j) = q_ad(i-1, j) + flux_ad(i, j)
          c_ad(i, j) = c_ad(i, j) - temp*temp_ad3 - (br(i-1, j)-c(i, j)*&
&           temp)*flux_ad(i, j)
          br_ad(i-1, j) = br_ad(i-1, j) + temp_ad4 + temp_ad3
          bl_ad(i-1, j) = bl_ad(i-1, j) + temp_ad4
          flux_ad(i, j) = 0.0_FVPRC
        END IF
      END DO
    END DO
    al_ad = 0.0_FVPRC
    DO j=jlast,jfirst,-1
      DO i=ilast+1,ifirst-1,-1
        al_ad(i+1, j) = al_ad(i+1, j) + br_ad(i, j)
        q_ad(i, j) = q_ad(i, j) - bl_ad(i, j) - br_ad(i, j)
        br_ad(i, j) = 0.0_FVPRC
        al_ad(i, j) = al_ad(i, j) + bl_ad(i, j)
        bl_ad(i, j) = 0.0_FVPRC
      END DO
    END DO
    DO j=jlast,jfirst,-1
      CALL POPCONTROL2B_FV(branch)
      IF (branch .NE. 0) THEN
        IF (branch .NE. 1) THEN
          q_ad(npx, j) = q_ad(npx, j) + c3*al_ad(npx+1, j)
          q_ad(npx+1, j) = q_ad(npx+1, j) + c2*al_ad(npx+1, j)
          q_ad(npx+2, j) = q_ad(npx+2, j) + c1*al_ad(npx+1, j)
          al_ad(npx+1, j) = 0.0_FVPRC
          temp_ad1 = 0.5*al_ad(npx, j)/(dxa(npx-2, j)+dxa(npx-1, j))
          temp_ad2 = 0.5*al_ad(npx, j)/(dxa(npx, j)+dxa(npx+1, j))
          q_ad(npx-1, j) = q_ad(npx-1, j) + (dxa(npx-1, j)*2.+dxa(npx-2&
&           , j))*temp_ad1
          q_ad(npx-2, j) = q_ad(npx-2, j) - dxa(npx-1, j)*temp_ad1
          q_ad(npx, j) = q_ad(npx, j) + (dxa(npx, j)*2.+dxa(npx+1, j))*&
&           temp_ad2
          q_ad(npx+1, j) = q_ad(npx+1, j) - dxa(npx, j)*temp_ad2
          al_ad(npx, j) = 0.0_FVPRC
          q_ad(npx-3, j) = q_ad(npx-3, j) + c1*al_ad(npx-1, j)
          q_ad(npx-2, j) = q_ad(npx-2, j) + c2*al_ad(npx-1, j)
          q_ad(npx-1, j) = q_ad(npx-1, j) + c3*al_ad(npx-1, j)
          al_ad(npx-1, j) = 0.0_FVPRC
        END IF
        CALL POPCONTROL1B_FV(branch)
        IF (branch .EQ. 0) THEN
          q_ad(1, j) = q_ad(1, j) + c3*al_ad(2, j)
          q_ad(2, j) = q_ad(2, j) + c2*al_ad(2, j)
          q_ad(3, j) = q_ad(3, j) + c1*al_ad(2, j)
          al_ad(2, j) = 0.0_FVPRC
          temp_ad = 0.5*al_ad(1, j)/(dxa(-1, j)+dxa(0, j))
          temp_ad0 = 0.5*al_ad(1, j)/(dxa(1, j)+dxa(2, j))
          q_ad(0, j) = q_ad(0, j) + (dxa(0, j)*2.+dxa(-1, j))*temp_ad
          q_ad(-1, j) = q_ad(-1, j) - dxa(0, j)*temp_ad
          q_ad(1, j) = q_ad(1, j) + (dxa(1, j)*2.+dxa(2, j))*temp_ad0
          q_ad(2, j) = q_ad(2, j) - dxa(1, j)*temp_ad0
          al_ad(1, j) = 0.0_FVPRC
          q_ad(-2, j) = q_ad(-2, j) + c1*al_ad(0, j)
          q_ad(-1, j) = q_ad(-1, j) + c2*al_ad(0, j)
          q_ad(0, j) = q_ad(0, j) + c3*al_ad(0, j)
          al_ad(0, j) = 0.0_FVPRC
        END IF
      END IF
    END DO
    DO j=jlast,jfirst,-1
      DO i=ie3,is1,-1
        q_ad(i-1, j) = q_ad(i-1, j) + p1*al_ad(i, j)
        q_ad(i, j) = q_ad(i, j) + p1*al_ad(i, j)
        q_ad(i-2, j) = q_ad(i-2, j) + p2*al_ad(i, j)
        q_ad(i+1, j) = q_ad(i+1, j) + p2*al_ad(i, j)
        al_ad(i, j) = 0.0_FVPRC
      END DO
    END DO
    CALL POPCONTROL1B_FV(branch)
  END SUBROUTINE XPPM0_BWD
!  Differentiation of yppm0 in reverse (adjoint) mode, forward sweep (with options r8 split(a2b_edge_mod.a2b_ord2 a2b_edge_mod
!.a2b_ord4 a2b_edge_mod.extrap_corner  dyn_core_mod.dyn_core dyn_core_mod.pk3_halo dyn_core_mod.pln_halo dyn_core_mod.pe_ha
!lo dyn_core_mod.adv_pe dyn_core_mod.p_grad_c dyn_core_mod.nh_p_grad dyn_core_mod.split_p_grad dyn_core_mod.one_grad_p dyn_core_m
!od.grad1_p_update dyn_core_mod.mix_dp dyn_core_mod.geopk dyn_core_mod.del2_cubed fv_dynamics_mod.fv_dynamics fv_dynamics_mod.ray
!leigh_super fv_dynamics_mod.rayleigh_friction fv_dynamics_mod.compute_aam fv_dynamics_mod.geos_to_fv3 fv_grid_utils_mod.cubed_to
!_latlon fv_grid_utils_mod.c2l_ord4 fv_grid_utils_mod.c2l_ord2 fv_mapz_mod.lagrangian_to_eulerian fv_mapz_mod.compute_total_energ
!y fv_mapz_mod.pkez fv_mapz_mod.remap_z fv_mapz_mod.map_scalar fv_mapz_mod.map1_ppm fv_mapz_mod.mapn_tracer fv_mapz_m
!od.map1_q2 fv_mapz_mod.map1_cubic fv_mapz_mod.scalar_profile_linear fv_mapz_mod.cs_profile_linear fv_mapz_mod.steepz fv
!_tracer2d_mod.tracer_2d fv_tracer2d_mod.tracer_2d_nested nh_core_mod.update_dz_c nh_core_mod.update_dz_d nh_core_mod.riem_solver
!_c nh_core_mod.riem_solver3 nh_core_mod.rim_2d nh_core_mod.sim3_solver nh_core_mod.sim3p0_solver nh_core_mod.sim1_solver nh_core
!_mod.sim_solver nh_core_mod.edge_profile sw_core_mod.c_sw sw_core_mod.d_sw sw_core_mod.divergence_corner sw_core_mod.divergence_
!corner_nest sw_core_mod.d2a2c_vect sw_core_mod.edge_interpolate4 sw_core_mod.fill2_4corners sw_core_mod.fill_4corners sw_core_mo
!d.compute_div_damping sw_core_mod.smag_corner sw_core_mod.ytp_v sw_core_mod.xtp_u tp_core_mod.fv_tp_2d tp_core_mo
!d.copy_corners tp_core_mod.xtp tp_core_mod.ytp tp_core_mod.xppm0 tp_core_mod.yppm0 tp_core_mod.fxppm tp_core_m
!od.fyppm tp_core_mod.deln_flux)):
!   gradient     of useful results: q flux c
!   with respect to varying inputs: q flux c
  SUBROUTINE YPPM0_FWD(flux, q, c, jord, ifirst, ilast, jfirst, jlast&
&   , npx, npy, bd, dya, nested, grid_type)
    IMPLICIT NONE
    TYPE(FV_GRID_BOUNDS_TYPE), INTENT(IN) :: bd
!  X-Dir strip
    INTEGER, INTENT(IN) :: ifirst, ilast
!  Y-Dir strip
    INTEGER, INTENT(IN) :: jfirst, jlast
    INTEGER, INTENT(IN) :: jord
    INTEGER, INTENT(IN) :: npx, npy
    REAL(fvprc), INTENT(IN) :: q(ifirst:ilast, jfirst-ng:jlast+ng)
! Courant number
    REAL(fvprc), INTENT(IN) :: c(bd%isd:bd%ied, bd%js:bd%je+1)
!  Flux
    REAL(fvprc) :: flux(ifirst:ilast, jfirst:jlast+1)
    REAL(fvprc), INTENT(IN) :: dya(bd%isd:bd%ied, bd%jsd:bd%jed)
    LOGICAL, INTENT(IN) :: nested
    INTEGER, INTENT(IN) :: grid_type
! Local:
    REAL(fvprc) :: al(ifirst:ilast, jfirst-1:jlast+2)
    REAL(fvprc) :: bl(ifirst:ilast, jfirst-1:jlast+1)
    REAL(fvprc) :: br(ifirst:ilast, jfirst-1:jlast+1)
    REAL(fvprc) :: xt, pmp_1, lac_1, pmp_2, lac_2
    INTEGER :: i, j, js1, je3, je1
    INTEGER :: is, ie, js, je, isd, ied, jsd, jed
    INTRINSIC MAX
    INTRINSIC MIN
    IF (.NOT.nested .AND. grid_type .LT. 3) THEN
      IF (3 .LT. bd%js - 1) THEN
        js1 = bd%js - 1
      ELSE
        js1 = 3
      END IF
      IF (npy - 2 .GT. bd%je + 2) THEN
        CALL PUSHCONTROL1B_FV(1)
        je3 = bd%je + 2
      ELSE
        CALL PUSHCONTROL1B_FV(1)
        je3 = npy - 2
      END IF
    ELSE
      CALL PUSHCONTROL1B_FV(0)
! Nested grid OR Doubly periodic domain:
      js1 = bd%js - 1
      je3 = bd%je + 2
    END IF
! ord = -5: linear scheme based on PPM 4th order interpolation
    DO j=js1,je3
      DO i=ifirst,ilast
        al(i, j) = p1*(q(i, j-1)+q(i, j)) + p2*(q(i, j-2)+q(i, j+1))
      END DO
    END DO
    IF (.NOT.nested .AND. grid_type .LT. 3) THEN
      IF (bd%js .EQ. 1) THEN
        DO i=ifirst,ilast
          al(i, 0) = c1*q(i, -2) + c2*q(i, -1) + c3*q(i, 0)
          al(i, 1) = 0.5*(((2.*dya(i, 0)+dya(i, -1))*q(i, 0)-dya(i, 0)*q&
&           (i, -1))/(dya(i, -1)+dya(i, 0))+((2.*dya(i, 1)+dya(i, 2))*q(&
&           i, 1)-dya(i, 1)*q(i, 2))/(dya(i, 1)+dya(i, 2)))
          al(i, 2) = c3*q(i, 1) + c2*q(i, 2) + c1*q(i, 3)
        END DO
        CALL PUSHCONTROL1B_FV(0)
      ELSE
        CALL PUSHCONTROL1B_FV(1)
      END IF
      IF (bd%je + 1 .EQ. npy) THEN
        DO i=ifirst,ilast
          al(i, npy-1) = c1*q(i, npy-3) + c2*q(i, npy-2) + c3*q(i, npy-1&
&           )
          al(i, npy) = 0.5*(((2.*dya(i, npy-1)+dya(i, npy-2))*q(i, npy-1&
&           )-dya(i, npy-1)*q(i, npy-2))/(dya(i, npy-2)+dya(i, npy-1))+(&
&           (2.*dya(i, npy)+dya(i, npy+1))*q(i, npy)-dya(i, npy)*q(i, &
&           npy+1))/(dya(i, npy)+dya(i, npy+1)))
          al(i, npy+1) = c3*q(i, npy) + c2*q(i, npy+1) + c1*q(i, npy+2)
        END DO
        CALL PUSHCONTROL2B_FV(2)
      ELSE
        CALL PUSHCONTROL2B_FV(1)
      END IF
    ELSE
      CALL PUSHCONTROL2B_FV(0)
    END IF
    DO j=jfirst-1,jlast+1
      DO i=ifirst,ilast
        bl(i, j) = al(i, j) - q(i, j)
        br(i, j) = al(i, j+1) - q(i, j)
      END DO
    END DO
    CALL PUSHREALARRAY(flux, 8*(ilast-ifirst+1)*(jlast-jfirst+2)/8)
    DO j=jfirst,jlast+1
      DO i=ifirst,ilast
        IF (c(i, j) .GT. 0.) THEN
          flux(i, j) = q(i, j-1) + (1.-c(i, j))*(br(i, j-1)-c(i, j)*(bl(&
&           i, j-1)+br(i, j-1)))
        ELSE
          flux(i, j) = q(i, j) + (1.+c(i, j))*(bl(i, j)+c(i, j)*(bl(i, j&
&           )+br(i, j)))
        END IF
      END DO
    END DO
    CALL PUSHREALARRAY(bl, 8*(ilast-ifirst+1)*(jlast-jfirst+3)/8)
    CALL PUSHINTEGER(je3)
    CALL PUSHREALARRAY(br, 8*(ilast-ifirst+1)*(jlast-jfirst+3)/8)
    CALL PUSHINTEGER(js1)
  END SUBROUTINE YPPM0_FWD
!  Differentiation of yppm0 in reverse (adjoint) mode, backward sweep (with options r8 split(a2b_edge_mod.a2b_ord2 a2b_edge_mo
!d.a2b_ord4 a2b_edge_mod.extrap_corner  dyn_core_mod.dyn_core dyn_core_mod.pk3_halo dyn_core_mod.pln_halo dyn_core_mod.pe_h
!alo dyn_core_mod.adv_pe dyn_core_mod.p_grad_c dyn_core_mod.nh_p_grad dyn_core_mod.split_p_grad dyn_core_mod.one_grad_p dyn_core_
!mod.grad1_p_update dyn_core_mod.mix_dp dyn_core_mod.geopk dyn_core_mod.del2_cubed fv_dynamics_mod.fv_dynamics fv_dynamics_mod.ra
!yleigh_super fv_dynamics_mod.rayleigh_friction fv_dynamics_mod.compute_aam fv_dynamics_mod.geos_to_fv3 fv_grid_utils_mod.cubed_t
!o_latlon fv_grid_utils_mod.c2l_ord4 fv_grid_utils_mod.c2l_ord2 fv_mapz_mod.lagrangian_to_eulerian fv_mapz_mod.compute_total_ener
!gy fv_mapz_mod.pkez fv_mapz_mod.remap_z fv_mapz_mod.map_scalar fv_mapz_mod.map1_ppm fv_mapz_mod.mapn_tracer fv_mapz_
!mod.map1_q2 fv_mapz_mod.map1_cubic fv_mapz_mod.scalar_profile_linear fv_mapz_mod.cs_profile_linear fv_mapz_mod.steepz f
!v_tracer2d_mod.tracer_2d fv_tracer2d_mod.tracer_2d_nested nh_core_mod.update_dz_c nh_core_mod.update_dz_d nh_core_mod.riem_solve
!r_c nh_core_mod.riem_solver3 nh_core_mod.rim_2d nh_core_mod.sim3_solver nh_core_mod.sim3p0_solver nh_core_mod.sim1_solver nh_cor
!e_mod.sim_solver nh_core_mod.edge_profile sw_core_mod.c_sw sw_core_mod.d_sw sw_core_mod.divergence_corner sw_core_mod.divergence
!_corner_nest sw_core_mod.d2a2c_vect sw_core_mod.edge_interpolate4 sw_core_mod.fill2_4corners sw_core_mod.fill_4corners sw_core_m
!od.compute_div_damping sw_core_mod.smag_corner sw_core_mod.ytp_v sw_core_mod.xtp_u tp_core_mod.fv_tp_2d tp_core_m
!od.copy_corners tp_core_mod.xtp tp_core_mod.ytp tp_core_mod.xppm0 tp_core_mod.yppm0 tp_core_mod.fxppm tp_core_
!mod.fyppm tp_core_mod.deln_flux)):
!   gradient     of useful results: q flux c
!   with respect to varying inputs: q flux c
  SUBROUTINE YPPM0_BWD(flux, flux_ad, q, q_ad, c, c_ad, jord, ifirst&
&   , ilast, jfirst, jlast, npx, npy, bd, dya, nested, grid_type)
    IMPLICIT NONE
    TYPE(FV_GRID_BOUNDS_TYPE), INTENT(IN) :: bd
    INTEGER, INTENT(IN) :: ifirst, ilast
    INTEGER, INTENT(IN) :: jfirst, jlast
    INTEGER, INTENT(IN) :: jord
    INTEGER, INTENT(IN) :: npx, npy
    REAL(fvprc), INTENT(IN) :: q(ifirst:ilast, jfirst-ng:jlast+ng)
    REAL(fvprc) :: q_ad(ifirst:ilast, jfirst-ng:jlast+ng)
    REAL(fvprc), INTENT(IN) :: c(bd%isd:bd%ied, bd%js:bd%je+1)
    REAL(fvprc) :: c_ad(bd%isd:bd%ied, bd%js:bd%je+1)
    REAL(fvprc) :: flux(ifirst:ilast, jfirst:jlast+1)
    REAL(fvprc) :: flux_ad(ifirst:ilast, jfirst:jlast+1)
    REAL(fvprc), INTENT(IN) :: dya(bd%isd:bd%ied, bd%jsd:bd%jed)
    LOGICAL, INTENT(IN) :: nested
    INTEGER, INTENT(IN) :: grid_type
    REAL(fvprc) :: al(ifirst:ilast, jfirst-1:jlast+2)
    REAL(fvprc) :: al_ad(ifirst:ilast, jfirst-1:jlast+2)
    REAL(fvprc) :: bl(ifirst:ilast, jfirst-1:jlast+1)
    REAL(fvprc) :: bl_ad(ifirst:ilast, jfirst-1:jlast+1)
    REAL(fvprc) :: br(ifirst:ilast, jfirst-1:jlast+1)
    REAL(fvprc) :: br_ad(ifirst:ilast, jfirst-1:jlast+1)
    REAL(fvprc) :: xt, pmp_1, lac_1, pmp_2, lac_2
    INTEGER :: i, j, js1, je3, je1
    INTEGER :: is, ie, js, je, isd, ied, jsd, jed
    INTRINSIC MAX
    INTRINSIC MIN
    REAL(fvprc) :: temp_ad
    REAL(fvprc) :: temp_ad0
    REAL(fvprc) :: temp_ad1
    REAL(fvprc) :: temp_ad2
    REAL(fvprc) :: temp
    REAL(fvprc) :: temp_ad3
    REAL(fvprc) :: temp_ad4
    REAL(fvprc) :: temp0
    REAL(fvprc) :: temp_ad5
    REAL(fvprc) :: temp_ad6
    INTEGER :: branch
    CALL POPINTEGER(js1)
    CALL POPREALARRAY(br, 8*(ilast-ifirst+1)*(jlast-jfirst+3)/8)
    CALL POPINTEGER(je3)
    CALL POPREALARRAY(bl, 8*(ilast-ifirst+1)*(jlast-jfirst+3)/8)
    bl_ad = 0.0_FVPRC
    br_ad = 0.0_FVPRC
    CALL POPREALARRAY(flux, 8*(ilast-ifirst+1)*(jlast-jfirst+2)/8)
    DO j=jfirst,jlast+1
      DO i=ifirst,ilast
        IF (c(i, j) .GT. 0.) THEN
          CALL PUSHCONTROL1B_FV(1)
        ELSE
          CALL PUSHCONTROL1B_FV(0)
        END IF
      END DO
      DO i=ilast,ifirst,-1
        CALL POPCONTROL1B_FV(branch)
        IF (branch .EQ. 0) THEN
          temp0 = bl(i, j) + br(i, j)
          temp_ad5 = (c(i, j)+1.)*flux_ad(i, j)
          temp_ad6 = c(i, j)*temp_ad5
          q_ad(i, j) = q_ad(i, j) + flux_ad(i, j)
          c_ad(i, j) = c_ad(i, j) + temp0*temp_ad5 + (bl(i, j)+c(i, j)*&
&           temp0)*flux_ad(i, j)
          bl_ad(i, j) = bl_ad(i, j) + temp_ad6 + temp_ad5
          br_ad(i, j) = br_ad(i, j) + temp_ad6
          flux_ad(i, j) = 0.0_FVPRC
        ELSE
          temp = bl(i, j-1) + br(i, j-1)
          temp_ad3 = (1.-c(i, j))*flux_ad(i, j)
          temp_ad4 = -(c(i, j)*temp_ad3)
          q_ad(i, j-1) = q_ad(i, j-1) + flux_ad(i, j)
          c_ad(i, j) = c_ad(i, j) - temp*temp_ad3 - (br(i, j-1)-c(i, j)*&
&           temp)*flux_ad(i, j)
          br_ad(i, j-1) = br_ad(i, j-1) + temp_ad4 + temp_ad3
          bl_ad(i, j-1) = bl_ad(i, j-1) + temp_ad4
          flux_ad(i, j) = 0.0_FVPRC
        END IF
      END DO
    END DO
    al_ad = 0.0_FVPRC
    DO j=jlast+1,jfirst-1,-1
      DO i=ilast,ifirst,-1
        al_ad(i, j+1) = al_ad(i, j+1) + br_ad(i, j)
        q_ad(i, j) = q_ad(i, j) - bl_ad(i, j) - br_ad(i, j)
        br_ad(i, j) = 0.0_FVPRC
        al_ad(i, j) = al_ad(i, j) + bl_ad(i, j)
        bl_ad(i, j) = 0.0_FVPRC
      END DO
    END DO
    CALL POPCONTROL2B_FV(branch)
    IF (branch .NE. 0) THEN
      IF (branch .NE. 1) THEN
        DO i=ilast,ifirst,-1
          q_ad(i, npy) = q_ad(i, npy) + c3*al_ad(i, npy+1)
          q_ad(i, npy+1) = q_ad(i, npy+1) + c2*al_ad(i, npy+1)
          q_ad(i, npy+2) = q_ad(i, npy+2) + c1*al_ad(i, npy+1)
          al_ad(i, npy+1) = 0.0_FVPRC
          temp_ad1 = 0.5*al_ad(i, npy)/(dya(i, npy-2)+dya(i, npy-1))
          temp_ad2 = 0.5*al_ad(i, npy)/(dya(i, npy)+dya(i, npy+1))
          q_ad(i, npy-1) = q_ad(i, npy-1) + (dya(i, npy-1)*2.+dya(i, npy&
&           -2))*temp_ad1
          q_ad(i, npy-2) = q_ad(i, npy-2) - dya(i, npy-1)*temp_ad1
          q_ad(i, npy) = q_ad(i, npy) + (dya(i, npy)*2.+dya(i, npy+1))*&
&           temp_ad2
          q_ad(i, npy+1) = q_ad(i, npy+1) - dya(i, npy)*temp_ad2
          al_ad(i, npy) = 0.0_FVPRC
          q_ad(i, npy-3) = q_ad(i, npy-3) + c1*al_ad(i, npy-1)
          q_ad(i, npy-2) = q_ad(i, npy-2) + c2*al_ad(i, npy-1)
          q_ad(i, npy-1) = q_ad(i, npy-1) + c3*al_ad(i, npy-1)
          al_ad(i, npy-1) = 0.0_FVPRC
        END DO
      END IF
      CALL POPCONTROL1B_FV(branch)
      IF (branch .EQ. 0) THEN
        DO i=ilast,ifirst,-1
          q_ad(i, 1) = q_ad(i, 1) + c3*al_ad(i, 2)
          q_ad(i, 2) = q_ad(i, 2) + c2*al_ad(i, 2)
          q_ad(i, 3) = q_ad(i, 3) + c1*al_ad(i, 2)
          al_ad(i, 2) = 0.0_FVPRC
          temp_ad = 0.5*al_ad(i, 1)/(dya(i, -1)+dya(i, 0))
          temp_ad0 = 0.5*al_ad(i, 1)/(dya(i, 1)+dya(i, 2))
          q_ad(i, 0) = q_ad(i, 0) + (dya(i, 0)*2.+dya(i, -1))*temp_ad
          q_ad(i, -1) = q_ad(i, -1) - dya(i, 0)*temp_ad
          q_ad(i, 1) = q_ad(i, 1) + (dya(i, 1)*2.+dya(i, 2))*temp_ad0
          q_ad(i, 2) = q_ad(i, 2) - dya(i, 1)*temp_ad0
          al_ad(i, 1) = 0.0_FVPRC
          q_ad(i, -2) = q_ad(i, -2) + c1*al_ad(i, 0)
          q_ad(i, -1) = q_ad(i, -1) + c2*al_ad(i, 0)
          q_ad(i, 0) = q_ad(i, 0) + c3*al_ad(i, 0)
          al_ad(i, 0) = 0.0_FVPRC
        END DO
      END IF
    END IF
    DO j=je3,js1,-1
      DO i=ilast,ifirst,-1
        q_ad(i, j-1) = q_ad(i, j-1) + p1*al_ad(i, j)
        q_ad(i, j) = q_ad(i, j) + p1*al_ad(i, j)
        q_ad(i, j-2) = q_ad(i, j-2) + p2*al_ad(i, j)
        q_ad(i, j+1) = q_ad(i, j+1) + p2*al_ad(i, j)
        al_ad(i, j) = 0.0_FVPRC
      END DO
    END DO
    CALL POPCONTROL1B_FV(branch)
  END SUBROUTINE YPPM0_BWD
!  Differentiation of fxppm in reverse (adjoint) mode, forward sweep (with options r8 split(a2b_edge_mod.a2b_ord2 a2b_edge_mod
!.a2b_ord4 a2b_edge_mod.extrap_corner  dyn_core_mod.dyn_core dyn_core_mod.pk3_halo dyn_core_mod.pln_halo dyn_core_mod.pe_ha
!lo dyn_core_mod.adv_pe dyn_core_mod.p_grad_c dyn_core_mod.nh_p_grad dyn_core_mod.split_p_grad dyn_core_mod.one_grad_p dyn_core_m
!od.grad1_p_update dyn_core_mod.mix_dp dyn_core_mod.geopk dyn_core_mod.del2_cubed fv_dynamics_mod.fv_dynamics fv_dynamics_mod.ray
!leigh_super fv_dynamics_mod.rayleigh_friction fv_dynamics_mod.compute_aam fv_dynamics_mod.geos_to_fv3 fv_grid_utils_mod.cubed_to
!_latlon fv_grid_utils_mod.c2l_ord4 fv_grid_utils_mod.c2l_ord2 fv_mapz_mod.lagrangian_to_eulerian fv_mapz_mod.compute_total_energ
!y fv_mapz_mod.pkez fv_mapz_mod.remap_z fv_mapz_mod.map_scalar fv_mapz_mod.map1_ppm fv_mapz_mod.mapn_tracer fv_mapz_m
!od.map1_q2 fv_mapz_mod.map1_cubic fv_mapz_mod.scalar_profile_linear fv_mapz_mod.cs_profile_linear fv_mapz_mod.steepz fv
!_tracer2d_mod.tracer_2d fv_tracer2d_mod.tracer_2d_nested nh_core_mod.update_dz_c nh_core_mod.update_dz_d nh_core_mod.riem_solver
!_c nh_core_mod.riem_solver3 nh_core_mod.rim_2d nh_core_mod.sim3_solver nh_core_mod.sim3p0_solver nh_core_mod.sim1_solver nh_core
!_mod.sim_solver nh_core_mod.edge_profile sw_core_mod.c_sw sw_core_mod.d_sw sw_core_mod.divergence_corner sw_core_mod.divergence_
!corner_nest sw_core_mod.d2a2c_vect sw_core_mod.edge_interpolate4 sw_core_mod.fill2_4corners sw_core_mod.fill_4corners sw_core_mo
!d.compute_div_damping sw_core_mod.smag_corner sw_core_mod.ytp_v sw_core_mod.xtp_u tp_core_mod.fv_tp_2d tp_core_mo
!d.copy_corners tp_core_mod.xtp tp_core_mod.ytp tp_core_mod.xppm0 tp_core_mod.yppm0 tp_core_mod.fxppm tp_core_m
!od.fyppm tp_core_mod.deln_flux)):
!   gradient     of useful results: q flux c
!   with respect to varying inputs: q flux c
  SUBROUTINE FXPPM_FWD(c, q, flux, iord, ifirst, ilast, jfirst, jlast&
&   , npx, npy, bd, dxa, nested, grid_type)
    IMPLICIT NONE
! !INPUT PARAMETERS:
    TYPE(FV_GRID_BOUNDS_TYPE), INTENT(IN) :: bd
!  X-Dir strip
    INTEGER, INTENT(IN) :: ifirst, ilast
!  Y-Dir strip
    INTEGER, INTENT(IN) :: jfirst, jlast
    INTEGER, INTENT(IN) :: iord
    INTEGER, INTENT(IN) :: npx, npy
    REAL(fvprc), INTENT(IN) :: q(ifirst-ng:ilast+ng, jfirst:jlast)
! Courant   N (like FLUX)
    REAL(fvprc), INTENT(IN) :: c(ifirst:ilast+1, jfirst:jlast)
    REAL(fvprc), INTENT(IN) :: dxa(bd%isd:bd%ied, bd%jsd:bd%jed)
    LOGICAL, INTENT(IN) :: nested
    INTEGER, INTENT(IN) :: grid_type
! !OUTPUT PARAMETERS:
!  Flux
    REAL(fvprc) :: flux(ifirst:ilast+1, jfirst:jlast)
! Local
    REAL(fvprc) :: dl, dr, pmp, lac, ct, qe
    REAL(fvprc) :: pmp_1, lac_1, pmp_2, lac_2
    REAL(fvprc) :: xt, x1, x0, x0l, x0r
    INTEGER :: i, j, is3, ie3, it
    REAL(fvprc) :: bl6(ifirst-1:ilast+1, jfirst:jlast)
    REAL(fvprc) :: br6(ifirst-1:ilast+1, jfirst:jlast)
    INTEGER :: is, ie, js, je, isd, ied, jsd, jed
    INTRINSIC MAX
    INTRINSIC MIN
    IF (nested) THEN
      CALL PUSHCONTROL1B_FV(1)
      is3 = bd%is - 1
      ie3 = bd%ie + 1
    ELSE
      IF (3 .LT. bd%is - 1) THEN
        is3 = bd%is - 1
      ELSE
        is3 = 3
      END IF
      IF (npx - 3 .GT. bd%ie + 1) THEN
        CALL PUSHCONTROL1B_FV(0)
        ie3 = bd%ie + 1
      ELSE
        CALL PUSHCONTROL1B_FV(0)
        ie3 = npx - 3
      END IF
    END IF
    DO j=jfirst,jlast
      DO i=is3,ie3
        bl6(i, j) = b5*q(i-2, j) + b4*q(i-1, j) + b3*q(i, j) + b2*q(i+1&
&         , j) + b1*q(i+2, j)
        br6(i, j) = b1*q(i-2, j) + b2*q(i-1, j) + b3*q(i, j) + b4*q(i+1&
&         , j) + b5*q(i+2, j)
      END DO
    END DO
!--------------
! fix the edges
!--------------
    DO j=jfirst,jlast
      IF (.NOT.nested) THEN
        IF (bd%is .EQ. 1) THEN
          x0l = 0.5*((2.*dxa(0, j)+dxa(-1, j))*q(0, j)-dxa(0, j)*q(-1, j&
&           ))/(dxa(0, j)+dxa(-1, j))
          x0r = 0.5*((2.*dxa(1, j)+dxa(2, j))*q(1, j)-dxa(1, j)*q(2, j))&
&           /(dxa(1, j)+dxa(2, j))
          br6(2, j) = p1*(q(2, j)+q(3, j)) + p2*(q(1, j)+q(4, j)) - q(2&
&           , j)
          xt = x0l + x0r
          bl6(1, j) = xt - q(1, j)
          br6(0, j) = xt - q(0, j)
          xt = c1*q(-2, j) + c2*q(-1, j) + c3*q(0, j)
          bl6(0, j) = xt - q(0, j)
          xt = c3*q(1, j) + c2*q(2, j) + c1*q(3, j)
          br6(1, j) = xt - q(1, j)
          bl6(2, j) = xt - q(2, j)
          CALL PUSHCONTROL1B_FV(0)
        ELSE
          CALL PUSHCONTROL1B_FV(1)
        END IF
        IF (bd%ie + 1 .EQ. npx) THEN
          x0l = 0.5*((2.*dxa(npx-1, j)+dxa(npx-2, j))*q(npx-1, j)-dxa(&
&           npx-1, j)*q(npx-2, j))/(dxa(npx-1, j)+dxa(npx-2, j))
          x0r = 0.5*((2.*dxa(npx, j)+dxa(npx+1, j))*q(npx, j)-dxa(npx, j&
&           )*q(npx+1, j))/(dxa(npx, j)+dxa(npx+1, j))
          bl6(npx-2, j) = p1*(q(npx-2, j)+q(npx-3, j)) + p2*(q(npx-4, j)&
&           +q(npx-1, j)) - q(npx-2, j)
          xt = x0l + x0r
          br6(npx-1, j) = xt - q(npx-1, j)
          bl6(npx, j) = xt - q(npx, j)
          xt = c3*q(npx, j) + c2*q(npx+1, j) + c1*q(npx+2, j)
          br6(npx, j) = xt - q(npx, j)
          xt = c1*q(npx-3, j) + c2*q(npx-2, j) + c3*q(npx-1, j)
          br6(npx-2, j) = xt - q(npx-2, j)
          bl6(npx-1, j) = xt - q(npx-1, j)
          CALL PUSHCONTROL2B_FV(2)
        ELSE
          CALL PUSHCONTROL2B_FV(1)
        END IF
      ELSE
        CALL PUSHCONTROL2B_FV(0)
      END IF
    END DO
    CALL PUSHREALARRAY(flux, 8*(ilast-ifirst+2)*(jlast-jfirst+1)/8)
    DO j=jfirst,jlast
      DO i=ifirst,ilast+1
        IF (c(i, j) .GT. 0.) THEN
          flux(i, j) = q(i-1, j) + (1.-c(i, j))*(br6(i-1, j)-c(i, j)*(&
&           bl6(i-1, j)+br6(i-1, j)))
        ELSE
          flux(i, j) = q(i, j) + (1.+c(i, j))*(bl6(i, j)+c(i, j)*(bl6(i&
&           , j)+br6(i, j)))
        END IF
      END DO
    END DO
    CALL PUSHINTEGER(is3)
    CALL PUSHREALARRAY(br6, 8*(ilast-ifirst+3)*(jlast-jfirst+1)/8)
    CALL PUSHREALARRAY(bl6, 8*(ilast-ifirst+3)*(jlast-jfirst+1)/8)
    CALL PUSHINTEGER(ie3)
  END SUBROUTINE FXPPM_FWD
!  Differentiation of fxppm in reverse (adjoint) mode, backward sweep (with options r8 split(a2b_edge_mod.a2b_ord2 a2b_edge_mo
!d.a2b_ord4 a2b_edge_mod.extrap_corner  dyn_core_mod.dyn_core dyn_core_mod.pk3_halo dyn_core_mod.pln_halo dyn_core_mod.pe_h
!alo dyn_core_mod.adv_pe dyn_core_mod.p_grad_c dyn_core_mod.nh_p_grad dyn_core_mod.split_p_grad dyn_core_mod.one_grad_p dyn_core_
!mod.grad1_p_update dyn_core_mod.mix_dp dyn_core_mod.geopk dyn_core_mod.del2_cubed fv_dynamics_mod.fv_dynamics fv_dynamics_mod.ra
!yleigh_super fv_dynamics_mod.rayleigh_friction fv_dynamics_mod.compute_aam fv_dynamics_mod.geos_to_fv3 fv_grid_utils_mod.cubed_t
!o_latlon fv_grid_utils_mod.c2l_ord4 fv_grid_utils_mod.c2l_ord2 fv_mapz_mod.lagrangian_to_eulerian fv_mapz_mod.compute_total_ener
!gy fv_mapz_mod.pkez fv_mapz_mod.remap_z fv_mapz_mod.map_scalar fv_mapz_mod.map1_ppm fv_mapz_mod.mapn_tracer fv_mapz_
!mod.map1_q2 fv_mapz_mod.map1_cubic fv_mapz_mod.scalar_profile_linear fv_mapz_mod.cs_profile_linear fv_mapz_mod.steepz f
!v_tracer2d_mod.tracer_2d fv_tracer2d_mod.tracer_2d_nested nh_core_mod.update_dz_c nh_core_mod.update_dz_d nh_core_mod.riem_solve
!r_c nh_core_mod.riem_solver3 nh_core_mod.rim_2d nh_core_mod.sim3_solver nh_core_mod.sim3p0_solver nh_core_mod.sim1_solver nh_cor
!e_mod.sim_solver nh_core_mod.edge_profile sw_core_mod.c_sw sw_core_mod.d_sw sw_core_mod.divergence_corner sw_core_mod.divergence
!_corner_nest sw_core_mod.d2a2c_vect sw_core_mod.edge_interpolate4 sw_core_mod.fill2_4corners sw_core_mod.fill_4corners sw_core_m
!od.compute_div_damping sw_core_mod.smag_corner sw_core_mod.ytp_v sw_core_mod.xtp_u tp_core_mod.fv_tp_2d tp_core_m
!od.copy_corners tp_core_mod.xtp tp_core_mod.ytp tp_core_mod.xppm0 tp_core_mod.yppm0 tp_core_mod.fxppm tp_core_
!mod.fyppm tp_core_mod.deln_flux)):
!   gradient     of useful results: q flux c
!   with respect to varying inputs: q flux c
  SUBROUTINE FXPPM_BWD(c, c_ad, q, q_ad, flux, flux_ad, iord, ifirst&
&   , ilast, jfirst, jlast, npx, npy, bd, dxa, nested, grid_type)
    IMPLICIT NONE
    TYPE(FV_GRID_BOUNDS_TYPE), INTENT(IN) :: bd
    INTEGER, INTENT(IN) :: ifirst, ilast
    INTEGER, INTENT(IN) :: jfirst, jlast
    INTEGER, INTENT(IN) :: iord
    INTEGER, INTENT(IN) :: npx, npy
    REAL(fvprc), INTENT(IN) :: q(ifirst-ng:ilast+ng, jfirst:jlast)
    REAL(fvprc) :: q_ad(ifirst-ng:ilast+ng, jfirst:jlast)
    REAL(fvprc), INTENT(IN) :: c(ifirst:ilast+1, jfirst:jlast)
    REAL(fvprc) :: c_ad(ifirst:ilast+1, jfirst:jlast)
    REAL(fvprc), INTENT(IN) :: dxa(bd%isd:bd%ied, bd%jsd:bd%jed)
    LOGICAL, INTENT(IN) :: nested
    INTEGER, INTENT(IN) :: grid_type
    REAL(fvprc) :: flux(ifirst:ilast+1, jfirst:jlast)
    REAL(fvprc) :: flux_ad(ifirst:ilast+1, jfirst:jlast)
    REAL(fvprc) :: dl, dr, pmp, lac, ct, qe
    REAL(fvprc) :: pmp_1, lac_1, pmp_2, lac_2
    REAL(fvprc) :: xt, x1, x0, x0l, x0r
    REAL(fvprc) :: xt_ad, x0l_ad, x0r_ad
    INTEGER :: i, j, is3, ie3, it
    REAL(fvprc) :: bl6(ifirst-1:ilast+1, jfirst:jlast)
    REAL(fvprc) :: bl6_ad(ifirst-1:ilast+1, jfirst:jlast)
    REAL(fvprc) :: br6(ifirst-1:ilast+1, jfirst:jlast)
    REAL(fvprc) :: br6_ad(ifirst-1:ilast+1, jfirst:jlast)
    INTEGER :: is, ie, js, je, isd, ied, jsd, jed
    INTRINSIC MAX
    INTRINSIC MIN
    REAL(fvprc) :: temp_ad
    REAL(fvprc) :: temp_ad0
    REAL(fvprc) :: temp_ad1
    REAL(fvprc) :: temp_ad2
    INTEGER :: branch
    REAL(fvprc) :: temp
    REAL(fvprc) :: temp_ad3
    REAL(fvprc) :: temp_ad4
    REAL(fvprc) :: temp0
    REAL(fvprc) :: temp_ad5
    REAL(fvprc) :: temp_ad6
    CALL POPINTEGER(ie3)
    CALL POPREALARRAY(bl6, 8*(ilast-ifirst+3)*(jlast-jfirst+1)/8)
    CALL POPREALARRAY(br6, 8*(ilast-ifirst+3)*(jlast-jfirst+1)/8)
    CALL POPINTEGER(is3)
    br6_ad = 0.0_FVPRC
    bl6_ad = 0.0_FVPRC
    CALL POPREALARRAY(flux, 8*(ilast-ifirst+2)*(jlast-jfirst+1)/8)
    DO j=jfirst,jlast
      DO i=ifirst,ilast+1
        IF (c(i, j) .GT. 0.) THEN
          CALL PUSHCONTROL1B_FV(1)
        ELSE
          CALL PUSHCONTROL1B_FV(0)
        END IF
      END DO
      DO i=ilast+1,ifirst,-1
        CALL POPCONTROL1B_FV(branch)
        IF (branch .EQ. 0) THEN
          temp0 = bl6(i, j) + br6(i, j)
          temp_ad5 = (c(i, j)+1.)*flux_ad(i, j)
          temp_ad6 = c(i, j)*temp_ad5
          q_ad(i, j) = q_ad(i, j) + flux_ad(i, j)
          c_ad(i, j) = c_ad(i, j) + temp0*temp_ad5 + (bl6(i, j)+c(i, j)*&
&           temp0)*flux_ad(i, j)
          bl6_ad(i, j) = bl6_ad(i, j) + temp_ad6 + temp_ad5
          br6_ad(i, j) = br6_ad(i, j) + temp_ad6
          flux_ad(i, j) = 0.0_FVPRC
        ELSE
          temp = bl6(i-1, j) + br6(i-1, j)
          temp_ad3 = (1.-c(i, j))*flux_ad(i, j)
          temp_ad4 = -(c(i, j)*temp_ad3)
          q_ad(i-1, j) = q_ad(i-1, j) + flux_ad(i, j)
          c_ad(i, j) = c_ad(i, j) - temp*temp_ad3 - (br6(i-1, j)-c(i, j)&
&           *temp)*flux_ad(i, j)
          br6_ad(i-1, j) = br6_ad(i-1, j) + temp_ad4 + temp_ad3
          bl6_ad(i-1, j) = bl6_ad(i-1, j) + temp_ad4
          flux_ad(i, j) = 0.0_FVPRC
        END IF
      END DO
    END DO
    DO j=jlast,jfirst,-1
      CALL POPCONTROL2B_FV(branch)
      IF (branch .NE. 0) THEN
        IF (branch .NE. 1) THEN
          xt_ad = br6_ad(npx-2, j) + bl6_ad(npx-1, j)
          q_ad(npx-1, j) = q_ad(npx-1, j) - bl6_ad(npx-1, j)
          bl6_ad(npx-1, j) = 0.0_FVPRC
          q_ad(npx-2, j) = q_ad(npx-2, j) - br6_ad(npx-2, j)
          br6_ad(npx-2, j) = 0.0_FVPRC
          q_ad(npx-3, j) = q_ad(npx-3, j) + c1*xt_ad
          q_ad(npx-2, j) = q_ad(npx-2, j) + c2*xt_ad
          q_ad(npx-1, j) = q_ad(npx-1, j) + c3*xt_ad
          xt_ad = br6_ad(npx, j)
          q_ad(npx, j) = q_ad(npx, j) + c3*xt_ad - br6_ad(npx, j)
          br6_ad(npx, j) = 0.0_FVPRC
          q_ad(npx+1, j) = q_ad(npx+1, j) + c2*xt_ad
          q_ad(npx+2, j) = q_ad(npx+2, j) + c1*xt_ad
          xt_ad = br6_ad(npx-1, j) + bl6_ad(npx, j)
          q_ad(npx, j) = q_ad(npx, j) - bl6_ad(npx, j)
          bl6_ad(npx, j) = 0.0_FVPRC
          q_ad(npx-1, j) = q_ad(npx-1, j) - br6_ad(npx-1, j)
          br6_ad(npx-1, j) = 0.0_FVPRC
          x0l_ad = xt_ad
          x0r_ad = xt_ad
          q_ad(npx-2, j) = q_ad(npx-2, j) + (p1-1.0)*bl6_ad(npx-2, j)
          q_ad(npx-3, j) = q_ad(npx-3, j) + p1*bl6_ad(npx-2, j)
          q_ad(npx-4, j) = q_ad(npx-4, j) + p2*bl6_ad(npx-2, j)
          q_ad(npx-1, j) = q_ad(npx-1, j) + p2*bl6_ad(npx-2, j)
          bl6_ad(npx-2, j) = 0.0_FVPRC
          temp_ad1 = 0.5*x0r_ad/(dxa(npx, j)+dxa(npx+1, j))
          q_ad(npx, j) = q_ad(npx, j) + (dxa(npx, j)*2.+dxa(npx+1, j))*&
&           temp_ad1
          q_ad(npx+1, j) = q_ad(npx+1, j) - dxa(npx, j)*temp_ad1
          temp_ad2 = 0.5*x0l_ad/(dxa(npx-1, j)+dxa(npx-2, j))
          q_ad(npx-1, j) = q_ad(npx-1, j) + (dxa(npx-1, j)*2.+dxa(npx-2&
&           , j))*temp_ad2
          q_ad(npx-2, j) = q_ad(npx-2, j) - dxa(npx-1, j)*temp_ad2
        END IF
        CALL POPCONTROL1B_FV(branch)
        IF (branch .EQ. 0) THEN
          xt_ad = br6_ad(1, j) + bl6_ad(2, j)
          q_ad(2, j) = q_ad(2, j) - bl6_ad(2, j)
          bl6_ad(2, j) = 0.0_FVPRC
          q_ad(1, j) = q_ad(1, j) + c3*xt_ad - br6_ad(1, j)
          br6_ad(1, j) = 0.0_FVPRC
          q_ad(2, j) = q_ad(2, j) + c2*xt_ad
          q_ad(3, j) = q_ad(3, j) + c1*xt_ad
          xt_ad = bl6_ad(0, j)
          q_ad(0, j) = q_ad(0, j) - bl6_ad(0, j)
          bl6_ad(0, j) = 0.0_FVPRC
          q_ad(-2, j) = q_ad(-2, j) + c1*xt_ad
          q_ad(-1, j) = q_ad(-1, j) + c2*xt_ad
          q_ad(0, j) = q_ad(0, j) + c3*xt_ad - br6_ad(0, j)
          xt_ad = bl6_ad(1, j) + br6_ad(0, j)
          br6_ad(0, j) = 0.0_FVPRC
          q_ad(1, j) = q_ad(1, j) - bl6_ad(1, j)
          bl6_ad(1, j) = 0.0_FVPRC
          x0l_ad = xt_ad
          x0r_ad = xt_ad
          q_ad(2, j) = q_ad(2, j) + (p1-1.0)*br6_ad(2, j)
          q_ad(3, j) = q_ad(3, j) + p1*br6_ad(2, j)
          q_ad(1, j) = q_ad(1, j) + p2*br6_ad(2, j)
          q_ad(4, j) = q_ad(4, j) + p2*br6_ad(2, j)
          br6_ad(2, j) = 0.0_FVPRC
          temp_ad = 0.5*x0r_ad/(dxa(1, j)+dxa(2, j))
          q_ad(1, j) = q_ad(1, j) + (dxa(1, j)*2.+dxa(2, j))*temp_ad
          q_ad(2, j) = q_ad(2, j) - dxa(1, j)*temp_ad
          temp_ad0 = 0.5*x0l_ad/(dxa(0, j)+dxa(-1, j))
          q_ad(0, j) = q_ad(0, j) + (dxa(0, j)*2.+dxa(-1, j))*temp_ad0
          q_ad(-1, j) = q_ad(-1, j) - dxa(0, j)*temp_ad0
        END IF
      END IF
    END DO
    DO j=jlast,jfirst,-1
      DO i=ie3,is3,-1
        q_ad(i-2, j) = q_ad(i-2, j) + b1*br6_ad(i, j)
        q_ad(i-1, j) = q_ad(i-1, j) + b2*br6_ad(i, j)
        q_ad(i, j) = q_ad(i, j) + b3*br6_ad(i, j)
        q_ad(i+1, j) = q_ad(i+1, j) + b4*br6_ad(i, j)
        q_ad(i+2, j) = q_ad(i+2, j) + b5*br6_ad(i, j)
        br6_ad(i, j) = 0.0_FVPRC
        q_ad(i-2, j) = q_ad(i-2, j) + b5*bl6_ad(i, j)
        q_ad(i-1, j) = q_ad(i-1, j) + b4*bl6_ad(i, j)
        q_ad(i, j) = q_ad(i, j) + b3*bl6_ad(i, j)
        q_ad(i+1, j) = q_ad(i+1, j) + b2*bl6_ad(i, j)
        q_ad(i+2, j) = q_ad(i+2, j) + b1*bl6_ad(i, j)
        bl6_ad(i, j) = 0.0_FVPRC
      END DO
    END DO
    CALL POPCONTROL1B_FV(branch)
  END SUBROUTINE FXPPM_BWD
!  Differentiation of fyppm in reverse (adjoint) mode, forward sweep (with options r8 split(a2b_edge_mod.a2b_ord2 a2b_edge_mod
!.a2b_ord4 a2b_edge_mod.extrap_corner  dyn_core_mod.dyn_core dyn_core_mod.pk3_halo dyn_core_mod.pln_halo dyn_core_mod.pe_ha
!lo dyn_core_mod.adv_pe dyn_core_mod.p_grad_c dyn_core_mod.nh_p_grad dyn_core_mod.split_p_grad dyn_core_mod.one_grad_p dyn_core_m
!od.grad1_p_update dyn_core_mod.mix_dp dyn_core_mod.geopk dyn_core_mod.del2_cubed fv_dynamics_mod.fv_dynamics fv_dynamics_mod.ray
!leigh_super fv_dynamics_mod.rayleigh_friction fv_dynamics_mod.compute_aam fv_dynamics_mod.geos_to_fv3 fv_grid_utils_mod.cubed_to
!_latlon fv_grid_utils_mod.c2l_ord4 fv_grid_utils_mod.c2l_ord2 fv_mapz_mod.lagrangian_to_eulerian fv_mapz_mod.compute_total_energ
!y fv_mapz_mod.pkez fv_mapz_mod.remap_z fv_mapz_mod.map_scalar fv_mapz_mod.map1_ppm fv_mapz_mod.mapn_tracer fv_mapz_m
!od.map1_q2 fv_mapz_mod.map1_cubic fv_mapz_mod.scalar_profile_linear fv_mapz_mod.cs_profile_linear fv_mapz_mod.steepz fv
!_tracer2d_mod.tracer_2d fv_tracer2d_mod.tracer_2d_nested nh_core_mod.update_dz_c nh_core_mod.update_dz_d nh_core_mod.riem_solver
!_c nh_core_mod.riem_solver3 nh_core_mod.rim_2d nh_core_mod.sim3_solver nh_core_mod.sim3p0_solver nh_core_mod.sim1_solver nh_core
!_mod.sim_solver nh_core_mod.edge_profile sw_core_mod.c_sw sw_core_mod.d_sw sw_core_mod.divergence_corner sw_core_mod.divergence_
!corner_nest sw_core_mod.d2a2c_vect sw_core_mod.edge_interpolate4 sw_core_mod.fill2_4corners sw_core_mod.fill_4corners sw_core_mo
!d.compute_div_damping sw_core_mod.smag_corner sw_core_mod.ytp_v sw_core_mod.xtp_u tp_core_mod.fv_tp_2d tp_core_mo
!d.copy_corners tp_core_mod.xtp tp_core_mod.ytp tp_core_mod.xppm0 tp_core_mod.yppm0 tp_core_mod.fxppm tp_core_m
!od.fyppm tp_core_mod.deln_flux)):
!   gradient     of useful results: q flux c
!   with respect to varying inputs: q flux c
  SUBROUTINE FYPPM_FWD(c, q, flux, jord, ifirst, ilast, jfirst, jlast&
&   , npx, npy, dm, bd, dya, nested, grid_type)
    IMPLICIT NONE
    TYPE(FV_GRID_BOUNDS_TYPE), INTENT(IN) :: bd
!  X-Dir strip
    INTEGER, INTENT(IN) :: ifirst, ilast
!  Y-Dir strip
    INTEGER, INTENT(IN) :: jfirst, jlast
    INTEGER, INTENT(IN) :: jord
    INTEGER, INTENT(IN) :: npx, npy
    REAL(fvprc), INTENT(IN) :: q(ifirst:ilast, jfirst-ng:jlast+ng)
! Courant number
    REAL(fvprc), INTENT(IN) :: c(bd%isd:bd%ied, bd%js:bd%je+1)
!  Flux
    REAL(fvprc) :: flux(ifirst:ilast, jfirst:jlast+1)
    REAL(fvprc), INTENT(OUT) :: dm(ifirst:ilast, jfirst-2:jlast+2)
    REAL(fvprc), INTENT(IN) :: dya(bd%isd:bd%ied, bd%jsd:bd%jed)
    LOGICAL, INTENT(IN) :: nested
    INTEGER, INTENT(IN) :: grid_type
! Local:
    REAL(fvprc) :: bl(ifirst:ilast, jfirst-1:jlast+1)
    REAL(fvprc) :: br(ifirst:ilast, jfirst-1:jlast+1)
    REAL(fvprc) :: dl, dr, pmp, lac, ct, qe
    REAL(fvprc) :: pmp_1, lac_1, pmp_2, lac_2
    REAL(fvprc) :: xt, x0, x1, x0l, x0r
    INTEGER :: i, j, js3, je3, jt
    INTEGER :: is, ie, js, je, isd, ied, jsd, jed
    INTRINSIC MAX
    INTRINSIC MIN
    INTEGER :: max1
    INTEGER :: min1
    IF (3 .LT. bd%js - 1) THEN
      max1 = bd%js - 1
    ELSE
      max1 = 3
    END IF
    IF (npy - 3 .GT. bd%je + 1) THEN
      min1 = bd%je + 1
    ELSE
      min1 = npy - 3
    END IF
    DO j=max1,min1
      DO i=ifirst,ilast
        bl(i, j) = b5*q(i, j-2) + b4*q(i, j-1) + b3*q(i, j) + b2*q(i, j+&
&         1) + b1*q(i, j+2)
        br(i, j) = b1*q(i, j-2) + b2*q(i, j-1) + b3*q(i, j) + b4*q(i, j+&
&         1) + b5*q(i, j+2)
      END DO
    END DO
    IF (bd%js .EQ. 1 .AND. (.NOT.nested)) THEN
      DO i=ifirst,ilast
        br(i, 2) = p1*(q(i, 2)+q(i, 3)) + p2*(q(i, 1)+q(i, 4)) - q(i, 2)
        x0l = 0.5*((2.*dya(i, 0)+dya(i, -1))*q(i, 0)-dya(i, 0)*q(i, -1))&
&         /(dya(i, 0)+dya(i, -1))
        x0r = 0.5*((2.*dya(i, 1)+dya(i, 2))*q(i, 1)-dya(i, 1)*q(i, 2))/(&
&         dya(i, 1)+dya(i, 2))
        xt = x0l + x0r
        bl(i, 1) = xt - q(i, 1)
        br(i, 0) = xt - q(i, 0)
        xt = c1*q(i, -2) + c2*q(i, -1) + c3*q(i, 0)
        bl(i, 0) = xt - q(i, 0)
        xt = c3*q(i, 1) + c2*q(i, 2) + c1*q(i, 3)
        br(i, 1) = xt - q(i, 1)
        bl(i, 2) = xt - q(i, 2)
      END DO
      CALL PUSHCONTROL1B_FV(0)
    ELSE
      CALL PUSHCONTROL1B_FV(1)
    END IF
    IF (bd%je + 1 .EQ. npy .AND. (.NOT.nested)) THEN
      DO i=ifirst,ilast
        bl(i, npy-2) = p1*(q(i, npy-3)+q(i, npy-2)) + p2*(q(i, npy-4)+q(&
&         i, npy-1)) - q(i, npy-2)
        x0l = 0.5*((2.*dya(i, npy-1)+dya(i, npy-2))*q(i, npy-1)-dya(i, &
&         npy-1)*q(i, npy-2))/(dya(i, npy-1)+dya(i, npy-2))
        x0r = 0.5*((2.*dya(i, npy)+dya(i, npy+1))*q(i, npy)-dya(i, npy)*&
&         q(i, npy+1))/(dya(i, npy)+dya(i, npy+1))
        xt = x0l + x0r
        br(i, npy-1) = xt - q(i, npy-1)
        bl(i, npy) = xt - q(i, npy)
        xt = c3*q(i, npy) + c2*q(i, npy+1) + c1*q(i, npy+2)
        br(i, npy) = xt - q(i, npy)
        xt = c1*q(i, npy-3) + c2*q(i, npy-2) + c3*q(i, npy-1)
        br(i, npy-2) = xt - q(i, npy-2)
        bl(i, npy-1) = xt - q(i, npy-1)
      END DO
      CALL PUSHCONTROL1B_FV(1)
    ELSE
      CALL PUSHCONTROL1B_FV(0)
    END IF
    CALL PUSHREALARRAY(flux, 8*(ilast-ifirst+1)*(jlast-jfirst+2)/8)
    DO j=jfirst,jlast+1
      DO i=ifirst,ilast
        IF (c(i, j) .GT. 0.) THEN
          flux(i, j) = q(i, j-1) + (1.-c(i, j))*(br(i, j-1)-c(i, j)*(bl(&
&           i, j-1)+br(i, j-1)))
        ELSE
          flux(i, j) = q(i, j) + (1.+c(i, j))*(bl(i, j)+c(i, j)*(bl(i, j&
&           )+br(i, j)))
        END IF
      END DO
    END DO
    CALL PUSHINTEGER(max1)
    CALL PUSHREALARRAY(bl, 8*(ilast-ifirst+1)*(jlast-jfirst+3)/8)
    CALL PUSHREALARRAY(br, 8*(ilast-ifirst+1)*(jlast-jfirst+3)/8)
    CALL PUSHINTEGER(min1)
  END SUBROUTINE FYPPM_FWD
!  Differentiation of fyppm in reverse (adjoint) mode, backward sweep (with options r8 split(a2b_edge_mod.a2b_ord2 a2b_edge_mo
!d.a2b_ord4 a2b_edge_mod.extrap_corner  dyn_core_mod.dyn_core dyn_core_mod.pk3_halo dyn_core_mod.pln_halo dyn_core_mod.pe_h
!alo dyn_core_mod.adv_pe dyn_core_mod.p_grad_c dyn_core_mod.nh_p_grad dyn_core_mod.split_p_grad dyn_core_mod.one_grad_p dyn_core_
!mod.grad1_p_update dyn_core_mod.mix_dp dyn_core_mod.geopk dyn_core_mod.del2_cubed fv_dynamics_mod.fv_dynamics fv_dynamics_mod.ra
!yleigh_super fv_dynamics_mod.rayleigh_friction fv_dynamics_mod.compute_aam fv_dynamics_mod.geos_to_fv3 fv_grid_utils_mod.cubed_t
!o_latlon fv_grid_utils_mod.c2l_ord4 fv_grid_utils_mod.c2l_ord2 fv_mapz_mod.lagrangian_to_eulerian fv_mapz_mod.compute_total_ener
!gy fv_mapz_mod.pkez fv_mapz_mod.remap_z fv_mapz_mod.map_scalar fv_mapz_mod.map1_ppm fv_mapz_mod.mapn_tracer fv_mapz_
!mod.map1_q2 fv_mapz_mod.map1_cubic fv_mapz_mod.scalar_profile_linear fv_mapz_mod.cs_profile_linear fv_mapz_mod.steepz f
!v_tracer2d_mod.tracer_2d fv_tracer2d_mod.tracer_2d_nested nh_core_mod.update_dz_c nh_core_mod.update_dz_d nh_core_mod.riem_solve
!r_c nh_core_mod.riem_solver3 nh_core_mod.rim_2d nh_core_mod.sim3_solver nh_core_mod.sim3p0_solver nh_core_mod.sim1_solver nh_cor
!e_mod.sim_solver nh_core_mod.edge_profile sw_core_mod.c_sw sw_core_mod.d_sw sw_core_mod.divergence_corner sw_core_mod.divergence
!_corner_nest sw_core_mod.d2a2c_vect sw_core_mod.edge_interpolate4 sw_core_mod.fill2_4corners sw_core_mod.fill_4corners sw_core_m
!od.compute_div_damping sw_core_mod.smag_corner sw_core_mod.ytp_v sw_core_mod.xtp_u tp_core_mod.fv_tp_2d tp_core_m
!od.copy_corners tp_core_mod.xtp tp_core_mod.ytp tp_core_mod.xppm0 tp_core_mod.yppm0 tp_core_mod.fxppm tp_core_
!mod.fyppm tp_core_mod.deln_flux)):
!   gradient     of useful results: q flux c
!   with respect to varying inputs: q flux c
  SUBROUTINE FYPPM_BWD(c, c_ad, q, q_ad, flux, flux_ad, jord, ifirst&
&   , ilast, jfirst, jlast, npx, npy, dm, bd, dya, nested, grid_type)
    IMPLICIT NONE
    TYPE(FV_GRID_BOUNDS_TYPE), INTENT(IN) :: bd
    INTEGER, INTENT(IN) :: ifirst, ilast
    INTEGER, INTENT(IN) :: jfirst, jlast
    INTEGER, INTENT(IN) :: jord
    INTEGER, INTENT(IN) :: npx, npy
    REAL(fvprc), INTENT(IN) :: q(ifirst:ilast, jfirst-ng:jlast+ng)
    REAL(fvprc) :: q_ad(ifirst:ilast, jfirst-ng:jlast+ng)
    REAL(fvprc), INTENT(IN) :: c(bd%isd:bd%ied, bd%js:bd%je+1)
    REAL(fvprc) :: c_ad(bd%isd:bd%ied, bd%js:bd%je+1)
    REAL(fvprc) :: flux(ifirst:ilast, jfirst:jlast+1)
    REAL(fvprc) :: flux_ad(ifirst:ilast, jfirst:jlast+1)
    REAL(fvprc), INTENT(OUT) :: dm(ifirst:ilast, jfirst-2:jlast+2)
    REAL(fvprc), INTENT(IN) :: dya(bd%isd:bd%ied, bd%jsd:bd%jed)
    LOGICAL, INTENT(IN) :: nested
    INTEGER, INTENT(IN) :: grid_type
    REAL(fvprc) :: bl(ifirst:ilast, jfirst-1:jlast+1)
    REAL(fvprc) :: bl_ad(ifirst:ilast, jfirst-1:jlast+1)
    REAL(fvprc) :: br(ifirst:ilast, jfirst-1:jlast+1)
    REAL(fvprc) :: br_ad(ifirst:ilast, jfirst-1:jlast+1)
    REAL(fvprc) :: dl, dr, pmp, lac, ct, qe
    REAL(fvprc) :: pmp_1, lac_1, pmp_2, lac_2
    REAL(fvprc) :: xt, x0, x1, x0l, x0r
    REAL(fvprc) :: xt_ad, x0l_ad, x0r_ad
    INTEGER :: i, j, js3, je3, jt
    INTEGER :: is, ie, js, je, isd, ied, jsd, jed
    INTRINSIC MAX
    INTRINSIC MIN
    INTEGER :: max1
    INTEGER :: min1
    REAL(fvprc) :: temp_ad
    REAL(fvprc) :: temp_ad0
    REAL(fvprc) :: temp_ad1
    REAL(fvprc) :: temp_ad2
    REAL(fvprc) :: temp
    REAL(fvprc) :: temp_ad3
    REAL(fvprc) :: temp_ad4
    REAL(fvprc) :: temp0
    REAL(fvprc) :: temp_ad5
    REAL(fvprc) :: temp_ad6
    INTEGER :: branch
    CALL POPINTEGER(min1)
    CALL POPREALARRAY(br, 8*(ilast-ifirst+1)*(jlast-jfirst+3)/8)
    CALL POPREALARRAY(bl, 8*(ilast-ifirst+1)*(jlast-jfirst+3)/8)
    CALL POPINTEGER(max1)
    bl_ad = 0.0_FVPRC
    br_ad = 0.0_FVPRC
    CALL POPREALARRAY(flux, 8*(ilast-ifirst+1)*(jlast-jfirst+2)/8)
    DO j=jfirst,jlast+1
      DO i=ifirst,ilast
        IF (c(i, j) .GT. 0.) THEN
          CALL PUSHCONTROL1B_FV(1)
        ELSE
          CALL PUSHCONTROL1B_FV(0)
        END IF
      END DO
      DO i=ilast,ifirst,-1
        CALL POPCONTROL1B_FV(branch)
        IF (branch .EQ. 0) THEN
          temp0 = bl(i, j) + br(i, j)
          temp_ad5 = (c(i, j)+1.)*flux_ad(i, j)
          temp_ad6 = c(i, j)*temp_ad5
          q_ad(i, j) = q_ad(i, j) + flux_ad(i, j)
          c_ad(i, j) = c_ad(i, j) + temp0*temp_ad5 + (bl(i, j)+c(i, j)*&
&           temp0)*flux_ad(i, j)
          bl_ad(i, j) = bl_ad(i, j) + temp_ad6 + temp_ad5
          br_ad(i, j) = br_ad(i, j) + temp_ad6
          flux_ad(i, j) = 0.0_FVPRC
        ELSE
          temp = bl(i, j-1) + br(i, j-1)
          temp_ad3 = (1.-c(i, j))*flux_ad(i, j)
          temp_ad4 = -(c(i, j)*temp_ad3)
          q_ad(i, j-1) = q_ad(i, j-1) + flux_ad(i, j)
          c_ad(i, j) = c_ad(i, j) - temp*temp_ad3 - (br(i, j-1)-c(i, j)*&
&           temp)*flux_ad(i, j)
          br_ad(i, j-1) = br_ad(i, j-1) + temp_ad4 + temp_ad3
          bl_ad(i, j-1) = bl_ad(i, j-1) + temp_ad4
          flux_ad(i, j) = 0.0_FVPRC
        END IF
      END DO
    END DO
    CALL POPCONTROL1B_FV(branch)
    IF (branch .NE. 0) THEN
      DO i=ilast,ifirst,-1
        xt_ad = br_ad(i, npy-2) + bl_ad(i, npy-1)
        q_ad(i, npy-1) = q_ad(i, npy-1) - bl_ad(i, npy-1)
        bl_ad(i, npy-1) = 0.0_FVPRC
        q_ad(i, npy-2) = q_ad(i, npy-2) - br_ad(i, npy-2)
        br_ad(i, npy-2) = 0.0_FVPRC
        q_ad(i, npy-3) = q_ad(i, npy-3) + c1*xt_ad
        q_ad(i, npy-2) = q_ad(i, npy-2) + c2*xt_ad
        q_ad(i, npy-1) = q_ad(i, npy-1) + c3*xt_ad
        xt_ad = br_ad(i, npy)
        q_ad(i, npy) = q_ad(i, npy) + c3*xt_ad - br_ad(i, npy)
        br_ad(i, npy) = 0.0_FVPRC
        q_ad(i, npy+1) = q_ad(i, npy+1) + c2*xt_ad
        q_ad(i, npy+2) = q_ad(i, npy+2) + c1*xt_ad
        xt_ad = br_ad(i, npy-1) + bl_ad(i, npy)
        q_ad(i, npy) = q_ad(i, npy) - bl_ad(i, npy)
        bl_ad(i, npy) = 0.0_FVPRC
        q_ad(i, npy-1) = q_ad(i, npy-1) - br_ad(i, npy-1)
        br_ad(i, npy-1) = 0.0_FVPRC
        x0l_ad = xt_ad
        x0r_ad = xt_ad
        temp_ad1 = 0.5*x0r_ad/(dya(i, npy)+dya(i, npy+1))
        q_ad(i, npy) = q_ad(i, npy) + (dya(i, npy)*2.+dya(i, npy+1))*&
&         temp_ad1
        q_ad(i, npy+1) = q_ad(i, npy+1) - dya(i, npy)*temp_ad1
        temp_ad2 = 0.5*x0l_ad/(dya(i, npy-1)+dya(i, npy-2))
        q_ad(i, npy-1) = q_ad(i, npy-1) + (dya(i, npy-1)*2.+dya(i, npy-2&
&         ))*temp_ad2
        q_ad(i, npy-2) = q_ad(i, npy-2) - dya(i, npy-1)*temp_ad2
        q_ad(i, npy-3) = q_ad(i, npy-3) + p1*bl_ad(i, npy-2)
        q_ad(i, npy-2) = q_ad(i, npy-2) + (p1-1.0)*bl_ad(i, npy-2)
        q_ad(i, npy-4) = q_ad(i, npy-4) + p2*bl_ad(i, npy-2)
        q_ad(i, npy-1) = q_ad(i, npy-1) + p2*bl_ad(i, npy-2)
        bl_ad(i, npy-2) = 0.0_FVPRC
      END DO
    END IF
    CALL POPCONTROL1B_FV(branch)
    IF (branch .EQ. 0) THEN
      DO i=ilast,ifirst,-1
        xt_ad = br_ad(i, 1) + bl_ad(i, 2)
        q_ad(i, 2) = q_ad(i, 2) - bl_ad(i, 2)
        bl_ad(i, 2) = 0.0_FVPRC
        q_ad(i, 1) = q_ad(i, 1) + c3*xt_ad - br_ad(i, 1)
        br_ad(i, 1) = 0.0_FVPRC
        q_ad(i, 2) = q_ad(i, 2) + c2*xt_ad
        q_ad(i, 3) = q_ad(i, 3) + c1*xt_ad
        xt_ad = bl_ad(i, 0)
        q_ad(i, 0) = q_ad(i, 0) - bl_ad(i, 0)
        bl_ad(i, 0) = 0.0_FVPRC
        q_ad(i, -2) = q_ad(i, -2) + c1*xt_ad
        q_ad(i, -1) = q_ad(i, -1) + c2*xt_ad
        q_ad(i, 0) = q_ad(i, 0) + c3*xt_ad - br_ad(i, 0)
        xt_ad = bl_ad(i, 1) + br_ad(i, 0)
        br_ad(i, 0) = 0.0_FVPRC
        x0l_ad = xt_ad
        x0r_ad = xt_ad
        temp_ad = 0.5*x0r_ad/(dya(i, 1)+dya(i, 2))
        q_ad(i, 1) = q_ad(i, 1) + (dya(i, 1)*2.+dya(i, 2))*temp_ad - &
&         bl_ad(i, 1)
        bl_ad(i, 1) = 0.0_FVPRC
        q_ad(i, 2) = q_ad(i, 2) - dya(i, 1)*temp_ad
        temp_ad0 = 0.5*x0l_ad/(dya(i, 0)+dya(i, -1))
        q_ad(i, 0) = q_ad(i, 0) + (dya(i, 0)*2.+dya(i, -1))*temp_ad0
        q_ad(i, -1) = q_ad(i, -1) - dya(i, 0)*temp_ad0
        q_ad(i, 2) = q_ad(i, 2) + (p1-1.0)*br_ad(i, 2)
        q_ad(i, 3) = q_ad(i, 3) + p1*br_ad(i, 2)
        q_ad(i, 1) = q_ad(i, 1) + p2*br_ad(i, 2)
        q_ad(i, 4) = q_ad(i, 4) + p2*br_ad(i, 2)
        br_ad(i, 2) = 0.0_FVPRC
      END DO
    END IF
    DO j=min1,max1,-1
      DO i=ilast,ifirst,-1
        q_ad(i, j-2) = q_ad(i, j-2) + b1*br_ad(i, j)
        q_ad(i, j-1) = q_ad(i, j-1) + b2*br_ad(i, j)
        q_ad(i, j) = q_ad(i, j) + b3*br_ad(i, j)
        q_ad(i, j+1) = q_ad(i, j+1) + b4*br_ad(i, j)
        q_ad(i, j+2) = q_ad(i, j+2) + b5*br_ad(i, j)
        br_ad(i, j) = 0.0_FVPRC
        q_ad(i, j-2) = q_ad(i, j-2) + b5*bl_ad(i, j)
        q_ad(i, j-1) = q_ad(i, j-1) + b4*bl_ad(i, j)
        q_ad(i, j) = q_ad(i, j) + b3*bl_ad(i, j)
        q_ad(i, j+1) = q_ad(i, j+1) + b2*bl_ad(i, j)
        q_ad(i, j+2) = q_ad(i, j+2) + b1*bl_ad(i, j)
        bl_ad(i, j) = 0.0_FVPRC
      END DO
    END DO
  END SUBROUTINE FYPPM_BWD
!  Differentiation of deln_flux in reverse (adjoint) mode, forward sweep (with options r8 split(a2b_edge_mod.a2b_ord2 a2b_edge
!_mod.a2b_ord4 a2b_edge_mod.extrap_corner  dyn_core_mod.dyn_core dyn_core_mod.pk3_halo dyn_core_mod.pln_halo dyn_core_mod.p
!e_halo dyn_core_mod.adv_pe dyn_core_mod.p_grad_c dyn_core_mod.nh_p_grad dyn_core_mod.split_p_grad dyn_core_mod.one_grad_p dyn_co
!re_mod.grad1_p_update dyn_core_mod.mix_dp dyn_core_mod.geopk dyn_core_mod.del2_cubed fv_dynamics_mod.fv_dynamics fv_dynamics_mod
!.rayleigh_super fv_dynamics_mod.rayleigh_friction fv_dynamics_mod.compute_aam fv_dynamics_mod.geos_to_fv3 fv_grid_utils_mod.cube
!d_to_latlon fv_grid_utils_mod.c2l_ord4 fv_grid_utils_mod.c2l_ord2 fv_mapz_mod.lagrangian_to_eulerian fv_mapz_mod.compute_total_e
!nergy fv_mapz_mod.pkez fv_mapz_mod.remap_z fv_mapz_mod.map_scalar fv_mapz_mod.map1_ppm fv_mapz_mod.mapn_tracer fv_ma
!pz_mod.map1_q2 fv_mapz_mod.map1_cubic fv_mapz_mod.scalar_profile_linear fv_mapz_mod.cs_profile_linear fv_mapz_mod.steep
!z fv_tracer2d_mod.tracer_2d fv_tracer2d_mod.tracer_2d_nested nh_core_mod.update_dz_c nh_core_mod.update_dz_d nh_core_mod.riem_so
!lver_c nh_core_mod.riem_solver3 nh_core_mod.rim_2d nh_core_mod.sim3_solver nh_core_mod.sim3p0_solver nh_core_mod.sim1_solver nh_
!core_mod.sim_solver nh_core_mod.edge_profile sw_core_mod.c_sw sw_core_mod.d_sw sw_core_mod.divergence_corner sw_core_mod.diverge
!nce_corner_nest sw_core_mod.d2a2c_vect sw_core_mod.edge_interpolate4 sw_core_mod.fill2_4corners sw_core_mod.fill_4corners sw_cor
!e_mod.compute_div_damping sw_core_mod.smag_corner sw_core_mod.ytp_v sw_core_mod.xtp_u tp_core_mod.fv_tp_2d tp_cor
!e_mod.copy_corners tp_core_mod.xtp tp_core_mod.ytp tp_core_mod.xppm0 tp_core_mod.yppm0 tp_core_mod.fxppm tp_co
!re_mod.fyppm tp_core_mod.deln_flux)):
!   gradient     of useful results: q mass fx fy
!   with respect to varying inputs: q mass fx fy
  SUBROUTINE DELN_FLUX_FWD(nord, npx, npy, damp, q, fx, fy, &
&   gridstruct, bd, mass)
    IMPLICIT NONE
! Del-n damping for the cell-mean values (A grid)
!------------------
! nord = 0:   del-2
! nord = 1:   del-4
! nord = 2:   del-6
! nord = 3:   del-8 --> requires more ghosting than current
!------------------
    TYPE(FV_GRID_BOUNDS_TYPE), INTENT(IN) :: bd
! del-n
    INTEGER, INTENT(IN) :: nord
    INTEGER, INTENT(IN) :: npx, npy
    REAL(fvprc), INTENT(IN) :: damp
! q ghosted on input
    REAL(fvprc), INTENT(IN) :: q(bd%is-ng:bd%ie+ng, bd%js-ng:bd%je+ng)
    TYPE(FV_GRID_TYPE), INTENT(IN), TARGET :: gridstruct
! q ghosted on input
    REAL(fvprc), OPTIONAL, INTENT(IN) :: mass(bd%isd:bd%ied, bd%jsd:bd%&
&   jed)
! diffusive fluxes:
    REAL(fvprc), INTENT(INOUT) :: fx(bd%is:bd%ie+1, bd%js:bd%je), fy(bd%&
&   is:bd%ie, bd%js:bd%je+1)
! local:
    REAL(fvprc) :: fx2(bd%isd:bd%ied+1, bd%jsd:bd%jed), fy2(bd%isd:bd%&
&   ied, bd%jsd:bd%jed+1)
    REAL(fvprc) :: d2(bd%isd:bd%ied, bd%jsd:bd%jed)
    REAL(fvprc) :: damp2
    INTEGER :: i, j, n, nt, i1, i2, j1, j2
    INTEGER :: is, ie, js, je, isd, ied, jsd, jed
    INTRINSIC PRESENT
    INTEGER :: ad_from
    INTEGER :: ad_from0
    INTEGER :: ad_from1
    INTEGER :: ad_from2
    INTEGER :: ad_from3
    INTEGER :: ad_from4
!   real(FVPRC), pointer, dimension(:,:)   :: rarea, dx, dy, rdxc, rdyc
!   real(FVPRC), pointer, dimension(:,:,:) :: sin_sg
!   rarea    => gridstruct%rarea  
!   dx       => gridstruct%dx     
!   dy       => gridstruct%dy     
!   rdxc     => gridstruct%rdxc   
!   rdyc     => gridstruct%rdyc   
!   sin_sg   => gridstruct%sin_sg 
    i1 = bd%is - 1 - nord
    i2 = bd%ie + 1 + nord
    j1 = bd%js - 1 - nord
    j2 = bd%je + 1 + nord
    IF (.NOT.PRESENT(mass)) THEN
      DO j=j1,j2
        DO i=i1,i2
          d2(i, j) = damp*q(i, j)
        END DO
      END DO
      CALL PUSHCONTROL1B_FV(0)
    ELSE
      DO j=j1,j2
        DO i=i1,i2
          d2(i, j) = q(i, j)
        END DO
      END DO
      CALL PUSHCONTROL1B_FV(1)
    END IF
    IF (nord .GT. 0) THEN
      CALL COPY_CORNERS_FWD(d2, npx, npy, 1, gridstruct%nested, bd, &
&                        gridstruct%sw_corner, gridstruct%se_corner, &
&                        gridstruct%nw_corner, gridstruct%ne_corner)
      CALL PUSHCONTROL1B_FV(1)
    ELSE
      CALL PUSHCONTROL1B_FV(0)
    END IF
    DO j=bd%js-nord,bd%je+nord
      DO i=bd%is-nord,bd%ie+nord+1
!        fx2(i,j) = gridstruct%dy(i,j)*sina_u(i,j)*(d2(i-1,j)-d2(i,j))*gridstruct%rdxc(i,j)
        fx2(i, j) = 0.5*(gridstruct%sin_sg(i-1, j, 3)+gridstruct%sin_sg(&
&         i, j, 1))*gridstruct%dy(i, j)*(d2(i-1, j)-d2(i, j))*gridstruct&
&         %rdxc(i, j)
      END DO
    END DO
    IF (nord .GT. 0) THEN
      CALL COPY_CORNERS_FWD(d2, npx, npy, 2, gridstruct%nested, bd, &
&                        gridstruct%sw_corner, gridstruct%se_corner, &
&                        gridstruct%nw_corner, gridstruct%ne_corner)
      CALL PUSHCONTROL1B_FV(1)
    ELSE
      CALL PUSHCONTROL1B_FV(0)
    END IF
    DO j=bd%js-nord,bd%je+nord+1
      DO i=bd%is-nord,bd%ie+nord
!           fy2(i,j) = gridstruct%dx(i,j)*sina_v(i,j)*(d2(i,j-1)-d2(i,j))*gridstruct%rdyc(i,j)
        fy2(i, j) = 0.5*(gridstruct%sin_sg(i, j-1, 4)+gridstruct%sin_sg(&
&         i, j, 2))*gridstruct%dx(i, j)*(d2(i, j-1)-d2(i, j))*gridstruct&
&         %rdyc(i, j)
      END DO
    END DO
    IF (nord .GT. 0) THEN
!----------
! high-order
!----------
      DO n=1,nord
        nt = nord - n
        ad_from0 = bd%js - nt - 1
        DO j=ad_from0,bd%je+nt+1
          ad_from = bd%is - nt - 1
          DO i=ad_from,bd%ie+nt+1
            d2(i, j) = (fx2(i, j)-fx2(i+1, j)+fy2(i, j)-fy2(i, j+1))*&
&             gridstruct%rarea(i, j)
          END DO
          CALL PUSHINTEGER(i - 1)
          CALL PUSHINTEGER(ad_from)
        END DO
        CALL PUSHINTEGER(j - 1)
        CALL PUSHINTEGER(ad_from0)
        CALL COPY_CORNERS_FWD(d2, npx, npy, 1, gridstruct%nested, bd&
&                          , gridstruct%sw_corner, gridstruct%se_corner&
&                          , gridstruct%nw_corner, gridstruct%ne_corner)
        ad_from2 = bd%js - nt
        DO j=ad_from2,bd%je+nt
          ad_from1 = bd%is - nt
          DO i=ad_from1,bd%ie+nt+1
            fx2(i, j) = 0.5*(gridstruct%sin_sg(i-1, j, 3)+gridstruct%&
&             sin_sg(i, j, 1))*gridstruct%dy(i, j)*(d2(i, j)-d2(i-1, j))&
&             *gridstruct%rdxc(i, j)
          END DO
          CALL PUSHINTEGER(i - 1)
          CALL PUSHINTEGER(ad_from1)
        END DO
        CALL PUSHINTEGER(j - 1)
        CALL PUSHINTEGER(ad_from2)
        CALL COPY_CORNERS_FWD(d2, npx, npy, 2, gridstruct%nested, bd&
&                          , gridstruct%sw_corner, gridstruct%se_corner&
&                          , gridstruct%nw_corner, gridstruct%ne_corner)
        ad_from4 = bd%js - nt
        DO j=ad_from4,bd%je+nt+1
          ad_from3 = bd%is - nt
          DO i=ad_from3,bd%ie+nt
            fy2(i, j) = gridstruct%dx(i, j)*(d2(i, j)-d2(i, j-1))*&
&             gridstruct%rdyc(i, j)*0.5*(gridstruct%sin_sg(i, j-1, 4)+&
&             gridstruct%sin_sg(i, j, 2))
          END DO
          CALL PUSHINTEGER(i - 1)
          CALL PUSHINTEGER(ad_from3)
        END DO
        CALL PUSHINTEGER(j - 1)
        CALL PUSHINTEGER(ad_from4)
      END DO
      CALL PUSHCONTROL1B_FV(0)
    ELSE
      CALL PUSHCONTROL1B_FV(1)
    END IF
!---------------------------------------------
! Add the diffusive fluxes to the flux arrays:
!---------------------------------------------
    IF (PRESENT(mass)) THEN
! Apply mass weighting to diffusive fluxes:
      damp2 = 0.5*damp
      CALL PUSHREALARRAY(fx, 8*(bd%ie-bd%is+2)*(bd%je-bd%js+1)/8)
      CALL PUSHREALARRAY(fx2, 8*(bd%ied-bd%isd+2)*(bd%jed-bd%jsd+1)&
&                   /8)
      CALL PUSHREALARRAY(damp2)
      DO j=bd%js,bd%je
        DO i=bd%is,bd%ie+1
          fx(i, j) = fx(i, j) + damp2*(mass(i-1, j)+mass(i, j))*fx2(i, j&
&           )
        END DO
      END DO
      CALL PUSHREALARRAY(fy, 8*(bd%ie-bd%is+1)*(bd%je-bd%js+2)/8)
      DO j=bd%js,bd%je+1
        DO i=bd%is,bd%ie
          fy(i, j) = fy(i, j) + damp2*(mass(i, j-1)+mass(i, j))*fy2(i, j&
&           )
        END DO
      END DO
      CALL PUSHREALARRAY(fy2, 8*(bd%ied-bd%isd+1)*(bd%jed-bd%jsd+2)&
&                   /8)
      CALL PUSHREALARRAY(fx2, 8*(bd%ied-bd%isd+2)*(bd%jed-bd%jsd+1)&
&                   /8)
      CALL PUSHREALARRAY(damp2)
      CALL PUSHCONTROL1B_FV(0)
    ELSE
      CALL PUSHREALARRAY(fx, 8*(bd%ie-bd%is+2)*(bd%je-bd%js+1)/8)
      DO j=bd%js,bd%je
        DO i=bd%is,bd%ie+1
          fx(i, j) = fx(i, j) + fx2(i, j)
        END DO
      END DO
      CALL PUSHREALARRAY(fy, 8*(bd%ie-bd%is+1)*(bd%je-bd%js+2)/8)
      DO j=bd%js,bd%je+1
        DO i=bd%is,bd%ie
          fy(i, j) = fy(i, j) + fy2(i, j)
        END DO
      END DO
      CALL PUSHCONTROL1B_FV(1)
    END IF
  END SUBROUTINE DELN_FLUX_FWD
!  Differentiation of deln_flux in reverse (adjoint) mode, backward sweep (with options r8 split(a2b_edge_mod.a2b_ord2 a2b_edg
!e_mod.a2b_ord4 a2b_edge_mod.extrap_corner  dyn_core_mod.dyn_core dyn_core_mod.pk3_halo dyn_core_mod.pln_halo dyn_core_mod.
!pe_halo dyn_core_mod.adv_pe dyn_core_mod.p_grad_c dyn_core_mod.nh_p_grad dyn_core_mod.split_p_grad dyn_core_mod.one_grad_p dyn_c
!ore_mod.grad1_p_update dyn_core_mod.mix_dp dyn_core_mod.geopk dyn_core_mod.del2_cubed fv_dynamics_mod.fv_dynamics fv_dynamics_mo
!d.rayleigh_super fv_dynamics_mod.rayleigh_friction fv_dynamics_mod.compute_aam fv_dynamics_mod.geos_to_fv3 fv_grid_utils_mod.cub
!ed_to_latlon fv_grid_utils_mod.c2l_ord4 fv_grid_utils_mod.c2l_ord2 fv_mapz_mod.lagrangian_to_eulerian fv_mapz_mod.compute_total_
!energy fv_mapz_mod.pkez fv_mapz_mod.remap_z fv_mapz_mod.map_scalar fv_mapz_mod.map1_ppm fv_mapz_mod.mapn_tracer fv_m
!apz_mod.map1_q2 fv_mapz_mod.map1_cubic fv_mapz_mod.scalar_profile_linear fv_mapz_mod.cs_profile_linear fv_mapz_mod.stee
!pz fv_tracer2d_mod.tracer_2d fv_tracer2d_mod.tracer_2d_nested nh_core_mod.update_dz_c nh_core_mod.update_dz_d nh_core_mod.riem_s
!olver_c nh_core_mod.riem_solver3 nh_core_mod.rim_2d nh_core_mod.sim3_solver nh_core_mod.sim3p0_solver nh_core_mod.sim1_solver nh
!_core_mod.sim_solver nh_core_mod.edge_profile sw_core_mod.c_sw sw_core_mod.d_sw sw_core_mod.divergence_corner sw_core_mod.diverg
!ence_corner_nest sw_core_mod.d2a2c_vect sw_core_mod.edge_interpolate4 sw_core_mod.fill2_4corners sw_core_mod.fill_4corners sw_co
!re_mod.compute_div_damping sw_core_mod.smag_corner sw_core_mod.ytp_v sw_core_mod.xtp_u tp_core_mod.fv_tp_2d tp_co
!re_mod.copy_corners tp_core_mod.xtp tp_core_mod.ytp tp_core_mod.xppm0 tp_core_mod.yppm0 tp_core_mod.fxppm tp_c
!ore_mod.fyppm tp_core_mod.deln_flux)):
!   gradient     of useful results: q mass fx fy
!   with respect to varying inputs: q mass fx fy
  SUBROUTINE DELN_FLUX_BWD(nord, npx, npy, damp, q, q_ad, fx, fx_ad, &
&   fy, fy_ad, gridstruct, bd, mass, mass_ad)
    IMPLICIT NONE
    TYPE(FV_GRID_BOUNDS_TYPE), INTENT(IN) :: bd
    INTEGER, INTENT(IN) :: nord
    INTEGER, INTENT(IN) :: npx, npy
    REAL(fvprc), INTENT(IN) :: damp
    REAL(fvprc), INTENT(IN) :: q(bd%is-ng:bd%ie+ng, bd%js-ng:bd%je+ng)
    REAL(fvprc) :: q_ad(bd%is-ng:bd%ie+ng, bd%js-ng:bd%je+ng)
    TYPE(FV_GRID_TYPE), INTENT(IN), TARGET :: gridstruct
    REAL(fvprc), OPTIONAL, INTENT(IN) :: mass(bd%isd:bd%ied, bd%jsd:bd%&
&   jed)
    REAL(fvprc), OPTIONAL :: mass_ad(bd%isd:bd%ied, bd%jsd:bd%jed)
    REAL(fvprc), INTENT(INOUT) :: fx(bd%is:bd%ie+1, bd%js:bd%je), fy(bd%&
&   is:bd%ie, bd%js:bd%je+1)
    REAL(fvprc), INTENT(INOUT) :: fx_ad(bd%is:bd%ie+1, bd%js:bd%je), &
&   fy_ad(bd%is:bd%ie, bd%js:bd%je+1)
    REAL(fvprc) :: fx2(bd%isd:bd%ied+1, bd%jsd:bd%jed), fy2(bd%isd:bd%&
&   ied, bd%jsd:bd%jed+1)
    REAL(fvprc) :: fx2_ad(bd%isd:bd%ied+1, bd%jsd:bd%jed), fy2_ad(bd%isd&
&   :bd%ied, bd%jsd:bd%jed+1)
    REAL(fvprc) :: d2(bd%isd:bd%ied, bd%jsd:bd%jed)
    REAL(fvprc) :: d2_ad(bd%isd:bd%ied, bd%jsd:bd%jed)
    REAL(fvprc) :: damp2
    INTEGER :: i, j, n, nt, i1, i2, j1, j2
    INTEGER :: is, ie, js, je, isd, ied, jsd, jed
    INTRINSIC PRESENT
    REAL(fvprc) :: temp_ad
    REAL(fvprc) :: temp_ad0
    REAL(fvprc) :: temp_ad1
    REAL(fvprc) :: temp_ad2
    REAL(fvprc) :: temp_ad3
    INTEGER :: ad_from
    INTEGER :: ad_to
    INTEGER :: ad_from0
    INTEGER :: ad_to0
    INTEGER :: ad_from1
    INTEGER :: ad_to1
    INTEGER :: ad_from2
    INTEGER :: ad_to2
    INTEGER :: ad_from3
    INTEGER :: ad_to3
    INTEGER :: ad_from4
    INTEGER :: ad_to4
    REAL(fvprc) :: temp_ad4
    REAL(fvprc) :: temp_ad5
    INTEGER :: branch
    CALL POPCONTROL1B_FV(branch)
    IF (branch .EQ. 0) THEN
      CALL POPREALARRAY(damp2)
      CALL POPREALARRAY(fx2, 8*(bd%ied-bd%isd+2)*(bd%jed-bd%jsd+1)/&
&                  8)
      CALL POPREALARRAY(fy2, 8*(bd%ied-bd%isd+1)*(bd%jed-bd%jsd+2)/&
&                  8)
      fy2_ad = 0.0_FVPRC
      CALL POPREALARRAY(fy, 8*(bd%ie-bd%is+1)*(bd%je-bd%js+2)/8)
      DO j=bd%js,bd%je+1
        DO i=bd%ie,bd%is,-1
          temp_ad5 = damp2*fy2(i, j)*fy_ad(i, j)
          mass_ad(i, j-1) = mass_ad(i, j-1) + temp_ad5
          mass_ad(i, j) = mass_ad(i, j) + temp_ad5
          fy2_ad(i, j) = fy2_ad(i, j) + damp2*(mass(i, j-1)+mass(i, j))*&
&           fy_ad(i, j)
        END DO
      END DO
      fx2_ad = 0.0_FVPRC
      CALL POPREALARRAY(damp2)
      CALL POPREALARRAY(fx2, 8*(bd%ied-bd%isd+2)*(bd%jed-bd%jsd+1)/&
&                  8)
      CALL POPREALARRAY(fx, 8*(bd%ie-bd%is+2)*(bd%je-bd%js+1)/8)
      DO j=bd%js,bd%je
        DO i=bd%ie+1,bd%is,-1
          temp_ad4 = damp2*fx2(i, j)*fx_ad(i, j)
          mass_ad(i-1, j) = mass_ad(i-1, j) + temp_ad4
          mass_ad(i, j) = mass_ad(i, j) + temp_ad4
          fx2_ad(i, j) = fx2_ad(i, j) + damp2*(mass(i-1, j)+mass(i, j))*&
&           fx_ad(i, j)
        END DO
      END DO
    ELSE
      fy2_ad = 0.0_FVPRC
      CALL POPREALARRAY(fy, 8*(bd%ie-bd%is+1)*(bd%je-bd%js+2)/8)
      DO j=bd%js,bd%je+1
        DO i=bd%ie,bd%is,-1
          fy2_ad(i, j) = fy2_ad(i, j) + fy_ad(i, j)
        END DO
      END DO
      fx2_ad = 0.0_FVPRC
      CALL POPREALARRAY(fx, 8*(bd%ie-bd%is+2)*(bd%je-bd%js+1)/8)
      DO j=bd%js,bd%je
        DO i=bd%ie+1,bd%is,-1
          fx2_ad(i, j) = fx2_ad(i, j) + fx_ad(i, j)
        END DO
      END DO
    END IF
    CALL POPCONTROL1B_FV(branch)
    IF (branch .EQ. 0) THEN
      d2_ad = 0.0_FVPRC
      DO n=nord,1,-1
        CALL POPINTEGER(ad_from4)
        CALL POPINTEGER(ad_to4)
        DO j=ad_to4,ad_from4,-1
          CALL POPINTEGER(ad_from3)
          CALL POPINTEGER(ad_to3)
          DO i=ad_to3,ad_from3,-1
            temp_ad3 = gridstruct%dx(i, j)*0.5*gridstruct%rdyc(i, j)*(&
&             gridstruct%sin_sg(i, j-1, 4)+gridstruct%sin_sg(i, j, 2))*&
&             fy2_ad(i, j)
            d2_ad(i, j) = d2_ad(i, j) + temp_ad3
            d2_ad(i, j-1) = d2_ad(i, j-1) - temp_ad3
            fy2_ad(i, j) = 0.0_FVPRC
          END DO
        END DO
        CALL COPY_CORNERS_BWD(d2, d2_ad, npx, npy, 2, gridstruct%&
&                          nested, bd, gridstruct%sw_corner, gridstruct%&
&                          se_corner, gridstruct%nw_corner, gridstruct%&
&                          ne_corner)
        CALL POPINTEGER(ad_from2)
        CALL POPINTEGER(ad_to2)
        DO j=ad_to2,ad_from2,-1
          CALL POPINTEGER(ad_from1)
          CALL POPINTEGER(ad_to1)
          DO i=ad_to1,ad_from1,-1
            temp_ad2 = gridstruct%dy(i, j)*0.5*gridstruct%rdxc(i, j)*(&
&             gridstruct%sin_sg(i-1, j, 3)+gridstruct%sin_sg(i, j, 1))*&
&             fx2_ad(i, j)
            d2_ad(i, j) = d2_ad(i, j) + temp_ad2
            d2_ad(i-1, j) = d2_ad(i-1, j) - temp_ad2
            fx2_ad(i, j) = 0.0_FVPRC
          END DO
        END DO
        CALL COPY_CORNERS_BWD(d2, d2_ad, npx, npy, 1, gridstruct%&
&                          nested, bd, gridstruct%sw_corner, gridstruct%&
&                          se_corner, gridstruct%nw_corner, gridstruct%&
&                          ne_corner)
        CALL POPINTEGER(ad_from0)
        CALL POPINTEGER(ad_to0)
        DO j=ad_to0,ad_from0,-1
          CALL POPINTEGER(ad_from)
          CALL POPINTEGER(ad_to)
          DO i=ad_to,ad_from,-1
            temp_ad1 = gridstruct%rarea(i, j)*d2_ad(i, j)
            fx2_ad(i, j) = fx2_ad(i, j) + temp_ad1
            fx2_ad(i+1, j) = fx2_ad(i+1, j) - temp_ad1
            fy2_ad(i, j) = fy2_ad(i, j) + temp_ad1
            fy2_ad(i, j+1) = fy2_ad(i, j+1) - temp_ad1
            d2_ad(i, j) = 0.0_FVPRC
          END DO
        END DO
      END DO
    ELSE
      d2_ad = 0.0_FVPRC
    END IF
    DO j=bd%je+nord+1,bd%js-nord,-1
      DO i=bd%ie+nord,bd%is-nord,-1
        temp_ad0 = gridstruct%dx(i, j)*0.5*gridstruct%rdyc(i, j)*(&
&         gridstruct%sin_sg(i, j-1, 4)+gridstruct%sin_sg(i, j, 2))*&
&         fy2_ad(i, j)
        d2_ad(i, j-1) = d2_ad(i, j-1) + temp_ad0
        d2_ad(i, j) = d2_ad(i, j) - temp_ad0
        fy2_ad(i, j) = 0.0_FVPRC
      END DO
    END DO
    CALL POPCONTROL1B_FV(branch)
    IF (branch .NE. 0) CALL COPY_CORNERS_BWD(d2, d2_ad, npx, npy, 2, &
&                                         gridstruct%nested, bd, &
&                                         gridstruct%sw_corner, &
&                                         gridstruct%se_corner, &
&                                         gridstruct%nw_corner, &
&                                         gridstruct%ne_corner)
    DO j=bd%je+nord,bd%js-nord,-1
      DO i=bd%ie+nord+1,bd%is-nord,-1
        temp_ad = gridstruct%dy(i, j)*0.5*gridstruct%rdxc(i, j)*(&
&         gridstruct%sin_sg(i-1, j, 3)+gridstruct%sin_sg(i, j, 1))*&
&         fx2_ad(i, j)
        d2_ad(i-1, j) = d2_ad(i-1, j) + temp_ad
        d2_ad(i, j) = d2_ad(i, j) - temp_ad
        fx2_ad(i, j) = 0.0_FVPRC
      END DO
    END DO
    CALL POPCONTROL1B_FV(branch)
    IF (branch .NE. 0) CALL COPY_CORNERS_BWD(d2, d2_ad, npx, npy, 1, &
&                                         gridstruct%nested, bd, &
&                                         gridstruct%sw_corner, &
&                                         gridstruct%se_corner, &
&                                         gridstruct%nw_corner, &
&                                         gridstruct%ne_corner)
    i1 = bd%is - 1 - nord
    i2 = bd%ie + 1 + nord
    j1 = bd%js - 1 - nord
    j2 = bd%je + 1 + nord
    CALL POPCONTROL1B_FV(branch)
    IF (branch .EQ. 0) THEN
      DO j=j2,j1,-1
        DO i=i2,i1,-1
          q_ad(i, j) = q_ad(i, j) + damp*d2_ad(i, j)
          d2_ad(i, j) = 0.0_FVPRC
        END DO
      END DO
    ELSE
      DO j=j2,j1,-1
        DO i=i2,i1,-1
          q_ad(i, j) = q_ad(i, j) + d2_ad(i, j)
          d2_ad(i, j) = 0.0_FVPRC
        END DO
      END DO
    END IF
  END SUBROUTINE DELN_FLUX_BWD
!  Differentiation of copy_corners in reverse (adjoint) mode, forward sweep (with options r8 split(a2b_edge_mod.a2b_ord2 a2b_e
!dge_mod.a2b_ord4 a2b_edge_mod.extrap_corner  dyn_core_mod.dyn_core dyn_core_mod.pk3_halo dyn_core_mod.pln_halo dyn_core_mo
!d.pe_halo dyn_core_mod.adv_pe dyn_core_mod.p_grad_c dyn_core_mod.nh_p_grad dyn_core_mod.split_p_grad dyn_core_mod.one_grad_p dyn
!_core_mod.grad1_p_update dyn_core_mod.mix_dp dyn_core_mod.geopk dyn_core_mod.del2_cubed fv_dynamics_mod.fv_dynamics fv_dynamics_
!mod.rayleigh_super fv_dynamics_mod.rayleigh_friction fv_dynamics_mod.compute_aam fv_dynamics_mod.geos_to_fv3 fv_grid_utils_mod.c
!ubed_to_latlon fv_grid_utils_mod.c2l_ord4 fv_grid_utils_mod.c2l_ord2 fv_mapz_mod.lagrangian_to_eulerian fv_mapz_mod.compute_tota
!l_energy fv_mapz_mod.pkez fv_mapz_mod.remap_z fv_mapz_mod.map_scalar fv_mapz_mod.map1_ppm fv_mapz_mod.mapn_tracer fv
!_mapz_mod.map1_q2 fv_mapz_mod.map1_cubic fv_mapz_mod.scalar_profile_linear fv_mapz_mod.cs_profile_linear fv_mapz_mod.st
!eepz fv_tracer2d_mod.tracer_2d fv_tracer2d_mod.tracer_2d_nested nh_core_mod.update_dz_c nh_core_mod.update_dz_d nh_core_mod.riem
!_solver_c nh_core_mod.riem_solver3 nh_core_mod.rim_2d nh_core_mod.sim3_solver nh_core_mod.sim3p0_solver nh_core_mod.sim1_solver 
!nh_core_mod.sim_solver nh_core_mod.edge_profile sw_core_mod.c_sw sw_core_mod.d_sw sw_core_mod.divergence_corner sw_core_mod.dive
!rgence_corner_nest sw_core_mod.d2a2c_vect sw_core_mod.edge_interpolate4 sw_core_mod.fill2_4corners sw_core_mod.fill_4corners sw_
!core_mod.compute_div_damping sw_core_mod.smag_corner sw_core_mod.ytp_v sw_core_mod.xtp_u tp_core_mod.fv_tp_2d tp_
!core_mod.copy_corners tp_core_mod.xtp tp_core_mod.ytp tp_core_mod.xppm0 tp_core_mod.yppm0 tp_core_mod.fxppm tp
!_core_mod.fyppm tp_core_mod.deln_flux)):
!   gradient     of useful results: q
!   with respect to varying inputs: q
  SUBROUTINE COPY_CORNERS_FWD(q, npx, npy, dir, nested, bd, sw_corner&
&   , se_corner, nw_corner, ne_corner)
    IMPLICIT NONE
    TYPE(FV_GRID_BOUNDS_TYPE), INTENT(IN) :: bd
    INTEGER, INTENT(IN) :: npx, npy, dir
    REAL(fvprc), INTENT(INOUT) :: q(bd%isd:bd%ied, bd%jsd:bd%jed)
    LOGICAL, INTENT(IN) :: nested, sw_corner, se_corner, nw_corner, &
&   ne_corner
    INTEGER :: i, j
    INTEGER :: is, ie, js, je, isd, ied, jsd, jed
    REAL(fvprc) :: tmp
    REAL(fvprc) :: tmp0
    REAL(fvprc) :: tmp1
    REAL(fvprc) :: tmp2
    REAL(fvprc) :: tmp3
    REAL(fvprc) :: tmp4
    REAL(fvprc) :: tmp5
    REAL(fvprc) :: tmp6
    IF (nested) THEN
      CALL PUSHCONTROL3B_FV(0)
    ELSE IF (dir .EQ. 1) THEN
! XDir:
      IF (sw_corner) THEN
        DO j=1-ng,0
          DO i=1-ng,0
            tmp = q(j, 1-i)
            CALL PUSHREALARRAY(q(i, j))
            q(i, j) = tmp
          END DO
        END DO
        CALL PUSHCONTROL1B_FV(0)
      ELSE
        CALL PUSHCONTROL1B_FV(1)
      END IF
      IF (se_corner) THEN
        DO j=1-ng,0
          DO i=npx,npx+ng-1
            tmp0 = q(npy-j, i-npx+1)
            CALL PUSHREALARRAY(q(i, j))
            q(i, j) = tmp0
          END DO
        END DO
        CALL PUSHCONTROL1B_FV(0)
      ELSE
        CALL PUSHCONTROL1B_FV(1)
      END IF
      IF (ne_corner) THEN
        DO j=npy,npy+ng-1
          DO i=npx,npx+ng-1
            tmp1 = q(j, 2*npx-1-i)
            CALL PUSHREALARRAY(q(i, j))
            q(i, j) = tmp1
          END DO
        END DO
        CALL PUSHCONTROL1B_FV(0)
      ELSE
        CALL PUSHCONTROL1B_FV(1)
      END IF
      IF (nw_corner) THEN
        DO j=npy,npy+ng-1
          DO i=1-ng,0
            tmp2 = q(npy-j, i-1+npx)
            CALL PUSHREALARRAY(q(i, j))
            q(i, j) = tmp2
          END DO
        END DO
        CALL PUSHCONTROL3B_FV(2)
      ELSE
        CALL PUSHCONTROL3B_FV(1)
      END IF
    ELSE IF (dir .EQ. 2) THEN
! YDir:
      IF (sw_corner) THEN
        DO j=1-ng,0
          DO i=1-ng,0
            tmp3 = q(1-j, i)
            CALL PUSHREALARRAY(q(i, j))
            q(i, j) = tmp3
          END DO
        END DO
        CALL PUSHCONTROL1B_FV(0)
      ELSE
        CALL PUSHCONTROL1B_FV(1)
      END IF
      IF (se_corner) THEN
        DO j=1-ng,0
          DO i=npx,npx+ng-1
            tmp4 = q(npy+j-1, npx-i)
            CALL PUSHREALARRAY(q(i, j))
            q(i, j) = tmp4
          END DO
        END DO
        CALL PUSHCONTROL1B_FV(0)
      ELSE
        CALL PUSHCONTROL1B_FV(1)
      END IF
      IF (ne_corner) THEN
        DO j=npy,npy+ng-1
          DO i=npx,npx+ng-1
            tmp5 = q(2*npy-1-j, i)
            CALL PUSHREALARRAY(q(i, j))
            q(i, j) = tmp5
          END DO
        END DO
        CALL PUSHCONTROL1B_FV(0)
      ELSE
        CALL PUSHCONTROL1B_FV(1)
      END IF
      IF (nw_corner) THEN
        DO j=npy,npy+ng-1
          DO i=1-ng,0
            tmp6 = q(j+1-npx, npy-i)
            CALL PUSHREALARRAY(q(i, j))
            q(i, j) = tmp6
          END DO
        END DO
        CALL PUSHCONTROL3B_FV(5)
      ELSE
        CALL PUSHCONTROL3B_FV(4)
      END IF
    ELSE
      CALL PUSHCONTROL3B_FV(3)
    END IF
  END SUBROUTINE COPY_CORNERS_FWD
!  Differentiation of copy_corners in reverse (adjoint) mode, backward sweep (with options r8 split(a2b_edge_mod.a2b_ord2 a2b_
!edge_mod.a2b_ord4 a2b_edge_mod.extrap_corner  dyn_core_mod.dyn_core dyn_core_mod.pk3_halo dyn_core_mod.pln_halo dyn_core_m
!od.pe_halo dyn_core_mod.adv_pe dyn_core_mod.p_grad_c dyn_core_mod.nh_p_grad dyn_core_mod.split_p_grad dyn_core_mod.one_grad_p dy
!n_core_mod.grad1_p_update dyn_core_mod.mix_dp dyn_core_mod.geopk dyn_core_mod.del2_cubed fv_dynamics_mod.fv_dynamics fv_dynamics
!_mod.rayleigh_super fv_dynamics_mod.rayleigh_friction fv_dynamics_mod.compute_aam fv_dynamics_mod.geos_to_fv3 fv_grid_utils_mod.
!cubed_to_latlon fv_grid_utils_mod.c2l_ord4 fv_grid_utils_mod.c2l_ord2 fv_mapz_mod.lagrangian_to_eulerian fv_mapz_mod.compute_tot
!al_energy fv_mapz_mod.pkez fv_mapz_mod.remap_z fv_mapz_mod.map_scalar fv_mapz_mod.map1_ppm fv_mapz_mod.mapn_tracer f
!v_mapz_mod.map1_q2 fv_mapz_mod.map1_cubic fv_mapz_mod.scalar_profile_linear fv_mapz_mod.cs_profile_linear fv_mapz_mod.s
!teepz fv_tracer2d_mod.tracer_2d fv_tracer2d_mod.tracer_2d_nested nh_core_mod.update_dz_c nh_core_mod.update_dz_d nh_core_mod.rie
!m_solver_c nh_core_mod.riem_solver3 nh_core_mod.rim_2d nh_core_mod.sim3_solver nh_core_mod.sim3p0_solver nh_core_mod.sim1_solver
! nh_core_mod.sim_solver nh_core_mod.edge_profile sw_core_mod.c_sw sw_core_mod.d_sw sw_core_mod.divergence_corner sw_core_mod.div
!ergence_corner_nest sw_core_mod.d2a2c_vect sw_core_mod.edge_interpolate4 sw_core_mod.fill2_4corners sw_core_mod.fill_4corners sw
!_core_mod.compute_div_damping sw_core_mod.smag_corner sw_core_mod.ytp_v sw_core_mod.xtp_u tp_core_mod.fv_tp_2d tp
!_core_mod.copy_corners tp_core_mod.xtp tp_core_mod.ytp tp_core_mod.xppm0 tp_core_mod.yppm0 tp_core_mod.fxppm t
!p_core_mod.fyppm tp_core_mod.deln_flux)):
!   gradient     of useful results: q
!   with respect to varying inputs: q
  SUBROUTINE COPY_CORNERS_BWD(q, q_ad, npx, npy, dir, nested, bd, &
&   sw_corner, se_corner, nw_corner, ne_corner)
    IMPLICIT NONE
    TYPE(FV_GRID_BOUNDS_TYPE), INTENT(IN) :: bd
    INTEGER, INTENT(IN) :: npx, npy, dir
    REAL(fvprc), INTENT(INOUT) :: q(bd%isd:bd%ied, bd%jsd:bd%jed)
    REAL(fvprc), INTENT(INOUT) :: q_ad(bd%isd:bd%ied, bd%jsd:bd%jed)
    LOGICAL, INTENT(IN) :: nested, sw_corner, se_corner, nw_corner, &
&   ne_corner
    INTEGER :: i, j
    INTEGER :: is, ie, js, je, isd, ied, jsd, jed
    REAL(fvprc) :: tmp_ad
    REAL(fvprc) :: tmp_ad0
    REAL(fvprc) :: tmp_ad1
    REAL(fvprc) :: tmp_ad2
    REAL(fvprc) :: tmp_ad3
    REAL(fvprc) :: tmp_ad4
    REAL(fvprc) :: tmp_ad5
    REAL(fvprc) :: tmp_ad6
    INTEGER :: branch
    CALL POPCONTROL3B_FV(branch)
    IF (branch .LT. 3) THEN
      IF (branch .NE. 0) THEN
        IF (branch .NE. 1) THEN
          DO j=npy+ng-1,npy,-1
            DO i=0,1-ng,-1
              CALL POPREALARRAY(q(i, j))
              tmp_ad2 = q_ad(i, j)
              q_ad(i, j) = 0.0_FVPRC
              q_ad(npy-j, i-1+npx) = q_ad(npy-j, i-1+npx) + tmp_ad2
            END DO
          END DO
        END IF
        CALL POPCONTROL1B_FV(branch)
        IF (branch .EQ. 0) THEN
          DO j=npy+ng-1,npy,-1
            DO i=npx+ng-1,npx,-1
              CALL POPREALARRAY(q(i, j))
              tmp_ad1 = q_ad(i, j)
              q_ad(i, j) = 0.0_FVPRC
              q_ad(j, 2*npx-1-i) = q_ad(j, 2*npx-1-i) + tmp_ad1
            END DO
          END DO
        END IF
        CALL POPCONTROL1B_FV(branch)
        IF (branch .EQ. 0) THEN
          DO j=0,1-ng,-1
            DO i=npx+ng-1,npx,-1
              CALL POPREALARRAY(q(i, j))
              tmp_ad0 = q_ad(i, j)
              q_ad(i, j) = 0.0_FVPRC
              q_ad(npy-j, i-npx+1) = q_ad(npy-j, i-npx+1) + tmp_ad0
            END DO
          END DO
        END IF
        CALL POPCONTROL1B_FV(branch)
        IF (branch .EQ. 0) THEN
          DO j=0,1-ng,-1
            DO i=0,1-ng,-1
              CALL POPREALARRAY(q(i, j))
              tmp_ad = q_ad(i, j)
              q_ad(i, j) = 0.0_FVPRC
              q_ad(j, 1-i) = q_ad(j, 1-i) + tmp_ad
            END DO
          END DO
        END IF
      END IF
    ELSE IF (branch .NE. 3) THEN
      IF (branch .NE. 4) THEN
        DO j=npy+ng-1,npy,-1
          DO i=0,1-ng,-1
            CALL POPREALARRAY(q(i, j))
            tmp_ad6 = q_ad(i, j)
            q_ad(i, j) = 0.0_FVPRC
            q_ad(j+1-npx, npy-i) = q_ad(j+1-npx, npy-i) + tmp_ad6
          END DO
        END DO
      END IF
      CALL POPCONTROL1B_FV(branch)
      IF (branch .EQ. 0) THEN
        DO j=npy+ng-1,npy,-1
          DO i=npx+ng-1,npx,-1
            CALL POPREALARRAY(q(i, j))
            tmp_ad5 = q_ad(i, j)
            q_ad(i, j) = 0.0_FVPRC
            q_ad(2*npy-1-j, i) = q_ad(2*npy-1-j, i) + tmp_ad5
          END DO
        END DO
      END IF
      CALL POPCONTROL1B_FV(branch)
      IF (branch .EQ. 0) THEN
        DO j=0,1-ng,-1
          DO i=npx+ng-1,npx,-1
            CALL POPREALARRAY(q(i, j))
            tmp_ad4 = q_ad(i, j)
            q_ad(i, j) = 0.0_FVPRC
            q_ad(npy+j-1, npx-i) = q_ad(npy+j-1, npx-i) + tmp_ad4
          END DO
        END DO
      END IF
      CALL POPCONTROL1B_FV(branch)
      IF (branch .EQ. 0) THEN
        DO j=0,1-ng,-1
          DO i=0,1-ng,-1
            CALL POPREALARRAY(q(i, j))
            tmp_ad3 = q_ad(i, j)
            q_ad(i, j) = 0.0_FVPRC
            q_ad(1-j, i) = q_ad(1-j, i) + tmp_ad3
          END DO
        END DO
      END IF
    END IF
  END SUBROUTINE COPY_CORNERS_BWD
END MODULE TP_CORE_MOD_B
