!        Generated by TAPENADE     (INRIA, Ecuador team)
!  Tapenade 3.12 (r6213) - 13 Oct 2016 10:30
!
MODULE TP_CORE_MOD_D
!BOP
!
! !MODULE: tp_core --- A collection of routines to support FV transport
!
  USE FV_MP_MOD_D, ONLY : ng
  USE FV_GRID_UTILS_MOD_D, ONLY : big_number
  USE FV_ARRAYS_MOD_D, ONLY : fv_grid_type, fv_grid_bounds_type
  USE FV_ARRAYS_MOD_D, ONLY : real4, real8, fvprc
  IMPLICIT NONE
  PRIVATE 
  PUBLIC fv_tp_2d, fv_tp_2d, pert_ppm, copy_corners
  PUBLIC fv_tp_2d_tlm, fv_tp_2d_tlm, pert_ppm_tlm, copy_corners_tlm
  REAL(fvprc), PARAMETER :: r3=1./3.
  REAL(fvprc), PARAMETER :: near_zero=1.e-25
  REAL(fvprc), PARAMETER :: ppm_limiter=2.0
!#ifdef WAVE_FORM
!! Suresh & Huynh scheme 2.2 (purtabation form)
!! The wave-form is more diffusive than scheme 2.1
! real(FVPRC), parameter:: b1 =   0.0375
! real(FVPRC), parameter:: b2 =  -7./30.
! real(FVPRC), parameter:: b3 =  -23./120.
! real(FVPRC), parameter:: b4 =  13./30.
! real(FVPRC), parameter:: b5 = -11./240.
!#else
! scheme 2.1: perturbation form
  REAL(fvprc), PARAMETER :: b1=1./30.
  REAL(fvprc), PARAMETER :: b2=-(13./60.)
  REAL(fvprc), PARAMETER :: b3=-(13./60.)
  REAL(fvprc), PARAMETER :: b4=0.45
  REAL(fvprc), PARAMETER :: b5=-0.05
!#endif
  REAL(fvprc), PARAMETER :: t11=27./28., t12=-(13./28.), t13=3./7.
  REAL(fvprc), PARAMETER :: s11=11./14., s14=4./7., s15=3./14.
!----------------------------------------------------
! volume-conserving cubic with 2nd drv=0 at end point:
!----------------------------------------------------
! Non-monotonic
  REAL(fvprc), PARAMETER :: c1=-(2./14.)
  REAL(fvprc), PARAMETER :: c2=11./14.
  REAL(fvprc), PARAMETER :: c3=5./14.
!----------------------
! PPM volume mean form:
!----------------------
! 0.58333333
  REAL(fvprc), PARAMETER :: p1=7./12.
  REAL(fvprc), PARAMETER :: p2=-(1./12.)
!   q(i+0.5) = p1*(q(i-1)+q(i)) + p2*(q(i-2)+q(i+1))
  INTEGER :: is, ie, js, je, isd, ied, jsd, jed

CONTAINS
!
!EOP
!-----------------------------------------------------------------------
  SUBROUTINE FV_TP_2D(q, crx, cry, npx, npy, hord, fx, fy, xfx, yfx, &
&   gridstruct, bd, ra_x, ra_y, mfx, mfy, mass, nord, damp_c)
    IMPLICIT NONE
    TYPE(FV_GRID_BOUNDS_TYPE), INTENT(IN) :: bd
    INTEGER, INTENT(IN) :: npx, npy
    INTEGER, INTENT(IN) :: hord
!
    REAL(fvprc), INTENT(IN) :: crx(bd%is:bd%ie+1, bd%jsd:bd%jed)
!
    REAL(fvprc), INTENT(IN) :: xfx(bd%is:bd%ie+1, bd%jsd:bd%jed)
!
    REAL(fvprc), INTENT(IN) :: cry(bd%isd:bd%ied, bd%js:bd%je+1)
!
    REAL(fvprc), INTENT(IN) :: yfx(bd%isd:bd%ied, bd%js:bd%je+1)
    REAL(fvprc), INTENT(IN) :: ra_x(bd%is:bd%ie, bd%jsd:bd%jed)
    REAL(fvprc), INTENT(IN) :: ra_y(bd%isd:bd%ied, bd%js:bd%je)
! transported scalar
    REAL(fvprc), INTENT(INOUT) :: q(bd%isd:bd%ied, bd%jsd:bd%jed)
! Flux in x ( E )
    REAL(fvprc), INTENT(OUT) :: fx(bd%is:bd%ie+1, bd%js:bd%je)
! Flux in y ( N )
    REAL(fvprc), INTENT(OUT) :: fy(bd%is:bd%ie, bd%js:bd%je+1)
    TYPE(FV_GRID_TYPE), INTENT(IN), TARGET :: gridstruct
! optional Arguments:
! Mass Flux X-Dir
    REAL(fvprc), OPTIONAL, INTENT(IN) :: mfx(bd%is:bd%ie+1, bd%js:bd%je)
! Mass Flux Y-Dir
    REAL(fvprc), OPTIONAL, INTENT(IN) :: mfy(bd%is:bd%ie, bd%js:bd%je+1)
    REAL(fvprc), OPTIONAL, INTENT(IN) :: mass(bd%isd:bd%ied, bd%jsd:bd%&
&   jed)
    REAL(fvprc), OPTIONAL, INTENT(IN) :: damp_c
    INTEGER, OPTIONAL, INTENT(IN) :: nord
! Local:
    INTEGER :: ord_ou, ord_in
    REAL(fvprc) :: q_i(bd%isd:bd%ied, bd%js:bd%je)
    REAL(fvprc) :: q_j(bd%is:bd%ie, bd%jsd:bd%jed)
    REAL(fvprc) :: fx2(bd%is:bd%ie+1, bd%jsd:bd%jed)
    REAL(fvprc) :: fy2(bd%isd:bd%ied, bd%js:bd%je+1)
    REAL(fvprc) :: fyy(bd%isd:bd%ied, bd%js:bd%je+1)
    REAL(fvprc) :: fx1(bd%is:bd%ie+1)
    REAL(fvprc) :: damp
    INTEGER :: i, j
    INTRINSIC PRESENT
    REAL :: pwx1
    INTEGER :: pwy1
!   real(FVPRC), pointer, dimension(:,:) :: area, rarea
    is = bd%is
    ie = bd%ie
    js = bd%js
    je = bd%je
    isd = bd%isd
    ied = bd%ied
    jsd = bd%jsd
    jed = bd%jed
!! Initalize pointers
!   area    => gridstruct%area  
!   rarea   => gridstruct%rarea 
    ord_in = hord
    ord_ou = hord
    IF (.NOT.gridstruct%nested) CALL COPY_CORNERS(q, npx, npy, 2, &
&                                           gridstruct%nested, bd, &
&                                           gridstruct%sw_corner, &
&                                           gridstruct%se_corner, &
&                                           gridstruct%nw_corner, &
&                                           gridstruct%ne_corner)
    IF (ord_in .LT. 0) THEN
      CALL YPPM0(fy2, q, cry, ord_in, isd, ied, js, je, npx, npy, bd, &
&          gridstruct%dya, gridstruct%nested, gridstruct%grid_type)
    ELSE
      CALL YTP(fy2, q, cry, ord_in, isd, ied, js, je, npx, npy, bd, &
&        gridstruct%dya, gridstruct%nested, gridstruct%grid_type)
    END IF
    DO j=js,je+1
      DO i=isd,ied
        fyy(i, j) = yfx(i, j)*fy2(i, j)
      END DO
    END DO
    DO j=js,je
      DO i=isd,ied
        q_i(i, j) = (q(i, j)*gridstruct%area(i, j)+fyy(i, j)-fyy(i, j+1)&
&         )/ra_y(i, j)
      END DO
    END DO
    IF (ord_ou .LT. 0) THEN
      CALL XPPM0(fx, q_i, crx(is:ie+1, js:je), ord_ou, is, ie, js, je, &
&          npx, npy, bd, gridstruct%dxa, gridstruct%nested, gridstruct%&
&          grid_type)
    ELSE
      CALL XTP(fx, q_i, crx(is:ie+1, js:je), ord_ou, is, ie, js, je, npx&
&        , npy, bd, gridstruct%dxa, gridstruct%nested, gridstruct%&
&        grid_type)
    END IF
    IF (.NOT.gridstruct%nested) CALL COPY_CORNERS(q, npx, npy, 1, &
&                                           gridstruct%nested, bd, &
&                                           gridstruct%sw_corner, &
&                                           gridstruct%se_corner, &
&                                           gridstruct%nw_corner, &
&                                           gridstruct%ne_corner)
    IF (ord_in .LT. 0) THEN
      CALL XPPM0(fx2, q, crx, ord_in, is, ie, jsd, jed, npx, npy, bd, &
&          gridstruct%dxa, gridstruct%nested, gridstruct%grid_type)
    ELSE
      CALL XTP(fx2, q, crx, ord_in, is, ie, jsd, jed, npx, npy, bd, &
&        gridstruct%dxa, gridstruct%nested, gridstruct%grid_type)
    END IF
    DO j=jsd,jed
      DO i=is,ie+1
        fx1(i) = xfx(i, j)*fx2(i, j)
      END DO
      DO i=is,ie
        q_j(i, j) = (q(i, j)*gridstruct%area(i, j)+fx1(i)-fx1(i+1))/ra_x&
&         (i, j)
      END DO
    END DO
    IF (ord_ou .LT. 0) THEN
      CALL YPPM0(fy, q_j, cry, ord_ou, is, ie, js, je, npx, npy, bd, &
&          gridstruct%dya, gridstruct%nested, gridstruct%grid_type)
    ELSE
      CALL YTP(fy, q_j, cry, ord_ou, is, ie, js, je, npx, npy, bd, &
&        gridstruct%dya, gridstruct%nested, gridstruct%grid_type)
    END IF
!----------------
! Flux averaging:
!----------------
    IF (PRESENT(mfx) .AND. PRESENT(mfy)) THEN
!---------------------------------
! For transport of pt and tracers
!---------------------------------
      DO j=js,je
        DO i=is,ie+1
          fx(i, j) = 0.5*(fx(i, j)+fx2(i, j))*mfx(i, j)
        END DO
      END DO
      DO j=js,je+1
        DO i=is,ie
          fy(i, j) = 0.5*(fy(i, j)+fy2(i, j))*mfy(i, j)
        END DO
      END DO
      IF (PRESENT(nord) .AND. PRESENT(damp_c) .AND. PRESENT(mass)) THEN
        IF (damp_c .GT. 1.e-4) THEN
          pwx1 = damp_c*gridstruct%da_min
          pwy1 = nord + 1
          damp = pwx1**pwy1
          CALL DELN_FLUX(nord, npx, npy, damp, q, fx, fy, gridstruct, bd&
&                  , mass)
        END IF
      END IF
    ELSE
!---------------------------------
! For transport of delp, vorticity
!---------------------------------
      DO j=js,je
        DO i=is,ie+1
          fx(i, j) = 0.5*(fx(i, j)+fx2(i, j))*xfx(i, j)
        END DO
      END DO
      DO j=js,je+1
        DO i=is,ie
          fy(i, j) = 0.5*(fy(i, j)+fy2(i, j))*yfx(i, j)
        END DO
      END DO
      IF (PRESENT(nord) .AND. PRESENT(damp_c)) THEN
        IF (damp_c .GT. 1.e-4) THEN
          pwx1 = damp_c*gridstruct%da_min
          pwy1 = nord + 1
          damp = pwx1**pwy1
          CALL DELN_FLUX(nord, npx, npy, damp, q, fx, fy, gridstruct, bd&
&                 )
        END IF
      END IF
    END IF
  END SUBROUTINE FV_TP_2D
  SUBROUTINE XTP(fx, q, c, iord, ifirst, ilast, jfirst, jlast, npx, npy&
&   , bd, dxa, nested, grid_type)
    IMPLICIT NONE
    TYPE(FV_GRID_BOUNDS_TYPE), INTENT(IN) :: bd
!  X-Dir strip
    INTEGER, INTENT(IN) :: ifirst, ilast
!  Y-Dir strip
    INTEGER, INTENT(IN) :: jfirst, jlast
    INTEGER, INTENT(IN) :: npx, npy
    INTEGER, INTENT(IN) :: iord
! Courant numbers
    REAL(fvprc), INTENT(IN) :: c(bd%is:bd%ie+1, jfirst:jlast)
    REAL(fvprc), INTENT(IN) :: q(bd%isd:bd%ied, jfirst:jlast)
    REAL(fvprc), INTENT(OUT) :: fx(ifirst:ilast+1, jfirst:jlast)
    REAL(fvprc), INTENT(IN) :: dxa(bd%isd:bd%ied, bd%jsd:bd%jed)
    LOGICAL, INTENT(IN) :: nested
    INTEGER, INTENT(IN) :: grid_type
! Local:
    REAL(fvprc) :: dm(bd%is-2:bd%ie+2)
    REAL(fvprc) :: x0l, x0r, x1
    INTEGER :: i, j
    INTRINSIC ABS
    INTRINSIC MAX
    INTRINSIC MIN
    INTRINSIC SIGN
    REAL(fvprc) :: min1
    REAL(fvprc) :: min2
    REAL(fvprc) :: min3
    REAL(fvprc) :: min4
    REAL(fvprc) :: min5
    REAL(fvprc) :: max1
    REAL(fvprc) :: min6
    REAL(fvprc) :: max2
    REAL(fvprc) :: min7
    REAL(fvprc) :: max3
    REAL(fvprc) :: min8
    REAL(fvprc) :: max4
    REAL(fvprc) :: min9
    REAL(fvprc) :: max5
    REAL(fvprc) :: min10
    REAL(fvprc) :: x6
    REAL(fvprc) :: x5
    REAL(fvprc) :: x4
    REAL(fvprc) :: x3
    REAL(fvprc) :: x2
    REAL(fvprc) :: z5
    REAL(fvprc) :: z4
    REAL(fvprc) :: z3
    REAL(fvprc) :: z2
    REAL(fvprc) :: z1
    REAL(fvprc) :: y5
    REAL(fvprc) :: y4
    REAL(fvprc) :: y3
    REAL(fvprc) :: y2
    REAL(fvprc) :: y1
    IF (iord .EQ. 1) THEN
      DO j=jfirst,jlast
        DO i=ifirst,ilast+1
          IF (c(i, j) .GT. 0.) THEN
            fx(i, j) = q(i-1, j)
          ELSE
            fx(i, j) = q(i, j)
          END IF
        END DO
      END DO
    ELSE IF (iord .EQ. 333) THEN
!Advection using third order scheme
      DO j=jfirst,jlast
        DO i=ifirst,ilast+1
          IF (c(i, j) .GT. 0.) THEN
            fx(i, j) = (2.0*q(i, j)+5.0*q(i-1, j)-q(i-2, j))/6.0 - 0.5*c&
&             (i, j)*(q(i, j)-q(i-1, j)) + c(i, j)*c(i, j)/6.0*(q(i, j)-&
&             2.0*q(i-1, j)+q(i-2, j))
          ELSE
            fx(i, j) = (2.0*q(i-1, j)+5.0*q(i, j)-q(i+1, j))/6.0 - 0.5*c&
&             (i, j)*(q(i, j)-q(i-1, j)) + c(i, j)*c(i, j)/6.0*(q(i+1, j&
&             )-2.0*q(i, j)+q(i-1, j))
          END IF
        END DO
      END DO
    ELSE IF (iord .EQ. 2) THEN
      DO j=jfirst,jlast
        DO i=is-2,ie+2
          dm(i) = 0.25*(q(i+1, j)-q(i-1, j))
          IF (dm(i) .GE. 0.) THEN
            x2 = dm(i)
          ELSE
            x2 = -dm(i)
          END IF
          IF (q(i-1, j) .LT. q(i, j)) THEN
            IF (q(i, j) .LT. q(i+1, j)) THEN
              max1 = q(i+1, j)
            ELSE
              max1 = q(i, j)
            END IF
          ELSE IF (q(i-1, j) .LT. q(i+1, j)) THEN
            max1 = q(i+1, j)
          ELSE
            max1 = q(i-1, j)
          END IF
          y1 = max1 - q(i, j)
          IF (q(i-1, j) .GT. q(i, j)) THEN
            IF (q(i, j) .GT. q(i+1, j)) THEN
              min6 = q(i+1, j)
            ELSE
              min6 = q(i, j)
            END IF
          ELSE IF (q(i-1, j) .GT. q(i+1, j)) THEN
            min6 = q(i+1, j)
          ELSE
            min6 = q(i-1, j)
          END IF
          z1 = q(i, j) - min6
          IF (x2 .GT. y1) THEN
            IF (y1 .GT. z1) THEN
              min1 = z1
            ELSE
              min1 = y1
            END IF
          ELSE IF (x2 .GT. z1) THEN
            min1 = z1
          ELSE
            min1 = x2
          END IF
          dm(i) = SIGN(min1, dm(i))
        END DO
        IF (grid_type .LT. 3 .AND. (.NOT.nested)) THEN
!--------------
! fix the edges 
!  NOW: interpolation to the edge (originally from PL07, appendix C) generalized first for variable dx, then for dx which differs
! between the two sides of the edge
!--------------
          IF (is .EQ. 1) THEN
!             x0 = 0.5*(3.0*(q(0,j)+q(1,j))   &
!                - (q(-1,j)+q(2,j)))/ ( 2.0 )
!             x0 = 0.5*((2.*dxa(1,j)+dxa(2,j))*(q(0,j)+q(1,j))   &
!                - dxa(1,j)*(q(-1,j)+q(2,j)))/ ( dxa(1,j)+dxa(2,j))
            x0l = 0.5*((2.*dxa(0, j)+dxa(-1, j))*q(0, j)-dxa(0, j)*q(-1&
&             , j))/(dxa(0, j)+dxa(-1, j))
            x0r = 0.5*((2.*dxa(1, j)+dxa(2, j))*q(1, j)-dxa(1, j)*q(2, j&
&             ))/(dxa(1, j)+dxa(2, j))
            x1 = s15*q(1, j) + s11*q(2, j) - s14*dm(2)
            dm(1) = 0.5*(x1-x0l-x0r)
            IF (dm(1) .GE. 0.) THEN
              x3 = dm(1)
            ELSE
              x3 = -dm(1)
            END IF
            IF (q(1, j) .LT. x0l + x0r) THEN
              IF (x0l + x0r .LT. x1) THEN
                max2 = x1
              ELSE
                max2 = x0l + x0r
              END IF
            ELSE IF (q(1, j) .LT. x1) THEN
              max2 = x1
            ELSE
              max2 = q(1, j)
            END IF
            y2 = max2 - q(1, j)
            IF (q(1, j) .GT. x0l + x0r) THEN
              IF (x0l + x0r .GT. x1) THEN
                min7 = x1
              ELSE
                min7 = x0l + x0r
              END IF
            ELSE IF (q(1, j) .GT. x1) THEN
              min7 = x1
            ELSE
              min7 = q(1, j)
            END IF
            z2 = q(1, j) - min7
            IF (x3 .GT. y2) THEN
              IF (y2 .GT. z2) THEN
                min2 = z2
              ELSE
                min2 = y2
              END IF
            ELSE IF (x3 .GT. z2) THEN
              min2 = z2
            ELSE
              min2 = x3
            END IF
            dm(1) = SIGN(min2, dm(1))
!
            x1 = s15*q(0, j) + s11*q(-1, j) + s14*dm(-1)
            dm(0) = 0.5*(x0r+x0l-x1)
            IF (dm(0) .GE. 0.) THEN
              x4 = dm(0)
            ELSE
              x4 = -dm(0)
            END IF
            IF (q(0, j) .LT. x0l + x0r) THEN
              IF (x0l + x0r .LT. x1) THEN
                max3 = x1
              ELSE
                max3 = x0l + x0r
              END IF
            ELSE IF (q(0, j) .LT. x1) THEN
              max3 = x1
            ELSE
              max3 = q(0, j)
            END IF
            y3 = max3 - q(0, j)
            IF (q(0, j) .GT. x0l + x0r) THEN
              IF (x0l + x0r .GT. x1) THEN
                min8 = x1
              ELSE
                min8 = x0l + x0r
              END IF
            ELSE IF (q(0, j) .GT. x1) THEN
              min8 = x1
            ELSE
              min8 = q(0, j)
            END IF
            z3 = q(0, j) - min8
            IF (x4 .GT. y3) THEN
              IF (y3 .GT. z3) THEN
                min3 = z3
              ELSE
                min3 = y3
              END IF
            ELSE IF (x4 .GT. z3) THEN
              min3 = z3
            ELSE
              min3 = x4
            END IF
            dm(0) = SIGN(min3, dm(0))
          END IF
          IF (ie + 1 .EQ. npx) THEN
!              x0 = 0.5*(3.0*(q(npx-1,j)+q(npx,j))   &
!                - (q(npx-2,j)+q(npx+1,j)))/( 2.0 )
!              x0 = 0.5*( (2.*dxa(npx-1,j)+dxa(npx-2,j))*(q(npx-1,j)+q(npx,j))   &
!                - dxa(npx-1,j)*(q(npx-2,j)+q(npx+1,j)))/( dxa(npx-1,j)+dxa(npx-2,j))
            x0l = 0.5*((2.*dxa(npx-1, j)+dxa(npx-2, j))*q(npx-1, j)-dxa(&
&             npx-1, j)*q(npx-2, j))/(dxa(npx-1, j)+dxa(npx-2, j))
            x0r = 0.5*((2.*dxa(npx, j)+dxa(npx+1, j))*q(npx, j)-dxa(npx&
&             , j)*q(npx+1, j))/(dxa(npx, j)+dxa(npx+1, j))
            x1 = s15*q(npx-1, j) + s11*q(npx-2, j) + s14*dm(npx-2)
            dm(npx-1) = 0.5*(x0r+x0l-x1)
            IF (dm(npx-1) .GE. 0.) THEN
              x5 = dm(npx-1)
            ELSE
              x5 = -dm(npx-1)
            END IF
            IF (q(npx-1, j) .LT. x0l + x0r) THEN
              IF (x0l + x0r .LT. x1) THEN
                max4 = x1
              ELSE
                max4 = x0l + x0r
              END IF
            ELSE IF (q(npx-1, j) .LT. x1) THEN
              max4 = x1
            ELSE
              max4 = q(npx-1, j)
            END IF
            y4 = max4 - q(npx-1, j)
            IF (q(npx-1, j) .GT. x0l + x0r) THEN
              IF (x0l + x0r .GT. x1) THEN
                min9 = x1
              ELSE
                min9 = x0l + x0r
              END IF
            ELSE IF (q(npx-1, j) .GT. x1) THEN
              min9 = x1
            ELSE
              min9 = q(npx-1, j)
            END IF
            z4 = q(npx-1, j) - min9
            IF (x5 .GT. y4) THEN
              IF (y4 .GT. z4) THEN
                min4 = z4
              ELSE
                min4 = y4
              END IF
            ELSE IF (x5 .GT. z4) THEN
              min4 = z4
            ELSE
              min4 = x5
            END IF
            dm(npx-1) = SIGN(min4, dm(npx-1))
!
            x1 = s15*q(npx, j) + s11*q(npx+1, j) - s14*dm(npx+1)
            dm(npx) = 0.5*(x1-x0r-x0l)
            IF (dm(npx) .GE. 0.) THEN
              x6 = dm(npx)
            ELSE
              x6 = -dm(npx)
            END IF
            IF (q(npx, j) .LT. x0l + x0r) THEN
              IF (x0l + x0r .LT. x1) THEN
                max5 = x1
              ELSE
                max5 = x0l + x0r
              END IF
            ELSE IF (q(npx, j) .LT. x1) THEN
              max5 = x1
            ELSE
              max5 = q(npx, j)
            END IF
            y5 = max5 - q(npx, j)
            IF (q(npx, j) .GT. x0l + x0r) THEN
              IF (x0l + x0r .GT. x1) THEN
                min10 = x1
              ELSE
                min10 = x0l + x0r
              END IF
            ELSE IF (q(npx, j) .GT. x1) THEN
              min10 = x1
            ELSE
              min10 = q(npx, j)
            END IF
            z5 = q(npx, j) - min10
            IF (x6 .GT. y5) THEN
              IF (y5 .GT. z5) THEN
                min5 = z5
              ELSE
                min5 = y5
              END IF
            ELSE IF (x6 .GT. z5) THEN
              min5 = z5
            ELSE
              min5 = x6
            END IF
            dm(npx) = SIGN(min5, dm(npx))
          END IF
        END IF
        DO i=is,ie+1
          IF (c(i, j) .GT. 0.) THEN
            fx(i, j) = q(i-1, j) + (1.-c(i, j))*dm(i-1)
          ELSE
            fx(i, j) = q(i, j) - (1.+c(i, j))*dm(i)
          END IF
        END DO
      END DO
    ELSE
      CALL FXPPM(c, q, fx, iord, ifirst, ilast, jfirst, jlast, npx, npy&
&          , bd, dxa, nested, grid_type)
    END IF
  END SUBROUTINE XTP
  SUBROUTINE YTP(fy, q, c, jord, ifirst, ilast, jfirst, jlast, npx, npy&
&   , bd, dya, nested, grid_type)
    IMPLICIT NONE
    TYPE(FV_GRID_BOUNDS_TYPE), INTENT(IN) :: bd
    INTEGER, INTENT(IN) :: npx, npy
!  X-Dir strip
    INTEGER, INTENT(IN) :: ifirst, ilast
!  Y-Dir strip
    INTEGER, INTENT(IN) :: jfirst, jlast
    INTEGER, INTENT(IN) :: jord
    REAL(fvprc), INTENT(IN) :: q(ifirst:ilast, jfirst-ng:jlast+ng)
! Courant number
    REAL(fvprc), INTENT(IN) :: c(bd%isd:bd%ied, bd%js:bd%je+1)
!  Flux
    REAL(fvprc), INTENT(OUT) :: fy(ifirst:ilast, jfirst:jlast+1)
    REAL(fvprc), INTENT(IN) :: dya(bd%isd:bd%ied, bd%jsd:bd%jed)
    LOGICAL, INTENT(IN) :: nested
    INTEGER, INTENT(IN) :: grid_type
! !LOCAL VARIABLES:
    REAL(fvprc) :: dm(ifirst:ilast, jfirst-2:jlast+2)
    REAL(fvprc) :: x0l, x0r, x1
    INTEGER :: i, j
    INTRINSIC ABS
    INTRINSIC MAX
    INTRINSIC MIN
    INTRINSIC SIGN
    REAL(fvprc) :: min1
    REAL(fvprc) :: min2
    REAL(fvprc) :: min3
    REAL(fvprc) :: min4
    REAL(fvprc) :: min5
    REAL(fvprc) :: max1
    REAL(fvprc) :: min6
    REAL(fvprc) :: max2
    REAL(fvprc) :: min7
    REAL(fvprc) :: max3
    REAL(fvprc) :: min8
    REAL(fvprc) :: max4
    REAL(fvprc) :: min9
    REAL(fvprc) :: max5
    REAL(fvprc) :: min10
    REAL(fvprc) :: x6
    REAL(fvprc) :: x5
    REAL(fvprc) :: x4
    REAL(fvprc) :: x3
    REAL(fvprc) :: x2
    REAL(fvprc) :: z5
    REAL(fvprc) :: z4
    REAL(fvprc) :: z3
    REAL(fvprc) :: z2
    REAL(fvprc) :: z1
    REAL(fvprc) :: y5
    REAL(fvprc) :: y4
    REAL(fvprc) :: y3
    REAL(fvprc) :: y2
    REAL(fvprc) :: y1
    IF (jord .EQ. 1) THEN
      DO j=jfirst,jlast+1
        DO i=ifirst,ilast
          IF (c(i, j) .GT. 0.) THEN
            fy(i, j) = q(i, j-1)
          ELSE
            fy(i, j) = q(i, j)
          END IF
        END DO
      END DO
    ELSE IF (jord .EQ. 333) THEN
!Advected using third order scheme
      DO j=jfirst,jlast+1
        DO i=ifirst,ilast
          IF (c(i, j) .GT. 0.) THEN
            fy(i, j) = (2.0*q(i, j)+5.0*q(i, j-1)-q(i, j-2))/6.0 - 0.5*c&
&             (i, j)*(q(i, j)-q(i, j-1)) + c(i, j)*c(i, j)/6.0*(q(i, j)-&
&             2.0*q(i, j-1)+q(i, j-2))
          ELSE
            fy(i, j) = (2.0*q(i, j-1)+5.0*q(i, j)-q(i, j+1))/6.0 - 0.5*c&
&             (i, j)*(q(i, j)-q(i, j-1)) + c(i, j)*c(i, j)/6.0*(q(i, j+1&
&             )-2.0*q(i, j)+q(i, j-1))
          END IF
        END DO
      END DO
    ELSE IF (jord .EQ. 2) THEN
      DO j=jfirst-2,jlast+2
        DO i=ifirst,ilast
          dm(i, j) = 0.25*(q(i, j+1)-q(i, j-1))
          IF (dm(i, j) .GE. 0.) THEN
            x2 = dm(i, j)
          ELSE
            x2 = -dm(i, j)
          END IF
          IF (q(i, j-1) .LT. q(i, j)) THEN
            IF (q(i, j) .LT. q(i, j+1)) THEN
              max1 = q(i, j+1)
            ELSE
              max1 = q(i, j)
            END IF
          ELSE IF (q(i, j-1) .LT. q(i, j+1)) THEN
            max1 = q(i, j+1)
          ELSE
            max1 = q(i, j-1)
          END IF
          y1 = max1 - q(i, j)
          IF (q(i, j-1) .GT. q(i, j)) THEN
            IF (q(i, j) .GT. q(i, j+1)) THEN
              min6 = q(i, j+1)
            ELSE
              min6 = q(i, j)
            END IF
          ELSE IF (q(i, j-1) .GT. q(i, j+1)) THEN
            min6 = q(i, j+1)
          ELSE
            min6 = q(i, j-1)
          END IF
          z1 = q(i, j) - min6
          IF (x2 .GT. y1) THEN
            IF (y1 .GT. z1) THEN
              min1 = z1
            ELSE
              min1 = y1
            END IF
          ELSE IF (x2 .GT. z1) THEN
            min1 = z1
          ELSE
            min1 = x2
          END IF
          dm(i, j) = SIGN(min1, dm(i, j))
        END DO
      END DO
!--------------
! Fix the edges:
!--------------
      IF (grid_type .LT. 3 .AND. (.NOT.nested)) THEN
        IF (js .EQ. 1) THEN
          DO i=ifirst,ilast
!            x0 = 0.5*(3.0*(q(i,0)+q(i,1))   &
!               - (q(i,-1)+q(i,2))) / ( 2.0 )
!            x0 = 0.5*((2.*dya(i,1)+dya(i,2))*(q(i,0)+q(i,1))   &
!               -dya(i,1)*(q(i,-1)+q(i,2))) / ( dya(i,1)+dya(i,2) )
            x0l = 0.5*((2.*dya(i, 0)+dya(i, -1))*q(i, 0)-dya(i, 0)*q(i, &
&             -1))/(dya(i, 0)+dya(i, -1))
            x0r = 0.5*((2.*dya(i, 1)+dya(i, 2))*q(i, 1)-dya(i, 1)*q(i, 2&
&             ))/(dya(i, 1)+dya(i, 2))
            x1 = s15*q(i, 1) + s11*q(i, 2) - s14*dm(i, 2)
            dm(i, 1) = 0.5*(x1-x0l-x0r)
            IF (dm(i, 1) .GE. 0.) THEN
              x3 = dm(i, 1)
            ELSE
              x3 = -dm(i, 1)
            END IF
            IF (q(i, 1) .LT. x0l + x0r) THEN
              IF (x0l + x0r .LT. x1) THEN
                max2 = x1
              ELSE
                max2 = x0l + x0r
              END IF
            ELSE IF (q(i, 1) .LT. x1) THEN
              max2 = x1
            ELSE
              max2 = q(i, 1)
            END IF
            y2 = max2 - q(i, 1)
            IF (q(i, 1) .GT. x0l + x0r) THEN
              IF (x0l + x0r .GT. x1) THEN
                min7 = x1
              ELSE
                min7 = x0l + x0r
              END IF
            ELSE IF (q(i, 1) .GT. x1) THEN
              min7 = x1
            ELSE
              min7 = q(i, 1)
            END IF
            z2 = q(i, 1) - min7
            IF (x3 .GT. y2) THEN
              IF (y2 .GT. z2) THEN
                min2 = z2
              ELSE
                min2 = y2
              END IF
            ELSE IF (x3 .GT. z2) THEN
              min2 = z2
            ELSE
              min2 = x3
            END IF
            dm(i, 1) = SIGN(min2, dm(i, 1))
!
            x1 = s15*q(i, 0) + s11*q(i, -1) + s14*dm(i, -1)
            dm(i, 0) = 0.5*(x0l+x0r-x1)
            IF (dm(i, 0) .GE. 0.) THEN
              x4 = dm(i, 0)
            ELSE
              x4 = -dm(i, 0)
            END IF
            IF (q(i, 0) .LT. x0l + x0r) THEN
              IF (x0l + x0r .LT. x1) THEN
                max3 = x1
              ELSE
                max3 = x0l + x0r
              END IF
            ELSE IF (q(i, 0) .LT. x1) THEN
              max3 = x1
            ELSE
              max3 = q(i, 0)
            END IF
            y3 = max3 - q(i, 0)
            IF (q(i, 0) .GT. x0l + x0r) THEN
              IF (x0l + x0r .GT. x1) THEN
                min8 = x1
              ELSE
                min8 = x0l + x0r
              END IF
            ELSE IF (q(i, 0) .GT. x1) THEN
              min8 = x1
            ELSE
              min8 = q(i, 0)
            END IF
            z3 = q(i, 0) - min8
            IF (x4 .GT. y3) THEN
              IF (y3 .GT. z3) THEN
                min3 = z3
              ELSE
                min3 = y3
              END IF
            ELSE IF (x4 .GT. z3) THEN
              min3 = z3
            ELSE
              min3 = x4
            END IF
            dm(i, 0) = SIGN(min3, dm(i, 0))
          END DO
        END IF
        IF (je + 1 .EQ. npy) THEN
          DO i=ifirst,ilast
!            x0 = 0.5*(3.0*(q(i,npy-1)+q(i,npy))  &
!               - (q(i,npy-2)+q(i,npy+1)))/(2.0)
!            x0 = 0.5*((2.*dya(i,npy-1)+dya(i,npy-2))*(q(i,npy-1)+q(i,npy))  &
!               -dya(i,npy-1)*(q(i,npy-2)+q(i,npy+1)))/(dya(i,npy-1)+dya(i,npy-2))
            x0l = 0.5*((2.*dya(i, npy-1)+dya(i, npy-2))*q(i, npy-1)-dya(&
&             i, npy-1)*q(i, npy-2))/(dya(i, npy-1)+dya(i, npy-2))
            x0r = 0.5*((2.*dya(i, npy)+dya(i, npy+1))*q(i, npy)-dya(i, &
&             npy)*q(i, npy+1))/(dya(i, npy)+dya(i, npy+1))
            x1 = s15*q(i, npy-1) + s11*q(i, npy-2) + s14*dm(i, npy-2)
            dm(i, npy-1) = 0.5*(x0l+x0r-x1)
            IF (dm(i, npy-1) .GE. 0.) THEN
              x5 = dm(i, npy-1)
            ELSE
              x5 = -dm(i, npy-1)
            END IF
            IF (q(i, npy-1) .LT. x0l + x0r) THEN
              IF (x0l + x0r .LT. x1) THEN
                max4 = x1
              ELSE
                max4 = x0l + x0r
              END IF
            ELSE IF (q(i, npy-1) .LT. x1) THEN
              max4 = x1
            ELSE
              max4 = q(i, npy-1)
            END IF
            y4 = max4 - q(i, npy-1)
            IF (q(i, npy-1) .GT. x0l + x0r) THEN
              IF (x0l + x0r .GT. x1) THEN
                min9 = x1
              ELSE
                min9 = x0l + x0r
              END IF
            ELSE IF (q(i, npy-1) .GT. x1) THEN
              min9 = x1
            ELSE
              min9 = q(i, npy-1)
            END IF
            z4 = q(i, npy-1) - min9
            IF (x5 .GT. y4) THEN
              IF (y4 .GT. z4) THEN
                min4 = z4
              ELSE
                min4 = y4
              END IF
            ELSE IF (x5 .GT. z4) THEN
              min4 = z4
            ELSE
              min4 = x5
            END IF
            dm(i, npy-1) = SIGN(min4, dm(i, npy-1))
!
            x1 = s15*q(i, npy) + s11*q(i, npy+1) - s14*dm(i, npy+1)
            dm(i, npy) = 0.5*(x1-x0l-x0r)
            IF (dm(i, npy) .GE. 0.) THEN
              x6 = dm(i, npy)
            ELSE
              x6 = -dm(i, npy)
            END IF
            IF (q(i, npy) .LT. x0l + x0r) THEN
              IF (x0l + x0r .LT. x1) THEN
                max5 = x1
              ELSE
                max5 = x0l + x0r
              END IF
            ELSE IF (q(i, npy) .LT. x1) THEN
              max5 = x1
            ELSE
              max5 = q(i, npy)
            END IF
            y5 = max5 - q(i, npy)
            IF (q(i, npy) .GT. x0l + x0r) THEN
              IF (x0l + x0r .GT. x1) THEN
                min10 = x1
              ELSE
                min10 = x0l + x0r
              END IF
            ELSE IF (q(i, npy) .GT. x1) THEN
              min10 = x1
            ELSE
              min10 = q(i, npy)
            END IF
            z5 = q(i, npy) - min10
            IF (x6 .GT. y5) THEN
              IF (y5 .GT. z5) THEN
                min5 = z5
              ELSE
                min5 = y5
              END IF
            ELSE IF (x6 .GT. z5) THEN
              min5 = z5
            ELSE
              min5 = x6
            END IF
            dm(i, npy) = SIGN(min5, dm(i, npy))
          END DO
        END IF
      END IF
      DO j=jfirst,jlast+1
        DO i=ifirst,ilast
          IF (c(i, j) .GT. 0.) THEN
            fy(i, j) = q(i, j-1) + (1.-c(i, j))*dm(i, j-1)
          ELSE
            fy(i, j) = q(i, j) - (1.+c(i, j))*dm(i, j)
          END IF
        END DO
      END DO
    ELSE
      CALL FYPPM(c, q, fy, jord, ifirst, ilast, jfirst, jlast, npx, npy&
&          , dm, bd, dya, nested, grid_type)
    END IF
  END SUBROUTINE YTP
!#ifdef XPPM_2D
! subroutine xppm0(flux, q, c, iord, ifirst, ilast, jfirst, jlast, npx, npy, bd, dxa, nested, grid_type)
! type(fv_grid_bounds_type), intent(IN) :: bd
! integer, INTENT(IN) :: ifirst, ilast               !  X-Dir strip
! integer, INTENT(IN) :: jfirst, jlast               !  Y-Dir strip
! integer, INTENT(IN) :: iord
! integer, INTENT(IN) :: npx, npy
! real(FVPRC)   , INTENT(IN) :: q(ifirst-ng:ilast+ng,jfirst:jlast)
! real(FVPRC)   , INTENT(IN) :: c(ifirst   :ilast+1 ,jfirst:jlast) ! Courant   N (like FLUX)
! real(FVPRC)   , intent(IN) :: dxa(bd%isd:bd%ied,bd%jsd:bd%jed)
! logical, intent(IN) :: nested
! integer, intent(IN) :: grid_type
!! !OUTPUT PARAMETERS:
! real(FVPRC)  , INTENT(OUT) :: flux(ifirst:ilast+1,jfirst:jlast) !  Flux
!! Local
! real(FVPRC), dimension(3*jfirst:3*jlast+2) :: q_tmp, bl_tmp, br_tmp
! real(FVPRC), dimension(ifirst-1:ilast+1,jfirst:jlast):: bl, br
! real(FVPRC)  al(ifirst-1:ilast+2,jfirst:jlast)
! real(FVPRC)  dm(ifirst-2:ilast+2,jfirst:jlast)
! real(FVPRC)  dq(ifirst-3:ilast+2,jfirst:jlast)
! logical extm(ifirst-2:ilast+2,jfirst:jlast)
! integer i, j, ie3, is1, ie1
! real(FVPRC) xt, pmp_1, lac_1, pmp_2, lac_2
!
! if ( .not. nested .and. grid_type<3 ) then
!    is1 = max(3,is-1);  ie3 = min(npx-2,ie+2)
!                        ie1 = min(npx-3,ie+1)
! else
!    is1 = is-1;         ie3 = ie+2
!                        ie1 = ie+1
! end if
!
! if ( abs(iord) < 8 ) then
!
!    ! ord = -5: linear scheme based on PPM 4th order interpolation
!    ! ord = -6: linear PPM with 2-delta filter
!    ! ord = -7: (-6) with additional Positive definite constraint:
!
!    do j=jfirst,jlast
!       do i=is1, ie3
!          al(i,j) = p1*(q(i-1,j)+q(i,j)) + p2*(q(i-2,j)+q(i+1,j))
!       enddo
!    enddo
!    if ( .not. nested .and. grid_type<3 ) then
!       if ( is==1 ) then
!          do j=jfirst,jlast
!             al(0,j) = c1*q(-2,j) + c2*q(-1,j) + c3*q(0,j)
!             al(1,j) = 0.5*(((2.*dxa(0,j)+dxa(-1,j))*q(0,j)-dxa(0,j)*q(-1,j))/(dxa(-1,j)+dxa(0,j)) &
!                  +      ((2.*dxa(1,j)+dxa( 2,j))*q(1,j)-dxa(1,j)*q(2,j))/(dxa(1, j)+dxa(2,j)))
!             al(2,j) = c3*q(1,j) + c2*q(2,j) +c1*q(3,j)
!          enddo
!          if(iord==-7) then
!             do j=jfirst,jlast
!                al(0,j) = max(0., al(0,j))
!                al(1,j) = max(0., al(1,j))
!                al(2,j) = max(0., al(2,j))
!             enddo
!          endif
!       endif
!       if ( (ie+1)==npx ) then
!          do j=jfirst,jlast
!             al(npx-1,j) = c1*q(npx-3,j) + c2*q(npx-2,j) + c3*q(npx-1,j)
!             al(npx,j) = 0.5*(((2.*dxa(npx-1,j)+dxa(npx-2,j))*q(npx-1,j)-dxa(npx-1,j)*q(npx-2,j))/(dxa(npx-2,j)+dxa(npx-1,j)) &
!                  +      ((2.*dxa(npx,  j)+dxa(npx+1,j))*q(npx,j)-dxa(npx,  j)*q(npx+1,j))/(dxa(npx,  j)+dxa(npx+1,j)))
!             al(npx+1,j) = c3*q(npx,j) + c2*q(npx+1,j) + c1*q(npx+2,j)
!          enddo
!          if(iord==-7) then
!             do j=jfirst,jlast
!                al(npx-1,j) = max(0., al(npx-1,j))
!                al(npx,  j) = max(0., al(npx  ,j))
!                al(npx+1,j) = max(0., al(npx+1,j))
!             enddo
!          endif
!       endif
!    endif
!
!    if ( iord==-5 ) then
!       do j=jfirst,jlast
!          do i=ifirst-1,ilast+1
!             bl(i,j) = al(i,j)   - q(i,j)
!             br(i,j) = al(i+1,j) - q(i,j)
!          enddo
!       enddo
!    else
!       do j=jfirst,jlast
!          do i=ifirst-3,ilast+2
!             dq(i,j) = q(i+1,j) - q(i,j)
!          enddo
!       enddo
!       do j=jfirst,jlast
!          do i=ifirst-2, ilast+2
!             if ( dq(i-1,j)*dq(i,j) > 0. ) then
!                extm(i,j) = .false.
!             else
!                extm(i,j) = .true.
!             endif
!          enddo
!       enddo
!       do j=jfirst,jlast
!          do i=ifirst-1,ilast+1
!             if ( extm(i-1,j).and.extm(i,j).and.extm(i+1,j) ) then
!                bl(i,j) = 0.
!                br(i,j) = 0.
!             else
!                bl(i,j) = al(i,j)   - q(i,j)
!                br(i,j) = al(i+1,j) - q(i,j)
!             endif
!          enddo
!       enddo
!       ! Additional positive definite constraint:
!       if(iord==-7) call pert_ppm(ilast-ifirst+3, q(ifirst-1,j), bl(ifirst-1,j), br(ifirst-1,j), 0)
!    endif
! else
!
!! Monotonic constraints:
!! ord = 8: PPM with Lin's PPM fast monotone constraint
!! ord = 10: PPM with Lin's modification of Huynh 2nd constraint
!! ord = 13: 10 plus positive definite constraint
!    do j=jfirst,jlast
!!DEC$ VECTOR ALWAYS
!       do i=is-2,ie+2
!          xt = 0.25*(q(i+1,j) - q(i-1,j))
!          dm(i,j) = sign(min(abs(xt), max(q(i-1,j), q(i,j), q(i+1,j)) - q(i,j),  &
!               q(i,j) - min(q(i-1,j), q(i,j), q(i+1,j))), xt)
!       enddo
!    enddo
!    do j=jfirst,jlast
!!DEC$ VECTOR ALWAYS
!       do i=is1,ie1+1
!          al(i,j) = 0.5*(q(i-1,j)+q(i,j)) + r3*(dm(i-1,j)-dm(i,j))
!       enddo
!    enddo
!    if ( iord==-8 ) then
!       do j=jfirst,jlast
!!DEC$ VECTOR ALWAYS
!          do i=is1, ie1
!             xt = 2.*dm(i,j)
!             bl(i,j) = -sign(min(abs(xt), abs(al(i,j  )-q(i,j))), xt)
!             br(i,j) =  sign(min(abs(xt), abs(al(i+1,j)-q(i,j))), xt)
!          enddo
!       enddo
!    else
!       do j=jfirst,jlast
!          do i=is1-2, ie1+1
!             dq(i,j) = q(i+1,j) - q(i,j)
!          enddo
!       enddo
!       do j=jfirst,jlast
!          do i=is1, ie1
!             bl(i,j) = al(i,j  ) - q(i,j)
!             br(i,j) = al(i+1,j) - q(i,j)
!             if ( abs(dm(i-1,j))+abs(dm(i,j))+abs(dm(i+1,j)) < near_zero ) then
!                bl(i,j) = 0.
!                br(i,j) = 0.
!             elseif( abs(3.*(bl(i,j)+br(i,j))) > abs(bl(i,j)-br(i,j)) ) then
!                pmp_1 = -(dq(i,j) + dq(i,j))
!                lac_1 = pmp_1 + 1.5*dq(i+1,j)
!                bl(i,j) = min( max(0., pmp_1, lac_1), max(bl(i,j), min(0., pmp_1, lac_1)) )
!                pmp_2 = dq(i-1,j) + dq(i-1,j)
!                lac_2 = pmp_2 - 1.5*dq(i-2,j)
!                br(i,j) = min( max(0., pmp_2, lac_2), max(br(i,j), min(0., pmp_2, lac_2)) )
!             endif
!          enddo
!       enddo
!    endif
!    ! Positive definite constraint:
!    if(iord==-9 .or. iord==-13) call pert_ppm(ie1-is1+1, q(is1,j), bl(is1,j), br(is1,j), 0)
!
!    if (.not. nested .and. grid_type<3) then
!       if ( is==1 ) then
!          do j=jfirst,jlast
!             bl_tmp(3*j) = s14*dm(-1,j) + s11*(q(-1,j)-q(0,j))
!
!             xt = 0.5*(((2.*dxa(0,j)+dxa(-1,j))*q(0,j)-dxa(0,j)*q(-1,j))/(dxa(-1,j)+dxa(0,j)) &
!                  +      ((2.*dxa(1,j)+dxa( 2,j))*q(1,j)-dxa(1,j)*q(2,j))/(dxa(1, j)+dxa(2,j)))
!             br_tmp(3*j) = xt - q(0,j)
!             bl_tmp(3*j+1) = xt - q(1,j)
!             xt = s15*q(1,j) + s11*q(2,j) - s14*dm(2,j)
!             br_tmp(3*j+1) = xt - q(1,j)
!             bl_tmp(3*j+2) = xt - q(2,j)
!             br_tmp(3*j+2) = al(3,j) - q(2,j)
!             q_tmp(j*3:j*3+2) = q(0:2,j)
!          enddo
!          call pert_ppm(3*(jlast-jfirst+1), q_tmp, bl_tmp, br_tmp, 1)
!          do j=jfirst,jlast
!             bl(0:2,j) = bl_tmp(j*3:j*3+2)
!             br(0:2,j) = br_tmp(j*3:j*3+2)
!          enddo
!      endif
!      if ( (ie+1)==npx ) then
!         do j=jfirst,jlast
!            bl_tmp(3*j) = al(npx-2,j) - q(npx-2,j)
!
!            xt = s15*q(npx-1,j) + s11*q(npx-2,j) + s14*dm(npx-2,j)
!            br_tmp(3*j) = xt - q(npx-2,j)
!            bl_tmp(3*j+1) = xt - q(npx-1,j)
!
!            xt = 0.5*(((2.*dxa(npx-1,j)+dxa(npx-2,j))*q(npx-1,j)-dxa(npx-1,j)*q(npx-2,j))/(dxa(npx-2,j)+dxa(npx-1,j)) &
!               +      ((2.*dxa(npx,  j)+dxa(npx+1,j))*q(npx,j  )-dxa(npx,  j)*q(npx+1,j))/(dxa(npx,  j)+dxa(npx+1,j)))
!            br_tmp(3*j+1) = xt - q(npx-1,j)
!            bl_tmp(3*j+2) = xt - q(npx,j  )
!
!            br_tmp(3*j+2) = s11*(q(npx+1,j)-q(npx,j)) - s14*dm(npx+1,j)
!            q_tmp(j*3:j*3+2) = q(npx-2:npx,j)
!         enddo
!         call pert_ppm(3*(jlast-jfirst+1), q_tmp, bl_tmp, br_tmp, 1)
!
!         do j=jfirst,jlast
!            bl(npx-2:npx,j) = bl_tmp(j*3:j*3+2)
!            br(npx-2:npx,j) = br_tmp(j*3:j*3+2)
!         enddo
!      endif
!    endif
!
!  endif
!
!  do j=jfirst,jlast
!!DEC$ VECTOR ALWAYS
!     do i=ifirst,ilast+1
!        if( c(i,j)>0. ) then
!           flux(i,j) = q(i-1,j) + (1.-c(i,j))*(br(i-1,j)-c(i,j)*(bl(i-1,j)+br(i-1,j)))
!        else
!           flux(i,j) = q(i,j  ) + (1.+c(i,j))*(bl(i,j  )+c(i,j)*(bl(i,j  )+br(i,j  )))
!        endif
!     enddo
!  enddo
!
! end subroutine xppm0
!#else
  SUBROUTINE XPPM0(flux, q, c, iord, ifirst, ilast, jfirst, jlast, npx, &
&   npy, bd, dxa, nested, grid_type)
    IMPLICIT NONE
    TYPE(FV_GRID_BOUNDS_TYPE), INTENT(IN) :: bd
!  X-Dir strip
    INTEGER, INTENT(IN) :: ifirst, ilast
!  Y-Dir strip
    INTEGER, INTENT(IN) :: jfirst, jlast
    INTEGER, INTENT(IN) :: iord
    INTEGER, INTENT(IN) :: npx, npy
    REAL(fvprc), INTENT(IN) :: q(ifirst-ng:ilast+ng, jfirst:jlast)
! Courant   N (like FLUX)
    REAL(fvprc), INTENT(IN) :: c(ifirst:ilast+1, jfirst:jlast)
    REAL(fvprc), INTENT(IN) :: dxa(bd%isd:bd%ied, bd%jsd:bd%jed)
    LOGICAL, INTENT(IN) :: nested
    INTEGER, INTENT(IN) :: grid_type
! !OUTPUT PARAMETERS:
!  Flux
    REAL(fvprc), INTENT(OUT) :: flux(ifirst:ilast+1, jfirst:jlast)
! Local
    REAL(fvprc), DIMENSION(ifirst-ng:ilast+ng) :: q1
    REAL(fvprc), DIMENSION(ifirst-1:ilast+1) :: bl, br
    REAL(fvprc) :: al(ifirst-1:ilast+2)
    REAL(fvprc) :: dm(ifirst-2:ilast+2)
    REAL(fvprc) :: dq(ifirst-3:ilast+2)
    LOGICAL :: extm(ifirst-2:ilast+2)
    INTEGER :: i, j, ie3, is1, ie1
    REAL(fvprc) :: xt, pmp_1, lac_1, pmp_2, lac_2
    INTRINSIC MAX
    INTRINSIC MIN
    INTRINSIC ABS
    INTRINSIC SIGN
    INTEGER :: abs0
    REAL(fvprc) :: min1
    REAL(fvprc) :: min2
    REAL(fvprc) :: min3
    REAL(fvprc) :: abs1
    REAL(fvprc) :: abs2
    REAL(fvprc) :: max1
    REAL(fvprc) :: min4
    REAL(fvprc) :: abs3
    REAL(fvprc) :: abs4
    REAL(fvprc) :: abs5
    REAL(fvprc) :: x5
    REAL(fvprc) :: x4
    REAL(fvprc) :: x3
    REAL(fvprc) :: x2
    REAL(fvprc) :: x1
    REAL(fvprc) :: z1
    REAL(fvprc) :: y7
    REAL(fvprc) :: y6
    REAL(fvprc) :: y5
    REAL(fvprc) :: y4
    REAL(fvprc) :: y3
    REAL(fvprc) :: y2
    REAL(fvprc) :: y1
    IF (.NOT.nested .AND. grid_type .LT. 3) THEN
      IF (3 .LT. is - 1) THEN
        is1 = is - 1
      ELSE
        is1 = 3
      END IF
      IF (npx - 2 .GT. ie + 2) THEN
        ie3 = ie + 2
      ELSE
        ie3 = npx - 2
      END IF
      IF (npx - 3 .GT. ie + 1) THEN
        ie1 = ie + 1
      ELSE
        ie1 = npx - 3
      END IF
    ELSE
      is1 = is - 1
      ie3 = ie + 2
      ie1 = ie + 1
    END IF
    DO j=jfirst,jlast
      DO i=ifirst-ng,ilast+ng
        q1(i) = q(i, j)
      END DO
      IF (iord .GE. 0.) THEN
        abs0 = iord
      ELSE
        abs0 = -iord
      END IF
      IF (abs0 .LT. 8) THEN
! ord = -5: linear scheme based on PPM 4th order interpolation
! ord = -6: linear PPM with 2-delta filter
! ord = -7: (-6) with additional Positive definite constraint:
        DO i=is1,ie3
          al(i) = p1*(q1(i-1)+q1(i)) + p2*(q1(i-2)+q1(i+1))
        END DO
        IF (.NOT.nested .AND. grid_type .LT. 3) THEN
          IF (is .EQ. 1) THEN
            al(0) = c1*q1(-2) + c2*q1(-1) + c3*q1(0)
            al(1) = 0.5*(((2.*dxa(0, j)+dxa(-1, j))*q1(0)-dxa(0, j)*q1(-&
&             1))/(dxa(-1, j)+dxa(0, j))+((2.*dxa(1, j)+dxa(2, j))*q1(1)&
&             -dxa(1, j)*q1(2))/(dxa(1, j)+dxa(2, j)))
            al(2) = c3*q1(1) + c2*q1(2) + c1*q1(3)
            IF (iord .EQ. -7) THEN
              IF (0. .LT. al(0)) THEN
                al(0) = al(0)
              ELSE
                al(0) = 0.
              END IF
              IF (0. .LT. al(1)) THEN
                al(1) = al(1)
              ELSE
                al(1) = 0.
              END IF
              IF (0. .LT. al(2)) THEN
                al(2) = al(2)
              ELSE
                al(2) = 0.
              END IF
            END IF
          END IF
          IF (ie + 1 .EQ. npx) THEN
            al(npx-1) = c1*q1(npx-3) + c2*q1(npx-2) + c3*q1(npx-1)
            al(npx) = 0.5*(((2.*dxa(npx-1, j)+dxa(npx-2, j))*q1(npx-1)-&
&             dxa(npx-1, j)*q1(npx-2))/(dxa(npx-2, j)+dxa(npx-1, j))+((&
&             2.*dxa(npx, j)+dxa(npx+1, j))*q1(npx)-dxa(npx, j)*q1(npx+1&
&             ))/(dxa(npx, j)+dxa(npx+1, j)))
            al(npx+1) = c3*q1(npx) + c2*q1(npx+1) + c1*q1(npx+2)
            IF (iord .EQ. -7) THEN
              IF (0. .LT. al(npx-1)) THEN
                al(npx-1) = al(npx-1)
              ELSE
                al(npx-1) = 0.
              END IF
              IF (0. .LT. al(npx)) THEN
                al(npx) = al(npx)
              ELSE
                al(npx) = 0.
              END IF
              IF (0. .LT. al(npx+1)) THEN
                al(npx+1) = al(npx+1)
              ELSE
                al(npx+1) = 0.
              END IF
            END IF
          END IF
        END IF
        IF (iord .EQ. -5) THEN
          DO i=ifirst-1,ilast+1
            bl(i) = al(i) - q1(i)
            br(i) = al(i+1) - q1(i)
          END DO
        ELSE
          DO i=ifirst-3,ilast+2
            dq(i) = q1(i+1) - q1(i)
          END DO
          DO i=ifirst-2,ilast+2
            IF (dq(i-1)*dq(i) .GT. 0.) THEN
              extm(i) = .false.
            ELSE
              extm(i) = .true.
            END IF
          END DO
          DO i=ifirst-1,ilast+1
            IF (extm(i-1) .AND. extm(i) .AND. extm(i+1)) THEN
              bl(i) = 0.
              br(i) = 0.
            ELSE
              bl(i) = al(i) - q1(i)
              br(i) = al(i+1) - q1(i)
            END IF
          END DO
! Additional positive definite constraint:
          IF (iord .EQ. -7) CALL PERT_PPM(ilast - ifirst + 3, q1(ifirst-&
&                                   1), bl(ifirst-1), br(ifirst-1), 0)
        END IF
      ELSE
! Monotonic constraints:
! ord = 8: PPM with Lin's PPM fast monotone constraint
! ord = 10: PPM with Lin's modification of Huynh 2nd constraint
! ord = 13: 10 plus positive definite constraint
        DO i=is-2,ie+2
          xt = 0.25*(q1(i+1)-q1(i-1))
          IF (xt .GE. 0.) THEN
            x1 = xt
          ELSE
            x1 = -xt
          END IF
          IF (q1(i-1) .LT. q1(i)) THEN
            IF (q1(i) .LT. q1(i+1)) THEN
              max1 = q1(i+1)
            ELSE
              max1 = q1(i)
            END IF
          ELSE IF (q1(i-1) .LT. q1(i+1)) THEN
            max1 = q1(i+1)
          ELSE
            max1 = q1(i-1)
          END IF
          y1 = max1 - q1(i)
          IF (q1(i-1) .GT. q1(i)) THEN
            IF (q1(i) .GT. q1(i+1)) THEN
              min4 = q1(i+1)
            ELSE
              min4 = q1(i)
            END IF
          ELSE IF (q1(i-1) .GT. q1(i+1)) THEN
            min4 = q1(i+1)
          ELSE
            min4 = q1(i-1)
          END IF
          z1 = q1(i) - min4
          IF (x1 .GT. y1) THEN
            IF (y1 .GT. z1) THEN
              min1 = z1
            ELSE
              min1 = y1
            END IF
          ELSE IF (x1 .GT. z1) THEN
            min1 = z1
          ELSE
            min1 = x1
          END IF
          dm(i) = SIGN(min1, xt)
        END DO
        DO i=is1,ie1+1
          al(i) = 0.5*(q1(i-1)+q1(i)) + r3*(dm(i-1)-dm(i))
        END DO
        IF (iord .EQ. -8) THEN
          DO i=is1,ie1
            xt = 2.*dm(i)
            IF (xt .GE. 0.) THEN
              x2 = xt
            ELSE
              x2 = -xt
            END IF
            IF (al(i) - q1(i) .GE. 0.) THEN
              y2 = al(i) - q1(i)
            ELSE
              y2 = -(al(i)-q1(i))
            END IF
            IF (x2 .GT. y2) THEN
              min2 = y2
            ELSE
              min2 = x2
            END IF
            bl(i) = -SIGN(min2, xt)
            IF (xt .GE. 0.) THEN
              x3 = xt
            ELSE
              x3 = -xt
            END IF
            IF (al(i+1) - q1(i) .GE. 0.) THEN
              y3 = al(i+1) - q1(i)
            ELSE
              y3 = -(al(i+1)-q1(i))
            END IF
            IF (x3 .GT. y3) THEN
              min3 = y3
            ELSE
              min3 = x3
            END IF
            br(i) = SIGN(min3, xt)
          END DO
        ELSE
          DO i=is1-2,ie1+1
            dq(i) = q1(i+1) - q1(i)
          END DO
          DO i=is1,ie1
            bl(i) = al(i) - q1(i)
            br(i) = al(i+1) - q1(i)
            IF (dm(i-1) .GE. 0.) THEN
              abs1 = dm(i-1)
            ELSE
              abs1 = -dm(i-1)
            END IF
            IF (dm(i) .GE. 0.) THEN
              abs3 = dm(i)
            ELSE
              abs3 = -dm(i)
            END IF
            IF (dm(i+1) .GE. 0.) THEN
              abs5 = dm(i+1)
            ELSE
              abs5 = -dm(i+1)
            END IF
            IF (abs1 + abs3 + abs5 .LT. near_zero) THEN
              bl(i) = 0.
              br(i) = 0.
            ELSE
              IF (3.*(bl(i)+br(i)) .GE. 0.) THEN
                abs2 = 3.*(bl(i)+br(i))
              ELSE
                abs2 = -(3.*(bl(i)+br(i)))
              END IF
              IF (bl(i) - br(i) .GE. 0.) THEN
                abs4 = bl(i) - br(i)
              ELSE
                abs4 = -(bl(i)-br(i))
              END IF
              IF (abs2 .GT. abs4) THEN
                pmp_1 = -(dq(i)+dq(i))
                lac_1 = pmp_1 + 1.5*dq(i+1)
                IF (0. .LT. pmp_1) THEN
                  IF (pmp_1 .LT. lac_1) THEN
                    x4 = lac_1
                  ELSE
                    x4 = pmp_1
                  END IF
                ELSE IF (0. .LT. lac_1) THEN
                  x4 = lac_1
                ELSE
                  x4 = 0.
                END IF
                IF (0. .GT. pmp_1) THEN
                  IF (pmp_1 .GT. lac_1) THEN
                    y6 = lac_1
                  ELSE
                    y6 = pmp_1
                  END IF
                ELSE IF (0. .GT. lac_1) THEN
                  y6 = lac_1
                ELSE
                  y6 = 0.
                END IF
                IF (bl(i) .LT. y6) THEN
                  y4 = y6
                ELSE
                  y4 = bl(i)
                END IF
                IF (x4 .GT. y4) THEN
                  bl(i) = y4
                ELSE
                  bl(i) = x4
                END IF
                pmp_2 = dq(i-1) + dq(i-1)
                lac_2 = pmp_2 - 1.5*dq(i-2)
                IF (0. .LT. pmp_2) THEN
                  IF (pmp_2 .LT. lac_2) THEN
                    x5 = lac_2
                  ELSE
                    x5 = pmp_2
                  END IF
                ELSE IF (0. .LT. lac_2) THEN
                  x5 = lac_2
                ELSE
                  x5 = 0.
                END IF
                IF (0. .GT. pmp_2) THEN
                  IF (pmp_2 .GT. lac_2) THEN
                    y7 = lac_2
                  ELSE
                    y7 = pmp_2
                  END IF
                ELSE IF (0. .GT. lac_2) THEN
                  y7 = lac_2
                ELSE
                  y7 = 0.
                END IF
                IF (br(i) .LT. y7) THEN
                  y5 = y7
                ELSE
                  y5 = br(i)
                END IF
                IF (x5 .GT. y5) THEN
                  br(i) = y5
                ELSE
                  br(i) = x5
                END IF
              END IF
            END IF
          END DO
        END IF
! Positive definite constraint:
        IF (iord .EQ. -9 .OR. iord .EQ. -13) CALL PERT_PPM(ie1 - is1 + 1&
&                                                    , q1(is1), bl(is1)&
&                                                    , br(is1), 0)
        IF (.NOT.nested .AND. grid_type .LT. 3) THEN
          IF (is .EQ. 1) THEN
            bl(0) = s14*dm(-1) + s11*(q1(-1)-q1(0))
            xt = 0.5*(((2.*dxa(0, j)+dxa(-1, j))*q1(0)-dxa(0, j)*q1(-1))&
&             /(dxa(-1, j)+dxa(0, j))+((2.*dxa(1, j)+dxa(2, j))*q1(1)-&
&             dxa(1, j)*q1(2))/(dxa(1, j)+dxa(2, j)))
            br(0) = xt - q1(0)
            bl(1) = xt - q1(1)
            xt = s15*q1(1) + s11*q1(2) - s14*dm(2)
            br(1) = xt - q1(1)
            bl(2) = xt - q1(2)
            br(2) = al(3) - q1(2)
            CALL PERT_PPM(3, q1(0), bl(0), br(0), 1)
          END IF
          IF (ie + 1 .EQ. npx) THEN
            bl(npx-2) = al(npx-2) - q1(npx-2)
            xt = s15*q1(npx-1) + s11*q1(npx-2) + s14*dm(npx-2)
            br(npx-2) = xt - q1(npx-2)
            bl(npx-1) = xt - q1(npx-1)
            xt = 0.5*(((2.*dxa(npx-1, j)+dxa(npx-2, j))*q1(npx-1)-dxa(&
&             npx-1, j)*q1(npx-2))/(dxa(npx-2, j)+dxa(npx-1, j))+((2.*&
&             dxa(npx, j)+dxa(npx+1, j))*q1(npx)-dxa(npx, j)*q1(npx+1))/&
&             (dxa(npx, j)+dxa(npx+1, j)))
            br(npx-1) = xt - q1(npx-1)
            bl(npx) = xt - q1(npx)
            br(npx) = s11*(q1(npx+1)-q1(npx)) - s14*dm(npx+1)
            CALL PERT_PPM(3, q1(npx-2), bl(npx-2), br(npx-2), 1)
          END IF
        END IF
      END IF
      DO i=ifirst,ilast+1
        IF (c(i, j) .GT. 0.) THEN
          flux(i, j) = q1(i-1) + (1.-c(i, j))*(br(i-1)-c(i, j)*(bl(i-1)+&
&           br(i-1)))
        ELSE
          flux(i, j) = q1(i) + (1.+c(i, j))*(bl(i)+c(i, j)*(bl(i)+br(i))&
&           )
        END IF
      END DO
    END DO
  END SUBROUTINE XPPM0
!#endif
  SUBROUTINE YPPM0(flux, q, c, jord, ifirst, ilast, jfirst, jlast, npx, &
&   npy, bd, dya, nested, grid_type)
    IMPLICIT NONE
    TYPE(FV_GRID_BOUNDS_TYPE), INTENT(IN) :: bd
!  X-Dir strip
    INTEGER, INTENT(IN) :: ifirst, ilast
!  Y-Dir strip
    INTEGER, INTENT(IN) :: jfirst, jlast
    INTEGER, INTENT(IN) :: jord
    INTEGER, INTENT(IN) :: npx, npy
    REAL(fvprc), INTENT(IN) :: q(ifirst:ilast, jfirst-ng:jlast+ng)
! Courant number
    REAL(fvprc), INTENT(IN) :: c(bd%isd:bd%ied, bd%js:bd%je+1)
!  Flux
    REAL(fvprc), INTENT(OUT) :: flux(ifirst:ilast, jfirst:jlast+1)
    REAL(fvprc), INTENT(IN) :: dya(bd%isd:bd%ied, bd%jsd:bd%jed)
    LOGICAL, INTENT(IN) :: nested
    INTEGER, INTENT(IN) :: grid_type
! Local:
    REAL(fvprc) :: dm(ifirst:ilast, jfirst-2:jlast+2)
    REAL(fvprc) :: al(ifirst:ilast, jfirst-1:jlast+2)
    REAL(fvprc) :: bl(ifirst:ilast, jfirst-1:jlast+1)
    REAL(fvprc) :: br(ifirst:ilast, jfirst-1:jlast+1)
    REAL(fvprc) :: dq(ifirst:ilast, jfirst-3:jlast+2)
    LOGICAL :: extm(ifirst:ilast, jfirst-2:jlast+2)
    REAL(fvprc) :: xt, pmp_1, lac_1, pmp_2, lac_2
    INTEGER :: i, j, js1, je3, je1
    INTRINSIC MAX
    INTRINSIC MIN
    INTRINSIC ABS
    INTRINSIC SIGN
    INTEGER :: abs0
    REAL(fvprc) :: min1
    REAL(fvprc) :: min2
    REAL(fvprc) :: min3
    REAL(fvprc) :: abs1
    REAL(fvprc) :: abs2
    REAL(fvprc) :: max1
    REAL(fvprc) :: min4
    REAL(fvprc) :: abs3
    REAL(fvprc) :: abs4
    REAL(fvprc) :: abs5
    REAL(fvprc) :: x5
    REAL(fvprc) :: x4
    REAL(fvprc) :: x3
    REAL(fvprc) :: x2
    REAL(fvprc) :: x1
    REAL(fvprc) :: z1
    REAL(fvprc) :: y7
    REAL(fvprc) :: y6
    REAL(fvprc) :: y5
    REAL(fvprc) :: y4
    REAL(fvprc) :: y3
    REAL(fvprc) :: y2
    REAL(fvprc) :: y1
    IF (.NOT.nested .AND. grid_type .LT. 3) THEN
      IF (3 .LT. js - 1) THEN
        js1 = js - 1
      ELSE
        js1 = 3
      END IF
      IF (npy - 2 .GT. je + 2) THEN
        je3 = je + 2
      ELSE
        je3 = npy - 2
      END IF
      IF (npy - 3 .GT. je + 1) THEN
        je1 = je + 1
      ELSE
        je1 = npy - 3
      END IF
    ELSE
! Nested grid OR Doubly periodic domain:
      js1 = js - 1
      je3 = je + 2
      je1 = je + 1
    END IF
    IF (jord .GE. 0.) THEN
      abs0 = jord
    ELSE
      abs0 = -jord
    END IF
    IF (abs0 .LT. 8) THEN
! ord = -5: linear scheme based on PPM 4th order interpolation
! ord = -6: linear PPM with 2-delta filter
! ord = -7: (-6) with additional Positive definite constraint:
      DO j=js1,je3
        DO i=ifirst,ilast
          al(i, j) = p1*(q(i, j-1)+q(i, j)) + p2*(q(i, j-2)+q(i, j+1))
        END DO
      END DO
      IF (.NOT.nested .AND. grid_type .LT. 3) THEN
        IF (js .EQ. 1) THEN
          DO i=ifirst,ilast
            al(i, 0) = c1*q(i, -2) + c2*q(i, -1) + c3*q(i, 0)
            al(i, 1) = 0.5*(((2.*dya(i, 0)+dya(i, -1))*q(i, 0)-dya(i, 0)&
&             *q(i, -1))/(dya(i, -1)+dya(i, 0))+((2.*dya(i, 1)+dya(i, 2)&
&             )*q(i, 1)-dya(i, 1)*q(i, 2))/(dya(i, 1)+dya(i, 2)))
            al(i, 2) = c3*q(i, 1) + c2*q(i, 2) + c1*q(i, 3)
          END DO
          IF (jord .EQ. -7) THEN
            DO i=ifirst,ilast
              IF (0. .LT. al(i, 0)) THEN
                al(i, 0) = al(i, 0)
              ELSE
                al(i, 0) = 0.
              END IF
              IF (0. .LT. al(i, 1)) THEN
                al(i, 1) = al(i, 1)
              ELSE
                al(i, 1) = 0.
              END IF
              IF (0. .LT. al(i, 2)) THEN
                al(i, 2) = al(i, 2)
              ELSE
                al(i, 2) = 0.
              END IF
            END DO
          END IF
        END IF
        IF (je + 1 .EQ. npy) THEN
          DO i=ifirst,ilast
            al(i, npy-1) = c1*q(i, npy-3) + c2*q(i, npy-2) + c3*q(i, npy&
&             -1)
            al(i, npy) = 0.5*(((2.*dya(i, npy-1)+dya(i, npy-2))*q(i, npy&
&             -1)-dya(i, npy-1)*q(i, npy-2))/(dya(i, npy-2)+dya(i, npy-1&
&             ))+((2.*dya(i, npy)+dya(i, npy+1))*q(i, npy)-dya(i, npy)*q&
&             (i, npy+1))/(dya(i, npy)+dya(i, npy+1)))
            al(i, npy+1) = c3*q(i, npy) + c2*q(i, npy+1) + c1*q(i, npy+2&
&             )
          END DO
          IF (jord .EQ. -7) THEN
            DO i=ifirst,ilast
              IF (0. .LT. al(i, npy-1)) THEN
                al(i, npy-1) = al(i, npy-1)
              ELSE
                al(i, npy-1) = 0.
              END IF
              IF (0. .LT. al(i, npy)) THEN
                al(i, npy) = al(i, npy)
              ELSE
                al(i, npy) = 0.
              END IF
              IF (0. .LT. al(i, npy+1)) THEN
                al(i, npy+1) = al(i, npy+1)
              ELSE
                al(i, npy+1) = 0.
              END IF
            END DO
          END IF
        END IF
      END IF
      IF (jord .EQ. -5) THEN
        DO j=jfirst-1,jlast+1
          DO i=ifirst,ilast
            bl(i, j) = al(i, j) - q(i, j)
            br(i, j) = al(i, j+1) - q(i, j)
          END DO
        END DO
      ELSE
        DO j=jfirst-3,jlast+2
          DO i=ifirst,ilast
            dq(i, j) = q(i, j+1) - q(i, j)
          END DO
        END DO
        DO j=jfirst-2,jlast+2
          DO i=ifirst,ilast
            IF (dq(i, j-1)*dq(i, j) .GT. 0.) THEN
              extm(i, j) = .false.
            ELSE
              extm(i, j) = .true.
            END IF
          END DO
        END DO
        DO j=jfirst-1,jlast+1
          DO i=ifirst,ilast
            IF (extm(i, j-1) .AND. extm(i, j) .AND. extm(i, j+1)) THEN
              bl(i, j) = 0.
              br(i, j) = 0.
            ELSE
              bl(i, j) = al(i, j) - q(i, j)
              br(i, j) = al(i, j+1) - q(i, j)
            END IF
          END DO
        END DO
! Additional positive definite constraint:
        IF (jord .EQ. -7) THEN
          DO j=jfirst-1,jlast+1
            CALL PERT_PPM(ilast - ifirst + 1, q(ifirst, j), bl(ifirst, j&
&                   ), br(ifirst, j), 0)
          END DO
        END IF
      END IF
    ELSE
! Monotonic constraints:
! ord = 8: PPM with Lin's PPM fast monotone constraint
! ord > 8: PPM with Lin's modification of Huynh 2nd constraint
      DO j=js-2,je+2
        DO i=ifirst,ilast
          xt = 0.25*(q(i, j+1)-q(i, j-1))
          IF (xt .GE. 0.) THEN
            x1 = xt
          ELSE
            x1 = -xt
          END IF
          IF (q(i, j-1) .LT. q(i, j)) THEN
            IF (q(i, j) .LT. q(i, j+1)) THEN
              max1 = q(i, j+1)
            ELSE
              max1 = q(i, j)
            END IF
          ELSE IF (q(i, j-1) .LT. q(i, j+1)) THEN
            max1 = q(i, j+1)
          ELSE
            max1 = q(i, j-1)
          END IF
          y1 = max1 - q(i, j)
          IF (q(i, j-1) .GT. q(i, j)) THEN
            IF (q(i, j) .GT. q(i, j+1)) THEN
              min4 = q(i, j+1)
            ELSE
              min4 = q(i, j)
            END IF
          ELSE IF (q(i, j-1) .GT. q(i, j+1)) THEN
            min4 = q(i, j+1)
          ELSE
            min4 = q(i, j-1)
          END IF
          z1 = q(i, j) - min4
          IF (x1 .GT. y1) THEN
            IF (y1 .GT. z1) THEN
              min1 = z1
            ELSE
              min1 = y1
            END IF
          ELSE IF (x1 .GT. z1) THEN
            min1 = z1
          ELSE
            min1 = x1
          END IF
          dm(i, j) = SIGN(min1, xt)
        END DO
      END DO
      DO j=js1,je1+1
        DO i=ifirst,ilast
          al(i, j) = 0.5*(q(i, j-1)+q(i, j)) + r3*(dm(i, j-1)-dm(i, j))
        END DO
      END DO
      IF (jord .EQ. -8) THEN
        DO j=js1,je1
          DO i=ifirst,ilast
            xt = 2.*dm(i, j)
            IF (xt .GE. 0.) THEN
              x2 = xt
            ELSE
              x2 = -xt
            END IF
            IF (al(i, j) - q(i, j) .GE. 0.) THEN
              y2 = al(i, j) - q(i, j)
            ELSE
              y2 = -(al(i, j)-q(i, j))
            END IF
            IF (x2 .GT. y2) THEN
              min2 = y2
            ELSE
              min2 = x2
            END IF
            bl(i, j) = -SIGN(min2, xt)
            IF (xt .GE. 0.) THEN
              x3 = xt
            ELSE
              x3 = -xt
            END IF
            IF (al(i, j+1) - q(i, j) .GE. 0.) THEN
              y3 = al(i, j+1) - q(i, j)
            ELSE
              y3 = -(al(i, j+1)-q(i, j))
            END IF
            IF (x3 .GT. y3) THEN
              min3 = y3
            ELSE
              min3 = x3
            END IF
            br(i, j) = SIGN(min3, xt)
          END DO
        END DO
      ELSE
        DO j=js1-2,je1+1
          DO i=ifirst,ilast
            dq(i, j) = q(i, j+1) - q(i, j)
          END DO
        END DO
        DO j=js1,je1
          DO i=ifirst,ilast
            bl(i, j) = al(i, j) - q(i, j)
            br(i, j) = al(i, j+1) - q(i, j)
            IF (dm(i, j-1) .GE. 0.) THEN
              abs1 = dm(i, j-1)
            ELSE
              abs1 = -dm(i, j-1)
            END IF
            IF (dm(i, j) .GE. 0.) THEN
              abs3 = dm(i, j)
            ELSE
              abs3 = -dm(i, j)
            END IF
            IF (dm(i, j+1) .GE. 0.) THEN
              abs5 = dm(i, j+1)
            ELSE
              abs5 = -dm(i, j+1)
            END IF
            IF (abs1 + abs3 + abs5 .LT. near_zero) THEN
              bl(i, j) = 0.
              br(i, j) = 0.
            ELSE
              IF (3.*(bl(i, j)+br(i, j)) .GE. 0.) THEN
                abs2 = 3.*(bl(i, j)+br(i, j))
              ELSE
                abs2 = -(3.*(bl(i, j)+br(i, j)))
              END IF
              IF (bl(i, j) - br(i, j) .GE. 0.) THEN
                abs4 = bl(i, j) - br(i, j)
              ELSE
                abs4 = -(bl(i, j)-br(i, j))
              END IF
              IF (abs2 .GT. abs4) THEN
                pmp_1 = -(2.*dq(i, j))
                lac_1 = pmp_1 + 1.5*dq(i, j+1)
                IF (0. .LT. pmp_1) THEN
                  IF (pmp_1 .LT. lac_1) THEN
                    x4 = lac_1
                  ELSE
                    x4 = pmp_1
                  END IF
                ELSE IF (0. .LT. lac_1) THEN
                  x4 = lac_1
                ELSE
                  x4 = 0.
                END IF
                IF (0. .GT. pmp_1) THEN
                  IF (pmp_1 .GT. lac_1) THEN
                    y6 = lac_1
                  ELSE
                    y6 = pmp_1
                  END IF
                ELSE IF (0. .GT. lac_1) THEN
                  y6 = lac_1
                ELSE
                  y6 = 0.
                END IF
                IF (bl(i, j) .LT. y6) THEN
                  y4 = y6
                ELSE
                  y4 = bl(i, j)
                END IF
                IF (x4 .GT. y4) THEN
                  bl(i, j) = y4
                ELSE
                  bl(i, j) = x4
                END IF
                pmp_2 = 2.*dq(i, j-1)
                lac_2 = pmp_2 - 1.5*dq(i, j-2)
                IF (0. .LT. pmp_2) THEN
                  IF (pmp_2 .LT. lac_2) THEN
                    x5 = lac_2
                  ELSE
                    x5 = pmp_2
                  END IF
                ELSE IF (0. .LT. lac_2) THEN
                  x5 = lac_2
                ELSE
                  x5 = 0.
                END IF
                IF (0. .GT. pmp_2) THEN
                  IF (pmp_2 .GT. lac_2) THEN
                    y7 = lac_2
                  ELSE
                    y7 = pmp_2
                  END IF
                ELSE IF (0. .GT. lac_2) THEN
                  y7 = lac_2
                ELSE
                  y7 = 0.
                END IF
                IF (br(i, j) .LT. y7) THEN
                  y5 = y7
                ELSE
                  y5 = br(i, j)
                END IF
                IF (x5 .GT. y5) THEN
                  br(i, j) = y5
                ELSE
                  br(i, j) = x5
                END IF
              END IF
            END IF
          END DO
        END DO
      END IF
      IF (jord .EQ. -9 .OR. jord .EQ. -13) THEN
! Positive definite constraint:
        DO j=js1,je1
          CALL PERT_PPM(ilast - ifirst + 1, q(ifirst, j), bl(ifirst, j)&
&                 , br(ifirst, j), 0)
        END DO
      END IF
      IF (.NOT.nested .AND. grid_type .LT. 3) THEN
        IF (js .EQ. 1) THEN
          DO i=ifirst,ilast
            bl(i, 0) = s14*dm(i, -1) + s11*(q(i, -1)-q(i, 0))
            xt = 0.5*(((2.*dya(i, 0)+dya(i, -1))*q(i, 0)-dya(i, 0)*q(i, &
&             -1))/(dya(i, -1)+dya(i, 0))+((2.*dya(i, 1)+dya(i, 2))*q(i&
&             , 1)-dya(i, 1)*q(i, 2))/(dya(i, 1)+dya(i, 2)))
            br(i, 0) = xt - q(i, 0)
            bl(i, 1) = xt - q(i, 1)
            xt = s15*q(i, 1) + s11*q(i, 2) - s14*dm(i, 2)
            br(i, 1) = xt - q(i, 1)
            bl(i, 2) = xt - q(i, 2)
            br(i, 2) = al(i, 3) - q(i, 2)
          END DO
          CALL PERT_PPM(3*(ilast-ifirst+1), q(ifirst, 0), bl(ifirst, 0)&
&                 , br(ifirst, 0), 1)
        END IF
        IF (je + 1 .EQ. npy) THEN
          DO i=ifirst,ilast
            bl(i, npy-2) = al(i, npy-2) - q(i, npy-2)
            xt = s15*q(i, npy-1) + s11*q(i, npy-2) + s14*dm(i, npy-2)
            br(i, npy-2) = xt - q(i, npy-2)
            bl(i, npy-1) = xt - q(i, npy-1)
            xt = 0.5*(((2.*dya(i, npy-1)+dya(i, npy-2))*q(i, npy-1)-dya(&
&             i, npy-1)*q(i, npy-2))/(dya(i, npy-2)+dya(i, npy-1))+((2.*&
&             dya(i, npy)+dya(i, npy+1))*q(i, npy)-dya(i, npy)*q(i, npy+&
&             1))/(dya(i, npy)+dya(i, npy+1)))
            br(i, npy-1) = xt - q(i, npy-1)
            bl(i, npy) = xt - q(i, npy)
            br(i, npy) = s11*(q(i, npy+1)-q(i, npy)) - s14*dm(i, npy+1)
          END DO
          CALL PERT_PPM(3*(ilast-ifirst+1), q(ifirst, npy-2), bl(ifirst&
&                 , npy-2), br(ifirst, npy-2), 1)
        END IF
      END IF
    END IF
    DO j=jfirst,jlast+1
      DO i=ifirst,ilast
        IF (c(i, j) .GT. 0.) THEN
          flux(i, j) = q(i, j-1) + (1.-c(i, j))*(br(i, j-1)-c(i, j)*(bl(&
&           i, j-1)+br(i, j-1)))
        ELSE
          flux(i, j) = q(i, j) + (1.+c(i, j))*(bl(i, j)+c(i, j)*(bl(i, j&
&           )+br(i, j)))
        END IF
      END DO
    END DO
  END SUBROUTINE YPPM0
  SUBROUTINE FXPPM(c, q, flux, iord, ifirst, ilast, jfirst, jlast, npx, &
&   npy, bd, dxa, nested, grid_type)
    IMPLICIT NONE
! !INPUT PARAMETERS:
    TYPE(FV_GRID_BOUNDS_TYPE), INTENT(IN) :: bd
!  X-Dir strip
    INTEGER, INTENT(IN) :: ifirst, ilast
!  Y-Dir strip
    INTEGER, INTENT(IN) :: jfirst, jlast
    INTEGER, INTENT(IN) :: iord
    INTEGER, INTENT(IN) :: npx, npy
    REAL(fvprc), INTENT(IN) :: q(ifirst-ng:ilast+ng, jfirst:jlast)
! Courant   N (like FLUX)
    REAL(fvprc), INTENT(IN) :: c(ifirst:ilast+1, jfirst:jlast)
    REAL(fvprc), INTENT(IN) :: dxa(bd%isd:bd%ied, bd%jsd:bd%jed)
    LOGICAL, INTENT(IN) :: nested
    INTEGER, INTENT(IN) :: grid_type
! !OUTPUT PARAMETERS:
!  Flux
    REAL(fvprc), INTENT(OUT) :: flux(ifirst:ilast+1, jfirst:jlast)
! Local
    LOGICAL :: extm(ifirst-2:ilast+2)
    REAL(fvprc) :: dm1(ifirst-2:ilast+2)
    REAL(fvprc) :: al(ifirst-1:ilast+2)
    REAL(fvprc) :: bl(ifirst-1:ilast+1)
    REAL(fvprc) :: br(ifirst-1:ilast+1)
    REAL(fvprc) :: dq(ifirst-3:ilast+2)
    REAL(fvprc) :: dl, dr, pmp, lac, ct, qe
    REAL(fvprc) :: pmp_1, lac_1, pmp_2, lac_2
    REAL(fvprc) :: xt, x1, x0, x0l, x0r
    INTEGER :: i, j, is3, ie3, it
    REAL(fvprc) :: bl6(ifirst-1:ilast+1, jfirst:jlast)
    REAL(fvprc) :: br6(ifirst-1:ilast+1, jfirst:jlast)
    INTRINSIC MAX
    INTRINSIC MIN
    INTRINSIC ABS
    INTRINSIC SIGN
    REAL(fvprc) :: min1
    REAL(fvprc) :: min2
    REAL(fvprc) :: min3
    REAL(fvprc) :: min4
    REAL(fvprc) :: min5
    REAL(fvprc) :: min6
    REAL(fvprc) :: min7
    REAL(fvprc) :: min8
    REAL(fvprc) :: min9
    REAL(fvprc) :: min10
    REAL(fvprc) :: min11
    REAL(fvprc) :: min12
    REAL(fvprc) :: min13
    REAL(fvprc) :: abs0
    REAL(fvprc) :: abs1
    REAL(fvprc) :: min14
    REAL(fvprc) :: min15
    REAL(fvprc) :: min16
    REAL(fvprc) :: min17
    REAL(fvprc) :: abs2
    REAL(fvprc) :: abs3
    REAL(fvprc) :: min18
    REAL(fvprc) :: min19
    REAL(fvprc) :: max1
    REAL(fvprc) :: min20
    REAL(fvprc) :: max2
    REAL(fvprc) :: min21
    REAL(fvprc) :: max3
    REAL(fvprc) :: min22
    REAL(fvprc) :: max4
    REAL(fvprc) :: min23
    REAL(fvprc) :: max5
    REAL(fvprc) :: min24
    REAL(fvprc) :: max6
    REAL(fvprc) :: min25
    REAL(fvprc) :: max7
    REAL(fvprc) :: min26
    REAL(fvprc) :: abs4
    REAL(fvprc) :: abs5
    REAL(fvprc) :: max8
    REAL(fvprc) :: min27
    REAL(fvprc) :: max9
    REAL(fvprc) :: min28
    REAL(fvprc) :: abs6
    REAL(fvprc) :: abs7
    REAL(fvprc) :: abs8
    REAL(fvprc) :: abs9
    REAL(fvprc) :: x19
    REAL(fvprc) :: x18
    REAL(fvprc) :: x17
    REAL(fvprc) :: x16
    REAL(fvprc) :: x15
    REAL(fvprc) :: x14
    REAL(fvprc) :: x13
    REAL(fvprc) :: x12
    REAL(fvprc) :: x11
    REAL(fvprc) :: y29
    REAL(fvprc) :: x10
    REAL(fvprc) :: y28
    REAL(fvprc) :: y27
    REAL(fvprc) :: y26
    REAL(fvprc) :: y25
    REAL(fvprc) :: y24
    REAL(fvprc) :: y23
    REAL(fvprc) :: y22
    REAL(fvprc) :: y21
    REAL(fvprc) :: y20
    REAL(fvprc) :: x9
    REAL(fvprc) :: x8
    REAL(fvprc) :: x7
    REAL(fvprc) :: x6
    REAL(fvprc) :: x5
    REAL(fvprc) :: x4
    REAL(fvprc) :: x3
    REAL(fvprc) :: x2
    REAL(fvprc) :: y19
    REAL(fvprc) :: y18
    REAL(fvprc) :: y17
    REAL(fvprc) :: y16
    REAL(fvprc) :: y15
    REAL(fvprc) :: x34
    REAL(fvprc) :: y14
    REAL(fvprc) :: x33
    REAL(fvprc) :: y13
    REAL(fvprc) :: x32
    REAL(fvprc) :: y12
    REAL(fvprc) :: x31
    REAL(fvprc) :: y11
    REAL(fvprc) :: x30
    REAL(fvprc) :: y10
    REAL(fvprc) :: y47
    REAL(fvprc) :: y46
    REAL(fvprc) :: y45
    REAL(fvprc) :: y44
    REAL(fvprc) :: y43
    REAL(fvprc) :: y42
    REAL(fvprc) :: y41
    REAL(fvprc) :: y40
    REAL(fvprc) :: z9
    REAL(fvprc) :: z8
    REAL(fvprc) :: z7
    REAL(fvprc) :: z6
    REAL(fvprc) :: z5
    REAL(fvprc) :: z4
    REAL(fvprc) :: z3
    REAL(fvprc) :: z2
    REAL(fvprc) :: z1
    REAL(fvprc) :: x29
    REAL(fvprc) :: x28
    REAL(fvprc) :: x27
    REAL(fvprc) :: x26
    REAL(fvprc) :: x25
    REAL(fvprc) :: x24
    REAL(fvprc) :: x23
    REAL(fvprc) :: x22
    REAL(fvprc) :: x21
    REAL(fvprc) :: y39
    REAL(fvprc) :: x20
    REAL(fvprc) :: y38
    REAL(fvprc) :: y37
    REAL(fvprc) :: y36
    REAL(fvprc) :: y35
    REAL(fvprc) :: y34
    REAL(fvprc) :: y33
    REAL(fvprc) :: y32
    REAL(fvprc) :: y31
    REAL(fvprc) :: y30
    REAL(fvprc) :: y9
    REAL(fvprc) :: y8
    REAL(fvprc) :: y7
    REAL(fvprc) :: y6
    REAL(fvprc) :: y5
    REAL(fvprc) :: y4
    REAL(fvprc) :: y3
    REAL(fvprc) :: y2
    REAL(fvprc) :: y1
    x0 = big_number
    IF (nested) THEN
      is3 = is - 1
      ie3 = ie + 1
    ELSE
      IF (3 .LT. is - 1) THEN
        is3 = is - 1
      ELSE
        is3 = 3
      END IF
      IF (npx - 3 .GT. ie + 1) THEN
        ie3 = ie + 1
      ELSE
        ie3 = npx - 3
      END IF
    END IF
    IF (iord .LE. 4) THEN
      DO j=jfirst,jlast
        DO i=is-2,ie+2
          xt = 0.25*(q(i+1, j)-q(i-1, j))
          IF (xt .GE. 0.) THEN
            x2 = xt
          ELSE
            x2 = -xt
          END IF
          IF (q(i-1, j) .LT. q(i, j)) THEN
            IF (q(i, j) .LT. q(i+1, j)) THEN
              max1 = q(i+1, j)
            ELSE
              max1 = q(i, j)
            END IF
          ELSE IF (q(i-1, j) .LT. q(i+1, j)) THEN
            max1 = q(i+1, j)
          ELSE
            max1 = q(i-1, j)
          END IF
          y1 = max1 - q(i, j)
          IF (q(i-1, j) .GT. q(i, j)) THEN
            IF (q(i, j) .GT. q(i+1, j)) THEN
              min20 = q(i+1, j)
            ELSE
              min20 = q(i, j)
            END IF
          ELSE IF (q(i-1, j) .GT. q(i+1, j)) THEN
            min20 = q(i+1, j)
          ELSE
            min20 = q(i-1, j)
          END IF
          z1 = q(i, j) - min20
          IF (x2 .GT. y1) THEN
            IF (y1 .GT. z1) THEN
              min1 = z1
            ELSE
              min1 = y1
            END IF
          ELSE IF (x2 .GT. z1) THEN
            min1 = z1
          ELSE
            min1 = x2
          END IF
          dm1(i) = SIGN(min1, xt)
        END DO
        IF (grid_type .LT. 3) THEN
          DO i=is3,ie3+1
!        do i=max(3,is-1),min(npx-2,ie+2)
            al(i) = 0.5*(q(i-1, j)+q(i, j)) + r3*(dm1(i-1)-dm1(i))
          END DO
!.not. nested
! Fix the edges:
          IF (.NOT.nested) THEN
            IF (is .EQ. 1) THEN
              x0l = 0.5*((2.*dxa(0, j)+dxa(-1, j))*q(0, j)-dxa(0, j)*q(-&
&               1, j))/(dxa(0, j)+dxa(-1, j))
              x0r = 0.5*((2.*dxa(1, j)+dxa(2, j))*q(1, j)-dxa(1, j)*q(2&
&               , j))/(dxa(1, j)+dxa(2, j))
              x0 = x0l + x0r
              al(1) = x0
              x1 = s15*q(0, j) + s11*q(-1, j) + s14*dm1(-1)
              dm1(0) = 0.5*(x0-x1)
              IF (dm1(0) .GE. 0.) THEN
                x3 = dm1(0)
              ELSE
                x3 = -dm1(0)
              END IF
              IF (q(0, j) .LT. x0) THEN
                IF (x0 .LT. x1) THEN
                  max2 = x1
                ELSE
                  max2 = x0
                END IF
              ELSE IF (q(0, j) .LT. x1) THEN
                max2 = x1
              ELSE
                max2 = q(0, j)
              END IF
              y2 = max2 - q(0, j)
              IF (q(0, j) .GT. x0) THEN
                IF (x0 .GT. x1) THEN
                  min21 = x1
                ELSE
                  min21 = x0
                END IF
              ELSE IF (q(0, j) .GT. x1) THEN
                min21 = x1
              ELSE
                min21 = q(0, j)
              END IF
              z2 = q(0, j) - min21
              IF (x3 .GT. y2) THEN
                IF (y2 .GT. z2) THEN
                  min2 = z2
                ELSE
                  min2 = y2
                END IF
              ELSE IF (x3 .GT. z2) THEN
                min2 = z2
              ELSE
                min2 = x3
              END IF
              dm1(0) = SIGN(min2, dm1(0))
              al(0) = 0.5*(q(-1, j)+q(0, j)) + r3*(dm1(-1)-dm1(0))
!
              x1 = s15*q(1, j) + s11*q(2, j) - s14*dm1(2)
              dm1(1) = 0.5*(x1-x0)
              IF (dm1(1) .GE. 0.) THEN
                x4 = dm1(1)
              ELSE
                x4 = -dm1(1)
              END IF
              IF (q(1, j) .LT. x0) THEN
                IF (x0 .LT. x1) THEN
                  max3 = x1
                ELSE
                  max3 = x0
                END IF
              ELSE IF (q(1, j) .LT. x1) THEN
                max3 = x1
              ELSE
                max3 = q(1, j)
              END IF
              y3 = max3 - q(1, j)
              IF (q(1, j) .GT. x0) THEN
                IF (x0 .GT. x1) THEN
                  min22 = x1
                ELSE
                  min22 = x0
                END IF
              ELSE IF (q(1, j) .GT. x1) THEN
                min22 = x1
              ELSE
                min22 = q(1, j)
              END IF
              z3 = q(1, j) - min22
              IF (x4 .GT. y3) THEN
                IF (y3 .GT. z3) THEN
                  min3 = z3
                ELSE
                  min3 = y3
                END IF
              ELSE IF (x4 .GT. z3) THEN
                min3 = z3
              ELSE
                min3 = x4
              END IF
              dm1(1) = SIGN(min3, dm1(1))
              al(2) = 0.5*(q(1, j)+q(2, j)) + r3*(dm1(1)-dm1(2))
            END IF
            IF (ie + 1 .EQ. npx) THEN
              x0l = 0.5*((2.*dxa(npx-1, j)+dxa(npx-2, j))*q(npx-1, j)-&
&               dxa(npx-1, j)*q(npx-2, j))/(dxa(npx-1, j)+dxa(npx-2, j))
              x0r = 0.5*((2.*dxa(npx, j)+dxa(npx+1, j))*q(npx, j)-dxa(&
&               npx, j)*q(npx+1, j))/(dxa(npx, j)+dxa(npx+1, j))
              x0 = x0l + x0r
              al(npx) = x0
              x1 = s15*q(npx-1, j) + s11*q(npx-2, j) + s14*dm1(npx-2)
              dm1(npx-1) = 0.5*(x0-x1)
              IF (dm1(npx-1) .GE. 0.) THEN
                x5 = dm1(npx-1)
              ELSE
                x5 = -dm1(npx-1)
              END IF
              IF (q(npx-1, j) .LT. x0) THEN
                IF (x0 .LT. x1) THEN
                  max4 = x1
                ELSE
                  max4 = x0
                END IF
              ELSE IF (q(npx-1, j) .LT. x1) THEN
                max4 = x1
              ELSE
                max4 = q(npx-1, j)
              END IF
              y4 = max4 - q(npx-1, j)
              IF (q(npx-1, j) .GT. x0) THEN
                IF (x0 .GT. x1) THEN
                  min23 = x1
                ELSE
                  min23 = x0
                END IF
              ELSE IF (q(npx-1, j) .GT. x1) THEN
                min23 = x1
              ELSE
                min23 = q(npx-1, j)
              END IF
              z4 = q(npx-1, j) - min23
              IF (x5 .GT. y4) THEN
                IF (y4 .GT. z4) THEN
                  min4 = z4
                ELSE
                  min4 = y4
                END IF
              ELSE IF (x5 .GT. z4) THEN
                min4 = z4
              ELSE
                min4 = x5
              END IF
              dm1(npx-1) = SIGN(min4, dm1(npx-1))
              al(npx-1) = 0.5*(q(npx-2, j)+q(npx-1, j)) + r3*(dm1(npx-2)&
&               -dm1(npx-1))
!
              x1 = s15*q(npx, j) + s11*q(npx+1, j) - s14*dm1(npx+1)
              dm1(npx) = 0.5*(x1-x0)
              IF (dm1(npx) .GE. 0.) THEN
                x6 = dm1(npx)
              ELSE
                x6 = -dm1(npx)
              END IF
              IF (q(npx, j) .LT. x0) THEN
                IF (x0 .LT. x1) THEN
                  max5 = x1
                ELSE
                  max5 = x0
                END IF
              ELSE IF (q(npx, j) .LT. x1) THEN
                max5 = x1
              ELSE
                max5 = q(npx, j)
              END IF
              y5 = max5 - q(npx, j)
              IF (q(npx, j) .GT. x0) THEN
                IF (x0 .GT. x1) THEN
                  min24 = x1
                ELSE
                  min24 = x0
                END IF
              ELSE IF (q(npx, j) .GT. x1) THEN
                min24 = x1
              ELSE
                min24 = q(npx, j)
              END IF
              z5 = q(npx, j) - min24
              IF (x6 .GT. y5) THEN
                IF (y5 .GT. z5) THEN
                  min5 = z5
                ELSE
                  min5 = y5
                END IF
              ELSE IF (x6 .GT. z5) THEN
                min5 = z5
              ELSE
                min5 = x6
              END IF
              dm1(npx) = SIGN(min5, dm1(npx))
              al(npx+1) = 0.5*(q(npx, j)+q(npx+1, j)) + r3*(dm1(npx)-dm1&
&               (npx+1))
            END IF
          END IF
        ELSE
! For doubly periodic BC
          DO i=is-1,ie+2
            al(i) = 0.5*(q(i-1, j)+q(i, j)) + r3*(dm1(i-1)-dm1(i))
          END DO
        END IF
        IF (iord .EQ. 3) THEN
          DO i=is-1,ie+1
            bl(i) = al(i) - q(i, j)
            br(i) = al(i+1) - q(i, j)
          END DO
          CALL PERT_PPM(ie - is + 3, q(is-1, j), bl(is-1), br(is-1), 1)
          DO i=is,ie+1
            IF (c(i, j) .GT. 0.) THEN
              flux(i, j) = q(i-1, j) + (1.-c(i, j))*(br(i-1)-c(i, j)*(bl&
&               (i-1)+br(i-1)))
            ELSE
              flux(i, j) = q(i, j) + (1.+c(i, j))*(bl(i)+c(i, j)*(bl(i)+&
&               br(i)))
            END IF
          END DO
        ELSE
          DO i=is,ie+1
            IF (c(i, j) .GT. 0.) THEN
              xt = ppm_limiter*dm1(i-1)
              IF (xt .GE. 0.) THEN
                x7 = xt
              ELSE
                x7 = -xt
              END IF
              IF (al(i-1) - q(i-1, j) .GE. 0.) THEN
                y6 = al(i-1) - q(i-1, j)
              ELSE
                y6 = -(al(i-1)-q(i-1, j))
              END IF
              IF (x7 .GT. y6) THEN
                min6 = y6
              ELSE
                min6 = x7
              END IF
              dl = SIGN(min6, xt)
              IF (xt .GE. 0.) THEN
                x8 = xt
              ELSE
                x8 = -xt
              END IF
              IF (al(i) - q(i-1, j) .GE. 0.) THEN
                y7 = al(i) - q(i-1, j)
              ELSE
                y7 = -(al(i)-q(i-1, j))
              END IF
              IF (x8 .GT. y7) THEN
                min7 = y7
              ELSE
                min7 = x8
              END IF
              dr = SIGN(min7, xt)
              flux(i, j) = q(i-1, j) + (1.-c(i, j))*(c(i, j)*(dl-dr)+dr)
            ELSE
              xt = ppm_limiter*dm1(i)
              IF (xt .GE. 0.) THEN
                x9 = xt
              ELSE
                x9 = -xt
              END IF
              IF (al(i) - q(i, j) .GE. 0.) THEN
                y8 = al(i) - q(i, j)
              ELSE
                y8 = -(al(i)-q(i, j))
              END IF
              IF (x9 .GT. y8) THEN
                min8 = y8
              ELSE
                min8 = x9
              END IF
              dl = SIGN(min8, xt)
              IF (xt .GE. 0.) THEN
                x10 = xt
              ELSE
                x10 = -xt
              END IF
              IF (al(i+1) - q(i, j) .GE. 0.) THEN
                y9 = al(i+1) - q(i, j)
              ELSE
                y9 = -(al(i+1)-q(i, j))
              END IF
              IF (x10 .GT. y9) THEN
                min9 = y9
              ELSE
                min9 = x10
              END IF
              dr = SIGN(min9, xt)
              flux(i, j) = q(i, j) - (1.+c(i, j))*(c(i, j)*(dl-dr)+dl)
            END IF
          END DO
        END IF
      END DO
    ELSE IF (iord .EQ. 5) THEN
! PPM with Hunyh's 2nd constraint
      DO j=jfirst,jlast
        DO i=ifirst-3,ilast+2
          dq(i) = q(i+1, j) - q(i, j)
        END DO
        DO i=ifirst-2,ilast+2
          xt = 0.25*(q(i+1, j)-q(i-1, j))
          IF (xt .GE. 0.) THEN
            x11 = xt
          ELSE
            x11 = -xt
          END IF
          IF (q(i-1, j) .LT. q(i, j)) THEN
            IF (q(i, j) .LT. q(i+1, j)) THEN
              max6 = q(i+1, j)
            ELSE
              max6 = q(i, j)
            END IF
          ELSE IF (q(i-1, j) .LT. q(i+1, j)) THEN
            max6 = q(i+1, j)
          ELSE
            max6 = q(i-1, j)
          END IF
          y10 = max6 - q(i, j)
          IF (q(i-1, j) .GT. q(i, j)) THEN
            IF (q(i, j) .GT. q(i+1, j)) THEN
              min25 = q(i+1, j)
            ELSE
              min25 = q(i, j)
            END IF
          ELSE IF (q(i-1, j) .GT. q(i+1, j)) THEN
            min25 = q(i+1, j)
          ELSE
            min25 = q(i-1, j)
          END IF
          z6 = q(i, j) - min25
          IF (x11 .GT. y10) THEN
            IF (y10 .GT. z6) THEN
              min10 = z6
            ELSE
              min10 = y10
            END IF
          ELSE IF (x11 .GT. z6) THEN
            min10 = z6
          ELSE
            min10 = x11
          END IF
          dm1(i) = SIGN(min10, xt)
        END DO
        DO i=ifirst-1,ilast+2
          al(i) = 0.5*(q(i-1, j)+q(i, j)) + r3*(dm1(i-1)-dm1(i))
        END DO
        DO i=ifirst-1,ilast+1
          pmp_1 = -(2.*dq(i))
          lac_1 = pmp_1 + 1.5*dq(i+1)
          IF (0. .LT. pmp_1) THEN
            IF (pmp_1 .LT. lac_1) THEN
              x12 = lac_1
            ELSE
              x12 = pmp_1
            END IF
          ELSE IF (0. .LT. lac_1) THEN
            x12 = lac_1
          ELSE
            x12 = 0.
          END IF
          IF (0. .GT. pmp_1) THEN
            IF (pmp_1 .GT. lac_1) THEN
              y34 = lac_1
            ELSE
              y34 = pmp_1
            END IF
          ELSE IF (0. .GT. lac_1) THEN
            y34 = lac_1
          ELSE
            y34 = 0.
          END IF
          IF (al(i) - q(i, j) .LT. y34) THEN
            y11 = y34
          ELSE
            y11 = al(i) - q(i, j)
          END IF
          IF (x12 .GT. y11) THEN
            bl(i) = y11
          ELSE
            bl(i) = x12
          END IF
          pmp_2 = 2.*dq(i-1)
          lac_2 = pmp_2 - 1.5*dq(i-2)
          IF (0. .LT. pmp_2) THEN
            IF (pmp_2 .LT. lac_2) THEN
              x13 = lac_2
            ELSE
              x13 = pmp_2
            END IF
          ELSE IF (0. .LT. lac_2) THEN
            x13 = lac_2
          ELSE
            x13 = 0.
          END IF
          IF (0. .GT. pmp_2) THEN
            IF (pmp_2 .GT. lac_2) THEN
              y35 = lac_2
            ELSE
              y35 = pmp_2
            END IF
          ELSE IF (0. .GT. lac_2) THEN
            y35 = lac_2
          ELSE
            y35 = 0.
          END IF
          IF (al(i+1) - q(i, j) .LT. y35) THEN
            y12 = y35
          ELSE
            y12 = al(i+1) - q(i, j)
          END IF
          IF (x13 .GT. y12) THEN
            br(i) = y12
          ELSE
            br(i) = x13
          END IF
        END DO
        DO i=ifirst,ilast+1
          IF (c(i, j) .GT. 0.) THEN
            flux(i, j) = q(i-1, j) + (1.-c(i, j))*(br(i-1)-c(i, j)*(bl(i&
&             -1)+br(i-1)))
          ELSE
            flux(i, j) = q(i, j) + (1.+c(i, j))*(bl(i)+c(i, j)*(bl(i)+br&
&             (i)))
          END IF
        END DO
      END DO
    ELSE IF (iord .EQ. 6 .OR. iord .EQ. 7) THEN
!do j=jfirst,jlast
      IF (iord .EQ. 6) THEN
!#ifdef UN_PPM
!        do i=ifirst-1,ilast+2
!           al(i) = p1*(q(i-1,j)+q(i,j)) + p2*(q(i-2,j)+q(i+1,j))
!        enddo
!        do i=is3, ie3
!           bl6(i,j) = al(i)   - q(i,j)
!           br6(i) = al(i+1) - q(i,j)
!        enddo
!#else
        DO j=jfirst,jlast
          DO i=is3,ie3
            bl6(i, j) = b5*q(i-2, j) + b4*q(i-1, j) + b3*q(i, j) + b2*q(&
&             i+1, j) + b1*q(i+2, j)
            br6(i, j) = b1*q(i-2, j) + b2*q(i-1, j) + b3*q(i, j) + b4*q(&
&             i+1, j) + b5*q(i+2, j)
          END DO
        END DO
      ELSE
!#endif
        DO j=jfirst,jlast
          DO i=is-3,ie+2
            dq(i) = q(i+1, j) - q(i, j)
          END DO
          DO i=is-2,ie+2
            IF (dq(i-1)*dq(i) .GT. 0.) THEN
              extm(i) = .false.
            ELSE
              extm(i) = .true.
            END IF
          END DO
          DO i=is3,ie3
!            if ( extm(i) .and. (extm(i-1) .or. extm(i+1)) ) then
            IF (extm(i-1) .AND. extm(i) .AND. extm(i+1)) THEN
! 2-delta-wave filter:
              bl6(i, j) = 0.
              br6(i, j) = 0.
            ELSE
              bl6(i, j) = b5*q(i-2, j) + b4*q(i-1, j) + b3*q(i, j) + b2*&
&               q(i+1, j) + b1*q(i+2, j)
              br6(i, j) = b1*q(i-2, j) + b2*q(i-1, j) + b3*q(i, j) + b4*&
&               q(i+1, j) + b5*q(i+2, j)
            END IF
          END DO
        END DO
      END IF
!--------------
! fix the edges
!--------------
      DO j=jfirst,jlast
        IF (.NOT.nested) THEN
          IF (is .EQ. 1) THEN
            x0l = 0.5*((2.*dxa(0, j)+dxa(-1, j))*q(0, j)-dxa(0, j)*q(-1&
&             , j))/(dxa(0, j)+dxa(-1, j))
            x0r = 0.5*((2.*dxa(1, j)+dxa(2, j))*q(1, j)-dxa(1, j)*q(2, j&
&             ))/(dxa(1, j)+dxa(2, j))
            br6(2, j) = p1*(q(2, j)+q(3, j)) + p2*(q(1, j)+q(4, j)) - q(&
&             2, j)
            xt = x0l + x0r
            bl6(1, j) = xt - q(1, j)
            br6(0, j) = xt - q(0, j)
            xt = c1*q(-2, j) + c2*q(-1, j) + c3*q(0, j)
!#ifdef DO_MONO_EDGE
!             xt = max( xt, min(q(-1,j),q(0,j)) )
!             xt = min( xt, max(q(-1,j),q(0,j)) )
!#endif
            bl6(0, j) = xt - q(0, j)
            xt = c3*q(1, j) + c2*q(2, j) + c1*q(3, j)
!#ifdef DO_MONO_EDGE
!             xt = max( xt, min(q(1,j),q(2,j)) )
!             xt = min( xt, max(q(1,j),q(2,j)) )
!#endif
            br6(1, j) = xt - q(1, j)
            bl6(2, j) = xt - q(2, j)
          END IF
          IF (ie + 1 .EQ. npx) THEN
            x0l = 0.5*((2.*dxa(npx-1, j)+dxa(npx-2, j))*q(npx-1, j)-dxa(&
&             npx-1, j)*q(npx-2, j))/(dxa(npx-1, j)+dxa(npx-2, j))
            x0r = 0.5*((2.*dxa(npx, j)+dxa(npx+1, j))*q(npx, j)-dxa(npx&
&             , j)*q(npx+1, j))/(dxa(npx, j)+dxa(npx+1, j))
            bl6(npx-2, j) = p1*(q(npx-2, j)+q(npx-3, j)) + p2*(q(npx-4, &
&             j)+q(npx-1, j)) - q(npx-2, j)
!             xt = x0L*gridstruct%sin_sg(npx-1,j,3) + x0R*gridstruct%sin_sg(npx,j,1)
!             xt = 2.*xt / (gridstruct%sin_sg(npx,j,1) + gridstruct%sin_sg(npx-1,j,3))
            xt = x0l + x0r
            br6(npx-1, j) = xt - q(npx-1, j)
            bl6(npx, j) = xt - q(npx, j)
            xt = c3*q(npx, j) + c2*q(npx+1, j) + c1*q(npx+2, j)
!#ifdef DO_MONO_EDGE
!             xt = max( xt, min(q(npx,j),q(npx+1,j)) )
!             xt = min( xt, max(q(npx,j),q(npx+1,j)) )
!#endif
            br6(npx, j) = xt - q(npx, j)
            xt = c1*q(npx-3, j) + c2*q(npx-2, j) + c3*q(npx-1, j)
!#ifdef DO_MONO_EDGE
!             xt = max( xt, min(q(npx-2,j),q(npx-1,j)) )
!             xt = min( xt, max(q(npx-2,j),q(npx-1,j)) )
!#endif
            br6(npx-2, j) = xt - q(npx-2, j)
            bl6(npx-1, j) = xt - q(npx-1, j)
          END IF
        END IF
! Positive definite constraint:
        IF (iord .EQ. 7) CALL PERT_PPM(ilast - ifirst + 3, q(ifirst-1, j&
&                                ), bl6(ifirst-1, j), br6(ifirst-1, j), &
&                                0)
      END DO
      DO j=jfirst,jlast
        DO i=ifirst,ilast+1
          IF (c(i, j) .GT. 0.) THEN
            flux(i, j) = q(i-1, j) + (1.-c(i, j))*(br6(i-1, j)-c(i, j)*(&
&             bl6(i-1, j)+br6(i-1, j)))
          ELSE
            flux(i, j) = q(i, j) + (1.+c(i, j))*(bl6(i, j)+c(i, j)*(bl6(&
&             i, j)+br6(i, j)))
          END IF
        END DO
      END DO
    ELSE IF (iord .LE. 10) THEN
! iord=8, 9, 10
      DO j=jfirst,jlast
! grid_type check
        IF (grid_type .LT. 3) THEN
          DO i=is-3,ie+2
            dq(i) = q(i+1, j) - q(i, j)
          END DO
          DO i=is-2,ie+2
            xt = 0.25*(q(i+1, j)-q(i-1, j))
            IF (xt .GE. 0.) THEN
              x14 = xt
            ELSE
              x14 = -xt
            END IF
            IF (q(i-1, j) .LT. q(i, j)) THEN
              IF (q(i, j) .LT. q(i+1, j)) THEN
                max7 = q(i+1, j)
              ELSE
                max7 = q(i, j)
              END IF
            ELSE IF (q(i-1, j) .LT. q(i+1, j)) THEN
              max7 = q(i+1, j)
            ELSE
              max7 = q(i-1, j)
            END IF
            y13 = max7 - q(i, j)
            IF (q(i-1, j) .GT. q(i, j)) THEN
              IF (q(i, j) .GT. q(i+1, j)) THEN
                min26 = q(i+1, j)
              ELSE
                min26 = q(i, j)
              END IF
            ELSE IF (q(i-1, j) .GT. q(i+1, j)) THEN
              min26 = q(i+1, j)
            ELSE
              min26 = q(i-1, j)
            END IF
            z7 = q(i, j) - min26
            IF (x14 .GT. y13) THEN
              IF (y13 .GT. z7) THEN
                min11 = z7
              ELSE
                min11 = y13
              END IF
            ELSE IF (x14 .GT. z7) THEN
              min11 = z7
            ELSE
              min11 = x14
            END IF
            dm1(i) = SIGN(min11, xt)
          END DO
!        do i=is3,min(npx-2,ie+2)
          DO i=is3,ie3+1
            al(i) = 0.5*(q(i-1, j)+q(i, j)) + r3*(dm1(i-1)-dm1(i))
          END DO
          IF (iord .EQ. 8) THEN
            DO i=is3,ie3
              xt = 2.*dm1(i)
              IF (xt .GE. 0.) THEN
                x15 = xt
              ELSE
                x15 = -xt
              END IF
              IF (al(i) - q(i, j) .GE. 0.) THEN
                y14 = al(i) - q(i, j)
              ELSE
                y14 = -(al(i)-q(i, j))
              END IF
              IF (x15 .GT. y14) THEN
                min12 = y14
              ELSE
                min12 = x15
              END IF
              bl(i) = -SIGN(min12, xt)
              IF (xt .GE. 0.) THEN
                x16 = xt
              ELSE
                x16 = -xt
              END IF
              IF (al(i+1) - q(i, j) .GE. 0.) THEN
                y15 = al(i+1) - q(i, j)
              ELSE
                y15 = -(al(i+1)-q(i, j))
              END IF
              IF (x16 .GT. y15) THEN
                min13 = y15
              ELSE
                min13 = x16
              END IF
              br(i) = SIGN(min13, xt)
            END DO
          ELSE IF (iord .EQ. 9) THEN
            DO i=is3,ie3
              pmp_1 = -(2.*dq(i))
              lac_1 = pmp_1 + 1.5*dq(i+1)
              IF (0. .LT. pmp_1) THEN
                IF (pmp_1 .LT. lac_1) THEN
                  x17 = lac_1
                ELSE
                  x17 = pmp_1
                END IF
              ELSE IF (0. .LT. lac_1) THEN
                x17 = lac_1
              ELSE
                x17 = 0.
              END IF
              IF (0. .GT. pmp_1) THEN
                IF (pmp_1 .GT. lac_1) THEN
                  y36 = lac_1
                ELSE
                  y36 = pmp_1
                END IF
              ELSE IF (0. .GT. lac_1) THEN
                y36 = lac_1
              ELSE
                y36 = 0.
              END IF
              IF (al(i) - q(i, j) .LT. y36) THEN
                y16 = y36
              ELSE
                y16 = al(i) - q(i, j)
              END IF
              IF (x17 .GT. y16) THEN
                bl(i) = y16
              ELSE
                bl(i) = x17
              END IF
              pmp_2 = 2.*dq(i-1)
              lac_2 = pmp_2 - 1.5*dq(i-2)
              IF (0. .LT. pmp_2) THEN
                IF (pmp_2 .LT. lac_2) THEN
                  x18 = lac_2
                ELSE
                  x18 = pmp_2
                END IF
              ELSE IF (0. .LT. lac_2) THEN
                x18 = lac_2
              ELSE
                x18 = 0.
              END IF
              IF (0. .GT. pmp_2) THEN
                IF (pmp_2 .GT. lac_2) THEN
                  y37 = lac_2
                ELSE
                  y37 = pmp_2
                END IF
              ELSE IF (0. .GT. lac_2) THEN
                y37 = lac_2
              ELSE
                y37 = 0.
              END IF
              IF (al(i+1) - q(i, j) .LT. y37) THEN
                y17 = y37
              ELSE
                y17 = al(i+1) - q(i, j)
              END IF
              IF (x18 .GT. y17) THEN
                br(i) = y17
              ELSE
                br(i) = x18
              END IF
            END DO
          ELSE
! iord=10
            DO i=is3,ie3
              bl(i) = al(i) - q(i, j)
              br(i) = al(i+1) - q(i, j)
              IF (dm1(i-1) .GE. 0.) THEN
                abs0 = dm1(i-1)
              ELSE
                abs0 = -dm1(i-1)
              END IF
              IF (dm1(i) .GE. 0.) THEN
                abs4 = dm1(i)
              ELSE
                abs4 = -dm1(i)
              END IF
              IF (dm1(i+1) .GE. 0.) THEN
                abs8 = dm1(i+1)
              ELSE
                abs8 = -dm1(i+1)
              END IF
              IF (abs0 + abs4 + abs8 .LT. near_zero) THEN
                bl(i) = 0.
                br(i) = 0.
              ELSE
                IF (3.*(bl(i)+br(i)) .GE. 0.) THEN
                  abs1 = 3.*(bl(i)+br(i))
                ELSE
                  abs1 = -(3.*(bl(i)+br(i)))
                END IF
                IF (bl(i) - br(i) .GE. 0.) THEN
                  abs5 = bl(i) - br(i)
                ELSE
                  abs5 = -(bl(i)-br(i))
                END IF
                IF (abs1 .GT. abs5) THEN
                  pmp_1 = -(dq(i)+dq(i))
                  lac_1 = pmp_1 + 1.5*dq(i+1)
                  IF (0. .LT. pmp_1) THEN
                    IF (pmp_1 .LT. lac_1) THEN
                      x19 = lac_1
                    ELSE
                      x19 = pmp_1
                    END IF
                  ELSE IF (0. .LT. lac_1) THEN
                    x19 = lac_1
                  ELSE
                    x19 = 0.
                  END IF
                  IF (0. .GT. pmp_1) THEN
                    IF (pmp_1 .GT. lac_1) THEN
                      y38 = lac_1
                    ELSE
                      y38 = pmp_1
                    END IF
                  ELSE IF (0. .GT. lac_1) THEN
                    y38 = lac_1
                  ELSE
                    y38 = 0.
                  END IF
                  IF (bl(i) .LT. y38) THEN
                    y18 = y38
                  ELSE
                    y18 = bl(i)
                  END IF
                  IF (x19 .GT. y18) THEN
                    bl(i) = y18
                  ELSE
                    bl(i) = x19
                  END IF
                  pmp_2 = dq(i-1) + dq(i-1)
                  lac_2 = pmp_2 - 1.5*dq(i-2)
                  IF (0. .LT. pmp_2) THEN
                    IF (pmp_2 .LT. lac_2) THEN
                      x20 = lac_2
                    ELSE
                      x20 = pmp_2
                    END IF
                  ELSE IF (0. .LT. lac_2) THEN
                    x20 = lac_2
                  ELSE
                    x20 = 0.
                  END IF
                  IF (0. .GT. pmp_2) THEN
                    IF (pmp_2 .GT. lac_2) THEN
                      y39 = lac_2
                    ELSE
                      y39 = pmp_2
                    END IF
                  ELSE IF (0. .GT. lac_2) THEN
                    y39 = lac_2
                  ELSE
                    y39 = 0.
                  END IF
                  IF (br(i) .LT. y39) THEN
                    y19 = y39
                  ELSE
                    y19 = br(i)
                  END IF
                  IF (x20 .GT. y19) THEN
                    br(i) = y19
                  ELSE
                    br(i) = x20
                  END IF
                END IF
              END IF
            END DO
          END IF
!--------------
! fix the edges
!--------------
          IF (.NOT.nested) THEN
            IF (is .EQ. 1) THEN
              x0l = 0.5*((2.*dxa(0, j)+dxa(-1, j))*q(0, j)-dxa(0, j)*q(-&
&               1, j))/(dxa(0, j)+dxa(-1, j))
              x0r = 0.5*((2.*dxa(1, j)+dxa(2, j))*q(1, j)-dxa(1, j)*q(2&
&               , j))/(dxa(1, j)+dxa(2, j))
              br(2) = al(3) - q(2, j)
              xt = x0l + x0r
!lmh              xt = 0.5*((2.*dxa(1,j)+dxa(2,j))*(q(0,j)+q(1,j))   &
!lmh                 - dxa(1,j)*(q(-1,j)+q(2,j)))/ ( dxa(1,j)+dxa(2,j))
              bl(1) = xt - q(1, j)
              br(0) = xt - q(0, j)
              xt = s14*dm1(-1) - s11*dq(-1) + q(0, j)
!             xt = max( xt, min(q(-1,j),q(0,j)) )
!             xt = min( xt, max(q(-1,j),q(0,j)) )
              bl(0) = xt - q(0, j)
              xt = s15*q(1, j) + s11*q(2, j) - s14*dm1(2)
!             xt = max( xt, min(q(1,j),q(2,j)) )
!             xt = min( xt, max(q(1,j),q(2,j)) )
              br(1) = xt - q(1, j)
              bl(2) = xt - q(2, j)
              CALL PERT_PPM(3, q(0, j), bl(0), br(0), 1)
            END IF
            IF (ie + 1 .EQ. npx) THEN
              bl(npx-2) = al(npx-2) - q(npx-2, j)
              x0l = 0.5*((2.*dxa(npx-1, j)+dxa(npx-2, j))*q(npx-1, j)-&
&               dxa(npx-1, j)*q(npx-2, j))/(dxa(npx-1, j)+dxa(npx-2, j))
              x0r = 0.5*((2.*dxa(npx, j)+dxa(npx+1, j))*q(npx, j)-dxa(&
&               npx, j)*q(npx+1, j))/(dxa(npx, j)+dxa(npx+1, j))
              xt = x0l + x0r
!lmh              xt = 0.5*( (2.*dxa(npx-1,j)+dxa(npx-2,j))*(q(npx-1,j)+q(npx,j))   &
!lmh                 - dxa(npx-1,j)*(q(npx-2,j)+q(npx+1,j)))/( dxa(npx-1,j)+dxa(npx-2,j))
              br(npx-1) = xt - q(npx-1, j)
              bl(npx) = xt - q(npx, j)
              xt = s11*dq(npx) - s14*dm1(npx+1) + q(npx, j)
!             xt = min( xt, max(q(npx,j), q(npx+1,j)) )
!             xt = max( xt, min(q(npx,j), q(npx+1,j)) )
              br(npx) = xt - q(npx, j)
              xt = s15*q(npx-1, j) + s11*q(npx-2, j) + s14*dm1(npx-2)
!             xt = min( xt, max(q(npx-2,j), q(npx-1,j)) )
!             xt = max( xt, min(q(npx-2,j), q(npx-1,j)) )
              br(npx-2) = xt - q(npx-2, j)
              bl(npx-1) = xt - q(npx-1, j)
              CALL PERT_PPM(3, q(npx-2, j), bl(npx-2), br(npx-2), 1)
            END IF
          END IF
        ELSE
!---------------
! grid_type == 4
!---------------
          DO i=ifirst-2,ilast+2
            xt = 0.25*(q(i+1, j)-q(i-1, j))
            IF (xt .GE. 0.) THEN
              x21 = xt
            ELSE
              x21 = -xt
            END IF
            IF (q(i-1, j) .LT. q(i, j)) THEN
              IF (q(i, j) .LT. q(i+1, j)) THEN
                max8 = q(i+1, j)
              ELSE
                max8 = q(i, j)
              END IF
            ELSE IF (q(i-1, j) .LT. q(i+1, j)) THEN
              max8 = q(i+1, j)
            ELSE
              max8 = q(i-1, j)
            END IF
            y20 = max8 - q(i, j)
            IF (q(i-1, j) .GT. q(i, j)) THEN
              IF (q(i, j) .GT. q(i+1, j)) THEN
                min27 = q(i+1, j)
              ELSE
                min27 = q(i, j)
              END IF
            ELSE IF (q(i-1, j) .GT. q(i+1, j)) THEN
              min27 = q(i+1, j)
            ELSE
              min27 = q(i-1, j)
            END IF
            z8 = q(i, j) - min27
            IF (x21 .GT. y20) THEN
              IF (y20 .GT. z8) THEN
                min14 = z8
              ELSE
                min14 = y20
              END IF
            ELSE IF (x21 .GT. z8) THEN
              min14 = z8
            ELSE
              min14 = x21
            END IF
            dm1(i) = SIGN(min14, xt)
          END DO
          DO i=ifirst-1,ilast+2
            al(i) = 0.5*(q(i-1, j)+q(i, j)) + r3*(dm1(i-1)-dm1(i))
          END DO
          DO i=ifirst-3,ilast+2
            dq(i) = q(i+1, j) - q(i, j)
          END DO
          DO i=ifirst-1,ilast+1
            pmp = -(2.*dq(i))
            lac = pmp + 1.5*dq(i+1)
            IF (0. .LT. pmp) THEN
              IF (pmp .LT. lac) THEN
                x22 = lac
              ELSE
                x22 = pmp
              END IF
            ELSE IF (0. .LT. lac) THEN
              x22 = lac
            ELSE
              x22 = 0.
            END IF
            IF (0. .GT. pmp) THEN
              IF (pmp .GT. lac) THEN
                y40 = lac
              ELSE
                y40 = pmp
              END IF
            ELSE IF (0. .GT. lac) THEN
              y40 = lac
            ELSE
              y40 = 0.
            END IF
            IF (al(i) - q(i, j) .LT. y40) THEN
              y21 = y40
            ELSE
              y21 = al(i) - q(i, j)
            END IF
            IF (x22 .GT. y21) THEN
              bl(i) = y21
            ELSE
              bl(i) = x22
            END IF
            pmp = 2.*dq(i-1)
            lac = pmp - 1.5*dq(i-2)
            IF (0. .LT. pmp) THEN
              IF (pmp .LT. lac) THEN
                x23 = lac
              ELSE
                x23 = pmp
              END IF
            ELSE IF (0. .LT. lac) THEN
              x23 = lac
            ELSE
              x23 = 0.
            END IF
            IF (0. .GT. pmp) THEN
              IF (pmp .GT. lac) THEN
                y41 = lac
              ELSE
                y41 = pmp
              END IF
            ELSE IF (0. .GT. lac) THEN
              y41 = lac
            ELSE
              y41 = 0.
            END IF
            IF (al(i+1) - q(i, j) .LT. y41) THEN
              y22 = y41
            ELSE
              y22 = al(i+1) - q(i, j)
            END IF
            IF (x23 .GT. y22) THEN
              br(i) = y22
            ELSE
              br(i) = x23
            END IF
          END DO
        END IF
        DO i=ifirst,ilast+1
          IF (c(i, j) .GT. 0.) THEN
            flux(i, j) = q(i-1, j) + (1.-c(i, j))*(br(i-1)-c(i, j)*(bl(i&
&             -1)+br(i-1)))
          ELSE
            flux(i, j) = q(i, j) + (1.+c(i, j))*(bl(i)+c(i, j)*(bl(i)+br&
&             (i)))
          END IF
        END DO
      END DO
    ELSE
!------------------------------
! For positive definite tracers:
!------------------------------
! iord=11: PPM mono constraint (Lin 2004)
! iord=12: Huynh 2nd constraint (Lin 2004) + positive definite (Lin & Rood 1996)
! iord>12: positive definite
      DO j=jfirst,jlast
        DO i=is-2,ie+2
          xt = 0.25*(q(i+1, j)-q(i-1, j))
          IF (xt .GE. 0.) THEN
            x24 = xt
          ELSE
            x24 = -xt
          END IF
          IF (q(i-1, j) .LT. q(i, j)) THEN
            IF (q(i, j) .LT. q(i+1, j)) THEN
              max9 = q(i+1, j)
            ELSE
              max9 = q(i, j)
            END IF
          ELSE IF (q(i-1, j) .LT. q(i+1, j)) THEN
            max9 = q(i+1, j)
          ELSE
            max9 = q(i-1, j)
          END IF
          y23 = max9 - q(i, j)
          IF (q(i-1, j) .GT. q(i, j)) THEN
            IF (q(i, j) .GT. q(i+1, j)) THEN
              min28 = q(i+1, j)
            ELSE
              min28 = q(i, j)
            END IF
          ELSE IF (q(i-1, j) .GT. q(i+1, j)) THEN
            min28 = q(i+1, j)
          ELSE
            min28 = q(i-1, j)
          END IF
          z9 = q(i, j) - min28
          IF (x24 .GT. y23) THEN
            IF (y23 .GT. z9) THEN
              min15 = z9
            ELSE
              min15 = y23
            END IF
          ELSE IF (x24 .GT. z9) THEN
            min15 = z9
          ELSE
            min15 = x24
          END IF
          dm1(i) = SIGN(min15, xt)
        END DO
        IF (grid_type .LT. 3) THEN
          IF (nested .AND. iord .NE. 14) THEN
            is3 = is - 1
            ie3 = ie + 1
          ELSE
            IF (3 .LT. is - 1) THEN
              is3 = is - 1
            ELSE
              is3 = 3
            END IF
            IF (npx - 3 .GT. ie + 1) THEN
              ie3 = ie + 1
            ELSE
              ie3 = npx - 3
            END IF
          END IF
!             do i=is3,min(npx-2,ie+2)
          DO i=is3,ie3+1
            al(i) = 0.5*(q(i-1, j)+q(i, j)) + r3*(dm1(i-1)-dm1(i))
          END DO
          IF (iord .EQ. 11) THEN
            DO i=is3,ie3
              xt = 2.*dm1(i)
              IF (xt .GE. 0.) THEN
                x25 = xt
              ELSE
                x25 = -xt
              END IF
              IF (al(i) - q(i, j) .GE. 0.) THEN
                y24 = al(i) - q(i, j)
              ELSE
                y24 = -(al(i)-q(i, j))
              END IF
              IF (x25 .GT. y24) THEN
                min16 = y24
              ELSE
                min16 = x25
              END IF
              bl(i) = -SIGN(min16, xt)
              IF (xt .GE. 0.) THEN
                x26 = xt
              ELSE
                x26 = -xt
              END IF
              IF (al(i+1) - q(i, j) .GE. 0.) THEN
                y25 = al(i+1) - q(i, j)
              ELSE
                y25 = -(al(i+1)-q(i, j))
              END IF
              IF (x26 .GT. y25) THEN
                min17 = y25
              ELSE
                min17 = x26
              END IF
              br(i) = SIGN(min17, xt)
            END DO
          ELSE IF (iord .EQ. 12) THEN
            DO i=is-3,ie+2
              dq(i) = q(i+1, j) - q(i, j)
            END DO
            DO i=is3,ie3
              pmp = -(2.*dq(i))
              lac = pmp + 1.5*dq(i+1)
              IF (0. .LT. pmp) THEN
                IF (pmp .LT. lac) THEN
                  x27 = lac
                ELSE
                  x27 = pmp
                END IF
              ELSE IF (0. .LT. lac) THEN
                x27 = lac
              ELSE
                x27 = 0.
              END IF
              IF (0. .GT. pmp) THEN
                IF (pmp .GT. lac) THEN
                  y42 = lac
                ELSE
                  y42 = pmp
                END IF
              ELSE IF (0. .GT. lac) THEN
                y42 = lac
              ELSE
                y42 = 0.
              END IF
              IF (al(i) - q(i, j) .LT. y42) THEN
                y26 = y42
              ELSE
                y26 = al(i) - q(i, j)
              END IF
              IF (x27 .GT. y26) THEN
                bl(i) = y26
              ELSE
                bl(i) = x27
              END IF
              pmp = 2.*dq(i-1)
              lac = pmp - 1.5*dq(i-2)
              IF (0. .LT. pmp) THEN
                IF (pmp .LT. lac) THEN
                  x28 = lac
                ELSE
                  x28 = pmp
                END IF
              ELSE IF (0. .LT. lac) THEN
                x28 = lac
              ELSE
                x28 = 0.
              END IF
              IF (0. .GT. pmp) THEN
                IF (pmp .GT. lac) THEN
                  y43 = lac
                ELSE
                  y43 = pmp
                END IF
              ELSE IF (0. .GT. lac) THEN
                y43 = lac
              ELSE
                y43 = 0.
              END IF
              IF (al(i+1) - q(i, j) .LT. y43) THEN
                y27 = y43
              ELSE
                y27 = al(i+1) - q(i, j)
              END IF
              IF (x28 .GT. y27) THEN
                br(i) = y27
              ELSE
                br(i) = x28
              END IF
            END DO
          ELSE
            DO i=is-3,ie+2
              dq(i) = q(i+1, j) - q(i, j)
            END DO
            DO i=is3,ie3
              IF (dm1(i-1) .GE. 0.) THEN
                abs2 = dm1(i-1)
              ELSE
                abs2 = -dm1(i-1)
              END IF
              IF (dm1(i) .GE. 0.) THEN
                abs6 = dm1(i)
              ELSE
                abs6 = -dm1(i)
              END IF
              IF (dm1(i+1) .GE. 0.) THEN
                abs9 = dm1(i+1)
              ELSE
                abs9 = -dm1(i+1)
              END IF
              IF (abs2 + abs6 + abs9 .LT. near_zero) THEN
                bl(i) = 0.
                br(i) = 0.
              ELSE
                bl(i) = al(i) - q(i, j)
                br(i) = al(i+1) - q(i, j)
                IF (3.*(bl(i)+br(i)) .GE. 0.) THEN
                  abs3 = 3.*(bl(i)+br(i))
                ELSE
                  abs3 = -(3.*(bl(i)+br(i)))
                END IF
                IF (bl(i) - br(i) .GE. 0.) THEN
                  abs7 = bl(i) - br(i)
                ELSE
                  abs7 = -(bl(i)-br(i))
                END IF
                IF (abs3 .GT. abs7) THEN
                  pmp_1 = -(dq(i)+dq(i))
                  lac_1 = pmp_1 + 1.5*dq(i+1)
                  IF (0. .LT. pmp_1) THEN
                    IF (pmp_1 .LT. lac_1) THEN
                      x29 = lac_1
                    ELSE
                      x29 = pmp_1
                    END IF
                  ELSE IF (0. .LT. lac_1) THEN
                    x29 = lac_1
                  ELSE
                    x29 = 0.
                  END IF
                  IF (0. .GT. pmp_1) THEN
                    IF (pmp_1 .GT. lac_1) THEN
                      y44 = lac_1
                    ELSE
                      y44 = pmp_1
                    END IF
                  ELSE IF (0. .GT. lac_1) THEN
                    y44 = lac_1
                  ELSE
                    y44 = 0.
                  END IF
                  IF (bl(i) .LT. y44) THEN
                    y28 = y44
                  ELSE
                    y28 = bl(i)
                  END IF
                  IF (x29 .GT. y28) THEN
                    bl(i) = y28
                  ELSE
                    bl(i) = x29
                  END IF
                  pmp_2 = dq(i-1) + dq(i-1)
                  lac_2 = pmp_2 - 1.5*dq(i-2)
                  IF (0. .LT. pmp_2) THEN
                    IF (pmp_2 .LT. lac_2) THEN
                      x30 = lac_2
                    ELSE
                      x30 = pmp_2
                    END IF
                  ELSE IF (0. .LT. lac_2) THEN
                    x30 = lac_2
                  ELSE
                    x30 = 0.
                  END IF
                  IF (0. .GT. pmp_2) THEN
                    IF (pmp_2 .GT. lac_2) THEN
                      y45 = lac_2
                    ELSE
                      y45 = pmp_2
                    END IF
                  ELSE IF (0. .GT. lac_2) THEN
                    y45 = lac_2
                  ELSE
                    y45 = 0.
                  END IF
                  IF (br(i) .LT. y45) THEN
                    y29 = y45
                  ELSE
                    y29 = br(i)
                  END IF
                  IF (x30 .GT. y29) THEN
                    br(i) = y29
                  ELSE
                    br(i) = x30
                  END IF
                END IF
              END IF
            END DO
          END IF
! Positive definite constraint:
          IF (iord .NE. 11) CALL PERT_PPM(ie3 - is3 + 1, q(is3, j), bl(&
&                                   is3), br(is3), 0)
!--------------
! fix the edges
!--------------
          IF (.NOT.nested) THEN
            IF (is .EQ. 1) THEN
              x0l = 0.5*((2.*dxa(0, j)+dxa(-1, j))*q(0, j)-dxa(0, j)*q(-&
&               1, j))/(dxa(0, j)+dxa(-1, j))
              x0r = 0.5*((2.*dxa(1, j)+dxa(2, j))*q(1, j)-dxa(1, j)*q(2&
&               , j))/(dxa(1, j)+dxa(2, j))
              br(2) = al(3) - q(2, j)
!               xt = t11*(q(0,j)+q(1,j)) + t12*(q(-1,j)+q(2,j)) + t13*(dm1(2)-dm1(-1))
!!!             xt = 0.75*(q(0,j)+q(1,j)) - 0.25*(q(-1,j)+q(2,j))
              xt = x0l + x0r
              IF (0. .LT. xt) THEN
                xt = xt
              ELSE
                xt = 0.
              END IF
              bl(1) = xt - q(1, j)
              br(0) = xt - q(0, j)
              xt = 4./7.*dm1(-1) + 11./14.*q(-1, j) + 3./14.*q(0, j)
              IF (0. .LT. xt) THEN
                xt = xt
              ELSE
                xt = 0.
              END IF
              bl(0) = xt - q(0, j)
              xt = 3./14.*q(1, j) + 11./14.*q(2, j) - 4./7.*dm1(2)
              IF (0. .LT. xt) THEN
                xt = xt
              ELSE
                xt = 0.
              END IF
              br(1) = xt - q(1, j)
              bl(2) = xt - q(2, j)
              CALL PERT_PPM(3, q(0, j), bl(0), br(0), 1)
            END IF
            IF (ie + 1 .EQ. npx) THEN
              x0l = 0.5*((2.*dxa(npx-1, j)+dxa(npx-2, j))*q(npx-1, j)-&
&               dxa(npx-1, j)*q(npx-2, j))/(dxa(npx-1, j)+dxa(npx-2, j))
              x0r = 0.5*((2.*dxa(npx, j)+dxa(npx+1, j))*q(npx, j)-dxa(&
&               npx, j)*q(npx+1, j))/(dxa(npx, j)+dxa(npx+1, j))
              bl(npx-2) = al(npx-2) - q(npx-2, j)
!               xt = t11*(q(npx-1,j)+q(npx,j)) + t12*(q(npx-2,j)+q(npx+1,j))   &
!                  + t13*(dm1(npx+1)-dm1(npx-2))
!!!             xt = 0.75*(q(npx-1,j)+q(npx,j)) - 0.25*(q(npx-2,j)+q(npx+1,j))
              xt = x0l + x0r
              IF (0. .LT. xt) THEN
                xt = xt
              ELSE
                xt = 0.
              END IF
              br(npx-1) = xt - q(npx-1, j)
              bl(npx) = xt - q(npx, j)
!               br(npx) = 11./14.*q(npx+1,j) + 3./14.*q(npx,j) - 4./7.*dm1(npx+1)
              xt = 11./14.*q(npx+1, j) + 3./14.*q(npx, j) - 4./7.*dm1(&
&               npx+1)
              IF (0. .LT. xt) THEN
                xt = xt
              ELSE
                xt = 0.
              END IF
              br(npx) = xt - q(npx, j)
              xt = 3./14.*q(npx-1, j) + 11./14.*q(npx-2, j) + 4./7.*dm1(&
&               npx-2)
              IF (0. .LT. xt) THEN
                xt = xt
              ELSE
                xt = 0.
              END IF
              br(npx-2) = xt - q(npx-2, j)
              bl(npx-1) = xt - q(npx-1, j)
              CALL PERT_PPM(3, q(npx-2, j), bl(npx-2), br(npx-2), 1)
            END IF
          END IF
        ELSE
!--------------
! grid_type >=4
!--------------
          DO i=ifirst-1,ilast+2
            al(i) = 0.5*(q(i-1, j)+q(i, j)) + r3*(dm1(i-1)-dm1(i))
          END DO
          IF (iord .EQ. 11) THEN
            DO i=ifirst-1,ilast+1
              xt = 2.*dm1(i)
              IF (xt .GE. 0.) THEN
                x31 = xt
              ELSE
                x31 = -xt
              END IF
              IF (al(i) - q(i, j) .GE. 0.) THEN
                y30 = al(i) - q(i, j)
              ELSE
                y30 = -(al(i)-q(i, j))
              END IF
              IF (x31 .GT. y30) THEN
                min18 = y30
              ELSE
                min18 = x31
              END IF
              bl(i) = -SIGN(min18, xt)
              IF (xt .GE. 0.) THEN
                x32 = xt
              ELSE
                x32 = -xt
              END IF
              IF (al(i+1) - q(i, j) .GE. 0.) THEN
                y31 = al(i+1) - q(i, j)
              ELSE
                y31 = -(al(i+1)-q(i, j))
              END IF
              IF (x32 .GT. y31) THEN
                min19 = y31
              ELSE
                min19 = x32
              END IF
              br(i) = SIGN(min19, xt)
            END DO
          ELSE IF (iord .EQ. 12) THEN
            DO i=ifirst-3,ilast+2
              dq(i) = q(i+1, j) - q(i, j)
            END DO
            DO i=ifirst-1,ilast+1
              pmp = -(2.*dq(i))
              lac = pmp + 1.5*dq(i+1)
              IF (0. .LT. pmp) THEN
                IF (pmp .LT. lac) THEN
                  x33 = lac
                ELSE
                  x33 = pmp
                END IF
              ELSE IF (0. .LT. lac) THEN
                x33 = lac
              ELSE
                x33 = 0.
              END IF
              IF (0. .GT. pmp) THEN
                IF (pmp .GT. lac) THEN
                  y46 = lac
                ELSE
                  y46 = pmp
                END IF
              ELSE IF (0. .GT. lac) THEN
                y46 = lac
              ELSE
                y46 = 0.
              END IF
              IF (al(i) - q(i, j) .LT. y46) THEN
                y32 = y46
              ELSE
                y32 = al(i) - q(i, j)
              END IF
              IF (x33 .GT. y32) THEN
                bl(i) = y32
              ELSE
                bl(i) = x33
              END IF
              pmp = 2.*dq(i-1)
              lac = pmp - 1.5*dq(i-2)
              IF (0. .LT. pmp) THEN
                IF (pmp .LT. lac) THEN
                  x34 = lac
                ELSE
                  x34 = pmp
                END IF
              ELSE IF (0. .LT. lac) THEN
                x34 = lac
              ELSE
                x34 = 0.
              END IF
              IF (0. .GT. pmp) THEN
                IF (pmp .GT. lac) THEN
                  y47 = lac
                ELSE
                  y47 = pmp
                END IF
              ELSE IF (0. .GT. lac) THEN
                y47 = lac
              ELSE
                y47 = 0.
              END IF
              IF (al(i+1) - q(i, j) .LT. y47) THEN
                y33 = y47
              ELSE
                y33 = al(i+1) - q(i, j)
              END IF
              IF (x34 .GT. y33) THEN
                br(i) = y33
              ELSE
                br(i) = x34
              END IF
            END DO
          ELSE
            DO i=is-1,ie+1
              bl(i) = al(i) - q(i, j)
              br(i) = al(i+1) - q(i, j)
            END DO
          END IF
! Positive definite constraint:
          IF (iord .NE. 11) CALL PERT_PPM(ilast - ifirst + 3, q(ifirst-1&
&                                   , j), bl(ifirst-1), br(ifirst-1), 0)
        END IF
        DO i=ifirst,ilast+1
          IF (c(i, j) .GT. 0.) THEN
            flux(i, j) = q(i-1, j) + (1.-c(i, j))*(br(i-1)-c(i, j)*(bl(i&
&             -1)+br(i-1)))
          ELSE
            flux(i, j) = q(i, j) + (1.+c(i, j))*(bl(i)+c(i, j)*(bl(i)+br&
&             (i)))
          END IF
        END DO
      END DO
    END IF
  END SUBROUTINE FXPPM
  SUBROUTINE FYPPM(c, q, flux, jord, ifirst, ilast, jfirst, jlast, npx, &
&   npy, dm, bd, dya, nested, grid_type)
    IMPLICIT NONE
    TYPE(FV_GRID_BOUNDS_TYPE), INTENT(IN) :: bd
!  X-Dir strip
    INTEGER, INTENT(IN) :: ifirst, ilast
!  Y-Dir strip
    INTEGER, INTENT(IN) :: jfirst, jlast
    INTEGER, INTENT(IN) :: jord
    INTEGER, INTENT(IN) :: npx, npy
    REAL(fvprc), INTENT(IN) :: q(ifirst:ilast, jfirst-ng:jlast+ng)
! Courant number
    REAL(fvprc), INTENT(IN) :: c(bd%isd:bd%ied, bd%js:bd%je+1)
!  Flux
    REAL(fvprc), INTENT(OUT) :: flux(ifirst:ilast, jfirst:jlast+1)
    REAL(fvprc), INTENT(OUT) :: dm(ifirst:ilast, jfirst-2:jlast+2)
    REAL(fvprc), INTENT(IN) :: dya(bd%isd:bd%ied, bd%jsd:bd%jed)
    LOGICAL, INTENT(IN) :: nested
    INTEGER, INTENT(IN) :: grid_type
! Local:
    LOGICAL :: extm(ifirst:ilast, jfirst-2:jlast+2)
    REAL(fvprc) :: al(ifirst:ilast, jfirst-1:jlast+2)
    REAL(fvprc) :: bl(ifirst:ilast, jfirst-1:jlast+1)
    REAL(fvprc) :: br(ifirst:ilast, jfirst-1:jlast+1)
    REAL(fvprc) :: dq(ifirst:ilast, jfirst-3:jlast+2)
    REAL(fvprc) :: dl, dr, pmp, lac, ct, qe
    REAL(fvprc) :: pmp_1, lac_1, pmp_2, lac_2
    REAL(fvprc) :: xt, x0, x1, x0l, x0r
    INTEGER :: i, j, js3, je3, jt
    INTRINSIC MAX
    INTRINSIC MIN
    INTRINSIC ABS
    INTRINSIC SIGN
    REAL(fvprc) :: min1
    INTEGER :: max1
    REAL(fvprc) :: min2
    REAL(fvprc) :: min3
    REAL(fvprc) :: min4
    REAL(fvprc) :: min5
    REAL(fvprc) :: min6
    REAL(fvprc) :: min7
    REAL(fvprc) :: min8
    REAL(fvprc) :: min9
    REAL(fvprc) :: min10
    INTEGER :: max2
    REAL(fvprc) :: min11
    REAL(fvprc) :: min12
    REAL(fvprc) :: min13
    REAL(fvprc) :: abs0
    REAL(fvprc) :: abs1
    REAL(fvprc) :: min14
    REAL(fvprc) :: min15
    REAL(fvprc) :: min16
    REAL(fvprc) :: abs2
    REAL(fvprc) :: abs3
    REAL(fvprc) :: min17
    REAL(fvprc) :: min18
    REAL(fvprc) :: max3
    REAL(fvprc) :: min19
    INTEGER :: min20
    REAL(fvprc) :: max4
    REAL(fvprc) :: min21
    REAL(fvprc) :: max5
    REAL(fvprc) :: min22
    REAL(fvprc) :: max6
    REAL(fvprc) :: min23
    REAL(fvprc) :: max7
    REAL(fvprc) :: min24
    REAL(fvprc) :: max8
    REAL(fvprc) :: min25
    INTEGER :: min26
    REAL(fvprc) :: max9
    REAL(fvprc) :: min27
    REAL(fvprc) :: abs4
    REAL(fvprc) :: abs5
    REAL(fvprc) :: max10
    REAL(fvprc) :: min28
    REAL(fvprc) :: abs6
    REAL(fvprc) :: abs7
    REAL(fvprc) :: abs8
    REAL(fvprc) :: abs9
    REAL(fvprc) :: x19
    REAL(fvprc) :: x18
    REAL(fvprc) :: x17
    REAL(fvprc) :: x16
    REAL(fvprc) :: x15
    REAL(fvprc) :: x14
    REAL(fvprc) :: x13
    REAL(fvprc) :: x12
    REAL(fvprc) :: x11
    REAL(fvprc) :: y29
    REAL(fvprc) :: x10
    REAL(fvprc) :: y28
    REAL(fvprc) :: y27
    REAL(fvprc) :: y26
    REAL(fvprc) :: y25
    REAL(fvprc) :: y24
    REAL(fvprc) :: y23
    REAL(fvprc) :: y22
    REAL(fvprc) :: y21
    REAL(fvprc) :: y20
    REAL(fvprc) :: x9
    REAL(fvprc) :: x8
    REAL(fvprc) :: x7
    REAL(fvprc) :: x6
    REAL(fvprc) :: x5
    REAL(fvprc) :: x4
    REAL(fvprc) :: x3
    REAL(fvprc) :: x2
    REAL(fvprc) :: y19
    REAL(fvprc) :: y18
    REAL(fvprc) :: y17
    REAL(fvprc) :: y16
    REAL(fvprc) :: y15
    REAL(fvprc) :: y14
    REAL(fvprc) :: x33
    REAL(fvprc) :: y13
    REAL(fvprc) :: x32
    REAL(fvprc) :: y12
    REAL(fvprc) :: x31
    REAL(fvprc) :: y11
    REAL(fvprc) :: x30
    REAL(fvprc) :: y10
    REAL(fvprc) :: y46
    REAL(fvprc) :: y45
    REAL(fvprc) :: y44
    REAL(fvprc) :: y43
    REAL(fvprc) :: y42
    REAL(fvprc) :: y41
    REAL(fvprc) :: y40
    REAL(fvprc) :: z8
    REAL(fvprc) :: z7
    REAL(fvprc) :: z6
    REAL(fvprc) :: z5
    REAL(fvprc) :: z4
    REAL(fvprc) :: z3
    REAL(fvprc) :: z2
    REAL(fvprc) :: z1
    REAL(fvprc) :: x29
    REAL(fvprc) :: x28
    REAL(fvprc) :: x27
    REAL(fvprc) :: x26
    REAL(fvprc) :: x25
    REAL(fvprc) :: x24
    REAL(fvprc) :: x23
    REAL(fvprc) :: x22
    REAL(fvprc) :: x21
    REAL(fvprc) :: y39
    REAL(fvprc) :: x20
    REAL(fvprc) :: y38
    REAL(fvprc) :: y37
    REAL(fvprc) :: y36
    REAL(fvprc) :: y35
    REAL(fvprc) :: y34
    REAL(fvprc) :: y33
    REAL(fvprc) :: y32
    REAL(fvprc) :: y31
    REAL(fvprc) :: y30
    REAL(fvprc) :: y9
    REAL(fvprc) :: y8
    REAL(fvprc) :: y7
    REAL(fvprc) :: y6
    REAL(fvprc) :: y5
    REAL(fvprc) :: y4
    REAL(fvprc) :: y3
    REAL(fvprc) :: y2
    REAL(fvprc) :: y1
    IF (nested) THEN
      js3 = js - 1
      je3 = je + 1
    ELSE
      IF (3 .LT. js - 1) THEN
        js3 = js - 1
      ELSE
        js3 = 3
      END IF
      IF (npy - 3 .GT. je + 1) THEN
        je3 = je + 1
      ELSE
        je3 = npy - 3
      END IF
    END IF
    IF (jord .LE. 4) THEN
      DO j=js-2,je+2
        DO i=ifirst,ilast
          xt = 0.25*(q(i, j+1)-q(i, j-1))
          IF (xt .GE. 0.) THEN
            x2 = xt
          ELSE
            x2 = -xt
          END IF
          IF (q(i, j-1) .LT. q(i, j)) THEN
            IF (q(i, j) .LT. q(i, j+1)) THEN
              max3 = q(i, j+1)
            ELSE
              max3 = q(i, j)
            END IF
          ELSE IF (q(i, j-1) .LT. q(i, j+1)) THEN
            max3 = q(i, j+1)
          ELSE
            max3 = q(i, j-1)
          END IF
          y1 = max3 - q(i, j)
          IF (q(i, j-1) .GT. q(i, j)) THEN
            IF (q(i, j) .GT. q(i, j+1)) THEN
              min19 = q(i, j+1)
            ELSE
              min19 = q(i, j)
            END IF
          ELSE IF (q(i, j-1) .GT. q(i, j+1)) THEN
            min19 = q(i, j+1)
          ELSE
            min19 = q(i, j-1)
          END IF
          z1 = q(i, j) - min19
          IF (x2 .GT. y1) THEN
            IF (y1 .GT. z1) THEN
              min1 = z1
            ELSE
              min1 = y1
            END IF
          ELSE IF (x2 .GT. z1) THEN
            min1 = z1
          ELSE
            min1 = x2
          END IF
          dm(i, j) = SIGN(min1, xt)
        END DO
      END DO
      IF (grid_type .LT. 3) THEN
        IF (3 .LT. js - 1) THEN
          max1 = js - 1
        ELSE
          max1 = 3
        END IF
        IF (npy - 2 .GT. je + 2) THEN
          min20 = je + 2
        ELSE
          min20 = npy - 2
        END IF
        DO j=max1,min20
          DO i=ifirst,ilast
            al(i, j) = 0.5*(q(i, j-1)+q(i, j)) + r3*(dm(i, j-1)-dm(i, j)&
&             )
          END DO
        END DO
!--------------
! Fix the edges:
!--------------
        IF (.NOT.nested) THEN
          IF (js .EQ. 1) THEN
            DO i=ifirst,ilast
              x0l = 0.5*((2.*dya(i, 0)+dya(i, -1))*q(i, 0)-dya(i, 0)*q(i&
&               , -1))/(dya(i, 0)+dya(i, -1))
              x0r = 0.5*((2.*dya(i, 1)+dya(i, 2))*q(i, 1)-dya(i, 1)*q(i&
&               , 2))/(dya(i, 1)+dya(i, 2))
              x0 = x0l + x0r
              al(i, 1) = x0
              x1 = s15*q(i, 0) + s11*q(i, -1) + s14*dm(i, -1)
              dm(i, 0) = 0.5*(x0-x1)
              IF (dm(i, 0) .GE. 0.) THEN
                x3 = dm(i, 0)
              ELSE
                x3 = -dm(i, 0)
              END IF
              IF (q(i, 0) .LT. x0) THEN
                IF (x0 .LT. x1) THEN
                  max4 = x1
                ELSE
                  max4 = x0
                END IF
              ELSE IF (q(i, 0) .LT. x1) THEN
                max4 = x1
              ELSE
                max4 = q(i, 0)
              END IF
              y2 = max4 - q(i, 0)
              IF (q(i, 0) .GT. x0) THEN
                IF (x0 .GT. x1) THEN
                  min21 = x1
                ELSE
                  min21 = x0
                END IF
              ELSE IF (q(i, 0) .GT. x1) THEN
                min21 = x1
              ELSE
                min21 = q(i, 0)
              END IF
              z2 = q(i, 0) - min21
              IF (x3 .GT. y2) THEN
                IF (y2 .GT. z2) THEN
                  min2 = z2
                ELSE
                  min2 = y2
                END IF
              ELSE IF (x3 .GT. z2) THEN
                min2 = z2
              ELSE
                min2 = x3
              END IF
              dm(i, 0) = SIGN(min2, dm(i, 0))
              al(i, 0) = 0.5*(q(i, -1)+q(i, 0)) + r3*(dm(i, -1)-dm(i, 0)&
&               )
!
              x1 = s15*q(i, 1) + s11*q(i, 2) - s14*dm(i, 2)
              dm(i, 1) = 0.5*(x1-x0)
              IF (dm(i, 1) .GE. 0.) THEN
                x4 = dm(i, 1)
              ELSE
                x4 = -dm(i, 1)
              END IF
              IF (q(i, 1) .LT. x0) THEN
                IF (x0 .LT. x1) THEN
                  max5 = x1
                ELSE
                  max5 = x0
                END IF
              ELSE IF (q(i, 1) .LT. x1) THEN
                max5 = x1
              ELSE
                max5 = q(i, 1)
              END IF
              y3 = max5 - q(i, 1)
              IF (q(i, 1) .GT. x0) THEN
                IF (x0 .GT. x1) THEN
                  min22 = x1
                ELSE
                  min22 = x0
                END IF
              ELSE IF (q(i, 1) .GT. x1) THEN
                min22 = x1
              ELSE
                min22 = q(i, 1)
              END IF
              z3 = q(i, 1) - min22
              IF (x4 .GT. y3) THEN
                IF (y3 .GT. z3) THEN
                  min3 = z3
                ELSE
                  min3 = y3
                END IF
              ELSE IF (x4 .GT. z3) THEN
                min3 = z3
              ELSE
                min3 = x4
              END IF
              dm(i, 1) = SIGN(min3, dm(i, 1))
              al(i, 2) = 0.5*(q(i, 1)+q(i, 2)) + r3*(dm(i, 1)-dm(i, 2))
            END DO
          END IF
          IF (je + 1 .EQ. npy) THEN
            DO i=ifirst,ilast
              x0l = 0.5*((2.*dya(i, npy-1)+dya(i, npy-2))*q(i, npy-1)-&
&               dya(i, npy-1)*q(i, npy-2))/(dya(i, npy-1)+dya(i, npy-2))
              x0r = 0.5*((2.*dya(i, npy)+dya(i, npy+1))*q(i, npy)-dya(i&
&               , npy)*q(i, npy+1))/(dya(i, npy)+dya(i, npy+1))
              x0 = x0l + x0r
              al(i, npy) = x0
              x1 = s15*q(i, npy-1) + s11*q(i, npy-2) + s14*dm(i, npy-2)
              dm(i, npy-1) = 0.5*(x0-x1)
              IF (dm(i, npy-1) .GE. 0.) THEN
                x5 = dm(i, npy-1)
              ELSE
                x5 = -dm(i, npy-1)
              END IF
              IF (q(i, npy-1) .LT. x0) THEN
                IF (x0 .LT. x1) THEN
                  max6 = x1
                ELSE
                  max6 = x0
                END IF
              ELSE IF (q(i, npy-1) .LT. x1) THEN
                max6 = x1
              ELSE
                max6 = q(i, npy-1)
              END IF
              y4 = max6 - q(i, npy-1)
              IF (q(i, npy-1) .GT. x0) THEN
                IF (x0 .GT. x1) THEN
                  min23 = x1
                ELSE
                  min23 = x0
                END IF
              ELSE IF (q(i, npy-1) .GT. x1) THEN
                min23 = x1
              ELSE
                min23 = q(i, npy-1)
              END IF
              z4 = q(i, npy-1) - min23
              IF (x5 .GT. y4) THEN
                IF (y4 .GT. z4) THEN
                  min4 = z4
                ELSE
                  min4 = y4
                END IF
              ELSE IF (x5 .GT. z4) THEN
                min4 = z4
              ELSE
                min4 = x5
              END IF
              dm(i, npy-1) = SIGN(min4, dm(i, npy-1))
              al(i, npy-1) = 0.5*(q(i, npy-2)+q(i, npy-1)) + r3*(dm(i, &
&               npy-2)-dm(i, npy-1))
!
              x1 = s15*q(i, npy) + s11*q(i, npy+1) - s14*dm(i, npy+1)
              dm(i, npy) = 0.5*(x1-x0)
              IF (dm(i, npy) .GE. 0.) THEN
                x6 = dm(i, npy)
              ELSE
                x6 = -dm(i, npy)
              END IF
              IF (q(i, npy) .LT. x0) THEN
                IF (x0 .LT. x1) THEN
                  max7 = x1
                ELSE
                  max7 = x0
                END IF
              ELSE IF (q(i, npy) .LT. x1) THEN
                max7 = x1
              ELSE
                max7 = q(i, npy)
              END IF
              y5 = max7 - q(i, npy)
              IF (q(i, npy) .GT. x0) THEN
                IF (x0 .GT. x1) THEN
                  min24 = x1
                ELSE
                  min24 = x0
                END IF
              ELSE IF (q(i, npy) .GT. x1) THEN
                min24 = x1
              ELSE
                min24 = q(i, npy)
              END IF
              z5 = q(i, npy) - min24
              IF (x6 .GT. y5) THEN
                IF (y5 .GT. z5) THEN
                  min5 = z5
                ELSE
                  min5 = y5
                END IF
              ELSE IF (x6 .GT. z5) THEN
                min5 = z5
              ELSE
                min5 = x6
              END IF
              dm(i, npy) = SIGN(min5, dm(i, npy))
              al(i, npy+1) = 0.5*(q(i, npy)+q(i, npy+1)) + r3*(dm(i, npy&
&               )-dm(i, npy+1))
            END DO
          END IF
        END IF
      ELSE
! Doubly periodic BC:
        DO j=js-1,je+2
          DO i=ifirst,ilast
            al(i, j) = 0.5*(q(i, j-1)+q(i, j)) + r3*(dm(i, j-1)-dm(i, j)&
&             )
          END DO
        END DO
      END IF
      IF (jord .EQ. 3) THEN
        DO j=js-1,je+1
          DO i=ifirst,ilast
            bl(i, j) = al(i, j) - q(i, j)
            br(i, j) = al(i, j+1) - q(i, j)
          END DO
          CALL PERT_PPM(ilast - ifirst + 1, q(ifirst, j), bl(ifirst, j)&
&                 , br(ifirst, j), 1)
        END DO
        DO j=js,je+1
          DO i=ifirst,ilast
            IF (c(i, j) .GT. 0.) THEN
              flux(i, j) = q(i, j-1) + (1.-c(i, j))*(br(i, j-1)-c(i, j)*&
&               (bl(i, j-1)+br(i, j-1)))
            ELSE
              flux(i, j) = q(i, j) + (1.+c(i, j))*(bl(i, j)+c(i, j)*(bl(&
&               i, j)+br(i, j)))
            END IF
          END DO
        END DO
      ELSE
! Inlined limiter
        DO j=js,je+1
          DO i=ifirst,ilast
            IF (c(i, j) .GT. 0.) THEN
              xt = ppm_limiter*dm(i, j-1)
              IF (xt .GE. 0.) THEN
                x7 = xt
              ELSE
                x7 = -xt
              END IF
              IF (al(i, j-1) - q(i, j-1) .GE. 0.) THEN
                y6 = al(i, j-1) - q(i, j-1)
              ELSE
                y6 = -(al(i, j-1)-q(i, j-1))
              END IF
              IF (x7 .GT. y6) THEN
                min6 = y6
              ELSE
                min6 = x7
              END IF
              dl = SIGN(min6, xt)
              IF (xt .GE. 0.) THEN
                x8 = xt
              ELSE
                x8 = -xt
              END IF
              IF (al(i, j) - q(i, j-1) .GE. 0.) THEN
                y7 = al(i, j) - q(i, j-1)
              ELSE
                y7 = -(al(i, j)-q(i, j-1))
              END IF
              IF (x8 .GT. y7) THEN
                min7 = y7
              ELSE
                min7 = x8
              END IF
              dr = SIGN(min7, xt)
              flux(i, j) = q(i, j-1) + (1.-c(i, j))*(c(i, j)*(dl-dr)+dr)
            ELSE
              xt = ppm_limiter*dm(i, j)
              IF (xt .GE. 0.) THEN
                x9 = xt
              ELSE
                x9 = -xt
              END IF
              IF (al(i, j) - q(i, j) .GE. 0.) THEN
                y8 = al(i, j) - q(i, j)
              ELSE
                y8 = -(al(i, j)-q(i, j))
              END IF
              IF (x9 .GT. y8) THEN
                min8 = y8
              ELSE
                min8 = x9
              END IF
              dl = SIGN(min8, xt)
              IF (xt .GE. 0.) THEN
                x10 = xt
              ELSE
                x10 = -xt
              END IF
              IF (al(i, j+1) - q(i, j) .GE. 0.) THEN
                y9 = al(i, j+1) - q(i, j)
              ELSE
                y9 = -(al(i, j+1)-q(i, j))
              END IF
              IF (x10 .GT. y9) THEN
                min9 = y9
              ELSE
                min9 = x10
              END IF
              dr = SIGN(min9, xt)
              flux(i, j) = q(i, j) - (1.+c(i, j))*(c(i, j)*(dl-dr)+dl)
            END IF
          END DO
        END DO
      END IF
    ELSE IF (jord .EQ. 5) THEN
! PPM with Hunyh's 2nd constraint
      DO j=jfirst-3,jlast+2
        DO i=ifirst,ilast
          dq(i, j) = q(i, j+1) - q(i, j)
        END DO
      END DO
      DO j=jfirst-2,jlast+2
        DO i=ifirst,ilast
          xt = 0.25*(q(i, j+1)-q(i, j-1))
          IF (xt .GE. 0.) THEN
            x11 = xt
          ELSE
            x11 = -xt
          END IF
          IF (q(i, j-1) .LT. q(i, j)) THEN
            IF (q(i, j) .LT. q(i, j+1)) THEN
              max8 = q(i, j+1)
            ELSE
              max8 = q(i, j)
            END IF
          ELSE IF (q(i, j-1) .LT. q(i, j+1)) THEN
            max8 = q(i, j+1)
          ELSE
            max8 = q(i, j-1)
          END IF
          y10 = max8 - q(i, j)
          IF (q(i, j-1) .GT. q(i, j)) THEN
            IF (q(i, j) .GT. q(i, j+1)) THEN
              min25 = q(i, j+1)
            ELSE
              min25 = q(i, j)
            END IF
          ELSE IF (q(i, j-1) .GT. q(i, j+1)) THEN
            min25 = q(i, j+1)
          ELSE
            min25 = q(i, j-1)
          END IF
          z6 = q(i, j) - min25
          IF (x11 .GT. y10) THEN
            IF (y10 .GT. z6) THEN
              min10 = z6
            ELSE
              min10 = y10
            END IF
          ELSE IF (x11 .GT. z6) THEN
            min10 = z6
          ELSE
            min10 = x11
          END IF
          dm(i, j) = SIGN(min10, xt)
        END DO
      END DO
      DO j=jfirst-1,jlast+2
        DO i=ifirst,ilast
          al(i, j) = 0.5*(q(i, j-1)+q(i, j)) + r3*(dm(i, j-1)-dm(i, j))
        END DO
      END DO
      DO j=jfirst-1,jlast+1
        DO i=ifirst,ilast
          pmp = -(2.*dq(i, j))
          lac = pmp + 1.5*dq(i, j+1)
          IF (0. .LT. pmp) THEN
            IF (pmp .LT. lac) THEN
              x12 = lac
            ELSE
              x12 = pmp
            END IF
          ELSE IF (0. .LT. lac) THEN
            x12 = lac
          ELSE
            x12 = 0.
          END IF
          IF (0. .GT. pmp) THEN
            IF (pmp .GT. lac) THEN
              y33 = lac
            ELSE
              y33 = pmp
            END IF
          ELSE IF (0. .GT. lac) THEN
            y33 = lac
          ELSE
            y33 = 0.
          END IF
          IF (al(i, j) - q(i, j) .LT. y33) THEN
            y11 = y33
          ELSE
            y11 = al(i, j) - q(i, j)
          END IF
          IF (x12 .GT. y11) THEN
            bl(i, j) = y11
          ELSE
            bl(i, j) = x12
          END IF
          pmp = 2.*dq(i, j-1)
          lac = pmp - 1.5*dq(i, j-2)
          IF (0. .LT. pmp) THEN
            IF (pmp .LT. lac) THEN
              x13 = lac
            ELSE
              x13 = pmp
            END IF
          ELSE IF (0. .LT. lac) THEN
            x13 = lac
          ELSE
            x13 = 0.
          END IF
          IF (0. .GT. pmp) THEN
            IF (pmp .GT. lac) THEN
              y34 = lac
            ELSE
              y34 = pmp
            END IF
          ELSE IF (0. .GT. lac) THEN
            y34 = lac
          ELSE
            y34 = 0.
          END IF
          IF (al(i, j+1) - q(i, j) .LT. y34) THEN
            y12 = y34
          ELSE
            y12 = al(i, j+1) - q(i, j)
          END IF
          IF (x13 .GT. y12) THEN
            br(i, j) = y12
          ELSE
            br(i, j) = x13
          END IF
        END DO
      END DO
      DO j=jfirst,jlast+1
        DO i=ifirst,ilast
          IF (c(i, j) .GT. 0.) THEN
            flux(i, j) = q(i, j-1) + (1.-c(i, j))*(br(i, j-1)-c(i, j)*(&
&             bl(i, j-1)+br(i, j-1)))
          ELSE
            flux(i, j) = q(i, j) + (1.+c(i, j))*(bl(i, j)+c(i, j)*(bl(i&
&             , j)+br(i, j)))
          END IF
        END DO
      END DO
    ELSE IF (jord .EQ. 6 .OR. jord .EQ. 7) THEN
      IF (jord .EQ. 6) THEN
        IF (3 .LT. js - 1) THEN
          max2 = js - 1
        ELSE
          max2 = 3
        END IF
        IF (npy - 3 .GT. je + 1) THEN
          min26 = je + 1
        ELSE
          min26 = npy - 3
        END IF
!#ifdef UN_PPM
!   do j=jfirst-1,jlast+2
!      do i=ifirst,ilast
!         al(i,j) = p1*(q(i,j-1)+q(i,j)) + p2*(q(i,j-2)+q(i,j+1))
!      enddo
!   enddo
!   do j=max(3,js-1),min(npy-3,je+1)
!      do i=ifirst,ilast
!         bl(i,j) = al(i,j  ) - q(i,j)
!         br(i,j) = al(i,j+1) - q(i,j)
!      enddo
!   enddo
!#else
        DO j=max2,min26
          DO i=ifirst,ilast
            bl(i, j) = b5*q(i, j-2) + b4*q(i, j-1) + b3*q(i, j) + b2*q(i&
&             , j+1) + b1*q(i, j+2)
            br(i, j) = b1*q(i, j-2) + b2*q(i, j-1) + b3*q(i, j) + b4*q(i&
&             , j+1) + b5*q(i, j+2)
          END DO
        END DO
      ELSE
!#endif
        DO j=js-3,je+2
          DO i=ifirst,ilast
            dq(i, j) = q(i, j+1) - q(i, j)
          END DO
        END DO
        DO j=js-2,je+2
          DO i=ifirst,ilast
            IF (dq(i, j-1)*dq(i, j) .GT. 0.) THEN
              extm(i, j) = .false.
            ELSE
              extm(i, j) = .true.
            END IF
          END DO
        END DO
        DO j=js3,je3
!do j=max(3,js-1),min(npy-3,je+1)
          DO i=ifirst,ilast
            IF (extm(i, j-1) .AND. extm(i, j) .AND. extm(i, j+1)) THEN
! 2-delta-wave filter
              bl(i, j) = 0.
              br(i, j) = 0.
            ELSE
              bl(i, j) = b5*q(i, j-2) + b4*q(i, j-1) + b3*q(i, j) + b2*q&
&               (i, j+1) + b1*q(i, j+2)
              br(i, j) = b1*q(i, j-2) + b2*q(i, j-1) + b3*q(i, j) + b4*q&
&               (i, j+1) + b5*q(i, j+2)
            END IF
          END DO
        END DO
      END IF
      IF (js .EQ. 1 .AND. (.NOT.nested)) THEN
        DO i=ifirst,ilast
!           br(i,2) = al(i,3) - q(i,2)
          br(i, 2) = p1*(q(i, 2)+q(i, 3)) + p2*(q(i, 1)+q(i, 4)) - q(i, &
&           2)
          x0l = 0.5*((2.*dya(i, 0)+dya(i, -1))*q(i, 0)-dya(i, 0)*q(i, -1&
&           ))/(dya(i, 0)+dya(i, -1))
          x0r = 0.5*((2.*dya(i, 1)+dya(i, 2))*q(i, 1)-dya(i, 1)*q(i, 2))&
&           /(dya(i, 1)+dya(i, 2))
          xt = x0l + x0r
!            xt = ( x0L*gridstruct%sin_sg(i,0,4) + x0R*gridstruct%sin_sg(i,1,2) ) 
!            xt = 2.*xt / ( gridstruct%sin_sg(i,0,4) + gridstruct%sin_sg(i,1,2) )
          bl(i, 1) = xt - q(i, 1)
          br(i, 0) = xt - q(i, 0)
!           xt = s14*0.25*(q(i,0)-q(i,-2)) - s11*(q(i,0)-q(i,-1)) + q(i,0)
          xt = c1*q(i, -2) + c2*q(i, -1) + c3*q(i, 0)
!#ifdef DO_MONO_EDGE
!            xt = min( xt, max(q(i,-1), q(i,0)) )
!            xt = max( xt, min(q(i,-1), q(i,0)) )
!#endif
          bl(i, 0) = xt - q(i, 0)
!           xt = s15*q(i,1) + s11*q(i,2) - s14*0.25*(q(i,3)-q(i,1))
          xt = c3*q(i, 1) + c2*q(i, 2) + c1*q(i, 3)
!#ifdef DO_MONO_EDGE
!            xt = min( xt, max(q(i,1), q(i,2)) )
!            xt = max( xt, min(q(i,1), q(i,2)) )
!#endif
          br(i, 1) = xt - q(i, 1)
          bl(i, 2) = xt - q(i, 2)
        END DO
      END IF
      IF (je + 1 .EQ. npy .AND. (.NOT.nested)) THEN
        DO i=ifirst,ilast
!           bl(i,npy-2) = al(i,npy-2) - q(i,npy-2)
          bl(i, npy-2) = p1*(q(i, npy-3)+q(i, npy-2)) + p2*(q(i, npy-4)+&
&           q(i, npy-1)) - q(i, npy-2)
          x0l = 0.5*((2.*dya(i, npy-1)+dya(i, npy-2))*q(i, npy-1)-dya(i&
&           , npy-1)*q(i, npy-2))/(dya(i, npy-1)+dya(i, npy-2))
          x0r = 0.5*((2.*dya(i, npy)+dya(i, npy+1))*q(i, npy)-dya(i, npy&
&           )*q(i, npy+1))/(dya(i, npy)+dya(i, npy+1))
          xt = x0l + x0r
!            xt = x0L*gridstruct%sin_sg(i,npy-1,4) + x0R*gridstruct%sin_sg(i,npy,2)
!            xt = 2.*xt /( gridstruct%sin_sg(i,npy-1,4) + gridstruct%sin_sg(i,npy,2) )
          br(i, npy-1) = xt - q(i, npy-1)
          bl(i, npy) = xt - q(i, npy)
!           xt = s11*(q(i,npy+1)-q(i,npy)) - s14*0.25*(q(i,npy+2)-q(i,npy)) + q(i,npy)
          xt = c3*q(i, npy) + c2*q(i, npy+1) + c1*q(i, npy+2)
!#ifdef DO_MONO_EDGE
!            xt = min( xt, max(q(i,npy), q(i,npy+1)) )
!            xt = max( xt, min(q(i,npy), q(i,npy+1)) )
!#endif
          br(i, npy) = xt - q(i, npy)
!           xt = s15*q(i,npy-1) + s11*q(i,npy-2) + s14*0.25*(q(i,npy-1)-q(i,npy-3))
          xt = c1*q(i, npy-3) + c2*q(i, npy-2) + c3*q(i, npy-1)
!#ifdef DO_MONO_EDGE
!            xt = min( xt, max(q(i,npy-2), q(i,npy-1)) )
!            xt = max( xt, min(q(i,npy-2), q(i,npy-1)) )
!#endif
          br(i, npy-2) = xt - q(i, npy-2)
          bl(i, npy-1) = xt - q(i, npy-1)
        END DO
      END IF
! Positive definite constraint:
      IF (jord .EQ. 7) THEN
        DO j=jfirst-1,jlast+1
          CALL PERT_PPM(ilast - ifirst + 1, q(ifirst, j), bl(ifirst, j)&
&                 , br(ifirst, j), 0)
        END DO
      END IF
      DO j=jfirst,jlast+1
        DO i=ifirst,ilast
          IF (c(i, j) .GT. 0.) THEN
            flux(i, j) = q(i, j-1) + (1.-c(i, j))*(br(i, j-1)-c(i, j)*(&
&             bl(i, j-1)+br(i, j-1)))
          ELSE
            flux(i, j) = q(i, j) + (1.+c(i, j))*(bl(i, j)+c(i, j)*(bl(i&
&             , j)+br(i, j)))
          END IF
        END DO
      END DO
    ELSE IF (jord .LE. 10) THEN
! jord=8, 9, 10
      DO j=js-2,je+2
        DO i=ifirst,ilast
          xt = 0.25*(q(i, j+1)-q(i, j-1))
          IF (xt .GE. 0.) THEN
            x14 = xt
          ELSE
            x14 = -xt
          END IF
          IF (q(i, j-1) .LT. q(i, j)) THEN
            IF (q(i, j) .LT. q(i, j+1)) THEN
              max9 = q(i, j+1)
            ELSE
              max9 = q(i, j)
            END IF
          ELSE IF (q(i, j-1) .LT. q(i, j+1)) THEN
            max9 = q(i, j+1)
          ELSE
            max9 = q(i, j-1)
          END IF
          y13 = max9 - q(i, j)
          IF (q(i, j-1) .GT. q(i, j)) THEN
            IF (q(i, j) .GT. q(i, j+1)) THEN
              min27 = q(i, j+1)
            ELSE
              min27 = q(i, j)
            END IF
          ELSE IF (q(i, j-1) .GT. q(i, j+1)) THEN
            min27 = q(i, j+1)
          ELSE
            min27 = q(i, j-1)
          END IF
          z7 = q(i, j) - min27
          IF (x14 .GT. y13) THEN
            IF (y13 .GT. z7) THEN
              min11 = z7
            ELSE
              min11 = y13
            END IF
          ELSE IF (x14 .GT. z7) THEN
            min11 = z7
          ELSE
            min11 = x14
          END IF
          dm(i, j) = SIGN(min11, xt)
        END DO
      END DO
      IF (grid_type .LT. 3) THEN
!      do j=max(3,js-1),min(npy-2,je+2)
        DO j=js3,je3+1
          DO i=ifirst,ilast
            al(i, j) = 0.5*(q(i, j-1)+q(i, j)) + r3*(dm(i, j-1)-dm(i, j)&
&             )
          END DO
        END DO
        DO j=js-3,je+2
          DO i=ifirst,ilast
            dq(i, j) = q(i, j+1) - q(i, j)
          END DO
        END DO
        IF (jord .EQ. 8) THEN
!         do j=max(3,js-1),min(npy-3,je+1) 
          DO j=js3,je3
            DO i=ifirst,ilast
              xt = 2.*dm(i, j)
              IF (xt .GE. 0.) THEN
                x15 = xt
              ELSE
                x15 = -xt
              END IF
              IF (al(i, j) - q(i, j) .GE. 0.) THEN
                y14 = al(i, j) - q(i, j)
              ELSE
                y14 = -(al(i, j)-q(i, j))
              END IF
              IF (x15 .GT. y14) THEN
                min12 = y14
              ELSE
                min12 = x15
              END IF
              bl(i, j) = -SIGN(min12, xt)
              IF (xt .GE. 0.) THEN
                x16 = xt
              ELSE
                x16 = -xt
              END IF
              IF (al(i, j+1) - q(i, j) .GE. 0.) THEN
                y15 = al(i, j+1) - q(i, j)
              ELSE
                y15 = -(al(i, j+1)-q(i, j))
              END IF
              IF (x16 .GT. y15) THEN
                min13 = y15
              ELSE
                min13 = x16
              END IF
              br(i, j) = SIGN(min13, xt)
            END DO
          END DO
        ELSE IF (jord .EQ. 9) THEN
!         do j=max(3,js-1),min(npy-3,je+1) 
          DO j=js3,je3
            DO i=ifirst,ilast
              pmp_1 = -(2.*dq(i, j))
              lac_1 = pmp_1 + 1.5*dq(i, j+1)
              IF (0. .LT. pmp_1) THEN
                IF (pmp_1 .LT. lac_1) THEN
                  x17 = lac_1
                ELSE
                  x17 = pmp_1
                END IF
              ELSE IF (0. .LT. lac_1) THEN
                x17 = lac_1
              ELSE
                x17 = 0.
              END IF
              IF (0. .GT. pmp_1) THEN
                IF (pmp_1 .GT. lac_1) THEN
                  y35 = lac_1
                ELSE
                  y35 = pmp_1
                END IF
              ELSE IF (0. .GT. lac_1) THEN
                y35 = lac_1
              ELSE
                y35 = 0.
              END IF
              IF (al(i, j) - q(i, j) .LT. y35) THEN
                y16 = y35
              ELSE
                y16 = al(i, j) - q(i, j)
              END IF
              IF (x17 .GT. y16) THEN
                bl(i, j) = y16
              ELSE
                bl(i, j) = x17
              END IF
              pmp_2 = 2.*dq(i, j-1)
              lac_2 = pmp_2 - 1.5*dq(i, j-2)
              IF (0. .LT. pmp_2) THEN
                IF (pmp_2 .LT. lac_2) THEN
                  x18 = lac_2
                ELSE
                  x18 = pmp_2
                END IF
              ELSE IF (0. .LT. lac_2) THEN
                x18 = lac_2
              ELSE
                x18 = 0.
              END IF
              IF (0. .GT. pmp_2) THEN
                IF (pmp_2 .GT. lac_2) THEN
                  y36 = lac_2
                ELSE
                  y36 = pmp_2
                END IF
              ELSE IF (0. .GT. lac_2) THEN
                y36 = lac_2
              ELSE
                y36 = 0.
              END IF
              IF (al(i, j+1) - q(i, j) .LT. y36) THEN
                y17 = y36
              ELSE
                y17 = al(i, j+1) - q(i, j)
              END IF
              IF (x18 .GT. y17) THEN
                br(i, j) = y17
              ELSE
                br(i, j) = x18
              END IF
            END DO
          END DO
        ELSE
! jord=10
!         do j=max(3,js-1),min(npy-3,je+1) 
          DO j=js3,je3
            DO i=ifirst,ilast
              bl(i, j) = al(i, j) - q(i, j)
              br(i, j) = al(i, j+1) - q(i, j)
              IF (dm(i, j-1) .GE. 0.) THEN
                abs0 = dm(i, j-1)
              ELSE
                abs0 = -dm(i, j-1)
              END IF
              IF (dm(i, j) .GE. 0.) THEN
                abs4 = dm(i, j)
              ELSE
                abs4 = -dm(i, j)
              END IF
              IF (dm(i, j+1) .GE. 0.) THEN
                abs8 = dm(i, j+1)
              ELSE
                abs8 = -dm(i, j+1)
              END IF
              IF (abs0 + abs4 + abs8 .LT. near_zero) THEN
                bl(i, j) = 0.
                br(i, j) = 0.
              ELSE
                IF (3.*(bl(i, j)+br(i, j)) .GE. 0.) THEN
                  abs1 = 3.*(bl(i, j)+br(i, j))
                ELSE
                  abs1 = -(3.*(bl(i, j)+br(i, j)))
                END IF
                IF (bl(i, j) - br(i, j) .GE. 0.) THEN
                  abs5 = bl(i, j) - br(i, j)
                ELSE
                  abs5 = -(bl(i, j)-br(i, j))
                END IF
                IF (abs1 .GT. abs5) THEN
                  pmp_1 = -(2.*dq(i, j))
                  lac_1 = pmp_1 + 1.5*dq(i, j+1)
                  IF (0. .LT. pmp_1) THEN
                    IF (pmp_1 .LT. lac_1) THEN
                      x19 = lac_1
                    ELSE
                      x19 = pmp_1
                    END IF
                  ELSE IF (0. .LT. lac_1) THEN
                    x19 = lac_1
                  ELSE
                    x19 = 0.
                  END IF
                  IF (0. .GT. pmp_1) THEN
                    IF (pmp_1 .GT. lac_1) THEN
                      y37 = lac_1
                    ELSE
                      y37 = pmp_1
                    END IF
                  ELSE IF (0. .GT. lac_1) THEN
                    y37 = lac_1
                  ELSE
                    y37 = 0.
                  END IF
                  IF (bl(i, j) .LT. y37) THEN
                    y18 = y37
                  ELSE
                    y18 = bl(i, j)
                  END IF
                  IF (x19 .GT. y18) THEN
                    bl(i, j) = y18
                  ELSE
                    bl(i, j) = x19
                  END IF
                  pmp_2 = 2.*dq(i, j-1)
                  lac_2 = pmp_2 - 1.5*dq(i, j-2)
                  IF (0. .LT. pmp_2) THEN
                    IF (pmp_2 .LT. lac_2) THEN
                      x20 = lac_2
                    ELSE
                      x20 = pmp_2
                    END IF
                  ELSE IF (0. .LT. lac_2) THEN
                    x20 = lac_2
                  ELSE
                    x20 = 0.
                  END IF
                  IF (0. .GT. pmp_2) THEN
                    IF (pmp_2 .GT. lac_2) THEN
                      y38 = lac_2
                    ELSE
                      y38 = pmp_2
                    END IF
                  ELSE IF (0. .GT. lac_2) THEN
                    y38 = lac_2
                  ELSE
                    y38 = 0.
                  END IF
                  IF (br(i, j) .LT. y38) THEN
                    y19 = y38
                  ELSE
                    y19 = br(i, j)
                  END IF
                  IF (x20 .GT. y19) THEN
                    br(i, j) = y19
                  ELSE
                    br(i, j) = x20
                  END IF
                END IF
              END IF
            END DO
          END DO
        END IF
!--------------
! Fix the edges:
!--------------
        IF (.NOT.nested) THEN
          IF (js .EQ. 1) THEN
            DO i=ifirst,ilast
              br(i, 2) = al(i, 3) - q(i, 2)
              x0l = 0.5*((2.*dya(i, 0)+dya(i, -1))*q(i, 0)-dya(i, 0)*q(i&
&               , -1))/(dya(i, 0)+dya(i, -1))
              x0r = 0.5*((2.*dya(i, 1)+dya(i, 2))*q(i, 1)-dya(i, 1)*q(i&
&               , 2))/(dya(i, 1)+dya(i, 2))
              xt = x0l + x0r
!lmh            xt = 0.5*((2.*dya(i,1)+dya(i,2))*(q(i,0)+q(i,1))   &
!lmh               -dya(i,1)*(q(i,-1)+q(i,2))) / ( dya(i,1)+dya(i,2) )
              bl(i, 1) = xt - q(i, 1)
              br(i, 0) = xt - q(i, 0)
              xt = s14*dm(i, -1) - s11*dq(i, -1) + q(i, 0)
!           xt = min( xt, max(q(i,-1), q(i,0)) )
!           xt = max( xt, min(q(i,-1), q(i,0)) )
              bl(i, 0) = xt - q(i, 0)
              xt = s15*q(i, 1) + s11*q(i, 2) - s14*dm(i, 2)
!           xt = min( xt, max(q(i,1), q(i,2)) )
!           xt = max( xt, min(q(i,1), q(i,2)) )
              br(i, 1) = xt - q(i, 1)
              bl(i, 2) = xt - q(i, 2)
            END DO
!         if ( jord<=9 ) then
            DO j=0,2
              CALL PERT_PPM(ilast - ifirst + 1, q(ifirst, j), bl(ifirst&
&                     , j), br(ifirst, j), 1)
            END DO
          END IF
!         endif
          IF (je + 1 .EQ. npy) THEN
            DO i=ifirst,ilast
              bl(i, npy-2) = al(i, npy-2) - q(i, npy-2)
              x0l = 0.5*((2.*dya(i, npy-1)+dya(i, npy-2))*q(i, npy-1)-&
&               dya(i, npy-1)*q(i, npy-2))/(dya(i, npy-1)+dya(i, npy-2))
              x0r = 0.5*((2.*dya(i, npy)+dya(i, npy+1))*q(i, npy)-dya(i&
&               , npy)*q(i, npy+1))/(dya(i, npy)+dya(i, npy+1))
              xt = x0l + x0r
!lmh            xt = 0.5*((2.*dya(i,npy-1)+dya(i,npy-2))*(q(i,npy-1)+q(i,npy))  &
!lmh               -dya(i,npy-1)*(q(i,npy-2)+q(i,npy+1)))/(dya(i,npy-1)+dya(i,npy-2))
              br(i, npy-1) = xt - q(i, npy-1)
              bl(i, npy) = xt - q(i, npy)
              xt = s11*dq(i, npy) - s14*dm(i, npy+1) + q(i, npy)
!           xt = min( xt, max( q(i,npy), q(i,npy+1)) )
!           xt = max( xt, min( q(i,npy), q(i,npy+1)) )
              br(i, npy) = xt - q(i, npy)
              xt = s15*q(i, npy-1) + s11*q(i, npy-2) + s14*dm(i, npy-2)
!           xt = min( xt, max( q(i,npy-2), q(i,npy-1)) )
!           xt = max( xt, min( q(i,npy-2), q(i,npy-1)) )
              br(i, npy-2) = xt - q(i, npy-2)
              bl(i, npy-1) = xt - q(i, npy-1)
            END DO
!         if ( jord<=9 ) then
            DO j=npy-2,npy
              CALL PERT_PPM(ilast - ifirst + 1, q(ifirst, j), bl(ifirst&
&                     , j), br(ifirst, j), 1)
            END DO
          END IF
        END IF
      ELSE
!         endif
!---------------
! grid_type == 4
!---------------
        DO j=jfirst-1,jlast+2
          DO i=ifirst,ilast
            al(i, j) = 0.5*(q(i, j-1)+q(i, j)) + r3*(dm(i, j-1)-dm(i, j)&
&             )
          END DO
        END DO
        DO j=jfirst-3,jlast+2
          DO i=ifirst,ilast
            dq(i, j) = q(i, j+1) - q(i, j)
          END DO
        END DO
        DO j=jfirst-1,jlast+1
          DO i=ifirst,ilast
            pmp = -(2.*dq(i, j))
            lac = pmp + 1.5*dq(i, j+1)
            IF (0. .LT. pmp) THEN
              IF (pmp .LT. lac) THEN
                x21 = lac
              ELSE
                x21 = pmp
              END IF
            ELSE IF (0. .LT. lac) THEN
              x21 = lac
            ELSE
              x21 = 0.
            END IF
            IF (0. .GT. pmp) THEN
              IF (pmp .GT. lac) THEN
                y39 = lac
              ELSE
                y39 = pmp
              END IF
            ELSE IF (0. .GT. lac) THEN
              y39 = lac
            ELSE
              y39 = 0.
            END IF
            IF (al(i, j) - q(i, j) .LT. y39) THEN
              y20 = y39
            ELSE
              y20 = al(i, j) - q(i, j)
            END IF
            IF (x21 .GT. y20) THEN
              bl(i, j) = y20
            ELSE
              bl(i, j) = x21
            END IF
            pmp = 2.*dq(i, j-1)
            lac = pmp - 1.5*dq(i, j-2)
            IF (0. .LT. pmp) THEN
              IF (pmp .LT. lac) THEN
                x22 = lac
              ELSE
                x22 = pmp
              END IF
            ELSE IF (0. .LT. lac) THEN
              x22 = lac
            ELSE
              x22 = 0.
            END IF
            IF (0. .GT. pmp) THEN
              IF (pmp .GT. lac) THEN
                y40 = lac
              ELSE
                y40 = pmp
              END IF
            ELSE IF (0. .GT. lac) THEN
              y40 = lac
            ELSE
              y40 = 0.
            END IF
            IF (al(i, j+1) - q(i, j) .LT. y40) THEN
              y21 = y40
            ELSE
              y21 = al(i, j+1) - q(i, j)
            END IF
            IF (x22 .GT. y21) THEN
              br(i, j) = y21
            ELSE
              br(i, j) = x22
            END IF
          END DO
        END DO
      END IF
      DO j=jfirst,jlast+1
        DO i=ifirst,ilast
          IF (c(i, j) .GT. 0.) THEN
            flux(i, j) = q(i, j-1) + (1.-c(i, j))*(br(i, j-1)-c(i, j)*(&
&             bl(i, j-1)+br(i, j-1)))
          ELSE
            flux(i, j) = q(i, j) + (1.+c(i, j))*(bl(i, j)+c(i, j)*(bl(i&
&             , j)+br(i, j)))
          END IF
        END DO
      END DO
    ELSE
!-------------------------------
! For positive definite tracers:
!-------------------------------
! jord=11: PPM mono constraint (Lin 2004)
! jord=12: Huynh 2nd constraint (Lin 2004) + positive definite (Lin & Rood 1996)
! jord>12: positive definite only (Lin & Rood 1996)
      DO j=js-2,je+2
        DO i=ifirst,ilast
          xt = 0.25*(q(i, j+1)-q(i, j-1))
          IF (xt .GE. 0.) THEN
            x23 = xt
          ELSE
            x23 = -xt
          END IF
          IF (q(i, j-1) .LT. q(i, j)) THEN
            IF (q(i, j) .LT. q(i, j+1)) THEN
              max10 = q(i, j+1)
            ELSE
              max10 = q(i, j)
            END IF
          ELSE IF (q(i, j-1) .LT. q(i, j+1)) THEN
            max10 = q(i, j+1)
          ELSE
            max10 = q(i, j-1)
          END IF
          y22 = max10 - q(i, j)
          IF (q(i, j-1) .GT. q(i, j)) THEN
            IF (q(i, j) .GT. q(i, j+1)) THEN
              min28 = q(i, j+1)
            ELSE
              min28 = q(i, j)
            END IF
          ELSE IF (q(i, j-1) .GT. q(i, j+1)) THEN
            min28 = q(i, j+1)
          ELSE
            min28 = q(i, j-1)
          END IF
          z8 = q(i, j) - min28
          IF (x23 .GT. y22) THEN
            IF (y22 .GT. z8) THEN
              min14 = z8
            ELSE
              min14 = y22
            END IF
          ELSE IF (x23 .GT. z8) THEN
            min14 = z8
          ELSE
            min14 = x23
          END IF
          dm(i, j) = SIGN(min14, xt)
        END DO
      END DO
      IF (grid_type .LT. 3) THEN
        IF (nested) THEN
          js3 = js - 1
          je3 = je + 1
        ELSE
          IF (3 .LT. js - 1) THEN
            js3 = js - 1
          ELSE
            js3 = 3
          END IF
          IF (npy - 3 .GT. je + 1) THEN
            je3 = je + 1
          ELSE
            je3 = npy - 3
          END IF
        END IF
!      do j=js3,min(npy-2,je+2)
        DO j=js3,je3+1
          DO i=ifirst,ilast
            al(i, j) = 0.5*(q(i, j-1)+q(i, j)) + r3*(dm(i, j-1)-dm(i, j)&
&             )
          END DO
        END DO
        IF (jord .EQ. 11) THEN
          DO j=js3,je3
            DO i=ifirst,ilast
              xt = 2.*dm(i, j)
              IF (xt .GE. 0.) THEN
                x24 = xt
              ELSE
                x24 = -xt
              END IF
              IF (al(i, j) - q(i, j) .GE. 0.) THEN
                y23 = al(i, j) - q(i, j)
              ELSE
                y23 = -(al(i, j)-q(i, j))
              END IF
              IF (x24 .GT. y23) THEN
                min15 = y23
              ELSE
                min15 = x24
              END IF
              bl(i, j) = -SIGN(min15, xt)
              IF (xt .GE. 0.) THEN
                x25 = xt
              ELSE
                x25 = -xt
              END IF
              IF (al(i, j+1) - q(i, j) .GE. 0.) THEN
                y24 = al(i, j+1) - q(i, j)
              ELSE
                y24 = -(al(i, j+1)-q(i, j))
              END IF
              IF (x25 .GT. y24) THEN
                min16 = y24
              ELSE
                min16 = x25
              END IF
              br(i, j) = SIGN(min16, xt)
            END DO
          END DO
        ELSE IF (jord .EQ. 12) THEN
          DO j=js-3,je+2
            DO i=ifirst,ilast
              dq(i, j) = q(i, j+1) - q(i, j)
            END DO
          END DO
          DO j=js3,je3
            DO i=ifirst,ilast
              pmp = -(2.*dq(i, j))
              lac = pmp + 1.5*dq(i, j+1)
              IF (0. .LT. pmp) THEN
                IF (pmp .LT. lac) THEN
                  x26 = lac
                ELSE
                  x26 = pmp
                END IF
              ELSE IF (0. .LT. lac) THEN
                x26 = lac
              ELSE
                x26 = 0.
              END IF
              IF (0. .GT. pmp) THEN
                IF (pmp .GT. lac) THEN
                  y41 = lac
                ELSE
                  y41 = pmp
                END IF
              ELSE IF (0. .GT. lac) THEN
                y41 = lac
              ELSE
                y41 = 0.
              END IF
              IF (al(i, j) - q(i, j) .LT. y41) THEN
                y25 = y41
              ELSE
                y25 = al(i, j) - q(i, j)
              END IF
              IF (x26 .GT. y25) THEN
                bl(i, j) = y25
              ELSE
                bl(i, j) = x26
              END IF
              pmp = 2.*dq(i, j-1)
              lac = pmp - 1.5*dq(i, j-2)
              IF (0. .LT. pmp) THEN
                IF (pmp .LT. lac) THEN
                  x27 = lac
                ELSE
                  x27 = pmp
                END IF
              ELSE IF (0. .LT. lac) THEN
                x27 = lac
              ELSE
                x27 = 0.
              END IF
              IF (0. .GT. pmp) THEN
                IF (pmp .GT. lac) THEN
                  y42 = lac
                ELSE
                  y42 = pmp
                END IF
              ELSE IF (0. .GT. lac) THEN
                y42 = lac
              ELSE
                y42 = 0.
              END IF
              IF (al(i, j+1) - q(i, j) .LT. y42) THEN
                y26 = y42
              ELSE
                y26 = al(i, j+1) - q(i, j)
              END IF
              IF (x27 .GT. y26) THEN
                br(i, j) = y26
              ELSE
                br(i, j) = x27
              END IF
            END DO
          END DO
        ELSE
! jord=13
          DO j=js-3,je+2
            DO i=ifirst,ilast
              dq(i, j) = q(i, j+1) - q(i, j)
            END DO
          END DO
          DO j=js3,je3
            DO i=ifirst,ilast
              IF (dm(i, j-1) .GE. 0.) THEN
                abs2 = dm(i, j-1)
              ELSE
                abs2 = -dm(i, j-1)
              END IF
              IF (dm(i, j) .GE. 0.) THEN
                abs6 = dm(i, j)
              ELSE
                abs6 = -dm(i, j)
              END IF
              IF (dm(i, j+1) .GE. 0.) THEN
                abs9 = dm(i, j+1)
              ELSE
                abs9 = -dm(i, j+1)
              END IF
              IF (abs2 + abs6 + abs9 .LT. near_zero) THEN
                bl(i, j) = 0.
                br(i, j) = 0.
              ELSE
                bl(i, j) = al(i, j) - q(i, j)
                br(i, j) = al(i, j+1) - q(i, j)
                IF (3.*(bl(i, j)+br(i, j)) .GE. 0.) THEN
                  abs3 = 3.*(bl(i, j)+br(i, j))
                ELSE
                  abs3 = -(3.*(bl(i, j)+br(i, j)))
                END IF
                IF (bl(i, j) - br(i, j) .GE. 0.) THEN
                  abs7 = bl(i, j) - br(i, j)
                ELSE
                  abs7 = -(bl(i, j)-br(i, j))
                END IF
                IF (abs3 .GT. abs7) THEN
                  pmp_1 = -(2.*dq(i, j))
                  lac_1 = pmp_1 + 1.5*dq(i, j+1)
                  IF (0. .LT. pmp_1) THEN
                    IF (pmp_1 .LT. lac_1) THEN
                      x28 = lac_1
                    ELSE
                      x28 = pmp_1
                    END IF
                  ELSE IF (0. .LT. lac_1) THEN
                    x28 = lac_1
                  ELSE
                    x28 = 0.
                  END IF
                  IF (0. .GT. pmp_1) THEN
                    IF (pmp_1 .GT. lac_1) THEN
                      y43 = lac_1
                    ELSE
                      y43 = pmp_1
                    END IF
                  ELSE IF (0. .GT. lac_1) THEN
                    y43 = lac_1
                  ELSE
                    y43 = 0.
                  END IF
                  IF (bl(i, j) .LT. y43) THEN
                    y27 = y43
                  ELSE
                    y27 = bl(i, j)
                  END IF
                  IF (x28 .GT. y27) THEN
                    bl(i, j) = y27
                  ELSE
                    bl(i, j) = x28
                  END IF
                  pmp_2 = 2.*dq(i, j-1)
                  lac_2 = pmp_2 - 1.5*dq(i, j-2)
                  IF (0. .LT. pmp_2) THEN
                    IF (pmp_2 .LT. lac_2) THEN
                      x29 = lac_2
                    ELSE
                      x29 = pmp_2
                    END IF
                  ELSE IF (0. .LT. lac_2) THEN
                    x29 = lac_2
                  ELSE
                    x29 = 0.
                  END IF
                  IF (0. .GT. pmp_2) THEN
                    IF (pmp_2 .GT. lac_2) THEN
                      y44 = lac_2
                    ELSE
                      y44 = pmp_2
                    END IF
                  ELSE IF (0. .GT. lac_2) THEN
                    y44 = lac_2
                  ELSE
                    y44 = 0.
                  END IF
                  IF (br(i, j) .LT. y44) THEN
                    y28 = y44
                  ELSE
                    y28 = br(i, j)
                  END IF
                  IF (x29 .GT. y28) THEN
                    br(i, j) = y28
                  ELSE
                    br(i, j) = x29
                  END IF
                END IF
              END IF
            END DO
          END DO
        END IF
        IF (jord .NE. 11) THEN
! Positive definite constraint:
          DO j=js3,je3
            CALL PERT_PPM(ilast - ifirst + 1, q(ifirst, j), bl(ifirst, j&
&                   ), br(ifirst, j), 0)
          END DO
        END IF
!--------------
! Fix the edges:
!--------------
        IF (.NOT.nested) THEN
          IF (js .EQ. 1) THEN
            DO i=ifirst,ilast
              br(i, 2) = al(i, 3) - q(i, 2)
!           xt = t11*(q(i,0)+q(i,1)) + t12*(q(i,-1)+q(i,2))   &
!              + t13*(dm(i,2)-dm(i,-1))
!!!         xt = 0.75*(q(i,0)+q(i,1)) - 0.25*(q(i,-1)+q(i,2))
              x0l = 0.5*((2.*dya(i, 0)+dya(i, -1))*q(i, 0)-dya(i, 0)*q(i&
&               , -1))/(dya(i, 0)+dya(i, -1))
              x0r = 0.5*((2.*dya(i, 1)+dya(i, 2))*q(i, 1)-dya(i, 1)*q(i&
&               , 2))/(dya(i, 1)+dya(i, 2))
              xt = x0l + x0r
              IF (0. .LT. xt) THEN
                xt = xt
              ELSE
                xt = 0.
              END IF
              bl(i, 1) = xt - q(i, 1)
              br(i, 0) = xt - q(i, 0)
              xt = 4./7.*dm(i, -1) + 11./14.*q(i, -1) + 3./14.*q(i, 0)
              IF (0. .LT. xt) THEN
                xt = xt
              ELSE
                xt = 0.
              END IF
              bl(i, 0) = xt - q(i, 0)
              xt = 3./14.*q(i, 1) + 11./14.*q(i, 2) - 4./7.*dm(i, 2)
              IF (0. .LT. xt) THEN
                xt = xt
              ELSE
                xt = 0.
              END IF
              br(i, 1) = xt - q(i, 1)
              bl(i, 2) = xt - q(i, 2)
            END DO
            DO j=0,2
              CALL PERT_PPM(ilast - ifirst + 1, q(ifirst, j), bl(ifirst&
&                     , j), br(ifirst, j), 1)
            END DO
          END IF
          IF (je + 1 .EQ. npy) THEN
            DO i=ifirst,ilast
              bl(i, npy-2) = al(i, npy-2) - q(i, npy-2)
!           xt = t11*(q(i,npy-1)+q(i,npy)) + t12*(q(i,npy-2)+q(i,npy+1))   &
!               + t13*(dm(i,npy+1)-dm(i,npy-2))
!!!         xt = 0.75*(q(i,npy-1)+q(i,npy)) - 0.25*(q(i,npy-2)+q(i,npy+1))
              x0l = 0.5*((2.*dya(i, npy-1)+dya(i, npy-2))*q(i, npy-1)-&
&               dya(i, npy-1)*q(i, npy-2))/(dya(i, npy-1)+dya(i, npy-2))
              x0r = 0.5*((2.*dya(i, npy)+dya(i, npy+1))*q(i, npy)-dya(i&
&               , npy)*q(i, npy+1))/(dya(i, npy)+dya(i, npy+1))
              xt = x0l + x0r
              IF (0. .LT. xt) THEN
                xt = xt
              ELSE
                xt = 0.
              END IF
              br(i, npy-1) = xt - q(i, npy-1)
              bl(i, npy) = xt - q(i, npy)
              xt = 3./14.*q(i, npy) + 11./14.*q(i, npy+1) - 4./7.*dm(i, &
&               npy+1)
              IF (0. .LT. xt) THEN
                xt = xt
              ELSE
                xt = 0.
              END IF
              br(i, npy) = xt - q(i, npy)
              xt = 3./14.*q(i, npy-1) + 11./14.*q(i, npy-2) + 4./7.*dm(i&
&               , npy-2)
              IF (0. .LT. xt) THEN
                xt = xt
              ELSE
                xt = 0.
              END IF
              br(i, npy-2) = xt - q(i, npy-2)
              bl(i, npy-1) = xt - q(i, npy-1)
            END DO
            DO j=npy-2,npy
              CALL PERT_PPM(ilast - ifirst + 1, q(ifirst, j), bl(ifirst&
&                     , j), br(ifirst, j), 1)
            END DO
          END IF
        END IF
      ELSE
        DO j=js-1,je+2
          DO i=ifirst,ilast
            al(i, j) = 0.5*(q(i, j-1)+q(i, j)) + r3*(dm(i, j-1)-dm(i, j)&
&             )
          END DO
        END DO
        IF (jord .EQ. 11) THEN
          DO j=js-1,je+1
            DO i=ifirst,ilast
              xt = 2.*dm(i, j)
              IF (xt .GE. 0.) THEN
                x30 = xt
              ELSE
                x30 = -xt
              END IF
              IF (al(i, j) - q(i, j) .GE. 0.) THEN
                y29 = al(i, j) - q(i, j)
              ELSE
                y29 = -(al(i, j)-q(i, j))
              END IF
              IF (x30 .GT. y29) THEN
                min17 = y29
              ELSE
                min17 = x30
              END IF
              bl(i, j) = -SIGN(min17, xt)
              IF (xt .GE. 0.) THEN
                x31 = xt
              ELSE
                x31 = -xt
              END IF
              IF (al(i, j+1) - q(i, j) .GE. 0.) THEN
                y30 = al(i, j+1) - q(i, j)
              ELSE
                y30 = -(al(i, j+1)-q(i, j))
              END IF
              IF (x31 .GT. y30) THEN
                min18 = y30
              ELSE
                min18 = x31
              END IF
              br(i, j) = SIGN(min18, xt)
            END DO
          END DO
        ELSE IF (jord .EQ. 12) THEN
          DO j=js-3,je+2
            DO i=ifirst,ilast
              dq(i, j) = q(i, j+1) - q(i, j)
            END DO
          END DO
          DO j=js-1,je+1
            DO i=ifirst,ilast
              pmp = -(2.*dq(i, j))
              lac = pmp + 1.5*dq(i, j+1)
              IF (0. .LT. pmp) THEN
                IF (pmp .LT. lac) THEN
                  x32 = lac
                ELSE
                  x32 = pmp
                END IF
              ELSE IF (0. .LT. lac) THEN
                x32 = lac
              ELSE
                x32 = 0.
              END IF
              IF (0. .GT. pmp) THEN
                IF (pmp .GT. lac) THEN
                  y45 = lac
                ELSE
                  y45 = pmp
                END IF
              ELSE IF (0. .GT. lac) THEN
                y45 = lac
              ELSE
                y45 = 0.
              END IF
              IF (al(i, j) - q(i, j) .LT. y45) THEN
                y31 = y45
              ELSE
                y31 = al(i, j) - q(i, j)
              END IF
              IF (x32 .GT. y31) THEN
                bl(i, j) = y31
              ELSE
                bl(i, j) = x32
              END IF
              pmp = 2.*dq(i, j-1)
              lac = pmp - 1.5*dq(i, j-2)
              IF (0. .LT. pmp) THEN
                IF (pmp .LT. lac) THEN
                  x33 = lac
                ELSE
                  x33 = pmp
                END IF
              ELSE IF (0. .LT. lac) THEN
                x33 = lac
              ELSE
                x33 = 0.
              END IF
              IF (0. .GT. pmp) THEN
                IF (pmp .GT. lac) THEN
                  y46 = lac
                ELSE
                  y46 = pmp
                END IF
              ELSE IF (0. .GT. lac) THEN
                y46 = lac
              ELSE
                y46 = 0.
              END IF
              IF (al(i, j+1) - q(i, j) .LT. y46) THEN
                y32 = y46
              ELSE
                y32 = al(i, j+1) - q(i, j)
              END IF
              IF (x33 .GT. y32) THEN
                br(i, j) = y32
              ELSE
                br(i, j) = x33
              END IF
            END DO
          END DO
        ELSE
          DO j=js-1,je+1
            DO i=ifirst,ilast
              bl(i, j) = al(i, j) - q(i, j)
              br(i, j) = al(i, j+1) - q(i, j)
            END DO
          END DO
        END IF
        IF (jord .NE. 11) THEN
! Positive definite constraint:
          DO j=js-1,je+1
            CALL PERT_PPM(ilast - ifirst + 1, q(ifirst, j), bl(ifirst, j&
&                   ), br(ifirst, j), 0)
          END DO
        END IF
      END IF
      DO j=js,je+1
        DO i=ifirst,ilast
          IF (c(i, j) .GT. 0.) THEN
            flux(i, j) = q(i, j-1) + (1.-c(i, j))*(br(i, j-1)-c(i, j)*(&
&             bl(i, j-1)+br(i, j-1)))
          ELSE
            flux(i, j) = q(i, j) + (1.+c(i, j))*(bl(i, j)+c(i, j)*(bl(i&
&             , j)+br(i, j)))
          END IF
        END DO
      END DO
    END IF
  END SUBROUTINE FYPPM
  SUBROUTINE MP_GHOST_EW(im, jm, km, nq, ifirst, ilast, jfirst, jlast, &
&   kfirst, klast, ng_w, ng_e, ng_s, ng_n, q_ghst, q)
    IMPLICIT NONE
!
! !INPUT PARAMETERS:
    INTEGER, INTENT(IN) :: im, jm, km, nq
    INTEGER, INTENT(IN) :: ifirst, ilast
    INTEGER, INTENT(IN) :: jfirst, jlast
    INTEGER, INTENT(IN) :: kfirst, klast
! eastern  zones to ghost
    INTEGER, INTENT(IN) :: ng_e
! western  zones to ghost
    INTEGER, INTENT(IN) :: ng_w
! southern zones to ghost
    INTEGER, INTENT(IN) :: ng_s
! northern zones to ghost
    INTEGER, INTENT(IN) :: ng_n
    REAL(fvprc), INTENT(INOUT) :: q_ghst(ifirst-ng_w:ilast+ng_e, jfirst-&
&   ng_s:jlast+ng_n, kfirst:klast, nq)
    REAL(fvprc), OPTIONAL, INTENT(IN) :: q(ifirst:ilast, jfirst:jlast, &
&   kfirst:klast, nq)
!
! !DESCRIPTION:
!
!     Ghost 4d east/west 
!
! !REVISION HISTORY:
!    2005.08.22   Putman
!
!EOP
!------------------------------------------------------------------------------
!BOC
    INTEGER :: i, j, k, n
    INTRINSIC PRESENT
    IF (PRESENT(q)) q_ghst(ifirst:ilast, jfirst:jlast, kfirst:klast, 1:&
&     nq) = q(ifirst:ilast, jfirst:jlast, kfirst:klast, 1:nq)
!      Assume Periodicity in X-dir and not overlapping
    DO n=1,nq
      DO k=kfirst,klast
        DO j=jfirst-ng_s,jlast+ng_n
          DO i=1,ng_w
            q_ghst(ifirst-i, j, k, n) = q_ghst(ilast-i+1, j, k, n)
          END DO
          DO i=1,ng_e
            q_ghst(ilast+i, j, k, n) = q_ghst(ifirst+i-1, j, k, n)
          END DO
        END DO
      END DO
    END DO
  END SUBROUTINE MP_GHOST_EW
!  Differentiation of pert_ppm in forward (tangent) mode (with options r8):
!   variations   of useful results: al ar
!   with respect to varying inputs: al ar
  SUBROUTINE PERT_PPM_TLM(im, a0, al, al_tl, ar, ar_tl, iv)
    IMPLICIT NONE
    INTEGER, INTENT(IN) :: im
    INTEGER, INTENT(IN) :: iv
    REAL(fvprc), INTENT(IN) :: a0(im)
    REAL(fvprc), INTENT(INOUT) :: al(im), ar(im)
    REAL(fvprc), INTENT(INOUT) :: al_tl(im), ar_tl(im)
! Local:
    REAL(fvprc) :: a4, da1, da2, a6da, fmin
    INTEGER :: i
    REAL(fvprc), PARAMETER :: r12=1./12.
    INTRINSIC ABS
    REAL(fvprc) :: abs0
!-----------------------------------
! Optimized PPM in perturbation form:
!-----------------------------------
    IF (iv .EQ. 0) THEN
! Positive definite constraint
      DO i=1,im
        IF (a0(i) .LE. 0.) THEN
          al_tl(i) = 0.0_FVPRC
          al(i) = 0.
          ar_tl(i) = 0.0_FVPRC
          ar(i) = 0.
        ELSE
          a4 = -(3.*(ar(i)+al(i)))
          da1 = ar(i) - al(i)
          IF (da1 .GE. 0.) THEN
            abs0 = da1
          ELSE
            abs0 = -da1
          END IF
          IF (abs0 .LT. -a4) THEN
            fmin = a0(i) + 0.25/a4*da1**2 + a4*r12
            IF (fmin .LT. 0.) THEN
              IF (ar(i) .GT. 0. .AND. al(i) .GT. 0.) THEN
                ar_tl(i) = 0.0_FVPRC
                ar(i) = 0.
                al_tl(i) = 0.0_FVPRC
                al(i) = 0.
              ELSE IF (da1 .GT. 0.) THEN
                ar_tl(i) = -(2.*al_tl(i))
                ar(i) = -(2.*al(i))
              ELSE
                al_tl(i) = -(2.*ar_tl(i))
                al(i) = -(2.*ar(i))
              END IF
            END IF
          END IF
        END IF
      END DO
    ELSE
! Standard PPM constraint
      DO i=1,im
        IF (al(i)*ar(i) .LT. 0.) THEN
          da1 = al(i) - ar(i)
          da2 = da1**2
          a6da = 3.*(al(i)+ar(i))*da1
          IF (a6da .LT. -da2) THEN
            ar_tl(i) = -(2.*al_tl(i))
            ar(i) = -(2.*al(i))
          ELSE IF (a6da .GT. da2) THEN
            al_tl(i) = -(2.*ar_tl(i))
            al(i) = -(2.*ar(i))
          END IF
        ELSE
! effect of dm=0 included here
          al_tl(i) = 0.0_FVPRC
          al(i) = 0.
          ar_tl(i) = 0.0_FVPRC
          ar(i) = 0.
        END IF
      END DO
    END IF
  END SUBROUTINE PERT_PPM_TLM
  SUBROUTINE PERT_PPM(im, a0, al, ar, iv)
    IMPLICIT NONE
    INTEGER, INTENT(IN) :: im
    INTEGER, INTENT(IN) :: iv
    REAL(fvprc), INTENT(IN) :: a0(im)
    REAL(fvprc), INTENT(INOUT) :: al(im), ar(im)
! Local:
    REAL(fvprc) :: a4, da1, da2, a6da, fmin
    INTEGER :: i
    REAL(fvprc), PARAMETER :: r12=1./12.
    INTRINSIC ABS
    REAL(fvprc) :: abs0
!-----------------------------------
! Optimized PPM in perturbation form:
!-----------------------------------
    IF (iv .EQ. 0) THEN
! Positive definite constraint
      DO i=1,im
        IF (a0(i) .LE. 0.) THEN
          al(i) = 0.
          ar(i) = 0.
        ELSE
          a4 = -(3.*(ar(i)+al(i)))
          da1 = ar(i) - al(i)
          IF (da1 .GE. 0.) THEN
            abs0 = da1
          ELSE
            abs0 = -da1
          END IF
          IF (abs0 .LT. -a4) THEN
            fmin = a0(i) + 0.25/a4*da1**2 + a4*r12
            IF (fmin .LT. 0.) THEN
              IF (ar(i) .GT. 0. .AND. al(i) .GT. 0.) THEN
                ar(i) = 0.
                al(i) = 0.
              ELSE IF (da1 .GT. 0.) THEN
                ar(i) = -(2.*al(i))
              ELSE
                al(i) = -(2.*ar(i))
              END IF
            END IF
          END IF
        END IF
      END DO
    ELSE
! Standard PPM constraint
      DO i=1,im
        IF (al(i)*ar(i) .LT. 0.) THEN
          da1 = al(i) - ar(i)
          da2 = da1**2
          a6da = 3.*(al(i)+ar(i))*da1
          IF (a6da .LT. -da2) THEN
            ar(i) = -(2.*al(i))
          ELSE IF (a6da .GT. da2) THEN
            al(i) = -(2.*ar(i))
          END IF
        ELSE
! effect of dm=0 included here
          al(i) = 0.
          ar(i) = 0.
        END IF
      END DO
    END IF
  END SUBROUTINE PERT_PPM
  SUBROUTINE DELN_FLUX(nord, npx, npy, damp, q, fx, fy, gridstruct, bd, &
&   mass)
    IMPLICIT NONE
! Del-n damping for the cell-mean values (A grid)
!------------------
! nord = 0:   del-2
! nord = 1:   del-4
! nord = 2:   del-6
! nord = 3:   del-8 --> requires more ghosting than current
!------------------
    TYPE(FV_GRID_BOUNDS_TYPE), INTENT(IN) :: bd
! del-n
    INTEGER, INTENT(IN) :: nord
    INTEGER, INTENT(IN) :: npx, npy
    REAL(fvprc), INTENT(IN) :: damp
! q ghosted on input
    REAL(fvprc), INTENT(IN) :: q(bd%is-ng:bd%ie+ng, bd%js-ng:bd%je+ng)
    TYPE(FV_GRID_TYPE), INTENT(IN), TARGET :: gridstruct
! q ghosted on input
    REAL(fvprc), OPTIONAL, INTENT(IN) :: mass(bd%isd:bd%ied, bd%jsd:bd%&
&   jed)
! diffusive fluxes:
    REAL(fvprc), INTENT(INOUT) :: fx(bd%is:bd%ie+1, bd%js:bd%je), fy(bd%&
&   is:bd%ie, bd%js:bd%je+1)
! local:
    REAL(fvprc) :: fx2(bd%isd:bd%ied+1, bd%jsd:bd%jed), fy2(bd%isd:bd%&
&   ied, bd%jsd:bd%jed+1)
    REAL(fvprc) :: d2(bd%isd:bd%ied, bd%jsd:bd%jed)
    REAL(fvprc) :: damp2
    INTEGER :: i, j, n, nt, i1, i2, j1, j2
    INTRINSIC PRESENT
!   real(FVPRC), pointer, dimension(:,:)   :: rarea, dx, dy, rdxc, rdyc
!   real(FVPRC), pointer, dimension(:,:,:) :: sin_sg
!   rarea    => gridstruct%rarea  
!   dx       => gridstruct%dx     
!   dy       => gridstruct%dy     
!   rdxc     => gridstruct%rdxc   
!   rdyc     => gridstruct%rdyc   
!   sin_sg   => gridstruct%sin_sg 
    i1 = is - 1 - nord
    i2 = ie + 1 + nord
    j1 = js - 1 - nord
    j2 = je + 1 + nord
    IF (.NOT.PRESENT(mass)) THEN
      DO j=j1,j2
        DO i=i1,i2
          d2(i, j) = damp*q(i, j)
        END DO
      END DO
    ELSE
      DO j=j1,j2
        DO i=i1,i2
          d2(i, j) = q(i, j)
        END DO
      END DO
    END IF
    IF (nord .GT. 0) CALL COPY_CORNERS(d2, npx, npy, 1, gridstruct%&
&                                nested, bd, gridstruct%sw_corner, &
&                                gridstruct%se_corner, gridstruct%&
&                                nw_corner, gridstruct%ne_corner)
    DO j=js-nord,je+nord
      DO i=is-nord,ie+nord+1
!        fx2(i,j) = gridstruct%dy(i,j)*sina_u(i,j)*(d2(i-1,j)-d2(i,j))*gridstruct%rdxc(i,j)
        fx2(i, j) = 0.5*(gridstruct%sin_sg(i-1, j, 3)+gridstruct%sin_sg(&
&         i, j, 1))*gridstruct%dy(i, j)*(d2(i-1, j)-d2(i, j))*gridstruct&
&         %rdxc(i, j)
      END DO
    END DO
    IF (nord .GT. 0) CALL COPY_CORNERS(d2, npx, npy, 2, gridstruct%&
&                                nested, bd, gridstruct%sw_corner, &
&                                gridstruct%se_corner, gridstruct%&
&                                nw_corner, gridstruct%ne_corner)
    DO j=js-nord,je+nord+1
      DO i=is-nord,ie+nord
!           fy2(i,j) = gridstruct%dx(i,j)*sina_v(i,j)*(d2(i,j-1)-d2(i,j))*gridstruct%rdyc(i,j)
        fy2(i, j) = 0.5*(gridstruct%sin_sg(i, j-1, 4)+gridstruct%sin_sg(&
&         i, j, 2))*gridstruct%dx(i, j)*(d2(i, j-1)-d2(i, j))*gridstruct&
&         %rdyc(i, j)
      END DO
    END DO
    IF (nord .GT. 0) THEN
!----------
! high-order
!----------
      DO n=1,nord
        nt = nord - n
        DO j=js-nt-1,je+nt+1
          DO i=is-nt-1,ie+nt+1
            d2(i, j) = (fx2(i, j)-fx2(i+1, j)+fy2(i, j)-fy2(i, j+1))*&
&             gridstruct%rarea(i, j)
          END DO
        END DO
        CALL COPY_CORNERS(d2, npx, npy, 1, gridstruct%nested, bd, &
&                   gridstruct%sw_corner, gridstruct%se_corner, &
&                   gridstruct%nw_corner, gridstruct%ne_corner)
        DO j=js-nt,je+nt
          DO i=is-nt,ie+nt+1
            fx2(i, j) = 0.5*(gridstruct%sin_sg(i-1, j, 3)+gridstruct%&
&             sin_sg(i, j, 1))*gridstruct%dy(i, j)*(d2(i, j)-d2(i-1, j))&
&             *gridstruct%rdxc(i, j)
          END DO
        END DO
        CALL COPY_CORNERS(d2, npx, npy, 2, gridstruct%nested, bd, &
&                   gridstruct%sw_corner, gridstruct%se_corner, &
&                   gridstruct%nw_corner, gridstruct%ne_corner)
        DO j=js-nt,je+nt+1
          DO i=is-nt,ie+nt
            fy2(i, j) = gridstruct%dx(i, j)*(d2(i, j)-d2(i, j-1))*&
&             gridstruct%rdyc(i, j)*0.5*(gridstruct%sin_sg(i, j-1, 4)+&
&             gridstruct%sin_sg(i, j, 2))
          END DO
        END DO
      END DO
    END IF
!---------------------------------------------
! Add the diffusive fluxes to the flux arrays:
!---------------------------------------------
    IF (PRESENT(mass)) THEN
! Apply mass weighting to diffusive fluxes:
      damp2 = 0.5*damp
      DO j=js,je
        DO i=is,ie+1
          fx(i, j) = fx(i, j) + damp2*(mass(i-1, j)+mass(i, j))*fx2(i, j&
&           )
        END DO
      END DO
      DO j=js,je+1
        DO i=is,ie
          fy(i, j) = fy(i, j) + damp2*(mass(i, j-1)+mass(i, j))*fy2(i, j&
&           )
        END DO
      END DO
    ELSE
      DO j=js,je
        DO i=is,ie+1
          fx(i, j) = fx(i, j) + fx2(i, j)
        END DO
      END DO
      DO j=js,je+1
        DO i=is,ie
          fy(i, j) = fy(i, j) + fy2(i, j)
        END DO
      END DO
    END IF
  END SUBROUTINE DELN_FLUX
!Weird arguments are because this routine is called in a lot of
!places outside of tp_core, sometimes very deeply nested in the call tree.
  SUBROUTINE COPY_CORNERS(q, npx, npy, dir, nested, bd, sw_corner, &
&   se_corner, nw_corner, ne_corner)
    IMPLICIT NONE
    TYPE(FV_GRID_BOUNDS_TYPE), INTENT(IN) :: bd
    INTEGER, INTENT(IN) :: npx, npy, dir
    REAL(fvprc), INTENT(INOUT) :: q(bd%isd:bd%ied, bd%jsd:bd%jed)
    LOGICAL, INTENT(IN) :: nested, sw_corner, se_corner, nw_corner, &
&   ne_corner
    INTEGER :: i, j
    IF (nested) THEN
      RETURN
    ELSE IF (dir .EQ. 1) THEN
! XDir:
      IF (sw_corner) THEN
        DO j=1-ng,0
          DO i=1-ng,0
            q(i, j) = q(j, 1-i)
          END DO
        END DO
      END IF
      IF (se_corner) THEN
        DO j=1-ng,0
          DO i=npx,npx+ng-1
            q(i, j) = q(npy-j, i-npx+1)
          END DO
        END DO
      END IF
      IF (ne_corner) THEN
        DO j=npy,npy+ng-1
          DO i=npx,npx+ng-1
            q(i, j) = q(j, 2*npx-1-i)
          END DO
        END DO
      END IF
      IF (nw_corner) THEN
        DO j=npy,npy+ng-1
          DO i=1-ng,0
            q(i, j) = q(npy-j, i-1+npx)
          END DO
        END DO
      END IF
    ELSE IF (dir .EQ. 2) THEN
! YDir:
      IF (sw_corner) THEN
        DO j=1-ng,0
          DO i=1-ng,0
            q(i, j) = q(1-j, i)
          END DO
        END DO
      END IF
      IF (se_corner) THEN
        DO j=1-ng,0
          DO i=npx,npx+ng-1
            q(i, j) = q(npy+j-1, npx-i)
          END DO
        END DO
      END IF
      IF (ne_corner) THEN
        DO j=npy,npy+ng-1
          DO i=npx,npx+ng-1
            q(i, j) = q(2*npy-1-j, i)
          END DO
        END DO
      END IF
      IF (nw_corner) THEN
        DO j=npy,npy+ng-1
          DO i=1-ng,0
            q(i, j) = q(j+1-npx, npy-i)
          END DO
        END DO
      END IF
    END IF
  END SUBROUTINE COPY_CORNERS
!  Differentiation of fv_tp_2d in forward (tangent) mode (with options r8):
!   variations   of useful results: q fx fy
!   with respect to varying inputs: xfx q mass mfx mfy ra_x ra_y
!                yfx fx fy crx cry
  SUBROUTINE FV_TP_2D_TLM(q, q_tl, crx, crx_tl, cry, cry_tl, npx, npy&
&   , hord, fx, fx_tl, fy, fy_tl, xfx, xfx_tl, yfx, yfx_tl, gridstruct, &
&   bd, ra_x, ra_x_tl, ra_y, ra_y_tl, mfx, mfx_tl, mfy, mfy_tl, mass, &
&   mass_tl, nord, damp_c)
    IMPLICIT NONE
    TYPE(FV_GRID_BOUNDS_TYPE), INTENT(IN) :: bd
    INTEGER, INTENT(IN) :: npx, npy
    INTEGER, INTENT(IN) :: hord
!
    REAL(fvprc), INTENT(IN) :: crx(bd%is:bd%ie+1, bd%jsd:bd%jed)
    REAL(fvprc), INTENT(IN) :: crx_tl(bd%is:bd%ie+1, bd%jsd:bd%jed)
!
    REAL(fvprc), INTENT(IN) :: xfx(bd%is:bd%ie+1, bd%jsd:bd%jed)
    REAL(fvprc), INTENT(IN) :: xfx_tl(bd%is:bd%ie+1, bd%jsd:bd%jed)
!
    REAL(fvprc), INTENT(IN) :: cry(bd%isd:bd%ied, bd%js:bd%je+1)
    REAL(fvprc), INTENT(IN) :: cry_tl(bd%isd:bd%ied, bd%js:bd%je+1)
!
    REAL(fvprc), INTENT(IN) :: yfx(bd%isd:bd%ied, bd%js:bd%je+1)
    REAL(fvprc), INTENT(IN) :: yfx_tl(bd%isd:bd%ied, bd%js:bd%je+1)
    REAL(fvprc), INTENT(IN) :: ra_x(bd%is:bd%ie, bd%jsd:bd%jed)
    REAL(fvprc), INTENT(IN) :: ra_x_tl(bd%is:bd%ie, bd%jsd:bd%jed)
    REAL(fvprc), INTENT(IN) :: ra_y(bd%isd:bd%ied, bd%js:bd%je)
    REAL(fvprc), INTENT(IN) :: ra_y_tl(bd%isd:bd%ied, bd%js:bd%je)
! transported scalar
    REAL(fvprc), INTENT(INOUT) :: q(bd%isd:bd%ied, bd%jsd:bd%jed)
    REAL(fvprc), INTENT(INOUT) :: q_tl(bd%isd:bd%ied, bd%jsd:bd%jed)
! Flux in x ( E )
    REAL(fvprc), INTENT(OUT) :: fx(bd%is:bd%ie+1, bd%js:bd%je)
    REAL(fvprc), INTENT(OUT) :: fx_tl(bd%is:bd%ie+1, bd%js:bd%je)
! Flux in y ( N )
    REAL(fvprc), INTENT(OUT) :: fy(bd%is:bd%ie, bd%js:bd%je+1)
    REAL(fvprc), INTENT(OUT) :: fy_tl(bd%is:bd%ie, bd%js:bd%je+1)
    TYPE(FV_GRID_TYPE), INTENT(IN), TARGET :: gridstruct
! optional Arguments:
! Mass Flux X-Dir
    REAL(fvprc), OPTIONAL, INTENT(IN) :: mfx(bd%is:bd%ie+1, bd%js:bd%je)
    REAL(fvprc), OPTIONAL, INTENT(IN) :: mfx_tl(bd%is:bd%ie+1, bd%js:bd%&
&   je)
! Mass Flux Y-Dir
    REAL(fvprc), OPTIONAL, INTENT(IN) :: mfy(bd%is:bd%ie, bd%js:bd%je+1)
    REAL(fvprc), OPTIONAL, INTENT(IN) :: mfy_tl(bd%is:bd%ie, bd%js:bd%je&
&   +1)
    REAL(fvprc), OPTIONAL, INTENT(IN) :: mass(bd%isd:bd%ied, bd%jsd:bd%&
&   jed)
    REAL(fvprc), OPTIONAL, INTENT(IN) :: mass_tl(bd%isd:bd%ied, bd%jsd:&
&   bd%jed)
    REAL(fvprc), OPTIONAL, INTENT(IN) :: damp_c
    INTEGER, OPTIONAL, INTENT(IN) :: nord
! Local:
    INTEGER :: ord_ou, ord_in
    REAL(fvprc) :: q_i(bd%isd:bd%ied, bd%js:bd%je)
    REAL(fvprc) :: q_i_tl(bd%isd:bd%ied, bd%js:bd%je)
    REAL(fvprc) :: q_j(bd%is:bd%ie, bd%jsd:bd%jed)
    REAL(fvprc) :: q_j_tl(bd%is:bd%ie, bd%jsd:bd%jed)
    REAL(fvprc) :: fx2(bd%is:bd%ie+1, bd%jsd:bd%jed)
    REAL(fvprc) :: fx2_tl(bd%is:bd%ie+1, bd%jsd:bd%jed)
    REAL(fvprc) :: fy2(bd%isd:bd%ied, bd%js:bd%je+1)
    REAL(fvprc) :: fy2_tl(bd%isd:bd%ied, bd%js:bd%je+1)
    REAL(fvprc) :: fyy(bd%isd:bd%ied, bd%js:bd%je+1)
    REAL(fvprc) :: fyy_tl(bd%isd:bd%ied, bd%js:bd%je+1)
    REAL(fvprc) :: fx1(bd%is:bd%ie+1)
    REAL(fvprc) :: fx1_tl(bd%is:bd%ie+1)
    REAL(fvprc) :: damp
    INTEGER :: i, j
    INTRINSIC PRESENT
    REAL :: pwx1
    INTEGER :: pwy1
!   real(FVPRC), pointer, dimension(:,:) :: area, rarea
!! Initalize pointers
!   area    => gridstruct%area  
!   rarea   => gridstruct%rarea 
    ord_in = hord
    ord_ou = hord
    IF (.NOT.gridstruct%nested) CALL COPY_CORNERS_TLM(q, q_tl, npx, &
&                                                  npy, 2, gridstruct%&
&                                                  nested, bd, &
&                                                  gridstruct%sw_corner&
&                                                  , gridstruct%&
&                                                  se_corner, gridstruct&
&                                                  %nw_corner, &
&                                                  gridstruct%ne_corner)
    IF (ord_in .LT. 0) THEN
      fy2_tl = 0.0_FVPRC
      CALL YPPM0_TLM(fy2, fy2_tl, q, q_tl, cry, cry_tl, ord_in, bd%&
&                 isd, bd%ied, bd%js, bd%je, npx, npy, bd, gridstruct%&
&                 dya, gridstruct%nested, gridstruct%grid_type)
      fyy_tl = 0.0_FVPRC
    ELSE
      fy2_tl = 0.0_FVPRC
      CALL YTP_TLM(fy2, fy2_tl, q, q_tl, cry, cry_tl, ord_in, bd%isd&
&               , bd%ied, bd%js, bd%je, npx, npy, bd, gridstruct%dya, &
&               gridstruct%nested, gridstruct%grid_type)
      fyy_tl = 0.0_FVPRC
    END IF
    DO j=bd%js,bd%je+1
      DO i=bd%isd,bd%ied
        fyy_tl(i, j) = yfx_tl(i, j)*fy2(i, j) + yfx(i, j)*fy2_tl(i, j)
        fyy(i, j) = yfx(i, j)*fy2(i, j)
      END DO
    END DO
    q_i_tl = 0.0_FVPRC
    DO j=bd%js,bd%je
      DO i=bd%isd,bd%ied
        q_i_tl(i, j) = ((gridstruct%area(i, j)*q_tl(i, j)+fyy_tl(i, j)-&
&         fyy_tl(i, j+1))*ra_y(i, j)-(q(i, j)*gridstruct%area(i, j)+fyy(&
&         i, j)-fyy(i, j+1))*ra_y_tl(i, j))/ra_y(i, j)**2
        q_i(i, j) = (q(i, j)*gridstruct%area(i, j)+fyy(i, j)-fyy(i, j+1)&
&         )/ra_y(i, j)
      END DO
    END DO
    IF (ord_ou .LT. 0) THEN
      CALL XPPM0_TLM(fx, fx_tl, q_i, q_i_tl, crx(bd%is:bd%ie+1, bd%js&
&                 :bd%je), crx_tl(bd%is:bd%ie+1, bd%js:bd%je), ord_ou, &
&                 bd%is, bd%ie, bd%js, bd%je, npx, npy, bd, gridstruct%&
&                 dxa, gridstruct%nested, gridstruct%grid_type)
    ELSE
      CALL XTP_TLM(fx, fx_tl, q_i, q_i_tl, crx(bd%is:bd%ie+1, bd%js:&
&               bd%je), crx_tl(bd%is:bd%ie+1, bd%js:bd%je), ord_ou, bd%&
&               is, bd%ie, bd%js, bd%je, npx, npy, bd, gridstruct%dxa, &
&               gridstruct%nested, gridstruct%grid_type)
    END IF
    IF (.NOT.gridstruct%nested) CALL COPY_CORNERS_TLM(q, q_tl, npx, &
&                                                  npy, 1, gridstruct%&
&                                                  nested, bd, &
&                                                  gridstruct%sw_corner&
&                                                  , gridstruct%&
&                                                  se_corner, gridstruct&
&                                                  %nw_corner, &
&                                                  gridstruct%ne_corner)
    IF (ord_in .LT. 0) THEN
      fx2_tl = 0.0_FVPRC
      CALL XPPM0_TLM(fx2, fx2_tl, q, q_tl, crx, crx_tl, ord_in, bd%is&
&                 , bd%ie, bd%jsd, bd%jed, npx, npy, bd, gridstruct%dxa&
&                 , gridstruct%nested, gridstruct%grid_type)
      q_j_tl = 0.0_FVPRC
      fx1_tl = 0.0_FVPRC
    ELSE
      fx2_tl = 0.0_FVPRC
      CALL XTP_TLM(fx2, fx2_tl, q, q_tl, crx, crx_tl, ord_in, bd%is, &
&               bd%ie, bd%jsd, bd%jed, npx, npy, bd, gridstruct%dxa, &
&               gridstruct%nested, gridstruct%grid_type)
      q_j_tl = 0.0_FVPRC
      fx1_tl = 0.0_FVPRC
    END IF
    DO j=bd%jsd,bd%jed
      DO i=bd%is,bd%ie+1
        fx1_tl(i) = xfx_tl(i, j)*fx2(i, j) + xfx(i, j)*fx2_tl(i, j)
        fx1(i) = xfx(i, j)*fx2(i, j)
      END DO
      DO i=bd%is,bd%ie
        q_j_tl(i, j) = ((gridstruct%area(i, j)*q_tl(i, j)+fx1_tl(i)-&
&         fx1_tl(i+1))*ra_x(i, j)-(q(i, j)*gridstruct%area(i, j)+fx1(i)-&
&         fx1(i+1))*ra_x_tl(i, j))/ra_x(i, j)**2
        q_j(i, j) = (q(i, j)*gridstruct%area(i, j)+fx1(i)-fx1(i+1))/ra_x&
&         (i, j)
      END DO
    END DO
    IF (ord_ou .LT. 0) THEN
      CALL YPPM0_TLM(fy, fy_tl, q_j, q_j_tl, cry, cry_tl, ord_ou, bd%&
&                 is, bd%ie, bd%js, bd%je, npx, npy, bd, gridstruct%dya&
&                 , gridstruct%nested, gridstruct%grid_type)
    ELSE
      CALL YTP_TLM(fy, fy_tl, q_j, q_j_tl, cry, cry_tl, ord_ou, bd%is&
&               , bd%ie, bd%js, bd%je, npx, npy, bd, gridstruct%dya, &
&               gridstruct%nested, gridstruct%grid_type)
    END IF
!----------------
! Flux averaging:
!----------------
    IF (PRESENT(mfx) .AND. PRESENT(mfy)) THEN
!---------------------------------
! For transport of pt and tracers
!---------------------------------
      DO j=bd%js,bd%je
        DO i=bd%is,bd%ie+1
          fx_tl(i, j) = 0.5*((fx_tl(i, j)+fx2_tl(i, j))*mfx(i, j)+(fx(i&
&           , j)+fx2(i, j))*mfx_tl(i, j))
          fx(i, j) = 0.5*(fx(i, j)+fx2(i, j))*mfx(i, j)
        END DO
      END DO
      DO j=bd%js,bd%je+1
        DO i=bd%is,bd%ie
          fy_tl(i, j) = 0.5*((fy_tl(i, j)+fy2_tl(i, j))*mfy(i, j)+(fy(i&
&           , j)+fy2(i, j))*mfy_tl(i, j))
          fy(i, j) = 0.5*(fy(i, j)+fy2(i, j))*mfy(i, j)
        END DO
      END DO
      IF (PRESENT(nord) .AND. PRESENT(damp_c) .AND. PRESENT(mass)) THEN
        IF (damp_c .GT. 1.e-4) THEN
          pwx1 = damp_c*gridstruct%da_min
          pwy1 = nord + 1
          damp = pwx1**pwy1
          CALL DELN_FLUX_TLM(nord, npx, npy, damp, q, q_tl, fx, fx_tl&
&                         , fy, fy_tl, gridstruct, bd, mass, mass_tl)
        END IF
      END IF
    ELSE
!---------------------------------
! For transport of delp, vorticity
!---------------------------------
      DO j=bd%js,bd%je
        DO i=bd%is,bd%ie+1
          fx_tl(i, j) = 0.5*((fx_tl(i, j)+fx2_tl(i, j))*xfx(i, j)+(fx(i&
&           , j)+fx2(i, j))*xfx_tl(i, j))
          fx(i, j) = 0.5*(fx(i, j)+fx2(i, j))*xfx(i, j)
        END DO
      END DO
      DO j=bd%js,bd%je+1
        DO i=bd%is,bd%ie
          fy_tl(i, j) = 0.5*((fy_tl(i, j)+fy2_tl(i, j))*yfx(i, j)+(fy(i&
&           , j)+fy2(i, j))*yfx_tl(i, j))
          fy(i, j) = 0.5*(fy(i, j)+fy2(i, j))*yfx(i, j)
        END DO
      END DO
      IF (PRESENT(nord) .AND. PRESENT(damp_c)) THEN
        IF (damp_c .GT. 1.e-4) THEN
          pwx1 = damp_c*gridstruct%da_min
          pwy1 = nord + 1
          damp = pwx1**pwy1
          CALL DELN_FLUX_TLM(nord, npx, npy, damp, q, q_tl, fx, fx_tl&
&                         , fy, fy_tl, gridstruct, bd)
        END IF
      END IF
    END IF
  END SUBROUTINE FV_TP_2D_TLM
!  Differentiation of xtp in forward (tangent) mode (with options r8):
!   variations   of useful results: fx
!   with respect to varying inputs: q fx c
  SUBROUTINE XTP_TLM(fx, fx_tl, q, q_tl, c, c_tl, iord, ifirst, ilast&
&   , jfirst, jlast, npx, npy, bd, dxa, nested, grid_type)
    IMPLICIT NONE
    TYPE(FV_GRID_BOUNDS_TYPE), INTENT(IN) :: bd
!  X-Dir strip
    INTEGER, INTENT(IN) :: ifirst, ilast
!  Y-Dir strip
    INTEGER, INTENT(IN) :: jfirst, jlast
    INTEGER, INTENT(IN) :: npx, npy
    INTEGER, INTENT(IN) :: iord
! Courant numbers
    REAL(fvprc), INTENT(IN) :: c(bd%is:bd%ie+1, jfirst:jlast)
    REAL(fvprc), INTENT(IN) :: c_tl(bd%is:bd%ie+1, jfirst:jlast)
    REAL(fvprc), INTENT(IN) :: q(bd%isd:bd%ied, jfirst:jlast)
    REAL(fvprc), INTENT(IN) :: q_tl(bd%isd:bd%ied, jfirst:jlast)
    REAL(fvprc), INTENT(OUT) :: fx(ifirst:ilast+1, jfirst:jlast)
    REAL(fvprc), INTENT(OUT) :: fx_tl(ifirst:ilast+1, jfirst:jlast)
    REAL(fvprc), INTENT(IN) :: dxa(bd%isd:bd%ied, bd%jsd:bd%jed)
    LOGICAL, INTENT(IN) :: nested
    INTEGER, INTENT(IN) :: grid_type
! Local:
    REAL(fvprc) :: dm(bd%is-2:bd%ie+2)
    REAL(fvprc) :: x0l, x0r, x1
    INTEGER :: i, j
    IF (iord .EQ. 1) THEN
      DO j=jfirst,jlast
        DO i=ifirst,ilast+1
          IF (c(i, j) .GT. 0.) THEN
            fx_tl(i, j) = q_tl(i-1, j)
            fx(i, j) = q(i-1, j)
          ELSE
            fx_tl(i, j) = q_tl(i, j)
            fx(i, j) = q(i, j)
          END IF
        END DO
      END DO
    ELSE IF (iord .EQ. 333) THEN
!Advection using third order scheme
      DO j=jfirst,jlast
        DO i=ifirst,ilast+1
          IF (c(i, j) .GT. 0.) THEN
            fx_tl(i, j) = (2.0*q_tl(i, j)+5.0*q_tl(i-1, j)-q_tl(i-2, j))&
&             /6.0 - 0.5*(c_tl(i, j)*(q(i, j)-q(i-1, j))+c(i, j)*(q_tl(i&
&             , j)-q_tl(i-1, j))) + (c_tl(i, j)*c(i, j)+c(i, j)*c_tl(i, &
&             j))*(q(i, j)-2.0*q(i-1, j)+q(i-2, j))/6.0 + c(i, j)**2*(&
&             q_tl(i, j)-2.0*q_tl(i-1, j)+q_tl(i-2, j))/6.0
            fx(i, j) = (2.0*q(i, j)+5.0*q(i-1, j)-q(i-2, j))/6.0 - 0.5*c&
&             (i, j)*(q(i, j)-q(i-1, j)) + c(i, j)*c(i, j)/6.0*(q(i, j)-&
&             2.0*q(i-1, j)+q(i-2, j))
          ELSE
            fx_tl(i, j) = (2.0*q_tl(i-1, j)+5.0*q_tl(i, j)-q_tl(i+1, j))&
&             /6.0 - 0.5*(c_tl(i, j)*(q(i, j)-q(i-1, j))+c(i, j)*(q_tl(i&
&             , j)-q_tl(i-1, j))) + (c_tl(i, j)*c(i, j)+c(i, j)*c_tl(i, &
&             j))*(q(i+1, j)-2.0*q(i, j)+q(i-1, j))/6.0 + c(i, j)**2*(&
&             q_tl(i+1, j)-2.0*q_tl(i, j)+q_tl(i-1, j))/6.0
            fx(i, j) = (2.0*q(i-1, j)+5.0*q(i, j)-q(i+1, j))/6.0 - 0.5*c&
&             (i, j)*(q(i, j)-q(i-1, j)) + c(i, j)*c(i, j)/6.0*(q(i+1, j&
&             )-2.0*q(i, j)+q(i-1, j))
          END IF
        END DO
      END DO
    ELSE
      CALL FXPPM_TLM(c, c_tl, q, q_tl, fx, fx_tl, iord, ifirst, ilast&
&                 , jfirst, jlast, npx, npy, bd, dxa, nested, grid_type)
    END IF
  END SUBROUTINE XTP_TLM
!  Differentiation of ytp in forward (tangent) mode (with options r8):
!   variations   of useful results: fy
!   with respect to varying inputs: q fy c
  SUBROUTINE YTP_TLM(fy, fy_tl, q, q_tl, c, c_tl, jord, ifirst, ilast&
&   , jfirst, jlast, npx, npy, bd, dya, nested, grid_type)
    IMPLICIT NONE
    TYPE(FV_GRID_BOUNDS_TYPE), INTENT(IN) :: bd
    INTEGER, INTENT(IN) :: npx, npy
!  X-Dir strip
    INTEGER, INTENT(IN) :: ifirst, ilast
!  Y-Dir strip
    INTEGER, INTENT(IN) :: jfirst, jlast
    INTEGER, INTENT(IN) :: jord
    REAL(fvprc), INTENT(IN) :: q(ifirst:ilast, jfirst-ng:jlast+ng)
    REAL(fvprc), INTENT(IN) :: q_tl(ifirst:ilast, jfirst-ng:jlast+ng)
! Courant number
    REAL(fvprc), INTENT(IN) :: c(bd%isd:bd%ied, bd%js:bd%je+1)
    REAL(fvprc), INTENT(IN) :: c_tl(bd%isd:bd%ied, bd%js:bd%je+1)
!  Flux
    REAL(fvprc), INTENT(OUT) :: fy(ifirst:ilast, jfirst:jlast+1)
    REAL(fvprc), INTENT(OUT) :: fy_tl(ifirst:ilast, jfirst:jlast+1)
    REAL(fvprc), INTENT(IN) :: dya(bd%isd:bd%ied, bd%jsd:bd%jed)
    LOGICAL, INTENT(IN) :: nested
    INTEGER, INTENT(IN) :: grid_type
! !LOCAL VARIABLES:
    REAL(fvprc) :: dm(ifirst:ilast, jfirst-2:jlast+2)
    REAL(fvprc) :: x0l, x0r, x1
    INTEGER :: i, j
    IF (jord .EQ. 1) THEN
      DO j=jfirst,jlast+1
        DO i=ifirst,ilast
          IF (c(i, j) .GT. 0.) THEN
            fy_tl(i, j) = q_tl(i, j-1)
            fy(i, j) = q(i, j-1)
          ELSE
            fy_tl(i, j) = q_tl(i, j)
            fy(i, j) = q(i, j)
          END IF
        END DO
      END DO
    ELSE IF (jord .EQ. 333) THEN
!Advected using third order scheme
      DO j=jfirst,jlast+1
        DO i=ifirst,ilast
          IF (c(i, j) .GT. 0.) THEN
            fy_tl(i, j) = (2.0*q_tl(i, j)+5.0*q_tl(i, j-1)-q_tl(i, j-2))&
&             /6.0 - 0.5*(c_tl(i, j)*(q(i, j)-q(i, j-1))+c(i, j)*(q_tl(i&
&             , j)-q_tl(i, j-1))) + (c_tl(i, j)*c(i, j)+c(i, j)*c_tl(i, &
&             j))*(q(i, j)-2.0*q(i, j-1)+q(i, j-2))/6.0 + c(i, j)**2*(&
&             q_tl(i, j)-2.0*q_tl(i, j-1)+q_tl(i, j-2))/6.0
            fy(i, j) = (2.0*q(i, j)+5.0*q(i, j-1)-q(i, j-2))/6.0 - 0.5*c&
&             (i, j)*(q(i, j)-q(i, j-1)) + c(i, j)*c(i, j)/6.0*(q(i, j)-&
&             2.0*q(i, j-1)+q(i, j-2))
          ELSE
            fy_tl(i, j) = (2.0*q_tl(i, j-1)+5.0*q_tl(i, j)-q_tl(i, j+1))&
&             /6.0 - 0.5*(c_tl(i, j)*(q(i, j)-q(i, j-1))+c(i, j)*(q_tl(i&
&             , j)-q_tl(i, j-1))) + (c_tl(i, j)*c(i, j)+c(i, j)*c_tl(i, &
&             j))*(q(i, j+1)-2.0*q(i, j)+q(i, j-1))/6.0 + c(i, j)**2*(&
&             q_tl(i, j+1)-2.0*q_tl(i, j)+q_tl(i, j-1))/6.0
            fy(i, j) = (2.0*q(i, j-1)+5.0*q(i, j)-q(i, j+1))/6.0 - 0.5*c&
&             (i, j)*(q(i, j)-q(i, j-1)) + c(i, j)*c(i, j)/6.0*(q(i, j+1&
&             )-2.0*q(i, j)+q(i, j-1))
          END IF
        END DO
      END DO
    ELSE
      CALL FYPPM_TLM(c, c_tl, q, q_tl, fy, fy_tl, jord, ifirst, ilast&
&                 , jfirst, jlast, npx, npy, dm, bd, dya, nested, &
&                 grid_type)
    END IF
  END SUBROUTINE YTP_TLM
!  Differentiation of xppm0 in forward (tangent) mode (with options r8):
!   variations   of useful results: flux
!   with respect to varying inputs: q flux c
  SUBROUTINE XPPM0_TLM(flux, flux_tl, q, q_tl, c, c_tl, iord, ifirst&
&   , ilast, jfirst, jlast, npx, npy, bd, dxa, nested, grid_type)
    IMPLICIT NONE
    TYPE(FV_GRID_BOUNDS_TYPE), INTENT(IN) :: bd
!  X-Dir strip
    INTEGER, INTENT(IN) :: ifirst, ilast
!  Y-Dir strip
    INTEGER, INTENT(IN) :: jfirst, jlast
    INTEGER, INTENT(IN) :: iord
    INTEGER, INTENT(IN) :: npx, npy
    REAL(fvprc), INTENT(IN) :: q(ifirst-ng:ilast+ng, jfirst:jlast)
    REAL(fvprc), INTENT(IN) :: q_tl(ifirst-ng:ilast+ng, jfirst:jlast)
! Courant   N (like FLUX)
    REAL(fvprc), INTENT(IN) :: c(ifirst:ilast+1, jfirst:jlast)
    REAL(fvprc), INTENT(IN) :: c_tl(ifirst:ilast+1, jfirst:jlast)
    REAL(fvprc), INTENT(IN) :: dxa(bd%isd:bd%ied, bd%jsd:bd%jed)
    LOGICAL, INTENT(IN) :: nested
    INTEGER, INTENT(IN) :: grid_type
! !OUTPUT PARAMETERS:
!  Flux
    REAL(fvprc), INTENT(OUT) :: flux(ifirst:ilast+1, jfirst:jlast)
    REAL(fvprc), INTENT(OUT) :: flux_tl(ifirst:ilast+1, jfirst:jlast)
! Local
    REAL(fvprc), DIMENSION(ifirst-ng:ilast+ng) :: q1
    REAL(fvprc), DIMENSION(ifirst-ng:ilast+ng) :: q1_tl
    REAL(fvprc), DIMENSION(ifirst-1:ilast+1) :: bl, br
    REAL(fvprc), DIMENSION(ifirst-1:ilast+1) :: bl_tl, br_tl
    REAL(fvprc) :: al(ifirst-1:ilast+2)
    REAL(fvprc) :: al_tl(ifirst-1:ilast+2)
    REAL(fvprc) :: dm(ifirst-2:ilast+2)
    REAL(fvprc) :: dq(ifirst-3:ilast+2)
    LOGICAL :: extm(ifirst-2:ilast+2)
    INTEGER :: i, j, ie3, is1, ie1
    REAL(fvprc) :: xt, pmp_1, lac_1, pmp_2, lac_2
    INTRINSIC MAX
    INTRINSIC MIN
    INTRINSIC ABS
    INTEGER :: abs0
    IF (.NOT.nested .AND. grid_type .LT. 3) THEN
      IF (3 .LT. bd%is - 1) THEN
        is1 = bd%is - 1
      ELSE
        is1 = 3
      END IF
      IF (npx - 2 .GT. bd%ie + 2) THEN
        ie3 = bd%ie + 2
      ELSE
        ie3 = npx - 2
      END IF
      IF (npx - 3 .GT. bd%ie + 1) THEN
        ie1 = bd%ie + 1
      ELSE
        ie1 = npx - 3
      END IF
      al_tl = 0.0_FVPRC
      bl_tl = 0.0_FVPRC
      br_tl = 0.0_FVPRC
      q1_tl = 0.0_FVPRC
    ELSE
      is1 = bd%is - 1
      ie3 = bd%ie + 2
      ie1 = bd%ie + 1
      al_tl = 0.0_FVPRC
      bl_tl = 0.0_FVPRC
      br_tl = 0.0_FVPRC
      q1_tl = 0.0_FVPRC
    END IF
    DO j=jfirst,jlast
      DO i=ifirst-ng,ilast+ng
        q1_tl(i) = q_tl(i, j)
        q1(i) = q(i, j)
      END DO
      IF (iord .GE. 0.) THEN
        abs0 = iord
      ELSE
        abs0 = -iord
      END IF
      IF (abs0 .LT. 8) THEN
! ord = -5: linear scheme based on PPM 4th order interpolation
! ord = -6: linear PPM with 2-delta filter
! ord = -7: (-6) with additional Positive definite constraint:
        DO i=is1,ie3
          al_tl(i) = p1*(q1_tl(i-1)+q1_tl(i)) + p2*(q1_tl(i-2)+q1_tl(i+1&
&           ))
          al(i) = p1*(q1(i-1)+q1(i)) + p2*(q1(i-2)+q1(i+1))
        END DO
        IF (.NOT.nested .AND. grid_type .LT. 3) THEN
          IF (bd%is .EQ. 1) THEN
            al_tl(0) = c1*q1_tl(-2) + c2*q1_tl(-1) + c3*q1_tl(0)
            al(0) = c1*q1(-2) + c2*q1(-1) + c3*q1(0)
            al_tl(1) = 0.5*(((2.*dxa(0, j)+dxa(-1, j))*q1_tl(0)-dxa(0, j&
&             )*q1_tl(-1))/(dxa(-1, j)+dxa(0, j))+((2.*dxa(1, j)+dxa(2, &
&             j))*q1_tl(1)-dxa(1, j)*q1_tl(2))/(dxa(1, j)+dxa(2, j)))
            al(1) = 0.5*(((2.*dxa(0, j)+dxa(-1, j))*q1(0)-dxa(0, j)*q1(-&
&             1))/(dxa(-1, j)+dxa(0, j))+((2.*dxa(1, j)+dxa(2, j))*q1(1)&
&             -dxa(1, j)*q1(2))/(dxa(1, j)+dxa(2, j)))
            al_tl(2) = c3*q1_tl(1) + c2*q1_tl(2) + c1*q1_tl(3)
            al(2) = c3*q1(1) + c2*q1(2) + c1*q1(3)
          END IF
          IF (bd%ie + 1 .EQ. npx) THEN
            al_tl(npx-1) = c1*q1_tl(npx-3) + c2*q1_tl(npx-2) + c3*q1_tl(&
&             npx-1)
            al(npx-1) = c1*q1(npx-3) + c2*q1(npx-2) + c3*q1(npx-1)
            al_tl(npx) = 0.5*(((2.*dxa(npx-1, j)+dxa(npx-2, j))*q1_tl(&
&             npx-1)-dxa(npx-1, j)*q1_tl(npx-2))/(dxa(npx-2, j)+dxa(npx-&
&             1, j))+((2.*dxa(npx, j)+dxa(npx+1, j))*q1_tl(npx)-dxa(npx&
&             , j)*q1_tl(npx+1))/(dxa(npx, j)+dxa(npx+1, j)))
            al(npx) = 0.5*(((2.*dxa(npx-1, j)+dxa(npx-2, j))*q1(npx-1)-&
&             dxa(npx-1, j)*q1(npx-2))/(dxa(npx-2, j)+dxa(npx-1, j))+((&
&             2.*dxa(npx, j)+dxa(npx+1, j))*q1(npx)-dxa(npx, j)*q1(npx+1&
&             ))/(dxa(npx, j)+dxa(npx+1, j)))
            al_tl(npx+1) = c3*q1_tl(npx) + c2*q1_tl(npx+1) + c1*q1_tl(&
&             npx+2)
            al(npx+1) = c3*q1(npx) + c2*q1(npx+1) + c1*q1(npx+2)
          END IF
        END IF
        IF (iord .EQ. -5) THEN
          DO i=ifirst-1,ilast+1
            bl_tl(i) = al_tl(i) - q1_tl(i)
            bl(i) = al(i) - q1(i)
            br_tl(i) = al_tl(i+1) - q1_tl(i)
            br(i) = al(i+1) - q1(i)
          END DO
        END IF
      END IF
      DO i=ifirst,ilast+1
        IF (c(i, j) .GT. 0.) THEN
          flux_tl(i, j) = q1_tl(i-1) + (1.-c(i, j))*(br_tl(i-1)-c_tl(i, &
&           j)*(bl(i-1)+br(i-1))-c(i, j)*(bl_tl(i-1)+br_tl(i-1))) - c_tl&
&           (i, j)*(br(i-1)-c(i, j)*(bl(i-1)+br(i-1)))
          flux(i, j) = q1(i-1) + (1.-c(i, j))*(br(i-1)-c(i, j)*(bl(i-1)+&
&           br(i-1)))
        ELSE
          flux_tl(i, j) = q1_tl(i) + c_tl(i, j)*(bl(i)+c(i, j)*(bl(i)+br&
&           (i))) + (1.+c(i, j))*(bl_tl(i)+c_tl(i, j)*(bl(i)+br(i))+c(i&
&           , j)*(bl_tl(i)+br_tl(i)))
          flux(i, j) = q1(i) + (1.+c(i, j))*(bl(i)+c(i, j)*(bl(i)+br(i))&
&           )
        END IF
      END DO
    END DO
  END SUBROUTINE XPPM0_TLM
!  Differentiation of yppm0 in forward (tangent) mode (with options r8):
!   variations   of useful results: flux
!   with respect to varying inputs: q flux c
  SUBROUTINE YPPM0_TLM(flux, flux_tl, q, q_tl, c, c_tl, jord, ifirst&
&   , ilast, jfirst, jlast, npx, npy, bd, dya, nested, grid_type)
    IMPLICIT NONE
    TYPE(FV_GRID_BOUNDS_TYPE), INTENT(IN) :: bd
!  X-Dir strip
    INTEGER, INTENT(IN) :: ifirst, ilast
!  Y-Dir strip
    INTEGER, INTENT(IN) :: jfirst, jlast
    INTEGER, INTENT(IN) :: jord
    INTEGER, INTENT(IN) :: npx, npy
    REAL(fvprc), INTENT(IN) :: q(ifirst:ilast, jfirst-ng:jlast+ng)
    REAL(fvprc), INTENT(IN) :: q_tl(ifirst:ilast, jfirst-ng:jlast+ng)
! Courant number
    REAL(fvprc), INTENT(IN) :: c(bd%isd:bd%ied, bd%js:bd%je+1)
    REAL(fvprc), INTENT(IN) :: c_tl(bd%isd:bd%ied, bd%js:bd%je+1)
!  Flux
    REAL(fvprc), INTENT(OUT) :: flux(ifirst:ilast, jfirst:jlast+1)
    REAL(fvprc), INTENT(OUT) :: flux_tl(ifirst:ilast, jfirst:jlast+1)
    REAL(fvprc), INTENT(IN) :: dya(bd%isd:bd%ied, bd%jsd:bd%jed)
    LOGICAL, INTENT(IN) :: nested
    INTEGER, INTENT(IN) :: grid_type
! Local:
    REAL(fvprc) :: dm(ifirst:ilast, jfirst-2:jlast+2)
    REAL(fvprc) :: al(ifirst:ilast, jfirst-1:jlast+2)
    REAL(fvprc) :: al_tl(ifirst:ilast, jfirst-1:jlast+2)
    REAL(fvprc) :: bl(ifirst:ilast, jfirst-1:jlast+1)
    REAL(fvprc) :: bl_tl(ifirst:ilast, jfirst-1:jlast+1)
    REAL(fvprc) :: br(ifirst:ilast, jfirst-1:jlast+1)
    REAL(fvprc) :: br_tl(ifirst:ilast, jfirst-1:jlast+1)
    REAL(fvprc) :: dq(ifirst:ilast, jfirst-3:jlast+2)
    LOGICAL :: extm(ifirst:ilast, jfirst-2:jlast+2)
    REAL(fvprc) :: xt, pmp_1, lac_1, pmp_2, lac_2
    INTEGER :: i, j, js1, je3, je1
    INTRINSIC MAX
    INTRINSIC MIN
    INTRINSIC ABS
    INTEGER :: abs0
    IF (.NOT.nested .AND. grid_type .LT. 3) THEN
      IF (3 .LT. bd%js - 1) THEN
        js1 = bd%js - 1
      ELSE
        js1 = 3
      END IF
      IF (npy - 2 .GT. bd%je + 2) THEN
        je3 = bd%je + 2
      ELSE
        je3 = npy - 2
      END IF
      IF (npy - 3 .GT. bd%je + 1) THEN
        je1 = bd%je + 1
      ELSE
        je1 = npy - 3
      END IF
    ELSE
! Nested grid OR Doubly periodic domain:
      js1 = bd%js - 1
      je3 = bd%je + 2
      je1 = bd%je + 1
    END IF
    IF (jord .GE. 0.) THEN
      abs0 = jord
    ELSE
      abs0 = -jord
    END IF
    IF (abs0 .LT. 8) THEN
      al_tl = 0.0_FVPRC
! ord = -5: linear scheme based on PPM 4th order interpolation
! ord = -6: linear PPM with 2-delta filter
! ord = -7: (-6) with additional Positive definite constraint:
      DO j=js1,je3
        DO i=ifirst,ilast
          al_tl(i, j) = p1*(q_tl(i, j-1)+q_tl(i, j)) + p2*(q_tl(i, j-2)+&
&           q_tl(i, j+1))
          al(i, j) = p1*(q(i, j-1)+q(i, j)) + p2*(q(i, j-2)+q(i, j+1))
        END DO
      END DO
      IF (.NOT.nested .AND. grid_type .LT. 3) THEN
        IF (bd%js .EQ. 1) THEN
          DO i=ifirst,ilast
            al_tl(i, 0) = c1*q_tl(i, -2) + c2*q_tl(i, -1) + c3*q_tl(i, 0&
&             )
            al(i, 0) = c1*q(i, -2) + c2*q(i, -1) + c3*q(i, 0)
            al_tl(i, 1) = 0.5*(((2.*dya(i, 0)+dya(i, -1))*q_tl(i, 0)-dya&
&             (i, 0)*q_tl(i, -1))/(dya(i, -1)+dya(i, 0))+((2.*dya(i, 1)+&
&             dya(i, 2))*q_tl(i, 1)-dya(i, 1)*q_tl(i, 2))/(dya(i, 1)+dya&
&             (i, 2)))
            al(i, 1) = 0.5*(((2.*dya(i, 0)+dya(i, -1))*q(i, 0)-dya(i, 0)&
&             *q(i, -1))/(dya(i, -1)+dya(i, 0))+((2.*dya(i, 1)+dya(i, 2)&
&             )*q(i, 1)-dya(i, 1)*q(i, 2))/(dya(i, 1)+dya(i, 2)))
            al_tl(i, 2) = c3*q_tl(i, 1) + c2*q_tl(i, 2) + c1*q_tl(i, 3)
            al(i, 2) = c3*q(i, 1) + c2*q(i, 2) + c1*q(i, 3)
          END DO
        END IF
        IF (bd%je + 1 .EQ. npy) THEN
          DO i=ifirst,ilast
            al_tl(i, npy-1) = c1*q_tl(i, npy-3) + c2*q_tl(i, npy-2) + c3&
&             *q_tl(i, npy-1)
            al(i, npy-1) = c1*q(i, npy-3) + c2*q(i, npy-2) + c3*q(i, npy&
&             -1)
            al_tl(i, npy) = 0.5*(((2.*dya(i, npy-1)+dya(i, npy-2))*q_tl(&
&             i, npy-1)-dya(i, npy-1)*q_tl(i, npy-2))/(dya(i, npy-2)+dya&
&             (i, npy-1))+((2.*dya(i, npy)+dya(i, npy+1))*q_tl(i, npy)-&
&             dya(i, npy)*q_tl(i, npy+1))/(dya(i, npy)+dya(i, npy+1)))
            al(i, npy) = 0.5*(((2.*dya(i, npy-1)+dya(i, npy-2))*q(i, npy&
&             -1)-dya(i, npy-1)*q(i, npy-2))/(dya(i, npy-2)+dya(i, npy-1&
&             ))+((2.*dya(i, npy)+dya(i, npy+1))*q(i, npy)-dya(i, npy)*q&
&             (i, npy+1))/(dya(i, npy)+dya(i, npy+1)))
            al_tl(i, npy+1) = c3*q_tl(i, npy) + c2*q_tl(i, npy+1) + c1*&
&             q_tl(i, npy+2)
            al(i, npy+1) = c3*q(i, npy) + c2*q(i, npy+1) + c1*q(i, npy+2&
&             )
          END DO
        END IF
      END IF
      IF (jord .EQ. -5) THEN
        bl_tl = 0.0_FVPRC
        br_tl = 0.0_FVPRC
        DO j=jfirst-1,jlast+1
          DO i=ifirst,ilast
            bl_tl(i, j) = al_tl(i, j) - q_tl(i, j)
            bl(i, j) = al(i, j) - q(i, j)
            br_tl(i, j) = al_tl(i, j+1) - q_tl(i, j)
            br(i, j) = al(i, j+1) - q(i, j)
          END DO
        END DO
      ELSE
        bl_tl = 0.0_FVPRC
        br_tl = 0.0_FVPRC
      END IF
    ELSE
      bl_tl = 0.0_FVPRC
      br_tl = 0.0_FVPRC
    END IF
    DO j=jfirst,jlast+1
      DO i=ifirst,ilast
        IF (c(i, j) .GT. 0.) THEN
          flux_tl(i, j) = q_tl(i, j-1) + (1.-c(i, j))*(br_tl(i, j-1)-&
&           c_tl(i, j)*(bl(i, j-1)+br(i, j-1))-c(i, j)*(bl_tl(i, j-1)+&
&           br_tl(i, j-1))) - c_tl(i, j)*(br(i, j-1)-c(i, j)*(bl(i, j-1)&
&           +br(i, j-1)))
          flux(i, j) = q(i, j-1) + (1.-c(i, j))*(br(i, j-1)-c(i, j)*(bl(&
&           i, j-1)+br(i, j-1)))
        ELSE
          flux_tl(i, j) = q_tl(i, j) + c_tl(i, j)*(bl(i, j)+c(i, j)*(bl(&
&           i, j)+br(i, j))) + (1.+c(i, j))*(bl_tl(i, j)+c_tl(i, j)*(bl(&
&           i, j)+br(i, j))+c(i, j)*(bl_tl(i, j)+br_tl(i, j)))
          flux(i, j) = q(i, j) + (1.+c(i, j))*(bl(i, j)+c(i, j)*(bl(i, j&
&           )+br(i, j)))
        END IF
      END DO
    END DO
  END SUBROUTINE YPPM0_TLM
!  Differentiation of fxppm in forward (tangent) mode (with options r8):
!   variations   of useful results: flux
!   with respect to varying inputs: q flux c
  SUBROUTINE FXPPM_TLM(c, c_tl, q, q_tl, flux, flux_tl, iord, ifirst&
&   , ilast, jfirst, jlast, npx, npy, bd, dxa, nested, grid_type)
    IMPLICIT NONE
! !INPUT PARAMETERS:
    TYPE(FV_GRID_BOUNDS_TYPE), INTENT(IN) :: bd
!  X-Dir strip
    INTEGER, INTENT(IN) :: ifirst, ilast
!  Y-Dir strip
    INTEGER, INTENT(IN) :: jfirst, jlast
    INTEGER, INTENT(IN) :: iord
    INTEGER, INTENT(IN) :: npx, npy
    REAL(fvprc), INTENT(IN) :: q(ifirst-ng:ilast+ng, jfirst:jlast)
    REAL(fvprc), INTENT(IN) :: q_tl(ifirst-ng:ilast+ng, jfirst:jlast)
! Courant   N (like FLUX)
    REAL(fvprc), INTENT(IN) :: c(ifirst:ilast+1, jfirst:jlast)
    REAL(fvprc), INTENT(IN) :: c_tl(ifirst:ilast+1, jfirst:jlast)
    REAL(fvprc), INTENT(IN) :: dxa(bd%isd:bd%ied, bd%jsd:bd%jed)
    LOGICAL, INTENT(IN) :: nested
    INTEGER, INTENT(IN) :: grid_type
! !OUTPUT PARAMETERS:
!  Flux
    REAL(fvprc), INTENT(OUT) :: flux(ifirst:ilast+1, jfirst:jlast)
    REAL(fvprc), INTENT(OUT) :: flux_tl(ifirst:ilast+1, jfirst:jlast)
! Local
    LOGICAL :: extm(ifirst-2:ilast+2)
    REAL(fvprc) :: dm1(ifirst-2:ilast+2)
    REAL(fvprc) :: al(ifirst-1:ilast+2)
    REAL(fvprc) :: bl(ifirst-1:ilast+1)
    REAL(fvprc) :: br(ifirst-1:ilast+1)
    REAL(fvprc) :: dq(ifirst-3:ilast+2)
    REAL(fvprc) :: dl, dr, pmp, lac, ct, qe
    REAL(fvprc) :: pmp_1, lac_1, pmp_2, lac_2
    REAL(fvprc) :: xt, x1, x0, x0l, x0r
    REAL(fvprc) :: xt_tl, x0l_tl, x0r_tl
    INTEGER :: i, j, is3, ie3, it
    REAL(fvprc) :: bl6(ifirst-1:ilast+1, jfirst:jlast)
    REAL(fvprc) :: bl6_tl(ifirst-1:ilast+1, jfirst:jlast)
    REAL(fvprc) :: br6(ifirst-1:ilast+1, jfirst:jlast)
    REAL(fvprc) :: br6_tl(ifirst-1:ilast+1, jfirst:jlast)
    INTRINSIC MAX
    INTRINSIC MIN
    x0 = big_number
    IF (nested) THEN
      is3 = bd%is - 1
      ie3 = bd%ie + 1
    ELSE
      IF (3 .LT. bd%is - 1) THEN
        is3 = bd%is - 1
      ELSE
        is3 = 3
      END IF
      IF (npx - 3 .GT. bd%ie + 1) THEN
        ie3 = bd%ie + 1
      ELSE
        ie3 = npx - 3
      END IF
    END IF
    IF (iord .EQ. 6 .OR. iord .EQ. 7) THEN
      IF (iord .EQ. 6) THEN
        br6_tl = 0.0_FVPRC
        bl6_tl = 0.0_FVPRC
        DO j=jfirst,jlast
          DO i=is3,ie3
            bl6_tl(i, j) = b5*q_tl(i-2, j) + b4*q_tl(i-1, j) + b3*q_tl(i&
&             , j) + b2*q_tl(i+1, j) + b1*q_tl(i+2, j)
            bl6(i, j) = b5*q(i-2, j) + b4*q(i-1, j) + b3*q(i, j) + b2*q(&
&             i+1, j) + b1*q(i+2, j)
            br6_tl(i, j) = b1*q_tl(i-2, j) + b2*q_tl(i-1, j) + b3*q_tl(i&
&             , j) + b4*q_tl(i+1, j) + b5*q_tl(i+2, j)
            br6(i, j) = b1*q(i-2, j) + b2*q(i-1, j) + b3*q(i, j) + b4*q(&
&             i+1, j) + b5*q(i+2, j)
          END DO
        END DO
      ELSE
        br6_tl = 0.0_FVPRC
        bl6_tl = 0.0_FVPRC
      END IF
!--------------
! fix the edges
!--------------
      DO j=jfirst,jlast
        IF (.NOT.nested) THEN
          IF (bd%is .EQ. 1) THEN
            x0l_tl = 0.5*((2.*dxa(0, j)+dxa(-1, j))*q_tl(0, j)-dxa(0, j)&
&             *q_tl(-1, j))/(dxa(0, j)+dxa(-1, j))
            x0l = 0.5*((2.*dxa(0, j)+dxa(-1, j))*q(0, j)-dxa(0, j)*q(-1&
&             , j))/(dxa(0, j)+dxa(-1, j))
            x0r_tl = 0.5*((2.*dxa(1, j)+dxa(2, j))*q_tl(1, j)-dxa(1, j)*&
&             q_tl(2, j))/(dxa(1, j)+dxa(2, j))
            x0r = 0.5*((2.*dxa(1, j)+dxa(2, j))*q(1, j)-dxa(1, j)*q(2, j&
&             ))/(dxa(1, j)+dxa(2, j))
            br6_tl(2, j) = p1*(q_tl(2, j)+q_tl(3, j)) + p2*(q_tl(1, j)+&
&             q_tl(4, j)) - q_tl(2, j)
            br6(2, j) = p1*(q(2, j)+q(3, j)) + p2*(q(1, j)+q(4, j)) - q(&
&             2, j)
            xt_tl = x0l_tl + x0r_tl
            xt = x0l + x0r
            bl6_tl(1, j) = xt_tl - q_tl(1, j)
            bl6(1, j) = xt - q(1, j)
            br6_tl(0, j) = xt_tl - q_tl(0, j)
            br6(0, j) = xt - q(0, j)
            xt_tl = c1*q_tl(-2, j) + c2*q_tl(-1, j) + c3*q_tl(0, j)
            xt = c1*q(-2, j) + c2*q(-1, j) + c3*q(0, j)
            bl6_tl(0, j) = xt_tl - q_tl(0, j)
            bl6(0, j) = xt - q(0, j)
            xt_tl = c3*q_tl(1, j) + c2*q_tl(2, j) + c1*q_tl(3, j)
            xt = c3*q(1, j) + c2*q(2, j) + c1*q(3, j)
            br6_tl(1, j) = xt_tl - q_tl(1, j)
            br6(1, j) = xt - q(1, j)
            bl6_tl(2, j) = xt_tl - q_tl(2, j)
            bl6(2, j) = xt - q(2, j)
          END IF
          IF (bd%ie + 1 .EQ. npx) THEN
            x0l_tl = 0.5*((2.*dxa(npx-1, j)+dxa(npx-2, j))*q_tl(npx-1, j&
&             )-dxa(npx-1, j)*q_tl(npx-2, j))/(dxa(npx-1, j)+dxa(npx-2, &
&             j))
            x0l = 0.5*((2.*dxa(npx-1, j)+dxa(npx-2, j))*q(npx-1, j)-dxa(&
&             npx-1, j)*q(npx-2, j))/(dxa(npx-1, j)+dxa(npx-2, j))
            x0r_tl = 0.5*((2.*dxa(npx, j)+dxa(npx+1, j))*q_tl(npx, j)-&
&             dxa(npx, j)*q_tl(npx+1, j))/(dxa(npx, j)+dxa(npx+1, j))
            x0r = 0.5*((2.*dxa(npx, j)+dxa(npx+1, j))*q(npx, j)-dxa(npx&
&             , j)*q(npx+1, j))/(dxa(npx, j)+dxa(npx+1, j))
            bl6_tl(npx-2, j) = p1*(q_tl(npx-2, j)+q_tl(npx-3, j)) + p2*(&
&             q_tl(npx-4, j)+q_tl(npx-1, j)) - q_tl(npx-2, j)
            bl6(npx-2, j) = p1*(q(npx-2, j)+q(npx-3, j)) + p2*(q(npx-4, &
&             j)+q(npx-1, j)) - q(npx-2, j)
            xt_tl = x0l_tl + x0r_tl
            xt = x0l + x0r
            br6_tl(npx-1, j) = xt_tl - q_tl(npx-1, j)
            br6(npx-1, j) = xt - q(npx-1, j)
            bl6_tl(npx, j) = xt_tl - q_tl(npx, j)
            bl6(npx, j) = xt - q(npx, j)
            xt_tl = c3*q_tl(npx, j) + c2*q_tl(npx+1, j) + c1*q_tl(npx+2&
&             , j)
            xt = c3*q(npx, j) + c2*q(npx+1, j) + c1*q(npx+2, j)
            br6_tl(npx, j) = xt_tl - q_tl(npx, j)
            br6(npx, j) = xt - q(npx, j)
            xt_tl = c1*q_tl(npx-3, j) + c2*q_tl(npx-2, j) + c3*q_tl(npx-&
&             1, j)
            xt = c1*q(npx-3, j) + c2*q(npx-2, j) + c3*q(npx-1, j)
            br6_tl(npx-2, j) = xt_tl - q_tl(npx-2, j)
            br6(npx-2, j) = xt - q(npx-2, j)
            bl6_tl(npx-1, j) = xt_tl - q_tl(npx-1, j)
            bl6(npx-1, j) = xt - q(npx-1, j)
          END IF
        END IF
      END DO
      DO j=jfirst,jlast
        DO i=ifirst,ilast+1
          IF (c(i, j) .GT. 0.) THEN
            flux_tl(i, j) = q_tl(i-1, j) + (1.-c(i, j))*(br6_tl(i-1, j)-&
&             c_tl(i, j)*(bl6(i-1, j)+br6(i-1, j))-c(i, j)*(bl6_tl(i-1, &
&             j)+br6_tl(i-1, j))) - c_tl(i, j)*(br6(i-1, j)-c(i, j)*(bl6&
&             (i-1, j)+br6(i-1, j)))
            flux(i, j) = q(i-1, j) + (1.-c(i, j))*(br6(i-1, j)-c(i, j)*(&
&             bl6(i-1, j)+br6(i-1, j)))
          ELSE
            flux_tl(i, j) = q_tl(i, j) + c_tl(i, j)*(bl6(i, j)+c(i, j)*(&
&             bl6(i, j)+br6(i, j))) + (1.+c(i, j))*(bl6_tl(i, j)+c_tl(i&
&             , j)*(bl6(i, j)+br6(i, j))+c(i, j)*(bl6_tl(i, j)+br6_tl(i&
&             , j)))
            flux(i, j) = q(i, j) + (1.+c(i, j))*(bl6(i, j)+c(i, j)*(bl6(&
&             i, j)+br6(i, j)))
          END IF
        END DO
      END DO
    END IF
  END SUBROUTINE FXPPM_TLM
!  Differentiation of fyppm in forward (tangent) mode (with options r8):
!   variations   of useful results: flux
!   with respect to varying inputs: q flux c
  SUBROUTINE FYPPM_TLM(c, c_tl, q, q_tl, flux, flux_tl, jord, ifirst&
&   , ilast, jfirst, jlast, npx, npy, dm, bd, dya, nested, grid_type)
    IMPLICIT NONE
    TYPE(FV_GRID_BOUNDS_TYPE), INTENT(IN) :: bd
!  X-Dir strip
    INTEGER, INTENT(IN) :: ifirst, ilast
!  Y-Dir strip
    INTEGER, INTENT(IN) :: jfirst, jlast
    INTEGER, INTENT(IN) :: jord
    INTEGER, INTENT(IN) :: npx, npy
    REAL(fvprc), INTENT(IN) :: q(ifirst:ilast, jfirst-ng:jlast+ng)
    REAL(fvprc), INTENT(IN) :: q_tl(ifirst:ilast, jfirst-ng:jlast+ng)
! Courant number
    REAL(fvprc), INTENT(IN) :: c(bd%isd:bd%ied, bd%js:bd%je+1)
    REAL(fvprc), INTENT(IN) :: c_tl(bd%isd:bd%ied, bd%js:bd%je+1)
!  Flux
    REAL(fvprc), INTENT(OUT) :: flux(ifirst:ilast, jfirst:jlast+1)
    REAL(fvprc), INTENT(OUT) :: flux_tl(ifirst:ilast, jfirst:jlast+1)
    REAL(fvprc), INTENT(OUT) :: dm(ifirst:ilast, jfirst-2:jlast+2)
    REAL(fvprc), INTENT(IN) :: dya(bd%isd:bd%ied, bd%jsd:bd%jed)
    LOGICAL, INTENT(IN) :: nested
    INTEGER, INTENT(IN) :: grid_type
! Local:
    LOGICAL :: extm(ifirst:ilast, jfirst-2:jlast+2)
    REAL(fvprc) :: al(ifirst:ilast, jfirst-1:jlast+2)
    REAL(fvprc) :: bl(ifirst:ilast, jfirst-1:jlast+1)
    REAL(fvprc) :: bl_tl(ifirst:ilast, jfirst-1:jlast+1)
    REAL(fvprc) :: br(ifirst:ilast, jfirst-1:jlast+1)
    REAL(fvprc) :: br_tl(ifirst:ilast, jfirst-1:jlast+1)
    REAL(fvprc) :: dq(ifirst:ilast, jfirst-3:jlast+2)
    REAL(fvprc) :: dl, dr, pmp, lac, ct, qe
    REAL(fvprc) :: pmp_1, lac_1, pmp_2, lac_2
    REAL(fvprc) :: xt, x0, x1, x0l, x0r
    REAL(fvprc) :: xt_tl, x0l_tl, x0r_tl
    INTEGER :: i, j, js3, je3, jt
    INTRINSIC MAX
    INTRINSIC MIN
    INTEGER :: max1
    INTEGER :: min1
    dm = 0.0_FVPRC
    IF (nested) THEN
      js3 = bd%js - 1
      je3 = bd%je + 1
    ELSE
      IF (3 .LT. bd%js - 1) THEN
        js3 = bd%js - 1
      ELSE
        js3 = 3
      END IF
      IF (npy - 3 .GT. bd%je + 1) THEN
        je3 = bd%je + 1
      ELSE
        je3 = npy - 3
      END IF
    END IF
    IF (jord .EQ. 6 .OR. jord .EQ. 7) THEN
      IF (jord .EQ. 6) THEN
        IF (3 .LT. bd%js - 1) THEN
          max1 = bd%js - 1
        ELSE
          max1 = 3
        END IF
        IF (npy - 3 .GT. bd%je + 1) THEN
          min1 = bd%je + 1
          bl_tl = 0.0_FVPRC
          br_tl = 0.0_FVPRC
        ELSE
          min1 = npy - 3
          bl_tl = 0.0_FVPRC
          br_tl = 0.0_FVPRC
        END IF
        DO j=max1,min1
          DO i=ifirst,ilast
            bl_tl(i, j) = b5*q_tl(i, j-2) + b4*q_tl(i, j-1) + b3*q_tl(i&
&             , j) + b2*q_tl(i, j+1) + b1*q_tl(i, j+2)
            bl(i, j) = b5*q(i, j-2) + b4*q(i, j-1) + b3*q(i, j) + b2*q(i&
&             , j+1) + b1*q(i, j+2)
            br_tl(i, j) = b1*q_tl(i, j-2) + b2*q_tl(i, j-1) + b3*q_tl(i&
&             , j) + b4*q_tl(i, j+1) + b5*q_tl(i, j+2)
            br(i, j) = b1*q(i, j-2) + b2*q(i, j-1) + b3*q(i, j) + b4*q(i&
&             , j+1) + b5*q(i, j+2)
          END DO
        END DO
      ELSE
        bl_tl = 0.0_FVPRC
        br_tl = 0.0_FVPRC
      END IF
      IF (bd%js .EQ. 1 .AND. (.NOT.nested)) THEN
        DO i=ifirst,ilast
          br_tl(i, 2) = p1*(q_tl(i, 2)+q_tl(i, 3)) + p2*(q_tl(i, 1)+q_tl&
&           (i, 4)) - q_tl(i, 2)
          br(i, 2) = p1*(q(i, 2)+q(i, 3)) + p2*(q(i, 1)+q(i, 4)) - q(i, &
&           2)
          x0l_tl = 0.5*((2.*dya(i, 0)+dya(i, -1))*q_tl(i, 0)-dya(i, 0)*&
&           q_tl(i, -1))/(dya(i, 0)+dya(i, -1))
          x0l = 0.5*((2.*dya(i, 0)+dya(i, -1))*q(i, 0)-dya(i, 0)*q(i, -1&
&           ))/(dya(i, 0)+dya(i, -1))
          x0r_tl = 0.5*((2.*dya(i, 1)+dya(i, 2))*q_tl(i, 1)-dya(i, 1)*&
&           q_tl(i, 2))/(dya(i, 1)+dya(i, 2))
          x0r = 0.5*((2.*dya(i, 1)+dya(i, 2))*q(i, 1)-dya(i, 1)*q(i, 2))&
&           /(dya(i, 1)+dya(i, 2))
          xt_tl = x0l_tl + x0r_tl
          xt = x0l + x0r
          bl_tl(i, 1) = xt_tl - q_tl(i, 1)
          bl(i, 1) = xt - q(i, 1)
          br_tl(i, 0) = xt_tl - q_tl(i, 0)
          br(i, 0) = xt - q(i, 0)
          xt_tl = c1*q_tl(i, -2) + c2*q_tl(i, -1) + c3*q_tl(i, 0)
          xt = c1*q(i, -2) + c2*q(i, -1) + c3*q(i, 0)
          bl_tl(i, 0) = xt_tl - q_tl(i, 0)
          bl(i, 0) = xt - q(i, 0)
          xt_tl = c3*q_tl(i, 1) + c2*q_tl(i, 2) + c1*q_tl(i, 3)
          xt = c3*q(i, 1) + c2*q(i, 2) + c1*q(i, 3)
          br_tl(i, 1) = xt_tl - q_tl(i, 1)
          br(i, 1) = xt - q(i, 1)
          bl_tl(i, 2) = xt_tl - q_tl(i, 2)
          bl(i, 2) = xt - q(i, 2)
        END DO
      END IF
      IF (bd%je + 1 .EQ. npy .AND. (.NOT.nested)) THEN
        DO i=ifirst,ilast
          bl_tl(i, npy-2) = p1*(q_tl(i, npy-3)+q_tl(i, npy-2)) + p2*(&
&           q_tl(i, npy-4)+q_tl(i, npy-1)) - q_tl(i, npy-2)
          bl(i, npy-2) = p1*(q(i, npy-3)+q(i, npy-2)) + p2*(q(i, npy-4)+&
&           q(i, npy-1)) - q(i, npy-2)
          x0l_tl = 0.5*((2.*dya(i, npy-1)+dya(i, npy-2))*q_tl(i, npy-1)-&
&           dya(i, npy-1)*q_tl(i, npy-2))/(dya(i, npy-1)+dya(i, npy-2))
          x0l = 0.5*((2.*dya(i, npy-1)+dya(i, npy-2))*q(i, npy-1)-dya(i&
&           , npy-1)*q(i, npy-2))/(dya(i, npy-1)+dya(i, npy-2))
          x0r_tl = 0.5*((2.*dya(i, npy)+dya(i, npy+1))*q_tl(i, npy)-dya(&
&           i, npy)*q_tl(i, npy+1))/(dya(i, npy)+dya(i, npy+1))
          x0r = 0.5*((2.*dya(i, npy)+dya(i, npy+1))*q(i, npy)-dya(i, npy&
&           )*q(i, npy+1))/(dya(i, npy)+dya(i, npy+1))
          xt_tl = x0l_tl + x0r_tl
          xt = x0l + x0r
          br_tl(i, npy-1) = xt_tl - q_tl(i, npy-1)
          br(i, npy-1) = xt - q(i, npy-1)
          bl_tl(i, npy) = xt_tl - q_tl(i, npy)
          bl(i, npy) = xt - q(i, npy)
          xt_tl = c3*q_tl(i, npy) + c2*q_tl(i, npy+1) + c1*q_tl(i, npy+2&
&           )
          xt = c3*q(i, npy) + c2*q(i, npy+1) + c1*q(i, npy+2)
          br_tl(i, npy) = xt_tl - q_tl(i, npy)
          br(i, npy) = xt - q(i, npy)
          xt_tl = c1*q_tl(i, npy-3) + c2*q_tl(i, npy-2) + c3*q_tl(i, npy&
&           -1)
          xt = c1*q(i, npy-3) + c2*q(i, npy-2) + c3*q(i, npy-1)
          br_tl(i, npy-2) = xt_tl - q_tl(i, npy-2)
          br(i, npy-2) = xt - q(i, npy-2)
          bl_tl(i, npy-1) = xt_tl - q_tl(i, npy-1)
          bl(i, npy-1) = xt - q(i, npy-1)
        END DO
      END IF
      DO j=jfirst,jlast+1
        DO i=ifirst,ilast
          IF (c(i, j) .GT. 0.) THEN
            flux_tl(i, j) = q_tl(i, j-1) + (1.-c(i, j))*(br_tl(i, j-1)-&
&             c_tl(i, j)*(bl(i, j-1)+br(i, j-1))-c(i, j)*(bl_tl(i, j-1)+&
&             br_tl(i, j-1))) - c_tl(i, j)*(br(i, j-1)-c(i, j)*(bl(i, j-&
&             1)+br(i, j-1)))
            flux(i, j) = q(i, j-1) + (1.-c(i, j))*(br(i, j-1)-c(i, j)*(&
&             bl(i, j-1)+br(i, j-1)))
          ELSE
            flux_tl(i, j) = q_tl(i, j) + c_tl(i, j)*(bl(i, j)+c(i, j)*(&
&             bl(i, j)+br(i, j))) + (1.+c(i, j))*(bl_tl(i, j)+c_tl(i, j)&
&             *(bl(i, j)+br(i, j))+c(i, j)*(bl_tl(i, j)+br_tl(i, j)))
            flux(i, j) = q(i, j) + (1.+c(i, j))*(bl(i, j)+c(i, j)*(bl(i&
&             , j)+br(i, j)))
          END IF
        END DO
      END DO
    END IF
  END SUBROUTINE FYPPM_TLM
!  Differentiation of deln_flux in forward (tangent) mode (with options r8):
!   variations   of useful results: fx fy
!   with respect to varying inputs: q mass fx fy
  SUBROUTINE DELN_FLUX_TLM(nord, npx, npy, damp, q, q_tl, fx, fx_tl, &
&   fy, fy_tl, gridstruct, bd, mass, mass_tl)
    IMPLICIT NONE
! Del-n damping for the cell-mean values (A grid)
!------------------
! nord = 0:   del-2
! nord = 1:   del-4
! nord = 2:   del-6
! nord = 3:   del-8 --> requires more ghosting than current
!------------------
    TYPE(FV_GRID_BOUNDS_TYPE), INTENT(IN) :: bd
! del-n
    INTEGER, INTENT(IN) :: nord
    INTEGER, INTENT(IN) :: npx, npy
    REAL(fvprc), INTENT(IN) :: damp
! q ghosted on input
    REAL(fvprc), INTENT(IN) :: q(bd%is-ng:bd%ie+ng, bd%js-ng:bd%je+ng)
    REAL(fvprc), INTENT(IN) :: q_tl(bd%is-ng:bd%ie+ng, bd%js-ng:bd%je+ng&
&   )
    TYPE(FV_GRID_TYPE), INTENT(IN), TARGET :: gridstruct
! q ghosted on input
    REAL(fvprc), OPTIONAL, INTENT(IN) :: mass(bd%isd:bd%ied, bd%jsd:bd%&
&   jed)
    REAL(fvprc), OPTIONAL, INTENT(IN) :: mass_tl(bd%isd:bd%ied, bd%jsd:&
&   bd%jed)
! diffusive fluxes:
    REAL(fvprc), INTENT(INOUT) :: fx(bd%is:bd%ie+1, bd%js:bd%je), fy(bd%&
&   is:bd%ie, bd%js:bd%je+1)
    REAL(fvprc), INTENT(INOUT) :: fx_tl(bd%is:bd%ie+1, bd%js:bd%je), &
&   fy_tl(bd%is:bd%ie, bd%js:bd%je+1)
! local:
    REAL(fvprc) :: fx2(bd%isd:bd%ied+1, bd%jsd:bd%jed), fy2(bd%isd:bd%&
&   ied, bd%jsd:bd%jed+1)
    REAL(fvprc) :: fx2_tl(bd%isd:bd%ied+1, bd%jsd:bd%jed), fy2_tl(bd%isd&
&   :bd%ied, bd%jsd:bd%jed+1)
    REAL(fvprc) :: d2(bd%isd:bd%ied, bd%jsd:bd%jed)
    REAL(fvprc) :: d2_tl(bd%isd:bd%ied, bd%jsd:bd%jed)
    REAL(fvprc) :: damp2
    INTEGER :: i, j, n, nt, i1, i2, j1, j2
    INTRINSIC PRESENT
!   real(FVPRC), pointer, dimension(:,:)   :: rarea, dx, dy, rdxc, rdyc
!   real(FVPRC), pointer, dimension(:,:,:) :: sin_sg
!   rarea    => gridstruct%rarea  
!   dx       => gridstruct%dx     
!   dy       => gridstruct%dy     
!   rdxc     => gridstruct%rdxc   
!   rdyc     => gridstruct%rdyc   
!   sin_sg   => gridstruct%sin_sg 
    i1 = bd%is - 1 - nord
    i2 = bd%ie + 1 + nord
    j1 = bd%js - 1 - nord
    j2 = bd%je + 1 + nord
    IF (.NOT.PRESENT(mass)) THEN
      d2_tl = 0.0_FVPRC
      DO j=j1,j2
        DO i=i1,i2
          d2_tl(i, j) = damp*q_tl(i, j)
          d2(i, j) = damp*q(i, j)
        END DO
      END DO
    ELSE
      d2_tl = 0.0_FVPRC
      DO j=j1,j2
        DO i=i1,i2
          d2_tl(i, j) = q_tl(i, j)
          d2(i, j) = q(i, j)
        END DO
      END DO
    END IF
    IF (nord .GT. 0) THEN
      CALL COPY_CORNERS_TLM(d2, d2_tl, npx, npy, 1, gridstruct%nested&
&                        , bd, gridstruct%sw_corner, gridstruct%&
&                        se_corner, gridstruct%nw_corner, gridstruct%&
&                        ne_corner)
      fx2_tl = 0.0_FVPRC
    ELSE
      fx2_tl = 0.0_FVPRC
    END IF
    DO j=bd%js-nord,bd%je+nord
      DO i=bd%is-nord,bd%ie+nord+1
!        fx2(i,j) = gridstruct%dy(i,j)*sina_u(i,j)*(d2(i-1,j)-d2(i,j))*gridstruct%rdxc(i,j)
        fx2_tl(i, j) = 0.5*(gridstruct%sin_sg(i-1, j, 3)+gridstruct%&
&         sin_sg(i, j, 1))*gridstruct%dy(i, j)*gridstruct%rdxc(i, j)*(&
&         d2_tl(i-1, j)-d2_tl(i, j))
        fx2(i, j) = 0.5*(gridstruct%sin_sg(i-1, j, 3)+gridstruct%sin_sg(&
&         i, j, 1))*gridstruct%dy(i, j)*(d2(i-1, j)-d2(i, j))*gridstruct&
&         %rdxc(i, j)
      END DO
    END DO
    IF (nord .GT. 0) THEN
      CALL COPY_CORNERS_TLM(d2, d2_tl, npx, npy, 2, gridstruct%nested&
&                        , bd, gridstruct%sw_corner, gridstruct%&
&                        se_corner, gridstruct%nw_corner, gridstruct%&
&                        ne_corner)
      fy2_tl = 0.0_FVPRC
    ELSE
      fy2_tl = 0.0_FVPRC
    END IF
    DO j=bd%js-nord,bd%je+nord+1
      DO i=bd%is-nord,bd%ie+nord
!           fy2(i,j) = gridstruct%dx(i,j)*sina_v(i,j)*(d2(i,j-1)-d2(i,j))*gridstruct%rdyc(i,j)
        fy2_tl(i, j) = 0.5*(gridstruct%sin_sg(i, j-1, 4)+gridstruct%&
&         sin_sg(i, j, 2))*gridstruct%dx(i, j)*gridstruct%rdyc(i, j)*(&
&         d2_tl(i, j-1)-d2_tl(i, j))
        fy2(i, j) = 0.5*(gridstruct%sin_sg(i, j-1, 4)+gridstruct%sin_sg(&
&         i, j, 2))*gridstruct%dx(i, j)*(d2(i, j-1)-d2(i, j))*gridstruct&
&         %rdyc(i, j)
      END DO
    END DO
    IF (nord .GT. 0) THEN
!----------
! high-order
!----------
      DO n=1,nord
        nt = nord - n
        DO j=bd%js-nt-1,bd%je+nt+1
          DO i=bd%is-nt-1,bd%ie+nt+1
            d2_tl(i, j) = gridstruct%rarea(i, j)*(fx2_tl(i, j)-fx2_tl(i+&
&             1, j)+fy2_tl(i, j)-fy2_tl(i, j+1))
            d2(i, j) = (fx2(i, j)-fx2(i+1, j)+fy2(i, j)-fy2(i, j+1))*&
&             gridstruct%rarea(i, j)
          END DO
        END DO
        CALL COPY_CORNERS_TLM(d2, d2_tl, npx, npy, 1, gridstruct%&
&                          nested, bd, gridstruct%sw_corner, gridstruct%&
&                          se_corner, gridstruct%nw_corner, gridstruct%&
&                          ne_corner)
        DO j=bd%js-nt,bd%je+nt
          DO i=bd%is-nt,bd%ie+nt+1
            fx2_tl(i, j) = 0.5*(gridstruct%sin_sg(i-1, j, 3)+gridstruct%&
&             sin_sg(i, j, 1))*gridstruct%dy(i, j)*gridstruct%rdxc(i, j)&
&             *(d2_tl(i, j)-d2_tl(i-1, j))
            fx2(i, j) = 0.5*(gridstruct%sin_sg(i-1, j, 3)+gridstruct%&
&             sin_sg(i, j, 1))*gridstruct%dy(i, j)*(d2(i, j)-d2(i-1, j))&
&             *gridstruct%rdxc(i, j)
          END DO
        END DO
        CALL COPY_CORNERS_TLM(d2, d2_tl, npx, npy, 2, gridstruct%&
&                          nested, bd, gridstruct%sw_corner, gridstruct%&
&                          se_corner, gridstruct%nw_corner, gridstruct%&
&                          ne_corner)
        DO j=bd%js-nt,bd%je+nt+1
          DO i=bd%is-nt,bd%ie+nt
            fy2_tl(i, j) = gridstruct%dx(i, j)*gridstruct%rdyc(i, j)*0.5&
&             *(gridstruct%sin_sg(i, j-1, 4)+gridstruct%sin_sg(i, j, 2))&
&             *(d2_tl(i, j)-d2_tl(i, j-1))
            fy2(i, j) = gridstruct%dx(i, j)*(d2(i, j)-d2(i, j-1))*&
&             gridstruct%rdyc(i, j)*0.5*(gridstruct%sin_sg(i, j-1, 4)+&
&             gridstruct%sin_sg(i, j, 2))
          END DO
        END DO
      END DO
    END IF
!---------------------------------------------
! Add the diffusive fluxes to the flux arrays:
!---------------------------------------------
    IF (PRESENT(mass)) THEN
! Apply mass weighting to diffusive fluxes:
      damp2 = 0.5*damp
      DO j=bd%js,bd%je
        DO i=bd%is,bd%ie+1
          fx_tl(i, j) = fx_tl(i, j) + damp2*((mass_tl(i-1, j)+mass_tl(i&
&           , j))*fx2(i, j)+(mass(i-1, j)+mass(i, j))*fx2_tl(i, j))
          fx(i, j) = fx(i, j) + damp2*(mass(i-1, j)+mass(i, j))*fx2(i, j&
&           )
        END DO
      END DO
      DO j=bd%js,bd%je+1
        DO i=bd%is,bd%ie
          fy_tl(i, j) = fy_tl(i, j) + damp2*((mass_tl(i, j-1)+mass_tl(i&
&           , j))*fy2(i, j)+(mass(i, j-1)+mass(i, j))*fy2_tl(i, j))
          fy(i, j) = fy(i, j) + damp2*(mass(i, j-1)+mass(i, j))*fy2(i, j&
&           )
        END DO
      END DO
    ELSE
      DO j=bd%js,bd%je
        DO i=bd%is,bd%ie+1
          fx_tl(i, j) = fx_tl(i, j) + fx2_tl(i, j)
          fx(i, j) = fx(i, j) + fx2(i, j)
        END DO
      END DO
      DO j=bd%js,bd%je+1
        DO i=bd%is,bd%ie
          fy_tl(i, j) = fy_tl(i, j) + fy2_tl(i, j)
          fy(i, j) = fy(i, j) + fy2(i, j)
        END DO
      END DO
    END IF
  END SUBROUTINE DELN_FLUX_TLM
!  Differentiation of copy_corners in forward (tangent) mode (with options r8):
!   variations   of useful results: q
!   with respect to varying inputs: q
  SUBROUTINE COPY_CORNERS_TLM(q, q_tl, npx, npy, dir, nested, bd, &
&   sw_corner, se_corner, nw_corner, ne_corner)
    IMPLICIT NONE
    TYPE(FV_GRID_BOUNDS_TYPE), INTENT(IN) :: bd
    INTEGER, INTENT(IN) :: npx, npy, dir
    REAL(fvprc), INTENT(INOUT) :: q(bd%isd:bd%ied, bd%jsd:bd%jed)
    REAL(fvprc), INTENT(INOUT) :: q_tl(bd%isd:bd%ied, bd%jsd:bd%jed)
    LOGICAL, INTENT(IN) :: nested, sw_corner, se_corner, nw_corner, &
&   ne_corner
    INTEGER :: i, j
    IF (nested) THEN
      RETURN
    ELSE IF (dir .EQ. 1) THEN
! XDir:
      IF (sw_corner) THEN
        DO j=1-ng,0
          DO i=1-ng,0
            q_tl(i, j) = q_tl(j, 1-i)
            q(i, j) = q(j, 1-i)
          END DO
        END DO
      END IF
      IF (se_corner) THEN
        DO j=1-ng,0
          DO i=npx,npx+ng-1
            q_tl(i, j) = q_tl(npy-j, i-npx+1)
            q(i, j) = q(npy-j, i-npx+1)
          END DO
        END DO
      END IF
      IF (ne_corner) THEN
        DO j=npy,npy+ng-1
          DO i=npx,npx+ng-1
            q_tl(i, j) = q_tl(j, 2*npx-1-i)
            q(i, j) = q(j, 2*npx-1-i)
          END DO
        END DO
      END IF
      IF (nw_corner) THEN
        DO j=npy,npy+ng-1
          DO i=1-ng,0
            q_tl(i, j) = q_tl(npy-j, i-1+npx)
            q(i, j) = q(npy-j, i-1+npx)
          END DO
        END DO
      END IF
    ELSE IF (dir .EQ. 2) THEN
! YDir:
      IF (sw_corner) THEN
        DO j=1-ng,0
          DO i=1-ng,0
            q_tl(i, j) = q_tl(1-j, i)
            q(i, j) = q(1-j, i)
          END DO
        END DO
      END IF
      IF (se_corner) THEN
        DO j=1-ng,0
          DO i=npx,npx+ng-1
            q_tl(i, j) = q_tl(npy+j-1, npx-i)
            q(i, j) = q(npy+j-1, npx-i)
          END DO
        END DO
      END IF
      IF (ne_corner) THEN
        DO j=npy,npy+ng-1
          DO i=npx,npx+ng-1
            q_tl(i, j) = q_tl(2*npy-1-j, i)
            q(i, j) = q(2*npy-1-j, i)
          END DO
        END DO
      END IF
      IF (nw_corner) THEN
        DO j=npy,npy+ng-1
          DO i=1-ng,0
            q_tl(i, j) = q_tl(j+1-npx, npy-i)
            q(i, j) = q(j+1-npx, npy-i)
          END DO
        END DO
      END IF
    END IF
  END SUBROUTINE COPY_CORNERS_TLM
END MODULE TP_CORE_MOD_D
